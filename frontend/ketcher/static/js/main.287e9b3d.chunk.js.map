{"version":3,"sources":["../../packages/ketcher-core/src/domain/constants/elementColor.ts","../../packages/ketcher-core/src/domain/constants/elements.ts","../../packages/ketcher-core/src/domain/constants/generics.ts","../../packages/ketcher-core/src/domain/entities/atomList.ts","../../packages/ketcher-core/src/domain/entities/vec2.ts","../../packages/ketcher-core/src/domain/entities/atom.ts","../../packages/ketcher-core/src/domain/entities/pile.ts","../../packages/ketcher-core/src/domain/entities/fragment.ts","../../packages/ketcher-core/src/domain/entities/bond.ts","../../packages/ketcher-core/src/domain/helpers/scale.ts","../../packages/ketcher-core/src/domain/helpers/stereoValidator.ts","../../packages/ketcher-core/src/domain/helpers/functionalGroupsProvider.ts","../../packages/ketcher-core/src/domain/entities/box2Abs.ts","../../packages/ketcher-core/src/domain/entities/sgroup.ts","../../packages/ketcher-core/src/domain/entities/rxnArrow.ts","../../packages/ketcher-core/src/domain/entities/functionalGroup.ts","../../packages/ketcher-core/src/domain/entities/halfBond.ts","../../packages/ketcher-core/src/domain/entities/loop.ts","../../packages/ketcher-core/src/domain/entities/rgroup.ts","../../packages/ketcher-core/src/domain/entities/simpleObject.ts","../../packages/ketcher-core/src/domain/entities/rxnPlus.ts","../../packages/ketcher-core/src/domain/entities/sgroupForest.ts","../../packages/ketcher-core/src/domain/entities/pool.ts","../../packages/ketcher-core/src/domain/entities/struct.ts","../../packages/ketcher-core/src/domain/entities/text.ts","../../packages/ketcher-core/src/domain/entities/highlight.ts","../../packages/ketcher-core/src/utilities/ifDef.ts","../../packages/ketcher-core/src/utilities/tfx.ts","../../packages/ketcher-core/src/domain/serializers/ket/toKet/moleculeToKet.ts","../../packages/ketcher-core/src/domain/serializers/ket/fromKet/moleculeToStruct.ts","../../packages/ketcher-core/src/domain/serializers/ket/toKet/prepare.ts","../../packages/ketcher-core/src/domain/serializers/ket/toKet/rgroupToKet.ts","../../packages/ketcher-core/src/domain/serializers/ket/fromKet/rgroupToStruct.ts","../../packages/ketcher-core/src/domain/serializers/ket/fromKet/rxnToStruct.ts","../../packages/ketcher-core/src/domain/serializers/ket/fromKet/simpleObjectToStruct.ts","../../packages/ketcher-core/src/domain/serializers/ket/ketSerializer.ts","../../packages/ketcher-core/src/domain/serializers/ket/fromKet/textToStruct.ts","../../packages/ketcher-core/src/domain/serializers/ket/validate.ts","../../packages/ketcher-core/src/domain/serializers/ket/toKet/headerToKet.ts","../../packages/ketcher-core/src/domain/serializers/ket/toKet/rxnToKet.ts","../../packages/ketcher-core/src/domain/serializers/ket/toKet/simpleObjectToKet.ts","../../packages/ketcher-core/src/domain/serializers/ket/toKet/textToKet.ts","../../packages/ketcher-core/src/domain/serializers/mol/utils.js","../../packages/ketcher-core/src/domain/serializers/mol/parseSGroup.js","../../packages/ketcher-core/src/domain/serializers/mol/v2000.js","../../packages/ketcher-core/src/domain/serializers/mol/v3000.js","../../packages/ketcher-core/src/domain/serializers/mol/common.js","../../packages/ketcher-core/src/domain/serializers/mol/molfile.ts","../../packages/ketcher-core/src/domain/serializers/mol/molSerializer.ts","../../packages/ketcher-core/src/domain/serializers/smi/cis_trans.js","../../packages/ketcher-core/src/domain/serializers/smi/dfs.js","../../packages/ketcher-core/src/domain/serializers/smi/stereocenters.js","../../packages/ketcher-core/src/domain/serializers/smi/smiles.js","../../packages/ketcher-core/src/domain/serializers/smi/smiSerializer.ts","../../packages/ketcher-core/src/domain/serializers/sdf/sdfSerializer.ts","../../packages/ketcher-core/src/domain/services/struct/structService.types.ts","../../packages/ketcher-core/src/infrastructure/services/struct/remoteStructService.ts","../../packages/ketcher-core/src/infrastructure/services/struct/remoteStructServiceProvider.ts","../../packages/ketcher-core/src/application/formatters/supportedFormatProperties.ts","../../packages/ketcher-core/src/application/formatters/formatProperties.ts","../../packages/ketcher-core/src/application/formatters/ketFormatter.ts","../../packages/ketcher-core/src/application/formatters/molfileV2000Formatter.ts","../../packages/ketcher-core/src/application/formatters/rxnFormatter.ts","../../packages/ketcher-core/src/application/render/restruct/generalEnumTypes.ts","../../packages/ketcher-core/src/application/formatters/serverFormatter.ts","../../packages/ketcher-core/src/application/formatters/smilesFormatter.ts","../../packages/ketcher-core/src/application/formatters/formatterFactory.ts","../../packages/ketcher-core/src/application/formatters/identifyStructFormat.ts","../../packages/ketcher-core/src/application/render/raphael-ext.js","../../packages/ketcher-core/src/application/render/restruct/visel.js","../../packages/ketcher-core/src/application/render/restruct/reobject.ts","../../packages/ketcher-core/src/application/render/util.js","../../packages/ketcher-core/src/application/render/draw.js","../../packages/ketcher-core/src/application/render/restruct/reatom.ts","../../packages/ketcher-core/src/application/render/restruct/rebond.ts","../../packages/ketcher-core/src/application/render/restruct/reenhancedFlag.ts","../../packages/ketcher-core/src/application/render/restruct/refrag.js","../../packages/ketcher-core/src/application/render/restruct/rergroup.js","../../packages/ketcher-core/src/application/render/restruct/rerxnarrow.ts","../../packages/ketcher-core/src/application/render/restruct/rerxnplus.js","../../packages/ketcher-core/src/application/render/restruct/redatasgroupdata.js","../../packages/ketcher-core/src/application/render/restruct/resgroup.js","../../packages/ketcher-core/src/application/render/restruct/resimpleObject.ts","../../packages/ketcher-core/src/application/render/restruct/reloop.js","../../packages/ketcher-core/src/application/render/restruct/retext.ts","../../packages/ketcher-core/src/application/render/restruct/restruct.ts","../../packages/ketcher-core/src/application/editor/shared/utils.js","../../packages/ketcher-core/src/application/render/raphaelRender.js","../../packages/ketcher-core/src/application/render/options.js","../../packages/ketcher-core/src/application/editor/operations/base.ts","../../packages/ketcher-core/src/application/editor/operations/OperationType.ts","../../packages/ketcher-core/src/application/editor/operations/atom/AtomAttr.ts","../../packages/ketcher-core/src/application/editor/operations/atom/AtomMove.ts","../../packages/ketcher-core/src/application/editor/operations/atom/index.ts","../../packages/ketcher-core/src/application/editor/operations/bond/BondAttr.ts","../../packages/ketcher-core/src/application/editor/operations/bond/BondMove.ts","../../packages/ketcher-core/src/application/editor/operations/bond/index.ts","../../packages/ketcher-core/src/application/editor/operations/CanvasLoad.ts","../../packages/ketcher-core/src/application/editor/operations/descriptors.ts","../../packages/ketcher-core/src/application/editor/operations/EnhancedFlagMove.ts","../../packages/ketcher-core/src/application/editor/operations/ifThen.ts","../../packages/ketcher-core/src/application/editor/operations/fragment.ts","../../packages/ketcher-core/src/application/editor/operations/fragmentStereoAtom.ts","../../packages/ketcher-core/src/application/editor/operations/FragmentStereoFlag.ts","../../packages/ketcher-core/src/application/editor/operations/calcimplicitH.ts","../../packages/ketcher-core/src/application/editor/operations/LoopMove.ts","../../packages/ketcher-core/src/application/editor/operations/rgroup/RGroupAttr.ts","../../packages/ketcher-core/src/application/editor/operations/rgroup/RGroupFragment.ts","../../packages/ketcher-core/src/application/editor/operations/rxn/RxnArrowMove.ts","../../packages/ketcher-core/src/application/editor/operations/rxn/RxnArrowResize.ts","../../packages/ketcher-core/src/application/editor/operations/rxn/plus/RxnPlusMove.ts","../../packages/ketcher-core/src/application/editor/operations/rxn/plus/index.ts","../../packages/ketcher-core/src/application/editor/operations/rxn/index.ts","../../packages/ketcher-core/src/application/editor/operations/simpleObject.ts","../../packages/ketcher-core/src/application/editor/operations/sgroup/sgroupAtom.ts","../../packages/ketcher-core/src/application/editor/operations/sgroup/SGroupAttr.ts","../../packages/ketcher-core/src/application/editor/operations/sgroup/SGroupDataMove.ts","../../packages/ketcher-core/src/application/editor/operations/sgroup/sgroupHierarchy.ts","../../packages/ketcher-core/src/application/editor/operations/sgroup/index.ts","../../packages/ketcher-core/src/application/editor/operations/Text/TextCreateDelete.ts","../../packages/ketcher-core/src/application/editor/operations/Text/TextUpdate.ts","../../packages/ketcher-core/src/application/editor/operations/Text/TextMove.ts","../../packages/ketcher-core/src/application/editor/actions/action.ts","../../packages/ketcher-core/src/application/editor/actions/aromaticFusing.ts","../../packages/ketcher-core/src/application/editor/shared/closest.js","../../packages/ketcher-core/src/application/editor/actions/utils.ts","../../packages/ketcher-core/src/application/editor/actions/rgroup.ts","../../packages/ketcher-core/src/application/editor/actions/sgroup.ts","../../packages/ketcher-core/src/application/editor/actions/bond.ts","../../packages/ketcher-core/src/application/editor/actions/atom.ts","../../packages/ketcher-core/src/application/editor/actions/basic.ts","../../packages/ketcher-core/src/application/editor/actions/chain.ts","../../packages/ketcher-core/src/application/editor/actions/closelyFusing.ts","../../packages/ketcher-core/src/application/editor/actions/fragment.ts","../../packages/ketcher-core/src/application/editor/actions/erase.ts","../../packages/ketcher-core/src/application/editor/actions/paste.ts","../../packages/ketcher-core/src/application/editor/actions/reaction.ts","../../packages/ketcher-core/src/application/editor/actions/rotate.ts","../../packages/ketcher-core/src/application/editor/actions/simpleobject.ts","../../packages/ketcher-core/src/application/editor/actions/template.ts","../../packages/ketcher-core/src/application/editor/actions/text.ts","../../packages/ketcher-core/src/application/editor/operations/highlight.ts","../../packages/ketcher-core/src/application/editor/actions/highlight.ts","../../packages/ketcher-core/src/application/editor/shared/constants.js","../../packages/ketcher-core/src/application/editor/index.ts","../../packages/ketcher-core/src/application/ketcher.ts","../../packages/ketcher-core/src/application/ketcherBuilder.ts","App.tsx","../../packages/ketcher-react/src/script/api.ts","../../packages/ketcher-react/src/contexts/appContext.tsx","../../packages/ketcher-react/src/contexts/errorsContext.tsx","../../packages/ketcher-react/src/contexts/settingsContext.tsx","../../packages/ketcher-react/src/contexts/formContext.tsx","../../packages/ketcher-react/src/script/ui/action/atoms.js","../../packages/ketcher-react/src/script/ui/action/copyAs.js","../../packages/ketcher-react/src/script/ui/action/copyImageToClipboard.js","../../packages/ketcher-react/src/script/ui/action/isHidden.ts","../../packages/ketcher-react/src/script/ui/action/debug.js","../../packages/ketcher-react/src/script/ui/component/cliparea/cliparea.jsx","../../packages/ketcher-react/src/script/ui/data/schema/options-schema.ts","../../packages/ketcher-react/src/script/ui/storage-ext.js","../../packages/ketcher-react/src/script/ui/state/options/index.js","../../packages/ketcher-react/src/script/ui/data/schema/schema-helper.js","../../packages/ketcher-react/src/script/ui/data/schema/sdata-schema.js","../../packages/ketcher-react/src/script/ui/state/modal/sdata.js","../../packages/ketcher-react/src/script/ui/state/modal/form.js","../../packages/ketcher-react/src/script/ui/state/request/request.types.ts","../../packages/ketcher-react/src/script/ui/state/request/index.ts","../../packages/ketcher-react/src/script/ui/state/constants.js","../../packages/ketcher-react/src/script/ui/data/schema/struct-schema.js","../../packages/ketcher-react/src/script/ui/data/convert/structconv.js","../../packages/ketcher-react/src/script/ui/action/tools.js","../../packages/ketcher-react/src/script/ui/state/shared.js","../../packages/ketcher-react/src/script/ui/state/server/index.js","../../packages/ketcher-react/src/script/ui/action/server.js","../../packages/ketcher-react/src/script/ui/data/templates.js","../../packages/ketcher-react/src/script/ui/action/templates.js","../../packages/ketcher-react/src/script/ui/action/zoom.js","../../packages/ketcher-react/src/script/ui/action/functionalGroups.ts","../../packages/ketcher-react/src/script/ui/action/index.js","../../packages/ketcher-react/src/icons/index.tsx","../../packages/ketcher-react/src/script/ui/component/view/icon.jsx","../../packages/ketcher-react/src/script/ui/views/toolbars/shortcutStr.ts","../../packages/ketcher-react/src/script/ui/views/toolbars/ToolbarGroupItem/ActionButton/ActionButton.tsx","../../packages/ketcher-react/src/script/ui/Portal/Portal.tsx","../../packages/ketcher-react/src/script/ui/views/toolbars/ToolbarGroupItem/ToolbarMultiToolItem/variants/DefaultMultiTool/DefaultMultiTool.tsx","../../packages/ketcher-react/src/script/ui/views/toolbars/ToolbarGroupItem/ToolbarMultiToolItem/variants/GroupedMultiTool/GroupedMultiTool.tsx","../../packages/ketcher-react/src/script/ui/views/toolbars/ToolbarGroupItem/ToolbarMultiToolItem/ToolbarMultiToolItem.tsx","../../packages/ketcher-react/src/script/ui/views/toolbars/ToolbarGroupItem/ToolbarMultiToolItem/usePortalOpening.ts","../../packages/ketcher-react/src/script/ui/views/toolbars/ToolbarGroupItem/ToolbarMultiToolItem/usePortalStyle.ts","../../packages/ketcher-react/src/script/ui/views/toolbars/ToolbarGroupItem/ToolbarMultiToolItem/variants/chooseMultiTool.ts","../../packages/ketcher-react/src/script/ui/views/toolbars/ToolbarGroupItem/ToolbarGroupItem.tsx","../../packages/ketcher-react/src/script/ui/views/toolbars/BottomToolbar/TemplatesList/TemplatesList.tsx","../../packages/ketcher-react/src/script/ui/views/toolbars/BottomToolbar/BottomToolbar.tsx","../../packages/ketcher-react/src/script/ui/state/templates/init-lib.js","../../packages/ketcher-react/src/script/ui/state/modal/index.js","../../packages/ketcher-react/src/script/ui/state/templates/index.js","../../packages/ketcher-react/src/script/ui/state/action/index.js","../../packages/ketcher-react/src/script/ui/state/toolbar/index.js","../../packages/ketcher-react/src/script/ui/state/functionalGroups/index.ts","../../packages/ketcher-react/src/script/ui/state/index.js","../../packages/ketcher-react/src/script/ui/views/toolbars/BottomToolbar/BottomToolbar.container.ts","../../packages/ketcher-react/src/script/ui/views/toolbars/ToolbarGroupItem/utils/makeItems.ts","../../packages/ketcher-react/src/script/ui/views/toolbars/LeftToolbar/Bond/options.ts","../../packages/ketcher-react/src/script/ui/views/toolbars/LeftToolbar/leftToolbarOptions.ts","../../packages/ketcher-react/src/hooks/useSettingsContext.ts","../../packages/ketcher-react/src/hooks/useResizeObserver.ts","../../packages/ketcher-react/src/hooks/useFormContext.tsx","../../packages/ketcher-react/src/hooks/useAppContext.ts","../../packages/ketcher-react/src/hooks/useInterval.ts","../../packages/ketcher-react/src/script/ui/views/toolbars/ArrowScroll/ArrowScroll.tsx","../../packages/ketcher-react/src/script/ui/views/toolbars/mediaSizes.ts","../../packages/ketcher-react/src/script/ui/views/toolbars/LeftToolbar/Bond/Bond.tsx","../../packages/ketcher-react/src/script/ui/views/toolbars/LeftToolbar/RGroup/RGroup.tsx","../../packages/ketcher-react/src/script/ui/views/toolbars/LeftToolbar/Shape/Shape.tsx","../../packages/ketcher-react/src/script/ui/views/toolbars/LeftToolbar/Transform/Transform.tsx","../../packages/ketcher-react/src/script/ui/views/toolbars/LeftToolbar/LeftToolbar.tsx","../../packages/ketcher-react/src/script/ui/views/toolbars/LeftToolbar/LeftToolbar.container.ts","../../packages/ketcher-react/src/script/ui/component/view/Atom/Atom.jsx","../../packages/ketcher-react/src/script/ui/views/toolbars/RightToolbar/AtomsList/AtomsList.tsx","../../packages/ketcher-react/src/script/ui/views/toolbars/RightToolbar/RightToolbar.tsx","../../packages/ketcher-react/src/script/ui/views/toolbars/RightToolbar/RightToolbar.container.ts","../../packages/ketcher-react/src/script/ui/views/toolbars/TopToolbar/ZoomList/ZoomList.tsx","../../packages/ketcher-react/src/script/ui/views/toolbars/TopToolbar/HelpLink/HelpLink.tsx","../../packages/ketcher-react/src/script/ui/views/toolbars/TopToolbar/TopToolbar.tsx","../../packages/ketcher-react/src/script/ui/views/toolbars/TopToolbar/TopToolbar.container.ts","../../packages/ketcher-react/src/script/ui/data/convert/keynorm.js","../../packages/ketcher-react/src/script/ui/state/hotkeys.js","../../packages/ketcher-react/src/script/ui/views/AppClipArea.tsx","../../packages/ketcher-react/src/script/ui/App/AppHidden/AppHidden.container.ts","../../packages/ketcher-react/src/script/ui/App/AppHidden/AppHidden.tsx","../../packages/ketcher-react/src/script/ui/views/modal/mediaSizes.ts","../../packages/ketcher-react/src/script/ui/views/components/Dialog/Dialog.tsx","../../packages/ketcher-react/src/script/ui/views/components/Spinner/Spinner.tsx","../../packages/ketcher-react/src/script/editor/shared/closest.js","../../packages/ketcher-react/src/script/editor/tool/apoint.js","../../packages/ketcher-react/src/script/editor/shared/utils.js","../../packages/ketcher-react/src/script/editor/tool/atom.js","../../packages/ketcher-react/src/script/editor/tool/attach.js","../../packages/ketcher-react/src/script/editor/tool/bond.js","../../packages/ketcher-react/src/script/editor/tool/chain.js","../../packages/ketcher-react/src/script/editor/tool/charge.js","../../packages/ketcher-react/src/script/editor/tool/helper/locate.js","../../packages/ketcher-react/src/script/editor/tool/helper/lasso.js","../../packages/ketcher-react/src/script/editor/tool/sgroup.js","../../packages/ketcher-react/src/script/editor/tool/select.ts","../../packages/ketcher-react/src/script/editor/tool/eraser.js","../../packages/ketcher-react/src/script/editor/tool/paste.js","../../packages/ketcher-react/src/script/editor/tool/rgroupatom.js","../../packages/ketcher-react/src/script/editor/tool/rgroupfragment.js","../../packages/ketcher-react/src/script/editor/tool/reactionarrow.js","../../packages/ketcher-react/src/script/editor/tool/reactionmap.js","../../packages/ketcher-react/src/script/editor/tool/reactionplus.js","../../packages/ketcher-react/src/script/editor/tool/reactionunmap.js","../../packages/ketcher-react/src/script/editor/tool/rotate.js","../../packages/ketcher-react/src/script/editor/tool/simpleobject.js","../../packages/ketcher-react/src/script/editor/tool/template.js","../../packages/ketcher-react/src/script/editor/tool/text.ts","../../packages/ketcher-react/src/script/editor/tool/index.js","../../packages/ketcher-react/src/script/editor/tool/enhanced-stereo.ts","../../packages/ketcher-react/src/script/editor/highlighter.ts","../../packages/ketcher-react/src/script/editor/Editor.ts","../../packages/ketcher-react/src/script/editor/utils/customOnChangeHandler.ts","../../packages/ketcher-react/src/script/ui/component/ContextMenu/ContextMenu.tsx","../../packages/ketcher-react/src/script/ui/views/components/StructEditor/StructEditor.jsx","../../packages/ketcher-react/src/script/ui/views/modal/components/meta/About/About.jsx","../../packages/ketcher-react/src/script/ui/component/form/input.jsx","../../packages/ketcher-react/src/script/ui/component/form/form/form.jsx","../../packages/ketcher-react/src/script/ui/views/modal/components/meta/Settings/components/Accordion/Accordion.tsx","../../packages/ketcher-react/src/script/ui/component/form/colorPicker/ColorPicker.tsx","../../packages/ketcher-react/src/script/ui/component/form/measure-input.jsx","../../packages/ketcher-react/src/script/ui/component/view/openbutton.jsx","../../packages/ketcher-react/src/script/ui/component/view/savebutton.jsx","../../packages/ketcher-react/src/script/ui/component/form/select-checkbox.jsx","../../packages/ketcher-react/src/script/ui/component/form/systemfonts.jsx","../../packages/ketcher-react/src/script/ui/views/modal/components/meta/Settings/Settings.tsx","../../packages/ketcher-react/src/script/ui/views/modal/components/process/Check/components/ErrorsCheck.jsx","../../packages/ketcher-react/src/script/ui/component/view/Tabs/Tabs.jsx","../../packages/ketcher-react/src/script/ui/views/modal/components/process/Check/Check.jsx","../../packages/ketcher-react/src/script/ui/views/modal/components/process/Analyse/components/FormulaInput/FormulaInput.jsx","../../packages/ketcher-react/src/script/ui/views/modal/components/process/Analyse/components/FrozenInput/FrozenInput.jsx","../../packages/ketcher-react/src/script/ui/views/modal/components/process/Analyse/Analyse.jsx","../../packages/ketcher-react/src/script/ui/component/view/spin.jsx","../../packages/ketcher-react/src/script/ui/component/structrender.jsx","../../packages/ketcher-react/src/script/ui/views/modal/components/process/Recognize/Recognize.jsx","../../packages/ketcher-react/src/script/ui/views/modal/components/process/Miew/Miew.jsx","../../packages/ketcher-react/src/script/ui/views/modal/components/toolbox/Atom/ElementNumber/ElementNumber.tsx","../../packages/ketcher-react/src/script/ui/views/modal/components/toolbox/Atom/Atom.container.ts","../../packages/ketcher-react/src/script/ui/views/modal/components/toolbox/Atom/Atom.tsx","../../packages/ketcher-react/src/script/ui/views/modal/components/toolbox/Attach/Attach.container.ts","../../packages/ketcher-react/src/script/ui/views/modal/components/toolbox/Attach/Attach.tsx","../../packages/ketcher-react/src/script/ui/views/modal/components/toolbox/Automap/Automap.tsx","../../packages/ketcher-react/src/script/ui/views/modal/components/toolbox/Automap/Automap.container.ts","../../packages/ketcher-react/src/script/ui/views/modal/components/toolbox/Bond/Bond.container.ts","../../packages/ketcher-react/src/script/ui/views/modal/components/toolbox/Bond/Bond.tsx","../../packages/ketcher-react/src/script/ui/views/modal/components/toolbox/RgroupLogic/components/IfThenSelect/IfThenSelect.tsx","../../packages/ketcher-react/src/script/ui/views/modal/components/toolbox/RgroupLogic/RgroupLogic.container.ts","../../packages/ketcher-react/src/script/ui/views/modal/components/toolbox/RgroupLogic/RgroupLogic.tsx","../../packages/ketcher-react/src/script/ui/views/modal/components/document/Open/Open.container.ts","../../packages/ketcher-react/src/script/ui/views/modal/components/document/Open/Open.tsx","../../packages/ketcher-react/src/script/ui/views/modal/components/document/Save/SaveImageTab.jsx","../../packages/ketcher-react/src/script/ui/views/modal/components/document/Save/Save.jsx","../../packages/ketcher-react/src/script/ui/data/convert/structConverter.ts","../../packages/ketcher-react/src/script/ui/dialog/toolbox/enhancedStereo/enhancedStereo.tsx","../../packages/ketcher-react/src/script/ui/dialog/template/EmptySearchResult.tsx","../../packages/ketcher-react/src/script/ui/utils/index.ts","../../packages/ketcher-react/src/script/ui/dialog/template/TemplateTable.tsx","../../packages/ketcher-react/src/script/ui/state/functionalGroups/selectors/index.ts","../../packages/ketcher-react/src/script/ui/views/components/FunctionalGroups/FunctionalGroups.tsx","../../packages/ketcher-react/src/script/ui/dialog/toolbox/labeledit.jsx","../../packages/ketcher-react/src/script/ui/views/modal/components/PeriodTable/components/AtomInfo/AtomInfo.jsx","../../packages/ketcher-react/src/script/ui/views/modal/components/PeriodTable/components/ElementsTable/components/Header.jsx","../../packages/ketcher-react/src/script/ui/views/modal/components/PeriodTable/components/ElementsTable/components/MainRow.jsx","../../packages/ketcher-react/src/script/ui/views/modal/components/PeriodTable/components/ElementsTable/components/OutinerRow.jsx","../../packages/ketcher-react/src/script/ui/views/modal/components/PeriodTable/components/ElementsTable/ElementsTable.jsx","../../packages/ketcher-react/src/script/ui/views/modal/components/PeriodTable/components/GenericGroups/components/components/GenSet.jsx","../../packages/ketcher-react/src/script/ui/views/modal/components/PeriodTable/components/GenericGroups/components/GenGroup.jsx","../../packages/ketcher-react/src/script/ui/views/modal/components/PeriodTable/components/GenericGroups/GenericGroups.jsx","../../packages/ketcher-react/src/script/ui/views/modal/components/PeriodTable/components/TypeChoice/TypeChoice.jsx","../../packages/ketcher-react/src/script/ui/views/modal/components/PeriodTable/PeriodTable.jsx","../../packages/ketcher-react/src/script/ui/component/form/buttonlist.jsx","../../packages/ketcher-react/src/script/ui/dialog/toolbox/rgroup/rgroup.jsx","../../packages/ketcher-react/src/script/ui/component/form/combobox/combobox.jsx","../../packages/ketcher-react/src/script/ui/dialog/toolbox/sdata.jsx","../../packages/ketcher-react/src/script/ui/dialog/toolbox/sgroup.jsx","../../packages/ketcher-react/src/script/ui/dialog/template/template-attach.jsx","../../packages/ketcher-react/src/script/ui/component/form/select.jsx","../../packages/ketcher-react/src/script/ui/dialog/template/TemplateDialog.tsx","../../packages/ketcher-react/src/script/ui/views/modal/components/Text/FontControl/FontControl.tsx","../../packages/ketcher-react/src/script/ui/views/modal/components/Text/TextButton/TextButton.tsx","../../packages/ketcher-react/src/script/ui/views/modal/components/Text/Text.tsx","../../packages/ketcher-react/src/script/ui/dialog/index.ts","../../packages/ketcher-react/src/script/ui/views/modal/components/toolbox/FG/RemoveFG.tsx","../../packages/ketcher-react/src/script/ui/views/modal/Modal.container.ts","../../packages/ketcher-react/src/script/ui/views/modal/Modal.tsx","../../packages/ketcher-react/src/script/ui/state/editor/index.js","../../packages/ketcher-react/src/script/ui/views/Editor.jsx","../../packages/ketcher-react/src/script/ui/App/App.container.ts","../../packages/ketcher-react/src/script/ui/App/App.tsx","../../packages/ketcher-react/src/script/ui/App/initApp.tsx","../../packages/ketcher-react/src/script/builders/ketcher/KetcherBuilder.ts","../../packages/ketcher-react/src/script/index.ts","../../packages/ketcher-react/src/Editor.tsx","ErrorModal/ErrorModal.tsx","index.tsx","../../packages/ketcher-standalone/src/infrastructure/services/struct/indigoWorker.types.ts","../../packages/ketcher-standalone/src/infrastructure/services/struct/standaloneStructService.ts","../../packages/ketcher-standalone/src/infrastructure/services/struct/standaloneStructServiceProvider.ts"],"names":["ElementColor","H","He","Li","Be","B","C","N","O","F","Ne","Na","Mg","Al","Si","P","S","Cl","Ar","K","Ca","Sc","Ti","V","Cr","Mn","Fe","Co","Ni","Cu","Zn","Ga","Ge","As","Se","Br","Kr","Rb","Sr","Y","Zr","Nb","Mo","Tc","Ru","Rh","Pd","Ag","Cd","In","Sn","Sb","Te","I","Xe","Cs","Ba","La","Ce","Pr","Nd","Pm","Sm","Eu","Gd","Tb","Dy","Ho","Er","Tm","Yb","Lu","Hf","Ta","W","Re","Os","Ir","Pt","Au","Hg","Tl","Pb","Bi","Po","At","Rn","Fr","Ra","Ac","Th","Pa","U","Np","Pu","Am","Cm","Bk","Cf","Es","Fm","Md","No","Lr","Rf","Db","Sg","Bh","Hs","Mt","Ds","Rg","Cn","Nh","Fl","Mc","Lv","Ts","Og","elementsArray","number","label","period","group","title","state","origin","type","mass","leftH","elementsMap","reduce","acc","element","set","Map","Elements","get","key","filter","predicate","Generics","atom","any","labels","metal","halogen","acyclic","carbo","alkynyl","alkyl","alkenyl","hetero","alkoxy","cyclic","aryl","cycloalkyl","cycloalkenyl","special","AtomList","params","this","notList","ids","id","currenElement","push","labelList","join","atomList","sort","toString","Vec2","args","length","x","y","z","arguments","parseFloat","Error","Math","sqrt","v","s","y1","f","scaled","l","toFixed","assert","max","min","ceil","floor","angle","sin","cos","rotateSC","atan2","a","b","diff","v1","v2","cross","dot","i","addScaled","f1","f2","lc2","StereoLabel","Pile","item","setB","isSuperset","subset","has","expression","Array","from","union","add","Set","getValueOrDefault","value","defaultValue","radicalElectrons","radical","Atom","PATTERN","RADICAL","DOUPLET","SINGLET","TRIPLET","attributes","fragment","alias","attrlist","isotope","charge","rglabel","attpnt","explicitValence","valence","implicitH","pp","sgs","ringBondCount","substitutionCount","unsaturatedAtom","hCount","aam","invRet","exactChangeFlag","rxnFragmentType","stereoLabel","stereoParity","neighbors","badConn","Object","defineProperty","enumerable","fidMap","ret","conn","isQuery","groupno","rad","hyd","absCharge","abs","attrs","attr","NONE","STEREO_PARITY","ODD","EVEN","EITHER","StereoFlag","Bond","begin","end","xxx","stereo","STEREO","topology","TOPOLOGY","reactingCenterStatus","len","sb","sa","center","struct","p1","atoms","p2","sub","normalized","aidMap","cp","bond","calcStereoFlag","stereoAids","filteredStereoAtoms","map","aid","stereoFlag","hasAnotherLabel","some","Mixed","match","Abs","And","Or","TYPE","SINGLE","DOUBLE","TRIPLE","AROMATIC","SINGLE_OR_DOUBLE","SINGLE_OR_AROMATIC","DOUBLE_OR_AROMATIC","ANY","DATIVE","HYDROGEN","UP","DOWN","CIS_TRANS","RING","CHAIN","REACTING_CENTER","NOT_CENTER","UNMARKED","CENTER","UNCHANGED","MADE_OR_BROKEN","ORDER_CHANGED","MADE_OR_BROKEN_AND_CHANGED","Fragment","stereoAtoms","stereoFlagPosition","fr","frId","isAdd","includes","bonds","values","atomId","fragmentId","getFragment","bb","getCoordBoundingBox","Scale","scaled2obj","options","scale","obj2scaled","StereoValidator","isCorrectStereoCenter","beginNeighs","endNeighs","beginAtom","EndAtomNeigh","NaN","Number","atomGetNeighbors","FunctionalGroupsProvider","functionalGroupsList","list","instance","Box2Abs","p0","lp","rb","p","ext","d","centre","relBox","width","height","b1","b2","c","dc","dd","da","db","SGroupBracketParams","w","h","n","SGroup","bracketBox","bracketDir","areas","hover","hovering","selected","selectionPlate","patoms","xBonds","neiAtoms","data","mul","connectivity","name","subscript","expanded","undefined","attached","absolute","showUnits","nCharsToDisplay","tagChar","daspPos","fieldType","fieldName","fieldValue","units","query","queryOp","keys","forEach","oldValue","offset","sum","topLeftPoint","context","contentBoxes","contentBB","direction","pos","bba","extend","bbb","include","sgroups","size","descriptorIntersects","sAtom","sAtomPP","getMassCentre","sgroup","newAtoms","j","_mol","sg","atomMap","removeNegative","filterAtoms","field","elem","allAtoms","splice","mol","parentAtomSet","crossBonds","bid","sGroup","crossBondsPerAtom","flat","getCenter","braketBox","vext","atomSet","brackets","crossBondsPerAtomValues","bracketWidth","sz","cl","cr","bracketHeight","negated","cl0","cr0","dr","dl","getDir","a0","_atom","getAtoms","indexOf","inBonds","xAtom1","xAtom2","crossBond","bond1","bond2","tailAtom","amap","aid2","newBond","newCrossBond","xBond2","sGroupForest","getPathToRoot","reverse","sgid","atomAddToSGroup","sgBottomRightPoint","bottomRightPoint","segmentIntersection","SUP","MUL","SRU","MON","MER","COP","CRO","MOD","GRA","COM","MIX","FOR","DAT","GEN","RxnArrowMode","FunctionalGroup","getInstance","getFunctionalGroupsList","functionalGroups","relatedSGroup","molecule","fg","getBonds","relatedSGroupId","functionalGroup","isFunctionalGroup","sgroupsFromReStruct","contractedFunctionalGroups","isContractedFunctionalGroup","contractedFunctionalGroupsAtoms","sgroupId","isExpanded","HalfBond","dir","norm","ang","loop","contra","next","leftSin","leftCos","leftNeighbor","rightSin","rightCos","rightNeighbor","Loop","hbs","isConvex","dblBonds","aromatic","convex","hb","halfBonds","RGroup","atrributes","frags","resth","range","ifthen","fid","rgroups","frid","find","_rgid","rgroup","SimpleObjectMode","RxnArrow","currentP","mode","RxnPlus","SGroupForest","parent","children","atomSets","order","queue","shift","newId","isStrictSuperset","isSubset","equals","parents","childs","findIndex","childId","path","guess","getAtomSetRelations","resetParentLink","parentId","childIndex","checkOverlapping","res","sid","sgAtoms","SimpleObject","line","rectangle","Pool","nextId","entries","arrayAddIfMissing","array","TextCommand","Struct","loops","isReaction","rxnArrows","rxnPluses","simpleObjects","texts","highlights","_aid","hasRxnProps","_bid","hasRxnArrow","hasRxnPluses","bondSet","dropRxnSymbols","simpleObjectsSet","textsSet","mergeInto","rg","_fnum","clone","getFragmentIds","keepAllRGroups","fidMask","_frag","rgroupsIds","rgid","keepGroup","newfid","oldfid","bidMap","insert","soid","initHalfBonds","initNeighbors","updateHalfBonds","sortNeighbors","findLoops","addAtom","a1","a2","hb1","hb2","hbid","dist","turnLeft","oxAngle","clear","bondInitHalfBonds","left","hbl","ir","il","setHbNext","halfBondSetAngle","nei","nei2","nextNei","atomSortNeighbors","halfBondUpdate","atomUpdateHalfBonds","remove","position","vec","global","totalLength","cnt","bld","getBondLengthData","minDist","k","totalDist","firstaid","pop","neiId","discardExistingFragments","addedAtoms","components","component","findConnectedComponent","idSet","frag","updateStereoAtom","findConnectedComponents","comp","markFragment","avg","getAvgBondLength","getAvgClosestAtomDistance","hbi","ai","bi","hbj","aj","bj","subloops","continueFlag","atomToHalfBond","aid1","subloop","slice","hbid1","hbid2","hba","hbb","every","loopArr","halfBondAngle","totalAngle","PI","hbida","hbidb","hbIdNext","newLoops","bondsToMark","hbId","partitionLoop","loopId","loopIsInner","loopHasSelfIntersections","loopIsConvex","calcConn","isAromatic","correctConn","hasImplicitH","calcValenceMinusHyd","calcValence","calcImplicitHydrogen","connectedComponents","barriers","arrowPos","reactants","products","defineRxnFragmentTypeForAtomset","atomset","arrowpos","Text","content","Highlight","color","ifDef","target","isArray","tfx","moleculeToKet","body","source","result","refsToRGroups","rgi","val","fromRlabel","rgnumber","rglabelToKet","atomListToKet","stereoCare","weight","parseInt","atomToKet","bondToKet","toUpperCase","sgroupToKet","moleculeToStruct","ketItem","location","attachmentPoints","toRlabel","$refs","el","rglabelToStruct","elements","atomListToStruct","mapping","atomToStruct","bondToStruct","toLowerCase","placement","display","fieldData","sgroupToStruct","markFragments","bindSGroupsToFunctionalGroups","getFragmentCenter","rgroupLogicToKet","rglogic","rgroupToStruct","rgroupLogicToStruct","rlogic","_value","rxnToStruct","simpleObjectToStruct","object","radius","pos0","ellipse","circleToEllipse","parseNode","node","currentStruct","textToStruct","KetSerializer","resultingStruct","ket","JSON","parse","Validator","validate","schema","valid","header","moleculeName","nodes","root","$ref","headerToKet","ketNodes","rgFrags","fragsAtoms","fragAtoms","ketNode","filteredSGroups","filteredSGroupsMap","index","prepareStructForKet","moleculeId","rgroupToKet","plusNode","coord","prop","plusToKet","stringify","fmtInfo","bondTypeMap","bondStereoMap","v30bondStereoMap","bondTopologyMap","countsLinePartition","atomLinePartition","bondLinePartition","atomListHeaderPartition","atomListHeaderLength","atomListHeaderItemLength","chargeMap","valenceMap","implicitHydrogenMap","v30atomPropMap","CHG","RAD","MASS","VAL","HCOUNT","INVRET","SUBST","UNSAT","RBCNT","rxnItemsPartition","FRAGMENT","paddedNum","precision","numStr","replace","padStart","parseDecimalInt","str","isNaN","partitionLine","parts","withspace","partitionLineFixed","itemLength","rxnMerge","mols","nReactants","nProducts","nAgents","shouldReactionRelayout","bbReact","bbAgent","bbProd","molReact","molAgent","molProd","bondLengthData","bondLengthDataMol","bb1","bb2","avgBondLength","getCoordBoundingBoxObj","fragmentType","shiftMol","xorig","over","add_","bbReactAll","bbProdAll","arrowCenter","arrowStart","arrowEnd","rgMerge","scaffold","ctab","readKeyValuePairs","valueString","partition","utils","count","trim","postLoadMul","atomReductionMap","m","raid","patomsMap","identityMap","bondsToRemove","beginIn","endIn","postLoadSru","postLoadSup","postLoadGen","postLoadDat","postLoadMon","postLoadMer","postLoadCop","postLoadCro","postLoadMod","postLoadGra","postLoadCom","postLoadMix","postLoadFor","postLoadAny","applyDataSGroupInfo","propData","split","applyDataSGroupData","finalize","startsWith","endsWith","substr","readKeyMultiValuePairs","loadSGroup","postLoadMap","initSGroup","sGroups","applySGroupProp","propName","numeric","core","kv","applySGroupArrayProp","num","part","strArray","toIntArray","concat","applyDataSGroupName","applyDataSGroupQuery","applyDataSGroupQueryOp","applyDataSGroupDesc","applyDataSGroupInfoLine","applyDataSGroupDataLine","applyDataSGroupExpand","parseAtomLine","atomLine","atomSplit","massDifference","parseBondLine","bondLine","bondSplit","parseAtomListLine","atomListLine","parseCTabV2000","ctabLines","countsSplit","atomCount","bondCount","atomListCount","isAbs","isAnd","stextLinesCount","propertyLinesCount","atomLines","bondLines","atomListLines","pair","rLogic","props","charAt","propValue","isPseudo","test","propertyData","rglabels","a2rs","a2ri","a2r","iii","hhh","ooo","logic","pool","parsePropertyLineAtomList","eg","sGroupId","parsePropertyLines","propId","propVal","applyAtomProp","psg","call","emptyGroups","parseRg2000","coreLines","fragmentLines","parseCTab","strId","hdr","lst","labelsListToIds","parseRxn2000","lines","search","parseAtomLineV3000","subsplit","spacebarsplit","atomListParams","matchNotListInfo","matchedSubstr","splitonce","ival","rgrsplit","parseBondLineV3000","v3000parseCollection","v3000parseSGroup","stripV30","splitSGroupDef","parseBracedNumberList","brkxyzStrs","brkxyz","stripQuotes","parseCTabV3000","norgroups","vals","substring","readRGroups3000","rfrags","rfrag","rlsplit","bracketEquality","currentIndex","firstSliceIndex","quoted","currentSymbol","closingBracketIndex","delim","braceBalance","parseRxn3000","findCtabEnd","findRGroupEnd","molLinesReactants","molLinesProducts","current","rGroups","molLines","version","v2000","v3000","prepareForSaving","prepareMulForSaving","message","saveToMolfile","sgMap","bondMap","idstr","makeAtomBondLines","smtLine","bracketsToMolfile","sdtLine","padEnd","sddLine","nCharnCharsToDisplay","nlRe","chars","prefix","rem","salLine","getCrossBonds","bracketPos","getBracketParameters","bracket","yComplement","parseMol","parseRxn","Molfile","molfile","reaction","bondMapping","molfileLines","common","skipErrors","preserveIndigoDesc","toRemove","errors","getSGroupsBFS","errorIgnore","ex","sGroupDelete","prepareSGroups","writeCTab2000","skipSGroupErrors","getComponents","all","saver","submol","saveMolecule","getCTab","getScaffold","writePaddedNumber","writeHeader","date","Date","writeCR","writeWhiteSpace","write","getMonth","getDate","getFullYear","getHours","getMinutes","repeat","isAbsFlag","enhancedStereoFlag","writeCTab2000Header","atomsIds","atomsProps","writeAtom","writeBond","writeAtomProps","chargeList","isotopeList","radicalList","rglabelList","rglogicList","aplabelList","rbcountList","unsaturatedList","substcountList","writeAtomPropList","writePadded","sgmap","sgmapback","q","expandedGroups","expandedGroupsLine","atomLabel","writePaddedFloat","MolSerializer","DefaultOptions","parseCTFile","reactionRelayout","badHeaderRecover","ex1","ex2","ignoreErrors","noRgroups","CisTrans","neighborsFunc","getNeighbors","swap","arr","i1","i2","tmp","Dfs","atomData","atom_data","nComponentsInReactants","vertices","VertexDesc","edges","EdgeDesc","v_seq","Stereocenters","Smiles","smiles","writtenAtoms","writtenComponents","PARITY","CIS","TRANS","prototype","each","func","getParity","idx","parity","getSubstituents","substituents","sameside","beg","neiBeg","neiEnd","normalize","normBeg","normEnd","prodBeg","prodEnd","samesides","iBeg","iEnd","iNeiBeg","iNeiEnd","sortSubstituents","h0","pureHydrogen","h1","h2","h3","isGeomStereoBond","bondIdx","label1","label2","neiBegin","nei–ïnd","build","excludeBonds","ct","sign","dfs_state","parent_vertex","parent_edge","branches","opening_cycles","closing_cycle","SeqElem","vIdx","parVertex","parEdge","walk","vStack","cid","parentVertex","seqElem","atomD","neighbours","neiIdx","edgeIdx","edgeClosingCycle","eIdx","numBranches","numOpeningCycles","buildFromBonds","alleneMask","neiList","nei1","nei1nei","nei2nei","stereocenter","buildOneCenter","allowed_stereocenters","degree","n_double_bonds","implicit_degree","atomIdx","implicitDegree","pyramid","edgeIds","lastAtomDir","nDoubleBonds","nPureHydrogens","neiAtom","edge_idx","nei_idx","rank","as","xyz1","xyz2","main1","main2","side1","side2","mainDir","getBondStereo","xyzzy","stereo0","stereo1","stereo2","nUp","nDown","xyz","centerIdx","u","eps","sine1","cosine1","sine2","cosine2","v3","isPyramidMappingRigid","rigid","_Atom","lowercase","chirality","branch_cnt","paren_written","h_count","isBondInRing","inLoop","setImplicitHydrogen","allowedLowercase","prepareLoopStructure","bondsInLoops","hbids","touchedCistransbonds","markCisTrans","componentsAll","seqEl","vPrevIdx","openingCycles","stereocenters","sc","implicitHIdx","pyramidMapping","counter","cycleNumbers","firstComponent","writeCycleNumber","calcBondDirection","comma","writeRadicals","needBrackets","hydro","cis_trans","dbonds","ctbond_beg","ctbond_end","saved","aromFailBeg","aromFailEnd","updateSideBonds","subst","sidebonds","findBondId","n1","n2","n3","n4","vprev","ntouched","marked","SmiSerializer","_content","ChemicalMimeType","DelimeterRegex","SdfSerializer","molSerializer","exec","chunk","propChunks","deserialize","pc","isFinite","sdfItems","serialize","request","method","url","headers","responseHandler","requestUrl","_","parametrizeUrl","response","fetch","assign","Accept","credentials","then","json","ok","Promise","reject","error","indigoCall","baseUrl","defaultOptions","RemoteStructService","apiPath","isAvailable","indigoVersion","imagoVersions","blob","parVersion","req","status","bind","process","upload_id","complete","timeGap","startTimeGap","resolve","setTimeout","iterate","e","err","metadata","mol_str","outputFormat","resp","text","RemoteStructServiceProvider","currentApiPath","URLSearchParams","document","SupportedFormatProperties","mime","extensions","supportsCoords","formatProperties","Mol","molV3000","rxn","Rxn","rxnV3000","DaylightSmiles","smilesExt","ExtendedSmiles","smarts","DaylightSmarts","inChI","InChI","inChIAuxInfo","InChIAuxInfo","cml","CML","KET","cdxml","CDXML","getPropertiesByFormat","format","KetFormatter","serializer","MolfileV2000Formatter","molfileManager","stringifiedMolfile","stringifiedStruct","RxnFormatter","LayerMap","StereoColoringType","StereLabelStyleType","ServerFormatter","structService","ketSerializer","info","convert","output_format","convertResult","withCoords","promise","layout","parsedStruct","rescale","formatError","SmilesFormatter","smiSerializer","getStructureFromStringAsync","FormatterFactory","structServiceOptions","molfileParseOptions","formatter","separateOptions","molSerializerOptions","identifyStructFormat","sanitizedString","er","Raphael","translateAbs","delta","transform","st","Visel","paths","boxes","boundingBox","exts","vector","translate","ReObject","viselType","visel","render","vbox","noredraw","removed","show","paper","setStart","drawHover","setFinish","hide","_render","restruct","styles","util","box","shiftRayBox","r","rc","rd","pid","nid","id0","id1","makeStroke","dashedPath","dash","t0","t1","black","t2","coordStr","recenterText","rbb","vml","gap","arrow","startPoint","endPoint","OpenAngle","arrowLength","arrowAngle","b0x","transformedPath","svgPath","rotate","lineattr","arrowOpenAngle","FilledTriangle","triangleLength","triangleWidth","fill","arrowFilledTriangle","FilledBow","arrowHeadLength","arrowHeadWidth","arrowHeadAttr","arrowFilledBow","DashedOpenAngle","dashInterval","arrowDashedOpenAngle","Failed","failSignWidth","arrowFailed","BothEndsFilledTriangle","arrowBothEndsFilledTriangle","EquilibriumFilledHalfBow","arrowLen","lineOffset","arrowOffset","arrowEquilibriumFilledHalfBow","EquilibriumFilledTriangle","arrowEquilibriumFilledTriangle","EquilibriumOpenAngle","arrowEquilibriumOpenAngle","UnbalancedEquilibriumFilledHalfBow","unbalanceVal","arrowUnbalancedEquilibriumFilledHalfBow","UnbalancedEquilibriumOpenHalfAngle","arrowUnbalancedEquilibriumOpenHalfAngle","UnbalancedEquilibriumLargeFilledHalfBow","arrowUnbalancedEquilibriumLargeFilledHalfBow","UnbalancedEquilibriumFilleHalfTriangle","arrowUnbalancedEquilibriumFilleHalfTriangle","plus","aromaticBondPaths","a3","b3","mask","bondSingle","stroke","bondSingleUp","bondSingleStereoBold","a4","bondDoubleStereoBold","sgBondPath","bondSingleDown","nlines","step","bsp","stereoBond","bondSingleEither","bondDouble","cisTrans","bondSingleOrDouble","nSect","pi","bondSpace","bondTriple","bondAromatic","bondShift","l1","l2","bondAny","bondHydrogen","bondDative","reactingCenter","pathdesc","topologyMark","mark","font","fontszsub","getBBox","radicalCap","lineWidth","dw","dh","radicalBullet","circle","b0","sgroupBracketStyle","selectionRectangle","rect","lassoStyle","selectionPolygon","pstr","selectionLine","rx","ry","rectangleWithAngle","polyline","ShowHydrogenLabels","ReAtom","showLabel","hydrogenOnTheLeft","getVBoxObj","makeHoverPlate","addReObjectPath","ps","isAtomInContractedFunctionalGroup","atomSelectionPlateRadius","hoverStyle","selectionStyle","isFirstAtomInFunctionalGroup","sgroupName","rightMargin","leftMargin","implh","isHydrogen","Boolean","yl","yr","nl","nr","setHydrogenPos","visibleTerminal","showHydrogenLabels","Off","Hetero","carbonExplicitly","showValenceWarnings","isLabelVisible","pseudo","getLabelText","atomColoring","fontsz","draw","pathAndRBoxTranslate","buildLabel","zoom","showAtomIds","indices","setHover","hydroIndex","showHydroIndex","hshift","vshift","showRadical","showIsotope","hydrogenLabels","On","Terminal","TerminalAndHetero","displayHydrogen","hydrogenLeft","hydrogen","showHydrogen","showCharge","showValence","mapValence","showExplicitValence","warning","showWarning","warnings","lsb","asterisk","attpntText","pos1","attpntPath1","attpntRbb","lsbn","fromRelBox","shiftBondEnd","arrowLeft","arrowRight","attpntPath","showAttpnt","bisectLargestSector","aamText","getAamText","queryAttrsText","getQueryAttrsText","labelStyle","flag","stereoLabelType","Classic","IUPAC","shouldDisplayStereoLabel","stereoLabelStyle","aamPath","colorStereogenicCenters","BondsOnly","getColorFromStereoLabel","getStereoAtomColor","childNodes","setAttribute","opacity","stereoLabelNumber","autoFadeOfStereoLabels","getStereoAtomOpacity","aamBox","t","isHighlighted","highlightColor","highlight","hasCurrentHighlight","style","colorOfAndCenters","colorOfOrCenters","colorOfAbsoluteCenters","angles","daMax","margin","ReBond","doubleBondShift","bondRecalc","isBondInContractedFunctionalGroup","bid0","halfbonds","findIncomingStereoUpBond","boldStereo","checkStereoBold","loop1","loop2","selectDoubleBondShiftChain","d1","d2","selectDoubleBondShift","setDoubleBondShift","shiftA","shiftB","findIncomingUpBonds","neihbid1","neihbid2","getBondSingleStereoBoldPath","coords","stereoUpBondGetCoordinates","getStereoBondColor","getBondSingleUpPath","interval","getBondSingleDownPath","getBondSingleEitherPath","getBondLineShift","getBondDoubleStereoBoldPath","s1","s2","getBondDoublePath","getBondAromaticPath","getSingleOrDoublePath","getBondPath","lw","bs","alongIntRc","alongIntMadeBroken","alongSz","acrossInt","acrossSz","tiltTan","getReactingCenterPath","fixed","getTopologyMark","ipath","bondIdxOff","subFontSize","showBondIds","getIdsPath","showHalfBondIds","showLoopIds","highlightPath","beginning","pathString","getHighlightPath","includeBoldStereoBond","neibond","defaultColor","beginAtomStereoLabel","endAtomStereoLabel","LabelsOnly","coords1","coords2","neihbid","neihb","cosHalf","biss","dashdotPattern","getAromaticBondPaths","param1","param2","pb","lc","irbb","atom1","atom2","nLeft","nRight","ReEnhancedFlag","hoverPath","getDefaultStereoFlagPosition","stereoFlagMap","absFlagLabel","andFlagLabel","mixedFlagLabel","orFlagLabel","showStereoFlags","ReFrag","firstFrag","secondFrag","_ui_editor","calcBBox","keyOf","BORDER_EXT","ReRGroup","labelBox","fragGetAtoms","fragGetBonds","bbf","rGroupdrawBrackets","labelSet","fontRLabel","logicStyle","fontRLogic","rLogicToString","logicPath","logicBox","_draw","fnum","drawing","cy","leftBracket","rightBracket","ifThen","rangeExists","restH","nextRg","ReRxnArrow","distRef","point","per","calculateDistanceToLine","refPoint","getReferencePointDistance","getReferencePoints","rp","generatePath","refPoints","_paper","scaleFactor","selectionSet","scaledRP","arrowParams","getArrowParams","x1","x2","y2","_id","ReRxnPlus","ReDataSGroupData","dataArea","ReSGroup","remol","firstSgroupAtom","SGroupdrawBrackets","calculatePP","nameI","showValue","boxI","sboxI","drawAttachedDat","sbox","sgroupData","drawAbsoluteDat","drawGroupDat","getHighlighPathInfo","startX","startY","sGroupItem","lowerIndexText","upperIndexText","indexAttribute","BracketParams","crossBondsValues","tl","tr","tt","tb","cc","dt","bracketR","renderIndex","indexPos","indexPath","indexBox","toFront","contractedFunctionalGroupSize","hoverPp","ReSimpleObject","simpleObject","pointToCenter","topX","topY","bottomX","bottomY","distances","onlyOnObject","poly","atan","stylesApplied","enhPath","hoverStyleSimpleObject","ReLoop","rlid","apos","bpos","aromaticCircle","pathStr","halfAngle","qi","ReText","getRelBox","topLeft","leftEdge","firstRow","topEdge","widestRow","nextRow","getRowWidth","lastElOfWidestRow","rightEdge","lastRow","bottomEdge","row","rowWidth","paperScale","shiftY","rawContentState","blocks","block","ranges","getRanges","shiftX","start","flatten","getStyles","nextStyles","isEqual","inlineStyleRanges","inlineRange","customFontSize","FontSize","textRange","Bold","Italic","Subscript","Superscript","ReStruct","initLayers","clearMarks","lid","reloops","enhancedFlags","reAtom","adjacentComponents","neighbor","halfBond","compId","aidSet","getConnectedComponent","ccFragmentType","ccid","removeConnectedComponent","addConnectedComponent","layers","class","visible","parentNode","insertBefore","maps","structChanged","markItem","mapChanged","clearVisel","selection","isSelectionEmpty","eachItem","scaleRPath","scaleVisel","force","initialized","_item","atomsChanged","connectedComponentRemoveAtom","clearConnectedComponents","atomsChangedArray","assignConnectedComponents","verifyLoops","updLoops","updateLoops","showLabels","showBonds","showLoops","showReactionSymbols","showSGroups","showFragments","showRGroups","showEnhancedFlags","showSimpleObjects","showTexts","reloop","markBond","simpleObjectsChanged","textsChanged","rxnArrowsChanged","rxnPlusesChanged","resgroup","bondlist","markAtom","isValid","loopRemove","enhancedFlagsChanged","chid","bondsChanged","redraw","mapValues","isSelectable","sGroupAtoms","showItemSelection","exists","items","isSelectionSvgObjectExists","makeSelectionPlate","FRAC","calcAngle","fracAngle","angle2","round","degrees","calcNewAtomPos","ctrlKey","setFracAngle","mergeBondsParams","struct1","struct2","begin1","begin2","end1","end2","mergeAngle","merged","inRange","Render","clientArea","opt","renderWidth","clientWidth","renderHeight","clientHeight","userOpts","ZERO","rotationStep","labelFontSize","autoScale","autoScaleMargin","maxBondLength","hideImplicitHydrogen","hideTerminalLabels","doubleBondWidth","stereoBondWidth","bondThickness","view2obj","isRelative","scroll","scrollPos","useOldZoom","obj2view","scrollLeft","scrollTop","page2obj","pagePos","curtop","curleft","offsetTop","offsetLeft","offsetParent","top","cumulativeOffset","pageX","pageY","setPaperSize","setSize","setViewBox","setOffset","newoffset","setZoom","setScrollOffset","cx","sSz","x0","y0","ey","calcExtend","update","setScale","canvas","setMolecule","viewSz","changes","setSelection","sf","sz1","marg","mv","csz","sz2","UNIT","eb","vb","cb","oldCb","oldBb","BaseOperation","priority","execute","_inverted","invert","level","halfBondId","invalidateLoop","bondId","halfBond1","halfBond2","invalidateAtom","invalidateBond","invalidateItem","OperationType","freeze","ATOM_ADD","ATOM_DELETE","ATOM_ATTR","ATOM_MOVE","CALC_IMPLICIT_H","BOND_ADD","BOND_DELETE","BOND_ATTR","BOND_MOVE","LOOP_MOVE","S_GROUP_ATOM_ADD","S_GROUP_ATOM_REMOVE","S_GROUP_ATTR","S_GROUP_CREATE","S_GROUP_DELETE","S_GROUP_ADD_TO_HIERACHY","S_GROUP_REMOVE_FROM_HIERACHY","R_GROUP_ATTR","R_GROUP_FRAGMENT","UPDATE_IF_THEN","RESTORE_IF_THEN","RXN_ARROW_ADD","RXN_ARROW_DELETE","RXN_ARROW_MOVE","RXN_ARROW_RESIZE","RXN_PLUS_ADD","RXN_PLUS_DELETE","RXN_PLUS_MOVE","S_GROUP_DATA_MOVE","CANVAS_LOAD","ALIGN_DESCRIPTORS","SIMPLE_OBJECT_ADD","SIMPLE_OBJECT_DELETE","SIMPLE_OBJECT_MOVE","SIMPLE_OBJECT_RESIZE","RESTORE_DESCRIPTORS_POSITION","FRAGMENT_ADD","FRAGMENT_DELETE","FRAGMENT_STEREO_FLAG","FRAGMENT_ADD_STEREO_ATOM","FRAGMENT_DELETE_STEREO_ATOM","ENHANCED_FLAG_MOVE","TEXT_CREATE","TEXT_UPDATE","TEXT_DELETE","TEXT_MOVE","ADD_HIGHLIGHT","UPDATE_HIGHLIGHT","REMOVE_HIGHLIGHT","AtomAttr","attribute","data2","inverted","AtomMove","noinvalidate","reatom","AtomAdd","atomSetPos","AtomDelete","restructedAtom","markItemRemoved","BondAttr","BondMove","BondAdd","structBond","atomAddNeighbor","BondDelete","rebond","prev","CanvasLoad","oldStruct","clearVisels","AlignDescriptors","history","structBox","alignPoint","RestoreDescriptorsPosition","EnhancedFlagMove","currentPosition","newPosition","UpdateIfThen","rgNew","rgOld","skipRgids","rgid_new","rgid_old","ifThenHistory","RestoreIfThen","rgValue","FragmentAdd","FragmentDelete","enhancedFalg","FragmentAddStereoAtom","invalidateEnhancedFlag","FragmentDeleteStereoAtom","FragmentStereoFlag","updateStereoFlag","CalcImplicitH","aids","atomIds","aIds","LoopMove","RGroupAttr","rgroupId","rgp","RGroupFragment","rg_new","rg_old","findRGroupByFragment","removeOld","setNew","RxnArrowMove","Base","move","RxnArrowResize","anchor","previousPos0","get_xy0","previousPos1","RxnPlusMove","RxnPlusAdd","plid","newRxn","structRxn","rxnPlusSetPos","RxnPlusDelete","RxnArrowAdd","itemId","positions","rxnArrowSetPos","RxnArrowDelete","performed","SimpleObjectAdd","toCircle","makeCircleFromEllipse","simpleObjectSetPos","SimpleObjectDelete","SimpleObjectMove","handleRectangleChangeWithAnchor","SimpleObjectResize","circlePoint","position0","position1","SGroupAtomAdd","SGroupAtomRemove","removeAtom","SGroupAttr","setAttr","SGroupDataMove","SGroupAddToHierarchy","relations","SGroupRemoveFromHierarchy","SGroupCreate","SGroupDelete","relatedFGroupId","fgid","TextCreate","textSetPosition","TextDelete","TextUpdate","previousContent","TextMove","difference","Action","operations","operation","isDummy","action","invertedOperation","perform","addOp","fromAromaticTemplateOnBond","template","events","simpleFusing","getBondFragment","atomsInStruct","getFragmentWithBondMap","SELECTION_DISTANCE_COEFFICIENT","findMaps","findClosestAtom","findClosestBond","inBox","xDist","firstAtomPp","pg","rxnArrow","calcDistance","ref","skip","closestAtom","closestBond","contains","cursorPosition","referencePoints","skipId","closestBondCenter","maxMinDist","minCDist","mid","cdist","mp","merge","srcId","atomGetAttr","atomGetDegree","atomGetSGroups","atomGetPos","findStereoAtoms","structSelection","atomForNewBond","prevBondId","prevBondType","neiPos","maxI","maxAngle","neiNeighbours","neiV","neiAngle","neiNei","neiNeiPos","vDiff","prevBondAngle","closest","getRelSgroupsBySelection","selectedAtoms","_sgid","fromRGroupAttrs","fromRGroupFragment","rgidNew","fromUpdateIfThen","rgidOld","fromSeveralSgroupAddition","descriptors","fromSgroupAddition","fValue","localAttrs","mergeWith","setExpandSGroup","fromAtomsAttrs","sGroupAttributeAction","fromSgroupDeletion","sG","sGroupsRecalcCrossBonds","getAttrs","asteriskAction","plainCarbon","isPlainCarbon","fromSgroupAttrs","fromSgroupAction","newSg","sourceAtoms","SgContexts","currSelection","getAtomsBondIds","uniq","bondid","fromBondAction","atomsFromBonds","newSourceAtoms","fromGroupAction","Multifragment","fromMultiFragmentAction","Group","fromAtomAction","targetAtoms","allFragments","fragId","removeAtomFromSgroupIfNeeded","removeSgroupIfNeeded","sgCounts","fromBondAddition","pos2","mergeFragments","mergeSgroups","bnd","fromBondStereoUpdate","mergeFragmentsIfNeeded","fromBondsAttrs","reset","attrGetDefault","withReverse","beginFrId","endFrId","fragmentStereoBonds","getStereoAtomsMap","stereoProp","aId","fromStereoAtomAttrs","stereoAtomsMap","correctAtomIds","getStereoParity","newAtomParity","bondChangingAction","itemID","bondProps","newItemId","isInteger","fromBondFlipping","plainBondTypes","fromAtomAddition","atomNeighbors","fromAtomsFragmentAttr","newfrid","oldfrid","fromAtomMerge","dstId","fragAction","mergeBondId","getAttrHash","dstAtomNeighbors","frid2","fridAtoms","atomsToNewFrag","moveAtomsAction","srcAtoms","dstAtom","without","fromNewCanvas","fromDescriptorsAlign","fromChain","dx","dy","chainItems","fromItemsFuse","usedAtoms","dst","src","mergeMap","atomPairs","bondCI","fromBondsMerge","getItemsToFuse","editor","mergeItems","closestMap","closestToMerge","findMerge","getHoverToFuse","hoverItems","now","fromMultipleMove","lists","atomsToInvalidate","rxnPulse","sgData","fromStereoFlagUpdate","processAtom","usedIds","fromFragmentSplit","rgForRemove","fromOneAtomDeletion","fromFragmentDeletion","fromBondDeletion","skipAtoms","atomsToRemove","fromOneBondDeletion","frids","actionRemoveDataSGroups","actionRemoveBonds","frid3","fromPaste","pstruct","xy0","getStructCenter","fridMap","pasteItems","tmpAtom","newsgid","oper","__frag","newRgId","onlyOneStructsSgroupId","xmin","ymin","xmax","ymax","fromArrowAddition","fromArrowResizing","fromArrowDeletion","fromPlusAddition","fromPlusDeletion","fromFlip","fids","allFragmentsOfStructure","selectedFragmentsOfStructure","bbox","calcCenter","flipItemByCenter","fromRotate","rotateDelta","did","stereoFlags","flagId","fromBondAlign","fromSimpleObjectDeletion","fromSimpleObjectAddition","fromSimpleObjectResizing","fromTemplateOnCanvas","fromTemplateOnAtom","extraBond","tmpl","extraRes","additionalAtom","middleAtom","actionRes","extraBondAction","angle0","fromTemplateOnBondAction","flip","fromTemplateOnBond","tmplBond","tmplBegin","atomsMap","bondAtoms","mergeA","tBond","existId","fromTextCreation","fromTextUpdating","fromTextDeletion","HighlightAdd","highlightId","notifyChanged","HighlightDelete","highlightToRemove","reAtoms","reBonds","fromHighlightCreate","fromHighlightClear","newData","oldData","highlightToUpdate","oldAtoms","oldBonds","oldColor","updatedHighlight","HighlightUpdate","parseStruct","structStr","create","getStructure","structureFormat","formatterFactory","getStructureFromStructAsync","Ketcher","isExtended","molfileFormat","containsReaction","rxnfile","withAuxInfo","meta","generateImageAsBase64","base64","byteCharacters","atob","byteNumbers","charCodeAt","byteArray","Uint8Array","Blob","DefaultStructServiceOptions","structServiceProvider","serviceOptions","mergedServiceOptions","createStructService","ketcher","Miew","StandaloneStructServiceProvider","require","App","hiddenButtonsConfig","hiddenButtons","window","button","hidden","getHiddenButtonsConfig","useState","hasError","setHasError","errorMessage","setErrorMessage","errorHandler","buttons","staticResourcesUrl","onInit","close","cliparea","querySelector","focus","createApi","clean","aromatize","dearomatize","calculateCip","automap","check","calculate","recognize","appContext","React","createContext","errorsContext","settingsContext","formContext","basicAtoms","atomCuts","A","shortcut","tool","opts","copyAs","currentState","structSelected","structData","clipboardData","setData","navigator","clipboard","writeText","server","factory","service","generateImage","backgroundColor","image","ClipboardItem","isHidden","buttonName","debugObj","molStr","molQs","encodeURIComponent","qs","ieCb","ClipArea","textAreaRef","createRef","listeners","mouseup","event","isActiveElement","focused","select","mousedown","shiftKey","preventDefault","copy","onCopy","cut","onCut","paste","onPaste","formats","getData","fmt","en","addEventListener","removeEventListener","_jsx","className","clsx","classes","contentEditable","autoFocus","suppressContentEditableWarning","Component","tagName","actions","enabled","queryCommandSupported","execCommand","ClipboardEvent","default","enum","enumNames","LabelsAndBonds","minimum","maximum","SERVER_OPTIONS","miew","miewMode","miewTheme","miewAtomLabel","MIEW_OPTIONS","optionsSchema","required","properties","resetToSelect","getDefaultOptions","storage","localStorage","getItem","isSet","setItem","initOptionsState","app","templates","analyse","roundWeight","roundMass","roundElAnalysis","checkOptions","file","settings","errProps","jsonschema","property","validation","getServerSettings","pick","appUpdate","dispatch","recognizeActions","setStruct","mapOf","oneOf","desc","constant","radioButtonsSchema","contextSchema","sData","radiobuttons","minLength","invalidMessage","sdataCustomSchema","sdataSchema","firstKeyOf","obj","getSdataDefault","correctErrors","payload","onContextChange","onFieldNameChange","formsState","atomProps","primary","secondary","moleculeErrors","labelEdit","rgroupLogic","save","filename","attach","sdata","initSdata","updateFormState","formReducer","formName","init","actionContext","actionFieldName","newstate","sdataReducer","INDIGO_VERIFICATION","indigoVerification","initialState","supportedSGroupTypes","maxLength","pattern","rgroupSchema","sgroupMap","minium","attachSchema","fromElement","selem","satom","fromAtom","ap","sap","toElement","toAtomList","capitalize","toAtom","pch","atomSchema","conv","toBond","toBondType","caption","bondCaptionMap","fromBondType","single","up","down","updown","double","crossed","triple","singledouble","singlearomatic","doublearomatic","dative","fromSgroup","ssgroup","toSgroup","toolActions","erase","chain","transforms","arrows","shapes","bondCuts","typeSchema","bondSchema","onAction","dialog","thunk","load","getState","formatterOptions","confirm","sgId","getOffset","updateOffset","stereAtomsMap","isBlank","tools","optsTypes","ketcherErrors","checkParams","badVal","ketcherCheck","types","serverCall","serverTransform","loadedStruct","explicitSelected","omit","config","disabled","arom","dearom","cip","standalone","templateLib","_tool","zoomList","findLastIndex","functionalGroupsLib","__","open","undo","historySize","redo","dontClipMessage","hasSelection","copies","copyImageToClipboard","active","help","about","selectionTool","toolbar","visibleTools","alignDescriptors","debug","icons","CopyIcon","dropdown","logo","emptyIcon","Icon","hasOwnProperty","findIconByName","shortcutAliasMap","Escape","Delete","Mod","platform","shortcutStr","ActionButton","disableableButtons","_jsxs","onClick","stopPropagation","Portal","createElement","isElementInDom","isOpen","addElementInDOM","addClassName","updateStyle","removeElementFromDOM","prevProps","removeClassNames","appendChild","removeChild","classNames","classList","prevStyle","ReactDOM","createPortal","DefaultMultiTool","toolbarItem","currentStatus","GroupedMultiTool","groups","descriptor","ToolbarMultiToolItem","variant","opened","vertical","onOpen","useRef","setIsOpen","useEffect","currentId","usePortalOpening","portalStyle","setPortalStyle","getBoundingClientRect","scrollOffset","scrollingElement","usePortalStyle","selectedTool","displayMultiToolItem","option","actionButtonProps","defaultClasses","chooseMultiTool","portalClassName","ToolbarGroupItem","TemplatesList","isTemplate","makeAction","initLib","lib","initTmplLib","cacheEl","deserializeSdfTemplates","userLib","userTmpls","fileName","sdfSerializer","prefetchStatic","tmpls","prefetch","files","prefetchSplit","fn","svgs","svgContent","innerHTML","prefetchRender","cachedFiles","pr","prerender","openDialog","dialogName","onResult","onCancel","updateLocalStore","initTmplsState","tmplActions","attachActions","activeTool","actObj","actionName","pickBy","initial","freqAtoms","currentAtom","updateVisibleTools","visibleTool","regExp","menuHeight","innerHeight","addFreqAtom","toolInMenu","toolName","sel","getElementById","base","findEl","getComputedStyle","overflow","hiddenAncestor","shared","combineReducers","actionState","isEmpty","newState","correctTools","isSelected","menuName","modal","formState","form","store","loading","requestsStatuses","setEditor","restOptions","initState","middleware","rootReducer","sh","finalState","getRootReducer","createStore","applyMiddleware","BottomToolbarContainer","connect","rest","makeItems","bondCommon","bondStereo","bondQuery","bondSpecial","groupOptions","groupDescriptors","accum","rGroupOptions","shapeOptions","transformOptions","selectOptions","arrowsOptions","mappingOptions","useSettingsContext","useContext","SettingsContext","useThrottleResizeObserver","onResize","useMemo","throttle","useResizeObserver","useFormContext","FormContext","useAppContext","AppContext","useInterval","callback","delay","savedCallback","setInterval","clearInterval","ArrowScroll","startInView","endInView","scrollUp","scrollDown","isScrollDown","setScrollDown","isScrollUp","setScrollUp","onMouseUp","onMouseDown","mediaSizes","Shape","Transform","LeftToolbarContainer","scrollRef","useInView","threshold","startRef","endRef","sizeRef","Item","visibleItems","_createElement","offsetHeight","AtomsList","forwardRef","isAtom","RightToolbarContainer","toPercent","ZoomList","onChange","parsedValue","HelpLink","href","rel","copyOptions","TopToolbarContainer","isZoomListHidden","mac","normalizeKeyName","alt","ctrl","mod","normalizeKeyMap","modifiers","altKey","metaKey","rusToEng","KN","keyCode","normalizeKeyEvent","isChar","keyNorm","KeyboardEvent","initKeydownListener","hotKeys","act","actName","setHotKey","initHotKeys","actionTool","atomsSelected","letter","lookup","checkGroupOnTool","clipArea","newAction","keyHandle","baseName","rxnTextPlain","initClipboard","debAction","debounce","loadStruct","clipData","AppClipArea","AppHiddenContainer","onInitTmpls","Dialog","dialogRef","useLayoutEffect","getElementsByClassName","exit","role","onSubmit","onKeyDown","activeElement","activeTextarea","tabIndex","Spinner","APointTool","mousemove","ci","findItem","click","atomResult","atomsInFunctionalGroup","elementEdit","newatom","fgId","findFunctionalGroupByAtom","removeFG","fgIds","AtomTool","atomLongtapEvent","dragCtx","atomid","fgs","timeout","quickEdit","stopTapping","clearTimeout","AttachTool","attachPoints","BondTool","ChainTool","ChargeTool","isPointInPolygon","v0","n0","d0","w0","flag1","flag0","w1","selectedSgroup","firstAtom","extraNeighbour","rnd","newAtomPos","bondResult","bondsInFunctionalGroup","attachEdit","findFunctionalGroupByBond","endAtom","beginPos","endPos","closestSGroup","fGroupId","fGroup","fGroupAtoms","MAX_VALUE","xy1","xy","bondAddition","sectCount","newItems","cancel","mouseleave","inRectangle","bondList","relatedFGId","rxnArrowsList","rxnPlusesList","simpleObjectsList","enhancedFlagList","sgroupDataList","textsList","inPolygon","rr","LassoHelper","getSelection","locate","points","running","addPoint","dp","searchMaps","SGroupTool","actualSgroupId","extraAtoms","newSelected","atomsResult","atomFromStruct","sgroupAtoms","sgroupBonds","sgroupDialog","lassoHelper","defaultType","eventName","manyComponentsSelected","singleComponentSelected","sgBonds","anyChainedBonds","getContextBySgroup","getContextBySelection","fromContextType","allBondsSelected","fixedBond","countOfSelectedComponents","bondFromStruct","extraBonds","bondsResult","selMerge","SelectTool","selectedSgroups","selectFragment","closestToSel","previous","expSel","ra","selectionAtoms","bondEdit","bondsSelection","newbond","reversible","dest","xor","uniqArray","EraserTool","PasteTool","lastEvent","RGroupAtomTool","propsDialog","RGroupFragmentTool","ReactionArrowTool","getDefaultLengthPos","newPos","ReactionMapTool","isValidMap","rcs","ri","ro","po","ReactionPlusTool","ReactionUnmapTool","RotateTool","SimpleObjectTool","TemplateTool","findItems","getSign","preResult","ce","rgroupEdit","newRg","isNew","updateLine","aam1","aam2","rotId","rotAll","neiHb","angle1","closestItem","sGroupResult","frIds","sign1","sign2","extra_bond","completeAction","TextTool","origilContent","rgroupatom","eraser","rgroupfragment","apoint","reactionarrow","reactionplus","reactionmap","reactionunmap","enhancedStereo","EnhancedStereoTool","stereoLabels","stereoAtom","enhancedStereoEdit","changeAtomsStereoAction","simpleobject","Highlighter","highlightsMap","createdHighlights","arg","getValidInputOnly","validAtoms","validBonds","structAtoms","structBonds","structObjects","highlightTargets","selectStereoFlagsIfNecessary","expAtoms","atomsOfFragments","shouldSelSFlag","Editor","_selection","historyStack","historyPtr","Subscription","PipelineSubscription","sgroupEdit","sdataEdit","change","selectionChange","aromatizeStruct","dearomatizeStruct","DOMSubscription","subs","which","isMouseRight","nodeName","EditorTool","domEventSetup","toolMap","recoordinate","newTool","ignoreHistory","HISTORY_SIZE","handler","subscriber","subscribeFuncWrapper","op","to","arid","customOnChangeHandler","srcItems","isRxn","item1","item2","FGContextMenu","getKetcherInstance","showSGroupMenu","setShowSGroupMenu","targetItems","setTargetItems","ContextMenu","onShow","selectedItems","detail","fgroup","showMenu","MenuItem","expandData","divider","setupEditor","oldProps","toolOpts","upperFirst","StructEditor","editorRef","logRef","nextProps","msg","parsedInfo","removeEditorHandlers","Tag","onSelectionChange","onElementEdit","onEnhancedStereoEdit","onQuickEdit","onBondEdit","onRgroupEdit","onSgroupEdit","onSdataEdit","onRemoveFG","onMessage","onAromatizeStruct","onDearomatizeStruct","onAttachEdit","onCipChange","hideMenu","holdToDisplay","About","indigoInfo","Logo","buildDate","GenericInput","onInput","TextArea","CheckBox","checked","Select","onSelect","multiple","enumSchema","FieldSet","defaultChecked","cbOrIndex","isTypeValue","ctrlMap","testVal","ev","multipleSelectCtrl","singleSelectCtrl","inputCtrl","input","isNumber","o","selectedIndex","fieldset","querySelectorAll","inp","Input","componentMap","shallowCompare","Form","onUpdate","propSchema","errs","getErrorsObj","customValid","updateState","self","dataError","Provider","stateStore","Label","labelPos","Field","fieldOpts","formField","SelectOneOf","selectDesc","validator","customFormats","inst","rewrite","serializeRewrite","deserializeRewrite","serializeMap","deserializeMap","getInvalidMessage","Accordion","setState","prevState","childrenWithProps","Children","child","isActive","groupIsActive","onActive","isValidElement","cloneElement","ColorPicker","handleChange","useCallback","HexColorPicker","HexColorInput","MeasureInput","cust","meas","calcValue","handleMeasChange","convValue","convertValue","onBlur","measureMap","px","cm","pt","inch","measureFrom","measureTo","OpenButton","FileReader","throughFileReader","ActiveXObject","fso","fd","OpenTextFile","ReadAll","Close","throughFileSystemObject","fileOpener","opener","noop","onLoad","onError","btn","accept","onload","msClose","onerror","readAsText","SaveButton","onSave","saveFile","fileSaver","saveImage","saveAs","SelectCheckbox","currentSchema","commonFonts","SystemFonts","availableFonts","setAvailableFonts","onChangeCallback","mounted","availableFontsPromises","fontName","FontFaceObserver","checkInSystem","results","fonts","Settings","appOpts","ownProps","onOpenFile","newOpts","onReset","onOk","newSettings","settingsSchema","ErrorsCheck","checkSchema","moleculeErrorsTypes","getOptionName","nameIndex","Tabs","changeTab","tabs","contentClassName","tabPanel","componentProps","Check","checkState","onCheck","captions","formulaRegexp","errorRegexp","formulaInputMarkdown","onKeyPress","FormulaInput","cnd","FrozenInput","spellCheck","roundOff","AnalyseDialog","onAnalyse","onChangeRound","withSelector","ErrorsContext","Analyse","serverSettings","roundName","changeRound","Spin","StructRender","tagRef","renderStruct","isImage","URL","webkitURL","createObjectURL","Recognize","isFragment","onImage","changeImage","onRecognize","ver","rec","onChangeImago","partProps","canPreviewImage","setCanPreviewImage","clearFile","BACKGROUND_COLOR","dark","light","MIEW_TX_TYPES","no","bright","colorer","blackAndWhite","bg","createMiewOptions","autoPreset","editing","inversePanning","reps","textMode","selector","showBg","TXoptions","MiewDialog","miewOpts","viewer","container","miewContainer","run","sourceType","fileType","setOptions","cmlStruct","exportCML","onExportCML","ElementNumber","readOnly","AtomContainer","currentLabel","setCurrentLabel","onLabelChangeCallback","newValue","atomValid","chargeValid","AttachPointsContainer","attachmentPointsSchema","automapSchema","AutomapContainer","BondContainer","IfThenSelect","rgroupLabels","rgroupLabel","RgroupLogicContainer","rangeConv","OpenContainer","setStructStr","setFragment","structAcceptMimes","SaveImageTab","changeImageFormat","extension","renderOptions","saveSchema","SaveDialog","disableControls","onResetForm","saveWarning","formatName","rxnArrowsSize","hasGenerics","rxnArrowMode","isRg","ind","isVal","structFormat","showStructWarningMessage","imageFormat","getWarnings","changeType","isCleanStruct","isMoleculeContain","onTmplSave","renderSaveFile","getButtons","tab","Save","saveUserTmpl","findStereLabels","maxAnd","stereLabels","numbers","maxOfAnds","maxOr","maxOfOrs","andNumber","orNumber","EmptySearchResult","textInfo","GREEK_SIMBOLS","Alpha","alpha","Beta","beta","Gamma","gamma","greekRe","RegExp","greekify","sym","tmplName","RenderTmpl","TemplateTable","onDelete","onAttach","ITEMS_COUNT","ITEM_SIZE","tmplStyles","minWidth","functionalGroupsSelector","modeSelector","labelEditSchema","AtomInfo","isInfo","numberStyle","fontSize","elemStyle","fontWeight","Header","MainRow","refer","currentEvents","atomClassNames","colSpan","OutinerRow","metalPrefix","beforeSpan","ACTINIDE","LANTHANIDE","main","lanthanides","actinides","ElementsTable","callbacks","table","summary","getAtomClassNames","main_row","outiner_row","GenSet","viewSchema","GenGroup","gen","pk","subgroup","GenericGroups","col","TypeChoice","Table","firstType","onMouseEnter","onMouseLeave","genType","periodicTable","changeTabType","mapSelectionToProps","PeriodTable","ButtonList","disabledIds","multipl","oneOrMore","ComboBox","suggestsHidden","blur","updateInput","textContent","suggestList","suggestListStyles","autoComplete","SelectInput","inputSelect","formSchema","schemes","EDITOR_STYLES","Attach","normTmpl","structNormalization","initTmpl","onNameEdit","getScale","checkUniqueName","placeholder","initAttach","setTmplName","normStruct","cbb","rxnPlus","SelectList","splitIndexes","isSplitIndex","filterLibSelector","createSelector","re","escapeRegExp","flow","_filter","onFilter","changeFilter","selectTmpl","onChangeGroup","changeGroup","formData","editTmpl","deleteUserTmpl","deleteTmpl","String","dialog_body","tableGroupWrap","singleColLayout","g","FontControl","editorState","setEditorState","defaultFontSize","isShowingFontSizeMenu","setIsShowingFontSizeMenu","currentFontSize","setCurrentFontSize","currentStyle","fontSizes","MAX_FONT_SIZE","fontSizeOptions","newEditorState","setFontSize","TextButton","command","toggleStyle","createStyles","customStyleFn","EditorState","moveFocusToEnd","createWithContent","convertFromRaw","entityMap","getCurrentInlineStyle","RichUtils","toggleInlineStyle","getCurrentContent","hasText","convertToRaw","keyBindingFn","getDefaultKeyBinding","customStyleMap","SUBSCRIPT","verticalAlign","transformOrigin","SUPERSCRIPT","Open","Rgroup","TemplateAttach","TemplatesDialog","AttachPoints","Automap","EnhancedStereo","LabelEdit","RgroupLogic","Sgroup","Sdata","fGroups","useDispatch","useSelector","setSelected","setFilter","filteredLib","setFilteredLib","expandedTemplates","filterFGLib","handleOk","handleResult","molSaveData","ModalContainer","_result","stateProps","dispatchProps","initProps","containerRef","modals","initEditor","updateAction","sleep","time","selectMode","resetOption","acts","dlg","fromStereoLabel","toStereoLabel","sbond","serverOpts","mapDispatchToProps","checkServer","AppContainer","provider","setFunctionalGroupsList","AppModalContainer","initApp","KetcherBuilder","serviceMode","buildNumber","initialMol","builder","appendApiAsync","appendServiceMode","appendUiAsync","rootElRef","buildKetcherAsync","ErrorModal","Command","SupportedFormat","convertMimeTypeToOutputFormat","mimeType","Smarts","Ket","IndigoService","worker","IndigoWorker","onmessage","terminate","postMessage","Info","commandOptions","commandData","inputMessage","Convert","Layout","Clean","Aromatize","Dearomatize","CalculateCip","curr","mappedProperty","mapWarningGroup","calculatedProperties","mappedPropertyName","mapCalculatedPropertyName","Calculate","GenerateImageAsBase64","StandaloneStructService"],"mappings":"01GAsBaA,EAAiC,CAC5CC,EAAG,UACHC,GAAI,UACJC,GAAI,UACJC,GAAI,UACJC,EAAG,UACHC,EAAG,UACHC,EAAG,UACHC,EAAG,UACHC,EAAG,UACHC,GAAI,UACJC,GAAI,UACJC,GAAI,UACJC,GAAI,UACJC,GAAI,UACJC,EAAG,UACHC,EAAG,UACHC,GAAI,UACJC,GAAI,UACJC,EAAG,UACHC,GAAI,UACJC,GAAI,UACJC,GAAI,UACJC,EAAG,UACHC,GAAI,UACJC,GAAI,UACJC,GAAI,UACJC,GAAI,UACJC,GAAI,UACJC,GAAI,UACJC,GAAI,UACJC,GAAI,UACJC,GAAI,UACJC,GAAI,UACJC,GAAI,UACJC,GAAI,UACJC,GAAI,UACJC,GAAI,UACJC,GAAI,UACJC,EAAG,UACHC,GAAI,UACJC,GAAI,UACJC,GAAI,UACJC,GAAI,UACJC,GAAI,UACJC,GAAI,UACJC,GAAI,UACJC,GAAI,UACJC,GAAI,UACJC,GAAI,UACJC,GAAI,UACJC,GAAI,UACJC,GAAI,UACJC,EAAG,UACHC,GAAI,UACJC,GAAI,UACJC,GAAI,UACJC,GAAI,UACJC,GAAI,UACJC,GAAI,UACJC,GAAI,UACJC,GAAI,UACJC,GAAI,UACJC,GAAI,UACJC,GAAI,UACJC,GAAI,UACJC,GAAI,UACJC,GAAI,UACJC,GAAI,UACJC,GAAI,UACJC,GAAI,UACJC,GAAI,UACJC,GAAI,UACJC,GAAI,UACJC,EAAG,UACHC,GAAI,UACJC,GAAI,UACJC,GAAI,UACJC,GAAI,UACJC,GAAI,UACJC,GAAI,UACJC,GAAI,UACJC,GAAI,UACJC,GAAI,UACJC,GAAI,UACJC,GAAI,UACJC,GAAI,UACJC,GAAI,UACJC,GAAI,UACJC,GAAI,UACJC,GAAI,UACJC,GAAI,UACJC,EAAG,UACHC,GAAI,UACJC,GAAI,UACJC,GAAI,UACJC,GAAI,UACJC,GAAI,UACJC,GAAI,UACJC,GAAI,UAEJC,GAAI,UACJC,GAAI,UACJC,GAAI,UACJC,GAAI,UACJC,GAAI,UACJC,GAAI,UACJC,GAAI,UACJC,GAAI,UACJC,G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mF,KAAM,SAAUqqE,OAAQsiB,GAAMmC,GAAezkB,WAG5DoT,OAAQ,SAAApvE,GAAO,OAAIwyE,GAASxyE,EAAS,yBAEpCiyE,IACA4O,IACAvC,IACAliF,IACAq2C,IACAqkC,IACAvsE,IAGL,SAAS41E,GAAa7Z,GACpB,IAAMve,EAAYue,EAAOve,YACzB,OACEA,GACA9tD,OAAOmK,KAAK2jD,GAAWx1D,QAAO,SAAAD,GAAG,OAAK,CAAC,cAAcgN,SAAShN,MAAMoC,OAClE,EAIN,SAASwrF,GAAgB1uF,EAAOm+E,GAC9BA,EACE,kEAEEn+E,EACA,K,0spBCvGN,IAAMsvF,GAAQ,CACZN,M,4yBACAzJ,Q,0qDACAqI,K,omCACA,W,sZACA,gB,kZACA,e,6aACA,gB,6nBACA,c,0TACA,c,0RACA,sB,kjBACA,Y,qsBACA,c,iOACA,sB,qaACA,oB,ukBACA,c,wVACA,U,kNACA,c,kbACAjC,M,2QACA,e,u5BACA,c,ogCACA1M,M,qVACA,c,ikDACA6O,I,kWACAlP,M,4xBACAgQ,OAAQW,GACRnN,KAAMmN,GACN,a,qqFACA,W,+gCACA,W,4+BACAjN,I,okFACAuL,O,42BACA2B,S,kVACA,kB,00FACA9D,M,u9EACA,oB,giBACA,iB,qpBACAqD,K,sgCACA/6C,O,u3BACAy7C,K,i1BACApL,K,0xEACAjjE,M,ytHACAktE,K,07DACA9L,M,ogDACA,e,4pDACA,4B,0QACA,iC,wUACA,4B,uWACA,mC,kcACA,wB,8iBACA,2C,6WAEA,6C,g3BAEA,6C,sgBAEA,wC,icACA,wD,w2BAEA,wD,qcAEA,8D,03BAEA,6D,62BAEA,mB,gXACA,e,+RACA,gB,sOACA,iB,0YACArD,U,ohCACAsP,K,6xCACA,mB,4ZACA,kB,+tCACA,e,kkBACAvG,K,uzEACA,kB,+5BACA,e,wgOACA,mB,6pCACArC,S,29DACA,c,o5BACA5xE,O,4SACA,a,meACA,a,maACA,a,qTACA,a,wSACA,a,uOACA,a,qPACA,a,oXACA,a,oVACA,e,ydACA68B,K,gvCACA,Y,6cACA,c,yRACA,iB,0aACA,mB,s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","file":"static/js/main.287e9b3d.chunk.js","sourcesContent":["/****************************************************************************\n * Copyright 2021 EPAM Systems\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *    http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n ***************************************************************************/\n\nimport type { ElementLabel } from './element.types'\n\ntype ElementColorType = {\n  [key in ElementLabel]: string\n}\n\nexport const ElementColor: ElementColorType = {\n  H: '#000000',\n  He: '#89a1a1',\n  Li: '#bd77ed',\n  Be: '#8fbc00',\n  B: '#c18989',\n  C: '#000000',\n  N: '#304ff7',\n  O: '#ff0d0d',\n  F: '#78bc42',\n  Ne: '#80a2af',\n  Na: '#ab5cf2',\n  Mg: '#6fcd00',\n  Al: '#a99393',\n  Si: '#b29478',\n  P: '#ff8000',\n  S: '#c99a19',\n  Cl: '#1fd01f',\n  Ar: '#69acba',\n  K: '#8f40d4',\n  Ca: '#38e900',\n  Sc: '#999999',\n  Ti: '#979a9e',\n  V: '#99999e',\n  Cr: '#8a99c7',\n  Mn: '#9c7ac7',\n  Fe: '#e06633',\n  Co: '#d37e8e',\n  Ni: '#4ece4e',\n  Cu: '#c78033',\n  Zn: '#7d80b0',\n  Ga: '#bc8b8b',\n  Ge: '#668f8f',\n  As: '#b87ddd',\n  Se: '#e59100',\n  Br: '#a62929',\n  Kr: '#59b1c9',\n  Rb: '#702eb0',\n  Sr: '#00ff00',\n  Y: '#66afaf',\n  Zr: '#71abab',\n  Nb: '#67aeb4',\n  Mo: '#54b5b5',\n  Tc: '#3b9e9e',\n  Ru: '#248f8f',\n  Rh: '#0a7d8c',\n  Pd: '#006985',\n  Ag: '#9a9a9a',\n  Cd: '#b29764',\n  In: '#a67573',\n  Sn: '#668080',\n  Sb: '#9e63b5',\n  Te: '#d47a00',\n  I: '#940094',\n  Xe: '#429eb0',\n  Cs: '#57178f',\n  Ba: '#00c900',\n  La: '#5caed1',\n  Ce: '#9d9d7b',\n  Pr: '#8ca581',\n  Nd: '#84a984',\n  Pm: '#71b18a',\n  Sm: '#66b68e',\n  Eu: '#4ac298',\n  Gd: '#37cb9e',\n  Tb: '#28d1a4',\n  Dy: '#1bd7a8',\n  Ho: '#00e98f',\n  Er: '#00e675',\n  Tm: '#00d452',\n  Yb: '#00bf38',\n  Lu: '#00ab24',\n  Hf: '#47b3ec',\n  Ta: '#4da6ff',\n  W: '#2194d6',\n  Re: '#267dab',\n  Os: '#266696',\n  Ir: '#175487',\n  Pt: '#9898a3',\n  Au: '#c19e1c',\n  Hg: '#9797ac',\n  Tl: '#a6544d',\n  Pb: '#575961',\n  Bi: '#9e4fb5',\n  Po: '#ab5c00',\n  At: '#754f45',\n  Rn: '#428296',\n  Fr: '#420066',\n  Ra: '#007d00',\n  Ac: '#6aa2ec',\n  Th: '#00baff',\n  Pa: '#00a1ff',\n  U: '#008fff',\n  Np: '#0080ff',\n  Pu: '#006bff',\n  Am: '#545cf2',\n  Cm: '#785ce3',\n  Bk: '#8a4fe3',\n  Cf: '#a136d4',\n  Es: '#b31fd4',\n  // Need to fix colors for the elements below (c)\n  Fm: '#000000',\n  Md: '#000000',\n  No: '#000000',\n  Lr: '#000000',\n  Rf: '#47b3ec',\n  Db: '#4da6ff',\n  Sg: '#2194d6',\n  Bh: '#267dab',\n  Hs: '#266696',\n  Mt: '#175487',\n  Ds: '#9898a3',\n  Rg: '#c19e1c',\n  Cn: '#9797ac',\n  Nh: '#000000',\n  Fl: '#000000',\n  Mc: '#000000',\n  Lv: '#000000',\n  Ts: '#000000',\n  Og: '#000000'\n} as const\n","/****************************************************************************\n * Copyright 2021 EPAM Systems\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *    http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n ***************************************************************************/\n\nimport type { Element } from './element.types'\n\nconst elementsArray: Array<Element> = [\n  {\n    number: 1,\n    label: 'H',\n    period: 1,\n    group: 1,\n    title: 'Hydrogen',\n    state: 'gas',\n    origin: 'primordial',\n    type: 'diatomic',\n    mass: 1.00794\n  },\n  {\n    number: 2,\n    label: 'He',\n    period: 1,\n    group: 8,\n    title: 'Helium',\n    state: 'gas',\n    origin: 'primordial',\n    type: 'noble',\n    mass: 4.0026022\n  },\n  {\n    number: 3,\n    label: 'Li',\n    period: 2,\n    group: 1,\n    title: 'Lithium',\n    state: 'solid',\n    origin: 'primordial',\n    type: 'alkali',\n    mass: 6.94\n  },\n  {\n    number: 4,\n    label: 'Be',\n    period: 2,\n    group: 2,\n    title: 'Beryllium',\n    state: 'solid',\n    origin: 'primordial',\n    type: 'alkaline-earth',\n    mass: 9.01218315\n  },\n  {\n    number: 5,\n    label: 'B',\n    period: 2,\n    group: 3,\n    title: 'Boron',\n    state: 'solid',\n    origin: 'primordial',\n    type: 'metalloid',\n    mass: 10.81\n  },\n  {\n    number: 6,\n    label: 'C',\n    period: 2,\n    group: 4,\n    title: 'Carbon',\n    state: 'solid',\n    origin: 'primordial',\n    type: 'polyatomic',\n    mass: 12.011\n  },\n  {\n    number: 7,\n    label: 'N',\n    period: 2,\n    group: 5,\n    title: 'Nitrogen',\n    state: 'gas',\n    origin: 'primordial',\n    type: 'diatomic',\n    mass: 14.007\n  },\n  {\n    number: 8,\n    label: 'O',\n    period: 2,\n    group: 6,\n    leftH: true,\n    title: 'Oxygen',\n    state: 'gas',\n    origin: 'primordial',\n    type: 'diatomic',\n    mass: 15.999\n  },\n  {\n    number: 9,\n    label: 'F',\n    period: 2,\n    group: 7,\n    leftH: true,\n    title: 'Fluorine',\n    state: 'gas',\n    origin: 'primordial',\n    type: 'diatomic',\n    mass: 18.9984031636\n  },\n  {\n    number: 10,\n    label: 'Ne',\n    period: 2,\n    group: 8,\n    title: 'Neon',\n    state: 'gas',\n    origin: 'primordial',\n    type: 'noble',\n    mass: 20.17976\n  },\n  {\n    number: 11,\n    label: 'Na',\n    period: 3,\n    group: 1,\n    title: 'Sodium',\n    state: 'solid',\n    origin: 'primordial',\n    type: 'alkali',\n    mass: 22.989769282\n  },\n  {\n    number: 12,\n    label: 'Mg',\n    period: 3,\n    group: 2,\n    title: 'Magnesium',\n    state: 'solid',\n    origin: 'primordial',\n    type: 'alkaline-earth',\n    mass: 24.305\n  },\n  {\n    number: 13,\n    label: 'Al',\n    period: 3,\n    group: 3,\n    title: 'Aluminium',\n    state: 'solid',\n    origin: 'primordial',\n    type: 'post-transition',\n    mass: 26.98153857\n  },\n  {\n    number: 14,\n    label: 'Si',\n    period: 3,\n    group: 4,\n    title: 'Silicon',\n    state: 'solid',\n    origin: 'primordial',\n    type: 'metalloid',\n    mass: 28.085\n  },\n  {\n    number: 15,\n    label: 'P',\n    period: 3,\n    group: 5,\n    title: 'Phosphorus',\n    state: 'solid',\n    origin: 'primordial',\n    type: 'polyatomic',\n    mass: 30.9737619985\n  },\n  {\n    number: 16,\n    label: 'S',\n    period: 3,\n    group: 6,\n    leftH: true,\n    title: 'Sulfur',\n    state: 'solid',\n    origin: 'primordial',\n    type: 'polyatomic',\n    mass: 32.06\n  },\n  {\n    number: 17,\n    label: 'Cl',\n    period: 3,\n    group: 7,\n    leftH: true,\n    title: 'Chlorine',\n    state: 'gas',\n    origin: 'primordial',\n    type: 'diatomic',\n    mass: 35.45\n  },\n  {\n    number: 18,\n    label: 'Ar',\n    period: 3,\n    group: 8,\n    title: 'Argon',\n    state: 'gas',\n    origin: 'primordial',\n    type: 'noble',\n    mass: 39.9481\n  },\n  {\n    number: 19,\n    label: 'K',\n    period: 4,\n    group: 1,\n    title: 'Potassium',\n    state: 'solid',\n    origin: 'primordial',\n    type: 'alkali',\n    mass: 39.09831\n  },\n  {\n    number: 20,\n    label: 'Ca',\n    period: 4,\n    group: 2,\n    title: 'Calcium',\n    state: 'solid',\n    origin: 'primordial',\n    type: 'alkaline-earth',\n    mass: 40.0784\n  },\n  {\n    number: 21,\n    label: 'Sc',\n    period: 4,\n    group: 3,\n    title: 'Scandium',\n    state: 'solid',\n    origin: 'primordial',\n    type: 'transition',\n    mass: 44.9559085\n  },\n  {\n    number: 22,\n    label: 'Ti',\n    period: 4,\n    group: 4,\n    title: 'Titanium',\n    state: 'solid',\n    origin: 'primordial',\n    type: 'transition',\n    mass: 47.8671\n  },\n  {\n    number: 23,\n    label: 'V',\n    period: 4,\n    group: 5,\n    title: 'Vanadium',\n    state: 'solid',\n    origin: 'primordial',\n    type: 'transition',\n    mass: 50.94151\n  },\n  {\n    number: 24,\n    label: 'Cr',\n    period: 4,\n    group: 6,\n    title: 'Chromium',\n    state: 'solid',\n    origin: 'primordial',\n    type: 'transition',\n    mass: 51.99616\n  },\n  {\n    number: 25,\n    label: 'Mn',\n    period: 4,\n    group: 7,\n    title: 'Manganese',\n    state: 'solid',\n    origin: 'primordial',\n    type: 'transition',\n    mass: 54.9380443\n  },\n  {\n    number: 26,\n    label: 'Fe',\n    period: 4,\n    group: 8,\n    title: 'Iron',\n    state: 'solid',\n    origin: 'primordial',\n    type: 'transition',\n    mass: 55.8452\n  },\n  {\n    number: 27,\n    label: 'Co',\n    period: 4,\n    group: 8,\n    title: 'Cobalt',\n    state: 'solid',\n    origin: 'primordial',\n    type: 'transition',\n    mass: 58.9331944\n  },\n  {\n    number: 28,\n    label: 'Ni',\n    period: 4,\n    group: 8,\n    title: 'Nickel',\n    state: 'solid',\n    origin: 'primordial',\n    type: 'transition',\n    mass: 58.69344\n  },\n  {\n    number: 29,\n    label: 'Cu',\n    period: 4,\n    group: 1,\n    title: 'Copper',\n    state: 'solid',\n    origin: 'primordial',\n    type: 'transition',\n    mass: 63.5463\n  },\n  {\n    number: 30,\n    label: 'Zn',\n    period: 4,\n    group: 2,\n    title: 'Zinc',\n    state: 'solid',\n    origin: 'primordial',\n    type: 'transition',\n    mass: 65.382\n  },\n  {\n    number: 31,\n    label: 'Ga',\n    period: 4,\n    group: 3,\n    title: 'Gallium',\n    state: 'solid',\n    origin: 'primordial',\n    type: 'post-transition',\n    mass: 69.7231\n  },\n  {\n    number: 32,\n    label: 'Ge',\n    period: 4,\n    group: 4,\n    title: 'Germanium',\n    state: 'solid',\n    origin: 'primordial',\n    type: 'metalloid',\n    mass: 72.6308\n  },\n  {\n    number: 33,\n    label: 'As',\n    period: 4,\n    group: 5,\n    title: 'Arsenic',\n    state: 'solid',\n    origin: 'primordial',\n    type: 'metalloid',\n    mass: 74.9215956\n  },\n  {\n    number: 34,\n    label: 'Se',\n    period: 4,\n    group: 6,\n    leftH: true,\n    title: 'Selenium',\n    state: 'solid',\n    origin: 'primordial',\n    type: 'polyatomic',\n    mass: 78.9718\n  },\n  {\n    number: 35,\n    label: 'Br',\n    period: 4,\n    group: 7,\n    leftH: true,\n    title: 'Bromine',\n    state: 'liquid',\n    origin: 'primordial',\n    type: 'diatomic',\n    mass: 79.904\n  },\n  {\n    number: 36,\n    label: 'Kr',\n    period: 4,\n    group: 8,\n    title: 'Krypton',\n    state: 'gas',\n    origin: 'primordial',\n    type: 'noble',\n    mass: 83.7982\n  },\n  {\n    number: 37,\n    label: 'Rb',\n    period: 5,\n    group: 1,\n    title: 'Rubidium',\n    state: 'solid',\n    origin: 'primordial',\n    type: 'alkali',\n    mass: 85.46783\n  },\n  {\n    number: 38,\n    label: 'Sr',\n    period: 5,\n    group: 2,\n    title: 'Strontium',\n    state: 'solid',\n    origin: 'primordial',\n    type: 'alkaline-earth',\n    mass: 87.621\n  },\n  {\n    number: 39,\n    label: 'Y',\n    period: 5,\n    group: 3,\n    title: 'Yttrium',\n    state: 'solid',\n    origin: 'primordial',\n    type: 'transition',\n    mass: 88.905842\n  },\n  {\n    number: 40,\n    label: 'Zr',\n    period: 5,\n    group: 4,\n    title: 'Zirconium',\n    state: 'solid',\n    origin: 'primordial',\n    type: 'transition',\n    mass: 91.2242\n  },\n  {\n    number: 41,\n    label: 'Nb',\n    period: 5,\n    group: 5,\n    title: 'Niobium',\n    state: 'solid',\n    origin: 'primordial',\n    type: 'transition',\n    mass: 92.906372\n  },\n  {\n    number: 42,\n    label: 'Mo',\n    period: 5,\n    group: 6,\n    title: 'Molybdenum',\n    state: 'solid',\n    origin: 'primordial',\n    type: 'transition',\n    mass: 95.951\n  },\n  {\n    number: 43,\n    label: 'Tc',\n    period: 5,\n    group: 7,\n    title: 'Technetium',\n    state: 'solid',\n    origin: 'decay',\n    type: 'transition',\n    mass: 98\n  },\n  {\n    number: 44,\n    label: 'Ru',\n    period: 5,\n    group: 8,\n    title: 'Ruthenium',\n    state: 'solid',\n    origin: 'primordial',\n    type: 'transition',\n    mass: 101.072\n  },\n  {\n    number: 45,\n    label: 'Rh',\n    period: 5,\n    group: 8,\n    title: 'Rhodium',\n    state: 'solid',\n    origin: 'primordial',\n    type: 'transition',\n    mass: 102.905502\n  },\n  {\n    number: 46,\n    label: 'Pd',\n    period: 5,\n    group: 8,\n    title: 'Palladium',\n    state: 'solid',\n    origin: 'primordial',\n    type: 'transition',\n    mass: 106.421\n  },\n  {\n    number: 47,\n    label: 'Ag',\n    period: 5,\n    group: 1,\n    title: 'Silver',\n    state: 'solid',\n    origin: 'primordial',\n    type: 'transition',\n    mass: 107.86822\n  },\n  {\n    number: 48,\n    label: 'Cd',\n    period: 5,\n    group: 2,\n    title: 'Cadmium',\n    state: 'solid',\n    origin: 'primordial',\n    type: 'transition',\n    mass: 112.4144\n  },\n  {\n    number: 49,\n    label: 'In', // 49\n    period: 5,\n    group: 3,\n    title: 'Indium',\n    state: 'solid',\n    origin: 'primordial',\n    type: 'post-transition',\n    mass: 114.8181\n  },\n  {\n    number: 50,\n    label: 'Sn',\n    period: 5,\n    group: 4,\n    title: 'Tin',\n    state: 'solid',\n    origin: 'primordial',\n    type: 'post-transition',\n    mass: 118.7107\n  },\n  {\n    number: 51,\n    label: 'Sb',\n    period: 5,\n    group: 5,\n    title: 'Antimony',\n    state: 'solid',\n    origin: 'primordial',\n    type: 'metalloid',\n    mass: 121.7601\n  },\n  {\n    number: 52,\n    label: 'Te',\n    period: 5,\n    group: 6,\n    title: 'Tellurium',\n    state: 'solid',\n    origin: 'primordial',\n    type: 'metalloid',\n    mass: 127.603\n  },\n  {\n    number: 53,\n    label: 'I',\n    period: 5,\n    group: 7,\n    leftH: true,\n    title: 'Iodine',\n    state: 'solid',\n    origin: 'primordial',\n    type: 'diatomic',\n    mass: 126.904473\n  },\n  {\n    number: 54,\n    label: 'Xe',\n    period: 5,\n    group: 8,\n    title: 'Xenon',\n    state: 'gas',\n    origin: 'primordial',\n    type: 'noble',\n    mass: 131.2936\n  },\n  {\n    number: 55,\n    label: 'Cs',\n    period: 6,\n    group: 1,\n    title: 'Caesium',\n    state: 'solid',\n    origin: 'primordial',\n    type: 'alkali',\n    mass: 132.905451966\n  },\n  {\n    number: 56,\n    label: 'Ba',\n    period: 6,\n    group: 2,\n    title: 'Barium',\n    state: 'solid',\n    origin: 'primordial',\n    type: 'alkaline-earth',\n    mass: 137.3277\n  },\n  {\n    number: 57,\n    label: 'La',\n    period: 6,\n    group: 3,\n    title: 'Lanthanum',\n    state: 'solid',\n    origin: 'primordial',\n    type: 'lanthanide',\n    mass: 138.905477\n  },\n  {\n    number: 58,\n    label: 'Ce',\n    period: 6,\n    group: 3,\n    title: 'Cerium',\n    state: 'solid',\n    origin: 'primordial',\n    type: 'lanthanide',\n    mass: 140.1161\n  },\n  {\n    number: 59,\n    label: 'Pr',\n    period: 6,\n    group: 3,\n    title: 'Praseodymium',\n    state: 'solid',\n    origin: 'primordial',\n    type: 'lanthanide',\n    mass: 140.907662\n  },\n  {\n    number: 60,\n    label: 'Nd',\n    period: 6,\n    group: 3,\n    title: 'Neodymium',\n    state: 'solid',\n    origin: 'primordial',\n    type: 'lanthanide',\n    mass: 144.2423\n  },\n  {\n    number: 61,\n    label: 'Pm',\n    period: 6,\n    group: 3,\n    title: 'Promethium',\n    state: 'solid',\n    origin: 'decay',\n    type: 'lanthanide',\n    mass: 145\n  },\n  {\n    number: 62,\n    label: 'Sm',\n    period: 6,\n    group: 3,\n    title: 'Samarium',\n    state: 'solid',\n    origin: 'primordial',\n    type: 'lanthanide',\n    mass: 150.362\n  },\n  {\n    number: 63,\n    label: 'Eu',\n    period: 6,\n    group: 3,\n    title: 'Europium',\n    state: 'solid',\n    origin: 'primordial',\n    type: 'lanthanide',\n    mass: 151.9641\n  },\n  {\n    number: 64,\n    label: 'Gd',\n    period: 6,\n    group: 3,\n    title: 'Gadolinium',\n    state: 'solid',\n    origin: 'primordial',\n    type: 'lanthanide',\n    mass: 157.253\n  },\n  {\n    number: 65,\n    label: 'Tb',\n    period: 6,\n    group: 3,\n    title: 'Terbium',\n    state: 'solid',\n    origin: 'primordial',\n    type: 'lanthanide',\n    mass: 158.925352\n  },\n  {\n    number: 66,\n    label: 'Dy',\n    period: 6,\n    group: 3,\n    title: 'Dysprosium',\n    state: 'solid',\n    origin: 'primordial',\n    type: 'lanthanide',\n    mass: 162.5001\n  },\n  {\n    number: 67,\n    label: 'Ho',\n    period: 6,\n    group: 3,\n    title: 'Holmium',\n    state: 'solid',\n    origin: 'primordial',\n    type: 'lanthanide',\n    mass: 164.930332\n  },\n  {\n    number: 68,\n    label: 'Er',\n    period: 6,\n    group: 3,\n    title: 'Erbium',\n    state: 'solid',\n    origin: 'primordial',\n    type: 'lanthanide',\n    mass: 167.2593\n  },\n  {\n    number: 69,\n    label: 'Tm',\n    period: 6,\n    group: 3,\n    title: 'Thulium',\n    state: 'solid',\n    origin: 'primordial',\n    type: 'lanthanide',\n    mass: 168.934222\n  },\n  {\n    number: 70,\n    label: 'Yb',\n    period: 6,\n    group: 3,\n    title: 'Ytterbium',\n    state: 'solid',\n    origin: 'primordial',\n    type: 'lanthanide',\n    mass: 173.0451\n  },\n  {\n    number: 71,\n    label: 'Lu',\n    period: 6,\n    group: 3,\n    title: 'Lutetium',\n    state: 'solid',\n    origin: 'primordial',\n    type: 'lanthanide',\n    mass: 174.96681\n  },\n  {\n    number: 72,\n    label: 'Hf',\n    period: 6,\n    group: 4,\n    title: 'Hafnium',\n    state: 'solid',\n    origin: 'primordial',\n    type: 'transition',\n    mass: 178.492\n  },\n  {\n    number: 73,\n    label: 'Ta',\n    period: 6,\n    group: 5,\n    title: 'Tantalum',\n    state: 'solid',\n    origin: 'primordial',\n    type: 'transition',\n    mass: 180.947882\n  },\n  {\n    number: 74,\n    label: 'W',\n    period: 6,\n    group: 6,\n    title: 'Tungsten',\n    state: 'solid',\n    origin: 'primordial',\n    type: 'transition',\n    mass: 183.841\n  },\n  {\n    number: 75,\n    label: 'Re',\n    period: 6,\n    group: 7,\n    title: 'Rhenium',\n    state: 'solid',\n    origin: 'primordial',\n    type: 'transition',\n    mass: 186.2071\n  },\n  {\n    number: 76,\n    label: 'Os',\n    period: 6,\n    group: 8,\n    title: 'Osmium',\n    state: 'solid',\n    origin: 'primordial',\n    type: 'transition',\n    mass: 190.233\n  },\n  {\n    number: 77,\n    label: 'Ir',\n    period: 6,\n    group: 8,\n    title: 'Iridium',\n    state: 'solid',\n    origin: 'primordial',\n    type: 'transition',\n    mass: 192.2173\n  },\n  {\n    number: 78,\n    label: 'Pt',\n    period: 6,\n    group: 8,\n    title: 'Platinum',\n    state: 'solid',\n    origin: 'primordial',\n    type: 'transition',\n    mass: 195.0849\n  },\n  {\n    number: 79,\n    label: 'Au',\n    period: 6,\n    group: 1,\n    title: 'Gold',\n    state: 'solid',\n    origin: 'primordial',\n    type: 'transition',\n    mass: 196.9665695\n  },\n  {\n    number: 80,\n    label: 'Hg',\n    period: 6,\n    group: 2,\n    title: 'Mercury',\n    state: 'liquid',\n    origin: 'primordial',\n    type: 'transition',\n    mass: 200.5923\n  },\n  {\n    number: 81,\n    label: 'Tl',\n    period: 6,\n    group: 3,\n    title: 'Thallium',\n    state: 'solid',\n    origin: 'primordial',\n    type: 'post-transition',\n    mass: 204.38\n  },\n  {\n    number: 82,\n    label: 'Pb',\n    period: 6,\n    group: 4,\n    title: 'Lead',\n    state: 'solid',\n    origin: 'primordial',\n    type: 'post-transition',\n    mass: 207.21\n  },\n  {\n    number: 83,\n    label: 'Bi',\n    period: 6,\n    group: 5,\n    title: 'Bismuth',\n    state: 'solid',\n    origin: 'primordial',\n    type: 'post-transition',\n    mass: 208.980401\n  },\n  {\n    number: 84,\n    label: 'Po',\n    period: 6,\n    group: 6,\n    title: 'Polonium',\n    state: 'solid',\n    origin: 'decay',\n    type: 'post-transition',\n    mass: 209\n  },\n  {\n    number: 85,\n    label: 'At',\n    period: 6,\n    group: 7,\n    title: 'Astatine',\n    state: 'solid',\n    origin: 'decay',\n    type: 'metalloid',\n    mass: 210\n  },\n  {\n    number: 86,\n    label: 'Rn',\n    period: 6,\n    group: 8,\n    title: 'Radon',\n    state: 'gas',\n    origin: 'decay',\n    type: 'noble',\n    mass: 222\n  },\n  {\n    number: 87,\n    label: 'Fr',\n    period: 7,\n    group: 1,\n    title: 'Francium',\n    state: 'solid',\n    origin: 'decay',\n    type: 'alkali',\n    mass: 223\n  },\n  {\n    number: 88,\n    label: 'Ra',\n    period: 7,\n    group: 2,\n    title: 'Radium',\n    state: 'solid',\n    origin: 'decay',\n    type: 'alkaline-earth',\n    mass: 226\n  },\n  {\n    number: 89,\n    label: 'Ac',\n    period: 7,\n    group: 3,\n    title: 'Actinium',\n    state: 'solid',\n    origin: 'decay',\n    type: 'actinide',\n    mass: 227\n  },\n  {\n    number: 90,\n    label: 'Th',\n    period: 7,\n    group: 3,\n    title: 'Thorium',\n    state: 'solid',\n    origin: 'primordial',\n    type: 'actinide',\n    mass: 232.03774\n  },\n  {\n    number: 91,\n    label: 'Pa',\n    period: 7,\n    group: 3,\n    title: 'Protactinium',\n    state: 'solid',\n    origin: 'decay',\n    type: 'actinide',\n    mass: 231.035882\n  },\n  {\n    number: 92,\n    label: 'U',\n    period: 7,\n    group: 3,\n    title: 'Uranium',\n    state: 'solid',\n    origin: 'primordial',\n    type: 'actinide',\n    mass: 238.028913\n  },\n  {\n    number: 93,\n    label: 'Np',\n    period: 7,\n    group: 3,\n    title: 'Neptunium',\n    state: 'solid',\n    origin: 'decay',\n    type: 'actinide',\n    mass: 237\n  },\n  {\n    number: 94,\n    label: 'Pu',\n    period: 7,\n    group: 3,\n    title: 'Plutonium',\n    state: 'solid',\n    origin: 'decay',\n    type: 'actinide',\n    mass: 244\n  },\n  {\n    number: 95,\n    label: 'Am',\n    period: 7,\n    group: 3,\n    title: 'Americium',\n    state: 'solid',\n    origin: 'synthetic',\n    type: 'actinide',\n    mass: 243\n  },\n  {\n    number: 96,\n    label: 'Cm',\n    period: 7,\n    group: 3,\n    title: 'Curium',\n    state: 'solid',\n    origin: 'synthetic',\n    type: 'actinide',\n    mass: 247\n  },\n  {\n    number: 97,\n    label: 'Bk',\n    period: 7,\n    group: 3,\n    title: 'Berkelium',\n    state: 'solid',\n    origin: 'synthetic',\n    type: 'actinide',\n    mass: 247\n  },\n  {\n    number: 98,\n    label: 'Cf',\n    period: 7,\n    group: 3,\n    title: 'Californium',\n    state: 'solid',\n    origin: 'synthetic',\n    type: 'actinide',\n    mass: 251\n  },\n  {\n    number: 99,\n    label: 'Es',\n    period: 7,\n    group: 3,\n    title: 'Einsteinium',\n    state: 'solid',\n    origin: 'synthetic',\n    type: 'actinide',\n    mass: 252\n  },\n  {\n    number: 100,\n    label: 'Fm',\n    period: 7,\n    group: 3,\n    title: 'Fermium',\n    origin: 'synthetic',\n    type: 'actinide',\n    mass: 257\n  },\n  {\n    number: 101,\n    label: 'Md',\n    period: 7,\n    group: 3,\n    title: 'Mendelevium',\n    origin: 'synthetic',\n    type: 'actinide',\n    mass: 258\n  },\n  {\n    number: 102,\n    label: 'No',\n    period: 7,\n    group: 3,\n    title: 'Nobelium',\n    origin: 'synthetic',\n    type: 'actinide',\n    mass: 259\n  },\n  {\n    number: 103,\n    label: 'Lr',\n    period: 7,\n    group: 3,\n    title: 'Lawrencium',\n    origin: 'synthetic',\n    type: 'actinide',\n    mass: 266\n  },\n  {\n    number: 104,\n    label: 'Rf',\n    period: 7,\n    group: 4,\n    title: 'Rutherfordium',\n    origin: 'synthetic',\n    type: 'transition',\n    mass: 267\n  },\n  {\n    number: 105,\n    label: 'Db',\n    period: 7,\n    group: 5,\n    title: 'Dubnium',\n    origin: 'synthetic',\n    type: 'transition',\n    mass: 268\n  },\n  {\n    number: 106,\n    label: 'Sg',\n    period: 7,\n    group: 6,\n    title: 'Seaborgium',\n    origin: 'synthetic',\n    type: 'transition',\n    mass: 269\n  },\n  {\n    number: 107,\n    label: 'Bh',\n    period: 7,\n    group: 7,\n    title: 'Bohrium',\n    origin: 'synthetic',\n    type: 'transition',\n    mass: 270\n  },\n  {\n    number: 108,\n    label: 'Hs',\n    period: 7,\n    group: 8,\n    title: 'Hassium',\n    origin: 'synthetic',\n    type: 'transition',\n    mass: 269\n  },\n  {\n    number: 109,\n    label: 'Mt',\n    period: 7,\n    group: 8,\n    title: 'Meitnerium',\n    origin: 'synthetic',\n    mass: 278\n  },\n  {\n    number: 110,\n    label: 'Ds',\n    period: 7,\n    group: 8,\n    title: 'Darmstadtium',\n    origin: 'synthetic',\n    mass: 281\n  },\n  {\n    number: 111,\n    label: 'Rg',\n    period: 7,\n    group: 1,\n    title: 'Roentgenium',\n    origin: 'synthetic',\n    mass: 282\n  },\n  {\n    number: 112,\n    label: 'Cn',\n    period: 7,\n    group: 2,\n    title: 'Copernicium',\n    origin: 'synthetic',\n    type: 'transition',\n    mass: 285\n  },\n  {\n    number: 113,\n    label: 'Nh',\n    period: 7,\n    group: 3,\n    title: 'Nihonium',\n    origin: 'synthetic',\n    mass: 286\n  },\n  {\n    number: 114,\n    label: 'Fl',\n    period: 7,\n    group: 4,\n    title: 'Flerovium',\n    origin: 'synthetic',\n    type: 'post-transition',\n    mass: 289\n  },\n  {\n    number: 115,\n    label: 'Mc',\n    period: 7,\n    group: 5,\n    title: 'Moscovium',\n    origin: 'synthetic',\n    mass: 289\n  },\n  {\n    number: 116,\n    label: 'Lv',\n    period: 7,\n    group: 6,\n    title: 'Livermorium',\n    origin: 'synthetic',\n    mass: 293\n  },\n  {\n    number: 117,\n    label: 'Ts',\n    period: 7,\n    group: 7,\n    title: 'Tennessine',\n    origin: 'synthetic',\n    mass: 294\n  },\n  {\n    number: 118,\n    label: 'Og',\n    period: 7,\n    group: 8,\n    title: 'Oganesson',\n    origin: 'synthetic',\n    mass: 294\n  }\n]\n\nconst elementsMap = elementsArray.reduce((acc, element) => {\n  acc.set(element.label, element)\n  acc.set(element.number, element)\n  return acc\n}, new Map<string | number, Element>())\n\nexport const Elements = {\n  get: (key: number | string): Element | undefined => elementsMap.get(key),\n  filter: (predicate: (element: Element) => boolean): Array<Element> => {\n    return elementsArray.filter(predicate)\n  }\n}\n","/****************************************************************************\n * Copyright 2021 EPAM Systems\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *    http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n ***************************************************************************/\n\nexport const Generics = {\n  atom: {\n    any: {\n      labels: ['A', 'AH']\n    },\n    'no-carbon': {\n      labels: ['Q', 'QH']\n    },\n    metal: {\n      labels: ['M', 'MH']\n    },\n    halogen: {\n      labels: ['X', 'XH']\n    }\n  },\n  group: {\n    labels: ['G', 'GH', 'G*', 'GH*'],\n    acyclic: {\n      labels: ['ACY', 'ACH'],\n      carbo: {\n        labels: ['ABC', 'ABH'],\n        alkynyl: {\n          labels: ['AYL', 'AYH']\n        },\n        alkyl: {\n          labels: ['ALK', 'ALH']\n        },\n        alkenyl: {\n          labels: ['AEL', 'AEH']\n        }\n      },\n      hetero: {\n        labels: ['AHC', 'AHH'],\n        alkoxy: {\n          labels: ['AOX', 'AOH']\n        }\n      }\n    },\n    cyclic: {\n      labels: ['CYC', 'CYH'],\n      'no-carbon': {\n        labels: ['CXX', 'CXH']\n      },\n      carbo: {\n        labels: ['CBC', 'CBH'],\n        aryl: {\n          labels: ['ARY', 'ARH']\n        },\n        cycloalkyl: {\n          labels: ['CAL', 'CAH']\n        },\n        cycloalkenyl: {\n          labels: ['CEL', 'CEH']\n        }\n      },\n      hetero: {\n        labels: ['CHC', 'CHH'],\n        aryl: {\n          labels: ['HAR', 'HAH']\n        }\n      }\n    }\n  },\n  special: {\n    labels: ['H+', 'D', 'T', 'R', 'Pol']\n  }\n} as const\n","/****************************************************************************\n * Copyright 2021 EPAM Systems\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *    http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n ***************************************************************************/\n\nimport { ElementLabel, Elements } from 'domain/constants'\n\nexport interface AtomListParams {\n  readonly notList: boolean\n  readonly ids: Array<number>\n}\n\nexport class AtomList {\n  notList: boolean\n  ids: Array<number>\n\n  constructor(params: AtomListParams) {\n    this.notList = params.notList\n    this.ids = params.ids\n  }\n\n  labelList() {\n    const labels: Array<ElementLabel> = []\n    for (let id of this.ids) {\n      const currenElement = Elements.get(id)\n      currenElement && labels.push(currenElement!.label)\n    }\n\n    return labels\n  }\n\n  label() {\n    let label = '[' + this.labelList().join(',') + ']'\n    if (this.notList) {\n      label = '!' + label\n    }\n    return label\n  }\n\n  equals(atomList: AtomList) {\n    return (\n      this.notList === atomList.notList &&\n      (this.ids || []).sort().toString() ===\n        (atomList.ids || []).sort().toString()\n    )\n  }\n}\n","/****************************************************************************\n * Copyright 2021 EPAM Systems\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *    http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n ***************************************************************************/\n\nimport assert from 'assert'\n\nexport interface Point {\n  x?: number\n  y?: number\n  z?: number\n}\nexport class Vec2 {\n  static ZERO = new Vec2(0, 0)\n  static UNIT = new Vec2(1, 1)\n\n  x: number\n  y: number\n  z: number\n\n  constructor(point: Point)\n  constructor(x?: number, y?: number, z?: number)\n  constructor(...args: Array<any>) {\n    if (args.length === 0) {\n      this.x = 0\n      this.y = 0\n      this.z = 0\n    } else if (arguments.length === 1) {\n      this.x = parseFloat(args[0].x || 0)\n      this.y = parseFloat(args[0].y || 0)\n      this.z = parseFloat(args[0].z || 0)\n    } else if (arguments.length === 2) {\n      this.x = parseFloat(args[0] || 0)\n      this.y = parseFloat(args[1] || 0)\n      this.z = 0\n    } else if (arguments.length === 3) {\n      this.x = parseFloat(args[0])\n      this.y = parseFloat(args[1])\n      this.z = parseFloat(args[2])\n    } else {\n      throw new Error('Vec2(): invalid arguments')\n    }\n  }\n\n  static dist(a: Vec2, b: Vec2): number {\n    return Vec2.diff(a, b).length()\n  }\n\n  static max(v1: Vec2, v2: Vec2): Vec2 {\n    return new Vec2(\n      Math.max(v1.x, v2.x),\n      Math.max(v1.y, v2.y),\n      Math.max(v1.z, v2.z)\n    )\n  }\n\n  static min(v1: Vec2, v2: Vec2): Vec2 {\n    return new Vec2(\n      Math.min(v1.x, v2.x),\n      Math.min(v1.y, v2.y),\n      Math.min(v1.z, v2.z)\n    )\n  }\n\n  static sum(v1: Vec2, v2: Vec2): Vec2 {\n    return new Vec2(v1.x + v2.x, v1.y + v2.y, v1.z + v2.z)\n  }\n\n  static dot(v1: Vec2, v2: Vec2): number {\n    return v1.x * v2.x + v1.y * v2.y\n  }\n\n  static cross(v1: Vec2, v2: Vec2): number {\n    return v1.x * v2.y - v1.y * v2.x\n  }\n\n  static angle(v1: Vec2, v2: Vec2): number {\n    return Math.atan2(Vec2.cross(v1, v2), Vec2.dot(v1, v2))\n  }\n\n  static diff(v1: Vec2, v2: Vec2): Vec2 {\n    return new Vec2(v1.x - v2.x, v1.y - v2.y, v1.z - v2.z)\n  }\n\n  // assume arguments v1, f1, v2, f2, v3, f3, etc.\n  // where v[i] are vectors and f[i] are corresponding coefficients\n  static lc(...args: Array<Vec2 | number>): Vec2 {\n    let v = new Vec2()\n    for (let i = 0; i < arguments.length / 2; ++i)\n      v = v.addScaled(args[2 * i] as Vec2, args[2 * i + 1] as number)\n    return v\n  }\n\n  static lc2(v1: Vec2, f1: number, v2: Vec2, f2: number): Vec2 {\n    return new Vec2(\n      v1.x * f1 + v2.x * f2,\n      v1.y * f1 + v2.y * f2,\n      v1.z * f1 + v2.z * f2\n    )\n  }\n\n  static centre(v1: Vec2, v2: Vec2) {\n    return Vec2.lc2(v1, 0.5, v2, 0.5)\n  }\n\n  length(): number {\n    return Math.sqrt(this.x * this.x + this.y * this.y)\n  }\n\n  equals(v: Vec2): boolean {\n    return this.x === v.x && this.y === v.y && this.z === v.z\n  }\n\n  add(v: Vec2): Vec2 {\n    return new Vec2(this.x + v.x, this.y + v.y, this.z + v.z)\n  }\n\n  add_(v: Vec2): void {\n    this.x += v.x\n    this.y += v.y\n    this.z += v.z\n  }\n\n  get_xy0(): Vec2 {\n    return new Vec2(this.x, this.y)\n  }\n\n  sub(v: Vec2): Vec2 {\n    return new Vec2(this.x - v.x, this.y - v.y, this.z - v.z)\n  }\n\n  scaled(s: number): Vec2 {\n    return new Vec2(this.x * s, this.y * s, this.z * s)\n  }\n\n  negated(): Vec2 {\n    return new Vec2(-this.x, -this.y, -this.z)\n  }\n\n  yComplement(y1: number): Vec2 {\n    y1 = y1 || 0\n    return new Vec2(this.x, y1 - this.y, this.z)\n  }\n\n  addScaled(v: Vec2, f: number): Vec2 {\n    return new Vec2(this.x + v.x * f, this.y + v.y * f, this.z + v.z * f)\n  }\n\n  normalized(): Vec2 {\n    return this.scaled(1 / this.length())\n  }\n\n  normalize(): boolean {\n    const l = this.length()\n\n    if (l < 0.000001) return false\n\n    this.x /= l\n    this.y /= l\n\n    return true\n  }\n\n  turnLeft(): Vec2 {\n    return new Vec2(-this.y, this.x, this.z)\n  }\n\n  coordStr(): string {\n    return this.x.toString() + ' , ' + this.y.toString()\n  }\n\n  toString(): string {\n    return '(' + this.x.toFixed(2) + ',' + this.y.toFixed(2) + ')'\n  }\n\n  max(v: Vec2): Vec2 {\n    assert(v != null)\n\n    return Vec2.max(this, v)\n  }\n\n  min(v: Vec2): Vec2 {\n    return Vec2.min(this, v)\n  }\n\n  ceil(): Vec2 {\n    return new Vec2(Math.ceil(this.x), Math.ceil(this.y), Math.ceil(this.z))\n  }\n\n  floor(): Vec2 {\n    return new Vec2(Math.floor(this.x), Math.floor(this.y), Math.floor(this.z))\n  }\n\n  rotate(angle: number) {\n    const sin = Math.sin(angle)\n    const cos = Math.cos(angle)\n\n    return this.rotateSC(sin, cos)\n  }\n\n  rotateSC(sin: number, cos: number): Vec2 {\n    assert(sin === 0 || !!sin)\n    assert(cos === 0 || !!cos)\n\n    return new Vec2(\n      this.x * cos - this.y * sin,\n      this.x * sin + this.y * cos,\n      this.z\n    )\n  }\n\n  oxAngle(): number {\n    return Math.atan2(this.y, this.x)\n  }\n}\n","/****************************************************************************\n * Copyright 2021 EPAM Systems\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *    http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n ***************************************************************************/\n\nimport { AtomList, AtomListParams } from './atomList'\nimport { Point, Vec2 } from './vec2'\n\nimport { Elements } from 'domain/constants'\nimport { Pile } from './pile'\n\nfunction getValueOrDefault<T>(value: T | undefined, defaultValue: T): T {\n  return typeof value !== 'undefined' ? value : defaultValue\n}\n\nfunction getPseudo(label: string) {\n  return !Elements.get(label) &&\n    label !== 'L' &&\n    label !== 'L#' &&\n    label !== 'R#'\n    ? label\n    : ''\n}\n\nexport function radicalElectrons(radical: any) {\n  radical -= 0\n  if (radical === Atom.PATTERN.RADICAL.DOUPLET) return 1\n  else if (\n    radical === Atom.PATTERN.RADICAL.SINGLET ||\n    radical === Atom.PATTERN.RADICAL.TRIPLET\n  )\n    return 2\n  else {\n    return 0\n  }\n}\n\nexport enum StereoLabel {\n  Abs = 'abs',\n  And = '&',\n  Or = 'or'\n}\n\nexport interface AtomAttributes {\n  stereoParity?: number\n  stereoLabel?: string | null\n  exactChangeFlag?: number\n  rxnFragmentType?: number\n  invRet?: number\n  aam?: number\n  hCount?: number\n  unsaturatedAtom?: number\n  substitutionCount?: number\n  ringBondCount?: number\n  explicitValence?: number\n  attpnt?: any\n  rglabel?: string | null\n  charge?: number\n  radical?: number\n  isotope?: number\n  alias?: string | null\n  pseudo?: string\n  atomList?: AtomListParams | null\n  label: string\n  fragment?: number\n  pp?: Point\n  implicitH?: number\n}\n\nexport class Atom {\n  static PATTERN = {\n    RADICAL: {\n      NONE: 0,\n      SINGLET: 1,\n      DOUPLET: 2,\n      TRIPLET: 3\n    },\n    STEREO_PARITY: {\n      NONE: 0,\n      ODD: 1,\n      EVEN: 2,\n      EITHER: 3\n    }\n  }\n\n  //TODO: rename\n  static attrlist = {\n    alias: null,\n    label: 'C',\n    isotope: 0,\n    radical: 0,\n    charge: 0,\n    explicitValence: -1,\n    ringBondCount: 0,\n    substitutionCount: 0,\n    unsaturatedAtom: 0,\n    hCount: 0,\n    atomList: null,\n    invRet: 0,\n    exactChangeFlag: 0,\n    rglabel: null,\n    attpnt: null,\n    aam: 0,\n    // enhanced stereo\n    stereoLabel: null,\n    stereoParity: 0\n  }\n\n  label: string\n  fragment: number\n  atomList: AtomList | null\n  attpnt: any\n  isotope: number\n  hCount: number\n  radical: number\n  charge: number\n  explicitValence: number\n  ringBondCount: number\n  unsaturatedAtom: number\n  substitutionCount: number\n  valence: number\n  implicitH: number\n  pp: Vec2\n  neighbors: Array<number>\n  sgs: Pile<any>\n  badConn: boolean\n  alias: string | null\n  rglabel: string | null\n  aam: number\n  invRet: number\n  exactChangeFlag: number\n  rxnFragmentType: number\n  stereoLabel?: string | null\n  stereoParity: number\n  hasImplicitH?: boolean\n  pseudo!: string\n\n  constructor(attributes: AtomAttributes) {\n    this.label = attributes.label\n    this.fragment = getValueOrDefault(attributes.fragment, -1)\n    this.alias = getValueOrDefault(attributes.alias, Atom.attrlist.alias)\n    this.isotope = getValueOrDefault(attributes.isotope, Atom.attrlist.isotope)\n    this.radical = getValueOrDefault(attributes.radical, Atom.attrlist.radical)\n    this.charge = getValueOrDefault(attributes.charge, Atom.attrlist.charge)\n    this.rglabel = getValueOrDefault(attributes.rglabel, Atom.attrlist.rglabel)\n    this.attpnt = getValueOrDefault(attributes.attpnt, Atom.attrlist.attpnt)\n    this.explicitValence = getValueOrDefault(\n      attributes.explicitValence,\n      Atom.attrlist.explicitValence\n    )\n\n    this.valence = 0\n    this.implicitH = attributes.implicitH || 0 // implicitH is not an attribute\n    this.pp = attributes.pp ? new Vec2(attributes.pp) : new Vec2()\n\n    // sgs should only be set when an atom is added to an s-group by an appropriate method,\n    //   or else a copied atom might think it belongs to a group, but the group be unaware of the atom\n    // TODO: make a consistency check on atom/s-group assignments\n    this.sgs = new Pile()\n\n    // query\n    this.ringBondCount = getValueOrDefault(\n      attributes.ringBondCount,\n      Atom.attrlist.ringBondCount\n    )\n    this.substitutionCount = getValueOrDefault(\n      attributes.substitutionCount,\n      Atom.attrlist.substitutionCount\n    )\n    this.unsaturatedAtom = getValueOrDefault(\n      attributes.unsaturatedAtom,\n      Atom.attrlist.unsaturatedAtom\n    )\n    this.hCount = getValueOrDefault(attributes.hCount, Atom.attrlist.hCount)\n\n    // reaction\n    this.aam = getValueOrDefault(attributes.aam, Atom.attrlist.aam)\n    this.invRet = getValueOrDefault(attributes.invRet, Atom.attrlist.invRet)\n    this.exactChangeFlag = getValueOrDefault(\n      attributes.exactChangeFlag,\n      Atom.attrlist.exactChangeFlag\n    )\n    this.rxnFragmentType = getValueOrDefault(attributes.rxnFragmentType, -1)\n\n    // stereo\n    this.stereoLabel = getValueOrDefault(\n      attributes.stereoLabel,\n      Atom.attrlist.stereoLabel\n    )\n    this.stereoParity = getValueOrDefault(\n      attributes.stereoParity,\n      Atom.attrlist.stereoParity\n    )\n\n    this.atomList = attributes.atomList\n      ? new AtomList(attributes.atomList)\n      : null\n    this.neighbors = [] // set of half-bonds having this atom as their origin\n    this.badConn = false\n\n    Object.defineProperty(this, 'pseudo', {\n      enumerable: true,\n      get: function () {\n        return getPseudo(this.label)\n      }\n    })\n  }\n\n  static getAttrHash(atom: Atom) {\n    const attrs = {}\n    for (let attr in Atom.attrlist) {\n      if (typeof atom[attr] !== 'undefined') attrs[attr] = atom[attr]\n    }\n    return attrs\n  }\n\n  static attrGetDefault(attr: string) {\n    if (attr in Atom.attrlist) {\n      return Atom.attrlist[attr]\n    }\n  }\n\n  clone(fidMap: Map<number, number>): Atom {\n    const ret = new Atom(this)\n    if (fidMap && fidMap.has(this.fragment))\n      ret.fragment = fidMap.get(this.fragment)!\n    return ret\n  }\n\n  isQuery(): boolean {\n    return (\n      this.atomList !== null || this.label === 'A' || this.attpnt || this.hCount\n    )\n  }\n\n  pureHydrogen(): boolean {\n    return this.label === 'H' && this.isotope === 0\n  }\n\n  isPlainCarbon(): boolean {\n    return (\n      this.label === 'C' &&\n      this.isotope === 0 &&\n      this.radical === 0 &&\n      this.charge === 0 &&\n      this.explicitValence < 0 &&\n      this.ringBondCount === 0 &&\n      this.substitutionCount === 0 &&\n      this.unsaturatedAtom === 0 &&\n      this.hCount === 0 &&\n      !this.atomList\n    )\n  }\n\n  isPseudo(): boolean {\n    // TODO: handle reaxys generics separately\n    return !this.atomList && !this.rglabel && !Elements.get(this.label)\n  }\n\n  hasRxnProps(): boolean {\n    return !!(\n      this.invRet ||\n      this.exactChangeFlag ||\n      this.attpnt !== null ||\n      this.aam\n    )\n  }\n\n  calcValence(conn: number): boolean {\n    const label = this.label\n    const charge = this.charge\n    if (this.isQuery()) {\n      this.implicitH = 0\n      return true\n    }\n    const element = Elements.get(label)\n    if (!element) {\n      this.implicitH = 0\n      return true\n    }\n\n    var groupno = element.group\n    var rad = radicalElectrons(this.radical)\n    var valence = conn\n    var hyd = 0\n    var absCharge = Math.abs(charge)\n    if (groupno === 1) {\n      if (\n        label === 'H' ||\n        label === 'Li' ||\n        label === 'Na' ||\n        label === 'K' ||\n        label === 'Rb' ||\n        label === 'Cs' ||\n        label === 'Fr'\n      ) {\n        valence = 1\n        hyd = 1 - rad - conn - absCharge\n      }\n    } else if (groupno === 2) {\n      if (conn + rad + absCharge === 2 || conn + rad + absCharge === 0)\n        valence = 2\n      else hyd = -1\n    } else if (groupno === 3) {\n      if (label === 'B' || label === 'Al' || label === 'Ga' || label === 'In') {\n        if (charge === -1) {\n          valence = 4\n          hyd = 4 - rad - conn\n        } else {\n          valence = 3\n          hyd = 3 - rad - conn - absCharge\n        }\n      } else if (label === 'Tl') {\n        if (charge === -1) {\n          if (rad + conn <= 2) {\n            valence = 2\n            hyd = 2 - rad - conn\n          } else {\n            valence = 4\n            hyd = 4 - rad - conn\n          }\n        } else if (charge === -2) {\n          if (rad + conn <= 3) {\n            valence = 3\n            hyd = 3 - rad - conn\n          } else {\n            valence = 5\n            hyd = 5 - rad - conn\n          }\n        } else if (rad + conn + absCharge <= 1) {\n          valence = 1\n          hyd = 1 - rad - conn - absCharge\n        } else {\n          valence = 3\n          hyd = 3 - rad - conn - absCharge\n        }\n      }\n    } else if (groupno === 4) {\n      if (label === 'C' || label === 'Si' || label === 'Ge') {\n        valence = 4\n        hyd = 4 - rad - conn - absCharge\n      } else if (label === 'Sn' || label === 'Pb') {\n        if (conn + rad + absCharge <= 2) {\n          valence = 2\n          hyd = 2 - rad - conn - absCharge\n        } else {\n          valence = 4\n          hyd = 4 - rad - conn - absCharge\n        }\n      }\n    } else if (groupno === 5) {\n      if (label === 'N' || label === 'P') {\n        if (charge === 1) {\n          valence = 4\n          hyd = 4 - rad - conn\n        } else if (charge === 2) {\n          valence = 3\n          hyd = 3 - rad - conn\n        } else if (label === 'N' || rad + conn + absCharge <= 3) {\n          valence = 3\n          hyd = 3 - rad - conn - absCharge\n        } else {\n          // ELEM_P && rad + conn + absCharge > 3\n          valence = 5\n          hyd = 5 - rad - conn - absCharge\n        }\n      } else if (label === 'Bi' || label === 'Sb' || label === 'As') {\n        if (charge === 1) {\n          if (rad + conn <= 2 && label !== 'As') {\n            valence = 2\n            hyd = 2 - rad - conn\n          } else {\n            valence = 4\n            hyd = 4 - rad - conn\n          }\n        } else if (charge === 2) {\n          valence = 3\n          hyd = 3 - rad - conn\n        } else if (rad + conn <= 3) {\n          valence = 3\n          hyd = 3 - rad - conn - absCharge\n        } else {\n          valence = 5\n          hyd = 5 - rad - conn - absCharge\n        }\n      }\n    } else if (groupno === 6) {\n      if (label === 'O') {\n        if (charge >= 1) {\n          valence = 3\n          hyd = 3 - rad - conn\n        } else {\n          valence = 2\n          hyd = 2 - rad - conn - absCharge\n        }\n      } else if (label === 'S' || label === 'Se' || label === 'Po') {\n        if (charge === 1) {\n          if (conn <= 3) {\n            valence = 3\n            hyd = 3 - rad - conn\n          } else {\n            valence = 5\n            hyd = 5 - rad - conn\n          }\n        } else if (conn + rad + absCharge <= 2) {\n          valence = 2\n          hyd = 2 - rad - conn - absCharge\n        } else if (conn + rad + absCharge <= 4) {\n          // See examples in PubChem\n          // [S] : CID 16684216\n          // [Se]: CID 5242252\n          // [Po]: no example, just following ISIS/Draw logic here\n          valence = 4\n          hyd = 4 - rad - conn - absCharge\n        } else {\n          // See examples in PubChem\n          // [S] : CID 46937044\n          // [Se]: CID 59786\n          // [Po]: no example, just following ISIS/Draw logic here\n          valence = 6\n          hyd = 6 - rad - conn - absCharge\n        }\n      } else if (label === 'Te') {\n        if (charge === -1) {\n          if (conn <= 2) {\n            valence = 2\n            hyd = 2 - rad - conn - absCharge\n          }\n        } else if (charge === 0 || charge === 2) {\n          if (conn <= 2) {\n            valence = 2\n            hyd = 2 - rad - conn - absCharge\n          } else if (conn <= 4) {\n            valence = 4\n            hyd = 4 - rad - conn - absCharge\n          } else if (charge === 0 && conn <= 6) {\n            valence = 6\n            hyd = 6 - rad - conn - absCharge\n          } else {\n            hyd = -1\n          }\n        }\n      }\n    } else if (groupno === 7) {\n      if (label === 'F') {\n        valence = 1\n        hyd = 1 - rad - conn - absCharge\n      } else if (\n        label === 'Cl' ||\n        label === 'Br' ||\n        label === 'I' ||\n        label === 'At'\n      ) {\n        if (charge === 1) {\n          if (conn <= 2) {\n            valence = 2\n            hyd = 2 - rad - conn\n          } else if (conn === 3 || conn === 5 || conn >= 7) {\n            hyd = -1\n          }\n        } else if (charge === 0) {\n          if (conn <= 1) {\n            valence = 1\n            hyd = 1 - rad - conn\n            // While the halogens can have valence 3, they can not have\n            // hydrogens in that case.\n          } else if (conn === 2 || conn === 4 || conn === 6) {\n            if (rad === 1) {\n              valence = conn\n              hyd = 0\n            } else {\n              hyd = -1 // will throw an error in the end\n            }\n          } else if (conn > 7) {\n            hyd = -1 // will throw an error in the end\n          }\n        }\n      }\n    } else if (groupno === 8) {\n      if (conn + rad + absCharge === 0) valence = 1\n      else hyd = -1\n    }\n\n    this.valence = valence\n    this.implicitH = hyd\n    if (this.implicitH < 0) {\n      this.valence = conn\n      this.implicitH = 0\n      this.badConn = true\n      return false\n    }\n    return true\n  }\n\n  calcValenceMinusHyd(conn: number): number {\n    const charge = this.charge\n    const label = this.label\n    const element = Elements.get(this.label)\n    if (!element) {\n      // query atom, skip\n      this.implicitH = 0\n      return 0\n    }\n\n    var groupno = element.group\n    var rad = radicalElectrons(this.radical)\n\n    if (groupno === 3) {\n      if (label === 'B' || label === 'Al' || label === 'Ga' || label === 'In') {\n        if (charge === -1) {\n          if (rad + conn <= 4) return rad + conn\n        }\n      }\n    } else if (groupno === 5) {\n      if (label === 'N' || label === 'P') {\n        if (charge === 1) return rad + conn\n        if (charge === 2) return rad + conn\n      } else if (label === 'Sb' || label === 'Bi' || label === 'As') {\n        if (charge === 1) return rad + conn\n        else if (charge === 2) return rad + conn\n      }\n    } else if (groupno === 6) {\n      if (label === 'O') {\n        if (charge >= 1) return rad + conn\n      } else if (label === 'S' || label === 'Se' || label === 'Po') {\n        if (charge === 1) return rad + conn\n      }\n    } else if (groupno === 7) {\n      if (label === 'Cl' || label === 'Br' || label === 'I' || label === 'At') {\n        if (charge === 1) return rad + conn\n      }\n    }\n\n    return rad + conn + Math.abs(charge)\n  }\n}\n","/****************************************************************************\n * Copyright 2021 EPAM Systems\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *    http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n ***************************************************************************/\n\nexport class Pile<TValue = any> extends Set<TValue> {\n  // TODO: it's used only in dfs.js in one place in some strange way.\n  // Should be removed after dfs.js refactoring\n  find(predicate: (item: TValue) => boolean) {\n    for (const item of this) {\n      if (predicate(item)) return item\n    }\n\n    return null\n  }\n\n  equals(setB: Pile): boolean {\n    return this.isSuperset(setB) && setB.isSuperset(this)\n  }\n\n  isSuperset(subset: Pile): boolean {\n    for (const item of subset) {\n      if (!this.has(item)) return false\n    }\n\n    return true\n  }\n\n  filter(expression: (arg: TValue) => boolean): Pile<TValue> {\n    return new Pile(Array.from(this).filter(expression))\n  }\n\n  union(setB: Pile): Pile<TValue> {\n    const union = new Pile(this)\n\n    for (const item of setB) union.add(item)\n\n    return union\n  }\n}\n","/****************************************************************************\n * Copyright 2021 EPAM Systems\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *    http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n ***************************************************************************/\n\nimport { Point, Vec2 } from './vec2'\n\nimport { Bond } from './bond'\nimport { StereoLabel } from './atom'\nimport { Struct } from './struct'\n\nexport enum StereoFlag {\n  Mixed = 'MIXED',\n  Abs = 'ABS',\n  And = 'AND',\n  Or = 'OR'\n}\n\nfunction calcStereoFlag(\n  struct: Struct,\n  stereoAids: Array<number>\n): StereoFlag | undefined {\n  if (!stereoAids || stereoAids.length === 0) return undefined\n  const filteredStereoAtoms = stereoAids\n    .map(aid => struct.atoms.get(aid))\n    .filter(atom => atom?.stereoLabel)\n  if (!filteredStereoAtoms.length) return undefined\n\n  const atom = filteredStereoAtoms[0]!\n  const stereoLabel = atom.stereoLabel! // {string | null} \"<abs|and|or>-<group>\"\n\n  const hasAnotherLabel = filteredStereoAtoms.some(\n    atom => atom?.stereoLabel !== stereoLabel\n  )\n\n  let stereoFlag: StereoFlag\n  if (hasAnotherLabel) {\n    stereoFlag = StereoFlag.Mixed\n  } else {\n    const label = stereoLabel.match(/\\D+/g)?.[0]\n    switch (label) {\n      case StereoLabel.Abs: {\n        stereoFlag = StereoFlag.Abs\n        break\n      }\n      case StereoLabel.And: {\n        stereoFlag = StereoFlag.And\n        break\n      }\n      case StereoLabel.Or: {\n        stereoFlag = StereoFlag.Or\n        break\n      }\n      default: {\n        throw new Error(`Unsupported stereo label: ${label}.`)\n      }\n    }\n  }\n  return stereoFlag\n}\n\nexport class Fragment {\n  #enhancedStereoFlag?: StereoFlag\n  stereoFlagPosition?: Vec2\n  #stereoAtoms: Array<number>\n\n  get stereoAtoms(): Array<number> {\n    return [...this.#stereoAtoms]\n  }\n\n  get enhancedStereoFlag() {\n    return this.#enhancedStereoFlag\n  }\n\n  constructor(stereoAtoms: Array<number> = [], stereoFlagPosition?: Point) {\n    if (stereoFlagPosition) {\n      this.stereoFlagPosition = new Vec2(stereoFlagPosition)\n    }\n\n    this.#stereoAtoms = stereoAtoms\n  }\n\n  static getDefaultStereoFlagPosition(\n    struct: Struct,\n    fragmentId: number\n  ): Vec2 | undefined {\n    const fragment = struct.getFragment(fragmentId)\n    if (!fragment) return undefined\n    const bb = fragment.getCoordBoundingBox()\n    return new Vec2(bb.max.x, bb.min.y - 1)\n  }\n\n  clone(aidMap: Map<number, number>) {\n    const stereoAtoms = this.#stereoAtoms.map(aid => aidMap.get(aid)!)\n    const fr = new Fragment(stereoAtoms, this.stereoFlagPosition)\n    fr.#enhancedStereoFlag = this.#enhancedStereoFlag\n    return fr\n  }\n\n  updateStereoFlag(struct: Struct) {\n    this.#enhancedStereoFlag = calcStereoFlag(struct, this.stereoAtoms)\n    return this.#enhancedStereoFlag\n  }\n\n  //TODO: split to 'add' and 'remove methods\n  updateStereoAtom(struct: Struct, aid: number, frId: number, isAdd: boolean) {\n    if (isAdd && !this.#stereoAtoms.includes(aid)) this.#stereoAtoms.push(aid)\n    if (\n      !isAdd &&\n      (struct.atoms.get(aid)?.fragment !== frId ||\n        !Array.from(struct.bonds.values())\n          .filter(bond => bond.stereo && bond.type !== Bond.PATTERN.TYPE.DOUBLE)\n          .some(bond => bond.begin === aid))\n    ) {\n      this.#stereoAtoms = this.stereoAtoms.filter(item => item !== aid)\n    }\n\n    this.#enhancedStereoFlag = calcStereoFlag(struct, this.stereoAtoms)\n  }\n\n  addStereoAtom(atomId: number): boolean {\n    if (!this.#stereoAtoms.includes(atomId)) {\n      this.stereoAtoms.push(atomId)\n      return true\n    }\n    return false\n  }\n\n  deleteStereoAtom(\n    struct: Struct,\n    fragmentId: number,\n    atomId: number\n  ): boolean {\n    if (\n      struct.atoms.get(atomId)?.fragment !== fragmentId ||\n      !Array.from(struct.bonds.values())\n        .filter(bond => bond.stereo && bond.type !== Bond.PATTERN.TYPE.DOUBLE)\n        .some(bond => bond.begin === atomId)\n    ) {\n      this.#stereoAtoms = this.#stereoAtoms.filter(item => item !== atomId)\n      return true\n    }\n    return false\n  }\n}\n","/****************************************************************************\n * Copyright 2021 EPAM Systems\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *    http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n ***************************************************************************/\n\nimport { Vec2 } from './vec2'\n\nexport interface BondAttributes {\n  reactingCenterStatus?: number\n  topology?: number\n  stereo?: number\n  xxx?: string\n  type: number\n  end: number\n  begin: number\n}\n\nexport class Bond {\n  static PATTERN = {\n    TYPE: {\n      SINGLE: 1,\n      DOUBLE: 2,\n      TRIPLE: 3,\n      AROMATIC: 4,\n      SINGLE_OR_DOUBLE: 5,\n      SINGLE_OR_AROMATIC: 6,\n      DOUBLE_OR_AROMATIC: 7,\n      ANY: 8,\n      DATIVE: 9,\n      HYDROGEN: 10\n    },\n\n    STEREO: {\n      NONE: 0,\n      UP: 1,\n      EITHER: 4,\n      DOWN: 6,\n      CIS_TRANS: 3\n    },\n\n    TOPOLOGY: {\n      EITHER: 0,\n      RING: 1,\n      CHAIN: 2\n    },\n\n    REACTING_CENTER: {\n      NOT_CENTER: -1,\n      UNMARKED: 0,\n      CENTER: 1,\n      UNCHANGED: 2,\n      MADE_OR_BROKEN: 4,\n      ORDER_CHANGED: 8,\n      MADE_OR_BROKEN_AND_CHANGED: 12\n    }\n  }\n\n  static attrlist = {\n    type: Bond.PATTERN.TYPE.SINGLE,\n    stereo: Bond.PATTERN.STEREO.NONE,\n    topology: Bond.PATTERN.TOPOLOGY.EITHER,\n    reactingCenterStatus: Bond.PATTERN.REACTING_CENTER.UNMARKED\n  }\n\n  begin: number\n  end: number\n  readonly type: number\n  readonly xxx: string\n  readonly stereo: number\n  readonly topology: number\n  readonly reactingCenterStatus: number\n  len: number\n  sb: number\n  sa: number\n  hb1?: number\n  hb2?: number\n  angle: number\n  center: Vec2\n\n  constructor(attributes: BondAttributes) {\n    this.begin = attributes.begin\n    this.end = attributes.end\n    this.type = attributes.type\n    this.xxx = attributes.xxx || ''\n    this.stereo = Bond.PATTERN.STEREO.NONE\n    this.topology = Bond.PATTERN.TOPOLOGY.EITHER\n    this.reactingCenterStatus = 0\n    this.len = 0\n    this.sb = 0\n    this.sa = 0\n    this.angle = 0\n\n    if (attributes.stereo) this.stereo = attributes.stereo\n    if (attributes.topology) this.topology = attributes.topology\n    if (attributes.reactingCenterStatus)\n      this.reactingCenterStatus = attributes.reactingCenterStatus\n\n    this.center = new Vec2()\n  }\n\n  static getAttrHash(bond: Bond) {\n    let attrs = {}\n    for (let attr in Bond.attrlist) {\n      if (bond[attr] || attr === 'stereo') {\n        attrs[attr] = bond[attr]\n      }\n    }\n    return attrs\n  }\n\n  static attrGetDefault(attr: string) {\n    if (attr in Bond.attrlist) {\n      return Bond.attrlist[attr]\n    }\n  }\n\n  hasRxnProps(): boolean {\n    return !!this.reactingCenterStatus\n  }\n\n  getCenter(struct: any): Vec2 {\n    const p1 = struct.atoms.get(this.begin).pp\n    const p2 = struct.atoms.get(this.end).pp\n    return Vec2.lc2(p1, 0.5, p2, 0.5)\n  }\n\n  getDir(struct: any): Vec2 {\n    const p1 = struct.atoms.get(this.begin)!.pp\n    const p2 = struct.atoms.get(this.end)!.pp\n    return p2.sub(p1).normalized()\n  }\n\n  clone(aidMap?: Map<number, number> | null): Bond {\n    const cp = new Bond(this)\n    if (aidMap) {\n      cp.begin = aidMap.get(cp.begin)!\n      cp.end = aidMap.get(cp.end)!\n    }\n    return cp\n  }\n}\n","/****************************************************************************\n * Copyright 2021 EPAM Systems\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *    http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n ***************************************************************************/\n\nimport { Vec2 } from 'domain/entities'\n\nexport interface ScaleOptions {\n  scale: number\n}\n\nfunction scaled2obj(v: Vec2, options: ScaleOptions): Vec2 {\n  return v.scaled(1 / options.scale)\n}\n\nfunction obj2scaled(v: Vec2, options: ScaleOptions): Vec2 {\n  return v.scaled(options.scale)\n}\n\nexport const Scale = {\n  scaled2obj,\n  obj2scaled\n}\n","/****************************************************************************\n * Copyright 2021 EPAM Systems\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *    http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n ***************************************************************************/\n\nimport { Bond, Neighbor, Struct } from 'domain/entities'\n\nfunction isCorrectStereoCenter(\n  bond: Bond,\n  beginNeighs: Array<Neighbor> | undefined,\n  endNeighs: Array<Neighbor> | undefined,\n  struct: Struct\n) {\n  const beginAtom = struct.atoms.get(bond.begin)\n\n  let EndAtomNeigh: number | undefined = NaN\n\n  if (endNeighs?.length === 2) {\n    EndAtomNeigh =\n      endNeighs[0].aid === bond.begin ? endNeighs[1].aid : endNeighs[0].aid\n  }\n\n  if (bond.stereo > 0) {\n    if (\n      endNeighs?.length === 1 &&\n      beginNeighs?.length === 2 &&\n      Number(beginAtom?.implicitH) % 2 === 0\n    ) {\n      return false\n    }\n\n    if (\n      endNeighs?.length === 2 &&\n      beginNeighs?.length === 2 &&\n      Number(beginAtom?.implicitH) % 2 === 0 &&\n      struct.atomGetNeighbors(EndAtomNeigh)?.length === 1\n    ) {\n      return false\n    }\n\n    if (beginNeighs?.length === 1) {\n      return false\n    }\n\n    return true\n  } else {\n    return false\n  }\n}\n\nexport const StereoValidator = {\n  isCorrectStereoCenter\n}\n","/****************************************************************************\n * Copyright 2021 EPAM Systems\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *    http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n ***************************************************************************/\nimport { Struct } from '../entities'\n\nexport class FunctionalGroupsProvider {\n  private static instance: FunctionalGroupsProvider\n  functionalGroupsList: Struct[]\n  constructor() {\n    this.functionalGroupsList = []\n  }\n\n  public static getInstance(): FunctionalGroupsProvider {\n    if (!FunctionalGroupsProvider.instance) {\n      FunctionalGroupsProvider.instance = new FunctionalGroupsProvider()\n    }\n    return FunctionalGroupsProvider.instance\n  }\n\n  public getFunctionalGroupsList() {\n    return this.functionalGroupsList\n  }\n\n  public setFunctionalGroupsList(list: Struct[]): void {\n    this.functionalGroupsList = list\n  }\n}\n","/****************************************************************************\n * Copyright 2021 EPAM Systems\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *    http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n ***************************************************************************/\n\nimport { Vec2 } from './vec2'\nimport assert from 'assert'\n\nexport class Box2Abs {\n  readonly p0: Vec2\n  readonly p1: Vec2\n\n  constructor()\n  constructor(p: Vec2)\n  constructor(p0: Vec2, p1: Vec2)\n  constructor(x0: number, y0: number, x1: number, y1: number)\n  constructor(...args: Array<any>) {\n    if (args.length === 1 && 'min' in args[0] && 'max' in args[0]) {\n      this.p0 = args[0].min\n      this.p1 = args[0].max\n    }\n\n    if (args.length === 2) {\n      this.p0 = args[0]\n      this.p1 = args[1]\n    } else if (args.length === 4) {\n      this.p0 = new Vec2(args[0], args[1])\n      this.p1 = new Vec2(args[2], args[3])\n    } else if (args.length === 0) {\n      this.p0 = new Vec2()\n      this.p1 = new Vec2()\n    } else {\n      throw new Error(\n        'Box2Abs constructor only accepts 4 numbers or 2 vectors or no args!'\n      )\n    }\n  }\n\n  toString(): string {\n    return this.p0.toString() + ' ' + this.p1.toString()\n  }\n\n  clone(): Box2Abs {\n    return new Box2Abs(this.p0, this.p1)\n  }\n\n  extend(lp: Vec2, rb: Vec2): Box2Abs {\n    rb = rb || lp\n    return new Box2Abs(this.p0.sub(lp), this.p1.add(rb))\n  }\n\n  include(p: Vec2): Box2Abs {\n    assert(p != null)\n\n    return new Box2Abs(this.p0.min(p), this.p1.max(p))\n  }\n\n  contains(p: Vec2, ext: number = 0.0): boolean {\n    assert(p != null)\n\n    return (\n      p.x >= this.p0.x - ext &&\n      p.x <= this.p1.x + ext &&\n      p.y >= this.p0.y - ext &&\n      p.y <= this.p1.y + ext\n    )\n  }\n\n  translate(d: Vec2): Box2Abs {\n    return new Box2Abs(this.p0.add(d), this.p1.add(d))\n  }\n\n  transform(f: (p: Vec2, options: any) => Vec2, options: any): Box2Abs {\n    assert(typeof f === 'function')\n\n    return new Box2Abs(f(this.p0, options), f(this.p1, options))\n  }\n\n  sz(): Vec2 {\n    return this.p1.sub(this.p0)\n  }\n\n  centre(): Vec2 {\n    return Vec2.centre(this.p0, this.p1)\n  }\n\n  pos() {\n    return this.p0\n  }\n\n  static fromRelBox(relBox: any): Box2Abs {\n    return new Box2Abs(\n      relBox.x,\n      relBox.y,\n      relBox.x + relBox.width,\n      relBox.y + relBox.height\n    )\n  }\n\n  static union(b1: Box2Abs, b2: Box2Abs): Box2Abs {\n    return new Box2Abs(Vec2.min(b1.p0, b2.p0), Vec2.max(b1.p1, b2.p1))\n  }\n\n  static segmentIntersection(a: Vec2, b: Vec2, c: Vec2, d: Vec2): boolean {\n    const dc = (a.x - c.x) * (b.y - c.y) - (a.y - c.y) * (b.x - c.x)\n    const dd = (a.x - d.x) * (b.y - d.y) - (a.y - d.y) * (b.x - d.x)\n    const da = (c.x - a.x) * (d.y - a.y) - (c.y - a.y) * (d.x - a.x)\n    const db = (c.x - b.x) * (d.y - b.y) - (c.y - b.y) * (d.x - b.x)\n\n    return dc * dd <= 0 && da * db <= 0\n  }\n}\n","/****************************************************************************\n * Copyright 2021 EPAM Systems\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *    http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n ***************************************************************************/\n\nimport { Atom } from './atom'\nimport { Bond } from './bond'\nimport { Box2Abs } from './box2Abs'\nimport { Pile } from './pile'\nimport { Struct } from './struct'\nimport { Vec2 } from './vec2'\n\nexport class SGroupBracketParams {\n  readonly c: Vec2\n  readonly d: Vec2\n  readonly n: Vec2\n  readonly w: number\n  readonly h: number\n\n  constructor(c: Vec2, d: Vec2, w: number, h: number) {\n    this.c = c\n    this.d = d\n    this.n = d.rotateSC(1, 0)\n    this.w = w\n    this.h = h\n  }\n}\n\nexport class SGroup {\n  static TYPES = {\n    SUP: 'SUP',\n    MUL: 'MUL',\n    SRU: 'SRU',\n    MON: 'MON',\n    MER: 'MER',\n    COP: 'COP',\n    CRO: 'CRO',\n    MOD: 'MOD',\n    GRA: 'GRA',\n    COM: 'COM',\n    MIX: 'MIX',\n    FOR: 'FOR',\n    DAT: 'DAT',\n    ANY: 'ANY',\n    GEN: 'GEN'\n  }\n\n  type: string\n  id: number\n  label: number\n  bracketBox: any\n  bracketDir: Vec2\n  areas: any\n  hover: boolean\n  hovering: any\n  selected: boolean\n  selectionPlate: any\n  atoms: any\n  atomSet: any\n  parentAtomSet: any\n  patoms?: any\n  allAtoms: any\n  bonds: any\n  xBonds: any\n  neiAtoms: any\n  pp: Vec2 | null\n  data: any\n\n  constructor(type: string) {\n    this.type = type\n    this.id = -1\n    this.label = -1\n    this.bracketBox = null\n    this.bracketDir = new Vec2(1, 0)\n    this.areas = []\n\n    this.hover = false\n    this.hovering = null\n    this.selected = false\n    this.selectionPlate = null\n\n    this.atoms = []\n    this.patoms = []\n    this.bonds = []\n    this.xBonds = []\n    this.neiAtoms = []\n    this.pp = null\n    this.data = {\n      mul: 1, // multiplication count for MUL group\n      connectivity: 'ht', // head-to-head, head-to-tail or either-unknown\n      name: '',\n      subscript: 'n',\n      expanded: undefined,\n      // data s-group fields\n      attached: false,\n      absolute: true,\n      showUnits: false,\n      nCharsToDisplay: -1,\n      tagChar: '',\n      daspPos: 1,\n      fieldType: 'F',\n      fieldName: '',\n      fieldValue: '',\n      units: '',\n      query: '',\n      queryOp: ''\n    }\n  }\n\n  // TODO: these methods should be overridden\n  //      and should only accept valid attributes for each S-group type.\n  //      The attributes should be accessed via these methods only and not directly through this.data.\n  // stub\n  getAttr(attr: string): any {\n    return this.data[attr]\n  }\n\n  // TODO: should be group-specific\n  getAttrs(): any {\n    var attrs = {}\n    Object.keys(this.data).forEach(attr => {\n      attrs[attr] = this.data[attr]\n    })\n    return attrs\n  }\n\n  // stub\n  setAttr(attr: string, value: any): any {\n    var oldValue = this.data[attr]\n    this.data[attr] = value\n    return oldValue\n  }\n\n  // stub\n  checkAttr(attr: string, value: any): boolean {\n    return this.data[attr] === value\n  }\n\n  updateOffset(offset: Vec2): void {\n    this.pp = Vec2.sum(this.bracketBox.p1, offset)\n  }\n\n  calculatePP(struct: Struct): void {\n    let topLeftPoint\n\n    if (this.data.context === 'Atom' || this.data.context === 'Bond') {\n      const contentBoxes: Array<any> = []\n      let contentBB: Box2Abs | null = null\n      const direction = new Vec2(1, 0)\n\n      this.atoms.forEach(aid => {\n        const atom = struct.atoms.get(aid)\n        const pos = new Vec2(atom!.pp)\n        const ext = new Vec2(0.05 * 3, 0.05 * 3)\n        const bba = new Box2Abs(pos, pos).extend(ext, ext)\n        contentBoxes.push(bba)\n      })\n      contentBoxes.forEach(bba => {\n        var bbb: Box2Abs | null = null\n        ;[bba.p0.x, bba.p1.x].forEach(x => {\n          ;[bba.p0.y, bba.p1.y].forEach(y => {\n            var v = new Vec2(x, y)\n            var p = new Vec2(\n              Vec2.dot(v, direction),\n              Vec2.dot(v, direction.rotateSC(1, 0))\n            )\n            bbb = !bbb ? new Box2Abs(p, p) : bbb!.include(p)\n          })\n        })\n        contentBB = !contentBB ? bbb : Box2Abs.union(contentBB, bbb!)\n      })\n\n      topLeftPoint = contentBB!.p0\n    } else {\n      topLeftPoint = this.bracketBox.p1.add(new Vec2(0.5, 0.5))\n    }\n\n    const sgroups = Array.from(struct.sgroups.values())\n    for (let i = 0; i < struct.sgroups.size; ++i) {\n      if (!descriptorIntersects(sgroups as [], topLeftPoint)) break\n\n      topLeftPoint = topLeftPoint.add(new Vec2(0, 0.5))\n    }\n\n    // TODO: the code below is a temporary solution that will be removed after the implementation of the internal format\n    // TODO: in schema.json required fields [\"context\", \"FieldValue\"] in sgroups type DAT must be returned\n    if (this.data.fieldName === 'INDIGO_CIP_DESC') {\n      if (this.atoms.length === 1) {\n        const sAtom = this.atoms[0]\n        const sAtomPP = struct.atoms.get(sAtom)?.pp\n\n        if (sAtomPP) {\n          topLeftPoint = sAtomPP\n        }\n      } else {\n        topLeftPoint = SGroup.getMassCentre(struct, this.atoms)\n      }\n    }\n\n    this.pp = topLeftPoint\n  }\n\n  static getOffset(sgroup: SGroup): null | Vec2 {\n    if (!sgroup?.pp) return null\n    return Vec2.diff(sgroup.pp, sgroup.bracketBox.p1)\n  }\n\n  static filterAtoms(atoms: any, map: any) {\n    var newAtoms: Array<any> = []\n    for (var i = 0; i < atoms.length; ++i) {\n      var aid = atoms[i]\n      if (typeof map[aid] !== 'number') newAtoms.push(aid)\n      else if (map[aid] >= 0) newAtoms.push(map[aid])\n      else newAtoms.push(-1)\n    }\n    return newAtoms\n  }\n\n  static removeNegative(atoms: any) {\n    var newAtoms: Array<any> = []\n    for (var j = 0; j < atoms.length; ++j) {\n      if (atoms[j] >= 0) newAtoms.push(atoms[j])\n    }\n    return newAtoms\n  }\n\n  static filter(_mol, sg, atomMap) {\n    sg.atoms = SGroup.removeNegative(SGroup.filterAtoms(sg.atoms, atomMap))\n  }\n\n  static clone(sgroup: SGroup, aidMap: Map<number, number>): SGroup {\n    const cp = new SGroup(sgroup.type)\n\n    Object.keys(sgroup.data).forEach(field => {\n      cp.data[field] = sgroup.data[field]\n    })\n\n    cp.atoms = sgroup.atoms.map(elem => aidMap.get(elem))\n    cp.pp = sgroup.pp\n    cp.bracketBox = sgroup.bracketBox\n    cp.patoms = null\n    cp.bonds = null\n    cp.allAtoms = sgroup.allAtoms\n    cp.data.expanded = sgroup.data.expanded\n    return cp\n  }\n\n  static addAtom(sgroup: SGroup, aid: number): void {\n    sgroup.atoms.push(aid)\n  }\n\n  static removeAtom(sgroup: SGroup, aid: number): void {\n    for (var i = 0; i < sgroup.atoms.length; ++i) {\n      if (sgroup.atoms[i] === aid) {\n        sgroup.atoms.splice(i, 1)\n        return\n      }\n    }\n  }\n\n  static getCrossBonds(\n    mol: any,\n    parentAtomSet: Pile<number>\n  ): { [key: number]: Array<Bond> } {\n    const crossBonds: { [key: number]: Array<Bond> } = {}\n    mol.bonds.forEach((bond, bid) => {\n      if (parentAtomSet.has(bond.begin) && !parentAtomSet.has(bond.end)) {\n        if (!crossBonds[bond.begin]) {\n          crossBonds[bond.begin] = []\n        }\n        crossBonds[bond.begin].push(bid)\n      } else if (\n        parentAtomSet.has(bond.end) &&\n        !parentAtomSet.has(bond.begin)\n      ) {\n        if (!crossBonds[bond.end]) {\n          crossBonds[bond.end] = []\n        }\n        crossBonds[bond.end].push(bid)\n      }\n    })\n    return crossBonds\n  }\n\n  static bracketPos(\n    sGroup,\n    mol,\n    crossBondsPerAtom: { [key: number]: Array<Bond> }\n  ): void {\n    var atoms = sGroup.atoms\n    const crossBonds = Object.values(crossBondsPerAtom).flat()\n    if (!crossBonds || crossBonds.length !== 2) {\n      sGroup.bracketDir = new Vec2(1, 0)\n    } else {\n      var p1 = mol.bonds.get(crossBonds[0]).getCenter(mol)\n      var p2 = mol.bonds.get(crossBonds[1]).getCenter(mol)\n      sGroup.bracketDir = Vec2.diff(p2, p1).normalized()\n    }\n    var d = sGroup.bracketDir\n\n    var braketBox: Box2Abs | null = null\n    var contentBoxes: Array<any> = []\n    atoms.forEach(aid => {\n      var atom = mol.atoms.get(aid)\n      var pos = new Vec2(atom.pp)\n      var ext = new Vec2(0.05 * 3, 0.05 * 3)\n      var bba = new Box2Abs(pos, pos).extend(ext, ext)\n      contentBoxes.push(bba)\n    })\n    contentBoxes.forEach(bba => {\n      var bbb: Box2Abs | null = null\n      ;[bba.p0.x, bba.p1.x].forEach(x => {\n        ;[bba.p0.y, bba.p1.y].forEach(y => {\n          var v = new Vec2(x, y)\n          var p = new Vec2(Vec2.dot(v, d), Vec2.dot(v, d.rotateSC(1, 0)))\n          bbb = !bbb ? new Box2Abs(p, p) : bbb!.include(p)\n        })\n      })\n      braketBox = !braketBox ? bbb : Box2Abs.union(braketBox, bbb!)\n    })\n    var vext = new Vec2(0.2, 0.4)\n    if (braketBox) braketBox = (braketBox as Box2Abs).extend(vext, vext)\n    sGroup.bracketBox = braketBox\n  }\n\n  static getBracketParameters(\n    mol,\n    crossBondsPerAtom: { [key: number]: Array<Bond> },\n    atomSet: Pile<number>,\n    bb,\n    d,\n    n\n  ): Array<any> {\n    var brackets: Array<any> = []\n    const crossBondsPerAtomValues = Object.values(crossBondsPerAtom)\n    const crossBonds = crossBondsPerAtomValues.flat()\n    if (crossBonds.length < 2) {\n      ;(function () {\n        d = d || new Vec2(1, 0)\n        n = n || d.rotateSC(1, 0)\n        var bracketWidth = Math.min(0.25, bb.sz().x * 0.3)\n        var cl = Vec2.lc2(d, bb.p0.x, n, 0.5 * (bb.p0.y + bb.p1.y))\n        var cr = Vec2.lc2(d, bb.p1.x, n, 0.5 * (bb.p0.y + bb.p1.y))\n        var bracketHeight = bb.sz().y\n\n        brackets.push(\n          new SGroupBracketParams(cl, d.negated(), bracketWidth, bracketHeight),\n          new SGroupBracketParams(cr, d, bracketWidth, bracketHeight)\n        )\n      })()\n    } else if (\n      crossBonds.length === 2 &&\n      crossBondsPerAtomValues.length === 2\n    ) {\n      ;(function () {\n        var b1 = mol.bonds.get(crossBonds[0])\n        var b2 = mol.bonds.get(crossBonds[1])\n        var cl0 = b1.getCenter(mol)\n        var cr0 = b2.getCenter(mol)\n        var dr = Vec2.diff(cr0, cl0).normalized()\n        var dl = dr.negated()\n\n        var bracketWidth = 0.25\n        var bracketHeight = 1.5\n        brackets.push(\n          new SGroupBracketParams(\n            cl0.addScaled(dl, 0),\n            dl,\n            bracketWidth,\n            bracketHeight\n          ),\n          new SGroupBracketParams(\n            cr0.addScaled(dr, 0),\n            dr,\n            bracketWidth,\n            bracketHeight\n          )\n        )\n      })()\n    } else {\n      ;(function () {\n        for (var i = 0; i < crossBonds.length; ++i) {\n          var b = mol.bonds.get(crossBonds[i])\n          var c = b.getCenter(mol)\n          var d = atomSet.has(b.begin) ? b.getDir(mol) : b.getDir(mol).negated()\n          brackets.push(new SGroupBracketParams(c, d, 0.2, 1.0))\n        }\n      })()\n    }\n    return brackets\n  }\n\n  static getObjBBox(atoms, mol): Box2Abs {\n    var a0 = mol.atoms.get(atoms[0]).pp\n    var bb = new Box2Abs(a0, a0)\n    for (var i = 1; i < atoms.length; ++i) {\n      var aid = atoms[i]\n      var atom = mol.atoms.get(aid)\n      var p = atom.pp\n      bb = bb.include(p)\n    }\n    return bb\n  }\n\n  static getAtoms(mol, sg): Array<any> {\n    if (!sg.allAtoms) return sg.atoms\n    var atoms: Array<any> = []\n    mol.atoms.forEach((_atom, aid) => {\n      atoms.push(aid)\n    })\n    return atoms\n  }\n\n  static getBonds(mol, sg): Array<any> {\n    var atoms = SGroup.getAtoms(mol, sg)\n    var bonds: Array<any> = []\n    mol.bonds.forEach((bond, bid) => {\n      if (atoms.indexOf(bond.begin) >= 0 && atoms.indexOf(bond.end) >= 0)\n        bonds.push(bid)\n    })\n    return bonds\n  }\n\n  static prepareMulForSaving(sgroup, mol): void {\n    sgroup.atoms.sort((a, b) => a - b)\n    sgroup.atomSet = new Pile(sgroup.atoms)\n    sgroup.parentAtomSet = new Pile(sgroup.atomSet)\n    var inBonds: Array<any> = []\n    var xBonds: Array<any> = []\n\n    mol.bonds.forEach((bond, bid) => {\n      if (\n        sgroup.parentAtomSet.has(bond.begin) &&\n        sgroup.parentAtomSet.has(bond.end)\n      )\n        inBonds.push(bid)\n      else if (\n        sgroup.parentAtomSet.has(bond.begin) ||\n        sgroup.parentAtomSet.has(bond.end)\n      )\n        xBonds.push(bid)\n    })\n\n    if (xBonds.length !== 0 && xBonds.length !== 2)\n      throw Error('Unsupported cross-bonds number')\n\n    var xAtom1 = -1\n    var xAtom2 = -1\n    var crossBond = null\n    if (xBonds.length === 2) {\n      var bond1 = mol.bonds.get(xBonds[0])\n      xAtom1 = sgroup.parentAtomSet.has(bond1.begin) ? bond1.begin : bond1.end\n\n      var bond2 = mol.bonds.get(xBonds[1])\n      xAtom2 = sgroup.parentAtomSet.has(bond2.begin) ? bond2.begin : bond2.end\n      crossBond = bond2\n    }\n\n    var tailAtom = xAtom2\n\n    var newAtoms: Array<any> = []\n    for (var j = 0; j < sgroup.data.mul - 1; j++) {\n      let amap = {}\n      sgroup.atoms.forEach(aid => {\n        var atom = mol.atoms.get(aid)\n        var aid2 = mol.atoms.add(new Atom(atom))\n        newAtoms.push(aid2)\n        sgroup.atomSet.add(aid2)\n        amap[aid] = aid2\n      })\n      inBonds.forEach(bid => {\n        var bond = mol.bonds.get(bid)\n        var newBond = new Bond(bond)\n        newBond.begin = amap[newBond.begin]\n        newBond.end = amap[newBond.end]\n        mol.bonds.add(newBond)\n      })\n      if (crossBond !== null) {\n        var newCrossBond = new Bond(crossBond)\n        newCrossBond.begin = tailAtom\n        newCrossBond.end = amap[xAtom1]\n        mol.bonds.add(newCrossBond)\n        tailAtom = amap[xAtom2]\n      }\n    }\n    if (tailAtom >= 0) {\n      var xBond2 = mol.bonds.get(xBonds[1])\n      if (xBond2.begin === xAtom2) xBond2.begin = tailAtom\n      else xBond2.end = tailAtom\n    }\n    sgroup.bonds = xBonds\n\n    newAtoms.forEach(aid => {\n      mol.sGroupForest\n        .getPathToRoot(sgroup.id)\n        .reverse()\n        .forEach(sgid => {\n          mol.atomAddToSGroup(sgid, aid)\n        })\n    })\n  }\n\n  static getMassCentre(mol, atoms): Vec2 {\n    var c = new Vec2() // mass centre\n    for (var i = 0; i < atoms.length; ++i)\n      c = c.addScaled(mol.atoms.get(atoms[i]).pp, 1.0 / atoms.length)\n    return c\n  }\n}\n\nfunction descriptorIntersects(sgroups: [], topLeftPoint: Vec2): boolean {\n  return sgroups.some((sg: SGroup) => {\n    if (!sg.pp) return false\n\n    const sgBottomRightPoint = sg.pp.add(new Vec2(0.5, 0.5))\n    const bottomRightPoint = topLeftPoint.add(new Vec2(0.5, 0.5))\n\n    return Box2Abs.segmentIntersection(\n      sg.pp,\n      sgBottomRightPoint,\n      topLeftPoint,\n      bottomRightPoint\n    )\n  })\n}\n","/****************************************************************************\n * Copyright 2021 EPAM Systems\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *    http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n ***************************************************************************/\n\nimport { Point, Vec2 } from './vec2'\n\nexport enum RxnArrowMode {\n  OpenAngle = 'open-angle',\n  FilledTriangle = 'filled-triangle',\n  FilledBow = 'filled-bow',\n  DashedOpenAngle = 'dashed-open-angle',\n  Failed = 'failed',\n  BothEndsFilledTriangle = 'both-ends-filled-triangle',\n  EquilibriumFilledTriangle = 'equilibrium-filled-triangle',\n  EquilibriumFilledHalfBow = 'equilibrium-filled-half-bow',\n  EquilibriumOpenAngle = 'equilibrium-open-angle',\n  UnbalancedEquilibriumFilledHalfBow = 'unbalanced-equilibrium-filled-half-bow',\n  UnbalancedEquilibriumOpenHalfAngle = 'unbalanced-equilibrium-open-half-angle',\n  UnbalancedEquilibriumLargeFilledHalfBow = 'unbalanced-equilibrium-large-filled-half-bow',\n  UnbalancedEquilibriumFilleHalfTriangle = 'unbalanced-equilibrium-fille-half-triangle'\n}\n\nexport interface RxnArrowAttributes {\n  mode: RxnArrowMode\n  pos?: Array<Point>\n}\n\nexport class RxnArrow {\n  mode: RxnArrowMode\n  pos: Array<Vec2>\n\n  constructor(atrributes: RxnArrowAttributes) {\n    this.pos = []\n\n    if (atrributes.pos) {\n      for (let i = 0; i < atrributes.pos.length; i++) {\n        const currentP = atrributes.pos[i]\n        this.pos[i] = currentP ? new Vec2(atrributes.pos[i]) : new Vec2()\n      }\n    }\n\n    this.mode = atrributes.mode\n  }\n\n  clone() {\n    return new RxnArrow(this)\n  }\n\n  center(): Vec2 {\n    return Vec2.centre(this.pos[0], this.pos[1])\n  }\n}\n","/****************************************************************************\n * Copyright 2021 EPAM Systems\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *    http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n ***************************************************************************/\nimport { FunctionalGroupsProvider } from '../helpers'\nimport { SGroup } from './sgroup'\nimport assert from 'assert'\n\nexport class FunctionalGroup {\n  #sgroup: SGroup\n\n  constructor(sgroup: SGroup) {\n    assert(sgroup != null)\n\n    this.#sgroup = sgroup\n  }\n\n  get name(): string {\n    return this.#sgroup.data.name\n  }\n\n  get relatedSGroupId(): number {\n    return this.#sgroup.id\n  }\n\n  get isExpanded(): boolean {\n    return this.#sgroup.data.expanded\n  }\n\n  get relatedSGroup(): SGroup {\n    return this.#sgroup\n  }\n\n  static isFunctionalGroup(sgroup): boolean {\n    const provider = FunctionalGroupsProvider.getInstance()\n    const types = provider.getFunctionalGroupsList()\n    return (\n      types.some(type => type.name === sgroup.data.name) &&\n      sgroup.type === 'SUP'\n    )\n  }\n\n  static atomsInFunctionalGroup(functionalGroups, atom): number | null {\n    if (functionalGroups.size === 0) {\n      return null\n    }\n    for (let fg of functionalGroups.values()) {\n      if (fg.relatedSGroup.atoms.includes(atom)) return atom\n    }\n    return null\n  }\n\n  static bondsInFunctionalGroup(\n    molecule,\n    functionalGroups,\n    bond\n  ): number | null {\n    if (functionalGroups.size === 0) {\n      return null\n    }\n    for (let fg of functionalGroups.values()) {\n      const bonds = SGroup.getBonds(molecule, fg.relatedSGroup)\n      if (bonds.includes(bond)) return bond\n    }\n    return null\n  }\n\n  static findFunctionalGroupByAtom(functionalGroups, atom): number | null {\n    for (let fg of functionalGroups.values()) {\n      if (fg.relatedSGroup.atoms.includes(atom)) return fg.relatedSGroupId\n    }\n    return null\n  }\n\n  static findFunctionalGroupByBond(\n    molecule,\n    functionalGroups,\n    bond\n  ): number | null {\n    for (let fg of functionalGroups.values()) {\n      const bonds = SGroup.getBonds(molecule, fg.relatedSGroup)\n      if (bonds.includes(bond)) return fg.relatedSGroupId\n    }\n    return null\n  }\n\n  static clone(functionalGroup: FunctionalGroup): FunctionalGroup {\n    return new FunctionalGroup(functionalGroup.#sgroup)\n  }\n\n  static isFirstAtomInFunctionalGroup(sgroups, aid): boolean {\n    for (let sg of sgroups.values()) {\n      if (FunctionalGroup.isFunctionalGroup(sg) && aid === sg.atoms[0]) {\n        return true\n      }\n    }\n    return false\n  }\n\n  static isAtomInContractedFunctionalGroup(\n    atom,\n    sgroups,\n    functionalGroups,\n    sgroupsFromReStruct: boolean\n  ): boolean {\n    const contractedFunctionalGroups: number[] = []\n    if (sgroupsFromReStruct) {\n      sgroups.forEach(sg => {\n        if (\n          FunctionalGroup.isContractedFunctionalGroup(\n            sg.item.id,\n            functionalGroups\n          )\n        ) {\n          contractedFunctionalGroups.push(sg.item.id)\n        }\n      })\n    } else {\n      sgroups.forEach(sg => {\n        if (\n          FunctionalGroup.isContractedFunctionalGroup(sg.id, functionalGroups)\n        ) {\n          contractedFunctionalGroups.push(sg.id)\n        }\n      })\n    }\n    return contractedFunctionalGroups.some(sg => atom.sgs.has(sg))\n  }\n\n  static isBondInContractedFunctionalGroup(\n    bond,\n    sgroups,\n    functionalGroups,\n    sgroupsFromReStruct: boolean\n  ): boolean {\n    const contractedFunctionalGroupsAtoms: number[] = []\n    if (sgroupsFromReStruct) {\n      sgroups.forEach(sg => {\n        if (\n          FunctionalGroup.isContractedFunctionalGroup(\n            sg.item.id,\n            functionalGroups\n          )\n        ) {\n          contractedFunctionalGroupsAtoms.push(...sg.item.atoms)\n        }\n      })\n    } else {\n      sgroups.forEach(sg => {\n        if (\n          FunctionalGroup.isContractedFunctionalGroup(sg.id, functionalGroups)\n        ) {\n          contractedFunctionalGroupsAtoms.push(...sg.atoms)\n        }\n      })\n    }\n    return (\n      contractedFunctionalGroupsAtoms.includes(bond.begin) &&\n      contractedFunctionalGroupsAtoms.includes(bond.end)\n    )\n  }\n\n  static isContractedFunctionalGroup(sgroupId, functionalGroups): boolean {\n    let isFunctionalGroup = false\n    let expanded = false\n    functionalGroups.forEach(fg => {\n      if (fg.relatedSGroupId === sgroupId) {\n        isFunctionalGroup = true\n        expanded = fg.isExpanded\n      }\n    })\n    return !expanded && isFunctionalGroup\n  }\n}\n","/****************************************************************************\n * Copyright 2021 EPAM Systems\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *    http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n ***************************************************************************/\n\nimport { Vec2 } from './vec2'\nimport assert from 'assert'\n\nexport class HalfBond {\n  begin: number\n  end: number\n  bid: number\n  dir: Vec2\n  norm: Vec2\n  ang: number\n  p: Vec2\n  loop: number\n  contra: number\n  next: number\n  leftSin: number\n  leftCos: number\n  leftNeighbor: number\n  rightSin: number\n  rightCos: number\n  rightNeighbor: number\n\n  constructor(begin: number, end: number, bid: number) {\n    assert(arguments.length === 3, 'Invalid parameter number.')\n\n    this.begin = begin\n    this.end = end\n    this.bid = bid\n\n    // rendering properties\n    this.dir = new Vec2() // direction\n    this.norm = new Vec2() // left normal\n    this.ang = 0 // angle to (1,0), used for sorting the bonds\n    this.p = new Vec2() // corrected origin position\n    this.loop = -1 // left loop id if the half-bond is in a loop, otherwise -1\n    this.contra = -1 // the half bond contrary to this one\n    this.next = -1 // the half-bond next ot this one in CCW order\n    this.leftSin = 0\n    this.leftCos = 0\n    this.leftNeighbor = 0\n    this.rightSin = 0\n    this.rightCos = 0\n    this.rightNeighbor = 0\n  }\n}\n","/****************************************************************************\n * Copyright 2021 EPAM Systems\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *    http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n ***************************************************************************/\n\nimport { Bond } from './bond'\nimport { Struct } from './struct'\n\nexport class Loop {\n  hbs: number[]\n  dblBonds: number\n  aromatic: boolean\n  convex: boolean\n\n  constructor(hbs: Array<number>, struct: Struct, isConvex: boolean) {\n    this.hbs = hbs // set of half-bonds involved\n    this.dblBonds = 0 // number of double bonds in the loop\n    this.aromatic = true\n    this.convex = isConvex || false\n\n    hbs.forEach(hb => {\n      const bond: Bond = struct.bonds.get(struct.halfBonds.get(hb)!.bid)!\n      if (bond.type !== Bond.PATTERN.TYPE.AROMATIC) this.aromatic = false\n      if (bond.type === Bond.PATTERN.TYPE.DOUBLE) this.dblBonds++\n    })\n  }\n}\n","/****************************************************************************\n * Copyright 2021 EPAM Systems\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *    http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n ***************************************************************************/\n\nimport { Pile } from './pile'\nimport { Pool } from './pool'\n\nexport interface RGroupAttributes {\n  ifthen?: number\n  resth?: boolean\n  range?: string\n}\nexport class RGroup {\n  frags: Pile<number>\n  resth: boolean\n  range: string\n  ifthen: number\n\n  constructor(atrributes?: RGroupAttributes) {\n    this.frags = new Pile<number>()\n    this.resth = atrributes?.resth || false\n    this.range = atrributes?.range || ''\n    this.ifthen = atrributes?.ifthen || 0\n  }\n\n  static findRGroupByFragment(rgroups: Pool<RGroup>, frid: number) {\n    return rgroups.find((_rgid, rgroup) => rgroup.frags.has(frid))\n  }\n\n  getAttrs(): RGroupAttributes {\n    return {\n      resth: this.resth,\n      range: this.range,\n      ifthen: this.ifthen\n    }\n  }\n\n  clone(fidMap?: Map<number, number> | null): RGroup {\n    const ret = new RGroup(this)\n    this.frags.forEach(fid => {\n      ret.frags.add(fidMap ? fidMap.get(fid)! : fid)\n    })\n    return ret\n  }\n}\n","/****************************************************************************\n * Copyright 2021 EPAM Systems\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *    http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n ***************************************************************************/\n\nimport { Point, Vec2 } from './vec2'\n\nexport enum SimpleObjectMode {\n  ellipse = 'ellipse',\n  rectangle = 'rectangle',\n  line = 'line'\n}\n\nexport interface SimpleObjectAttributes {\n  mode: SimpleObjectMode\n  pos?: Array<Point>\n}\n\nexport class SimpleObject {\n  pos: Array<Vec2>\n  mode: SimpleObjectMode\n\n  constructor(attributes?: SimpleObjectAttributes) {\n    this.pos = []\n\n    if (attributes?.pos) {\n      for (let i = 0; i < attributes.pos.length; i++) {\n        const currentP = attributes.pos[i]\n        this.pos[i] = currentP ? new Vec2(attributes.pos[i]) : new Vec2()\n      }\n    }\n\n    this.mode = attributes?.mode || SimpleObjectMode.line\n  }\n\n  clone(): SimpleObject {\n    return new SimpleObject(this)\n  }\n\n  center(): Vec2 {\n    switch (this.mode) {\n      case SimpleObjectMode.rectangle: {\n        return Vec2.centre(this.pos[0], this.pos[1])\n      }\n      default:\n        return this.pos[0]\n    }\n  }\n}\n","/****************************************************************************\n * Copyright 2021 EPAM Systems\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *    http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n ***************************************************************************/\n\nimport { Point, Vec2 } from './vec2'\n\nexport interface RxnPlusAttributes {\n  pp?: Point\n}\n\nexport class RxnPlus {\n  pp: Vec2\n\n  constructor(attributes?: RxnPlusAttributes) {\n    this.pp = attributes?.pp ? new Vec2(attributes.pp) : new Vec2()\n  }\n\n  clone() {\n    return new RxnPlus(this)\n  }\n}\n","/****************************************************************************\n * Copyright 2021 EPAM Systems\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *    http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n ***************************************************************************/\n\nimport { Pile } from './pile'\nimport { SGroup } from './sgroup'\nimport assert from 'assert'\n\nexport class SGroupForest {\n  /** node id -> parent id */\n  parent: Map<number, number>\n  /** node id -> list of child ids */\n  children: Map<number, number[]>\n  atomSets: Map<number, any>\n\n  constructor() {\n    this.parent = new Map()\n    this.children = new Map()\n\n    this.children.set(-1, []) // extra root node\n    this.atomSets = new Map()\n  }\n\n  /** returns an array or s-group ids in the order of breadth-first search */\n  getSGroupsBFS(): number[] {\n    const order: number[] = []\n    const queue = Array.from(this.children.get(-1) as Array<number>)\n    while (queue.length > 0) {\n      const id = queue.shift()\n      if (typeof id !== 'number') {\n        break\n      }\n      const children = this.children.get(id)\n      if (typeof children === 'undefined') {\n        break\n      }\n\n      children.forEach(id => {\n        queue.push(id)\n      })\n\n      order.push(id)\n    }\n\n    return order\n  }\n\n  getAtomSetRelations(newId: any, atoms: any) {\n    // find the lowest superset in the hierarchy\n    const isStrictSuperset = new Map()\n    const isSubset = new Map()\n\n    this.atomSets.delete(newId)\n\n    this.atomSets.forEach((atomSet, id) => {\n      isSubset.set(id, atomSet.isSuperset(atoms))\n      isStrictSuperset.set(\n        id,\n        atoms.isSuperset(atomSet) && !atomSet.equals(atoms)\n      )\n    })\n\n    const parents = Array.from(this.atomSets.keys()).filter(sgid => {\n      if (!isSubset.get(sgid)) {\n        return false\n      }\n      const childs = this.children.get(sgid)\n      return childs && childs.findIndex(childId => isSubset.get(childId)) < 0\n    })\n\n    const children = Array.from(this.atomSets.keys()).filter(\n      id =>\n        isStrictSuperset.get(id) && !isStrictSuperset.get(this.parent.get(id))\n    )\n\n    return {\n      children,\n      parent: parents.length === 0 ? -1 : parents[0]\n    }\n  }\n\n  getPathToRoot(sgid): number[] {\n    const path: number[] = []\n    for (let id = sgid; id >= 0; id = this.parent.get(id)) {\n      path.push(id)\n    }\n    return path\n  }\n\n  insert({ id, atoms }, parent?: number, children?: number[]) {\n    assert(!this.parent.has(id), 'sgid already present in the forest')\n    assert(!this.children.has(id), 'sgid already present in the forest')\n\n    if (!parent || !children) {\n      // if these are not provided, deduce automatically\n      const guess = this.getAtomSetRelations(id, new Pile(atoms))\n      parent = guess.parent\n      children = guess.children\n    }\n\n    // TODO: make children Map<int, Pile> instead of Map<int, []>?\n    children.forEach(childId => {\n      this.resetParentLink(childId, id)\n    })\n    this.children.set(\n      id,\n      children.filter(id => this.parent.get(id))\n    )\n    this.parent.set(id, parent)\n    this.children.get(parent)?.push(id)\n    this.atomSets.set(id, new Pile(atoms))\n\n    return { parent, children }\n  }\n\n  private resetParentLink(childId, id) {\n    const parentId = this.parent.get(childId)\n    if (typeof parentId === 'undefined') {\n      return\n    }\n\n    const childs = this.children.get(parentId)\n    if (!childs) {\n      return\n    }\n\n    const childIndex = childs.indexOf(childId)\n    childs.splice(childIndex, 1)\n    this.parent.set(childId, id)\n  }\n\n  remove(id) {\n    assert(this.parent.has(id), 'sgid is not in the forest')\n    assert(this.children.has(id), 'sgid is not in the forest')\n\n    const parentId = this.parent.get(id) as any\n    const childs = this.children.get(parentId) as any\n    this.children.get(id)?.forEach(childId => {\n      this.parent.set(childId, parentId)\n      this.children.get(parentId)?.push(childId)\n    })\n\n    const i = childs.indexOf(id)\n    childs.splice(i, 1)\n\n    this.children.delete(id)\n    this.parent.delete(id)\n    this.atomSets.delete(id)\n  }\n}\n\nexport function checkOverlapping(struct, atoms) {\n  const sgroups = atoms.reduce((res, aid) => {\n    const atom = struct.atoms.get(aid)\n    return res.union(atom.sgs)\n  }, new Pile())\n\n  return Array.from(sgroups).some(sid => {\n    const sg = struct.sgroups.get(sid)\n    if (sg.type === 'DAT') return false\n    const sgAtoms = SGroup.getAtoms(struct, sg)\n\n    return sgAtoms.length < atoms.length\n      ? sgAtoms.findIndex(aid => atoms.indexOf(aid) === -1) >= 0\n      : atoms.findIndex(aid => sgAtoms.indexOf(aid) === -1) >= 0\n  })\n}\n","/****************************************************************************\n * Copyright 2021 EPAM Systems\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *    http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n ***************************************************************************/\n\nexport class Pool<TValue = any> extends Map<number, TValue> {\n  private nextId: number = 0\n\n  add(item: TValue): number {\n    const id = this.nextId++\n    super.set(id, item)\n    return id\n  }\n\n  newId(): number {\n    return this.nextId++\n  }\n\n  keyOf(item: TValue): number | null {\n    for (const [key, value] of this.entries()) {\n      if (value === item) return key\n    }\n\n    return null\n  }\n\n  find(predicate: (key: number, value: TValue) => boolean): number | null {\n    for (const [key, value] of this.entries()) {\n      if (predicate(key, value)) return key\n    }\n\n    return null\n  }\n\n  filter(predicate: (key: number, value: TValue) => boolean): Pool<TValue> {\n    return new Pool<TValue>(\n      Array.from(this).filter(([key, value]) => predicate(key, value))\n    )\n  }\n\n  some(predicate: (value: TValue) => boolean): boolean {\n    for (const value of this.values()) {\n      if (predicate(value)) {\n        return true\n      }\n    }\n\n    return false\n  }\n}\n","/****************************************************************************\n * Copyright 2021 EPAM Systems\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *    http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n ***************************************************************************/\n\nimport { Atom, radicalElectrons } from './atom'\n\nimport { Bond } from './bond'\nimport { Box2Abs } from './box2Abs'\nimport { Elements } from 'domain/constants'\nimport { Fragment } from './fragment'\nimport { FunctionalGroup } from './functionalGroup'\nimport { HalfBond } from './halfBond'\nimport { Loop } from './loop'\nimport { Pile } from './pile'\nimport { Pool } from './pool'\nimport { RGroup } from './rgroup'\nimport { RxnArrow } from './rxnArrow'\nimport { RxnPlus } from './rxnPlus'\nimport { SGroup } from './sgroup'\nimport { SGroupForest } from './sgroupForest'\nimport { SimpleObject } from './simpleObject'\nimport { Text } from './text'\nimport { Vec2 } from './vec2'\nimport { Highlight } from './highlight'\n\nexport type Neighbor = {\n  aid: number\n  bid: number\n}\n\nfunction arrayAddIfMissing(array, item) {\n  for (var i = 0; i < array.length; ++i) {\n    if (array[i] === item) return false\n  }\n  array.push(item)\n  return true\n}\n\nexport class Struct {\n  atoms: Pool<Atom>\n  bonds: Pool<Bond>\n  sgroups: Pool<SGroup>\n  halfBonds: Pool<HalfBond>\n  loops: Pool<Loop>\n  isReaction: boolean\n  rxnArrows: Pool<RxnArrow>\n  rxnPluses: Pool<RxnPlus>\n  frags: Pool<Fragment | null>\n  rgroups: Pool<RGroup>\n  name: string\n  sGroupForest: SGroupForest\n  simpleObjects: Pool<SimpleObject>\n  texts: Pool<Text>\n  functionalGroups: Pool<FunctionalGroup>\n  highlights: Pool<Highlight>\n\n  constructor() {\n    this.atoms = new Pool<Atom>()\n    this.bonds = new Pool<Bond>()\n    this.sgroups = new Pool<SGroup>()\n    this.halfBonds = new Pool<HalfBond>()\n    this.loops = new Pool<Loop>()\n    this.isReaction = false\n    this.rxnArrows = new Pool<RxnArrow>()\n    this.rxnPluses = new Pool<RxnPlus>()\n    this.frags = new Pool<Fragment>()\n    this.rgroups = new Pool<RGroup>()\n    this.name = ''\n    this.sGroupForest = new SGroupForest()\n    this.simpleObjects = new Pool<SimpleObject>()\n    this.texts = new Pool<Text>()\n    this.functionalGroups = new Pool<FunctionalGroup>()\n    this.highlights = new Pool<Highlight>()\n  }\n\n  hasRxnProps(): boolean {\n    return !!(\n      this.atoms.find((_aid, atom) => atom.hasRxnProps()) ||\n      this.bonds.find((_bid, bond) => bond.hasRxnProps())\n    )\n  }\n\n  hasRxnArrow(): boolean {\n    return this.rxnArrows.size === 1\n  }\n\n  hasRxnPluses(): boolean {\n    return this.rxnPluses.size > 0\n  }\n\n  isRxn(): boolean {\n    return this.hasRxnArrow() || this.hasRxnPluses()\n  }\n\n  isBlank(): boolean {\n    return (\n      this.atoms.size === 0 &&\n      this.rxnArrows.size === 0 &&\n      this.rxnPluses.size === 0 &&\n      this.simpleObjects.size === 0 &&\n      this.texts.size === 0\n    )\n  }\n\n  clone(\n    atomSet?: Pile<number> | null,\n    bondSet?: Pile<number> | null,\n    dropRxnSymbols?: boolean,\n    aidMap?: Map<number, number> | null,\n    simpleObjectsSet?: Pile<number> | null,\n    textsSet?: Pile<number> | null\n  ): Struct {\n    return this.mergeInto(\n      new Struct(),\n      atomSet,\n      bondSet,\n      dropRxnSymbols,\n      false,\n      aidMap,\n      simpleObjectsSet,\n      textsSet\n    )\n  }\n\n  getScaffold(): Struct {\n    const atomSet = new Pile<number>()\n    this.atoms.forEach((_atom, aid) => {\n      atomSet.add(aid)\n    })\n\n    this.rgroups.forEach(rg => {\n      rg.frags.forEach((_fnum, fid) => {\n        this.atoms.forEach((atom, aid) => {\n          if (atom.fragment === fid) atomSet.delete(aid)\n        })\n      })\n    })\n\n    return this.clone(atomSet)\n  }\n\n  getFragmentIds(fid: number): Pile<number> {\n    const atomSet = new Pile<number>()\n\n    this.atoms.forEach((atom, aid) => {\n      if (atom.fragment === fid) atomSet.add(aid)\n    })\n\n    return atomSet\n  }\n\n  getFragment(fid: number): Struct {\n    return this.clone(this.getFragmentIds(fid), null, true)\n  }\n\n  mergeInto(\n    cp: Struct,\n    atomSet?: Pile<number> | null,\n    bondSet?: Pile<number> | null,\n    dropRxnSymbols?: boolean,\n    keepAllRGroups?: boolean,\n    aidMap?: Map<number, number> | null,\n    simpleObjectsSet?: Pile<number> | null,\n    textsSet?: Pile<number> | null\n  ): Struct {\n    atomSet = atomSet || new Pile<number>(this.atoms.keys())\n    bondSet = bondSet || new Pile<number>(this.bonds.keys())\n    simpleObjectsSet =\n      simpleObjectsSet || new Pile<number>(this.simpleObjects.keys())\n    textsSet = textsSet || new Pile<number>(this.texts.keys())\n    aidMap = aidMap || new Map()\n\n    bondSet = bondSet.filter(bid => {\n      const bond = this.bonds.get(bid)!\n      return atomSet!.has(bond.begin) && atomSet!.has(bond.end)\n    })\n\n    const fidMask = new Pile()\n    this.atoms.forEach((atom, aid) => {\n      if (atomSet!.has(aid)) fidMask.add(atom.fragment)\n    })\n\n    const fidMap = new Map()\n    this.frags.forEach((_frag, fid) => {\n      if (fidMask.has(fid)) fidMap.set(fid, cp.frags.add(null))\n    })\n\n    const rgroupsIds: Array<number> = []\n    this.rgroups.forEach((rgroup, rgid) => {\n      let keepGroup = keepAllRGroups\n      if (!keepGroup) {\n        rgroup.frags.forEach((_fnum, fid) => {\n          rgroupsIds.push(fid)\n          if (fidMask.has(fid)) keepGroup = true\n        })\n\n        if (!keepGroup) return\n      }\n\n      const rg = cp.rgroups.get(rgid)\n      if (rg) {\n        rgroup.frags.forEach((_fnum, fid) => {\n          rgroupsIds.push(fid)\n          if (fidMask.has(fid)) rg.frags.add(fidMap.get(fid))\n        })\n      } else {\n        cp.rgroups.set(rgid, rgroup.clone(fidMap))\n      }\n    })\n\n    // atoms in not RGroup\n    this.atoms.forEach((atom, aid) => {\n      if (atomSet!.has(aid) && rgroupsIds.indexOf(atom.fragment) === -1)\n        aidMap!.set(aid, cp.atoms.add(atom.clone(fidMap)))\n    })\n    // atoms in RGroup\n    this.atoms.forEach((atom, aid) => {\n      if (atomSet!.has(aid) && rgroupsIds.indexOf(atom.fragment) !== -1)\n        aidMap!.set(aid, cp.atoms.add(atom.clone(fidMap)))\n    })\n\n    fidMap.forEach((newfid, oldfid) => {\n      const fragment = this.frags.get(oldfid)\n\n      // TODO: delete type check\n      if (fragment && fragment instanceof Fragment) {\n        cp.frags.set(newfid, this.frags.get(oldfid)!.clone(aidMap!)) // clone Fragments\n      }\n    })\n\n    const bidMap = new Map()\n    this.bonds.forEach((bond, bid) => {\n      if (bondSet!.has(bid)) bidMap.set(bid, cp.bonds.add(bond.clone(aidMap!)))\n    })\n\n    this.sgroups.forEach(sg => {\n      if (sg.atoms.some(aid => !atomSet!.has(aid))) return\n\n      sg = SGroup.clone(sg, aidMap!)\n      const id = cp.sgroups.add(sg)\n      sg.id = id\n\n      sg.atoms.forEach(aid => {\n        const atom = cp.atoms.get(aid)\n        if (atom) {\n          atom.sgs.add(id)\n        }\n      })\n\n      if (sg.type === 'DAT') cp.sGroupForest.insert(sg, -1, [])\n      else cp.sGroupForest.insert(sg)\n    })\n\n    this.functionalGroups.forEach(fg => {\n      fg = FunctionalGroup.clone(fg)\n      cp.functionalGroups.add(fg)\n    })\n\n    simpleObjectsSet.forEach(soid => {\n      cp.simpleObjects.add(this.simpleObjects.get(soid)!.clone())\n    })\n\n    textsSet.forEach(id => {\n      cp.texts.add(this.texts.get(id)!.clone())\n    })\n\n    if (!dropRxnSymbols) {\n      cp.isReaction = this.isReaction\n      this.rxnArrows.forEach(item => {\n        cp.rxnArrows.add(item.clone())\n      })\n      this.rxnPluses.forEach(item => {\n        cp.rxnPluses.add(item.clone())\n      })\n    }\n\n    cp.name = this.name\n\n    return cp\n  }\n\n  // NB: this updates the structure without modifying the corresponding ReStruct.\n  //  To be applied to standalone structures only.\n  prepareLoopStructure() {\n    this.initHalfBonds()\n    this.initNeighbors()\n    this.updateHalfBonds(Array.from(this.atoms.keys()))\n    this.sortNeighbors(Array.from(this.atoms.keys()))\n    this.findLoops()\n  }\n\n  atomAddToSGroup(sgid, aid) {\n    // TODO: [MK] make sure the addition does not break the hierarchy?\n    SGroup.addAtom(this.sgroups.get(sgid)!, aid)\n    this.atoms.get(aid)!.sgs.add(sgid)\n  }\n\n  calcConn(atom) {\n    let conn = 0\n    for (let i = 0; i < atom.neighbors.length; ++i) {\n      const hb = this.halfBonds.get(atom.neighbors[i])!\n      const bond = this.bonds.get(hb.bid)!\n      switch (bond.type) {\n        case Bond.PATTERN.TYPE.SINGLE:\n          conn += 1\n          break\n        case Bond.PATTERN.TYPE.DOUBLE:\n          conn += 2\n          break\n        case Bond.PATTERN.TYPE.TRIPLE:\n          conn += 3\n          break\n        case Bond.PATTERN.TYPE.DATIVE:\n          break\n        case Bond.PATTERN.TYPE.HYDROGEN:\n          break\n        case Bond.PATTERN.TYPE.AROMATIC:\n          if (atom.neighbors.length === 1) return [-1, true]\n          return [atom.neighbors.length, true]\n        default:\n          return [-1, false]\n      }\n    }\n    return [conn, false]\n  }\n\n  findBondId(begin, end) {\n    return this.bonds.find(\n      (_bid, bond) =>\n        (bond.begin === begin && bond.end === end) ||\n        (bond.begin === end && bond.end === begin)\n    )\n  }\n\n  initNeighbors() {\n    this.atoms.forEach(atom => {\n      atom.neighbors = []\n    })\n\n    this.bonds.forEach(bond => {\n      const a1 = this.atoms.get(bond.begin)!\n      const a2 = this.atoms.get(bond.end)!\n      a1.neighbors.push(bond.hb1!)\n      a2.neighbors.push(bond.hb2!)\n    })\n  }\n\n  bondInitHalfBonds(bid, bond?: Bond) {\n    bond = bond || this.bonds.get(bid)!\n    bond.hb1 = 2 * bid\n    bond.hb2 = 2 * bid + 1 // eslint-disable-line no-mixed-operators\n    this.halfBonds.set(bond.hb1, new HalfBond(bond.begin, bond.end, bid))\n    this.halfBonds.set(bond.hb2, new HalfBond(bond.end, bond.begin, bid))\n    const hb1 = this.halfBonds.get(bond.hb1)!\n    const hb2 = this.halfBonds.get(bond.hb2)!\n    hb1.contra = bond.hb2\n    hb2.contra = bond.hb1\n  }\n\n  halfBondUpdate(hbid: number) {\n    const hb = this.halfBonds.get(hbid)!\n    const p1 = this.atoms.get(hb.begin)!.pp\n    const p2 = this.atoms.get(hb.end)!.pp\n    const d = Vec2.diff(p2, p1).normalized()\n    hb.dir = Vec2.dist(p2, p1) > 1e-4 ? d : new Vec2(1, 0)\n    hb.norm = hb.dir.turnLeft()\n    hb.ang = hb.dir.oxAngle()\n    if (hb.loop < 0) hb.loop = -1\n  }\n\n  initHalfBonds() {\n    this.halfBonds.clear()\n    this.bonds.forEach((bond, bid) => {\n      this.bondInitHalfBonds(bid, bond)\n    })\n  }\n\n  setHbNext(hbid, next) {\n    this.halfBonds.get(this.halfBonds.get(hbid)!.contra)!.next = next\n  }\n\n  halfBondSetAngle(hbid, left) {\n    const hb = this.halfBonds.get(hbid)!\n    const hbl = this.halfBonds.get(left)!\n\n    hbl.rightCos = Vec2.dot(hbl.dir, hb.dir)\n    hb.leftCos = Vec2.dot(hbl.dir, hb.dir)\n\n    hbl.rightSin = Vec2.cross(hbl.dir, hb.dir)\n    hb.leftSin = Vec2.cross(hbl.dir, hb.dir)\n\n    hb.leftNeighbor = left\n    hbl.rightNeighbor = hbid\n  }\n\n  atomAddNeighbor(hbid) {\n    const hb = this.halfBonds.get(hbid)!\n    const atom = this.atoms.get(hb.begin)!\n\n    for (var i = 0; i < atom.neighbors.length; ++i) {\n      if (this.halfBonds.get(atom.neighbors[i])!.ang > hb.ang) break\n    }\n    atom.neighbors.splice(i, 0, hbid)\n    var ir = atom.neighbors[(i + 1) % atom.neighbors.length]\n    var il =\n      atom.neighbors[(i + atom.neighbors.length - 1) % atom.neighbors.length]\n    this.setHbNext(il, hbid)\n    this.setHbNext(hbid, ir)\n    this.halfBondSetAngle(hbid, il)\n    this.halfBondSetAngle(ir, hbid)\n  }\n\n  atomSortNeighbors(aid) {\n    const atom = this.atoms.get(aid)!\n    const halfBonds = this.halfBonds\n\n    atom.neighbors\n      .sort((nei, nei2) => halfBonds.get(nei)!.ang - halfBonds.get(nei2)!.ang)\n      .forEach((nei, i) => {\n        const nextNei = atom.neighbors[(i + 1) % atom.neighbors.length]\n        this.halfBonds.get(this.halfBonds.get(nei)!.contra)!.next = nextNei\n        this.halfBondSetAngle(nextNei, nei)\n      })\n  }\n\n  sortNeighbors(list) {\n    if (!list) {\n      this.atoms.forEach((_atom, aid) => {\n        this.atomSortNeighbors(aid)\n      })\n    } else {\n      list.forEach(aid => {\n        this.atomSortNeighbors(aid)\n      })\n    }\n  }\n\n  atomUpdateHalfBonds(aid) {\n    this.atoms.get(aid)!.neighbors.forEach(hbid => {\n      this.halfBondUpdate(hbid)\n      this.halfBondUpdate(this.halfBonds.get(hbid)!.contra)\n    })\n  }\n\n  updateHalfBonds(list) {\n    if (!list) {\n      this.atoms.forEach((_atom, aid) => {\n        this.atomUpdateHalfBonds(aid)\n      })\n    } else {\n      list.forEach(aid => {\n        this.atomUpdateHalfBonds(aid)\n      })\n    }\n  }\n\n  sGroupsRecalcCrossBonds() {\n    this.sgroups.forEach(sg => {\n      sg.xBonds = []\n      sg.neiAtoms = []\n    })\n\n    this.bonds.forEach((bond, bid) => {\n      const a1 = this.atoms.get(bond.begin)!\n      const a2 = this.atoms.get(bond.end)!\n\n      a1.sgs.forEach(sgid => {\n        if (!a2.sgs.has(sgid)) {\n          const sg = this.sgroups.get(sgid)!\n          sg.xBonds.push(bid)\n          arrayAddIfMissing(sg.neiAtoms, bond.end)\n        }\n      })\n\n      a2.sgs.forEach(sgid => {\n        if (!a1.sgs.has(sgid)) {\n          const sg = this.sgroups.get(sgid)!\n          sg.xBonds.push(bid)\n          arrayAddIfMissing(sg.neiAtoms, bond.begin)\n        }\n      })\n    })\n  }\n\n  sGroupDelete(sgid: number) {\n    this.sgroups.get(sgid)!.atoms.forEach(atom => {\n      this.atoms.get(atom)!.sgs.delete(sgid)\n    })\n\n    this.sGroupForest.remove(sgid)\n    this.sgroups.delete(sgid)\n  }\n\n  atomSetPos(id: number, pp: Vec2): void {\n    const item = this.atoms.get(id)!\n    item.pp = pp\n  }\n\n  rxnPlusSetPos(id: number, pp: Vec2): void {\n    const item = this.rxnPluses.get(id)!\n    item.pp = pp\n  }\n\n  rxnArrowSetPos(id: number, pos: Array<Vec2>): void {\n    const item = this.rxnArrows.get(id)\n    if (item) {\n      item.pos = pos\n    }\n  }\n\n  simpleObjectSetPos(id: number, pos: Array<Vec2>) {\n    const item = this.simpleObjects.get(id)!\n    item.pos = pos\n  }\n\n  textSetPosition(id: number, position: Vec2): void {\n    const item = this.texts.get(id)\n\n    if (item) {\n      item.position = position\n    }\n  }\n\n  getCoordBoundingBox(atomSet?: Pile<number>) {\n    let bb: any = null\n    function extend(pp) {\n      if (!bb) {\n        bb = {\n          min: pp,\n          max: pp\n        }\n      } else {\n        if (pp instanceof Array) {\n          pp.forEach(vec => {\n            bb.min = Vec2.min(bb.min, vec)\n            bb.max = Vec2.max(bb.max, vec)\n          })\n        } else {\n          bb.min = Vec2.min(bb.min, pp)\n          bb.max = Vec2.max(bb.max, pp)\n        }\n      }\n    }\n\n    let global = !atomSet || atomSet.size === 0\n\n    this.atoms.forEach((atom, aid) => {\n      if (global || atomSet!.has(aid)) extend(atom.pp)\n    })\n    if (global) {\n      this.rxnPluses.forEach(item => {\n        extend(item.pp)\n      })\n      this.rxnArrows.forEach(item => {\n        extend(item.pos)\n      })\n      this.simpleObjects.forEach(item => {\n        extend(item.pos)\n      })\n      this.texts.forEach(item => {\n        extend(item.position)\n      })\n    }\n    if (!bb && global) {\n      bb = {\n        min: new Vec2(0, 0),\n        max: new Vec2(1, 1)\n      }\n    }\n    return bb\n  }\n\n  getCoordBoundingBoxObj() {\n    var bb: any = null\n    function extend(pp) {\n      if (!bb) {\n        bb = {\n          min: new Vec2(pp),\n          max: new Vec2(pp)\n        }\n      } else {\n        bb.min = Vec2.min(bb.min, pp)\n        bb.max = Vec2.max(bb.max, pp)\n      }\n    }\n\n    this.atoms.forEach(atom => {\n      extend(atom.pp)\n    })\n    return bb\n  }\n\n  getBondLengthData() {\n    let totalLength = 0\n    let cnt = 0\n    this.bonds.forEach(bond => {\n      totalLength += Vec2.dist(\n        this.atoms.get(bond.begin)!.pp,\n        this.atoms.get(bond.end)!.pp\n      )\n      cnt++\n    })\n    return { cnt, totalLength }\n  }\n\n  getAvgBondLength(): number {\n    const bld = this.getBondLengthData()\n    return bld.cnt > 0 ? bld.totalLength / bld.cnt : -1\n  }\n\n  getAvgClosestAtomDistance(): number {\n    var totalDist = 0\n    var minDist\n    var dist = 0\n    var keys = Array.from(this.atoms.keys())\n    var k\n    var j\n    for (k = 0; k < keys.length; ++k) {\n      minDist = -1\n      for (j = 0; j < keys.length; ++j) {\n        if (j === k) continue // eslint-disable-line no-continue\n        dist = Vec2.dist(\n          this.atoms.get(keys[j])!.pp,\n          this.atoms.get(keys[k])!.pp\n        )\n        if (minDist < 0 || minDist > dist) minDist = dist\n      }\n      totalDist += minDist\n    }\n\n    return keys.length > 0 ? totalDist / keys.length : -1\n  }\n\n  checkBondExists(begin: number, end: number): boolean {\n    const key = this.bonds.find(\n      (_bid, bond) =>\n        (bond.begin === begin && bond.end === end) ||\n        (bond.end === begin && bond.begin === end)\n    )\n\n    return key !== undefined\n  }\n\n  findConnectedComponent(firstaid: number): Pile<number> {\n    const list = [firstaid]\n    const ids = new Pile<number>()\n    while (list.length > 0) {\n      const aid = list.pop()!\n      ids.add(aid)\n      const atom = this.atoms.get(aid)!\n      atom.neighbors.forEach(nei => {\n        const neiId = this.halfBonds.get(nei)!.end\n        if (!ids.has(neiId)) list.push(neiId)\n      })\n    }\n\n    return ids\n  }\n\n  findConnectedComponents(discardExistingFragments?: boolean) {\n    // NB: this is a hack\n    // TODO: need to maintain half-bond and neighbor structure permanently\n    if (!this.halfBonds.size) {\n      this.initHalfBonds()\n      this.initNeighbors()\n      this.updateHalfBonds(Array.from(this.atoms.keys()))\n      this.sortNeighbors(Array.from(this.atoms.keys()))\n    }\n\n    let addedAtoms = new Pile<number>()\n\n    const components: Array<any> = []\n    this.atoms.forEach((atom, aid) => {\n      if (\n        (discardExistingFragments || atom.fragment < 0) &&\n        !addedAtoms.has(aid)\n      ) {\n        const component = this.findConnectedComponent(aid)\n        components.push(component)\n        addedAtoms = addedAtoms.union(component)\n      }\n    })\n\n    return components\n  }\n\n  markFragment(idSet: Pile<number>) {\n    const frag = new Fragment()\n    const fid = this.frags.add(frag)\n\n    idSet.forEach(aid => {\n      const atom = this.atoms.get(aid)!\n      if (atom.stereoLabel) frag.updateStereoAtom(this, aid, fid, true)\n      atom.fragment = fid\n    })\n  }\n\n  markFragments() {\n    const components = this.findConnectedComponents()\n    components.forEach(comp => {\n      this.markFragment(comp)\n    })\n  }\n\n  scale(scale: number) {\n    if (scale === 1) return\n\n    this.atoms.forEach(atom => {\n      atom.pp = atom.pp.scaled(scale)\n    })\n\n    this.rxnPluses.forEach(item => {\n      item.pp = item.pp.scaled(scale)\n    })\n\n    this.rxnArrows.forEach(item => {\n      item.pos = item.pos.map(p => p.scaled(scale))\n    })\n\n    this.sgroups.forEach(item => {\n      item.pp = item.pp ? item.pp.scaled(scale) : null\n    })\n  }\n\n  rescale() {\n    let avg = this.getAvgBondLength()\n    if (avg < 0 && !this.isReaction)\n      // TODO [MK] this doesn't work well for reactions as the distances between\n      // the atoms in different components are generally larger than those between atoms of a single component\n      // (KETCHER-341)\n      avg = this.getAvgClosestAtomDistance()\n    if (avg < 1e-3) avg = 1\n\n    const scale = 1 / avg\n    this.scale(scale)\n  }\n\n  loopHasSelfIntersections(hbs: Array<number>) {\n    for (let i = 0; i < hbs.length; ++i) {\n      const hbi = this.halfBonds.get(hbs[i])!\n      const ai = this.atoms.get(hbi.begin)!.pp\n      const bi = this.atoms.get(hbi.end)!.pp\n      const set = new Pile([hbi.begin, hbi.end])\n\n      for (let j = i + 2; j < hbs.length; ++j) {\n        const hbj = this.halfBonds.get(hbs[j])!\n        if (set.has(hbj.begin) || set.has(hbj.end)) continue // skip edges sharing an atom\n\n        const aj = this.atoms.get(hbj.begin)!.pp\n        const bj = this.atoms.get(hbj.end)!.pp\n\n        if (Box2Abs.segmentIntersection(ai, bi, aj, bj)) return true\n      }\n    }\n\n    return false\n  }\n\n  // partition a cycle into simple cycles\n  // TODO: [MK] rewrite the detection algorithm to only find simple ones right away?\n  partitionLoop(loop: any) {\n    // eslint-disable-line max-statements\n    const subloops: Array<any> = []\n    let continueFlag = true\n    while (continueFlag) {\n      const atomToHalfBond = {} // map from every atom in the loop to the index of the first half-bond starting from that atom in the uniqHb array\n      continueFlag = false\n\n      for (let l = 0; l < loop.length; ++l) {\n        const hbid = loop[l]\n        const aid1 = this.halfBonds.get(hbid)!.begin\n        const aid2 = this.halfBonds.get(hbid)!.end\n        if (aid2 in atomToHalfBond) {\n          // subloop found\n          const s = atomToHalfBond[aid2] // where the subloop begins\n          const subloop = loop.slice(s, l + 1)\n          subloops.push(subloop)\n          if (l < loop.length)\n            // remove half-bonds corresponding to the subloop\n            loop.splice(s, l - s + 1)\n          continueFlag = true\n          break\n        }\n        atomToHalfBond[aid1] = l\n      }\n      if (!continueFlag) subloops.push(loop) // we're done, no more subloops found\n    }\n    return subloops\n  }\n\n  halfBondAngle(hbid1: number, hbid2: number): number {\n    const hba = this.halfBonds.get(hbid1)!\n    const hbb = this.halfBonds.get(hbid2)!\n    return Math.atan2(Vec2.cross(hba.dir, hbb.dir), Vec2.dot(hba.dir, hbb.dir))\n  }\n\n  loopIsConvex(loop: Array<any>): boolean {\n    return loop.every((item, k, loopArr) => {\n      const angle = this.halfBondAngle(item, loopArr[(k + 1) % loopArr.length])\n      return angle <= 0\n    })\n  }\n\n  // check whether a loop is on the inner or outer side of the polygon\n  //  by measuring the total angle between bonds\n  loopIsInner(loop: Array<any>): boolean {\n    let totalAngle = 2 * Math.PI\n    loop.forEach((hbida, k, loopArr) => {\n      const hbidb = loopArr[(k + 1) % loopArr.length]\n      const hbb = this.halfBonds.get(hbidb)!\n      const angle = this.halfBondAngle(hbida, hbidb)\n      totalAngle += hbb.contra === hbida ? Math.PI : angle // back and forth along the same edge\n    })\n    return Math.abs(totalAngle) < Math.PI\n  }\n\n  findLoops() {\n    const newLoops: Array<any> = []\n    const bondsToMark = new Pile<number>()\n\n    /*\n      Starting from each half-bond not known to be in a loop yet,\n      follow the 'next' links until the initial half-bond is reached or\n      the length of the sequence exceeds the number of half-bonds available.\n      In a planar graph, as long as every bond is a part of some \"loop\" -\n      either an outer or an inner one - every iteration either yields a loop\n      or doesn't start at all. Thus this has linear complexity in the number\n      of bonds for planar graphs.\n   */\n\n    let hbIdNext, c, loop\n    this.halfBonds.forEach((hb, hbId) => {\n      if (hb.loop !== -1) return\n\n      for (\n        hbIdNext = hbId, c = 0, loop = [];\n        c <= this.halfBonds.size;\n        hbIdNext = this.halfBonds.get(hbIdNext)!.next, ++c\n      ) {\n        if (!(c > 0 && hbIdNext === hbId)) {\n          loop.push(hbIdNext)\n          continue // eslint-disable-line no-continue\n        }\n\n        // loop found\n        const subloops = this.partitionLoop(loop)\n        subloops.forEach(loop => {\n          let loopId\n          if (this.loopIsInner(loop) && !this.loopHasSelfIntersections(loop)) {\n            /*\n                        loop is internal\n                        use lowest half-bond id in the loop as the loop id\n                        this ensures that the loop gets the same id if it is discarded and then recreated,\n                        which in turn is required to enable redrawing while dragging, as actions store item id's\n                     */\n            loopId = Math.min(...loop)\n            this.loops.set(\n              loopId,\n              new Loop(loop, this, this.loopIsConvex(loop))\n            )\n          } else {\n            loopId = -2\n          }\n\n          loop.forEach(hbid => {\n            this.halfBonds.get(hbid)!.loop = loopId\n            bondsToMark.add(this.halfBonds.get(hbid)!.bid)\n          })\n\n          if (loopId >= 0) newLoops.push(loopId)\n        })\n        break\n      }\n    })\n\n    return {\n      newLoops,\n      bondsToMark: Array.from(bondsToMark)\n    }\n  }\n\n  calcImplicitHydrogen(aid: number) {\n    const atom = this.atoms.get(aid)!\n    const [conn, isAromatic] = this.calcConn(atom)\n    let correctConn = conn\n    atom.badConn = false\n\n    if (isAromatic) {\n      if (atom.label === 'C' && atom.charge === 0) {\n        if (conn === 3) {\n          atom.implicitH = -radicalElectrons(atom.radical)\n          return\n        }\n        if (conn === 2) {\n          atom.implicitH = 1 - radicalElectrons(atom.radical)\n          return\n        }\n      } else if (\n        (atom.label === 'O' && atom.charge === 0) ||\n        (atom.label === 'N' && atom.charge === 0 && conn === 3) ||\n        (atom.label === 'N' && atom.charge === 1 && conn === 3) ||\n        (atom.label === 'S' && atom.charge === 0 && conn === 3)\n      ) {\n        atom.implicitH = 0\n        return\n      } else if (!atom.hasImplicitH) {\n        correctConn++\n      }\n    }\n\n    if (correctConn < 0 || atom.isQuery()) {\n      atom.implicitH = 0\n      return\n    }\n\n    if (atom.explicitValence >= 0) {\n      const elem = Elements.get(atom.label)\n      atom.implicitH = !!elem\n        ? atom.explicitValence - atom.calcValenceMinusHyd(correctConn)\n        : 0\n      if (atom.implicitH < 0) {\n        atom.implicitH = 0\n        atom.badConn = true\n      }\n    } else {\n      atom.calcValence(correctConn)\n    }\n  }\n\n  setImplicitHydrogen(list?: Array<number>) {\n    this.sgroups.forEach(item => {\n      if (item.data.fieldName === 'MRV_IMPLICIT_H')\n        this.atoms.get(item.atoms[0])!.hasImplicitH = true\n    })\n\n    if (!list) {\n      this.atoms.forEach((_atom, aid) => {\n        this.calcImplicitHydrogen(aid)\n      })\n    } else {\n      list.forEach(aid => {\n        if (this.atoms.get(aid)) {\n          this.calcImplicitHydrogen(aid)\n        }\n      })\n    }\n  }\n\n  atomGetNeighbors(aid: number): Array<Neighbor> | undefined {\n    return this.atoms.get(aid)?.neighbors.map(nei => {\n      const hb = this.halfBonds.get(nei)!\n      return {\n        aid: hb.end,\n        bid: hb.bid\n      }\n    })\n  }\n\n  getComponents() {\n    // eslint-disable-line max-statements\n    /* saver */\n    const connectedComponents = this.findConnectedComponents(true)\n    const barriers: Array<any> = []\n    let arrowPos: number | null = null\n\n    this.rxnArrows.forEach(item => {\n      // there's just one arrow\n      arrowPos = item.center().x\n    })\n\n    this.rxnPluses.forEach(item => {\n      barriers.push(item.pp.x)\n    })\n\n    if (arrowPos !== null) barriers.push(arrowPos)\n\n    barriers.sort((a, b) => a - b)\n\n    const components: Array<any> = []\n\n    connectedComponents.forEach(component => {\n      const bb = this.getCoordBoundingBox(component)\n      const c = Vec2.lc2(bb.min, 0.5, bb.max, 0.5)\n      let j = 0\n\n      while (c.x > barriers[j]) ++j\n\n      components[j] = components[j] || new Pile()\n      components[j] = components[j].union(component)\n    })\n\n    const submolTexts: Array<string> = []\n    const reactants: Array<any> = []\n    const products: Array<any> = []\n\n    components.forEach(component => {\n      if (!component) {\n        submolTexts.push('')\n        return\n      }\n\n      const rxnFragmentType = this.defineRxnFragmentTypeForAtomset(\n        component,\n        arrowPos || 0\n      )\n\n      if (rxnFragmentType === 1) reactants.push(component)\n      else products.push(component)\n    })\n\n    return {\n      reactants,\n      products\n    }\n  }\n\n  defineRxnFragmentTypeForAtomset(atomset: Pile<number>, arrowpos: number) {\n    const bb = this.getCoordBoundingBox(atomset)\n    const c = Vec2.lc2(bb.min, 0.5, bb.max, 0.5)\n    return c.x < arrowpos ? 1 : 2\n  }\n\n  getBondFragment(bid: number) {\n    const aid = this.bonds.get(bid)?.begin\n    return aid && this.atoms.get(aid)?.fragment\n  }\n\n  bindSGroupsToFunctionalGroups() {\n    this.sgroups.forEach(sgroup => {\n      if (FunctionalGroup.isFunctionalGroup(sgroup)) {\n        this.functionalGroups.add(new FunctionalGroup(sgroup))\n      }\n    })\n  }\n}\n","/****************************************************************************\n * Copyright 2021 EPAM Systems\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *    http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n ***************************************************************************/\n\nimport { Vec2 } from './vec2'\n\n//TODO: move to infrastructure\nexport enum TextCommand {\n  Bold = 'BOLD',\n  Italic = 'ITALIC',\n  Subscript = 'SUBSCRIPT',\n  Superscript = 'SUPERSCRIPT',\n  FontSize = 'CUSTOM_FONT_SIZE'\n}\n\nexport interface TextAttributes {\n  //TODO: add Interface for content type\n  content?: string\n  position?: Vec2\n}\n\nexport class Text {\n  content: string\n  position: Vec2\n\n  constructor(attributes?: TextAttributes) {\n    this.content = attributes?.content || ''\n    this.position = attributes?.position\n      ? new Vec2(attributes.position)\n      : new Vec2()\n  }\n\n  clone(): Text {\n    return new Text(this)\n  }\n}\n","/****************************************************************************\n * Copyright 2021 EPAM Systems\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *    http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n ***************************************************************************/\n\nexport interface HighlightAttributes {\n  atoms: Array<number>\n  bonds: Array<number>\n  color: string\n}\n\nexport class Highlight {\n  atoms: Array<number>\n  bonds: Array<number>\n  color: string\n\n  constructor(attributes: HighlightAttributes) {\n    const { atoms, bonds, color } = attributes\n    this.color = color\n    this.atoms = atoms\n    this.bonds = bonds\n  }\n}\n","/****************************************************************************\n * Copyright 2021 EPAM Systems\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *    http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n ***************************************************************************/\n\nexport function ifDef<TValue = any>(\n  target: any,\n  key: string,\n  value: TValue,\n  defaultValue?: TValue\n) {\n  if (\n    value !== undefined &&\n    value !== null &&\n    value !== defaultValue &&\n    !(Array.isArray(value) && value.length === 0)\n  )\n    target[key] = value\n}\n","export function tfx<TValue extends number | string>(value: TValue): string {\n  let parsedValue: number\n  if (typeof value == 'number') {\n    parsedValue = value\n  } else {\n    parsedValue = parseFloat(value)\n  }\n  return parsedValue.toFixed(8)\n}\n","/****************************************************************************\n * Copyright 2021 EPAM Systems\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *    http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n ***************************************************************************/\n\nimport { SGroup, Struct } from 'domain/entities'\n\nimport { ifDef } from 'utilities'\n\nfunction fromRlabel(rg) {\n  const res: Array<any> = []\n  let rgi\n  let val\n  for (rgi = 0; rgi < 32; rgi++) {\n    if (rg & (1 << rgi)) {\n      val = rgi + 1\n      res.push(val) // push the string\n    }\n  }\n  return res\n}\n\nexport function moleculeToKet(struct: Struct): any {\n  const body: any = {\n    atoms: Array.from(struct.atoms.values()).map(atom => {\n      if (atom.label === 'R#') return rglabelToKet(atom)\n      if (atom.label === 'L#') return atomListToKet(atom)\n      return atomToKet(atom)\n    })\n  }\n\n  if (struct.bonds.size !== 0)\n    body.bonds = Array.from(struct.bonds.values()).map(bondToKet)\n\n  if (struct.sgroups.size !== 0)\n    body.sgroups = Array.from(struct.sgroups.values()).map(sGroup =>\n      sgroupToKet(struct, sGroup)\n    )\n\n  const fragment = struct.frags.get(0)\n  if (fragment) {\n    ifDef(body, 'stereoFlagPosition', fragment.stereoFlagPosition, null)\n  }\n  return {\n    type: 'molecule',\n    ...body\n  }\n}\n\nfunction atomToKet(source) {\n  const result = {}\n  ifDef(result, 'label', source.label)\n  ifDef(result, 'alias', source.alias)\n  ifDef(result, 'location', [source.pp.x, -source.pp.y, source.pp.z])\n  ifDef(result, 'charge', source.charge, 0)\n  ifDef(result, 'explicitValence', source.explicitValence, -1)\n  ifDef(result, 'isotope', source.isotope, 0)\n  ifDef(result, 'radical', source.radical, 0)\n  ifDef(result, 'attachmentPoints', source.attpnt, 0)\n  // stereo\n  ifDef(result, 'stereoLabel', source.stereoLabel, null)\n  ifDef(result, 'stereoParity', source.stereoCare, 0)\n  ifDef(result, 'weight', source.weight, 0)\n  // query\n  ifDef(result, 'ringBondCount', source.ringBondCount, 0)\n  ifDef(result, 'substitutionCount', source.substitutionCount, 0)\n  ifDef(result, 'unsaturatedAtom', !!source.unsaturatedAtom, false)\n  ifDef(result, 'hCount', source.hCount, 0)\n  // reaction\n  ifDef(result, 'mapping', parseInt(source.aam), 0)\n  ifDef(result, 'invRet', source.invRet, 0)\n  ifDef(result, 'exactChangeFlag', !!source.exactChangeFlag, false)\n  return result\n}\n\nfunction rglabelToKet(source) {\n  const result = {\n    type: 'rg-label'\n  }\n  ifDef(result, 'location', [source.pp.x, source.pp.y, source.pp.z])\n  ifDef(result, 'attachmentPoints', source.attpnt, 0)\n\n  const refsToRGroups = fromRlabel(source.rglabel).map(\n    rgnumber => `rg-${rgnumber}`\n  )\n  ifDef(result, '$refs', refsToRGroups)\n\n  return result\n}\n\nfunction atomListToKet(source) {\n  const result = {\n    type: 'atom-list'\n  }\n  ifDef(result, 'location', [source.pp.x, source.pp.y, source.pp.z])\n  ifDef(result, 'attachmentPoints', source.attpnt, 0)\n  ifDef(result, 'elements', source.atomList.labelList())\n  ifDef(result, 'notList', source.atomList.notList, false)\n  return result\n}\n\nfunction bondToKet(source) {\n  const result = {}\n\n  ifDef(result, 'type', source.type)\n  ifDef(result, 'atoms', [source.begin, source.end])\n  ifDef(result, 'stereo', source.stereo, 0)\n  ifDef(result, 'topology', source.topology, 0)\n  ifDef(result, 'center', source.reactingCenterStatus, 0)\n\n  return result\n}\n\nfunction sgroupToKet(struct, source) {\n  const result = {}\n\n  ifDef(result, 'type', source.type)\n  ifDef(result, 'atoms', source.atoms)\n\n  switch (source.type) {\n    case 'GEN':\n      break\n    case 'MUL': {\n      ifDef(result, 'mul', source.data.mul || 1)\n      break\n    }\n    case 'SRU': {\n      ifDef(result, 'subscript', source.data.subscript || 'n')\n      ifDef(\n        result,\n        'connectivity',\n        source.data.connectivity.toUpperCase() || 'ht'\n      )\n      break\n    }\n    case 'SUP': {\n      ifDef(result, 'name', source.data.name || '')\n      ifDef(result, 'expanded', source.data.expanded)\n      ifDef(result, 'id', source.id)\n      break\n    }\n    case 'DAT': {\n      const data = source.data\n      ifDef(result, 'placement', data.absolute, true)\n      ifDef(result, 'display', data.attached, false)\n      ifDef(result, 'context', data.context)\n      ifDef(result, 'fieldName', data.fieldName)\n      ifDef(result, 'fieldData', data.fieldValue)\n      ifDef(result, 'bonds', SGroup.getBonds(struct, source))\n      break\n    }\n    default:\n      break\n  }\n\n  return result\n}\n","/****************************************************************************\n * Copyright 2021 EPAM Systems\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *    http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n ***************************************************************************/\n\nimport { Atom, Bond, SGroup, Struct } from 'domain/entities'\n\nimport { Elements } from 'domain/constants'\nimport { ifDef } from 'utilities'\n\nexport function toRlabel(values) {\n  let res = 0\n  values.forEach(val => {\n    const rgi = val - 1\n    res |= 1 << rgi\n  })\n  return res\n}\n\nexport function moleculeToStruct(ketItem: any): Struct {\n  const struct = new Struct()\n  ketItem.atoms.forEach(atom => {\n    if (atom.type === 'rg-label') struct.atoms.add(rglabelToStruct(atom))\n    if (atom.type === 'atom-list') struct.atoms.add(atomListToStruct(atom))\n    if (!atom.type) struct.atoms.add(atomToStruct(atom))\n  })\n\n  if (ketItem.bonds)\n    ketItem.bonds.forEach(bond => struct.bonds.add(bondToStruct(bond)))\n\n  if (ketItem.sgroups)\n    ketItem.sgroups.forEach(sgroup =>\n      struct.sgroups.add(sgroupToStruct(sgroup))\n    )\n\n  struct.initHalfBonds()\n  struct.initNeighbors()\n  struct.markFragments()\n  struct.bindSGroupsToFunctionalGroups()\n\n  return struct\n}\n\nexport function atomToStruct(source) {\n  const params: any = {}\n\n  ifDef(params, 'label', source.label)\n  ifDef(params, 'alias', source.alias)\n  ifDef(params, 'pp', {\n    x: source.location[0],\n    y: -source.location[1],\n    z: source.location[2] || 0.0\n  })\n  ifDef(params, 'charge', source.charge)\n  ifDef(params, 'explicitValence', source.explicitValence)\n  ifDef(params, 'isotope', source.isotope)\n  ifDef(params, 'radical', source.radical)\n  ifDef(params, 'attpnt', source.attachmentPoints)\n  // stereo\n  ifDef(params, 'stereoLabel', source.stereoLabel)\n  ifDef(params, 'stereoParity', source.stereoParity)\n  ifDef(params, 'weight', source.weight)\n  // query\n  ifDef(params, 'ringBondCount', source.ringBondCount)\n  ifDef(params, 'substitutionCount', source.substitutionCount)\n  ifDef(params, 'unsaturatedAtom', source.unsaturatedAtom)\n  ifDef(params, 'hCount', source.hCount)\n  // reaction\n  ifDef(params, 'aam', source.mapping)\n  ifDef(params, 'invRet', source.invRet)\n  ifDef(params, 'exactChangeFlag', !!source.exactChangeFlag)\n  return new Atom(params)\n}\n\nexport function rglabelToStruct(source) {\n  const params: any = {}\n  params.label = 'R#'\n  ifDef(params, 'pp', {\n    x: source.location[0],\n    y: source.location[1],\n    z: source.location[2] || 0.0\n  })\n  ifDef(params, 'attpnt', source.attachmentPoints)\n  const rglabel = toRlabel(source.$refs.map(el => parseInt(el.slice(3))))\n  ifDef(params, 'rglabel', rglabel)\n  return new Atom(params)\n}\n\nexport function atomListToStruct(source) {\n  const params: any = {}\n  params.label = 'L#'\n  ifDef(params, 'pp', {\n    x: source.location[0],\n    y: source.location[1],\n    z: source.location[2] || 0.0\n  })\n  ifDef(params, 'attpnt', source.attachmentPoints)\n  const ids = source.elements\n    .map(el => Elements.get(el)?.number)\n    .filter(id => id)\n  ifDef(params, 'atomList', {\n    ids,\n    notList: source.notList\n  })\n  return new Atom(params)\n}\n\nexport function bondToStruct(source) {\n  const params: any = {}\n\n  ifDef(params, 'type', source.type)\n  ifDef(params, 'topology', source.topology)\n  ifDef(params, 'reactingCenterStatus', source.center)\n  ifDef(params, 'stereo', source.stereo)\n  // if (params.stereo)\n  // \tparams.stereo = params.stereo > 1 ? params.stereo * 2 : params.stereo;\n  // params.xxx = 0;\n  ifDef(params, 'begin', source.atoms[0])\n  ifDef(params, 'end', source.atoms[1])\n\n  return new Bond(params)\n}\n\nexport function sgroupToStruct(source) {\n  const sgroup = new SGroup(source.type)\n  ifDef(sgroup, 'atoms', source.atoms)\n  switch (source.type) {\n    case 'GEN':\n      break\n    case 'MUL': {\n      ifDef(sgroup.data, 'mul', source.mul)\n      break\n    }\n    case 'SRU': {\n      ifDef(sgroup.data, 'subscript', source.subscript)\n      ifDef(sgroup.data, 'connectivity', source.connectivity.toLowerCase())\n      break\n    }\n    case 'SUP': {\n      ifDef(sgroup.data, 'name', source.name)\n      ifDef(sgroup.data, 'expanded', source.expanded)\n      ifDef(sgroup, 'id', source.id)\n      break\n    }\n    case 'DAT': {\n      ifDef(sgroup.data, 'absolute', source.placement)\n      ifDef(sgroup.data, 'attached', source.display)\n      ifDef(sgroup.data, 'context', source.context)\n      ifDef(sgroup.data, 'fieldName', source.fieldName)\n      ifDef(sgroup.data, 'fieldValue', source.fieldData)\n      break\n    }\n    default:\n      break\n  }\n  return sgroup\n}\n","/****************************************************************************\n * Copyright 2021 EPAM Systems\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *    http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n ***************************************************************************/\nimport { Pile, Struct, Vec2, SGroup } from 'domain/entities'\n\nexport function prepareStructForKet(struct: Struct) {\n  const ketNodes: any = []\n\n  const rgFrags = new Set() // skip this when writing molecules\n  for (const [rgnumber, rgroup] of struct.rgroups.entries()) {\n    // RGroups writing\n    rgroup.frags.forEach(frid => rgFrags.add(frid))\n\n    const fragsAtoms = Array.from(rgroup.frags.values()).reduce(\n      (res, frid) => res.union(struct.getFragmentIds(frid)),\n      new Pile()\n    )\n\n    ketNodes.push({\n      type: 'rgroup',\n      fragment: struct.clone(fragsAtoms),\n      center: getFragmentCenter(struct, fragsAtoms),\n      data: { rgnumber, rgroup }\n    })\n  }\n\n  Array.from(struct.frags.keys())\n    .filter(fid => !rgFrags.has(fid))\n    .forEach(fid => {\n      const fragAtoms = struct.getFragmentIds(fid)\n      ketNodes.push({\n        type: 'molecule',\n        fragment: struct.clone(fragAtoms),\n        center: getFragmentCenter(struct, fragAtoms)\n      })\n    })\n\n  struct.rxnArrows.forEach(item => {\n    ketNodes.push({\n      type: 'arrow',\n      center: item.pos[0],\n      data: {\n        mode: item.mode,\n        pos: item.pos\n      }\n    })\n  })\n\n  struct.rxnPluses.forEach(item => {\n    ketNodes.push({\n      type: 'plus',\n      center: item.pp,\n      data: {}\n    })\n  })\n\n  struct.simpleObjects.forEach(item => {\n    ketNodes.push({\n      type: 'simpleObject',\n      center: item.pos[0],\n      data: {\n        mode: item.mode,\n        pos: item.pos\n      }\n    })\n  })\n\n  struct.texts.forEach(item => {\n    ketNodes.push({\n      type: 'text',\n      center: item.position,\n      data: {\n        content: item.content,\n        position: item.position\n      }\n    })\n  })\n\n  ketNodes.forEach(ketNode => {\n    if (ketNode.fragment) {\n      const sgroups: SGroup[] = Array.from(ketNode.fragment.sgroups.values())\n      const filteredSGroups = sgroups.filter((sg: SGroup) =>\n        sg.atoms.every(atom => atom !== undefined)\n      )\n      const filteredSGroupsMap = new Map()\n      filteredSGroups.forEach((sg, index) => {\n        filteredSGroupsMap.set(index, sg)\n      })\n      ketNode.fragment.sgroups = filteredSGroupsMap\n    }\n  })\n\n  //TODO: check if this sorting operation is needed\n  //return ketNodes.sort((a, b) => a.center.x - b.center.x)\n  return ketNodes\n}\n\nfunction getFragmentCenter(struct, atomSet) {\n  const bb = struct.getCoordBoundingBox(atomSet)\n  return Vec2.centre(bb.min, bb.max)\n}\n","/****************************************************************************\n * Copyright 2021 EPAM Systems\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *    http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n ***************************************************************************/\n\nimport { Struct } from 'domain/entities'\nimport { ifDef } from 'utilities'\nimport { moleculeToKet } from './moleculeToKet'\n\nexport function rgroupToKet(struct: Struct, data) {\n  const body = {\n    rlogic: rgroupLogicToKet(data.rgnumber, data.rgroup),\n    ...moleculeToKet(struct)\n  }\n\n  return {\n    ...body,\n    type: 'rgroup'\n  }\n}\n\nfunction rgroupLogicToKet(rgnumber, rglogic) {\n  const result = {}\n\n  ifDef(result, 'number', rgnumber)\n  ifDef(result, 'range', rglogic.range, '')\n  ifDef(result, 'resth', rglogic.resth, false)\n  ifDef(result, 'ifthen', rglogic.ifthen, 0)\n\n  return result\n}\n","/****************************************************************************\n * Copyright 2021 EPAM Systems\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *    http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n ***************************************************************************/\n\nimport { RGroup, Struct } from 'domain/entities'\n\nimport { ifDef } from 'utilities'\nimport { moleculeToStruct } from './moleculeToStruct'\n\nexport function rgroupToStruct(ketItem): Struct {\n  const struct = moleculeToStruct(ketItem)\n  const rgroup = rgroupLogicToStruct(ketItem.rlogic)\n  struct.frags.forEach((_value: any, key) => {\n    rgroup.frags.add(key)\n  })\n  if (ketItem.rlogic) struct.rgroups.set(ketItem.rlogic.number, rgroup)\n  return struct\n}\n\nexport function rgroupLogicToStruct(rglogic) {\n  const params = {}\n  ifDef(params, 'range', rglogic.range)\n  ifDef(params, 'resth', rglogic.resth)\n  ifDef(params, 'ifthen', rglogic.ifthen)\n\n  return new RGroup(params)\n}\n","/****************************************************************************\n * Copyright 2021 EPAM Systems\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *    http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n ***************************************************************************/\n\nimport { RxnArrow, RxnPlus, Struct } from 'domain/entities'\n\nexport function rxnToStruct(ketItem: any, struct: Struct): Struct {\n  if (ketItem.type === 'arrow') {\n    struct.rxnArrows.add(new RxnArrow(ketItem.data))\n  } else {\n    struct.rxnPluses.add(\n      new RxnPlus({\n        pp: {\n          x: ketItem.location[0],\n          y: ketItem.location[1],\n          z: ketItem.location[2]\n        }\n      })\n    )\n  }\n  return struct\n}\n","/****************************************************************************\n * Copyright 2021 EPAM Systems\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *    http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n ***************************************************************************/\n\nimport { SimpleObject, SimpleObjectMode, Struct, Vec2 } from 'domain/entities'\n\nexport function simpleObjectToStruct(ketItem: any, struct: Struct): Struct {\n  const object =\n    ketItem.data.mode === 'circle' ? circleToEllipse(ketItem) : ketItem.data\n  struct.simpleObjects.add(new SimpleObject(object))\n  return struct\n}\n\n/**\n * @deprecated TODO to remove after release 2.3\n * As circle has been migrated to ellipses here is function for converting old files data with circles to ellipse type\n * @param ketItem\n */\nfunction circleToEllipse(ketItem) {\n  const radius = Vec2.dist(ketItem.data.pos[1], ketItem.data.pos[0])\n  const pos0 = ketItem.data.pos[0]\n  return {\n    mode: SimpleObjectMode.ellipse,\n    pos: [\n      {\n        x: pos0.x - Math.abs(radius),\n        y: pos0.y - Math.abs(radius),\n        z: pos0.z - Math.abs(radius)\n      },\n      {\n        x: pos0.x + Math.abs(radius),\n        y: pos0.y + Math.abs(radius),\n        z: pos0.z + Math.abs(radius)\n      }\n    ]\n  }\n}\n","/****************************************************************************\n * Copyright 2021 EPAM Systems\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *    http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n ***************************************************************************/\n\nimport { Struct, Vec2 } from 'domain/entities'\nimport { arrowToKet, plusToKet } from './toKet/rxnToKet'\n\nimport { Serializer } from '../serializers.types'\nimport { headerToKet } from './toKet/headerToKet'\nimport { moleculeToKet } from './toKet/moleculeToKet'\nimport { moleculeToStruct } from './fromKet/moleculeToStruct'\nimport { prepareStructForKet } from './toKet/prepare'\nimport { rgroupToKet } from './toKet/rgroupToKet'\nimport { rgroupToStruct } from './fromKet/rgroupToStruct'\nimport { rxnToStruct } from './fromKet/rxnToStruct'\nimport { simpleObjectToKet } from './toKet/simpleObjectToKet'\nimport { simpleObjectToStruct } from './fromKet/simpleObjectToStruct'\nimport { textToKet } from './toKet/textToKet'\nimport { textToStruct } from './fromKet/textToStruct'\nimport { validate } from './validate'\n\nfunction parseNode(node: any, struct: any) {\n  const type = node.type\n  switch (type) {\n    case 'arrow':\n      rxnToStruct(node, struct)\n      break\n    case 'plus':\n      rxnToStruct(node, struct)\n      break\n    case 'simpleObject':\n      simpleObjectToStruct(node, struct)\n      break\n    case 'molecule':\n      const currentStruct = moleculeToStruct(node)\n      if (node.stereoFlagPosition) {\n        const fragment = currentStruct.frags.get(0)!\n        fragment.stereoFlagPosition = new Vec2(node.stereoFlagPosition)\n      }\n\n      currentStruct.mergeInto(struct)\n      break\n    case 'rgroup':\n      rgroupToStruct(node).mergeInto(struct)\n      break\n    case 'text':\n      textToStruct(node, struct)\n      break\n    default:\n      break\n  }\n}\nexport class KetSerializer implements Serializer<Struct> {\n  deserialize(content: string): Struct {\n    const resultingStruct = new Struct()\n    const ket = JSON.parse(content)\n    if (!validate(ket)) {\n      throw new Error('Cannot deserialize input JSON.')\n    }\n    resultingStruct.name = ket.header ? ket.header.moleculeName : null\n    const nodes = ket.root.nodes\n    Object.keys(nodes).forEach(i => {\n      if (nodes[i].type) parseNode(nodes[i], resultingStruct)\n      else if (nodes[i].$ref) parseNode(ket[nodes[i].$ref], resultingStruct)\n    })\n\n    return resultingStruct\n  }\n\n  serialize(struct: Struct): string {\n    const result: any = {\n      root: {\n        nodes: []\n      }\n    }\n\n    const header = headerToKet(struct)\n    if (header) result.header = header\n\n    const ketNodes = prepareStructForKet(struct)\n\n    let moleculeId = 0\n    ketNodes.forEach(item => {\n      switch (item.type) {\n        case 'molecule': {\n          result.root.nodes.push({ $ref: `mol${moleculeId}` })\n          result[`mol${moleculeId++}`] = moleculeToKet(item.fragment)\n          break\n        }\n        case 'rgroup': {\n          result.root.nodes.push({ $ref: `rg${item.data!.rgnumber}` })\n          result[`rg${item.data!.rgnumber}`] = rgroupToKet(\n            item.fragment,\n            item.data\n          )\n          break\n        }\n        case 'plus': {\n          result.root.nodes.push(plusToKet(item))\n          break\n        }\n        case 'arrow': {\n          result.root.nodes.push(arrowToKet(item))\n          break\n        }\n        case 'simpleObject': {\n          result.root.nodes.push(simpleObjectToKet(item))\n          break\n        }\n        case 'text': {\n          result.root.nodes.push(textToKet(item))\n          break\n        }\n        default:\n          break\n      }\n    })\n\n    return JSON.stringify(result, null, 4)\n  }\n}\n","/****************************************************************************\n * Copyright 2021 EPAM Systems\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *    http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n ***************************************************************************/\n\nimport { Struct, Text } from 'domain/entities'\n\nexport function textToStruct(ketItem: any, struct: Struct) {\n  const object = ketItem.data\n  struct.texts.add(new Text(object))\n\n  return struct\n}\n","/****************************************************************************\n * Copyright 2021 EPAM Systems\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *    http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n ***************************************************************************/\n\nimport { Validator } from 'jsonschema'\nimport schema from './schema.json'\n\nexport function validate(ket: any): boolean {\n  const validator = new Validator()\n  const result = validator.validate(ket, schema)\n  return result.valid\n}\n","/****************************************************************************\n * Copyright 2021 EPAM Systems\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *    http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n ***************************************************************************/\n\nimport { Struct } from 'domain/entities'\nimport { ifDef } from 'utilities'\n\nexport function headerToKet(struct: Struct): any {\n  const header = {}\n\n  ifDef(header, 'moleculeName', struct.name, '')\n  ifDef(header, 'creatorProgram', null, '')\n  ifDef(header, 'comment', null, '')\n\n  return Object.keys(header).length !== 0 ? header : null\n}\n","/****************************************************************************\n * Copyright 2021 EPAM Systems\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *    http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n ***************************************************************************/\n\nexport function arrowToKet(arrowNode) {\n  return {\n    type: 'arrow',\n    data: arrowNode.data\n  }\n}\n\nexport function plusToKet(plusNode) {\n  const coord = plusNode.center\n  return {\n    type: 'plus',\n    location: [coord.x, coord.y, coord.z],\n    prop: plusNode.data\n  }\n}\n","/****************************************************************************\n * Copyright 2021 EPAM Systems\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *    http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n ***************************************************************************/\n\nexport function simpleObjectToKet(simpleObjectNode) {\n  return {\n    type: 'simpleObject',\n    data: simpleObjectNode.data\n  }\n}\n","/****************************************************************************\n * Copyright 2021 EPAM Systems\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *    http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n ***************************************************************************/\n\nexport function textToKet(textNode) {\n  return {\n    type: 'text',\n    data: textNode.data\n  }\n}\n","/****************************************************************************\n * Copyright 2021 EPAM Systems\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *    http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n ***************************************************************************/\nimport {\n  Bond,\n  RxnArrow,\n  RxnPlus,\n  Struct,\n  Vec2,\n  RGroup,\n  Fragment\n} from 'domain/entities'\n\nfunction paddedNum(number, width, precision) {\n  number = parseFloat(number)\n\n  var numStr = number.toFixed(precision || 0).replace(',', '.') // Really need to replace?\n  if (numStr.length > width) throw new Error('number does not fit')\n\n  return numStr.padStart(width)\n}\n\nfunction parseDecimalInt(str) {\n  /* reader */\n  var val = parseInt(str, 10)\n\n  return isNaN(val) ? 0 : val // eslint-disable-line\n}\n\nfunction partitionLine(\n  /* string*/ str,\n  /* array of int*/ parts,\n  /* bool*/ withspace\n) {\n  /* reader */\n  var res = []\n  for (var i = 0, shift = 0; i < parts.length; ++i) {\n    res.push(str.slice(shift, shift + parts[i]))\n    if (withspace) shift++\n    shift += parts[i]\n  }\n  return res\n}\n\nfunction partitionLineFixed(\n  /* string*/ str,\n  /* int*/ itemLength,\n  /* bool*/ withspace\n) {\n  /* reader */\n  var res = []\n  for (var shift = 0; shift < str.length; shift += itemLength) {\n    res.push(str.slice(shift, shift + itemLength))\n    if (withspace) shift++\n  }\n  return res\n}\n\nvar fmtInfo = {\n  bondTypeMap: {\n    1: Bond.PATTERN.TYPE.SINGLE,\n    2: Bond.PATTERN.TYPE.DOUBLE,\n    3: Bond.PATTERN.TYPE.TRIPLE,\n    4: Bond.PATTERN.TYPE.AROMATIC,\n    5: Bond.PATTERN.TYPE.SINGLE_OR_DOUBLE,\n    6: Bond.PATTERN.TYPE.SINGLE_OR_AROMATIC,\n    7: Bond.PATTERN.TYPE.DOUBLE_OR_AROMATIC,\n    8: Bond.PATTERN.TYPE.ANY,\n    9: Bond.PATTERN.TYPE.DATIVE,\n    10: Bond.PATTERN.TYPE.HYDROGEN\n  },\n  bondStereoMap: {\n    0: Bond.PATTERN.STEREO.NONE,\n    1: Bond.PATTERN.STEREO.UP,\n    4: Bond.PATTERN.STEREO.EITHER,\n    6: Bond.PATTERN.STEREO.DOWN,\n    3: Bond.PATTERN.STEREO.CIS_TRANS\n  },\n  v30bondStereoMap: {\n    0: Bond.PATTERN.STEREO.NONE,\n    1: Bond.PATTERN.STEREO.UP,\n    2: Bond.PATTERN.STEREO.EITHER,\n    3: Bond.PATTERN.STEREO.DOWN\n  },\n  bondTopologyMap: {\n    0: Bond.PATTERN.TOPOLOGY.EITHER,\n    1: Bond.PATTERN.TOPOLOGY.RING,\n    2: Bond.PATTERN.TOPOLOGY.CHAIN\n  },\n  countsLinePartition: [3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 6],\n  atomLinePartition: [10, 10, 10, 1, 3, 2, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3],\n  bondLinePartition: [3, 3, 3, 3, 3, 3, 3],\n  atomListHeaderPartition: [3, 1, 1, 4, 1, 1],\n  atomListHeaderLength: 11, // = atomListHeaderPartition.reduce(function(a,b) { return a + b; }, 0)\n  atomListHeaderItemLength: 4,\n  chargeMap: [0, +3, +2, +1, 0, -1, -2, -3],\n  valenceMap: [undefined, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 0],\n  implicitHydrogenMap: [undefined, 0, 1, 2, 3, 4],\n  v30atomPropMap: {\n    CHG: 'charge',\n    RAD: 'radical',\n    MASS: 'isotope',\n    VAL: 'explicitValence',\n    HCOUNT: 'hCount',\n    INVRET: 'invRet',\n    SUBST: 'substitutionCount',\n    UNSAT: 'unsaturatedAtom',\n    RBCNT: 'ringBondCount'\n  },\n  rxnItemsPartition: [3, 3, 3]\n}\n\nvar FRAGMENT = {\n  NONE: 0,\n  REACTANT: 1,\n  PRODUCT: 2,\n  AGENT: 3\n}\n\nvar SHOULD_RESCALE_MOLECULES = true\n\nfunction rxnMerge(\n  mols,\n  nReactants,\n  nProducts,\n  nAgents,\n  shouldReactionRelayout\n) /* Struct */ {\n  // eslint-disable-line max-statements\n  /* reader */\n  var ret = new Struct()\n  var bbReact = [],\n    bbAgent = [],\n    bbProd = []\n  var molReact = [],\n    molAgent = [],\n    molProd = []\n  var j\n  var bondLengthData = { cnt: 0, totalLength: 0 }\n  for (j = 0; j < mols.length; ++j) {\n    var mol = mols[j]\n    var bondLengthDataMol = mol.getBondLengthData()\n    bondLengthData.cnt += bondLengthDataMol.cnt\n    bondLengthData.totalLength += bondLengthDataMol.totalLength\n  }\n  if (SHOULD_RESCALE_MOLECULES) {\n    var avgBondLength =\n      1 /\n      (bondLengthData.cnt == 0\n        ? 1\n        : bondLengthData.totalLength / bondLengthData.cnt)\n    for (j = 0; j < mols.length; ++j) {\n      mol = mols[j]\n      mol.scale(avgBondLength)\n    }\n  }\n\n  for (j = 0; j < mols.length; ++j) {\n    mol = mols[j]\n    var bb = mol.getCoordBoundingBoxObj()\n    if (!bb) continue // eslint-disable-line no-continue\n\n    var fragmentType =\n      j < nReactants\n        ? FRAGMENT.REACTANT // eslint-disable-line no-nested-ternary\n        : j < nReactants + nProducts\n        ? FRAGMENT.PRODUCT\n        : FRAGMENT.AGENT\n    if (fragmentType == FRAGMENT.REACTANT) {\n      bbReact.push(bb)\n      molReact.push(mol)\n    } else if (fragmentType == FRAGMENT.AGENT) {\n      bbAgent.push(bb)\n      molAgent.push(mol)\n    } else if (fragmentType == FRAGMENT.PRODUCT) {\n      bbProd.push(bb)\n      molProd.push(mol)\n    }\n\n    mol.atoms.forEach(atom => {\n      atom.rxnFragmentType = fragmentType\n    })\n  }\n\n  function shiftMol(ret, mol, bb, xorig, over) {\n    // eslint-disable-line max-params\n    var d = new Vec2(\n      xorig - bb.min.x,\n      over ? 1 - bb.min.y : -(bb.min.y + bb.max.y) / 2\n    )\n    mol.atoms.forEach(atom => {\n      atom.pp.add_(d) // eslint-disable-line no-underscore-dangle\n    })\n\n    mol.sgroups.forEach(item => {\n      if (item.pp) item.pp.add_(d) // eslint-disable-line no-underscore-dangle\n    })\n    bb.min.add_(d) // eslint-disable-line no-underscore-dangle\n    bb.max.add_(d) // eslint-disable-line no-underscore-dangle\n    mol.mergeInto(ret)\n    return bb.max.x - bb.min.x\n  }\n\n  if (shouldReactionRelayout) {\n    // reaction fragment layout\n    var xorig = 0\n    for (j = 0; j < molReact.length; ++j)\n      xorig += shiftMol(ret, molReact[j], bbReact[j], xorig, false) + 2.0\n    xorig += 2.0\n    for (j = 0; j < molAgent.length; ++j)\n      xorig += shiftMol(ret, molAgent[j], bbAgent[j], xorig, true) + 2.0\n    xorig += 2.0\n\n    for (j = 0; j < molProd.length; ++j)\n      xorig += shiftMol(ret, molProd[j], bbProd[j], xorig, false) + 2.0\n  } else {\n    for (j = 0; j < molReact.length; ++j) molReact[j].mergeInto(ret)\n    for (j = 0; j < molAgent.length; ++j) molAgent[j].mergeInto(ret)\n    for (j = 0; j < molProd.length; ++j) molProd[j].mergeInto(ret)\n  }\n\n  var bb1\n  var bb2\n  var x\n  var y\n  var bbReactAll = null\n  var bbProdAll = null\n  for (j = 0; j < bbReact.length - 1; ++j) {\n    bb1 = bbReact[j]\n    bb2 = bbReact[j + 1]\n\n    x = (bb1.max.x + bb2.min.x) / 2\n    y = (bb1.max.y + bb1.min.y + bb2.max.y + bb2.min.y) / 4\n\n    ret.rxnPluses.add(new RxnPlus({ pp: new Vec2(x, y) }))\n  }\n  for (j = 0; j < bbReact.length; ++j) {\n    if (j == 0) {\n      bbReactAll = {}\n      bbReactAll.max = new Vec2(bbReact[j].max)\n      bbReactAll.min = new Vec2(bbReact[j].min)\n    } else {\n      bbReactAll.max = Vec2.max(bbReactAll.max, bbReact[j].max)\n      bbReactAll.min = Vec2.min(bbReactAll.min, bbReact[j].min)\n    }\n  }\n  for (j = 0; j < bbProd.length - 1; ++j) {\n    bb1 = bbProd[j]\n    bb2 = bbProd[j + 1]\n\n    x = (bb1.max.x + bb2.min.x) / 2\n    y = (bb1.max.y + bb1.min.y + bb2.max.y + bb2.min.y) / 4\n\n    ret.rxnPluses.add(new RxnPlus({ pp: new Vec2(x, y) }))\n  }\n  for (j = 0; j < bbProd.length; ++j) {\n    if (j == 0) {\n      bbProdAll = {}\n      bbProdAll.max = new Vec2(bbProd[j].max)\n      bbProdAll.min = new Vec2(bbProd[j].min)\n    } else {\n      bbProdAll.max = Vec2.max(bbProdAll.max, bbProd[j].max)\n      bbProdAll.min = Vec2.min(bbProdAll.min, bbProd[j].min)\n    }\n  }\n  bb1 = bbReactAll\n  bb2 = bbProdAll\n  const defaultArrowLength = 2\n\n  if (!bb1 && !bb2) {\n    ret.rxnArrows.add(\n      new RxnArrow({\n        mode: 'open-angle',\n        pos: [new Vec2(0, 0), new Vec2(defaultArrowLength, 0)]\n      })\n    )\n  } else {\n    var v1 = bb1 ? new Vec2(bb1.max.x, (bb1.max.y + bb1.min.y) / 2) : null\n    var v2 = bb2 ? new Vec2(bb2.min.x, (bb2.max.y + bb2.min.y) / 2) : null\n    var defaultOffset = 3\n    if (!v1) v1 = new Vec2(v2.x - defaultOffset, v2.y)\n    if (!v2) v2 = new Vec2(v1.x + defaultOffset, v1.y)\n    const arrowCenter = Vec2.lc2(v1, 0.5, v2, 0.5)\n    const arrowStart = new Vec2(\n      arrowCenter.x - 0.5 * defaultArrowLength,\n      arrowCenter.y,\n      arrowCenter.z\n    )\n    const arrowEnd = new Vec2(\n      arrowCenter.x + 0.5 * defaultArrowLength,\n      arrowCenter.y,\n      arrowCenter.z\n    )\n    ret.rxnArrows.add(\n      new RxnArrow({\n        mode: 'open-angle',\n        pos: [arrowStart, arrowEnd]\n      })\n    )\n  }\n  ret.isReaction = true\n  return ret\n}\n\nfunction rgMerge(scaffold, rgroups) /* Struct */ {\n  /* reader */\n  const ret = new Struct()\n\n  scaffold.mergeInto(ret, null, null, false, true)\n\n  Object.keys(rgroups).forEach(id => {\n    const rgid = parseInt(id, 10)\n\n    for (let j = 0; j < rgroups[rgid].length; ++j) {\n      const ctab = rgroups[rgid][j]\n      ctab.rgroups.set(rgid, new RGroup())\n      const frag = new Fragment()\n      const frid = ctab.frags.add(frag)\n      ctab.rgroups.get(rgid).frags.add(frid)\n      ctab.atoms.forEach(atom => {\n        atom.fragment = frid\n      })\n      ctab.mergeInto(ret)\n    }\n  })\n\n  return ret\n}\n\nexport default {\n  fmtInfo,\n  paddedNum,\n  parseDecimalInt,\n  partitionLine,\n  partitionLineFixed,\n  rxnMerge,\n  rgMerge\n}\n","/****************************************************************************\n * Copyright 2021 EPAM Systems\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *    http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n ***************************************************************************/\n\nimport { Pool, SGroup, Vec2 } from 'domain/entities'\n\nimport utils from './utils'\n\n/**\n * @param str { string }\n * @param valueString { boolean }\n * @returns { Pool }\n */\nfunction readKeyValuePairs(str, valueString) {\n  const ret = new Pool()\n  const partition = utils.partitionLineFixed(str, 3, true)\n  const count = utils.parseDecimalInt(partition[0])\n\n  for (let i = 0; i < count; ++i) {\n    const key = utils.parseDecimalInt(partition[2 * i + 1]) - 1\n    const value = valueString\n      ? partition[2 * i + 2].trim()\n      : utils.parseDecimalInt(partition[2 * i + 2])\n\n    ret.set(key, value)\n  }\n\n  return ret\n}\n\n/**\n * @param str { string }\n * @param valueString { boolean }\n * @returns { Array }\n */\nfunction readKeyMultiValuePairs(str, valueString) {\n  /* reader */\n  var ret = []\n  var partition = utils.partitionLineFixed(str, 3, true)\n  var count = utils.parseDecimalInt(partition[0])\n  for (var i = 0; i < count; ++i) {\n    ret.push([\n      /* eslint-disable no-mixed-operators*/\n      utils.parseDecimalInt(partition[2 * i + 1]) - 1,\n      valueString\n        ? partition[2 * i + 2].trim()\n        : utils.parseDecimalInt(partition[2 * i + 2])\n      /* eslint-enable no-mixed-operators*/\n    ])\n  }\n  return ret\n}\n\nfunction postLoadMul(sgroup, mol, atomMap) {\n  // eslint-disable-line max-statements\n  sgroup.data.mul = sgroup.data.subscript - 0\n  var atomReductionMap = {}\n\n  sgroup.atoms = SGroup.filterAtoms(sgroup.atoms, atomMap)\n  sgroup.patoms = SGroup.filterAtoms(sgroup.patoms, atomMap)\n\n  // mark repetitions for removal\n  for (var k = 1; k < sgroup.data.mul; ++k) {\n    for (var m = 0; m < sgroup.patoms.length; ++m) {\n      var raid = sgroup.atoms[k * sgroup.patoms.length + m] // eslint-disable-line no-mixed-operators\n      if (raid < 0) continue // eslint-disable-line no-continue\n      if (sgroup.patoms[m] < 0) throw new Error('parent atom missing')\n      atomReductionMap[raid] = sgroup.patoms[m] // \"merge\" atom in parent\n    }\n  }\n  sgroup.patoms = SGroup.removeNegative(sgroup.patoms)\n\n  var patomsMap = identityMap(sgroup.patoms)\n\n  var bondsToRemove = []\n  mol.bonds.forEach((bond, bid) => {\n    var beginIn = bond.begin in atomReductionMap\n    var endIn = bond.end in atomReductionMap\n    // if both adjacent atoms of a bond are to be merged, remove it\n    /* eslint-disable no-mixed-operators*/\n    if (\n      (beginIn && endIn) ||\n      (beginIn && bond.end in patomsMap) ||\n      (endIn && bond.begin in patomsMap)\n    )\n      bondsToRemove.push(bid)\n    /* eslint-enable no-mixed-operators*/\n    // if just one atom is merged, modify the bond accordingly\n    else if (beginIn) bond.begin = atomReductionMap[bond.begin]\n    else if (endIn) bond.end = atomReductionMap[bond.end]\n  }, sgroup)\n\n  // apply removal lists\n  for (var b = 0; b < bondsToRemove.length; ++b)\n    mol.bonds.delete(bondsToRemove[b])\n  for (var a in atomReductionMap) {\n    mol.atoms.delete(+a)\n    atomMap[a] = -1\n  }\n  sgroup.atoms = sgroup.patoms\n  sgroup.patoms = null\n}\n\nfunction postLoadSru(sgroup) {\n  sgroup.data.connectivity = (sgroup.data.connectivity || 'EU')\n    .trim()\n    .toLowerCase()\n}\n\nfunction postLoadSup(sgroup) {\n  sgroup.data.name = (sgroup.data.subscript || '').trim()\n  sgroup.data.subscript = ''\n}\n\nfunction postLoadGen(sgroup, mol, atomMap) {\n  // eslint-disable-line no-unused-vars\n}\n\nfunction postLoadDat(sgroup, mol) {\n  if (!sgroup.data.absolute)\n    sgroup.pp = sgroup.pp.add(SGroup.getMassCentre(mol, sgroup.atoms))\n}\n\nfunction postLoadMon(sgroup) {\n  // TODO: Implement after adding MON type support\n}\n\nfunction postLoadMer(sgroup) {\n  // TODO: Implement after adding MER type support\n}\n\nfunction postLoadCop(sgroup) {\n  // TODO: Implement after adding COP type support\n}\n\nfunction postLoadCro(sgroup) {\n  // TODO: Implement after adding CRO type support\n}\n\nfunction postLoadMod(sgroup) {\n  // TODO: Implement after adding MOD type support\n}\n\nfunction postLoadGra(sgroup) {\n  // TODO: Implement after adding GRA type support\n}\n\nfunction postLoadCom(sgroup) {\n  // TODO: Implement after adding COM type support\n}\n\nfunction postLoadMix(sgroup) {\n  // TODO: Implement after adding MIX type support\n}\n\nfunction postLoadFor(sgroup) {\n  // TODO: Implement after adding FOR type support\n}\n\nfunction postLoadAny(sgroup) {\n  // TODO: Implement after adding ANY type support\n}\n\nfunction loadSGroup(mol, sg, atomMap) {\n  const postLoadMap = {\n    SUP: postLoadSup,\n    MUL: postLoadMul,\n    SRU: postLoadSru,\n    MON: postLoadMon,\n    MER: postLoadMer,\n    COP: postLoadCop,\n    CRO: postLoadCro,\n    MOD: postLoadMod,\n    GRA: postLoadGra,\n    COM: postLoadCom,\n    MIX: postLoadMix,\n    FOR: postLoadFor,\n    DAT: postLoadDat,\n    ANY: postLoadAny,\n    GEN: postLoadGen\n  }\n\n  // add the group to the molecule\n  sg.id = mol.sgroups.add(sg)\n\n  // apply type-specific post-processing\n  postLoadMap[sg.type](sg, mol, atomMap)\n  // mark atoms in the group as belonging to it\n  for (let s = 0; s < sg.atoms.length; ++s) {\n    if (mol.atoms.has(sg.atoms[s])) mol.atoms.get(sg.atoms[s]).sgs.add(sg.id)\n  }\n\n  if (sg.type === 'DAT') mol.sGroupForest.insert(sg, -1, [])\n  else mol.sGroupForest.insert(sg)\n\n  return sg.id\n}\n\nfunction initSGroup(sGroups, propData) {\n  /* reader */\n  const kv = readKeyValuePairs(propData, true)\n  for (const [key, type] of kv) {\n    const sg = new SGroup(type)\n    sg.number = key\n    sGroups[key] = sg\n  }\n}\n\nfunction applySGroupProp(sGroups, propName, propData, numeric, core) {\n  // eslint-disable-line max-params\n  const kv = readKeyValuePairs(propData, !numeric)\n  // \"core\" properties are stored directly in an sgroup, not in sgroup.data\n  for (const key of kv.keys())\n    (core ? sGroups[key] : sGroups[key].data)[propName] = kv.get(key)\n}\n\nfunction applySGroupArrayProp(sGroups, propName, propData, shift) {\n  /* reader */\n  const sid = utils.parseDecimalInt(propData.slice(1, 4)) - 1\n  const num = utils.parseDecimalInt(propData.slice(4, 8))\n  let part = toIntArray(utils.partitionLineFixed(propData.slice(8), 3, true))\n\n  if (part.length !== num) throw new Error('File format invalid')\n  if (shift) part = part.map(v => v + shift)\n\n  sGroups[sid][propName] = sGroups[sid][propName].concat(part)\n}\n\nfunction applyDataSGroupName(sg, name) {\n  /* reader */\n  sg.data.fieldName = name\n}\n\nfunction applyDataSGroupExpand(sg, expanded) {\n  sg.data.expanded = expanded\n}\n\nfunction applyDataSGroupQuery(sg, query) {\n  /* reader */\n  sg.data.query = query\n}\n\nfunction applyDataSGroupQueryOp(sg, queryOp) {\n  /* reader */\n  sg.data.queryOp = queryOp\n}\n\nfunction applyDataSGroupDesc(sGroups, propData) {\n  /* reader */\n  var split = utils.partitionLine(propData, [4, 31, 2, 20, 2, 3], false)\n  var id = utils.parseDecimalInt(split[0]) - 1\n  var fieldName = split[1].trim()\n  var fieldType = split[2].trim()\n  var units = split[3].trim()\n  var query = split[4].trim()\n  var queryOp = split[5].trim()\n  var sGroup = sGroups[id]\n  sGroup.data.fieldType = fieldType\n  sGroup.data.fieldName = fieldName\n  sGroup.data.units = units\n  sGroup.data.query = query\n  sGroup.data.queryOp = queryOp\n}\n\nfunction applyDataSGroupInfo(sg, propData) {\n  // eslint-disable-line max-statements\n  /* reader */\n  var split = utils.partitionLine(\n    propData,\n    [\n      10 /* x.x*/, 10 /* y.y*/, 4 /* eee*/, 1 /* f*/, 1 /* g*/, 1 /* h*/,\n      3 /* i */, 3 /* jjj*/, 3 /* kkk*/, 3 /* ll*/, 2 /* m*/, 3 /* n*/,\n      2 /* oo*/\n    ],\n    false\n  )\n\n  var x = parseFloat(split[0])\n  var y = parseFloat(split[1])\n  var attached = split[3].trim() == 'A'\n  var absolute = split[4].trim() == 'A'\n  var showUnits = split[5].trim() == 'U'\n  var nCharsToDisplay = split[7].trim()\n  nCharsToDisplay =\n    nCharsToDisplay == 'ALL' ? -1 : utils.parseDecimalInt(nCharsToDisplay)\n  var tagChar = split[10].trim()\n  var daspPos = utils.parseDecimalInt(split[11].trim())\n\n  sg.pp = new Vec2(x, -y)\n  sg.data.attached = attached\n  sg.data.absolute = absolute\n  sg.data.showUnits = showUnits\n  sg.data.nCharsToDisplay = nCharsToDisplay\n  sg.data.tagChar = tagChar\n  sg.data.daspPos = daspPos\n}\n\nfunction applyDataSGroupInfoLine(sGroups, propData) {\n  /* reader */\n  var id = utils.parseDecimalInt(propData.substr(0, 4)) - 1\n  var sg = sGroups[id]\n  applyDataSGroupInfo(sg, propData.substr(5))\n}\n\nfunction applyDataSGroupData(sg, data, finalize) {\n  /* reader */\n  sg.data.fieldValue = (sg.data.fieldValue || '') + data\n  if (finalize) {\n    sg.data.fieldValue = trimRight(sg.data.fieldValue)\n    if (sg.data.fieldValue.startsWith('\"') && sg.data.fieldValue.endsWith('\"'))\n      sg.data.fieldValue = sg.data.fieldValue.substr(\n        1,\n        sg.data.fieldValue.length - 2\n      )\n  }\n}\n\nfunction applyDataSGroupDataLine(sGroups, propData, finalize) {\n  /* reader */\n  var id = utils.parseDecimalInt(propData.substr(0, 5)) - 1\n  var data = propData.substr(5)\n  var sg = sGroups[id]\n  applyDataSGroupData(sg, data, finalize)\n}\n\n// Utilities functions\nfunction toIntArray(strArray) {\n  /* reader */\n  var ret = []\n  for (var j = 0; j < strArray.length; ++j)\n    ret[j] = utils.parseDecimalInt(strArray[j])\n  return ret\n}\n\nfunction trimRight(str) {\n  return str.replace(/\\s+$/, '')\n}\n\nfunction identityMap(array) {\n  var map = {}\n  for (var i = 0; i < array.length; ++i) map[array[i]] = array[i]\n  return map\n}\n\nexport default {\n  readKeyValuePairs,\n  readKeyMultiValuePairs,\n  loadSGroup,\n  initSGroup,\n  applySGroupProp,\n  applySGroupArrayProp,\n  applyDataSGroupName,\n  applyDataSGroupQuery,\n  applyDataSGroupQueryOp,\n  applyDataSGroupDesc,\n  applyDataSGroupInfo,\n  applyDataSGroupData,\n  applyDataSGroupInfoLine,\n  applyDataSGroupDataLine,\n  applyDataSGroupExpand\n}\n","/****************************************************************************\n * Copyright 2021 EPAM Systems\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *    http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n ***************************************************************************/\n\n/* eslint-disable guard-for-in */ // todo\n\nimport {\n  Atom,\n  AtomList,\n  Bond,\n  Pool,\n  RGroup,\n  SGroup,\n  StereoLabel,\n  Struct,\n  Vec2\n} from 'domain/entities'\n\nimport { Elements } from 'domain/constants'\nimport sGroup from './parseSGroup'\nimport utils from './utils'\n\nconst loadRGroupFragments = true // TODO: set to load the fragments\n\nfunction parseAtomLine(atomLine) {\n  /* reader */\n  var atomSplit = utils.partitionLine(atomLine, utils.fmtInfo.atomLinePartition)\n  var params = {\n    // generic\n    pp: new Vec2(\n      parseFloat(atomSplit[0]),\n      -parseFloat(atomSplit[1]),\n      parseFloat(atomSplit[2])\n    ),\n    label: atomSplit[4].trim(),\n    explicitValence:\n      utils.fmtInfo.valenceMap[utils.parseDecimalInt(atomSplit[10])],\n\n    // obsolete\n    massDifference: utils.parseDecimalInt(atomSplit[5]),\n    charge: utils.fmtInfo.chargeMap[utils.parseDecimalInt(atomSplit[6])],\n\n    // query\n    hCount: utils.parseDecimalInt(utils.parseDecimalInt(atomSplit[8])),\n    stereoCare: utils.parseDecimalInt(atomSplit[9]) !== 0,\n\n    // reaction\n    aam: utils.parseDecimalInt(atomSplit[14]),\n    invRet: utils.parseDecimalInt(atomSplit[15]),\n\n    // reaction query\n    exactChangeFlag: utils.parseDecimalInt(atomSplit[16]) !== 0\n  }\n  return new Atom(params)\n}\n\nfunction parseBondLine(bondLine) {\n  /* reader */\n  var bondSplit = utils.partitionLine(bondLine, utils.fmtInfo.bondLinePartition)\n\n  var params = {\n    begin: utils.parseDecimalInt(bondSplit[0]) - 1,\n    end: utils.parseDecimalInt(bondSplit[1]) - 1,\n    type: utils.fmtInfo.bondTypeMap[utils.parseDecimalInt(bondSplit[2])],\n    stereo: utils.fmtInfo.bondStereoMap[utils.parseDecimalInt(bondSplit[3])],\n    xxx: bondSplit[4],\n    topology:\n      utils.fmtInfo.bondTopologyMap[utils.parseDecimalInt(bondSplit[5])],\n    reactingCenterStatus: utils.parseDecimalInt(bondSplit[6])\n  }\n\n  return new Bond(params)\n}\n\nfunction parseAtomListLine(/* string */ atomListLine) {\n  /* reader */\n  var split = utils.partitionLine(\n    atomListLine,\n    utils.fmtInfo.atomListHeaderPartition\n  )\n\n  var number = utils.parseDecimalInt(split[0]) - 1\n  var notList = split[2].trim() === 'T'\n  var count = utils.parseDecimalInt(split[4].trim())\n\n  var ids = atomListLine.slice(utils.fmtInfo.atomListHeaderLength)\n  var list = []\n  var itemLength = utils.fmtInfo.atomListHeaderItemLength\n  for (var i = 0; i < count; ++i)\n    list[i] = utils.parseDecimalInt(\n      ids.slice(i * itemLength, (i + 1) * itemLength - 1)\n    )\n\n  return {\n    aid: number,\n    atomList: new AtomList({\n      notList,\n      ids: list\n    })\n  }\n}\n\n/**\n * @param ctab\n * @param ctabLines\n * @param shift\n * @param end\n * @param sGroups\n * @param rLogic\n * @returns { Pool }\n */\nfunction parsePropertyLines(ctab, ctabLines, shift, end, sGroups, rLogic) {\n  // eslint-disable-line max-statements, max-params\n  /* reader */\n  const props = new Pool()\n\n  while (shift < end) {\n    var line = ctabLines[shift]\n    if (line.charAt(0) === 'A') {\n      var propValue = ctabLines[++shift]\n      //TODO: Atom entity only have pseudo getter. Check during refactoring\n      //this type of pseudo labeling is not used in current BIOVIA products. See ctab documentation 2020\n      // https://discover.3ds.com/sites/default/files/2020-08/biovia_ctfileformats_2020.pdf (page 47)\n      var isPseudo = /'.+'/.test(propValue)\n      if (isPseudo && !props.get('pseudo')) props.set('pseudo', new Pool())\n      if (!isPseudo && !props.get('alias')) props.set('alias', new Pool())\n      if (isPseudo) propValue = propValue.replace(/'/g, '')\n      props\n        .get(isPseudo ? 'pseudo' : 'alias')\n        .set(utils.parseDecimalInt(line.slice(3, 6)) - 1, propValue)\n    } else if (line.charAt(0) === 'M') {\n      var type = line.slice(3, 6)\n      var propertyData = line.slice(6)\n      if (type === 'END') {\n        break\n      } else if (type === 'CHG') {\n        if (!props.get('charge'))\n          props.set('charge', sGroup.readKeyValuePairs(propertyData))\n      } else if (type === 'RAD') {\n        if (!props.get('radical'))\n          props.set('radical', sGroup.readKeyValuePairs(propertyData))\n      } else if (type === 'ISO') {\n        if (!props.get('isotope'))\n          props.set('isotope', sGroup.readKeyValuePairs(propertyData))\n      } else if (type === 'RBC') {\n        if (!props.get('ringBondCount'))\n          props.set('ringBondCount', sGroup.readKeyValuePairs(propertyData))\n      } else if (type === 'SUB') {\n        if (!props.get('substitutionCount'))\n          props.set('substitutionCount', sGroup.readKeyValuePairs(propertyData))\n      } else if (type === 'UNS') {\n        if (!props.get('unsaturatedAtom'))\n          props.set('unsaturatedAtom', sGroup.readKeyValuePairs(propertyData))\n        // else if (type == \"LIN\") // link atom\n      } else if (type === 'RGP') {\n        // rgroup atom\n        if (!props.get('rglabel')) props.set('rglabel', new Pool())\n        var rglabels = props.get('rglabel')\n        var a2rs = sGroup.readKeyMultiValuePairs(propertyData)\n        for (var a2ri = 0; a2ri < a2rs.length; a2ri++) {\n          var a2r = a2rs[a2ri]\n          rglabels.set(\n            a2r[0],\n            (rglabels.get(a2r[0]) || 0) | (1 << (a2r[1] - 1))\n          )\n        }\n      } else if (type === 'LOG') {\n        // rgroup atom\n        propertyData = propertyData.slice(4)\n        var rgid = utils.parseDecimalInt(propertyData.slice(0, 3).trim())\n        var iii = utils.parseDecimalInt(propertyData.slice(4, 7).trim())\n        var hhh = utils.parseDecimalInt(propertyData.slice(8, 11).trim())\n        var ooo = propertyData.slice(12).trim()\n        var logic = {}\n        if (iii > 0) logic.ifthen = iii\n        logic.resth = hhh === 1\n        logic.range = ooo\n        rLogic[rgid] = logic\n      } else if (type === 'APO') {\n        if (!props.get('attpnt'))\n          props.set('attpnt', sGroup.readKeyValuePairs(propertyData))\n      } else if (type === 'ALS') {\n        // atom list\n        const pool = parsePropertyLineAtomList(\n          utils.partitionLine(propertyData, [1, 3, 3, 1, 1, 1]),\n          utils.partitionLineFixed(propertyData.slice(10), 4, false)\n        )\n\n        if (!props.get('atomList')) props.set('atomList', new Pool())\n        if (!props.get('label')) props.set('label', new Pool())\n\n        pool.forEach((atomList, aid) => {\n          props.get('label').set(aid, 'L#')\n          props.get('atomList').set(aid, atomList)\n        })\n      } else if (type === 'STY') {\n        // introduce s-group\n        sGroup.initSGroup(sGroups, propertyData)\n      } else if (type === 'SST') {\n        sGroup.applySGroupProp(sGroups, 'subtype', propertyData)\n      } else if (type === 'SLB') {\n        sGroup.applySGroupProp(sGroups, 'label', propertyData, true)\n      } else if (type === 'SPL') {\n        sGroup.applySGroupProp(sGroups, 'parent', propertyData, true, true)\n      } else if (type === 'SCN') {\n        sGroup.applySGroupProp(sGroups, 'connectivity', propertyData)\n      } else if (type === 'SAL') {\n        sGroup.applySGroupArrayProp(sGroups, 'atoms', propertyData, -1)\n      } else if (type === 'SBL') {\n        sGroup.applySGroupArrayProp(sGroups, 'bonds', propertyData, -1)\n      } else if (type === 'SPA') {\n        sGroup.applySGroupArrayProp(sGroups, 'patoms', propertyData, -1)\n      } else if (type === 'SMT') {\n        var sid = utils.parseDecimalInt(propertyData.slice(0, 4)) - 1\n        sGroups[sid].data.subscript = propertyData.slice(4).trim()\n      } else if (type === 'SDT') {\n        sGroup.applyDataSGroupDesc(sGroups, propertyData)\n      } else if (type === 'SDD') {\n        sGroup.applyDataSGroupInfoLine(sGroups, propertyData)\n      } else if (type === 'SCD') {\n        sGroup.applyDataSGroupDataLine(sGroups, propertyData, false)\n      } else if (type === 'SED') {\n        sGroup.applyDataSGroupDataLine(sGroups, propertyData, true)\n      } else if (type === 'SDS') {\n        const expandedSGroups = propertyData.slice(7).trim().split('   ')\n        expandedSGroups.forEach(eg => {\n          const sGroupId = Number(eg) - 1\n          sGroups[sGroupId].data.expanded = true\n        })\n      }\n    }\n    ++shift\n  }\n  return props\n}\n\n/**\n * @param atoms { Pool }\n * @param values { Pool }\n * @param propId { string }\n */\nfunction applyAtomProp(atoms, values, propId) {\n  /* reader */\n  values.forEach((propVal, aid) => {\n    atoms.get(aid)[propId] = propVal\n  })\n}\n\nfunction parseCTabV2000(ctabLines, countsSplit) {\n  // eslint-disable-line max-statements\n  /* reader */\n  const ctab = new Struct()\n  let i\n  const atomCount = utils.parseDecimalInt(countsSplit[0])\n  const bondCount = utils.parseDecimalInt(countsSplit[1])\n  const atomListCount = utils.parseDecimalInt(countsSplit[2])\n  const isAbs = utils.parseDecimalInt(countsSplit[4]) === 1\n  const isAnd = utils.parseDecimalInt(countsSplit[4]) === 0\n  const stextLinesCount = utils.parseDecimalInt(countsSplit[5])\n  const propertyLinesCount = utils.parseDecimalInt(countsSplit[10])\n  let shift = 0\n  const atomLines = ctabLines.slice(shift, shift + atomCount)\n  shift += atomCount\n  const bondLines = ctabLines.slice(shift, shift + bondCount)\n  shift += bondCount\n  const atomListLines = ctabLines.slice(shift, shift + atomListCount)\n  shift += atomListCount + stextLinesCount\n\n  const atoms = atomLines.map(parseAtomLine)\n  atoms.forEach(atom => ctab.atoms.add(atom))\n\n  const bonds = bondLines.map(parseBondLine)\n  bonds.forEach(bond => {\n    if (bond.stereo && isAbs)\n      ctab.atoms.get(bond.begin).stereoLabel = StereoLabel.Abs\n    if (bond.stereo && isAnd)\n      ctab.atoms.get(bond.begin).stereoLabel = `${StereoLabel.And}1`\n    ctab.bonds.add(bond)\n  })\n\n  const atomLists = atomListLines.map(parseAtomListLine)\n  atomLists.forEach(pair => {\n    ctab.atoms.get(pair.aid).atomList = pair.atomList\n    ctab.atoms.get(pair.aid).label = 'L#'\n  })\n\n  const sGroups = {}\n  const rLogic = {}\n  const props = parsePropertyLines(\n    ctab,\n    ctabLines,\n    shift,\n    Math.min(ctabLines.length, shift + propertyLinesCount),\n    sGroups,\n    rLogic\n  )\n  props.forEach((values, propId) => {\n    applyAtomProp(ctab.atoms, values, propId)\n  })\n\n  const atomMap = {}\n  let sid\n  for (sid in sGroups) {\n    const sg = sGroups[sid]\n    if (sg.type === 'DAT' && sg.atoms.length === 0) {\n      const parent = sGroups[sid].parent\n      if (parent >= 0) {\n        const psg = sGroups[parent - 1]\n        if (psg.type === 'GEN') sg.atoms = [].slice.call(psg.atoms)\n      }\n    }\n  }\n  for (sid in sGroups) sGroup.loadSGroup(ctab, sGroups[sid], atomMap)\n  const emptyGroups = []\n  for (sid in sGroups) {\n    // TODO: why do we need that?\n    SGroup.filter(ctab, sGroups[sid], atomMap)\n    if (sGroups[sid].atoms.length === 0 && !sGroups[sid].allAtoms)\n      emptyGroups.push(+sid)\n  }\n  for (i = 0; i < emptyGroups.length; ++i) {\n    ctab.sGroupForest.remove(emptyGroups[i])\n    ctab.sgroups.delete(emptyGroups[i])\n  }\n  for (const id in rLogic) {\n    const rgid = parseInt(id, 10)\n    ctab.rgroups.set(rgid, new RGroup(rLogic[rgid]))\n  }\n  return ctab\n}\n\nfunction parseRg2000(/* string[] */ ctabLines) /* Struct */ {\n  // eslint-disable-line max-statements\n  ctabLines = ctabLines.slice(7)\n  if (ctabLines[0].trim() !== '$CTAB') throw new Error('RGFile format invalid')\n  var i = 1\n  while (ctabLines[i].charAt(0) !== '$') i++\n  if (ctabLines[i].trim() !== '$END CTAB')\n    throw new Error('RGFile format invalid')\n  var coreLines = ctabLines.slice(1, i)\n  ctabLines = ctabLines.slice(i + 1)\n  var fragmentLines = {}\n  while (true) {\n    // eslint-disable-line no-constant-condition\n    if (ctabLines.length === 0) throw new Error('Unexpected end of file')\n    var line = ctabLines[0].trim()\n    if (line === '$END MOL') {\n      ctabLines = ctabLines.slice(1)\n      break\n    }\n    if (line !== '$RGP') throw new Error('RGFile format invalid')\n\n    const rgid = parseInt(ctabLines[1].trim(), 10)\n    fragmentLines[rgid] = []\n    ctabLines = ctabLines.slice(2)\n    while (true) {\n      // eslint-disable-line no-constant-condition\n      if (ctabLines.length === 0) throw new Error('Unexpected end of file')\n      line = ctabLines[0].trim()\n      if (line === '$END RGP') {\n        ctabLines = ctabLines.slice(1)\n        break\n      }\n      if (line !== '$CTAB') throw new Error('RGFile format invalid')\n      i = 1\n      while (ctabLines[i].charAt(0) !== '$') i++\n      if (ctabLines[i].trim() !== '$END CTAB')\n        throw new Error('RGFile format invalid')\n      fragmentLines[rgid].push(ctabLines.slice(1, i))\n      ctabLines = ctabLines.slice(i + 1)\n    }\n  }\n\n  var core = parseCTab(coreLines)\n  var frag = {}\n  if (loadRGroupFragments) {\n    for (var strId in fragmentLines) {\n      const id = parseInt(strId, 10)\n      frag[id] = []\n      for (var j = 0; j < fragmentLines[id].length; ++j)\n        frag[id].push(parseCTab(fragmentLines[id][j]))\n    }\n  }\n  return utils.rgMerge(core, frag)\n}\n\nfunction parseRxn2000(\n  /* string[] */ ctabLines,\n  shouldReactionRelayout\n) /* Struct */ {\n  // eslint-disable-line max-statements\n  /* reader */\n  ctabLines = ctabLines.slice(4)\n  var countsSplit = utils.partitionLine(\n    ctabLines[0],\n    utils.fmtInfo.rxnItemsPartition\n  )\n  var nReactants = countsSplit[0] - 0,\n    nProducts = countsSplit[1] - 0,\n    nAgents = countsSplit[2] - 0\n  ctabLines = ctabLines.slice(1) // consume counts line\n  var mols = []\n  while (ctabLines.length > 0 && ctabLines[0].substr(0, 4) === '$MOL') {\n    ctabLines = ctabLines.slice(1)\n    var n = 0\n    while (n < ctabLines.length && ctabLines[n].substr(0, 4) !== '$MOL') n++\n\n    var lines = ctabLines.slice(0, n)\n    var struct\n    if (lines[0].search('\\\\$MDL') === 0) {\n      struct = parseRg2000(lines)\n    } else {\n      struct = parseCTab(lines.slice(3))\n      struct.name = lines[0].trim()\n    }\n    mols.push(struct)\n    ctabLines = ctabLines.slice(n)\n  }\n  return utils.rxnMerge(\n    mols,\n    nReactants,\n    nProducts,\n    nAgents,\n    shouldReactionRelayout\n  )\n}\n\nfunction parseCTab(/* string */ ctabLines) /* Struct */ {\n  /* reader */\n  var countsSplit = utils.partitionLine(\n    ctabLines[0],\n    utils.fmtInfo.countsLinePartition\n  )\n  ctabLines = ctabLines.slice(1)\n  return parseCTabV2000(ctabLines, countsSplit)\n}\n\nfunction labelsListToIds(labels) {\n  /* reader */\n  var ids = []\n  for (var i = 0; i < labels.length; ++i) {\n    const element = Elements.get(labels[i].trim())\n    if (element) {\n      ids.push(element.number)\n    }\n  }\n\n  return ids\n}\n\n/**\n * @param hdr\n * @param lst\n * @returns { Pool }\n */\nfunction parsePropertyLineAtomList(hdr, lst) {\n  /* reader */\n  var aid = utils.parseDecimalInt(hdr[1]) - 1\n  var count = utils.parseDecimalInt(hdr[2])\n  var notList = hdr[4].trim() === 'T'\n  var ids = labelsListToIds(lst.slice(0, count))\n  var ret = new Pool()\n  ret.set(\n    aid,\n    new AtomList({\n      notList,\n      ids\n    })\n  )\n  return ret\n}\n\nexport default {\n  parseCTabV2000,\n  parseRg2000,\n  parseRxn2000\n}\n","/****************************************************************************\n * Copyright 2021 EPAM Systems\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *    http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n ***************************************************************************/\n\nimport {\n  Atom,\n  AtomList,\n  Bond,\n  RGroup,\n  SGroup,\n  Struct,\n  Vec2\n} from 'domain/entities'\n\nimport { Elements } from 'domain/constants'\nimport sGroup from './parseSGroup'\nimport utils from './utils'\n\nfunction parseAtomLineV3000(line) {\n  // eslint-disable-line max-statements\n  /* reader */\n  var split, subsplit, key, value, i\n  split = spacebarsplit(line)\n  var params = {\n    pp: new Vec2(\n      parseFloat(split[2]),\n      -parseFloat(split[3]),\n      parseFloat(split[4])\n    ),\n    aam: split[5].trim()\n  }\n  var label = split[1].trim()\n  if (label.charAt(0) == '\"' && label.charAt(label.length - 1) == '\"')\n    label = label.substr(1, label.length - 2) // strip qutation marks\n  if (label.charAt(label.length - 1) == ']') {\n    // assume atom list\n    label = label.substr(0, label.length - 1) // remove ']'\n    var atomListParams = {}\n    atomListParams.notList = false\n    const matchNotListInfo = label.match(/NOT ?\\[/)\n    if (matchNotListInfo) {\n      atomListParams.notList = true\n      const [matchedSubstr] = matchNotListInfo\n      label = label.substr(matchedSubstr.length) // remove 'NOT [' or 'NOT['\n    } else if (label.charAt(0) != '[') {\n      throw new Error(\"Error: atom list expected, found '\" + label + \"'\")\n    } else {\n      label = label.substr(1) // remove '['\n    }\n    atomListParams.ids = labelsListToIds(label.split(','))\n    params['atomList'] = new AtomList(atomListParams)\n    params['label'] = 'L#'\n  } else {\n    params['label'] = label\n  }\n  split.splice(0, 6)\n  for (i = 0; i < split.length; ++i) {\n    subsplit = splitonce(split[i], '=')\n    key = subsplit[0]\n    value = subsplit[1]\n    if (key in utils.fmtInfo.v30atomPropMap) {\n      var ival = utils.parseDecimalInt(value)\n      if (key == 'VAL') {\n        if (ival == 0) continue // eslint-disable-line no-continue\n        if (ival == -1) ival = 0\n      }\n      params[utils.fmtInfo.v30atomPropMap[key]] = ival\n    } else if (key == 'RGROUPS') {\n      value = value.trim().substr(1, value.length - 2)\n      var rgrsplit = value.split(' ').slice(1)\n      params.rglabel = 0\n      for (var j = 0; j < rgrsplit.length; ++j)\n        params.rglabel |= 1 << (rgrsplit[j] - 1)\n    } else if (key == 'ATTCHPT') {\n      params.attpnt = value.trim() - 0\n    }\n  }\n\n  return new Atom(params)\n}\n\nfunction parseBondLineV3000(line) {\n  /* reader */\n  var split, subsplit, key, value, i\n  split = spacebarsplit(line)\n  var params = {\n    begin: utils.parseDecimalInt(split[2]) - 1,\n    end: utils.parseDecimalInt(split[3]) - 1,\n    type: utils.fmtInfo.bondTypeMap[utils.parseDecimalInt(split[1])]\n  }\n  split.splice(0, 4)\n  for (i = 0; i < split.length; ++i) {\n    subsplit = splitonce(split[i], '=')\n    key = subsplit[0]\n    value = subsplit[1]\n    if (key == 'CFG') {\n      params.stereo =\n        utils.fmtInfo.v30bondStereoMap[utils.parseDecimalInt(value)]\n      if (\n        params.type == Bond.PATTERN.TYPE.DOUBLE &&\n        params.stereo == Bond.PATTERN.STEREO.EITHER\n      )\n        params.stereo = Bond.PATTERN.STEREO.CIS_TRANS\n    } else if (key == 'TOPO') {\n      params.topology =\n        utils.fmtInfo.bondTopologyMap[utils.parseDecimalInt(value)]\n    } else if (key == 'RXCTR') {\n      params.reactingCenterStatus = utils.parseDecimalInt(value)\n    } else if (key == 'STBOX') {\n      params.stereoCare = utils.parseDecimalInt(value)\n    }\n  }\n  return new Bond(params)\n}\n\nfunction v3000parseCollection(ctab, ctabLines, shift) {\n  /* reader */\n  shift++\n  while (ctabLines[shift].trim() != 'M  V30 END COLLECTION') shift++\n  shift++\n  return shift\n}\n\nfunction v3000parseSGroup(ctab, ctabLines, sgroups, atomMap, shift) {\n  // eslint-disable-line max-params, max-statements\n  /* reader */\n  var line = ''\n  shift++\n  while (shift < ctabLines.length) {\n    line = stripV30(ctabLines[shift++]).trim()\n    if (line.trim() == 'END SGROUP') return shift\n    while (line.charAt(line.length - 1) == '-')\n      line = (\n        line.substr(0, line.length - 1) + stripV30(ctabLines[shift++])\n      ).trim()\n    var split = splitSGroupDef(line)\n    var type = split[1]\n    var sg = new SGroup(type)\n    sg.number = split[0] - 0\n    sg.type = type\n    sg.label = split[2] - 0\n    sgroups[sg.number] = sg\n    var props = {}\n    for (var i = 3; i < split.length; ++i) {\n      var subsplit = splitonce(split[i], '=')\n      if (subsplit.length != 2)\n        throw new Error(\n          \"A record of form AAA=BBB or AAA=(...) expected, got '\" +\n            split[i] +\n            \"'\"\n        )\n      var name = subsplit[0]\n      if (!(name in props)) props[name] = []\n      props[name].push(subsplit[1])\n    }\n    sg.atoms = parseBracedNumberList(props['ATOMS'][0], -1)\n    if (props['PATOMS'])\n      sg.patoms = parseBracedNumberList(props['PATOMS'][0], -1)\n    sg.bonds = props['BONDS']\n      ? parseBracedNumberList(props['BONDS'][0], -1)\n      : []\n    var brkxyzStrs = props['BRKXYZ']\n    sg.brkxyz = []\n    if (brkxyzStrs) {\n      for (var j = 0; j < brkxyzStrs.length; ++j)\n        sg.brkxyz.push(parseBracedNumberList(brkxyzStrs[j]))\n    }\n    if (props['MULT']) sg.data.subscript = props['MULT'][0] - 0\n    if (props['LABEL']) sg.data.subscript = props['LABEL'][0].trim()\n    if (props['CONNECT'])\n      sg.data.connectivity = props['CONNECT'][0].toLowerCase()\n    if (props['FIELDDISP'])\n      sGroup.applyDataSGroupInfo(sg, stripQuotes(props['FIELDDISP'][0]))\n    if (props['FIELDDATA'])\n      sGroup.applyDataSGroupData(sg, props['FIELDDATA'][0], true)\n    if (props['FIELDNAME'])\n      sGroup.applyDataSGroupName(sg, props['FIELDNAME'][0])\n    if (props['QUERYTYPE'])\n      sGroup.applyDataSGroupQuery(sg, props['QUERYTYPE'][0])\n    if (props['QUERYOP']) sGroup.applyDataSGroupQueryOp(sg, props['QUERYOP'][0])\n    sGroup.loadSGroup(ctab, sg, atomMap)\n    if (props['ESTATE']) sGroup.applyDataSGroupExpand(sg, props['ESTATE'][0])\n  }\n  throw new Error('S-group declaration incomplete.')\n}\n\nfunction parseCTabV3000(ctabLines, norgroups) {\n  // eslint-disable-line max-statements\n  /* reader */\n  var ctab = new Struct()\n\n  var shift = 0\n  if (ctabLines[shift++].trim() !== 'M  V30 BEGIN CTAB')\n    throw Error('CTAB V3000 invalid')\n  if (ctabLines[shift].slice(0, 13) !== 'M  V30 COUNTS')\n    throw Error('CTAB V3000 invalid')\n  var vals = ctabLines[shift].slice(14).split(' ')\n  const isAbs = utils.parseDecimalInt(vals[4]) === 1\n  shift++\n\n  if (ctabLines[shift].trim() === 'M  V30 BEGIN ATOM') {\n    shift++\n    var line\n    while (shift < ctabLines.length) {\n      line = stripV30(ctabLines[shift++]).trim()\n      if (line === 'END ATOM') break\n      while (line.charAt(line.length - 1) === '-')\n        line = (\n          line.substring(0, line.length - 1) + stripV30(ctabLines[shift++])\n        ).trim()\n      ctab.atoms.add(parseAtomLineV3000(line))\n    }\n\n    if (ctabLines[shift].trim() === 'M  V30 BEGIN BOND') {\n      shift++\n      while (shift < ctabLines.length) {\n        line = stripV30(ctabLines[shift++]).trim()\n        if (line === 'END BOND') break\n        while (line.charAt(line.length - 1) === '-')\n          line = (\n            line.substring(0, line.length - 1) + stripV30(ctabLines[shift++])\n          ).trim()\n        const bond = parseBondLineV3000(line)\n        if (bond.stereo && isAbs) ctab.atoms.get(bond.begin).stereoLabel = 'abs'\n        ctab.bonds.add(bond)\n      }\n    }\n\n    // TODO: let sections follow in arbitrary order\n    var sgroups = {}\n    var atomMap = {}\n\n    while (ctabLines[shift].trim() !== 'M  V30 END CTAB') {\n      if (ctabLines[shift].trim() === 'M  V30 BEGIN COLLECTION')\n        // TODO: read collection information\n        shift = v3000parseCollection(ctab, ctabLines, shift)\n      else if (ctabLines[shift].trim() === 'M  V30 BEGIN SGROUP')\n        shift = v3000parseSGroup(ctab, ctabLines, sgroups, atomMap, shift)\n      else throw Error('CTAB V3000 invalid')\n    }\n  }\n  if (ctabLines[shift++].trim() !== 'M  V30 END CTAB')\n    throw Error('CTAB V3000 invalid')\n\n  if (!norgroups) readRGroups3000(ctab, ctabLines.slice(shift))\n\n  return ctab\n}\n\nfunction readRGroups3000(ctab, /* string */ ctabLines) /* Struct */ {\n  // eslint-disable-line max-statements\n  /* reader */\n  var rfrags = {}\n  var rLogic = {}\n  var shift = 0\n  while (\n    shift < ctabLines.length &&\n    ctabLines[shift].search('M  V30 BEGIN RGROUP') === 0\n  ) {\n    var id = ctabLines[shift++].split(' ').pop()\n    rfrags[id] = []\n    rLogic[id] = {}\n    while (true) {\n      // eslint-disable-line no-constant-condition\n      var line = ctabLines[shift].trim()\n      if (line.search('M  V30 RLOGIC') === 0) {\n        line = line.slice(13)\n        var rlsplit = line.trim().split(/\\s+/g)\n        var iii = utils.parseDecimalInt(rlsplit[0])\n        var hhh = utils.parseDecimalInt(rlsplit[1])\n        var ooo = rlsplit.slice(2).join(' ')\n        var logic = {}\n        if (iii > 0) logic.ifthen = iii\n        logic.resth = hhh == 1\n        logic.range = ooo\n        rLogic[id] = logic\n        shift++\n        continue // eslint-disable-line no-continue\n      }\n      if (line != 'M  V30 BEGIN CTAB') throw Error('CTAB V3000 invalid')\n      for (var i = 0; i < ctabLines.length; ++i) {\n        if (ctabLines[shift + i].trim() == 'M  V30 END CTAB') break\n      }\n      var lines = ctabLines.slice(shift, shift + i + 1)\n      var rfrag = parseCTabV3000(lines, true)\n      rfrags[id].push(rfrag)\n      shift = shift + i + 1\n      if (ctabLines[shift].trim() == 'M  V30 END RGROUP') {\n        shift++\n        break\n      }\n    }\n  }\n\n  Object.keys(rfrags).forEach(rgid => {\n    rfrags[rgid].forEach(rg => {\n      rg.rgroups.set(rgid, new RGroup(rLogic[rgid]))\n      const frid = rg.frags.add({})\n      rg.rgroups.get(rgid).frags.add(frid)\n      rg.atoms.forEach(atom => {\n        atom.fragment = frid\n      })\n      rg.mergeInto(ctab)\n    })\n  })\n}\n\nfunction parseRxn3000(\n  /* string[] */ ctabLines,\n  shouldReactionRelayout\n) /* Struct */ {\n  // eslint-disable-line max-statements\n  /* reader */\n  ctabLines = ctabLines.slice(4)\n  var countsSplit = ctabLines[0].split(/\\s+/g).slice(3)\n  var nReactants = countsSplit[0] - 0,\n    nProducts = countsSplit[1] - 0,\n    nAgents = countsSplit.length > 2 ? countsSplit[2] - 0 : 0\n\n  function findCtabEnd(i) {\n    for (var j = i; j < ctabLines.length; ++j) {\n      if (ctabLines[j].trim() == 'M  V30 END CTAB') return j\n    }\n\n    return console.error('CTab format invalid')\n  }\n\n  function findRGroupEnd(i) {\n    for (var j = i; j < ctabLines.length; ++j) {\n      if (ctabLines[j].trim() == 'M  V30 END RGROUP') return j\n    }\n    return console.error('CTab format invalid')\n  }\n\n  var molLinesReactants = []\n  var molLinesProducts = []\n  var current = null\n  var rGroups = []\n  for (var i = 0; i < ctabLines.length; ++i) {\n    var line = ctabLines[i].trim()\n    var j\n\n    if (line.startsWith('M  V30 COUNTS')) {\n      // do nothing\n    } else if (line === 'M  END') {\n      break // stop reading\n    } else if (line === 'M  V30 BEGIN PRODUCT') {\n      current = molLinesProducts\n    } else if (line === 'M  V30 END PRODUCT') {\n      current = null\n    } else if (line === 'M  V30 BEGIN REACTANT') {\n      current = molLinesReactants\n    } else if (line === 'M  V30 END REACTANT') {\n      current = null\n    } else if (line.startsWith('M  V30 BEGIN RGROUP')) {\n      j = findRGroupEnd(i)\n      rGroups.push(ctabLines.slice(i, j + 1))\n      i = j\n    } else if (line === 'M  V30 BEGIN CTAB') {\n      j = findCtabEnd(i)\n      current.push(ctabLines.slice(i, j + 1))\n      i = j\n    } else {\n      throw new Error('line unrecognized: ' + line)\n    }\n  }\n  var mols = []\n  var molLines = molLinesReactants.concat(molLinesProducts)\n  for (j = 0; j < molLines.length; ++j) {\n    var mol = parseCTabV3000(molLines[j], countsSplit)\n    mols.push(mol)\n  }\n  var ctab = utils.rxnMerge(\n    mols,\n    nReactants,\n    nProducts,\n    nAgents,\n    shouldReactionRelayout\n  )\n\n  readRGroups3000(\n    ctab,\n    (function (array) {\n      var res = []\n      for (var k = 0; k < array.length; ++k) res = res.concat(array[k])\n      return res\n    })(rGroups)\n  )\n\n  return ctab\n}\n\n// split a line by spaces outside parentheses\nfunction spacebarsplit(line) {\n  // eslint-disable-line max-statements\n  /* reader */\n  const split = []\n  let bracketEquality = 0\n  let currentIndex = 0\n  let firstSliceIndex = -1\n  let quoted = false\n\n  for (currentIndex; currentIndex < line.length; currentIndex += 1) {\n    const currentSymbol = line[currentIndex]\n    if (line.substr(currentIndex, 3) === 'NOT') {\n      const closingBracketIndex = line.indexOf(']')\n      split.push(line.slice(currentIndex, closingBracketIndex + 1))\n      currentIndex = closingBracketIndex + 1\n      firstSliceIndex = currentIndex\n    } else if (currentSymbol === '(') bracketEquality += 1\n    else if (currentSymbol === ')') bracketEquality -= 1\n    else if (currentSymbol === '\"') quoted = !quoted\n    else if (!quoted && line[currentIndex] === ' ' && bracketEquality === 0) {\n      if (currentIndex > firstSliceIndex + 1)\n        split.push(line.slice(firstSliceIndex + 1, currentIndex))\n      firstSliceIndex = currentIndex\n    }\n  }\n  if (currentIndex > firstSliceIndex + 1)\n    split.push(line.slice(firstSliceIndex + 1, currentIndex))\n  return split\n}\n\n// utils\nfunction stripQuotes(str) {\n  if (str[0] === '\"' && str[str.length - 1] === '\"')\n    return str.substr(1, str.length - 2)\n  return str\n}\n\nfunction splitonce(line, delim) {\n  /* reader */\n  var p = line.indexOf(delim)\n  return [line.slice(0, p), line.slice(p + 1)]\n}\n\nfunction splitSGroupDef(line) {\n  // eslint-disable-line max-statements\n  /* reader */\n  var split = []\n  var braceBalance = 0\n  var quoted = false\n  for (var i = 0; i < line.length; ++i) {\n    var c = line.charAt(i)\n    if (c == '\"') {\n      quoted = !quoted\n    } else if (!quoted) {\n      if (c == '(') {\n        braceBalance++\n      } else if (c == ')') {\n        braceBalance--\n      } else if (c == ' ' && braceBalance == 0) {\n        split.push(line.slice(0, i))\n        line = line.slice(i + 1).trim()\n        i = 0\n      }\n    }\n  }\n  if (braceBalance != 0)\n    throw new Error('Brace balance broken. S-group properies invalid!')\n  if (line.length > 0) split.push(line.trim())\n  return split\n}\n\nfunction parseBracedNumberList(line, shift) {\n  /* reader */\n  if (!line) return null\n  var list = []\n  line = line.trim()\n  line = line.substr(1, line.length - 2)\n  var split = line.split(' ')\n  shift = shift || 0\n\n  for (var i = 1; i < split.length; ++i) {\n    var value = parseInt(split[i])\n    if (!isNaN(value))\n      // eslint-disable-line\n      list.push(value + shift)\n  }\n\n  return list\n}\n\nfunction stripV30(line) {\n  /* reader */\n  if (line.slice(0, 7) != 'M  V30 ') throw new Error('Prefix invalid')\n  return line.slice(7)\n}\n\nfunction labelsListToIds(labels) {\n  /* reader */\n  var ids = []\n  for (var i = 0; i < labels.length; ++i) {\n    const element = Elements.get(labels[i].trim())\n    if (element) {\n      ids.push(element.number)\n    }\n  }\n\n  return ids\n}\n\nexport default {\n  parseCTabV3000,\n  readRGroups3000,\n  parseRxn3000\n}\n","/****************************************************************************\n * Copyright 2021 EPAM Systems\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *    http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n ***************************************************************************/\n\nimport { Pile, SGroup } from 'domain/entities'\n\nimport utils from './utils'\nimport v2000 from './v2000'\nimport v3000 from './v3000'\n\nconst loadRGroupFragments = true // TODO: set to load the fragments\n\n/* Parse Mol */\nfunction parseMol(/* string */ ctabLines) /* Struct */ {\n  /* reader */\n  if (ctabLines[0].search('\\\\$MDL') === 0) {\n    const struct = v2000.parseRg2000(ctabLines)\n    struct.name = ctabLines[3].trim()\n    return struct\n  }\n  const struct = parseCTab(ctabLines.slice(3))\n  struct.name = ctabLines[0].trim()\n  return struct\n}\n\nfunction parseCTab(/* string */ ctabLines) /* Struct */ {\n  /* reader */\n  const countsSplit = partitionLine(\n    ctabLines[0],\n    utils.fmtInfo.countsLinePartition\n  )\n  const version = countsSplit[11].trim()\n  ctabLines = ctabLines.slice(1)\n  if (version === 'V2000') return v2000.parseCTabV2000(ctabLines, countsSplit)\n  else if (version === 'V3000')\n    return v3000.parseCTabV3000(ctabLines, !loadRGroupFragments)\n  else throw new Error('Molfile version unknown: ' + version) // eslint-disable-line no-else-return\n}\n\n/* Parse Rxn */\nfunction parseRxn(\n  /* string[] */ ctabLines,\n  shouldReactionRelayout\n) /* Struct */ {\n  /* reader */\n  const split = ctabLines[0].trim().split(' ')\n  if (split.length > 1 && split[1] === 'V3000')\n    return v3000.parseRxn3000(ctabLines, shouldReactionRelayout)\n\n  const struct = v2000.parseRxn2000(ctabLines, shouldReactionRelayout)\n  struct.name = ctabLines[1].trim()\n  return struct\n}\n\n/* Prepare For Saving */\nconst prepareForSaving = {\n  MUL: SGroup.prepareMulForSaving,\n  SRU: prepareSruForSaving,\n  SUP: prepareSupForSaving,\n  DAT: prepareDatForSaving,\n  GEN: prepareGenForSaving\n}\n\nfunction prepareSruForSaving(sgroup, mol) {\n  const xBonds = []\n  mol.bonds.forEach((bond, bid) => {\n    const a1 = mol.atoms.get(bond.begin)\n    const a2 = mol.atoms.get(bond.end)\n    /* eslint-disable no-mixed-operators*/\n    if (\n      (a1.sgs.has(sgroup.id) && !a2.sgs.has(sgroup.id)) ||\n      (a2.sgs.has(sgroup.id) && !a1.sgs.has(sgroup.id))\n    )\n      /* eslint-enable no-mixed-operators*/\n      xBonds.push(bid)\n  }, sgroup)\n  if (xBonds.length !== 0 && xBonds.length !== 2) {\n    throw {\n      // eslint-disable-line no-throw-literal\n      id: sgroup.id,\n      'error-type': 'cross-bond-number',\n      message: 'Unsupported cross-bonds number'\n    }\n  }\n  sgroup.bonds = xBonds\n}\n\nfunction prepareSupForSaving(sgroup, mol) {\n  // This code is also used for GroupSru and should be moved into a separate common method\n  // It seems that such code should be used for any sgroup by this this should be checked\n  const xBonds = []\n  mol.bonds.forEach((bond, bid) => {\n    const a1 = mol.atoms.get(bond.begin)\n    const a2 = mol.atoms.get(bond.end)\n    /* eslint-disable no-mixed-operators*/\n    if (\n      (a1.sgs.has(sgroup.id) && !a2.sgs.has(sgroup.id)) ||\n      (a2.sgs.has(sgroup.id) && !a1.sgs.has(sgroup.id))\n    )\n      /* eslint-enable no-mixed-operators*/\n      xBonds.push(bid)\n  }, sgroup)\n  sgroup.bonds = xBonds\n}\n\nfunction prepareGenForSaving(sgroup, mol) {\n  // eslint-disable-line no-unused-vars\n}\n\nfunction prepareDatForSaving(sgroup, mol) {\n  sgroup.atoms = SGroup.getAtoms(mol, sgroup)\n}\n\n/* Save To Molfile */\nconst saveToMolfile = {\n  MUL: saveMulToMolfile,\n  SRU: saveSruToMolfile,\n  SUP: saveSupToMolfile,\n  DAT: saveDatToMolfile,\n  GEN: saveGenToMolfile\n}\n\nfunction saveMulToMolfile(sgroup, mol, sgMap, atomMap, bondMap) {\n  // eslint-disable-line max-params\n  const idstr = (sgMap[sgroup.id] + '').padStart(3)\n\n  let lines = []\n  lines = lines.concat(\n    makeAtomBondLines(\n      'SAL',\n      idstr,\n      Array.from(sgroup.atomSet.values()),\n      atomMap\n    )\n  ) // TODO: check atomSet\n  lines = lines.concat(\n    makeAtomBondLines(\n      'SPA',\n      idstr,\n      Array.from(sgroup.parentAtomSet.values()),\n      atomMap\n    )\n  )\n  lines = lines.concat(makeAtomBondLines('SBL', idstr, sgroup.bonds, bondMap))\n  const smtLine = 'M  SMT ' + idstr + ' ' + sgroup.data.mul\n  lines.push(smtLine)\n  lines = lines.concat(bracketsToMolfile(mol, sgroup, idstr))\n  return lines.join('\\n')\n}\n\nfunction saveSruToMolfile(sgroup, mol, sgMap, atomMap, bondMap) {\n  // eslint-disable-line max-params\n  const idstr = (sgMap[sgroup.id] + '').padStart(3)\n\n  let lines = []\n  lines = lines.concat(makeAtomBondLines('SAL', idstr, sgroup.atoms, atomMap))\n  lines = lines.concat(makeAtomBondLines('SBL', idstr, sgroup.bonds, bondMap))\n  lines = lines.concat(bracketsToMolfile(mol, sgroup, idstr))\n  return lines.join('\\n')\n}\n\nfunction saveSupToMolfile(sgroup, mol, sgMap, atomMap, bondMap) {\n  // eslint-disable-line max-params\n  const idstr = (sgMap[sgroup.id] + '').padStart(3)\n\n  let lines = []\n  lines = lines.concat(makeAtomBondLines('SAL', idstr, sgroup.atoms, atomMap))\n  lines = lines.concat(makeAtomBondLines('SBL', idstr, sgroup.bonds, bondMap))\n  if (sgroup.data.name && sgroup.data.name !== '')\n    lines.push('M  SMT ' + idstr + ' ' + sgroup.data.name)\n  return lines.join('\\n')\n}\n\nfunction saveDatToMolfile(sgroup, mol, sgMap, atomMap) {\n  const idstr = (sgMap[sgroup.id] + '').padStart(3)\n\n  const data = sgroup.data\n  let pp = sgroup.pp\n  if (!data.absolute) pp = pp.sub(SGroup.getMassCentre(mol, sgroup.atoms))\n  let lines = []\n  lines = lines.concat(makeAtomBondLines('SAL', idstr, sgroup.atoms, atomMap))\n  let sdtLine =\n    'M  SDT ' +\n    idstr +\n    ' ' +\n    (data.fieldName || '').padEnd(30) +\n    (data.fieldType || '').padStart(2) +\n    (data.units || '').padEnd(20) +\n    (data.query || '').padStart(2)\n\n  if (data.queryOp)\n    // see gitlab #184\n    sdtLine += data.queryOp.padEnd(80 - 65)\n\n  lines.push(sdtLine)\n  const sddLine =\n    'M  SDD ' +\n    idstr +\n    ' ' +\n    utils.paddedNum(pp.x, 10, 4) +\n    utils.paddedNum(-pp.y, 10, 4) +\n    '    ' + // ' eee'\n    (data.attached ? 'A' : 'D') + // f\n    (data.absolute ? 'A' : 'R') + // g\n    (data.showUnits ? 'U' : ' ') + // h\n    '   ' + //  i\n    (data.nCharnCharsToDisplay >= 0\n      ? utils.paddedNum(data.nCharnCharsToDisplay, 3)\n      : 'ALL') + // jjj\n    '  1   ' + // 'kkk ll '\n    (data.tagChar || ' ') + // m\n    '  ' +\n    utils.paddedNum(data.daspPos, 1) + // n\n    '  ' // oo\n  lines.push(sddLine)\n  const val = normalizeNewlines(data.fieldValue).replace(/\\n*$/, '')\n  const charsPerLine = 69\n  val.split('\\n').forEach(chars => {\n    while (chars.length > charsPerLine) {\n      lines.push('M  SCD ' + idstr + ' ' + chars.slice(0, charsPerLine))\n      chars = chars.slice(charsPerLine)\n    }\n    lines.push('M  SED ' + idstr + ' ' + chars)\n  })\n  return lines.join('\\n')\n}\n\nfunction saveGenToMolfile(sgroup, mol, sgMap, atomMap, bondMap) {\n  // eslint-disable-line max-params\n  const idstr = (sgMap[sgroup.id] + '').padStart(3)\n\n  let lines = []\n  lines = lines.concat(makeAtomBondLines('SAL', idstr, sgroup.atoms, atomMap))\n  lines = lines.concat(makeAtomBondLines('SBL', idstr, sgroup.bonds, bondMap))\n  lines = lines.concat(bracketsToMolfile(mol, sgroup, idstr))\n  return lines.join('\\n')\n}\n\nfunction makeAtomBondLines(prefix, idstr, ids, map) {\n  if (!ids) return []\n  const lines = []\n  for (let i = 0; i < Math.floor((ids.length + 14) / 15); ++i) {\n    const rem = Math.min(ids.length - 15 * i, 15) // eslint-disable-line no-mixed-operators\n    let salLine = 'M  ' + prefix + ' ' + idstr + ' ' + utils.paddedNum(rem, 2)\n    for (let j = 0; j < rem; ++j)\n      salLine += ' ' + utils.paddedNum(map[ids[i * 15 + j]], 3) // eslint-disable-line no-mixed-operators\n    lines.push(salLine)\n  }\n  return lines\n}\n\nfunction bracketsToMolfile(mol, sg, idstr) {\n  // eslint-disable-line max-statements\n  const atomSet = new Pile(sg.atoms)\n  const crossBonds = SGroup.getCrossBonds(mol, atomSet)\n  SGroup.bracketPos(sg, mol, crossBonds)\n  const bb = sg.bracketBox\n  const d = sg.bracketDir\n  const n = d.rotateSC(1, 0)\n  const brackets = SGroup.getBracketParameters(\n    mol,\n    crossBonds,\n    atomSet,\n    bb,\n    d,\n    n\n  )\n  const lines = []\n  for (let i = 0; i < brackets.length; ++i) {\n    const bracket = brackets[i]\n    const a0 = bracket.c.addScaled(bracket.n, -0.5 * bracket.h).yComplement()\n    const a1 = bracket.c.addScaled(bracket.n, 0.5 * bracket.h).yComplement()\n    let line = 'M  SDI ' + idstr + utils.paddedNum(4, 3)\n    const coord = [a0.x, a0.y, a1.x, a1.y]\n    for (let j = 0; j < coord.length; ++j)\n      line += utils.paddedNum(coord[j], 10, 4)\n    lines.push(line)\n  }\n  return lines\n}\n\n// According Unicode Consortium sould be\n// nlRe = /\\r\\n|[\\n\\v\\f\\r\\x85\\u2028\\u2029]/g;\n// http://www.unicode.org/reports/tr18/#Line_Boundaries\nconst nlRe = /\\r\\n|[\\n\\r]/g\nfunction normalizeNewlines(str) {\n  return str.replace(nlRe, '\\n')\n}\n\nfunction partitionLine(\n  /* string*/ str,\n  /* array of int*/ parts,\n  /* bool*/ withspace\n) {\n  /* reader */\n  const res = []\n  for (let i = 0, shift = 0; i < parts.length; ++i) {\n    res.push(str.slice(shift, shift + parts[i]))\n    if (withspace) shift++\n    shift += parts[i]\n  }\n  return res\n}\n\nexport default {\n  parseCTab,\n  parseMol,\n  parseRxn,\n  prepareForSaving,\n  saveToMolfile\n}\n","/****************************************************************************\n * Copyright 2021 EPAM Systems\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *    http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n ***************************************************************************/\n\nimport { StereoFlag, Struct } from 'domain/entities'\n\nimport { Elements } from 'domain/constants'\nimport common from './common'\nimport utils from './utils'\n\nconst END_V2000 = '2D 1   1.00000     0.00000     0'\n\ntype Mapping = {\n  [key in number]: number\n}\ntype NumberTuple = [number, number]\n\nexport class Molfile {\n  molecule: Struct\n  molfile: string | null\n  reaction: boolean\n  mapping: Mapping\n  bondMapping: Mapping\n\n  constructor() {\n    // @ts-ignore\n    this.molecule = null\n    this.molfile = null\n\n    this.reaction = false\n    this.mapping = {}\n    this.bondMapping = {}\n  }\n\n  parseCTFile(molfileLines: string[], shouldReactionRelayout?: boolean) {\n    let ret\n    if (molfileLines[0].search('\\\\$RXN') === 0) {\n      ret = common.parseRxn(molfileLines, shouldReactionRelayout)\n    } else {\n      ret = common.parseMol(molfileLines)\n    }\n    ret.initHalfBonds()\n    ret.initNeighbors()\n    ret.bindSGroupsToFunctionalGroups()\n\n    return ret\n  }\n\n  prepareSGroups(skipErrors: boolean, preserveIndigoDesc?: boolean) {\n    let mol = this.molecule\n    let toRemove: any[] = []\n    let errors = 0\n\n    this.molecule.sGroupForest\n      .getSGroupsBFS()\n      .reverse()\n      .forEach(id => {\n        let sgroup = mol.sgroups.get(id)!\n        let errorIgnore = false\n\n        try {\n          common.prepareForSaving[sgroup.type](sgroup, mol)\n        } catch (ex: any) {\n          if (!skipErrors || typeof ex.id != 'number') {\n            throw new Error(`Error: ${ex.message}`)\n          }\n          errorIgnore = true\n        }\n        /* eslint-disable no-mixed-operators*/\n        if (\n          errorIgnore ||\n          (!preserveIndigoDesc &&\n            /^INDIGO_.+_DESC$/i.test(sgroup.data.fieldName))\n        ) {\n          /* eslint-enable no-mixed-operators*/\n          // @ts-ignore\n          errors += errorIgnore\n          toRemove.push(sgroup.id)\n        }\n      }, this)\n\n    if (errors) {\n      throw new Error(\n        'Warning: ' +\n          errors +\n          ' invalid S-groups were detected. They will be omitted.'\n      )\n    }\n\n    for (let i = 0; i < toRemove.length; ++i) {\n      mol.sGroupDelete(toRemove[i])\n    }\n  }\n\n  getCTab(molecule: Struct, rgroups?: Map<any, any>) {\n    /* saver */\n    this.molecule = molecule.clone()\n    this.prepareSGroups(false, false)\n    this.molfile = ''\n    this.writeCTab2000(rgroups)\n    return this.molfile\n  }\n\n  saveMolecule(\n    molecule: Struct,\n    skipSGroupErrors: boolean,\n    norgroups?: boolean,\n    preserveIndigoDesc?: boolean\n  ) {\n    // eslint-disable-line max-statements\n    /* saver */\n    this.reaction = molecule.hasRxnArrow()\n    this.molfile = '' + molecule.name\n    if (this.reaction) {\n      if (molecule.rgroups.size > 0) {\n        throw new Error(\n          'Reactions with r-groups are not supported at the moment'\n        )\n      }\n      let components = molecule.getComponents()\n\n      let reactants = components.reactants\n      let products = components.products\n      let all = reactants.concat(products)\n      this.molfile =\n        '$RXN\\n' +\n        molecule.name +\n        '\\n\\n\\n' +\n        utils.paddedNum(reactants.length, 3) +\n        utils.paddedNum(products.length, 3) +\n        utils.paddedNum(0, 3) +\n        '\\n'\n      for (let i = 0; i < all.length; ++i) {\n        const saver = new Molfile()\n        const submol = molecule.clone(all[i], null, true)\n        const molfile = saver.saveMolecule(submol, false, true)\n        this.molfile += '$MOL\\n' + molfile\n      }\n      return this.molfile\n    }\n\n    if (molecule.rgroups.size > 0) {\n      if (norgroups) {\n        molecule = molecule.getScaffold()\n      } else {\n        let scaffold = new Molfile().getCTab(\n          molecule.getScaffold(),\n          molecule.rgroups\n        )\n        this.molfile =\n          '$MDL  REV  1\\n$MOL\\n$HDR\\n' + molecule.name + '\\n\\n\\n$END HDR\\n'\n        this.molfile += '$CTAB\\n' + scaffold + '$END CTAB\\n'\n\n        molecule.rgroups.forEach((rg, rgid) => {\n          this.molfile += '$RGP\\n'\n          this.writePaddedNumber(rgid, 3)\n          this.molfile += '\\n'\n          rg.frags.forEach(fid => {\n            const group = new Molfile().getCTab(molecule.getFragment(fid))\n            this.molfile += '$CTAB\\n' + group + '$END CTAB\\n'\n          })\n          this.molfile += '$END RGP\\n'\n        })\n        this.molfile += '$END MOL\\n'\n\n        return this.molfile\n      }\n    }\n\n    this.molecule = molecule.clone()\n\n    this.prepareSGroups(skipSGroupErrors, preserveIndigoDesc)\n\n    this.writeHeader()\n    this.writeCTab2000()\n\n    return this.molfile\n  }\n\n  writeHeader() {\n    /* saver */\n\n    let date = new Date()\n\n    this.writeCR() // TODO: write structure name\n    this.writeWhiteSpace(2)\n    this.write('Ketcher')\n    this.writeWhiteSpace()\n    this.writeCR(\n      (date.getMonth() + 1 + '').padStart(2) +\n        (date.getDate() + '').padStart(2) +\n        ((date.getFullYear() % 100) + '').padStart(2) +\n        (date.getHours() + '').padStart(2) +\n        (date.getMinutes() + '').padStart(2) +\n        END_V2000\n    )\n    this.writeCR()\n  }\n\n  write(str: string) {\n    /* saver */\n    this.molfile += str\n  }\n\n  writeCR(str?: string) {\n    /* saver */\n    if (arguments.length === 0) {\n      str = ''\n    }\n\n    this.molfile += str + '\\n'\n  }\n\n  writeWhiteSpace(length: number = 0) {\n    /* saver */\n    if (arguments.length === 0) {\n      length = 1\n    }\n\n    this.write(' '.repeat(Math.max(length, 0)))\n  }\n\n  writePadded(str: string, width: number) {\n    /* saver */\n    this.write(str)\n    this.writeWhiteSpace(width - str.length)\n  }\n\n  writePaddedNumber(number: number, width: number) {\n    /* saver */\n    let str = (number - 0).toString()\n\n    this.writeWhiteSpace(width - str.length)\n    this.write(str)\n  }\n\n  writePaddedFloat(number: string | number, width: number, precision: number) {\n    /* saver */\n    this.write(utils.paddedNum(number, width, precision))\n  }\n\n  writeCTab2000Header() {\n    /* saver */\n    this.writePaddedNumber(this.molecule.atoms.size, 3)\n    this.writePaddedNumber(this.molecule.bonds.size, 3)\n\n    this.writePaddedNumber(0, 3)\n    this.writePaddedNumber(0, 3)\n    const isAbsFlag = Array.from(this.molecule.frags.values()).some(fr =>\n      fr ? fr.enhancedStereoFlag === StereoFlag.Abs : false\n    )\n    this.writePaddedNumber(isAbsFlag ? 1 : 0, 3)\n    this.writePaddedNumber(0, 3)\n    this.writeWhiteSpace(12)\n    this.writePaddedNumber(999, 3)\n    this.writeCR(' V2000')\n  }\n\n  writeCTab2000(rgroups?: Map<any, any>) {\n    // eslint-disable-line max-statements\n    /* saver */\n    this.writeCTab2000Header()\n\n    this.mapping = {}\n    let i = 1\n\n    const atomsIds: number[] = []\n    const atomsProps: {\n      id: number\n      value: string\n    }[] = []\n    this.molecule.atoms.forEach((atom, id) => {\n      let label = atom.label\n      if (atom.atomList != null) {\n        label = 'L'\n        atomsIds.push(id)\n      } else if (atom['pseudo']) {\n        if (atom['pseudo'].length > 3) {\n          label = 'A'\n          atomsProps.push({ id, value: `'${atom['pseudo']}'` })\n        }\n      } else if (atom['alias']) {\n        atomsProps.push({ id, value: atom['alias'] })\n      } else if (\n        !Elements.get(atom.label) &&\n        ['A', 'Q', 'X', '*', 'R#'].indexOf(atom.label) === -1\n      ) {\n        // search in generics?\n        label = 'C'\n        atomsProps.push({ id, value: atom.label })\n      }\n\n      this.writeAtom(atom, label)\n\n      this.mapping[id] = i++\n    }, this)\n\n    this.bondMapping = {}\n    i = 1\n    this.molecule.bonds.forEach((bond, id) => {\n      this.bondMapping[id] = i++\n      this.writeBond(bond)\n    }, this)\n\n    while (atomsProps.length > 0) {\n      this.writeAtomProps(atomsProps[0])\n      atomsProps.splice(0, 1)\n    }\n\n    const chargeList: NumberTuple[] = []\n    const isotopeList: NumberTuple[] = []\n    const radicalList: NumberTuple[] = []\n    const rglabelList: NumberTuple[] = []\n    const rglogicList: string[] = []\n    const aplabelList: NumberTuple[] = []\n    const rbcountList: NumberTuple[] = []\n    const unsaturatedList: NumberTuple[] = []\n    const substcountList: NumberTuple[] = []\n\n    this.molecule.atoms.forEach((atom, id) => {\n      if (atom.charge !== 0) {\n        chargeList.push([id, atom.charge])\n      }\n      if (atom.isotope !== 0) {\n        isotopeList.push([id, atom.isotope])\n      }\n      if (atom.radical !== 0) {\n        radicalList.push([id, atom.radical])\n      }\n      if (atom.rglabel != null && atom.label === 'R#') {\n        // TODO need to force rglabel=null when label is not 'R#'\n        for (let rgi = 0; rgi < 32; rgi++) {\n          if ((atom.rglabel as any) & (1 << rgi)) {\n            rglabelList.push([id, rgi + 1])\n          }\n        }\n      }\n      if (atom.attpnt != null) {\n        aplabelList.push([id, atom.attpnt])\n      }\n      if (atom.ringBondCount !== 0) {\n        rbcountList.push([id, atom.ringBondCount])\n      }\n      if (atom.substitutionCount !== 0) {\n        substcountList.push([id, atom.substitutionCount])\n      }\n      if (atom.unsaturatedAtom !== 0) {\n        unsaturatedList.push([id, atom.unsaturatedAtom])\n      }\n    })\n\n    if (rgroups) {\n      rgroups.forEach((rg, rgid) => {\n        if (rg.resth || rg.ifthen > 0 || rg.range.length > 0) {\n          let line =\n            '  1 ' +\n            utils.paddedNum(rgid, 3) +\n            ' ' +\n            utils.paddedNum(rg.ifthen, 3) +\n            ' ' +\n            utils.paddedNum(rg.resth ? 1 : 0, 3) +\n            '   ' +\n            rg.range\n          rglogicList.push(line)\n        }\n      })\n    }\n\n    this.writeAtomPropList('M  CHG', chargeList)\n    this.writeAtomPropList('M  ISO', isotopeList)\n    this.writeAtomPropList('M  RAD', radicalList)\n    this.writeAtomPropList('M  RGP', rglabelList)\n    for (let j = 0; j < rglogicList.length; ++j) {\n      this.write('M  LOG' + rglogicList[j] + '\\n')\n    }\n\n    this.writeAtomPropList('M  APO', aplabelList)\n    this.writeAtomPropList('M  RBC', rbcountList)\n    this.writeAtomPropList('M  SUB', substcountList)\n    this.writeAtomPropList('M  UNS', unsaturatedList)\n\n    if (atomsIds.length > 0) {\n      for (let j = 0; j < atomsIds.length; ++j) {\n        let atomId = atomsIds[j]\n        let atomList = this.molecule.atoms.get(atomId)!.atomList!\n        this.write('M  ALS')\n        this.writePaddedNumber(atomId + 1, 4)\n        this.writePaddedNumber(atomList.ids.length, 3)\n        this.writeWhiteSpace()\n        this.write(atomList.notList ? 'T' : 'F')\n\n        let labelList = atomList.labelList()\n        for (let k = 0; k < labelList.length; ++k) {\n          this.writeWhiteSpace()\n          this.writePadded(labelList[k], 3)\n        }\n        this.writeCR()\n      }\n    }\n\n    const sgmap = {}\n    let cnt = 1\n    const sgmapback = {}\n    const sgorder = this.molecule.sGroupForest.getSGroupsBFS()\n    sgorder.forEach(id => {\n      sgmapback[cnt] = id\n      sgmap[id] = cnt++\n    })\n    for (let q = 1; q < cnt; ++q) {\n      // each group on its own\n      const id = sgmapback[q]\n      const sgroup = this.molecule.sgroups.get(id)!\n      this.write('M  STY')\n      this.writePaddedNumber(1, 3)\n      this.writeWhiteSpace(1)\n      this.writePaddedNumber(q, 3)\n      this.writeWhiteSpace(1)\n      this.writePadded(sgroup.type, 3)\n      this.writeCR()\n\n      // TODO: write subtype, M SST\n\n      this.write('M  SLB')\n      this.writePaddedNumber(1, 3)\n      this.writeWhiteSpace(1)\n      this.writePaddedNumber(q, 3)\n      this.writeWhiteSpace(1)\n      this.writePaddedNumber(q, 3)\n      this.writeCR()\n\n      const parentId = this.molecule.sGroupForest.parent.get(id)!\n      if (parentId >= 0) {\n        this.write('M  SPL')\n        this.writePaddedNumber(1, 3)\n        this.writeWhiteSpace(1)\n        this.writePaddedNumber(q, 3)\n        this.writeWhiteSpace(1)\n        this.writePaddedNumber(sgmap[parentId], 3)\n        this.writeCR()\n      }\n\n      // connectivity\n      if (sgroup.type === 'SRU' && sgroup.data.connectivity) {\n        const connectivity = ` ${q.toString().padStart(3)} ${(\n          sgroup.data.connectivity || ''\n        ).padEnd(3)}`\n\n        this.write('M  SCN')\n        this.writePaddedNumber(1, 3)\n        this.write(connectivity.toUpperCase())\n        this.writeCR()\n      }\n\n      if (sgroup.type === 'SRU') {\n        this.write('M  SMT ')\n        this.writePaddedNumber(q, 3)\n        this.writeWhiteSpace()\n        this.write(sgroup.data.subscript || 'n')\n        this.writeCR()\n      }\n\n      this.writeCR(\n        common.saveToMolfile[sgroup.type](\n          sgroup,\n          this.molecule,\n          sgmap,\n          this.mapping,\n          this.bondMapping\n        )\n      )\n    }\n\n    // TODO: write M  APO\n    // TODO: write M  AAL\n    // TODO: write M  RGP\n    // TODO: write M  LOG\n\n    const expandedGroups: number[] = []\n    this.molecule.sgroups.forEach(sg => {\n      if (sg.data.expanded) expandedGroups.push(sg.id + 1)\n    })\n\n    if (expandedGroups.length) {\n      const expandedGroupsLine = `M  SDS EXP  ${\n        expandedGroups.length\n      }   ${expandedGroups.join('   ')}`\n      this.writeCR(expandedGroupsLine)\n    }\n\n    this.writeCR('M  END')\n  }\n\n  private writeAtom(atom, atomLabel: string) {\n    this.writePaddedFloat(atom.pp.x, 10, 4)\n    this.writePaddedFloat(-atom.pp.y, 10, 4)\n    this.writePaddedFloat(atom.pp.z, 10, 4)\n    this.writeWhiteSpace()\n    this.writePadded(atomLabel, 3)\n    this.writePaddedNumber(0, 2)\n    this.writePaddedNumber(0, 3)\n    this.writePaddedNumber(0, 3)\n\n    if (typeof atom.hCount === 'undefined') {\n      atom.hCount = 0\n    }\n    this.writePaddedNumber(atom.hCount, 3)\n\n    if (typeof atom.stereoCare === 'undefined') {\n      atom.stereoCare = 0\n    }\n    this.writePaddedNumber(atom.stereoCare, 3)\n\n    let number: number\n    if (atom.explicitValence < 0) {\n      number = 0\n    } else if (atom.explicitValence === 0) {\n      number = 15\n    } else {\n      number = atom.explicitValence\n    }\n    this.writePaddedNumber(number, 3)\n\n    this.writePaddedNumber(0, 3)\n    this.writePaddedNumber(0, 3)\n    this.writePaddedNumber(0, 3)\n\n    if (typeof atom.aam === 'undefined') {\n      atom.aam = 0\n    }\n    this.writePaddedNumber(atom.aam, 3)\n\n    if (typeof atom.invRet === 'undefined') {\n      atom.invRet = 0\n    }\n    this.writePaddedNumber(atom.invRet, 3)\n\n    if (typeof atom.exactChangeFlag === 'undefined') {\n      atom.exactChangeFlag = 0\n    }\n    this.writePaddedNumber(atom.exactChangeFlag, 3)\n\n    this.writeCR()\n  }\n\n  private writeBond(bond) {\n    this.writePaddedNumber(this.mapping[bond.begin], 3)\n    this.writePaddedNumber(this.mapping[bond.end], 3)\n    this.writePaddedNumber(bond.type, 3)\n\n    if (typeof bond.stereo === 'undefined') {\n      bond.stereo = 0\n    }\n    this.writePaddedNumber(bond.stereo, 3)\n\n    this.writePadded(bond.xxx, 3)\n\n    if (typeof bond.topology === 'undefined') {\n      bond.topology = 0\n    }\n    this.writePaddedNumber(bond.topology, 3)\n\n    if (typeof bond.reactingCenterStatus === 'undefined') {\n      bond.reactingCenterStatus = 0\n    }\n    this.writePaddedNumber(bond.reactingCenterStatus, 3)\n\n    this.writeCR()\n  }\n\n  private writeAtomProps(props) {\n    this.write('A  ')\n    this.writePaddedNumber(props.id + 1, 3)\n    this.writeCR()\n    this.writeCR(props.value)\n  }\n\n  private writeAtomPropList(propId: string, values: NumberTuple[]) {\n    while (values.length > 0) {\n      const part: NumberTuple[] = []\n\n      while (values.length > 0 && part.length < 8) {\n        part.push(values[0])\n        values.splice(0, 1)\n      }\n\n      this.write(propId)\n      this.writePaddedNumber(part.length, 3)\n\n      part.forEach(value => {\n        this.writeWhiteSpace()\n        this.writePaddedNumber(this.mapping[value[0]], 3)\n        this.writeWhiteSpace()\n        this.writePaddedNumber(value[1], 3)\n      })\n\n      this.writeCR()\n    }\n  }\n}\n","/****************************************************************************\n * Copyright 2021 EPAM Systems\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *    http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n ***************************************************************************/\n\nimport { MolSerializerOptions } from './mol.types'\nimport { Molfile } from './molfile'\nimport { Serializer } from '../serializers.types'\nimport { Struct } from 'domain/entities'\n\nexport class MolSerializer implements Serializer<Struct> {\n  static DefaultOptions: MolSerializerOptions = {\n    badHeaderRecover: false,\n    ignoreErrors: false,\n    noRgroups: false,\n    preserveIndigoDesc: false,\n    reactionRelayout: false\n  }\n\n  readonly options: MolSerializerOptions\n\n  constructor(options?: Partial<MolSerializerOptions>) {\n    this.options = { ...MolSerializer.DefaultOptions, ...options }\n  }\n\n  deserialize(content: string): Struct {\n    const molfile = new Molfile()\n    const lines = content?.split(/\\r\\n|[\\n\\r]/g)\n    try {\n      return molfile.parseCTFile(lines, this.options.reactionRelayout)\n    } catch (ex) {\n      if (this.options.badHeaderRecover) {\n        try {\n          // check whether there's an extra empty line on top\n          // this often happens when molfile text is pasted into the dialog window\n          return molfile.parseCTFile(\n            lines.slice(1),\n            this.options.reactionRelayout\n          )\n        } catch (ex1) {\n          //\n        }\n        try {\n          // check for a missing first line\n          // this sometimes happens when pasting\n          return molfile.parseCTFile(\n            [''].concat(lines),\n            this.options.reactionRelayout\n          )\n        } catch (ex2) {\n          //\n        }\n      }\n      throw ex\n    }\n  }\n\n  serialize(struct: Struct): string {\n    return new Molfile().saveMolecule(\n      struct,\n      this.options.ignoreErrors,\n      this.options.noRgroups,\n      this.options.preserveIndigoDesc\n    )\n  }\n}\n","/****************************************************************************\n * Copyright 2021 EPAM Systems\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *    http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n ***************************************************************************/\n\nimport { Bond, Pool, Vec2 } from 'domain/entities'\n\nfunction CisTrans(mol, neighborsFunc, context) {\n  this.molecule = mol\n  this.bonds = new Pool()\n  this.getNeighbors = neighborsFunc\n  this.context = context\n}\n\nCisTrans.PARITY = {\n  NONE: 0,\n  CIS: 1,\n  TRANS: 2\n}\n\nCisTrans.prototype.each = function (func) {\n  this.bonds.forEach(func)\n}\n\nCisTrans.prototype.getParity = function (idx) {\n  return this.bonds.get(idx).parity\n}\n\nCisTrans.prototype.getSubstituents = function (idx) {\n  return this.bonds.get(idx).substituents\n}\n\nCisTrans.prototype.sameside = function (beg, end, neiBeg, neiEnd) {\n  var diff = Vec2.diff(beg, end)\n  var norm = new Vec2(-diff.y, diff.x)\n\n  if (!norm.normalize()) return 0\n\n  var normBeg = Vec2.diff(neiBeg, beg)\n  var normEnd = Vec2.diff(neiEnd, end)\n\n  if (!normBeg.normalize()) return 0\n  if (!normEnd.normalize()) return 0\n\n  var prodBeg = Vec2.dot(normBeg, norm)\n  var prodEnd = Vec2.dot(normEnd, norm)\n\n  if (Math.abs(prodBeg) < 0.001 || Math.abs(prodEnd) < 0.001) return 0\n\n  return prodBeg * prodEnd > 0 ? 1 : -1\n}\n\nCisTrans.prototype.samesides = function (iBeg, iEnd, iNeiBeg, iNeiEnd) {\n  return this.sameside(\n    this.molecule.atoms.get(iBeg).pp,\n    this.molecule.atoms.get(iEnd).pp,\n    this.molecule.atoms.get(iNeiBeg).pp,\n    this.molecule.atoms.get(iNeiEnd).pp\n  )\n}\n\nCisTrans.prototype.sortSubstituents = function (substituents) {\n  // eslint-disable-line max-statements\n  var h0 = this.molecule.atoms.get(substituents[0]).pureHydrogen()\n  var h1 =\n    substituents[1] < 0 ||\n    this.molecule.atoms.get(substituents[1]).pureHydrogen()\n  var h2 = this.molecule.atoms.get(substituents[2]).pureHydrogen()\n  var h3 =\n    substituents[3] < 0 ||\n    this.molecule.atoms.get(substituents[3]).pureHydrogen()\n\n  if (h0 && h1) return false\n  if (h2 && h3) return false\n\n  if (h1) {\n    substituents[1] = -1\n  } else if (h0) {\n    substituents[0] = substituents[1]\n    substituents[1] = -1\n  } else if (substituents[0] > substituents[1]) {\n    swap(substituents, 0, 1)\n  }\n\n  if (h3) {\n    substituents[3] = -1\n  } else if (h2) {\n    substituents[2] = substituents[3]\n    substituents[3] = -1\n  } else if (substituents[2] > substituents[3]) {\n    swap(substituents, 2, 3)\n  }\n\n  return true\n}\n\nCisTrans.prototype.isGeomStereoBond = function (bondIdx, substituents) {\n  // eslint-disable-line max-statements\n  // it must be [C,N,Si]=[C,N,Si] bond\n  var bond = this.molecule.bonds.get(bondIdx)\n\n  if (bond.type != Bond.PATTERN.TYPE.DOUBLE) return false\n\n  var label1 = this.molecule.atoms.get(bond.begin).label\n  var label2 = this.molecule.atoms.get(bond.end).label\n\n  if (label1 != 'C' && label1 != 'N' && label1 != 'Si' && label1 != 'Ge')\n    return false\n  if (label2 != 'C' && label2 != 'N' && label2 != 'Si' && label2 != 'Ge')\n    return false\n\n  // the atoms should have 1 or 2 single bonds\n  // (apart from the double bond under consideration)\n  var neiBegin = this.getNeighbors.call(this.context, bond.begin)\n  var nei–ïnd = this.getNeighbors.call(this.context, bond.end)\n\n  if (\n    neiBegin.length < 2 ||\n    neiBegin.length > 3 ||\n    nei–ïnd.length < 2 ||\n    nei–ïnd.length > 3\n  )\n    return false\n\n  substituents[0] = -1\n  substituents[1] = -1\n  substituents[2] = -1\n  substituents[3] = -1\n\n  var i\n  var nei\n\n  for (i = 0; i < neiBegin.length; i++) {\n    nei = neiBegin[i]\n\n    if (nei.bid == bondIdx) continue // eslint-disable-line no-continue\n\n    if (this.molecule.bonds.get(nei.bid).type != Bond.PATTERN.TYPE.SINGLE)\n      return false\n\n    if (substituents[0] == -1) substituents[0] = nei.aid\n    // (substituents[1] == -1)\n    else substituents[1] = nei.aid\n  }\n\n  for (i = 0; i < nei–ïnd.length; i++) {\n    nei = nei–ïnd[i]\n\n    if (nei.bid == bondIdx) continue // eslint-disable-line no-continue\n\n    if (this.molecule.bonds.get(nei.bid).type != Bond.PATTERN.TYPE.SINGLE)\n      return false\n\n    if (substituents[2] == -1) substituents[2] = nei.aid\n    // (substituents[3] == -1)\n    else substituents[3] = nei.aid\n  }\n\n  if (\n    substituents[1] != -1 &&\n    this.samesides(bond.begin, bond.end, substituents[0], substituents[1]) != -1\n  )\n    return false\n  if (\n    substituents[3] != -1 &&\n    this.samesides(bond.begin, bond.end, substituents[2], substituents[3]) != -1\n  )\n    return false\n\n  return true\n}\n\nCisTrans.prototype.build = function (excludeBonds) {\n  this.molecule.bonds.forEach((bond, bid) => {\n    const ct = {\n      parity: 0,\n      substituents: []\n    }\n    this.bonds.set(bid, ct)\n\n    if (Array.isArray(excludeBonds) && excludeBonds[bid]) return\n\n    if (!this.isGeomStereoBond(bid, ct.substituents)) return\n\n    if (!this.sortSubstituents(ct.substituents)) return\n\n    const sign = this.samesides(\n      bond.begin,\n      bond.end,\n      ct.substituents[0],\n      ct.substituents[2]\n    )\n\n    if (sign === 1) ct.parity = CisTrans.PARITY.CIS\n    else if (sign === -1) ct.parity = CisTrans.PARITY.TRANS\n  })\n}\n\nfunction swap(arr, i1, i2) {\n  var tmp = arr[i1]\n  arr[i1] = arr[i2]\n  arr[i2] = tmp\n}\n\nexport default CisTrans\n","/****************************************************************************\n * Copyright 2021 EPAM Systems\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *    http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n ***************************************************************************/\n\nfunction Dfs(mol, atomData, components, nReactants) {\n  this.molecule = mol\n  this.atom_data = atomData\n  this.components = components\n  this.nComponentsInReactants = -1\n  this.nReactants = nReactants\n\n  this.vertices = new Array(this.molecule.atoms.size) // Minimum size\n  this.molecule.atoms.forEach((atom, aid) => {\n    this.vertices[aid] = new Dfs.VertexDesc()\n  }, this)\n\n  this.edges = new Array(this.molecule.bonds.size) // Minimum size\n  this.molecule.bonds.forEach((bond, bid) => {\n    this.edges[bid] = new Dfs.EdgeDesc()\n  }, this)\n\n  this.v_seq = []\n}\n\nDfs.VertexDesc = function () {\n  this.dfs_state = 0 // 0 -- not on stack\n  // 1 -- on stack\n  // 2 -- removed from stack\n  this.parent_vertex = 0 // parent vertex in DFS tree\n  this.parent_edge = 0 // edge to parent vertex\n  this.branches = 0 // how many DFS branches go out from this vertex}\n}\n\nDfs.EdgeDesc = function () {\n  this.opening_cycles = 0 // how many cycles are\n  // (i) starting with this edge\n  // and (ii) ending in this edge's first vertex\n  this.closing_cycle = 0 // 1 if this edge closes a cycle\n}\n\nDfs.SeqElem = function (vIdx, parVertex, parEdge) {\n  this.idx = vIdx // index of vertex in _graph\n  this.parent_vertex = parVertex // parent vertex in DFS tree\n  this.parent_edge = parEdge // edge to parent vertex\n}\n\nDfs.prototype.walk = function () {\n  // eslint-disable-line max-statements\n  var vStack = []\n  var i, j\n  var cid = 0\n  var component = 0\n\n  while (true) {\n    // eslint-disable-line no-constant-condition\n    if (vStack.length < 1) {\n      var selected = -1\n\n      while (cid < this.components.length && selected == -1) {\n        selected = this.components[cid].find(aid => {\n          if (this.vertices[aid].dfs_state === 0) {\n            selected = aid\n            return true\n          }\n          return false\n        })\n        if (selected === null) {\n          selected = -1\n          cid++\n        }\n        if (cid == this.nReactants) this.nComponentsInReactants = component\n      }\n      if (selected < -1) {\n        this.molecule.atoms.find(aid => {\n          if (this.vertices[aid].dfs_state === 0) {\n            selected = aid\n            return true\n          }\n          return false\n        })\n      }\n      if (selected == -1) break\n      this.vertices[selected].parent_vertex = -1\n      this.vertices[selected].parent_edge = -1\n      vStack.push(selected)\n      component++\n    }\n\n    var vIdx = vStack.pop()\n    var parentVertex = this.vertices[vIdx].parent_vertex\n\n    var seqElem = new Dfs.SeqElem(\n      vIdx,\n      parentVertex,\n      this.vertices[vIdx].parent_edge\n    )\n    this.v_seq.push(seqElem)\n\n    this.vertices[vIdx].dfs_state = 2\n\n    var atomD = this.atom_data[vIdx]\n\n    for (i = 0; i < atomD.neighbours.length; i++) {\n      var neiIdx = atomD.neighbours[i].aid\n      var edgeIdx = atomD.neighbours[i].bid\n\n      if (neiIdx == parentVertex) continue // eslint-disable-line no-continue\n\n      if (this.vertices[neiIdx].dfs_state == 2) {\n        this.edges[edgeIdx].closing_cycle = 1\n\n        j = vIdx\n\n        while (j != -1 && this.vertices[j].parent_vertex != neiIdx)\n          j = this.vertices[j].parent_vertex\n\n        if (j == -1) throw new Error('cycle unwind error')\n\n        this.edges[this.vertices[j].parent_edge].opening_cycles++\n        this.vertices[vIdx].branches++\n\n        seqElem = new Dfs.SeqElem(neiIdx, vIdx, edgeIdx)\n        this.v_seq.push(seqElem)\n      } else {\n        if (this.vertices[neiIdx].dfs_state == 1) {\n          j = vStack.indexOf(neiIdx)\n\n          if (j == -1)\n            // eslint-disable-line max-depth\n            throw new Error('internal: removing vertex from stack')\n\n          vStack.splice(j, 1)\n\n          var parent = this.vertices[neiIdx].parent_vertex\n\n          if (parent >= 0)\n            // eslint-disable-line max-depth\n            this.vertices[parent].branches--\n        }\n\n        this.vertices[vIdx].branches++\n        this.vertices[neiIdx].parent_vertex = vIdx\n        this.vertices[neiIdx].parent_edge = edgeIdx\n        this.vertices[neiIdx].dfs_state = 1\n        vStack.push(neiIdx)\n      }\n    }\n  }\n}\n\nDfs.prototype.edgeClosingCycle = function (eIdx) {\n  return this.edges[eIdx].closing_cycle !== 0\n}\n\nDfs.prototype.numBranches = function (vIdx) {\n  return this.vertices[vIdx].branches\n}\n\nDfs.prototype.numOpeningCycles = function (eIdx) {\n  return this.edges[eIdx].opening_cycles\n}\n\nDfs.prototype.toString = function () {\n  var str = ''\n  this.v_seq.forEach(seqElem => {\n    str += seqElem.idx + ' -> '\n  })\n  str += '*'\n  return str\n}\n\nexport default Dfs\n","/****************************************************************************\n * Copyright 2021 EPAM Systems\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *    http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n ***************************************************************************/\n\nimport { Bond, Pile, Pool, Vec2 } from 'domain/entities'\n\nfunction Stereocenters(mol, neighborsFunc, context) {\n  this.molecule = mol\n  this.atoms = new Pool()\n  this.getNeighbors = neighborsFunc\n  this.context = context\n}\n\nStereocenters.prototype.each = function (func, context) {\n  this.atoms.forEach(func, context)\n}\n\nStereocenters.prototype.buildFromBonds = function (\n  /* const int *atom_types, const int *atom_groups, const int *bond_orientations, */ ignoreErrors\n) {\n  var atoms = this.molecule.atoms\n  var bonds = this.molecule.bonds\n\n  /*\n\t\tthis is a set of atoms that are likely to belong to allene structures and\n\t\ttherefore should not be considered as potential stereocenters in the code below,\n\t\tas allenes cannot be encoded in the SMILES notation\n\t*/\n\n  var alleneMask = new Pile()\n  atoms.forEach((atom, aid) => {\n    var neiList = this.getNeighbors.call(this.context, aid)\n    if (neiList.length !== 2) return false\n    var nei1 = neiList[0]\n    var nei2 = neiList[1]\n    // check atom labels\n    if (\n      [aid, nei1.aid, nei2.aid].findIndex(\n        aid => ['C', 'Si'].indexOf(atoms.get(aid).label) < 0,\n        this\n      ) >= 0\n    )\n      return false\n\n    // check adjacent bond types\n    if (\n      [nei1.bid, nei2.bid].findIndex(\n        bid => bonds.get(bid).type !== Bond.PATTERN.TYPE.DOUBLE,\n        this\n      ) >= 0\n    )\n      return false\n\n    // get the other neighbors of the two adjacent atoms except for the central atom\n    var nei1nei = this.getNeighbors\n      .call(this.context, nei1.aid)\n      .filter(nei => nei.aid != aid)\n    var nei2nei = this.getNeighbors\n      .call(this.context, nei2.aid)\n      .filter(nei => nei.aid != aid)\n    if (\n      nei1nei.length < 1 ||\n      nei1nei.length > 2 ||\n      nei2nei.length < 1 ||\n      nei2nei.length > 2\n    )\n      return false\n\n    if (\n      nei1nei\n        .concat(nei2nei)\n        .findIndex(\n          nei => bonds.get(nei.bid).type != Bond.PATTERN.TYPE.SINGLE,\n          this\n        ) >= 0\n    )\n      return false\n\n    if (\n      nei1nei\n        .concat(nei2nei)\n        .findIndex(\n          nei => bonds.get(nei.bid).stereo == Bond.PATTERN.STEREO.EITHER,\n          this\n        ) >= 0\n    )\n      return false\n    alleneMask.add(nei1.aid).add(nei2.aid)\n    return true\n  })\n\n  if (alleneMask.size > 0)\n    //TODO: add error handler call\n    //legacy message: This structure may contain allenes, which cannot be represented in the SMILES notation. Relevant stereo-information will be discarded.\n\n    atoms.forEach((atom, aid) => {\n      if (alleneMask.has(aid)) return\n      /*\n      if (atom_types[atom_idx] == 0)\n         continue;\n         */\n      var neiList = this.getNeighbors.call(this.context, aid)\n      var stereocenter = false\n\n      neiList.find(function (nei) {\n        var bond = this.molecule.bonds.get(nei.bid)\n\n        if (bond.type === Bond.PATTERN.TYPE.SINGLE && bond.begin == aid) {\n          if (\n            bond.stereo === Bond.PATTERN.STEREO.UP ||\n            bond.stereo == Bond.PATTERN.STEREO.DOWN\n          ) {\n            stereocenter = true\n            return true\n          }\n        }\n        return false\n      }, this)\n\n      if (!stereocenter) return\n\n      if (ignoreErrors)\n        this.buildOneCenter(\n          aid /* , atom_groups[atom_idx], atom_types[atom_idx], bond_orientations*/\n        )\n      else\n        this.buildOneCenter(\n          aid /* , atom_groups[atom_idx], atom_types[atom_idx], bond_orientations*/\n        )\n    })\n}\n\nStereocenters.allowed_stereocenters = [\n  { elem: 'C', charge: 0, degree: 3, n_double_bonds: 0, implicit_degree: 4 },\n  { elem: 'C', charge: 0, degree: 4, n_double_bonds: 0, implicit_degree: 4 },\n  { elem: 'Si', charge: 0, degree: 3, n_double_bonds: 0, implicit_degree: 4 },\n  { elem: 'Si', charge: 0, degree: 4, n_double_bonds: 0, implicit_degree: 4 },\n  { elem: 'N', charge: 1, degree: 3, n_double_bonds: 0, implicit_degree: 4 },\n  { elem: 'N', charge: 1, degree: 4, n_double_bonds: 0, implicit_degree: 4 },\n  { elem: 'N', charge: 0, degree: 3, n_double_bonds: 0, implicit_degree: 3 },\n  { elem: 'S', charge: 0, degree: 4, n_double_bonds: 2, implicit_degree: 4 },\n  { elem: 'S', charge: 1, degree: 3, n_double_bonds: 0, implicit_degree: 3 },\n  { elem: 'S', charge: 0, degree: 3, n_double_bonds: 1, implicit_degree: 3 },\n  { elem: 'P', charge: 0, degree: 3, n_double_bonds: 0, implicit_degree: 3 },\n  { elem: 'P', charge: 1, degree: 4, n_double_bonds: 0, implicit_degree: 4 },\n  { elem: 'P', charge: 0, degree: 4, n_double_bonds: 1, implicit_degree: 4 }\n]\n\nStereocenters.prototype.buildOneCenter = function (\n  atomIdx /* , int group, int type, const int *bond_orientations*/\n) {\n  // eslint-disable-line max-statements\n  var atom = this.molecule.atoms.get(atomIdx)\n\n  var neiList = this.getNeighbors.call(this.context, atomIdx)\n  var degree = neiList.length\n  var implicitDegree = -1\n\n  var stereocenter = {\n    group: 0, // = group;\n    type: 0, // = type;\n    pyramid: []\n  }\n\n  var edgeIds = []\n\n  var lastAtomDir = 0\n  var nDoubleBonds = 0\n\n  stereocenter.pyramid[0] = -1\n  stereocenter.pyramid[1] = -1\n  stereocenter.pyramid[2] = -1\n  stereocenter.pyramid[3] = -1\n\n  var nPureHydrogens = 0\n\n  if (degree > 4)\n    throw new Error('stereocenter with %d bonds are not supported' + degree)\n\n  neiList.forEach((nei, neiIdx) => {\n    var neiAtom = this.molecule.atoms.get(nei.aid)\n    var bond = this.molecule.bonds.get(nei.bid)\n    edgeIds[neiIdx] = {\n      edge_idx: nei.bid,\n      nei_idx: nei.aid,\n      rank: nei.aid,\n      vec: Vec2.diff(neiAtom.pp, atom.pp).yComplement()\n    }\n\n    if (neiAtom.pureHydrogen()) {\n      nPureHydrogens++\n      edgeIds[neiIdx].rank = 10000\n    } else if (neiAtom.label === 'H') {\n      edgeIds[neiIdx].rank = 5000\n    }\n\n    if (!edgeIds[neiIdx].vec.normalize()) throw new Error('zero bond length')\n\n    if (bond.type === Bond.PATTERN.TYPE.TRIPLE)\n      throw new Error('non-single bonds not allowed near stereocenter')\n    else if (bond.type === Bond.PATTERN.TYPE.AROMATIC)\n      throw new Error('aromatic bonds not allowed near stereocenter')\n    else if (bond.type === Bond.PATTERN.TYPE.DOUBLE) nDoubleBonds++\n  })\n\n  Stereocenters.allowed_stereocenters.find(as => {\n    if (\n      as.elem === atom.label &&\n      as.charge === atom.charge &&\n      as.degree === degree &&\n      as.n_double_bonds === nDoubleBonds\n    ) {\n      implicitDegree = as.implicit_degree\n      return true\n    }\n    return false\n  })\n\n  if (implicitDegree === -1)\n    throw new Error(\n      'unknown stereocenter configuration: ' +\n        atom.label +\n        ', charge ' +\n        atom.charge +\n        ', ' +\n        degree +\n        ' bonds (' +\n        nDoubleBonds +\n        ' double)'\n    )\n\n  if (degree === 4 && nPureHydrogens > 1)\n    throw new Error(nPureHydrogens + ' hydrogens near stereocenter')\n\n  if (degree === 3 && implicitDegree === 4 && nPureHydrogens > 0)\n    throw new Error(\n      'have hydrogen(s) besides implicit hydrogen near stereocenter'\n    )\n\n  if (degree === 4) {\n    // sort by neighbor atom index (ascending)\n    if (edgeIds[0].rank > edgeIds[1].rank) swap(edgeIds, 0, 1)\n    if (edgeIds[1].rank > edgeIds[2].rank) swap(edgeIds, 1, 2)\n    if (edgeIds[2].rank > edgeIds[3].rank) swap(edgeIds, 2, 3)\n    if (edgeIds[1].rank > edgeIds[2].rank) swap(edgeIds, 1, 2)\n    if (edgeIds[0].rank > edgeIds[1].rank) swap(edgeIds, 0, 1)\n    if (edgeIds[1].rank > edgeIds[2].rank) swap(edgeIds, 1, 2)\n\n    var main1 = -1\n    var main2 = -1\n    var side1 = -1\n    var side2 = -1\n    var mainDir = 0\n\n    for (var neiIdx = 0; neiIdx < 4; neiIdx++) {\n      var stereo = this.getBondStereo(atomIdx, edgeIds[neiIdx].edge_idx)\n\n      if (\n        stereo === Bond.PATTERN.STEREO.UP ||\n        stereo == Bond.PATTERN.STEREO.DOWN\n      ) {\n        main1 = neiIdx\n        mainDir = stereo\n        break\n      }\n    }\n\n    if (main1 === -1)\n      throw new Error('none of 4 bonds going from stereocenter is stereobond')\n\n    var xyz1, xyz2\n\n    // find main2 as opposite to main1\n    if (main2 === -1) {\n      xyz1 = Stereocenters.xyzzy(\n        edgeIds[main1].vec,\n        edgeIds[(main1 + 1) % 4].vec,\n        edgeIds[(main1 + 2) % 4].vec\n      )\n      xyz2 = Stereocenters.xyzzy(\n        edgeIds[main1].vec,\n        edgeIds[(main1 + 1) % 4].vec,\n        edgeIds[(main1 + 3) % 4].vec\n      )\n\n      if (xyz1 + xyz2 == 3 || xyz1 + xyz2 == 12) {\n        main2 = (main1 + 1) % 4\n        side1 = (main1 + 2) % 4\n        side2 = (main1 + 3) % 4\n      }\n    }\n    if (main2 == -1) {\n      xyz1 = Stereocenters.xyzzy(\n        edgeIds[main1].vec,\n        edgeIds[(main1 + 2) % 4].vec,\n        edgeIds[(main1 + 1) % 4].vec\n      )\n      xyz2 = Stereocenters.xyzzy(\n        edgeIds[main1].vec,\n        edgeIds[(main1 + 2) % 4].vec,\n        edgeIds[(main1 + 3) % 4].vec\n      )\n\n      if (xyz1 + xyz2 == 3 || xyz1 + xyz2 == 12) {\n        main2 = (main1 + 2) % 4\n        side1 = (main1 + 1) % 4\n        side2 = (main1 + 3) % 4\n      }\n    }\n    if (main2 == -1) {\n      xyz1 = Stereocenters.xyzzy(\n        edgeIds[main1].vec,\n        edgeIds[(main1 + 3) % 4].vec,\n        edgeIds[(main1 + 1) % 4].vec\n      )\n      xyz2 = Stereocenters.xyzzy(\n        edgeIds[main1].vec,\n        edgeIds[(main1 + 3) % 4].vec,\n        edgeIds[(main1 + 2) % 4].vec\n      )\n\n      if (xyz1 + xyz2 == 3 || xyz1 + xyz2 == 12) {\n        main2 = (main1 + 3) % 4\n        side1 = (main1 + 2) % 4\n        side2 = (main1 + 1) % 4\n      }\n    }\n\n    if (main2 == -1)\n      throw new Error('internal error: can not find opposite bond')\n\n    if (\n      mainDir == Bond.PATTERN.STEREO.UP &&\n      this.getBondStereo(atomIdx, edgeIds[main2].edge_idx) ==\n        Bond.PATTERN.STEREO.DOWN\n    )\n      throw new Error('stereo types of the opposite bonds mismatch')\n    if (\n      mainDir == Bond.PATTERN.STEREO.DOWN &&\n      this.getBondStereo(atomIdx, edgeIds[main2].edge_idx) ==\n        Bond.PATTERN.STEREO.UP\n    )\n      throw new Error('stereo types of the opposite bonds mismatch')\n\n    if (mainDir == this.getBondStereo(atomIdx, edgeIds[side1].edge_idx))\n      throw new Error('stereo types of non-opposite bonds match')\n    if (mainDir == this.getBondStereo(atomIdx, edgeIds[side2].edge_idx))\n      throw new Error('stereo types of non-opposite bonds match')\n\n    if (main1 == 3 || main2 == 3) lastAtomDir = mainDir\n    else\n      lastAtomDir =\n        mainDir == Bond.PATTERN.STEREO.UP\n          ? Bond.PATTERN.STEREO.DOWN\n          : Bond.PATTERN.STEREO.UP\n\n    sign = Stereocenters.sign(edgeIds[0].vec, edgeIds[1].vec, edgeIds[2].vec)\n\n    if (\n      (lastAtomDir == Bond.PATTERN.STEREO.UP && sign > 0) ||\n      (lastAtomDir == Bond.PATTERN.STEREO.DOWN && sign < 0)\n    ) {\n      stereocenter.pyramid[0] = edgeIds[0].nei_idx\n      stereocenter.pyramid[1] = edgeIds[1].nei_idx\n      stereocenter.pyramid[2] = edgeIds[2].nei_idx\n    } else {\n      stereocenter.pyramid[0] = edgeIds[0].nei_idx\n      stereocenter.pyramid[1] = edgeIds[2].nei_idx\n      stereocenter.pyramid[2] = edgeIds[1].nei_idx\n    }\n\n    stereocenter.pyramid[3] = edgeIds[3].nei_idx\n  } else if (degree === 3) {\n    // sort by neighbor atom index (ascending)\n    if (edgeIds[0].rank > edgeIds[1].rank) swap(edgeIds, 0, 1)\n    if (edgeIds[1].rank > edgeIds[2].rank) swap(edgeIds, 1, 2)\n    if (edgeIds[0].rank > edgeIds[1].rank) swap(edgeIds, 0, 1)\n\n    var stereo0 = this.getBondStereo(atomIdx, edgeIds[0].edge_idx)\n    var stereo1 = this.getBondStereo(atomIdx, edgeIds[1].edge_idx)\n    var stereo2 = this.getBondStereo(atomIdx, edgeIds[2].edge_idx)\n\n    var nUp = 0\n    var nDown = 0\n\n    nUp += stereo0 === Bond.PATTERN.STEREO.UP ? 1 : 0\n    nUp += stereo1 === Bond.PATTERN.STEREO.UP ? 1 : 0\n    nUp += stereo2 === Bond.PATTERN.STEREO.UP ? 1 : 0\n\n    nDown += stereo0 === Bond.PATTERN.STEREO.DOWN ? 1 : 0\n    nDown += stereo1 === Bond.PATTERN.STEREO.DOWN ? 1 : 0\n    nDown += stereo2 === Bond.PATTERN.STEREO.DOWN ? 1 : 0\n\n    if (implicitDegree == 4) {\n      // have implicit hydrogen\n      if (nUp == 3) throw new Error('all 3 bonds up near stereoatom')\n      if (nDown == 3) throw new Error('all 3 bonds down near stereoatom')\n\n      if (nUp == 0 && nDown == 0)\n        throw new Error('no up/down bonds near stereoatom -- indefinite case')\n      if (nUp == 1 && nDown == 1)\n        throw new Error('one bond up, one bond down -- indefinite case')\n\n      mainDir = 0\n\n      if (nUp == 2) {\n        lastAtomDir = Bond.PATTERN.STEREO.DOWN\n      } else if (nDown == 2) {\n        lastAtomDir = Bond.PATTERN.STEREO.UP\n      } else {\n        main1 = -1\n        side1 = -1\n        side2 = -1\n\n        for (neiIdx = 0; neiIdx < 3; neiIdx++) {\n          dir = this.getBondStereo(atomIdx, edgeIds[neiIdx].edge_idx)\n\n          if (\n            dir == Bond.PATTERN.STEREO.UP ||\n            dir == Bond.PATTERN.STEREO.DOWN\n          ) {\n            // eslint-disable-line max-depth\n            main1 = neiIdx\n            mainDir = dir\n            side1 = (neiIdx + 1) % 3\n            side2 = (neiIdx + 2) % 3\n            break\n          }\n        }\n\n        if (main1 == -1)\n          throw new Error('internal error: can not find up or down bond')\n\n        var xyz = Stereocenters.xyzzy(\n          edgeIds[side1].vec,\n          edgeIds[side2].vec,\n          edgeIds[main1].vec\n        )\n\n        if (xyz == 3 || xyz == 4)\n          throw new Error('degenerate case for 3 bonds near stereoatom')\n\n        if (xyz == 1) lastAtomDir = mainDir\n        else\n          lastAtomDir =\n            mainDir == Bond.PATTERN.STEREO.UP\n              ? Bond.PATTERN.STEREO.DOWN\n              : Bond.PATTERN.STEREO.UP\n      }\n\n      var sign = Stereocenters.sign(\n        edgeIds[0].vec,\n        edgeIds[1].vec,\n        edgeIds[2].vec\n      )\n\n      if (\n        (lastAtomDir == Bond.PATTERN.STEREO.UP && sign > 0) ||\n        (lastAtomDir == Bond.PATTERN.STEREO.DOWN && sign < 0)\n      ) {\n        stereocenter.pyramid[0] = edgeIds[0].nei_idx\n        stereocenter.pyramid[1] = edgeIds[1].nei_idx\n        stereocenter.pyramid[2] = edgeIds[2].nei_idx\n      } else {\n        stereocenter.pyramid[0] = edgeIds[0].nei_idx\n        stereocenter.pyramid[1] = edgeIds[2].nei_idx\n        stereocenter.pyramid[2] = edgeIds[1].nei_idx\n      }\n\n      stereocenter.pyramid[3] = -1\n    } else {\n      // 3-connected P, N or S; no implicit hydrogens\n      var dir\n\n      if (nDown > 0 && nUp > 0)\n        throw new Error('one bond up, one bond down -- indefinite case')\n      else if (nDown == 0 && nUp == 0)\n        throw new Error('no up-down bonds attached to stereocenter')\n      else if (nUp > 0) dir = 1\n      else dir = -1\n\n      if (\n        Stereocenters.xyzzy(edgeIds[0].vec, edgeIds[1].vec, edgeIds[2].vec) ===\n          1 ||\n        Stereocenters.xyzzy(edgeIds[0].vec, edgeIds[2].vec, edgeIds[1].vec) ===\n          1 ||\n        Stereocenters.xyzzy(edgeIds[2].vec, edgeIds[1].vec, edgeIds[0].vec) ===\n          1\n      )\n        // all bonds belong to the same half-plane\n        dir = -dir\n\n      sign = Stereocenters.sign(edgeIds[0].vec, edgeIds[1].vec, edgeIds[2].vec)\n\n      if (sign == dir) {\n        stereocenter.pyramid[0] = edgeIds[0].nei_idx\n        stereocenter.pyramid[1] = edgeIds[2].nei_idx\n        stereocenter.pyramid[2] = edgeIds[1].nei_idx\n      } else {\n        stereocenter.pyramid[0] = edgeIds[0].nei_idx\n        stereocenter.pyramid[1] = edgeIds[1].nei_idx\n        stereocenter.pyramid[2] = edgeIds[2].nei_idx\n      }\n      stereocenter.pyramid[3] = -1\n    }\n  }\n  this.atoms.set(atomIdx, stereocenter)\n}\n\nStereocenters.prototype.getBondStereo = function (centerIdx, edgeIdx) {\n  var bond = this.molecule.bonds.get(edgeIdx)\n\n  if (centerIdx != bond.begin)\n    // TODO: check this\n    return 0\n\n  return bond.stereo\n}\n\n// 1 -- in the smaller angle, 2 -- in the bigger angle,\n// 4 -- in the 'positive' straight angle, 8 -- in the 'negative' straight angle\nStereocenters.xyzzy = function (v1, v2, u) {\n  var eps = 0.001\n\n  var sine1 = Vec2.cross(v1, v2)\n  var cosine1 = Vec2.dot(v1, v2)\n\n  var sine2 = Vec2.cross(v1, u)\n  var cosine2 = Vec2.dot(v1, u)\n\n  if (Math.abs(sine1) < eps) {\n    if (Math.abs(sine2) < eps)\n      throw new Error('degenerate case -- bonds overlap')\n\n    return sine2 > 0 ? 4 : 8\n  }\n\n  if (sine1 * sine2 < -eps * eps) return 2\n\n  if (cosine2 < cosine1) return 2\n\n  return 1\n}\n\nStereocenters.sign = function (v1, v2, v3) {\n  var res = (v1.x - v3.x) * (v2.y - v3.y) - (v1.y - v3.y) * (v2.x - v3.x) // eslint-disable-line no-mixed-operators\n  var eps = 0.001\n\n  if (res > eps) return 1\n  if (res < -eps) return -1\n\n  throw new Error('degenerate triangle')\n}\n\nStereocenters.isPyramidMappingRigid = function (mapping) {\n  var arr = mapping.slice()\n  var rigid = true\n\n  if (arr[0] > arr[1]) {\n    swap(arr, 0, 1)\n    rigid = !rigid\n  }\n  if (arr[1] > arr[2]) {\n    swap(arr, 1, 2)\n    rigid = !rigid\n  }\n  if (arr[2] > arr[3]) {\n    swap(arr, 2, 3)\n    rigid = !rigid\n  }\n  if (arr[1] > arr[2]) {\n    swap(arr, 1, 2)\n    rigid = !rigid\n  }\n  if (arr[0] > arr[1]) {\n    swap(arr, 0, 1)\n    rigid = !rigid\n  }\n  if (arr[1] > arr[2]) {\n    swap(arr, 1, 2)\n    rigid = !rigid\n  }\n\n  return rigid\n}\n\nfunction swap(arr, i1, i2) {\n  var tmp = arr[i1]\n  arr[i1] = arr[i2]\n  arr[i2] = tmp\n}\n\nexport default Stereocenters\n","/****************************************************************************\n * Copyright 2021 EPAM Systems\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *    http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n ***************************************************************************/\n\nimport { Atom, Bond, Pile, SGroup } from 'domain/entities'\n\nimport CisTrans from './cis_trans'\nimport Dfs from './dfs'\nimport Stereocenters from './stereocenters'\n\nexport function Smiles() {\n  this.smiles = ''\n  this.writtenAtoms = []\n  this.writtenComponents = 0\n\n  this.ignoreErrors = false\n}\n\nSmiles._Atom = function (hCount) {\n  // eslint-disable-line no-underscore-dangle\n  this.neighbours = [] // Array of integer pairs {a, b}\n  this.aromatic = false // has aromatic bond\n  this.lowercase = false // aromatic and has to be written lowercase\n  this.chirality = 0 // 0 means no chirality, 1 means CCW pyramid, 2 means CW pyramid\n  this.branch_cnt = 0 // runs from 0 to (branches - 1)\n  this.paren_written = false\n  this.h_count = hCount\n  this.parent = -1\n}\n\n// NB: only loops of length up to 6 are included here\nSmiles.prototype.isBondInRing = function (bid) {\n  return this.inLoop[bid]\n}\n\nSmiles.prototype.saveMolecule = function (struct, ignoreErrors) {\n  // eslint-disable-line max-statements\n  var i, j, k\n\n  if (!ignoreErrors) this.ignoreErrors = ignoreErrors\n\n  // [RB]: KETCHER-498 (Incorrect smile-string for multiple Sgroup)\n  // TODO the fix is temporary, still need to implement error handling/reporting\n  // BEGIN\n  struct = struct.clone(\n    undefined,\n    undefined,\n    !struct.hasRxnArrow(), // make it drop multiple reactions\n    undefined,\n    undefined,\n    undefined\n  )\n  struct.initHalfBonds()\n  struct.initNeighbors()\n  struct.sortNeighbors()\n  struct.setImplicitHydrogen()\n  struct.sgroups.forEach(sg => {\n    if (sg.type === 'MUL') {\n      try {\n        SGroup.prepareMulForSaving(sg, struct)\n      } catch (ex) {\n        throw Error('Bad s-group (' + ex.message + ')')\n      }\n    }\n    // 'SMILES data format doesn\\'t support s-groups'\n  })\n  // END\n\n  this.atoms = new Array(struct.atoms.size)\n\n  struct.atoms.forEach((atom, aid) => {\n    this.atoms[aid] = new Smiles._Atom(atom.implicitH) // eslint-disable-line no-underscore-dangle\n  })\n\n  // From the SMILES specification:\n  // Please note that only atoms on the following list\n  // can be considered aromatic: C, N, O, P, S, As, Se, and * (wildcard).\n  var allowedLowercase = ['B', 'C', 'N', 'O', 'P', 'S', 'Se', 'As']\n\n  // Detect atoms that have aromatic bonds and count neighbours\n  struct.bonds.forEach((bond, bid) => {\n    if (bond.type === Bond.PATTERN.TYPE.AROMATIC) {\n      this.atoms[bond.begin].aromatic = true\n      if (allowedLowercase.indexOf(struct.atoms.get(bond.begin).label) !== -1)\n        this.atoms[bond.begin].lowercase = true\n      this.atoms[bond.end].aromatic = true\n      if (allowedLowercase.indexOf(struct.atoms.get(bond.end).label) !== -1)\n        this.atoms[bond.end].lowercase = true\n    }\n    this.atoms[bond.begin].neighbours.push({ aid: bond.end, bid })\n    this.atoms[bond.end].neighbours.push({ aid: bond.begin, bid })\n  })\n\n  this.inLoop = (function () {\n    struct.prepareLoopStructure()\n    let bondsInLoops = new Pile()\n    struct.loops.forEach(loop => {\n      if (loop.hbs.length <= 6) {\n        const hbids = loop.hbs.map(hbid => struct.halfBonds.get(hbid).bid)\n        bondsInLoops = bondsInLoops.union(new Pile(hbids))\n      }\n    })\n    const inLoop = {}\n    bondsInLoops.forEach(bid => {\n      inLoop[bid] = 1\n    })\n    return inLoop\n  })()\n\n  this.touchedCistransbonds = 0\n  this.markCisTrans(struct)\n\n  var components = struct.getComponents()\n  var componentsAll = components.reactants.concat(components.products)\n\n  var walk = new Dfs(\n    struct,\n    this.atoms,\n    componentsAll,\n    components.reactants.length\n  )\n\n  walk.walk()\n  this.atoms.forEach(atom => {\n    atom.neighbours = []\n  })\n\n  // fill up neighbor lists for the stereocenters calculation\n  for (i = 0; i < walk.v_seq.length; i++) {\n    var seqEl = walk.v_seq[i]\n    var vIdx = seqEl.idx\n    var eIdx = seqEl.parent_edge\n    var vPrevIdx = seqEl.parent_vertex\n\n    if (eIdx >= 0) {\n      var atom = this.atoms[vIdx]\n\n      var openingCycles = walk.numOpeningCycles(eIdx)\n\n      for (j = 0; j < openingCycles; j++)\n        this.atoms[vPrevIdx].neighbours.push({ aid: -1, bid: -1 })\n\n      if (walk.edgeClosingCycle(eIdx)) {\n        for (k = 0; k < atom.neighbours.length; k++) {\n          if (atom.neighbours[k].aid === -1) {\n            // eslint-disable-line max-depth\n            atom.neighbours[k].aid = vPrevIdx\n            atom.neighbours[k].bid = eIdx\n            break\n          }\n        }\n        if (k === atom.neighbours.length)\n          throw new Error('internal: can not put closing bond to its place')\n      } else {\n        atom.neighbours.push({ aid: vPrevIdx, bid: eIdx })\n        atom.parent = vPrevIdx\n      }\n      this.atoms[vPrevIdx].neighbours.push({ aid: vIdx, bid: eIdx })\n    }\n  }\n\n  try {\n    // detect chiral configurations\n    var stereocenters = new Stereocenters(\n      struct,\n      function (idx) {\n        return this.atoms[idx].neighbours\n      },\n      this\n    )\n    stereocenters.buildFromBonds(this.ignoreErrors)\n\n    stereocenters.each((sc, atomIdx) => {\n      // eslint-disable-line max-statements\n      // if (sc.type < MoleculeStereocenters::ATOM_AND)\n      //    continue;\n\n      var implicitHIdx = -1\n\n      if (sc.pyramid[3] == -1) implicitHIdx = 3\n      /*\n\t\t\telse for (j = 0; j < 4; j++)\n\t\t\t\tif (ignored_vertices[pyramid[j]])\n\t\t\t\t{\n\t\t\t\t\timplicit_h_idx = j;\n\t\t\t\t\tbreak;\n\t\t\t\t}\n\t\t\t\t*/\n\n      var pyramidMapping = []\n      var counter = 0\n\n      var atom = this.atoms[atomIdx]\n\n      if (atom.parent != -1) {\n        for (k = 0; k < 4; k++) {\n          if (sc.pyramid[k] == atom.parent) {\n            pyramidMapping[counter++] = k\n            break\n          }\n        }\n      }\n\n      if (implicitHIdx !== -1) pyramidMapping[counter++] = implicitHIdx\n\n      for (j = 0; j !== atom.neighbours.length; j++) {\n        if (atom.neighbours[j].aid == atom.parent) continue // eslint-disable-line no-continue\n\n        for (k = 0; k < 4; k++) {\n          if (atom.neighbours[j].aid == sc.pyramid[k]) {\n            if (counter >= 4) throw new Error('internal: pyramid overflow')\n            pyramidMapping[counter++] = k\n            break\n          }\n        }\n      }\n\n      if (counter === 4) {\n        // move the 'from' atom to the end\n        counter = pyramidMapping[0]\n        pyramidMapping[0] = pyramidMapping[1]\n        pyramidMapping[1] = pyramidMapping[2]\n        pyramidMapping[2] = pyramidMapping[3]\n        pyramidMapping[3] = counter\n      } else if (counter !== 3) {\n        throw new Error('cannot calculate chirality')\n      }\n\n      if (Stereocenters.isPyramidMappingRigid(pyramidMapping))\n        this.atoms[atomIdx].chirality = 1\n      else this.atoms[atomIdx].chirality = 2\n    })\n  } catch (ex) {\n    //TODO: add error handler call\n  }\n\n  // write the SMILES itself\n\n  // cycle_numbers[i] == -1 means that the number is available\n  // cycle_numbers[i] == n means that the number is used by vertex n\n  var cycleNumbers = []\n\n  cycleNumbers.push(0) // never used\n\n  var firstComponent = true\n\n  for (i = 0; i < walk.v_seq.length; i++) {\n    seqEl = walk.v_seq[i]\n    vIdx = seqEl.idx\n    eIdx = seqEl.parent_edge\n    vPrevIdx = seqEl.parent_vertex\n    var writeAtom = true\n\n    if (vPrevIdx >= 0) {\n      if (walk.numBranches(vPrevIdx) > 1) {\n        if (\n          this.atoms[vPrevIdx].branch_cnt > 0 &&\n          this.atoms[vPrevIdx].paren_written\n        )\n          this.smiles += ')'\n      }\n\n      openingCycles = walk.numOpeningCycles(eIdx)\n\n      for (j = 0; j < openingCycles; j++) {\n        for (k = 1; k < cycleNumbers.length; k++) {\n          if (cycleNumbers[k] == -1)\n            // eslint-disable-line max-depth\n            break\n        }\n        if (k === cycleNumbers.length) cycleNumbers.push(vPrevIdx)\n        else cycleNumbers[k] = vPrevIdx\n\n        this.writeCycleNumber(k)\n      }\n\n      if (vPrevIdx >= 0) {\n        var branches = walk.numBranches(vPrevIdx)\n\n        if (branches > 1 && this.atoms[vPrevIdx].branch_cnt < branches - 1) {\n          if (walk.edgeClosingCycle(eIdx)) {\n            // eslint-disable-line max-depth\n            this.atoms[vPrevIdx].paren_written = false\n          } else {\n            this.smiles += '('\n            this.atoms[vPrevIdx].paren_written = true\n          }\n        }\n\n        this.atoms[vPrevIdx].branch_cnt++\n\n        if (this.atoms[vPrevIdx].branch_cnt > branches)\n          throw new Error('unexpected branch')\n      }\n\n      var bond = struct.bonds.get(eIdx)\n\n      var dir = 0\n\n      if (bond.type == Bond.PATTERN.TYPE.SINGLE)\n        dir = this.calcBondDirection(struct, eIdx, vPrevIdx)\n\n      if ((dir == 1 && vIdx == bond.end) || (dir == 2 && vIdx == bond.begin))\n        this.smiles += '/'\n      else if (\n        (dir == 2 && vIdx == bond.end) ||\n        (dir == 1 && vIdx == bond.begin)\n      )\n        this.smiles += '\\\\'\n      else if (bond.type == Bond.PATTERN.TYPE.ANY) {\n        this.smiles += '~'\n      } else if (bond.type == Bond.PATTERN.TYPE.DOUBLE) {\n        this.smiles += '='\n      } else if (bond.type == Bond.PATTERN.TYPE.TRIPLE) {\n        this.smiles += '#'\n      } else if (bond.type == Bond.PATTERN.TYPE.SINGLE_OR_AROMATIC) {\n        this.smiles += '-,:'\n      } else if (bond.type == Bond.PATTERN.TYPE.DOUBLE_OR_AROMATIC) {\n        this.smiles += '=,:'\n      } else if (bond.type == Bond.PATTERN.TYPE.SINGLE_OR_DOUBLE) {\n        this.smiles += '-,='\n      } else if (\n        bond.type == Bond.PATTERN.TYPE.AROMATIC &&\n        (!this.atoms[bond.begin].lowercase ||\n          !this.atoms[bond.end].lowercase ||\n          !this.isBondInRing(eIdx))\n      )\n        this.smiles += ':'\n      // TODO: Check if this : is needed\n      else if (\n        bond.type == Bond.PATTERN.TYPE.SINGLE &&\n        this.atoms[bond.begin].aromatic &&\n        this.atoms[bond.end].aromatic\n      )\n        this.smiles += '-'\n\n      if (walk.edgeClosingCycle(eIdx)) {\n        for (j = 1; j < cycleNumbers.length; j++) {\n          if (cycleNumbers[j] == vIdx) break\n        }\n\n        if (j === cycleNumbers.length) throw new Error('cycle number not found')\n\n        this.writeCycleNumber(j)\n\n        cycleNumbers[j] = -1\n        writeAtom = false\n      }\n    } else {\n      if (!firstComponent) {\n        this.smiles +=\n          this.writtenComponents === walk.nComponentsInReactants &&\n          walk.nReactants !== 0\n            ? '>>'\n            : '.' // when walk.nReactants === 0 - not reaction\n      }\n      firstComponent = false\n      this.writtenComponents++\n    }\n    if (writeAtom) {\n      this.writeAtom(\n        struct,\n        vIdx,\n        this.atoms[vIdx].aromatic,\n        this.atoms[vIdx].lowercase,\n        this.atoms[vIdx].chirality\n      )\n      this.writtenAtoms.push(seqEl.idx)\n    }\n  }\n\n  this.comma = false\n\n  // this._writeStereogroups(mol, atoms);\n  this.writeRadicals(struct)\n  // this._writePseudoAtoms(mol);\n  // this._writeHighlighting();\n\n  if (this.comma) this.smiles += '|'\n\n  return this.smiles\n}\n\nSmiles.prototype.writeCycleNumber = function (n) {\n  if (n > 0 && n < 10) this.smiles += n\n  else if (n >= 10 && n < 100) this.smiles += '%' + n\n  else if (n >= 100 && n < 1000) this.smiles += '%%' + n\n  else throw new Error('bad cycle number: ' + n)\n}\n\nSmiles.prototype.writeAtom = function (\n  mol,\n  idx,\n  aromatic,\n  lowercase,\n  chirality\n) {\n  // eslint-disable-line max-params, max-statements\n  var atom = mol.atoms.get(idx)\n  var needBrackets = false\n  var hydro = -1\n  var aam = 0\n\n  /*\n\tif (mol.haveQueryAtoms())\n\t{\n\t  query_atom = &mol.getQueryAtom(idx);\n\n\t  if (query_atom->type == QUERY_ATOM_RGROUP)\n\t  {\n\t\t if (mol.getRGroups()->isRGroupAtom(idx))\n\t\t {\n\t\t\tconst Array<int> &rg = mol.getRGroups()->getSiteRGroups(idx);\n\n\t\t\tif (rg.length != 1)\n\t\t\t   throw Error(\"rgroup count %d\", rg.length);\n\n\t\t\t_output.printf(\"[&%d]\", rg[0] + 1);\n\t\t }\n\t\t else\n\t\t\t_output.printf(\"[&%d]\", 1);\n\n\t\t return;\n\t  }\n\t}\n\t*/\n\n  if (atom.label === 'A') {\n    this.smiles += '*'\n    return\n  }\n\n  if (atom.label === 'R' || atom.label === 'R#') {\n    this.smiles += '[*]'\n    return\n  }\n\n  // KETCHER-598 (Ketcher does not save AAM into reaction SMILES)\n  // BEGIN\n  //    if (this.atom_atom_mapping)\n  //        aam = atom_atom_mapping[idx];\n  aam = atom.aam\n  // END\n\n  if (\n    atom.label !== 'C' &&\n    atom.label !== 'P' &&\n    atom.label !== 'N' &&\n    atom.label !== 'S' &&\n    atom.label !== 'O' &&\n    atom.label !== 'Cl' &&\n    atom.label !== 'F' &&\n    atom.label !== 'Br' &&\n    atom.label !== 'B' &&\n    atom.label !== 'I'\n  )\n    needBrackets = true\n\n  if (\n    atom.explicitValence >= 0 ||\n    atom.radical !== 0 ||\n    chirality > 0 ||\n    (aromatic && atom.label !== 'C' && atom.label !== 'O') ||\n    (aromatic &&\n      atom.label === 'C' &&\n      this.atoms[idx].neighbours.length < 3 &&\n      this.atoms[idx].h_count === 0)\n  )\n    hydro = this.atoms[idx].h_count\n\n  var label = atom.label\n  if (atom.atomList && !atom.atomList.notList) {\n    label = atom.atomList.label()\n    needBrackets = false // atom list label already has brackets\n  } else if (atom.isPseudo() || (atom.atomList && atom.atomList.notList)) {\n    label = '*'\n    needBrackets = false\n  } else if (\n    chirality ||\n    atom.charge !== 0 ||\n    atom.isotope > 0 ||\n    hydro >= 0 ||\n    aam > 0\n  ) {\n    needBrackets = true\n  }\n\n  if (needBrackets) {\n    if (hydro === -1) hydro = this.atoms[idx].h_count\n    this.smiles += '['\n  }\n\n  if (atom.isotope > 0) this.smiles += atom.isotope\n\n  if (lowercase) this.smiles += label.toLowerCase()\n  else this.smiles += label\n\n  if (chirality > 0) {\n    if (chirality === 1) this.smiles += '@'\n    // chirality == 2\n    else this.smiles += '@@'\n\n    if (atom.implicitH > 1)\n      throw new Error(atom.implicitH + ' implicit H near stereocenter')\n  }\n\n  if (atom.label !== 'H') {\n    if (hydro > 1 || (hydro === 0 && !needBrackets)) this.smiles += 'H' + hydro\n    else if (hydro === 1) this.smiles += 'H'\n  }\n\n  if (atom.charge > 1) this.smiles += '+' + atom.charge\n  else if (atom.charge < -1) this.smiles += atom.charge\n  else if (atom.charge === 1) this.smiles += '+'\n  else if (atom.charge === -1) this.smiles += '-'\n\n  if (aam > 0) this.smiles += ':' + aam\n\n  if (needBrackets) this.smiles += ']'\n\n  /*\n\tif (mol.getRGroupFragment() != 0)\n\t{\n\t  for (i = 0; i < 2; i++)\n\t  {\n\t\t int j;\n\n\t\t for (j = 0; mol.getRGroupFragment()->getAttachmentPoint(i, j) != -1; j++)\n\t\t\tif (idx == mol.getRGroupFragment()->getAttachmentPoint(i, j))\n\t\t\t{\n\t\t\t   _output.printf(\"([*])\");\n\t\t\t   break;\n\t\t\t}\n\n\t\t if (mol.getRGroupFragment()->getAttachmentPoint(i, j) != -1)\n\t\t\tbreak;\n\t  }\n\t}\n\t*/\n}\n\nSmiles.prototype.markCisTrans = function (mol) {\n  this.cis_trans = new CisTrans(\n    mol,\n    function (idx) {\n      return this.atoms[idx].neighbours\n    },\n    this\n  )\n  this.cis_trans.build()\n  this.dbonds = new Array(mol.bonds.size)\n\n  mol.bonds.forEach((bond, bid) => {\n    this.dbonds[bid] = {\n      ctbond_beg: -1,\n      ctbond_end: -1,\n      saved: 0\n    }\n  })\n\n  this.cis_trans.each((ct, bid) => {\n    var bond = mol.bonds.get(bid)\n\n    if (ct.parity !== 0 && !this.isBondInRing(bid)) {\n      var neiBeg = this.atoms[bond.begin].neighbours\n      var neiEnd = this.atoms[bond.end].neighbours\n      var aromFailBeg = true\n      var aromFailEnd = true\n\n      neiBeg.forEach(nei => {\n        if (\n          nei.bid !== bid &&\n          mol.bonds.get(nei.bid).type === Bond.PATTERN.TYPE.SINGLE\n        )\n          aromFailBeg = false\n      })\n\n      neiEnd.forEach(nei => {\n        if (\n          nei.bid !== bid &&\n          mol.bonds.get(nei.bid).type === Bond.PATTERN.TYPE.SINGLE\n        )\n          aromFailEnd = false\n      })\n\n      if (aromFailBeg || aromFailEnd) return\n\n      neiBeg.forEach(nei => {\n        if (nei.bid === bid) return\n        if (mol.bonds.get(nei.bid).begin === bond.begin)\n          this.dbonds[nei.bid].ctbond_beg = bid\n        else this.dbonds[nei.bid].ctbond_end = bid\n      })\n\n      neiEnd.forEach(nei => {\n        if (nei.bid === bid) return\n        if (mol.bonds.get(nei.bid).begin === bond.end)\n          this.dbonds[nei.bid].ctbond_beg = bid\n        else this.dbonds[nei.bid].ctbond_end = bid\n      })\n    }\n  })\n}\n\nSmiles.prototype.updateSideBonds = function (mol, bondIdx) {\n  // eslint-disable-line max-statements\n  var bond = mol.bonds.get(bondIdx)\n  var subst = this.cis_trans.getSubstituents(bondIdx)\n  var parity = this.cis_trans.getParity(bondIdx)\n\n  var sidebonds = [-1, -1, -1, -1]\n\n  sidebonds[0] = mol.findBondId(subst[0], bond.begin)\n  if (subst[1] != -1) sidebonds[1] = mol.findBondId(subst[1], bond.begin)\n\n  sidebonds[2] = mol.findBondId(subst[2], bond.end)\n  if (subst[3] != -1) sidebonds[3] = mol.findBondId(subst[3], bond.end)\n\n  var n1 = 0\n  var n2 = 0\n  var n3 = 0\n  var n4 = 0\n\n  if (this.dbonds[sidebonds[0]].saved != 0) {\n    if (\n      (this.dbonds[sidebonds[0]].saved == 1 &&\n        mol.bonds.get(sidebonds[0]).begin == bond.begin) ||\n      (this.dbonds[sidebonds[0]].saved == 2 &&\n        mol.bonds.get(sidebonds[0]).end == bond.begin)\n    )\n      n1++\n    else n2++\n  }\n  if (sidebonds[1] != -1 && this.dbonds[sidebonds[1]].saved != 0) {\n    if (\n      (this.dbonds[sidebonds[1]].saved == 2 &&\n        mol.bonds.get(sidebonds[1]).begin == bond.begin) ||\n      (this.dbonds[sidebonds[1]].saved == 1 &&\n        mol.bonds.get(sidebonds[1]).end == bond.begin)\n    )\n      n1++\n    else n2++\n  }\n  if (this.dbonds[sidebonds[2]].saved != 0) {\n    if (\n      (this.dbonds[sidebonds[2]].saved == 1 &&\n        mol.bonds.get(sidebonds[2]).begin == bond.end) ||\n      (this.dbonds[sidebonds[2]].saved == 2 &&\n        mol.bonds.get(sidebonds[2]).end == bond.end)\n    )\n      n3++\n    else n4++\n  }\n  if (sidebonds[3] != -1 && this.dbonds[sidebonds[3]].saved != 0) {\n    if (\n      (this.dbonds[sidebonds[3]].saved == 2 &&\n        mol.bonds.get(sidebonds[3]).begin == bond.end) ||\n      (this.dbonds[sidebonds[3]].saved == 1 &&\n        mol.bonds.get(sidebonds[3]).end == bond.end)\n    )\n      n3++\n    else n4++\n  }\n\n  if (parity == CisTrans.PARITY.CIS) {\n    n1 += n3\n    n2 += n4\n  } else {\n    n1 += n4\n    n2 += n3\n  }\n\n  if (n1 > 0 && n2 > 0) throw new Error('incompatible cis-trans configuration')\n\n  if (n1 === 0 && n2 === 0) return false\n\n  if (n1 > 0) {\n    this.dbonds[sidebonds[0]].saved =\n      mol.bonds.get(sidebonds[0]).begin == bond.begin ? 1 : 2\n    if (sidebonds[1] != -1) {\n      this.dbonds[sidebonds[1]].saved =\n        mol.bonds.get(sidebonds[1]).begin == bond.begin ? 2 : 1\n    }\n\n    this.dbonds[sidebonds[2]].saved =\n      (mol.bonds.get(sidebonds[2]).begin == bond.end) ==\n      (parity == CisTrans.PARITY.CIS)\n        ? 1\n        : 2\n    if (sidebonds[3] != -1) {\n      this.dbonds[sidebonds[3]].saved =\n        (mol.bonds.get(sidebonds[3]).begin == bond.end) ==\n        (parity == CisTrans.PARITY.CIS)\n          ? 2\n          : 1\n    }\n  }\n  if (n2 > 0) {\n    this.dbonds[sidebonds[0]].saved =\n      mol.bonds.get(sidebonds[0]).begin == bond.begin ? 2 : 1\n    if (sidebonds[1] != -1) {\n      this.dbonds[sidebonds[1]].saved =\n        mol.bonds.get(sidebonds[1]).begin == bond.begin ? 1 : 2\n    }\n\n    this.dbonds[sidebonds[2]].saved =\n      (mol.bonds.get(sidebonds[2]).begin == bond.end) ==\n      (parity == CisTrans.PARITY.CIS)\n        ? 2\n        : 1\n    if (sidebonds[3] != -1) {\n      this.dbonds[sidebonds[3]].saved =\n        (mol.bonds.get(sidebonds[3]).begin == bond.end) ==\n        (parity == CisTrans.PARITY.CIS)\n          ? 1\n          : 2\n    }\n  }\n\n  return true\n}\n\nSmiles.prototype.calcBondDirection = function (mol, idx, vprev) {\n  var ntouched\n\n  if (this.dbonds[idx].ctbond_beg == -1 && this.dbonds[idx].ctbond_end == -1)\n    return 0\n\n  if (mol.bonds.get(idx).type != Bond.PATTERN.TYPE.SINGLE)\n    throw new Error('internal: directed bond type ' + mol.bonds.get(idx).type)\n\n  while (true) {\n    // eslint-disable-line no-constant-condition\n    ntouched = 0\n    this.cis_trans.each((ct, bid) => {\n      if (ct.parity !== 0 && !this.isBondInRing(bid)) {\n        if (this.updateSideBonds(mol, bid)) ntouched++\n      }\n    })\n    if (ntouched === this.touchedCistransbonds) break\n    this.touchedCistransbonds = ntouched\n  }\n\n  if (this.dbonds[idx].saved === 0) {\n    if (vprev === mol.bonds.get(idx).begin) this.dbonds[idx].saved = 1\n    else this.dbonds[idx].saved = 2\n  }\n\n  return this.dbonds[idx].saved\n}\n\nSmiles.prototype.writeRadicals = function (mol) {\n  // eslint-disable-line max-statements\n  var marked = new Array(this.writtenAtoms.length)\n  var i, j\n\n  for (i = 0; i < this.writtenAtoms.length; i++) {\n    if (marked[i]) continue // eslint-disable-line no-continue\n\n    var radical = mol.atoms.get(this.writtenAtoms[i]).radical\n\n    if (radical === 0) continue // eslint-disable-line no-continue\n\n    if (this.comma) {\n      this.smiles += ','\n    } else {\n      this.smiles += ' |'\n      this.comma = true\n    }\n\n    if (radical == Atom.PATTERN.RADICAL.SINGLET) this.smiles += '^3:'\n    else if (radical == Atom.PATTERN.RADICAL.DOUPLET) this.smiles += '^1:'\n    // RADICAL_TRIPLET\n    else this.smiles += '^4:'\n\n    this.smiles += i\n\n    for (j = i + 1; j < this.writtenAtoms.length; j++) {\n      if (mol.atoms.get(this.writtenAtoms[j]).radical === radical) {\n        marked[j] = true\n        this.smiles += ',' + j\n      }\n    }\n  }\n}\n","/****************************************************************************\n * Copyright 2021 EPAM Systems\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *    http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n ***************************************************************************/\n\nimport { Serializer } from '../serializers.types'\nimport { SmiSerializerOptions } from './smi.types'\nimport { Smiles } from './smiles'\nimport { Struct } from 'domain/entities'\n\nexport class SmiSerializer implements Serializer<Struct> {\n  static DefaultOptions: SmiSerializerOptions = {\n    ignoreErrors: false\n  }\n\n  private readonly options: SmiSerializerOptions\n\n  constructor(options?: Partial<SmiSerializerOptions>) {\n    this.options = { ...SmiSerializer.DefaultOptions, ...options }\n  }\n\n  deserialize(_content: string): Struct {\n    throw new Error('Not implemented yet.')\n  }\n\n  serialize(struct: Struct): string {\n    return new Smiles().saveMolecule(struct, this.options.ignoreErrors)\n  }\n}\n","/****************************************************************************\n * Copyright 2021 EPAM Systems\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *    http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n ***************************************************************************/\n\nimport { SdfItem, StructAssociatedData } from './sdf.types'\n\nimport { MolSerializer } from '../mol/molSerializer'\nimport { Serializer } from '../serializers.types'\n\nconst DelimeterRegex = /^[^]+?\\$\\$\\$\\$$/gm\nexport class SdfSerializer implements Serializer<Array<SdfItem>> {\n  deserialize(content: string): Array<SdfItem> {\n    let m: any\n    const result: Array<SdfItem> = []\n    const molSerializer = new MolSerializer()\n    while ((m = DelimeterRegex.exec(content)) !== null) {\n      const chunk = m[0].replace(/\\r/g, '').trim() // TODO: normalize newline?\n      var end = chunk.indexOf('M  END')\n      if (end !== -1) {\n        const propChunks: any = chunk\n          .substr(end + 7)\n          .trim()\n          .split(/^$\\n?/m)\n\n        const struct = molSerializer.deserialize(chunk.substring(0, end + 6))\n        const props = propChunks.reduce(\n          (acc: StructAssociatedData, pc: string) => {\n            var m = pc.match(/^> [ \\d]*<(\\S+)>/)\n            if (m) {\n              const field = m[1]\n              const value = pc.split('\\n')[1].trim()\n              acc[field] = Number.isFinite(value) ? +value : value.toString() // eslint-disable-line\n            }\n            return acc\n          },\n          {} as StructAssociatedData\n        )\n\n        result.push({ struct, props })\n      }\n    }\n    return result\n  }\n\n  serialize(sdfItems: Array<SdfItem>): string {\n    const molSerializer = new MolSerializer()\n    return sdfItems.reduce((res, item) => {\n      res += molSerializer.serialize(item.struct)\n\n      Object.keys(item.props).forEach(prop => {\n        res += '> <' + prop + '>\\n'\n        res += item.props[prop] + '\\n\\n'\n      })\n\n      return res + '$$$$'\n    }, '')\n  }\n}\n","/****************************************************************************\n * Copyright 2021 EPAM Systems\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *    http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n ***************************************************************************/\n\nexport enum ChemicalMimeType {\n  Mol = 'chemical/x-mdl-molfile',\n  Rxn = 'chemical/x-mdl-rxnfile',\n  DaylightSmiles = 'chemical/x-daylight-smiles',\n  ExtendedSmiles = 'chemical/x-chemaxon-cxsmiles',\n  DaylightSmarts = 'chemical/x-daylight-smarts',\n  InChI = 'chemical/x-inchi',\n  InChIAuxInfo = 'chemical/x-inchi-aux',\n  CDXML = 'chemical/x-cdxml',\n  CML = 'chemical/x-cml',\n  KET = 'chemical/x-indigo-ket'\n}\n\nexport interface WithStruct {\n  struct: string\n}\n\nexport interface WithFormat {\n  format: ChemicalMimeType\n}\n\nexport interface WithOutputFormat {\n  output_format: ChemicalMimeType\n}\n\nexport interface WithSelection {\n  selected?: Array<number>\n}\n\nexport interface CheckData extends WithStruct {\n  types: Array<string>\n}\n\nexport interface CheckResult {\n  [key: string]: string\n}\n\nexport interface ConvertData extends WithStruct, WithOutputFormat {}\n\nexport interface ConvertResult extends WithStruct, WithFormat {}\n\nexport interface LayoutData extends WithStruct, WithOutputFormat {}\n\nexport interface LayoutResult extends WithStruct, WithFormat {}\n\nexport interface CleanData\n  extends WithStruct,\n    WithSelection,\n    WithOutputFormat {}\n\nexport interface CleanResult extends WithStruct, WithFormat {}\n\nexport interface AromatizeData extends WithStruct, WithOutputFormat {}\n\nexport interface AromatizeResult extends WithStruct, WithFormat {}\n\nexport interface DearomatizeData extends WithStruct, WithOutputFormat {}\n\nexport interface DearomatizeResult extends WithStruct, WithFormat {}\n\nexport interface CalculateCipData extends WithStruct, WithOutputFormat {}\n\nexport interface CalculateCipResult extends WithStruct, WithFormat {}\n\nexport interface CalculateData extends WithStruct, WithSelection {\n  properties: Array<string>\n}\n\nexport interface CalculateResult {\n  [key: string]: string | number | boolean\n}\n\nexport interface AutomapData extends WithStruct, WithOutputFormat {\n  mode: string\n}\n\nexport interface AutomapResult extends WithStruct, WithFormat {}\n\nexport interface InfoResult {\n  indigoVersion: string\n  imagoVersions: Array<string>\n  isAvailable: boolean\n}\n\nexport interface RecognizeResult extends WithStruct, WithOutputFormat {}\n\nexport interface StructServiceOptions {\n  [key: string]: string | number | boolean | undefined\n}\n\nexport type OutputFormatType = 'png' | 'svg'\nexport interface GenerateImageOptions extends StructServiceOptions {\n  outputFormat: OutputFormatType\n  backgroundColor?: string\n}\n\nexport interface StructService {\n  info: () => Promise<InfoResult>\n  convert: (\n    data: ConvertData,\n    options?: StructServiceOptions\n  ) => Promise<ConvertResult>\n  layout: (\n    data: LayoutData,\n    options?: StructServiceOptions\n  ) => Promise<LayoutResult>\n  clean: (\n    data: CleanData,\n    options?: StructServiceOptions\n  ) => Promise<CleanResult>\n  aromatize: (\n    data: AromatizeData,\n    options?: StructServiceOptions\n  ) => Promise<AromatizeResult>\n  dearomatize: (\n    data: DearomatizeData,\n    options?: StructServiceOptions\n  ) => Promise<DearomatizeResult>\n  calculateCip: (\n    data: CalculateCipData,\n    options?: StructServiceOptions\n  ) => Promise<CalculateCipResult>\n  automap: (\n    data: AutomapData,\n    options?: StructServiceOptions\n  ) => Promise<AutomapResult>\n  check: (\n    data: CheckData,\n    options?: StructServiceOptions\n  ) => Promise<CheckResult>\n  calculate: (\n    data: CalculateData,\n    options?: StructServiceOptions\n  ) => Promise<CalculateResult>\n  recognize: (blob: Blob, version: string) => Promise<RecognizeResult>\n  generateImageAsBase64: (\n    data: string,\n    options?: GenerateImageOptions\n  ) => Promise<string>\n}\n","/****************************************************************************\n * Copyright 2021 EPAM Systems\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *    http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n ***************************************************************************/\n\nimport {\n  AromatizeData,\n  AromatizeResult,\n  AutomapData,\n  AutomapResult,\n  CalculateCipData,\n  CalculateCipResult,\n  CalculateData,\n  CalculateResult,\n  CheckData,\n  CheckResult,\n  CleanData,\n  CleanResult,\n  ConvertData,\n  ConvertResult,\n  DearomatizeData,\n  DearomatizeResult,\n  GenerateImageOptions,\n  InfoResult,\n  LayoutData,\n  LayoutResult,\n  OutputFormatType,\n  RecognizeResult,\n  StructService,\n  StructServiceOptions\n} from 'domain/services'\n\nfunction pollDeferred(process, complete, timeGap, startTimeGap) {\n  return new Promise((resolve, reject) => {\n    function iterate() {\n      process().then(\n        val => {\n          try {\n            if (complete(val)) resolve(val)\n            else setTimeout(iterate, timeGap)\n          } catch (e) {\n            reject(e)\n          }\n        },\n        err => reject(err)\n      )\n    }\n    setTimeout(iterate, startTimeGap || 0)\n  })\n}\n\nfunction parametrizeUrl(url, params) {\n  return url.replace(/:(\\w+)/g, (_, val) => params[val])\n}\n\nfunction request(\n  method: string,\n  url: string,\n  data?: any,\n  headers?: any,\n  responseHandler?: (promise: Promise<any>) => Promise<any>\n) {\n  let requestUrl = url\n  if (data && method === 'GET') requestUrl = parametrizeUrl(url, data)\n  let response: any = fetch(requestUrl, {\n    method,\n    headers: Object.assign(\n      {\n        Accept: 'application/json'\n      },\n      headers\n    ),\n    body: method !== 'GET' ? data : undefined,\n    credentials: 'same-origin'\n  })\n\n  if (responseHandler) {\n    response = responseHandler(response)\n  } else {\n    response = response.then(response =>\n      response\n        .json()\n        .then(res => (response.ok ? res : Promise.reject(res.error)))\n    )\n  }\n\n  return response\n}\n\nfunction indigoCall(\n  method: string,\n  url: string,\n  baseUrl: string,\n  defaultOptions: any\n) {\n  return function (\n    data,\n    options,\n    responseHandler?: (promise: Promise<any>) => Promise<any>\n  ) {\n    const body = Object.assign({}, data)\n    body.options = Object.assign(body.options || {}, defaultOptions, options)\n    return request(\n      method,\n      baseUrl + url,\n      JSON.stringify(body),\n      {\n        'Content-Type': 'application/json'\n      },\n      responseHandler\n    )\n  }\n}\n\nexport class RemoteStructService implements StructService {\n  private readonly apiPath: string\n  private readonly defaultOptions: StructServiceOptions\n\n  constructor(apiPath: string, defaultOptions: StructServiceOptions) {\n    this.apiPath = apiPath\n    this.defaultOptions = defaultOptions\n  }\n\n  async info(): Promise<InfoResult> {\n    let indigoVersion: string\n    let imagoVersions: Array<string>\n    let isAvailable: boolean = false\n\n    try {\n      const response = await request('GET', this.apiPath + 'info')\n      indigoVersion = response['indigo_version']\n      imagoVersions = response['imago_versions']\n      isAvailable = true\n    } catch (e) {\n      indigoVersion = ''\n      imagoVersions = []\n      isAvailable = false\n    }\n\n    return {\n      indigoVersion,\n      imagoVersions,\n      isAvailable\n    }\n  }\n\n  convert(\n    data: ConvertData,\n    options?: StructServiceOptions\n  ): Promise<ConvertResult> {\n    return indigoCall(\n      'POST',\n      'indigo/convert',\n      this.apiPath,\n      this.defaultOptions\n    )(data, options)\n  }\n\n  layout(\n    data: LayoutData,\n    options?: StructServiceOptions\n  ): Promise<LayoutResult> {\n    return indigoCall(\n      'POST',\n      'indigo/layout',\n      this.apiPath,\n      this.defaultOptions\n    )(data, options)\n  }\n\n  clean(data: CleanData, options?: StructServiceOptions): Promise<CleanResult> {\n    return indigoCall(\n      'POST',\n      'indigo/clean',\n      this.apiPath,\n      this.defaultOptions\n    )(data, options)\n  }\n\n  aromatize(\n    data: AromatizeData,\n    options?: StructServiceOptions\n  ): Promise<AromatizeResult> {\n    return indigoCall(\n      'POST',\n      'indigo/aromatize',\n      this.apiPath,\n      this.defaultOptions\n    )(data, options)\n  }\n\n  dearomatize(\n    data: DearomatizeData,\n    options?: StructServiceOptions\n  ): Promise<DearomatizeResult> {\n    return indigoCall(\n      'POST',\n      'indigo/dearomatize',\n      this.apiPath,\n      this.defaultOptions\n    )(data, options)\n  }\n\n  calculateCip(\n    data: CalculateCipData,\n    options?: StructServiceOptions\n  ): Promise<CalculateCipResult> {\n    return indigoCall(\n      'POST',\n      'indigo/calculate_cip',\n      this.apiPath,\n      this.defaultOptions\n    )(data, options)\n  }\n\n  automap(\n    data: AutomapData,\n    options?: StructServiceOptions\n  ): Promise<AutomapResult> {\n    return indigoCall(\n      'POST',\n      'indigo/automap',\n      this.apiPath,\n      this.defaultOptions\n    )(data, options)\n  }\n\n  check(data: CheckData, options?: StructServiceOptions): Promise<CheckResult> {\n    return indigoCall(\n      'POST',\n      'indigo/check',\n      this.apiPath,\n      this.defaultOptions\n    )(data, options)\n  }\n\n  calculate(\n    data: CalculateData,\n    options?: StructServiceOptions\n  ): Promise<CalculateResult> {\n    return indigoCall(\n      'POST',\n      'indigo/calculate',\n      this.apiPath,\n      this.defaultOptions\n    )(data, options)\n  }\n\n  recognize(blob: Blob, version: string): Promise<RecognizeResult> {\n    const parVersion = version ? `?version=${version}` : ''\n    const req = request(\n      'POST',\n      this.apiPath + `imago/uploads${parVersion}`,\n      blob,\n      {\n        'Content-Type': blob.type || 'application/octet-stream'\n      }\n    )\n    const status = request.bind(null, 'GET', this.apiPath + 'imago/uploads/:id')\n    return req\n      .then(data =>\n        pollDeferred(\n          status.bind(null, { id: data.upload_id }),\n          (response: any) => {\n            if (response.state === 'FAILURE') throw response\n            return response.state === 'SUCCESS'\n          },\n          500,\n          300\n        )\n      )\n      .then((response: any) => ({ struct: response.metadata.mol_str }))\n  }\n\n  generateImageAsBase64(\n    data: string,\n    options?: GenerateImageOptions\n  ): Promise<string> {\n    const outputFormat: OutputFormatType = options?.outputFormat || 'png'\n    return indigoCall(\n      'POST',\n      'indigo/render',\n      this.apiPath,\n      this.defaultOptions\n    )({ struct: data }, { 'render-output-format': outputFormat }, response =>\n      response.then(resp => resp.text())\n    )\n  }\n}\n","/****************************************************************************\n * Copyright 2021 EPAM Systems\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *    http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n ***************************************************************************/\n\nimport {\n  ServiceMode,\n  StructService,\n  StructServiceOptions,\n  StructServiceProvider\n} from 'domain/services'\n\nimport { RemoteStructService } from './remoteStructService'\n\nexport class RemoteStructServiceProvider implements StructServiceProvider {\n  private readonly apiPath: string\n  mode: ServiceMode = 'remote'\n\n  constructor(apiPath: string) {\n    let currentApiPath = apiPath\n    const params = new URLSearchParams(document.location.search)\n    if (params.has('api_path')) {\n      currentApiPath = params.get('api_path')!\n    }\n    this.apiPath =\n      !currentApiPath || /\\/$/.test(currentApiPath)\n        ? currentApiPath\n        : currentApiPath + '/'\n  }\n\n  createStructService(options: StructServiceOptions): StructService {\n    return new RemoteStructService(this.apiPath, options)\n  }\n}\n","/****************************************************************************\n * Copyright 2021 EPAM Systems\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *    http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n ***************************************************************************/\n\nimport { ChemicalMimeType } from 'domain/services'\n\nexport class SupportedFormatProperties {\n  name: string\n  mime: ChemicalMimeType\n  extensions: string[]\n  supportsCoords?: boolean\n  options?: any\n\n  constructor(\n    name: string,\n    mime: ChemicalMimeType,\n    extensions: string[],\n    supportsCoords?: boolean,\n    options?: any\n  ) {\n    this.name = name\n    this.mime = mime\n    this.extensions = extensions\n    this.supportsCoords = supportsCoords || false\n    this.options = options || {}\n  }\n}\n","/****************************************************************************\n * Copyright 2021 EPAM Systems\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *    http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n ***************************************************************************/\n\nimport { ChemicalMimeType } from 'domain/services'\nimport { SupportedFormat } from './structFormatter.types'\nimport { SupportedFormatProperties } from './supportedFormatProperties'\n\ntype FormatPropertiesMap = {\n  [key in SupportedFormat]: SupportedFormatProperties\n}\n\nconst formatProperties: FormatPropertiesMap = {\n  mol: new SupportedFormatProperties(\n    'MDL Molfile V2000',\n    ChemicalMimeType.Mol,\n    ['.mol'],\n    true\n  ),\n  molV3000: new SupportedFormatProperties(\n    'MDL Molfile V3000',\n    ChemicalMimeType.Mol,\n    ['.mol'],\n    true,\n    { 'molfile-saving-mode': '3000' }\n  ),\n  rxn: new SupportedFormatProperties(\n    'MDL Rxnfile V2000',\n    ChemicalMimeType.Rxn,\n    ['.rxn'],\n    true\n  ),\n  rxnV3000: new SupportedFormatProperties(\n    'MDL Rxnfile V3000',\n    ChemicalMimeType.Rxn,\n    ['.rxn'],\n    true,\n    { 'molfile-saving-mode': '3000' }\n  ),\n  smiles: new SupportedFormatProperties(\n    'Daylight SMILES',\n    ChemicalMimeType.DaylightSmiles,\n    ['.smi', '.smiles']\n  ),\n  smilesExt: new SupportedFormatProperties(\n    'Extended SMILES',\n    ChemicalMimeType.ExtendedSmiles,\n    ['.cxsmi', '.cxsmiles']\n  ),\n  smarts: new SupportedFormatProperties(\n    'Daylight SMARTS',\n    ChemicalMimeType.DaylightSmarts,\n    ['.smarts']\n  ),\n  inChI: new SupportedFormatProperties('InChI', ChemicalMimeType.InChI, [\n    '.inchi'\n  ]),\n  inChIAuxInfo: new SupportedFormatProperties(\n    'InChI AuxInfo',\n    ChemicalMimeType.InChIAuxInfo,\n    ['.inchi']\n  ),\n  cml: new SupportedFormatProperties(\n    'CML',\n    ChemicalMimeType.CML,\n    ['.cml', '.mrv'],\n    true\n  ),\n  ket: new SupportedFormatProperties('Ket Format', ChemicalMimeType.KET, [\n    '.ket'\n  ]),\n  cdxml: new SupportedFormatProperties(\n    'CDXML',\n    ChemicalMimeType.CDXML,\n    ['.cdxml'],\n    true\n  )\n}\n\nfunction getPropertiesByFormat(format: SupportedFormat) {\n  return formatProperties[format]\n}\n\nexport { formatProperties, getPropertiesByFormat }\n","/****************************************************************************\n * Copyright 2021 EPAM Systems\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *    http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n ***************************************************************************/\n\nimport { KetSerializer } from 'domain/serializers'\nimport { Struct } from 'domain/entities'\nimport { StructFormatter } from './structFormatter.types'\n\nexport class KetFormatter implements StructFormatter {\n  constructor(private readonly serializer: KetSerializer) {}\n\n  async getStructureFromStructAsync(struct: Struct): Promise<string> {\n    const ket = this.serializer.serialize(struct)\n    return ket\n  }\n\n  async getStructureFromStringAsync(content: string): Promise<Struct> {\n    return this.serializer.deserialize(content)\n  }\n}\n","/****************************************************************************\n * Copyright 2021 EPAM Systems\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *    http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n ***************************************************************************/\n\nimport { MolSerializer } from 'domain/serializers'\nimport { Struct } from 'domain/entities'\nimport { StructFormatter } from './structFormatter.types'\n\nexport class MolfileV2000Formatter implements StructFormatter {\n  constructor(private readonly molfileManager: MolSerializer) {}\n\n  async getStructureFromStructAsync(struct: Struct): Promise<string> {\n    const stringifiedMolfile = this.molfileManager.serialize(struct)\n    return stringifiedMolfile\n  }\n\n  async getStructureFromStringAsync(\n    stringifiedStruct: string\n  ): Promise<Struct> {\n    const struct = this.molfileManager.deserialize(stringifiedStruct)\n    return struct\n  }\n}\n","/****************************************************************************\n * Copyright 2021 EPAM Systems\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *    http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n ***************************************************************************/\n\nimport { MolSerializer } from 'domain/serializers'\nimport { Struct } from 'domain/entities'\nimport { StructFormatter } from './structFormatter.types'\n\nexport class RxnFormatter implements StructFormatter {\n  constructor(private readonly molfileManager: MolSerializer) {}\n\n  async getStructureFromStructAsync(struct: Struct): Promise<string> {\n    const stringifiedMolfile = this.molfileManager.serialize(struct)\n    return stringifiedMolfile\n  }\n\n  async getStructureFromStringAsync(\n    stringifiedStruct: string\n  ): Promise<Struct> {\n    const struct = this.molfileManager.deserialize(stringifiedStruct)\n    return struct\n  }\n}\n","/****************************************************************************\n * Copyright 2021 EPAM Systems\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *    http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n ***************************************************************************/\n\nexport enum LayerMap {\n  background = 'background',\n  selectionPlate = 'selectionPlate',\n  hovering = 'hovering',\n  warnings = 'warnings',\n  data = 'data',\n  indices = 'indices'\n}\n\nexport enum StereoColoringType {\n  LabelsOnly = 'LabelsOnly',\n  BondsOnly = 'BondsOnly',\n  LabelsAndBonds = 'LabelsAndBonds',\n  Off = 'Off'\n}\n\nexport enum StereLabelStyleType {\n  IUPAC = 'Iupac',\n  Classic = 'Classic',\n  On = 'On',\n  Off = 'Off'\n}\n","/****************************************************************************\n * Copyright 2021 EPAM Systems\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *    http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n ***************************************************************************/\n\nimport {\n  ConvertData,\n  ConvertResult,\n  LayoutData,\n  LayoutResult,\n  StructService,\n  StructServiceOptions\n} from 'domain/services'\nimport { StructFormatter, SupportedFormat } from './structFormatter.types'\n\nimport { KetSerializer } from 'domain/serializers'\nimport { Struct } from 'domain/entities'\nimport { getPropertiesByFormat } from './formatProperties'\n\nexport class ServerFormatter implements StructFormatter {\n  constructor(\n    private readonly structService: StructService,\n    private readonly ketSerializer: KetSerializer,\n    private readonly format: SupportedFormat,\n    private readonly options?: StructServiceOptions\n  ) {}\n\n  async getStructureFromStructAsync(struct: Struct): Promise<string> {\n    const infoResult = await this.structService.info()\n    if (!infoResult.isAvailable) {\n      throw new Error('Server is not available')\n    }\n\n    const formatProperties = getPropertiesByFormat(this.format)\n\n    try {\n      const stringifiedStruct = this.ketSerializer.serialize(struct)\n      const convertResult = await this.structService.convert(\n        {\n          struct: stringifiedStruct,\n          output_format: formatProperties.mime\n        },\n        { ...this.options, ...formatProperties.options }\n      )\n\n      return convertResult.struct\n    } catch (error: any) {\n      let message\n      if (error.message === 'Server is not compatible') {\n        message = `${formatProperties.name} is not supported.`\n      } else {\n        message = `Convert error!\\n${error.message || error}`\n      }\n\n      throw new Error(message)\n    }\n  }\n\n  async getStructureFromStringAsync(\n    stringifiedStruct: string\n  ): Promise<Struct> {\n    const infoResult = await this.structService.info()\n    if (!infoResult.isAvailable) {\n      throw new Error('Server is not available')\n    }\n\n    type ConvertPromise = (\n      data: ConvertData,\n      options?: StructServiceOptions\n    ) => Promise<ConvertResult>\n\n    type LayoutPromise = (\n      data: LayoutData,\n      options?: StructServiceOptions\n    ) => Promise<LayoutResult>\n\n    let promise: LayoutPromise | ConvertPromise\n\n    let data: ConvertData | LayoutData = {\n      struct: undefined as any,\n      output_format: getPropertiesByFormat('ket').mime\n    }\n\n    const withCoords = getPropertiesByFormat(this.format).supportsCoords\n    if (withCoords) {\n      promise = this.structService.convert\n      data.struct = stringifiedStruct\n    } else {\n      promise = this.structService.layout\n      data.struct = stringifiedStruct.trim()\n    }\n\n    try {\n      const result = await promise(data, this.options)\n      const parsedStruct = this.ketSerializer.deserialize(result.struct)\n      if (!withCoords) {\n        parsedStruct.rescale()\n      }\n      return parsedStruct\n    } catch (error: any) {\n      if (error.message !== 'Server is not compatible') {\n        throw Error(`Convert error!\\n${error.message || error}`)\n      }\n\n      const formatError =\n        this.format === 'smiles'\n          ? `${getPropertiesByFormat('smilesExt').name} and opening of ${\n              getPropertiesByFormat('smiles').name\n            }`\n          : getPropertiesByFormat(this.format).name\n\n      throw Error(`${formatError} is not supported in standalone mode.`)\n    }\n  }\n}\n","/****************************************************************************\n * Copyright 2021 EPAM Systems\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *    http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n ***************************************************************************/\n\nimport { KetSerializer, SmiSerializer } from 'domain/serializers'\nimport { StructFormatter, SupportedFormat } from './structFormatter.types'\nimport { StructService, StructServiceOptions } from 'domain/services'\n\nimport { ServerFormatter } from './serverFormatter'\nimport { Struct } from 'domain/entities'\n\nexport class SmilesFormatter implements StructFormatter {\n  constructor(\n    private readonly smiSerializer: SmiSerializer,\n\n    // only for ServerFormatter\n\n    private readonly structService: StructService,\n    private readonly ketSerializer: KetSerializer,\n    private readonly format: SupportedFormat,\n    private readonly options?: StructServiceOptions\n  ) {}\n\n  async getStructureFromStructAsync(struct: Struct): Promise<string> {\n    const stringifiedMolfile = this.smiSerializer.serialize(struct)\n    return stringifiedMolfile\n  }\n\n  getStructureFromStringAsync(stringifiedStruct: string): Promise<Struct> {\n    const serverFormatter = new ServerFormatter(\n      this.structService,\n      this.ketSerializer,\n      this.format,\n      this.options\n    )\n\n    return serverFormatter.getStructureFromStringAsync(stringifiedStruct)\n  }\n}\n","/****************************************************************************\n * Copyright 2021 EPAM Systems\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *    http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n ***************************************************************************/\n\nimport {\n  FormatterFactoryOptions,\n  StructFormatter,\n  SupportedFormat\n} from './structFormatter.types'\nimport {\n  KetSerializer,\n  MolSerializer,\n  MolSerializerOptions,\n  SmiSerializer\n} from 'domain/serializers'\nimport { StructService, StructServiceOptions } from 'domain/services'\n\nimport { KetFormatter } from './ketFormatter'\nimport { MolfileV2000Formatter } from './molfileV2000Formatter'\nimport { RxnFormatter } from './rxnFormatter'\nimport { ServerFormatter } from './serverFormatter'\nimport { SmilesFormatter } from './smilesFormatter'\n\nexport class FormatterFactory {\n  constructor(private readonly structService: StructService) {}\n\n  private separateOptions(\n    options?: FormatterFactoryOptions\n  ): [Partial<MolSerializerOptions>, StructServiceOptions | {}] {\n    if (!options) {\n      return [{}, {}]\n    }\n\n    const { reactionRelayout, badHeaderRecover, ...structServiceOptions } =\n      options\n\n    let molfileParseOptions: Partial<MolSerializerOptions> = {}\n\n    if (typeof reactionRelayout === 'boolean') {\n      molfileParseOptions.reactionRelayout = reactionRelayout\n    }\n    if (typeof badHeaderRecover === 'boolean') {\n      molfileParseOptions.badHeaderRecover = badHeaderRecover\n    }\n\n    return [molfileParseOptions, structServiceOptions]\n  }\n\n  create(\n    format: SupportedFormat,\n    options?: FormatterFactoryOptions\n  ): StructFormatter {\n    const [molSerializerOptions, structServiceOptions] =\n      this.separateOptions(options)\n\n    let formatter: StructFormatter\n    switch (format) {\n      case 'ket':\n        formatter = new KetFormatter(new KetSerializer())\n        break\n\n      case 'mol':\n        formatter = new MolfileV2000Formatter(\n          new MolSerializer(molSerializerOptions)\n        )\n        break\n\n      case 'rxn':\n        formatter = new RxnFormatter(new MolSerializer(molSerializerOptions))\n        break\n\n      case 'smiles':\n        formatter = new SmilesFormatter(\n          new SmiSerializer(),\n\n          // only for ServerFormatter, because 'getStructureFromStringAsync' is delegated to it\n\n          this.structService,\n          new KetSerializer(),\n          format,\n          structServiceOptions\n        )\n        break\n\n      case 'cml':\n      case 'inChIAuxInfo':\n      case 'inChI':\n      case 'molV3000':\n      case 'rxnV3000':\n      case 'smilesExt':\n      case 'smarts':\n      case 'cdxml':\n      default:\n        formatter = new ServerFormatter(\n          this.structService,\n          new KetSerializer(),\n          format,\n          structServiceOptions\n        )\n    }\n\n    return formatter\n  }\n}\n","/****************************************************************************\n * Copyright 2021 EPAM Systems\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *    http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n ***************************************************************************/\n\nimport { SupportedFormat } from './structFormatter.types'\n\nexport function identifyStructFormat(\n  stringifiedStruct: string\n): SupportedFormat {\n  // Mimic Indigo/molecule_auto_loader.cpp as much as possible\n  const sanitizedString = stringifiedStruct.trim()\n\n  try {\n    if (JSON.parse(sanitizedString)) {\n      return 'ket'\n    }\n  } catch (er) {} // eslint-disable-line\n\n  if (sanitizedString.indexOf('$RXN') !== -1) {\n    return 'rxn'\n  }\n\n  if (sanitizedString.indexOf('V3000') !== -1) {\n    return 'molV3000'\n  }\n\n  const match = sanitizedString.match(/^(M {2}END|\\$END MOL)$/m)\n\n  if (match) {\n    const end = (match.index || 0) + match[0].length\n    if (\n      end === sanitizedString.length ||\n      sanitizedString.slice(end, end + 20).search(/^\\$(MOL|END CTAB)$/m) !== -1\n    ) {\n      return 'mol'\n    }\n  }\n  if (\n    sanitizedString[0] === '<' &&\n    sanitizedString.indexOf('<molecule') !== -1\n  ) {\n    return 'cml'\n  }\n\n  if (sanitizedString.slice(0, 5) === 'InChI') {\n    return 'inChI'\n  }\n\n  if (sanitizedString.indexOf('\\n') === -1) {\n    // TODO: smiles regexp\n    return 'smiles'\n  }\n\n  if (sanitizedString.indexOf('<CDXML') !== -1) {\n    return 'cdxml'\n  }\n  // Molfile by default as Indigo does\n  return 'mol'\n}\n","/****************************************************************************\n * Copyright 2021 EPAM Systems\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *    http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n ***************************************************************************/\n\n// Single entry point to Rapha√´l library\n\nimport Raphael from 'raphael'\nimport { Vec2 } from 'domain/entities'\n\n// TODO: refactor ugly prototype extensions to plain old functions\nRaphael.el.translateAbs = function (x, y) {\n  this.delta = this.delta || new Vec2()\n  this.delta.x += x - 0\n  this.delta.y += y - 0\n  this.transform('t' + this.delta.x.toString() + ',' + this.delta.y.toString())\n}\n\nRaphael.st.translateAbs = function (x, y) {\n  this.forEach(el => {\n    el.translateAbs(x, y)\n  })\n}\n\nexport default Raphael\n","/****************************************************************************\n * Copyright 2021 EPAM Systems\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *    http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n ***************************************************************************/\n\n// Visel is a shorthand for VISual ELement\n// It corresponds to a visualization (i.e. set of paths) of an atom or a bond.\nimport { Box2Abs, Vec2 } from 'domain/entities'\n\nclass Visel {\n  constructor(type) {\n    this.type = type\n    this.paths = []\n    this.boxes = []\n    this.boundingBox = null\n    this.exts = []\n  }\n  add(path, bb, ext) {\n    this.paths.push(path)\n    if (bb) {\n      this.boxes.push(bb)\n      this.boundingBox =\n        this.boundingBox == null ? bb : Box2Abs.union(this.boundingBox, bb)\n    }\n    if (ext) this.exts.push(ext)\n  }\n  clear() {\n    this.paths = []\n    this.boxes = []\n    this.exts = []\n    this.boundingBox = null\n  }\n  translate(...args) {\n    if (args.length > 2)\n      // TODO: replace to debug time assert\n      throw new Error('One vector or two scalar arguments expected')\n    if (args.length === 1) {\n      const vector = args[0]\n      this.translate(vector.x, vector.y)\n    } else {\n      const x = args[0]\n      const y = args[1]\n      var delta = new Vec2(x, y)\n      for (var i = 0; i < this.paths.length; ++i)\n        this.paths[i].translateAbs(x, y)\n      for (var j = 0; j < this.boxes.length; ++j)\n        this.boxes[j] = this.boxes[j].translate(delta)\n      if (this.boundingBox !== null)\n        this.boundingBox = this.boundingBox.translate(delta)\n    }\n  }\n}\n\nexport default Visel\n","/****************************************************************************\n * Copyright 2021 EPAM Systems\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *    http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n ***************************************************************************/\n\nimport { Box2Abs } from 'domain/entities'\nimport ReStruct from './restruct'\nimport { Render } from '../raphaelRender'\nimport { Scale } from 'domain/helpers'\nimport Visel from './visel'\n\nclass ReObject {\n  public visel: Visel\n  public hover = false\n  public hovering: any = null\n  public selected = false\n  public selectionPlate: any = null\n\n  constructor(viselType: string) {\n    this.visel = new Visel(viselType)\n  }\n\n  getVBoxObj(render: Render): Box2Abs | null {\n    var vbox = this.visel.boundingBox\n    if (vbox === null) return null\n    if (render.options.offset)\n      vbox = vbox.translate(render.options.offset.negated())\n    return vbox.transform(Scale.scaled2obj, render.options)\n  }\n\n  setHover(hover: boolean, render: Render): void {\n    // TODO render should be field\n    if (hover) {\n      let noredraw = 'hovering' in this && this.hovering !== null // && !this.highlighting.removed;\n      if (noredraw) {\n        if (this.hovering.type === 'set') {\n          if (!this.hovering[0]) return\n          noredraw = !this.hovering[0].removed\n        } else {\n          noredraw = !this.hovering.removed\n        }\n      }\n      if (noredraw) {\n        this.hovering.show()\n      } else {\n        render.paper.setStart()\n        this.drawHover(render)\n        this.hovering = render.paper.setFinish()\n      }\n    } else if (this.hovering) {\n      this.hovering.hide()\n    }\n\n    this.hover = hover\n  }\n\n  drawHover(_render: Render): any {\n    throw new Error('ReObject.drawHover is not overridden.')\n  }\n\n  // @ts-ignore\n  makeSelectionPlate(restruct: ReStruct, paper: any, styles: any): any {\n    throw new Error('ReObject.makeSelectionPlate is not overridden')\n  }\n}\n\nexport default ReObject\n","/****************************************************************************\n * Copyright 2021 EPAM Systems\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *    http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n ***************************************************************************/\n\nimport { Vec2 } from 'domain/entities'\nimport assert from 'assert'\n\nfunction tfx(v) {\n  return parseFloat(v).toFixed(8)\n}\n\nfunction relBox(box) {\n  return {\n    x: box.x,\n    y: box.y,\n    width: box.width,\n    height: box.height\n  }\n}\n\n/**\n * Finds intersection of a ray and a box and\n * Returns the shift magnitude to avoid it\n * @param p { Vec2 }\n * @param d { Vec2 }\n * @param bb { Box2Abs }\n */\nfunction shiftRayBox(p, d, bb) {\n  assert(!!p)\n  assert(!!d)\n  assert(!!bb)\n\n  // four corner points of the box\n  const b = [\n    bb.p0,\n    new Vec2(bb.p1.x, bb.p0.y),\n    bb.p1,\n    new Vec2(bb.p0.x, bb.p1.y)\n  ]\n\n  const r = b.map(v => v.sub(p)) // b relative to p\n\n  d = d.normalized()\n\n  const rc = r.map(v => Vec2.cross(v, d)) // cross prods\n  const rd = r.map(v => Vec2.dot(v, d)) // dot prods\n\n  // find foremost points on the right and on the left of the ray\n  let pid = -1\n  let nid = -1\n\n  for (let i = 0; i < 4; ++i) {\n    if (rc[i] > 0) {\n      if (pid < 0 || rd[pid] < rd[i]) pid = i\n    } else if (nid < 0 || rd[nid] < rd[i]) {\n      nid = i\n    }\n  }\n\n  if (nid < 0 || pid < 0)\n    // no intersection, no shift\n    return 0\n\n  // check the order\n  const id0 = rd[pid] > rd[nid] ? nid : pid\n  const id1 = rd[pid] > rd[nid] ? pid : nid\n\n  // simple proportion to calculate the shift\n  /* eslint-disable no-mixed-operators*/\n  return (\n    rd[id0] +\n    (Math.abs(rc[id0]) * (rd[id1] - rd[id0])) /\n      (Math.abs(rc[id0]) + Math.abs(rc[id1]))\n  )\n}\n\nconst util = {\n  tfx,\n  relBox,\n  shiftRayBox\n}\n\nexport default util\n","/****************************************************************************\n * Copyright 2021 EPAM Systems\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *    http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n ***************************************************************************/\n\nimport { RxnArrowMode, Vec2 } from 'domain/entities'\n\nimport Raphael from './raphael-ext'\nimport svgPath from 'svgpath'\nimport util from './util'\n\nconst tfx = util.tfx\n\nfunction rectangle(paper, pos, options) {\n  return paper.rect(\n    tfx(Math.min(pos[0].x, pos[1].x)),\n    tfx(Math.min(pos[0].y, pos[1].y)),\n    tfx(Math.abs(pos[1].x - pos[0].x)),\n    tfx(Math.abs(pos[1].y - pos[0].y))\n  )\n}\n\nfunction rectangleWithAngle(paper, a, b, length, angle, options) {\n  const wOffset = 5\n  const hOffset = 8\n\n  const b0x = a.x + length\n\n  const path =\n    `M${tfx(a.x - wOffset)},${tfx(a.y)}` +\n    `L${tfx(a.x - wOffset)},${tfx(a.y + hOffset)}` +\n    `L${tfx(b0x + wOffset)},${tfx(a.y + hOffset)}` +\n    `L${tfx(b0x + wOffset)},${tfx(a.y - hOffset)}` +\n    `L${tfx(a.x - wOffset)},${tfx(a.y - hOffset)}Z`\n\n  const transformedPath = svgPath(path).rotate(angle, a.x, a.y).toString()\n\n  return transformedPath\n}\n\nfunction ellipse(paper, pos, options) {\n  const rad = Vec2.diff(pos[1], pos[0])\n  const rx = rad.x / 2\n  const ry = rad.y / 2\n  return paper.ellipse(pos[0].x + rx, pos[0].y + ry, Math.abs(rx), Math.abs(ry))\n}\n\nfunction polyline(paper, pos, options) {\n  let path = ['M', pos[0].x, pos[0].y]\n  for (let i = 1; i < pos.length; i++) path.push('L', pos[i].x, pos[i].y)\n  return paper.path(path)\n}\n\nfunction line(paper, pos, options) {\n  let path = ['M', pos[0].x, pos[0].y]\n  path.push('L', pos[1].x, pos[1].y)\n  return paper.path(path)\n}\n\nfunction arrow(paper, startPoint, endPoint, length, angle, options, type) {\n  switch (type) {\n    case RxnArrowMode.OpenAngle: {\n      return arrowOpenAngle(paper, startPoint, endPoint, length, angle, options)\n    }\n    case RxnArrowMode.FilledTriangle: {\n      return arrowFilledTriangle(\n        paper,\n        startPoint,\n        endPoint,\n        length,\n        angle,\n        options\n      )\n    }\n    case RxnArrowMode.FilledBow: {\n      return arrowFilledBow(paper, startPoint, endPoint, length, angle, options)\n    }\n    case RxnArrowMode.DashedOpenAngle: {\n      return arrowDashedOpenAngle(\n        paper,\n        startPoint,\n        endPoint,\n        length,\n        angle,\n        options\n      )\n    }\n    case RxnArrowMode.Failed: {\n      return arrowFailed(paper, startPoint, endPoint, length, angle, options)\n    }\n    case RxnArrowMode.BothEndsFilledTriangle: {\n      return arrowBothEndsFilledTriangle(\n        paper,\n        startPoint,\n        endPoint,\n        length,\n        angle,\n        options\n      )\n    }\n    case RxnArrowMode.EquilibriumFilledHalfBow: {\n      return arrowEquilibriumFilledHalfBow(\n        paper,\n        startPoint,\n        endPoint,\n        length,\n        angle,\n        options\n      )\n    }\n    case RxnArrowMode.EquilibriumFilledTriangle: {\n      return arrowEquilibriumFilledTriangle(\n        paper,\n        startPoint,\n        endPoint,\n        length,\n        angle,\n        options\n      )\n    }\n    case RxnArrowMode.EquilibriumOpenAngle: {\n      return arrowEquilibriumOpenAngle(\n        paper,\n        startPoint,\n        endPoint,\n        length,\n        angle,\n        options\n      )\n    }\n    case RxnArrowMode.UnbalancedEquilibriumFilledHalfBow: {\n      return arrowUnbalancedEquilibriumFilledHalfBow(\n        paper,\n        startPoint,\n        endPoint,\n        length,\n        angle,\n        options\n      )\n    }\n    case RxnArrowMode.UnbalancedEquilibriumOpenHalfAngle: {\n      return arrowUnbalancedEquilibriumOpenHalfAngle(\n        paper,\n        startPoint,\n        endPoint,\n        length,\n        angle,\n        options\n      )\n    }\n    case RxnArrowMode.UnbalancedEquilibriumLargeFilledHalfBow: {\n      return arrowUnbalancedEquilibriumLargeFilledHalfBow(\n        paper,\n        startPoint,\n        endPoint,\n        length,\n        angle,\n        options\n      )\n    }\n    case RxnArrowMode.UnbalancedEquilibriumFilleHalfTriangle: {\n      return arrowUnbalancedEquilibriumFilleHalfTriangle(\n        paper,\n        startPoint,\n        endPoint,\n        length,\n        angle,\n        options\n      )\n    }\n  }\n}\n\nfunction arrowOpenAngle(paper, a, b, arrowLength, arrowAngle, options) {\n  const width = 5\n  const length = 7\n\n  const b0x = a.x + arrowLength\n\n  const path =\n    `M${tfx(a.x)},${tfx(a.y)}` +\n    `L${tfx(b0x)},${tfx(a.y)}` +\n    `L${tfx(b0x - length)},${tfx(a.y - width)}` +\n    `M${tfx(b0x)},${tfx(a.y)}` +\n    `L${tfx(b0x - length)}, ${tfx(a.y + width)}`\n\n  const transformedPath = svgPath(path).rotate(arrowAngle, a.x, a.y).toString()\n\n  return paper.path(transformedPath).attr(options.lineattr)\n}\n\nfunction arrowFilledTriangle(paper, a, b, arrowLength, arrowAngle, options) {\n  const triangleLength = 10\n  const triangleWidth = 5\n\n  const b0x = a.x + arrowLength\n\n  const path =\n    `M${tfx(a.x)},${tfx(a.y)}` +\n    `L${tfx(b0x)},${tfx(a.y)}` +\n    `L${tfx(b0x - triangleLength)},${tfx(a.y + triangleWidth)}` +\n    `L${tfx(b0x - triangleLength)},${tfx(a.y - triangleWidth)}` +\n    `L${tfx(b0x)},${tfx(a.y)}Z`\n\n  const transformedPath = svgPath(path).rotate(arrowAngle, a.x, a.y).toString()\n\n  return paper.path(transformedPath).attr({ ...options.lineattr, fill: '#000' })\n}\n\nfunction arrowFilledBow(paper, a, b, arrowLength, arrowAngle, options) {\n  const arrowHeadLength = 10\n  const arrowHeadWidth = 5\n  const arrowHeadAttr = 4\n\n  const b0x = a.x + arrowLength\n\n  const path =\n    `M${tfx(a.x)},${tfx(a.y)}` +\n    `L${tfx(b0x)},${tfx(a.y)}` +\n    `L${tfx(b0x - arrowHeadLength)},${tfx(a.y + arrowHeadWidth)}` +\n    `L${tfx(b0x - arrowHeadLength + arrowHeadAttr)},${tfx(a.y)}` +\n    `L${tfx(b0x - arrowHeadLength)},${tfx(a.y - arrowHeadWidth)}` +\n    `L${tfx(b0x)},${tfx(a.y)}Z`\n\n  const transformedPath = svgPath(path).rotate(arrowAngle, a.x, a.y).toString()\n\n  return paper.path(transformedPath).attr({ ...options.lineattr, fill: '#000' })\n}\n\nfunction arrowDashedOpenAngle(paper, a, b, arrowLength, arrowAngle, options) {\n  const triangleLength = 10\n  const triangleWidth = 5\n  const dashInterval = 3.5\n\n  const path = []\n\n  const b0x = a.x + arrowLength\n\n  // Dashed arrow\n  for (let i = 0; i < arrowLength / dashInterval; i++) {\n    if (i % 2) {\n      path.push(`L${tfx(a.x + i * dashInterval)},${tfx(a.y)}`)\n    } else {\n      path.push(`M${tfx(a.x + i * dashInterval)},${tfx(a.y)}`)\n    }\n  }\n\n  // Arrowhead\n  path.push(\n    `M${tfx(b0x)},${tfx(a.y)}` +\n      `L${tfx(b0x - triangleLength)},${tfx(a.y + triangleWidth)}` +\n      `M${tfx(b0x)},${tfx(a.y)}` +\n      `L${tfx(b0x - triangleLength)},${tfx(a.y - triangleWidth)}`\n  )\n\n  const transformedPath = svgPath(path.join(''))\n    .rotate(arrowAngle, a.x, a.y)\n    .toString()\n\n  return paper.path(transformedPath).attr({ ...options.lineattr, fill: '#000' })\n}\n\nfunction arrowFailed(paper, a, b, arrowLength, arrowAngle, options) {\n  const arrowHeadLength = 10\n  const arrowHeadWidth = 5\n  const arrowHeadAttr = 4\n  const failSignWidth = 8\n\n  const b0x = a.x + arrowLength\n\n  const arrowCenter = b0x - (b0x - a.x) / 2\n\n  const path = []\n\n  // Arrow with arrowhead\n  path.push(\n    `M${tfx(a.x)},${tfx(a.y)}` +\n      `L${tfx(b0x)},${tfx(a.y)}` +\n      `L${tfx(b0x - arrowHeadLength)},${tfx(a.y + arrowHeadWidth)}` +\n      `L${tfx(b0x - arrowHeadLength + arrowHeadAttr)},${tfx(a.y)}` +\n      `L${tfx(b0x - arrowHeadLength)},${tfx(a.y - arrowHeadWidth)}` +\n      `L${tfx(b0x)},${tfx(a.y)}Z`\n  )\n\n  // Failed sign line 1\n  path.push(\n    `M${tfx(arrowCenter + failSignWidth)},${tfx(a.y + failSignWidth)}` +\n      `L${tfx(arrowCenter - failSignWidth)},${tfx(a.y - failSignWidth)}`\n  )\n\n  // Failed sign line 2\n  path.push(\n    `M${tfx(arrowCenter + failSignWidth)},${tfx(a.y - failSignWidth)}` +\n      `L${tfx(arrowCenter - failSignWidth)},${tfx(a.y + failSignWidth)}`\n  )\n\n  const transformedPath = svgPath(path.join(''))\n    .rotate(arrowAngle, a.x, a.y)\n    .toString()\n\n  return paper.path(transformedPath).attr({ ...options.lineattr, fill: '#000' })\n}\n\nfunction arrowBothEndsFilledTriangle(\n  paper,\n  a,\n  b,\n  arrowLength,\n  arrowAngle,\n  options\n) {\n  const triangleLength = 10\n  const triangleWidth = 5\n\n  const b0x = a.x + arrowLength\n\n  const path =\n    `M${tfx(a.x)},${tfx(a.y)}` +\n    `L${tfx(b0x)},${tfx(a.y)}` +\n    `L${tfx(b0x - triangleLength)},${tfx(a.y + triangleWidth)}` +\n    `L${tfx(b0x - triangleLength)},${tfx(a.y - triangleWidth)}` +\n    `L${tfx(b0x)},${tfx(a.y)}` +\n    `M${tfx(a.x)},${tfx(a.y)}` +\n    `L${tfx(a.x + triangleLength)},${tfx(a.y - triangleWidth)}` +\n    `L${tfx(a.x + triangleLength)},${tfx(a.y + triangleWidth)}` +\n    `L${tfx(a.x)},${tfx(a.y)}`\n\n  const transformedPath = svgPath(path).rotate(arrowAngle, a.x, a.y).toString()\n\n  return paper.path(transformedPath).attr({ ...options.lineattr, fill: '#000' })\n}\n\nfunction arrowEquilibriumFilledHalfBow(\n  paper,\n  a,\n  b,\n  arrowLength,\n  arrowAngle,\n  options\n) {\n  const arrowLen = 9\n  const lineOffset = 3.5\n  const arrowOffset = 7\n  const arrowHeadAttr = 2\n\n  const b0x = a.x + arrowLength\n\n  const path = []\n\n  // Arrow\n  path.push(\n    `M${tfx(a.x)},${tfx(a.y - lineOffset)}` +\n      `L${tfx(b0x)},${tfx(a.y - lineOffset)}` +\n      `L${tfx(b0x - arrowLen)},${tfx(a.y - arrowOffset)}` +\n      `L${tfx(b0x - arrowLen + arrowHeadAttr)},${tfx(a.y - lineOffset)}Z`\n  )\n\n  // Arrowhead\n  path.push(\n    `M${tfx(b0x)},${tfx(a.y + lineOffset)}` +\n      `L${tfx(a.x)},${tfx(a.y + lineOffset)}` +\n      `L${tfx(a.x + arrowLen)},${tfx(a.y + arrowOffset)}` +\n      `L${tfx(a.x + arrowLen - arrowHeadAttr)},${a.y + lineOffset}Z`\n  )\n\n  const transformedPath = svgPath(path.join(''))\n    .rotate(arrowAngle, a.x, a.y)\n    .toString()\n\n  return paper.path(transformedPath).attr({ ...options.lineattr, fill: '#000' })\n}\n\nfunction arrowEquilibriumFilledTriangle(\n  paper,\n  a,\n  b,\n  arrowLength,\n  arrowAngle,\n  options\n) {\n  const arrowLen = 9\n  const lineOffset = 3.5\n  const arrowOffset = 7\n\n  const b0x = a.x + arrowLength\n\n  const path = []\n\n  // First arrow\n  path.push(\n    `M${tfx(a.x)},${tfx(a.y - lineOffset)}` +\n      `L${tfx(b0x)},${tfx(a.y - lineOffset)}` +\n      `L${tfx(b0x - arrowLen)},${tfx(a.y - arrowOffset)}` +\n      `L${tfx(b0x - arrowLen)},${tfx(a.y - lineOffset)}` +\n      `L${tfx(b0x - arrowLen)},${tfx(a.y)}` +\n      `L${tfx(b0x)},${tfx(a.y - lineOffset)}Z`\n  )\n\n  // Second arrow\n  path.push(\n    `M${tfx(a.x)},${tfx(a.y + lineOffset)}` +\n      `L${tfx(b0x)},${tfx(a.y + lineOffset)}` +\n      `M${tfx(a.x)},${tfx(a.y + lineOffset)}` +\n      `L${tfx(a.x + arrowLen)},${tfx(a.y + arrowOffset)}` +\n      `L${tfx(a.x + arrowLen)},${a.y + lineOffset}Z` +\n      `L${tfx(a.x + arrowLen)},${tfx(a.y)}` +\n      `L${tfx(a.x + arrowLen)},${a.y + lineOffset}Z`\n  )\n\n  const transformedPath = svgPath(path.join(''))\n    .rotate(arrowAngle, a.x, a.y)\n    .toString()\n\n  return paper.path(transformedPath).attr({ ...options.lineattr, fill: '#000' })\n}\n\nfunction arrowEquilibriumOpenAngle(\n  paper,\n  a,\n  b,\n  arrowLength,\n  arrowAngle,\n  options\n) {\n  const width = 5\n  const length = 7\n  const arrowLen = 9\n  const lineOffset = 3.5\n  const arrowOffset = 7\n\n  const b0x = a.x + arrowLength\n\n  const path = []\n\n  // First arrow\n  path.push(\n    `M${tfx(a.x)},${tfx(a.y - lineOffset)}` +\n      `L${tfx(b0x)},${tfx(a.y - lineOffset)}` +\n      `L${tfx(b0x - length)},${tfx(a.y - width - lineOffset)}`\n  )\n\n  // Second arrow\n  path.push(\n    `M${tfx(a.x)},${tfx(a.y + lineOffset)}` +\n      `L${tfx(b0x)},${tfx(a.y + lineOffset)}` +\n      `M${tfx(a.x)},${tfx(a.y + lineOffset)}` +\n      `L${tfx(a.x + arrowLen)},${tfx(a.y + lineOffset + width)}`\n  )\n\n  const transformedPath = svgPath(path.join(''))\n    .rotate(arrowAngle, a.x, a.y)\n    .toString()\n\n  return paper.path(transformedPath).attr(options.lineattr)\n}\n\nfunction arrowUnbalancedEquilibriumFilledHalfBow(\n  paper,\n  a,\n  b,\n  arrowLength,\n  arrowAngle,\n  options\n) {\n  const arrowLen = 9\n  const lineOffset = 3.5\n  const arrowOffset = 7\n  const arrowHeadAttr = 2\n  const unbalanceVal = 15\n\n  const b0x = a.x + arrowLength\n\n  const path = []\n\n  // First arrow\n  path.push(\n    `M${tfx(a.x)},${tfx(a.y - lineOffset)}` +\n      `L${tfx(b0x)},${tfx(a.y - lineOffset)}` +\n      `L${tfx(b0x - arrowLen)},${tfx(a.y - arrowOffset)}` +\n      `L${tfx(b0x - arrowLen + arrowHeadAttr)},${tfx(a.y - lineOffset)}Z`\n  )\n\n  // Second (Unbalanced) arrow\n  path.push(\n    `M${tfx(a.x + unbalanceVal)},${tfx(a.y + lineOffset)}` +\n      `L${tfx(b0x - unbalanceVal)},${tfx(a.y + lineOffset)}` +\n      `M${tfx(a.x + unbalanceVal)},${tfx(a.y + lineOffset)}` +\n      `L${tfx(a.x + arrowLen + unbalanceVal)},${tfx(a.y + arrowOffset)}` +\n      `L${tfx(a.x + arrowLen - arrowHeadAttr + unbalanceVal)},${\n        a.y + lineOffset\n      }Z`\n  )\n\n  const transformedPath = svgPath(path.join(''))\n    .rotate(arrowAngle, a.x, a.y)\n    .toString()\n\n  return paper.path(transformedPath).attr({ ...options.lineattr, fill: '#000' })\n}\n\nfunction arrowUnbalancedEquilibriumOpenHalfAngle(\n  paper,\n  a,\n  b,\n  arrowLength,\n  arrowAngle,\n  options\n) {\n  const width = 5\n  const length = 7\n  const arrowLen = 9\n  const lineOffset = 3.5\n  const arrowOffset = 7\n  const unbalanceVal = 15\n\n  const b0x = a.x + arrowLength\n\n  const path = []\n\n  // First arrow\n  path.push(\n    `M${tfx(a.x)},${tfx(a.y - lineOffset)}` +\n      `L${tfx(b0x)},${tfx(a.y - lineOffset)}` +\n      `L${tfx(b0x - length)},${tfx(a.y - width - lineOffset)}`\n  )\n\n  // Second (Unbalanced) arrow\n  path.push(\n    `M${tfx(a.x + unbalanceVal)},${tfx(a.y + lineOffset)}` +\n      `L${tfx(b0x - unbalanceVal)},${tfx(a.y + lineOffset)}` +\n      `M${tfx(a.x + unbalanceVal)},${tfx(a.y + lineOffset)}` +\n      `L${tfx(a.x + arrowLen + unbalanceVal)},${tfx(a.y + lineOffset + width)}`\n  )\n\n  const transformedPath = svgPath(path.join(''))\n    .rotate(arrowAngle, a.x, a.y)\n    .toString()\n\n  return paper.path(transformedPath).attr(options.lineattr)\n}\n\nfunction arrowUnbalancedEquilibriumLargeFilledHalfBow(\n  paper,\n  a,\n  b,\n  arrowLength,\n  arrowAngle,\n  options\n) {\n  const arrowLen = 9\n  const lineOffset = 3.5\n  const arrowOffset = 10\n  const arrowHeadAttr = 2\n  const unbalanceVal = 15\n\n  const b0x = a.x + arrowLength\n\n  const path = []\n\n  // First arrow\n  path.push(\n    `M${tfx(a.x)},${tfx(a.y - lineOffset)}` +\n      `L${tfx(b0x)},${tfx(a.y - lineOffset)}` +\n      `L${tfx(b0x - arrowLen)},${tfx(a.y - arrowOffset)}` +\n      `L${tfx(b0x - arrowLen + arrowHeadAttr)},${tfx(a.y - lineOffset)}Z`\n  )\n\n  // Second (Unbalanced) arrow\n  path.push(\n    `M${tfx(a.x + unbalanceVal)},${tfx(a.y + lineOffset)}` +\n      `L${tfx(b0x - unbalanceVal)},${tfx(a.y + lineOffset)}` +\n      `M${tfx(a.x + unbalanceVal)},${tfx(a.y + lineOffset)}` +\n      `L${tfx(a.x + arrowLen + unbalanceVal)},${tfx(a.y + arrowOffset)}` +\n      `L${tfx(a.x + arrowLen - arrowHeadAttr + unbalanceVal)},${\n        a.y + lineOffset\n      }Z`\n  )\n\n  const transformedPath = svgPath(path.join(''))\n    .rotate(arrowAngle, a.x, a.y)\n    .toString()\n\n  return paper.path(transformedPath).attr({ ...options.lineattr, fill: '#000' })\n}\n\nfunction arrowUnbalancedEquilibriumFilleHalfTriangle(\n  paper,\n  a,\n  b,\n  arrowLength,\n  arrowAngle,\n  options\n) {\n  const arrowLen = 9\n  const lineOffset = 3.5\n  const arrowOffset = 7\n  const unbalanceVal = 15\n\n  const b0x = a.x + arrowLength\n\n  const path = []\n\n  // First arrow\n  path.push(\n    `M${tfx(a.x)},${tfx(a.y - lineOffset)}` +\n      `L${tfx(b0x)},${tfx(a.y - lineOffset)}` +\n      `L${tfx(b0x - arrowLen)},${tfx(a.y - arrowOffset)}` +\n      `L${tfx(b0x - arrowLen)},${tfx(a.y - lineOffset)}Z`\n  )\n\n  // Second (Unbalanced) arrow\n  path.push(\n    `M${tfx(a.x + unbalanceVal)},${tfx(a.y + lineOffset)}` +\n      `L${tfx(b0x - unbalanceVal)},${tfx(a.y + lineOffset)}` +\n      `M${tfx(a.x + unbalanceVal)},${tfx(a.y + lineOffset)}` +\n      `L${tfx(a.x + arrowLen + unbalanceVal)},${tfx(a.y + arrowOffset)}` +\n      `L${tfx(a.x + arrowLen + unbalanceVal)},${a.y + lineOffset}Z`\n  )\n\n  const transformedPath = svgPath(path.join(''))\n    .rotate(arrowAngle, a.x, a.y)\n    .toString()\n\n  return paper.path(transformedPath).attr({ ...options.lineattr, fill: '#000' })\n}\n\nfunction plus(paper, c, options) {\n  var s = options.scale / 5\n  return paper\n    .path(\n      'M{0},{4}L{0},{5}M{2},{1}L{3},{1}',\n      tfx(c.x),\n      tfx(c.y),\n      tfx(c.x - s),\n      tfx(c.x + s),\n      tfx(c.y - s),\n      tfx(c.y + s)\n    )\n    .attr(options.lineattr)\n}\n\nfunction bondSingle(paper, hb1, hb2, options, color = '#000') {\n  var a = hb1.p,\n    b = hb2.p\n  return paper.path(makeStroke(a, b)).attr(options.lineattr).attr({\n    fill: color,\n    stroke: color\n  })\n}\n\nfunction bondSingleUp(paper, a, b2, b3, options, color = '#000') {\n  // eslint-disable-line max-params\n  return paper\n    .path(\n      'M{0},{1}L{2},{3}L{4},{5}Z',\n      tfx(a.x),\n      tfx(a.y),\n      tfx(b2.x),\n      tfx(b2.y),\n      tfx(b3.x),\n      tfx(b3.y)\n    )\n    .attr(options.lineattr)\n    .attr({\n      fill: color,\n      stroke: color\n    })\n}\n\nfunction bondSingleStereoBold(paper, a1, a2, a3, a4, options, color = '#000') {\n  // eslint-disable-line max-params\n  const bond = paper\n    .path(\n      'M{0},{1}L{2},{3}L{4},{5}L{6},{7}Z',\n      tfx(a1.x),\n      tfx(a1.y),\n      tfx(a2.x),\n      tfx(a2.y),\n      tfx(a3.x),\n      tfx(a3.y),\n      tfx(a4.x),\n      tfx(a4.y)\n    )\n    .attr(options.lineattr)\n  bond.attr({\n    stroke: color,\n    fill: color\n  })\n  return bond\n}\n\nfunction bondDoubleStereoBold(\n  paper,\n  sgBondPath,\n  b1,\n  b2,\n  options,\n  color = '#000'\n) {\n  // eslint-disable-line max-params\n  return paper.set([\n    sgBondPath,\n    paper\n      .path('M{0},{1}L{2},{3}', tfx(b1.x), tfx(b1.y), tfx(b2.x), tfx(b2.y))\n      .attr(options.lineattr)\n      .attr({\n        stroke: color,\n        fill: color\n      })\n  ])\n}\n\nfunction bondSingleDown(paper, hb1, d, nlines, step, options, color = '#000') {\n  // eslint-disable-line max-params\n  var a = hb1.p,\n    n = hb1.norm\n  var bsp = 0.7 * options.stereoBond\n\n  var path = '',\n    p,\n    q,\n    r\n  for (var i = 0; i < nlines; ++i) {\n    r = a.addScaled(d, step * i)\n    p = r.addScaled(n, (bsp * (i + 0.5)) / (nlines - 0.5))\n    q = r.addScaled(n, (-bsp * (i + 0.5)) / (nlines - 0.5))\n    path += makeStroke(p, q)\n  }\n  return paper.path(path).attr(options.lineattr).attr({\n    fill: color,\n    stroke: color\n  })\n}\n\nfunction bondSingleEither(\n  paper,\n  hb1,\n  d,\n  nlines,\n  step,\n  options,\n  color = '#000'\n) {\n  // eslint-disable-line max-params\n  var a = hb1.p,\n    n = hb1.norm\n  var bsp = 0.7 * options.stereoBond\n\n  var path = 'M' + tfx(a.x) + ',' + tfx(a.y),\n    r = a\n  for (var i = 0; i < nlines; ++i) {\n    r = a\n      .addScaled(d, step * (i + 0.5))\n      .addScaled(n, ((i & 1 ? -1 : +1) * bsp * (i + 0.5)) / (nlines - 0.5))\n    path += 'L' + tfx(r.x) + ',' + tfx(r.y)\n  }\n  return paper.path(path).attr(options.lineattr).attr({\n    fill: color,\n    stroke: color\n  })\n}\n\nfunction bondDouble(paper, a1, a2, b1, b2, cisTrans, options) {\n  // eslint-disable-line max-params\n  return paper\n    .path(\n      cisTrans\n        ? 'M{0},{1}L{6},{7}M{4},{5}L{2},{3}'\n        : 'M{0},{1}L{2},{3}M{4},{5}L{6},{7}',\n      tfx(a1.x),\n      tfx(a1.y),\n      tfx(b1.x),\n      tfx(b1.y),\n      tfx(a2.x),\n      tfx(a2.y),\n      tfx(b2.x),\n      tfx(b2.y)\n    )\n    .attr(options.lineattr)\n}\n\nfunction bondSingleOrDouble(paper, hb1, hb2, nSect, options) {\n  // eslint-disable-line max-statements, max-params\n  var a = hb1.p,\n    b = hb2.p,\n    n = hb1.norm\n  var bsp = options.bondSpace / 2\n\n  var path = '',\n    pi,\n    pp = a\n  for (var i = 1; i <= nSect; ++i) {\n    pi = Vec2.lc2(a, (nSect - i) / nSect, b, i / nSect)\n    if (i & 1) {\n      path += makeStroke(pp, pi)\n    } else {\n      path += makeStroke(pp.addScaled(n, bsp), pi.addScaled(n, bsp))\n      path += makeStroke(pp.addScaled(n, -bsp), pi.addScaled(n, -bsp))\n    }\n    pp = pi\n  }\n  return paper.path(path).attr(options.lineattr)\n}\n\nfunction bondTriple(paper, hb1, hb2, options, color = '#000') {\n  var a = hb1.p,\n    b = hb2.p,\n    n = hb1.norm\n  var a2 = a.addScaled(n, options.bondSpace)\n  var b2 = b.addScaled(n, options.bondSpace)\n  var a3 = a.addScaled(n, -options.bondSpace)\n  var b3 = b.addScaled(n, -options.bondSpace)\n  return paper\n    .path(makeStroke(a, b) + makeStroke(a2, b2) + makeStroke(a3, b3))\n    .attr(options.lineattr)\n    .attr({\n      fill: color,\n      stroke: color\n    })\n}\n\nfunction bondAromatic(paper, paths, bondShift, options) {\n  var l1 = paper.path(paths[0]).attr(options.lineattr)\n  var l2 = paper.path(paths[1]).attr(options.lineattr)\n  if (bondShift !== undefined && bondShift !== null)\n    (bondShift > 0 ? l1 : l2).attr({ 'stroke-dasharray': '- ' })\n\n  return paper.set([l1, l2])\n}\n\nfunction bondAny(paper, hb1, hb2, options) {\n  var a = hb1.p,\n    b = hb2.p\n  return paper\n    .path(makeStroke(a, b))\n    .attr(options.lineattr)\n    .attr({ 'stroke-dasharray': '- ' })\n}\n\nfunction bondHydrogen(paper, hb1, hb2, options) {\n  var a = hb1.p,\n    b = hb2.p\n  return paper.path(makeStroke(a, b)).attr(options.lineattr).attr({\n    'stroke-dasharray': '.',\n    'stroke-linecap': 'square'\n  })\n}\n\nfunction bondDative(paper, hb1, hb2, options) {\n  var a = hb1.p,\n    b = hb2.p\n  return paper\n    .path(makeStroke(a, b))\n    .attr(options.lineattr)\n    .attr({ 'arrow-end': 'block-midium-long' })\n}\n\nfunction reactingCenter(paper, p, options) {\n  var pathdesc = ''\n  for (var i = 0; i < p.length / 2; ++i)\n    pathdesc += makeStroke(p[2 * i], p[2 * i + 1])\n  return paper.path(pathdesc).attr(options.lineattr)\n}\n\nfunction topologyMark(paper, p, mark, options) {\n  var path = paper.text(p.x, p.y, mark).attr({\n    font: options.font,\n    'font-size': options.fontszsub,\n    fill: '#000'\n  })\n  var rbb = util.relBox(path.getBBox())\n  recenterText(path, rbb)\n  return path\n}\n\nfunction radicalCap(paper, p, options) {\n  var s = options.lineWidth * 0.9\n  var dw = s,\n    dh = 2 * s\n  return paper\n    .path(\n      'M{0},{1}L{2},{3}L{4},{5}',\n      tfx(p.x - dw),\n      tfx(p.y + dh),\n      tfx(p.x),\n      tfx(p.y),\n      tfx(p.x + dw),\n      tfx(p.y + dh)\n    )\n    .attr({\n      stroke: '#000',\n      'stroke-width': options.lineWidth * 0.7,\n      'stroke-linecap': 'square',\n      'stroke-linejoin': 'miter'\n    })\n}\n\nfunction radicalBullet(paper, p, options) {\n  return paper.circle(tfx(p.x), tfx(p.y), options.lineWidth).attr({\n    stroke: null,\n    fill: '#000'\n  })\n}\n\nfunction bracket(paper, d, n, c, bracketWidth, bracketHeight, options) {\n  // eslint-disable-line max-params\n  bracketWidth = bracketWidth || 0.25\n  bracketHeight = bracketHeight || 1.0\n  var a0 = c.addScaled(n, -0.5 * bracketHeight)\n  var a1 = c.addScaled(n, 0.5 * bracketHeight)\n  var b0 = a0.addScaled(d, -bracketWidth)\n  var b1 = a1.addScaled(d, -bracketWidth)\n\n  return paper\n    .path(\n      'M{0},{1}L{2},{3}L{4},{5}L{6},{7}',\n      tfx(b0.x),\n      tfx(b0.y),\n      tfx(a0.x),\n      tfx(a0.y),\n      tfx(a1.x),\n      tfx(a1.y),\n      tfx(b1.x),\n      tfx(b1.y)\n    )\n    .attr(options.sgroupBracketStyle)\n}\n\nfunction selectionRectangle(paper, p0, p1, options) {\n  return paper\n    .rect(\n      tfx(Math.min(p0.x, p1.x)),\n      tfx(Math.min(p0.y, p1.y)),\n      tfx(Math.abs(p1.x - p0.x)),\n      tfx(Math.abs(p1.y - p0.y))\n    )\n    .attr(options.lassoStyle)\n}\n\nfunction selectionPolygon(paper, r, options) {\n  var v = r[r.length - 1]\n  var pstr = 'M' + tfx(v.x) + ',' + tfx(v.y)\n  for (var i = 0; i < r.length; ++i)\n    pstr += 'L' + tfx(r[i].x) + ',' + tfx(r[i].y)\n  return paper.path(pstr).attr(options.lassoStyle)\n}\n\nfunction selectionLine(paper, p0, p1, options) {\n  return paper.path(makeStroke(p0, p1)).attr(options.lassoStyle)\n}\n\nfunction makeStroke(a, b) {\n  return 'M' + tfx(a.x) + ',' + tfx(a.y) + 'L' + tfx(b.x) + ',' + tfx(b.y) + '\t'\n}\n\nfunction dashedPath(p0, p1, dash) {\n  var t0 = 0\n  var t1 = Vec2.dist(p0, p1)\n  var d = Vec2.diff(p1, p0).normalized()\n  var black = true\n  var path = ''\n  var i = 0\n\n  while (t0 < t1) {\n    var len = dash[i % dash.length]\n    var t2 = t0 + Math.min(len, t1 - t0)\n    if (black)\n      path +=\n        'M ' +\n        p0.addScaled(d, t0).coordStr() +\n        ' L ' +\n        p0.addScaled(d, t2).coordStr()\n    t0 += len\n    black = !black\n    i++\n  }\n  return path\n}\n\nfunction aromaticBondPaths(a2, a3, b2, b3, mask, dash) {\n  // eslint-disable-line max-params\n  var l1 = dash && mask & 1 ? dashedPath(a2, b2, dash) : makeStroke(a2, b2)\n  var l2 = dash && mask & 2 ? dashedPath(a3, b3, dash) : makeStroke(a3, b3)\n\n  return [l1, l2]\n}\n\nfunction recenterText(path, rbb) {\n  // TODO: find a better way\n  if (Raphael.vml) {\n    var gap = rbb.height * 0.16\n    path.translateAbs(0, gap)\n    rbb.y += gap\n  }\n}\n\nexport default {\n  recenterText,\n  arrow,\n  plus,\n  aromaticBondPaths,\n  bondSingle,\n  bondSingleUp,\n  bondSingleStereoBold,\n  bondDoubleStereoBold,\n  bondSingleDown,\n  bondSingleEither,\n  bondDouble,\n  bondSingleOrDouble,\n  bondTriple,\n  bondAromatic,\n  bondAny,\n  bondHydrogen,\n  bondDative,\n  reactingCenter,\n  topologyMark,\n  radicalCap,\n  radicalBullet,\n  bracket,\n  selectionRectangle,\n  selectionPolygon,\n  selectionLine,\n  ellipse,\n  rectangle,\n  rectangleWithAngle,\n  polyline,\n  line\n}\n","/****************************************************************************\n * Copyright 2021 EPAM Systems\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *    http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n ***************************************************************************/\n\nimport {\n  Atom,\n  Bond,\n  Box2Abs,\n  FunctionalGroup,\n  StereoFlag,\n  StereoLabel,\n  Struct,\n  Vec2\n} from 'domain/entities'\nimport { ElementColor, Elements } from 'domain/constants'\nimport {\n  LayerMap,\n  StereLabelStyleType,\n  StereoColoringType\n} from './generalEnumTypes'\n\nimport ReObject from './reobject'\nimport ReStruct from './restruct'\nimport { Render } from '../raphaelRender'\nimport { Scale } from 'domain/helpers'\nimport draw from '../draw'\nimport util from '../util'\n\ninterface ElemAttr {\n  text: string\n  path: any\n  rbb: { x: number; y: number; width: number; height: number }\n}\n\nconst StereoLabelMinOpacity = 0.3\n\nenum ShowHydrogenLabels {\n  Off = 'off',\n  Hetero = 'Hetero',\n  Terminal = 'Terminal',\n  TerminalAndHetero = 'Terminal and Hetero',\n  On = 'on'\n}\n\nclass ReAtom extends ReObject {\n  a: Atom\n  showLabel: boolean\n  hydrogenOnTheLeft: boolean\n  color: string\n  component: number\n  label?: ElemAttr\n\n  constructor(atom: Atom) {\n    super('atom')\n    this.a = atom // TODO rename a to item\n    this.showLabel = false\n\n    this.hydrogenOnTheLeft = false\n\n    this.color = '#000000'\n    this.component = -1\n  }\n  static isSelectable(): true {\n    return true\n  }\n  getVBoxObj(render: Render): Box2Abs | null {\n    if (this.visel.boundingBox)\n      return ReObject.prototype.getVBoxObj.call(this, render)\n    return new Box2Abs(this.a.pp, this.a.pp)\n  }\n\n  drawHover(render: Render) {\n    const ret = this.makeHoverPlate(render)\n    render.ctab.addReObjectPath(LayerMap.hovering, this.visel, ret)\n    return ret\n  }\n\n  makeHoverPlate(render: Render) {\n    const paper = render.paper\n    const options = render.options\n    const ps = Scale.obj2scaled(this.a.pp, options)\n    const atom = this.a\n    const sgroups = render.ctab.sgroups\n    const functionalGroups = render.ctab.molecule.functionalGroups\n    if (\n      FunctionalGroup.isAtomInContractedFunctionalGroup(\n        atom,\n        sgroups,\n        functionalGroups,\n        true\n      )\n    )\n      return null\n    return paper\n      .circle(ps.x, ps.y, options.atomSelectionPlateRadius)\n      .attr(options.hoverStyle)\n  }\n  makeSelectionPlate(restruct: ReStruct, paper: any, styles: any) {\n    const atom = this.a\n    const sgroups = restruct.render.ctab.sgroups\n    const functionalGroups = restruct.render.ctab.molecule.functionalGroups\n    if (\n      FunctionalGroup.isAtomInContractedFunctionalGroup(\n        atom,\n        sgroups,\n        functionalGroups,\n        true\n      )\n    )\n      return null\n\n    const ps = Scale.obj2scaled(this.a.pp, restruct.render.options)\n    return paper\n      .circle(ps.x, ps.y, styles.atomSelectionPlateRadius)\n      .attr(styles.selectionStyle)\n  }\n  show(restruct: ReStruct, aid: number, options: any): void {\n    // eslint-disable-line max-statements\n    const atom = restruct.molecule.atoms.get(aid)\n    const sgroups = restruct.molecule.sgroups\n    const functionalGroups = restruct.molecule.functionalGroups\n    const render = restruct.render\n    const ps = Scale.obj2scaled(this.a.pp, render.options)\n\n    if (\n      FunctionalGroup.isAtomInContractedFunctionalGroup(\n        atom,\n        sgroups,\n        functionalGroups,\n        false\n      )\n    ) {\n      if (FunctionalGroup.isFirstAtomInFunctionalGroup(sgroups, aid)) {\n        let sgroupName\n        for (let sg of sgroups.values()) {\n          if (aid === sg.atoms[0]) sgroupName = sg.data.name\n        }\n        const path = render.paper.text(ps.x, ps.y, sgroupName).attr({\n          'font-weight': 700,\n          'font-size': 14\n        })\n        restruct.addReObjectPath(LayerMap.data, this.visel, path, ps, true)\n      }\n      return\n    }\n\n    this.hydrogenOnTheLeft = setHydrogenPos(restruct.molecule, this)\n    this.showLabel = isLabelVisible(restruct, render.options, this)\n    this.color = 'black' // reset colour\n\n    let delta\n    let rightMargin\n    let leftMargin\n    let implh\n    let isHydrogen\n    let label\n    let index: any = null\n\n    if (this.showLabel) {\n      label = buildLabel(this, render.paper, ps, options)\n      delta = 0.5 * options.lineWidth\n      rightMargin =\n        (label.rbb.width / 2) * (options.zoom > 1 ? 1 : options.zoom)\n      leftMargin =\n        (-label.rbb.width / 2) * (options.zoom > 1 ? 1 : options.zoom)\n      implh = Math.floor(this.a.implicitH)\n      isHydrogen = label.text === 'H'\n      restruct.addReObjectPath(LayerMap.data, this.visel, label.path, ps, true)\n\n      if (options.showAtomIds) {\n        index = {}\n        index.text = aid.toString()\n        index.path = render.paper.text(ps.x, ps.y, index.text).attr({\n          font: options.font,\n          'font-size': options.fontszsub,\n          fill: '#070'\n        })\n        index.rbb = util.relBox(index.path.getBBox())\n        draw.recenterText(index.path, index.rbb)\n        restruct.addReObjectPath(LayerMap.indices, this.visel, index.path, ps)\n      }\n      this.setHover(this.hover, render)\n    }\n\n    if (this.showLabel && !this.a.pseudo) {\n      let hydroIndex: any = null\n      if (isHydrogen && implh > 0) {\n        hydroIndex = showHydroIndex(this, render, implh, rightMargin)\n        rightMargin += hydroIndex.rbb.width + delta\n        restruct.addReObjectPath(\n          LayerMap.data,\n          this.visel,\n          hydroIndex.path,\n          ps,\n          true\n        )\n      }\n\n      if (this.a.radical != 0) {\n        const radical = showRadical(this, render)\n        restruct.addReObjectPath(\n          LayerMap.data,\n          this.visel,\n          radical.path,\n          ps,\n          true\n        )\n      }\n      if (this.a.isotope != 0) {\n        const isotope = showIsotope(this, render, leftMargin)\n        leftMargin -= isotope.rbb.width + delta\n        restruct.addReObjectPath(\n          LayerMap.data,\n          this.visel,\n          isotope.path,\n          ps,\n          true\n        )\n      }\n      if (\n        !isHydrogen &&\n        !this.a.alias &&\n        implh > 0 &&\n        displayHydrogen(options.showHydrogenLabels, this)\n      ) {\n        const data = showHydrogen(this, render, implh, {\n          hydrogen: {},\n          hydroIndex,\n          rightMargin,\n          leftMargin\n        })\n        const hydrogen = data.hydrogen\n        hydroIndex = data.hydroIndex\n        rightMargin = data.rightMargin\n        leftMargin = data.leftMargin\n        restruct.addReObjectPath(\n          LayerMap.data,\n          this.visel,\n          hydrogen.path,\n          ps,\n          true\n        )\n        if (hydroIndex != null)\n          restruct.addReObjectPath(\n            LayerMap.data,\n            this.visel,\n            hydroIndex.path,\n            ps,\n            true\n          )\n      }\n\n      if (this.a.charge != 0 && options.showCharge) {\n        const charge = showCharge(this, render, rightMargin)\n        rightMargin += charge.rbb.width + delta\n        restruct.addReObjectPath(\n          LayerMap.data,\n          this.visel,\n          charge.path,\n          ps,\n          true\n        )\n      }\n      if (this.a.explicitValence >= 0 && options.showValence) {\n        const valence = showExplicitValence(this, render, rightMargin)\n        rightMargin += valence.rbb.width + delta\n        restruct.addReObjectPath(\n          LayerMap.data,\n          this.visel,\n          valence.path,\n          ps,\n          true\n        )\n      }\n\n      if (this.a.badConn && options.showValenceWarnings) {\n        const warning = showWarning(this, render, leftMargin, rightMargin)\n        restruct.addReObjectPath(\n          LayerMap.warnings,\n          this.visel,\n          warning.path,\n          ps,\n          true\n        )\n      }\n      if (index) {\n        /* eslint-disable no-mixed-operators */\n        pathAndRBoxTranslate(\n          index.path,\n          index.rbb,\n          -0.5 * label.rbb.width - 0.5 * index.rbb.width - delta,\n          0.3 * label.rbb.height\n        )\n        /* eslint-enable no-mixed-operators */\n      }\n    }\n\n    if (this.a.attpnt) {\n      const lsb = bisectLargestSector(this, restruct.molecule)\n      showAttpnt(this, render, lsb, restruct.addReObjectPath.bind(restruct))\n    }\n\n    const stereoLabel = this.a.stereoLabel // Enhanced Stereo\n    const aamText = getAamText(this)\n    const queryAttrsText = !this.a.pseudo ? getQueryAttrsText(this) : ''\n\n    // we render them together to avoid possible collisions\n\n    const fragmentId = Number(restruct.atoms.get(aid)?.a.fragment)\n    //TODO: fragment should not be null\n    const fragment = restruct.molecule.frags.get(fragmentId)\n\n    const text =\n      (shouldDisplayStereoLabel(\n        stereoLabel,\n        options.stereoLabelStyle,\n        fragment?.enhancedStereoFlag\n      )\n        ? `${stereoLabel}\\n`\n        : '') +\n      (queryAttrsText.length > 0 ? `${queryAttrsText}\\n` : '') +\n      (aamText.length > 0 ? `.${aamText}.` : '')\n    if (text.length > 0) {\n      const elem = Elements.get(this.a.label)\n      const aamPath = render.paper.text(ps.x, ps.y, text).attr({\n        font: options.font,\n        'font-size': options.fontszsub,\n        fill: options.atomColoring && elem ? ElementColor[this.a.label] : '#000'\n      })\n      if (stereoLabel) {\n        //use dom element to change color of stereo label which is the first element\n        //of just created text\n        //text -> tspan\n        const color = getStereoAtomColor(render.options, stereoLabel)\n        aamPath.node.childNodes[0].setAttribute('fill', color)\n        const opacity = getStereoAtomOpacity(render.options, stereoLabel)\n        aamPath.node.childNodes[0].setAttribute('fill-opacity', opacity)\n      }\n      const aamBox = util.relBox(aamPath.getBBox())\n      draw.recenterText(aamPath, aamBox)\n      const visel = this.visel\n      let t = 3\n      let dir = bisectLargestSector(this, restruct.molecule)\n      // estimate the shift to clear the atom label\n      for (let i = 0; i < visel.exts.length; ++i)\n        t = Math.max(t, util.shiftRayBox(ps, dir, visel.exts[i].translate(ps)))\n      // estimate the shift backwards to account for the size of the aam/query text box itself\n      t += util.shiftRayBox(ps, dir.negated(), Box2Abs.fromRelBox(aamBox))\n      dir = dir.scaled(8 + t)\n      pathAndRBoxTranslate(aamPath, aamBox, dir.x, dir.y)\n      restruct.addReObjectPath(LayerMap.data, this.visel, aamPath, ps, true)\n    }\n\n    // Checking whether atom is highlighted and what's the last color\n    const highlights = restruct.molecule.highlights\n    let isHighlighted = false\n    let highlightColor = ''\n    highlights.forEach(highlight => {\n      const hasCurrentHighlight = highlight.atoms?.includes(aid)\n      isHighlighted = isHighlighted || hasCurrentHighlight\n      if (hasCurrentHighlight) {\n        highlightColor = highlight.color\n      }\n    })\n\n    // Drawing highlight\n    if (isHighlighted) {\n      const style = { fill: highlightColor, stroke: 'none' }\n\n      const ps = Scale.obj2scaled(this.a.pp, restruct.render.options)\n      const path = render.paper\n        .circle(ps.x, ps.y, options.atomSelectionPlateRadius * 0.8)\n        .attr(style)\n\n      restruct.addReObjectPath(LayerMap.hovering, this.visel, path)\n    }\n  }\n}\n\nfunction getStereoAtomColor(options, stereoLabel) {\n  if (\n    !stereoLabel ||\n    options.colorStereogenicCenters === StereoColoringType.Off ||\n    options.colorStereogenicCenters === StereoColoringType.BondsOnly\n  ) {\n    return '#000'\n  }\n\n  return getColorFromStereoLabel(options, stereoLabel)\n}\n\nexport function getColorFromStereoLabel(options, stereoLabel) {\n  const stereoLabelType = stereoLabel.match(/\\D+/g)[0]\n\n  switch (stereoLabelType) {\n    case StereoLabel.And:\n      return options.colorOfAndCenters\n    case StereoLabel.Or:\n      return options.colorOfOrCenters\n    case StereoLabel.Abs:\n      return options.colorOfAbsoluteCenters\n    default:\n      return '#000'\n  }\n}\n\nfunction getStereoAtomOpacity(options, stereoLabel) {\n  const stereoLabelType = stereoLabel.match(/\\D+/g)[0]\n  const stereoLabelNumber = +stereoLabel.replace(stereoLabelType, '')\n  if (\n    !options.autoFadeOfStereoLabels ||\n    stereoLabelType === StereoLabel.Abs ||\n    options.colorStereogenicCenters === StereoColoringType.Off ||\n    options.colorStereogenicCenters === StereoColoringType.BondsOnly\n  ) {\n    return 1\n  }\n  return Math.max(1 - (stereoLabelNumber - 1) / 10, StereoLabelMinOpacity)\n}\n\nfunction shouldDisplayStereoLabel(\n  stereoLabel,\n  labelStyle,\n  flag: StereoFlag | undefined\n): Boolean {\n  if (!stereoLabel) {\n    return false\n  }\n  const stereoLabelType = stereoLabel.match(/\\D+/g)[0]\n  switch (labelStyle) {\n    // Off\n    case StereLabelStyleType.Off:\n      return false\n    // On\n    case StereLabelStyleType.On:\n      return true\n    // Classic\n    case StereLabelStyleType.Classic:\n      return flag === StereoFlag.Mixed || stereoLabelType === StereoLabel.Or\n        ? true\n        : false\n    // IUPAC\n    case StereLabelStyleType.IUPAC:\n      return flag === StereoFlag.Mixed && stereoLabelType !== StereoLabel.Abs\n        ? true\n        : false\n    default:\n      return true\n  }\n}\n\nfunction isLabelVisible(restruct, options, atom) {\n  const visibleTerminal =\n    options.showHydrogenLabels !== ShowHydrogenLabels.Off &&\n    options.showHydrogenLabels !== ShowHydrogenLabels.Hetero\n\n  const neighborsLength =\n    atom.a.neighbors.length === 0 ||\n    (atom.a.neighbors.length < 2 && visibleTerminal)\n\n  const shouldBeVisible =\n    neighborsLength ||\n    options.carbonExplicitly ||\n    atom.a.alias ||\n    atom.a.isotope !== 0 ||\n    atom.a.radical !== 0 ||\n    atom.a.charge !== 0 ||\n    atom.a.explicitValence >= 0 ||\n    atom.a.atomList !== null ||\n    atom.a.rglabel !== null ||\n    (atom.a.badConn && options.showValenceWarnings) ||\n    atom.a.label.toLowerCase() !== 'c'\n\n  if (shouldBeVisible) return true\n\n  if (atom.a.neighbors.length === 2) {\n    const nei1 = atom.a.neighbors[0]\n    const nei2 = atom.a.neighbors[1]\n    const hb1 = restruct.molecule.halfBonds.get(nei1)\n    const hb2 = restruct.molecule.halfBonds.get(nei2)\n    const bond1 = restruct.bonds.get(hb1.bid)\n    const bond2 = restruct.bonds.get(hb2.bid)\n\n    const sameNotStereo =\n      bond1.b.type === bond2.b.type &&\n      bond1.b.stereo === Bond.PATTERN.STEREO.NONE &&\n      bond2.b.stereo === Bond.PATTERN.STEREO.NONE\n\n    if (sameNotStereo && Math.abs(Vec2.cross(hb1.dir, hb2.dir)) < 0.2)\n      return true\n  }\n\n  return false\n}\n\nfunction displayHydrogen(hydrogenLabels, atom) {\n  return (\n    hydrogenLabels === ShowHydrogenLabels.On ||\n    (hydrogenLabels === ShowHydrogenLabels.Terminal &&\n      atom.a.neighbors.length < 2) ||\n    (hydrogenLabels === ShowHydrogenLabels.Hetero &&\n      atom.label.text.toLowerCase() !== 'c') ||\n    (hydrogenLabels === ShowHydrogenLabels.TerminalAndHetero &&\n      (atom.a.neighbors.length < 2 || atom.label.text.toLowerCase() !== 'c'))\n  )\n}\n\nfunction setHydrogenPos(struct, atom) {\n  // check where should the hydrogen be put on the left of the label\n  if (atom.a.neighbors.length === 0) {\n    const element = Elements.get(atom.a.label)\n    return !element || Boolean(element.leftH)\n  }\n\n  let yl = 1\n  let yr = 1\n  let nl = 0\n  let nr = 0\n\n  atom.a.neighbors.forEach(nei => {\n    const d = struct.halfBonds.get(nei).dir\n\n    if (d.x <= 0) {\n      yl = Math.min(yl, Math.abs(d.y))\n      nl++\n    } else {\n      yr = Math.min(yr, Math.abs(d.y))\n      nr++\n    }\n  })\n\n  return yl < 0.51 || yr < 0.51 ? yr < yl : nr > nl\n}\n\nfunction buildLabel(\n  atom: ReAtom,\n  paper: any,\n  ps: Vec2,\n  options: any\n): ElemAttr {\n  // eslint-disable-line max-statements\n  let label: any = {}\n  label.text = getLabelText(atom.a)\n\n  if (label.text === '') label = 'R#' // for structures that missed 'M  RGP' tag in molfile\n\n  if (label.text === atom.a.label) {\n    const element = Elements.get(label.text)\n    if (options.atomColoring && element)\n      atom.color = ElementColor[label.text] || '#000'\n  }\n\n  label.path = paper.text(ps.x, ps.y, label.text).attr({\n    font: options.font,\n    'font-size': options.fontsz,\n    fill: atom.color,\n    'font-style': atom.a.pseudo ? 'italic' : ''\n  })\n\n  label.rbb = util.relBox(label.path.getBBox())\n  draw.recenterText(label.path, label.rbb)\n\n  if (atom.a.atomList !== null)\n    pathAndRBoxTranslate(\n      label.path,\n      label.rbb,\n      ((atom.hydrogenOnTheLeft ? -1 : 1) *\n        (label.rbb.width - label.rbb.height)) /\n        2,\n      0\n    )\n\n  atom.label = label\n  return label\n}\n\nfunction getLabelText(atom) {\n  if (atom.atomList !== null) return atom.atomList.label()\n\n  if (atom.pseudo) return atom.pseudo\n\n  if (atom.alias) return atom.alias\n\n  if (atom.label === 'R#' && atom.rglabel !== null) {\n    let text = ''\n\n    for (let rgi = 0; rgi < 32; rgi++) {\n      if (atom.rglabel & (1 << rgi))\n        // eslint-disable-line max-depth\n        text += 'R' + (rgi + 1).toString()\n    }\n\n    return text\n  }\n\n  return atom.label\n}\n\nfunction showHydroIndex(atom, render, implh, rightMargin): ElemAttr {\n  const ps = Scale.obj2scaled(atom.a.pp, render.options)\n  const options = render.options\n  const delta = 0.5 * options.lineWidth\n  const hydroIndex: any = {}\n  hydroIndex.text = (implh + 1).toString()\n  hydroIndex.path = render.paper.text(ps.x, ps.y, hydroIndex.text).attr({\n    font: options.font,\n    'font-size': options.fontszsub,\n    fill: atom.color\n  })\n  hydroIndex.rbb = util.relBox(hydroIndex.path.getBBox())\n  draw.recenterText(hydroIndex.path, hydroIndex.rbb)\n  /* eslint-disable no-mixed-operators*/\n  pathAndRBoxTranslate(\n    hydroIndex.path,\n    hydroIndex.rbb,\n    rightMargin + 0.5 * hydroIndex.rbb.width + delta,\n    0.2 * atom.label.rbb.height\n  )\n  /* eslint-enable no-mixed-operators*/\n  return hydroIndex\n}\n\nfunction showRadical(atom: ReAtom, render: Render): Omit<ElemAttr, 'text'> {\n  const ps: Vec2 = Scale.obj2scaled(atom.a.pp, render.options)\n  const options = render.options\n  const paper: any = render.paper\n  const radical: any = {}\n  let hshift\n  switch (atom.a.radical) {\n    case 1:\n      radical.path = paper.set()\n      hshift = 1.6 * options.lineWidth\n      radical.path.push(\n        draw.radicalBullet(paper, ps.add(new Vec2(-hshift, 0)), options),\n        draw.radicalBullet(paper, ps.add(new Vec2(hshift, 0)), options)\n      )\n      radical.path.attr('fill', atom.color)\n      break\n    case 2:\n      radical.path = paper.set()\n      radical.path.push(draw.radicalBullet(paper, ps, options))\n      radical.path.attr('fill', atom.color)\n      break\n    case 3:\n      radical.path = paper.set()\n      hshift = 1.6 * options.lineWidth\n      radical.path.push(\n        draw.radicalCap(paper, ps.add(new Vec2(-hshift, 0)), options),\n        draw.radicalCap(paper, ps.add(new Vec2(hshift, 0)), options)\n      )\n      radical.path.attr('stroke', atom.color)\n      break\n    default:\n      break\n  }\n  radical.rbb = util.relBox(radical.path.getBBox())\n  let vshift = -0.5 * (atom.label!.rbb.height + radical.rbb.height)\n  if (atom.a.radical === 3) vshift -= options.lineWidth / 2\n  pathAndRBoxTranslate(radical.path, radical.rbb, 0, vshift)\n  return radical\n}\n\nfunction showIsotope(\n  atom: ReAtom,\n  render: Render,\n  leftMargin: number\n): ElemAttr {\n  const ps = Scale.obj2scaled(atom.a.pp, render.options)\n  const options = render.options\n  const delta = 0.5 * options.lineWidth\n  const isotope: any = {}\n  isotope.text = atom.a.isotope.toString()\n  isotope.path = render.paper.text(ps.x, ps.y, isotope.text).attr({\n    font: options.font,\n    'font-size': options.fontszsub,\n    fill: atom.color\n  })\n  isotope.rbb = util.relBox(isotope.path.getBBox())\n  draw.recenterText(isotope.path, isotope.rbb)\n  /* eslint-disable no-mixed-operators*/\n  pathAndRBoxTranslate(\n    isotope.path,\n    isotope.rbb,\n    leftMargin - 0.5 * isotope.rbb.width - delta,\n    -0.3 * atom.label!.rbb.height\n  )\n  /* eslint-enable no-mixed-operators*/\n  return isotope\n}\n\nfunction showCharge(\n  atom: ReAtom,\n  render: Render,\n  rightMargin: number\n): ElemAttr {\n  const ps = Scale.obj2scaled(atom.a.pp, render.options)\n  const options = render.options\n  const delta = 0.5 * options.lineWidth\n  const charge: any = {}\n  charge.text = ''\n  const absCharge = Math.abs(atom.a.charge)\n  if (absCharge !== 1) charge.text = absCharge.toString()\n  if (atom.a.charge < 0) charge.text += '\\u2013'\n  else charge.text += '+'\n\n  charge.path = render.paper.text(ps.x, ps.y, charge.text).attr({\n    font: options.font,\n    'font-size': options.fontszsub,\n    fill: atom.color\n  })\n  charge.rbb = util.relBox(charge.path.getBBox())\n  draw.recenterText(charge.path, charge.rbb)\n  /* eslint-disable no-mixed-operators*/\n  pathAndRBoxTranslate(\n    charge.path,\n    charge.rbb,\n    rightMargin + 0.5 * charge.rbb.width + delta,\n    -0.3 * atom.label!.rbb.height\n  )\n  /* eslint-enable no-mixed-operators*/\n  return charge\n}\n\nfunction showExplicitValence(\n  atom: ReAtom,\n  render: Render,\n  rightMargin: number\n): ElemAttr {\n  const mapValence = {\n    0: '0',\n    1: 'I',\n    2: 'II',\n    3: 'III',\n    4: 'IV',\n    5: 'V',\n    6: 'VI',\n    7: 'VII',\n    8: 'VIII',\n    9: 'IX',\n    10: 'X',\n    11: 'XI',\n    12: 'XII',\n    13: 'XIII',\n    14: 'XIV'\n  }\n  const ps = Scale.obj2scaled(atom.a.pp, render.options)\n  const options = render.options\n  const delta = 0.5 * options.lineWidth\n  const valence: any = {}\n  valence.text = mapValence[atom.a.explicitValence]\n  if (!valence.text)\n    throw new Error('invalid valence ' + atom.a.explicitValence.toString())\n  valence.text = '(' + valence.text + ')'\n  valence.path = render.paper.text(ps.x, ps.y, valence.text).attr({\n    font: options.font,\n    'font-size': options.fontszsub,\n    fill: atom.color\n  })\n  valence.rbb = util.relBox(valence.path.getBBox())\n  draw.recenterText(valence.path, valence.rbb)\n  /* eslint-disable no-mixed-operators*/\n  pathAndRBoxTranslate(\n    valence.path,\n    valence.rbb,\n    rightMargin + 0.5 * valence.rbb.width + delta,\n    -0.3 * atom.label!.rbb.height\n  )\n  /* eslint-enable no-mixed-operators*/\n  return valence\n}\n\nfunction showHydrogen(\n  atom: ReAtom,\n  render: Render,\n  implh: number,\n  data: {\n    hydrogen: any\n    hydroIndex: number\n    rightMargin: number\n    leftMargin: number\n  }\n): {\n  hydrogen: ElemAttr\n  hydroIndex: ElemAttr\n  rightMargin: number\n  leftMargin: number\n} {\n  // eslint-disable-line max-statements\n  let hydroIndex: any = data.hydroIndex\n  const hydrogenLeft = atom.hydrogenOnTheLeft\n  const ps = Scale.obj2scaled(atom.a.pp, render.options)\n  const options = render.options\n  const delta = 0.5 * options.lineWidth\n  const hydrogen = data.hydrogen\n  hydrogen.text = 'H'\n  hydrogen.path = render.paper.text(ps.x, ps.y, hydrogen.text).attr({\n    font: options.font,\n    'font-size': options.fontsz,\n    fill: atom.color\n  })\n  hydrogen.rbb = util.relBox(hydrogen.path.getBBox())\n  draw.recenterText(hydrogen.path, hydrogen.rbb)\n  if (!hydrogenLeft) {\n    pathAndRBoxTranslate(\n      hydrogen.path,\n      hydrogen.rbb,\n      data.rightMargin + 0.5 * hydrogen.rbb.width + delta,\n      0\n    )\n    data.rightMargin += hydrogen.rbb.width + delta\n  }\n  if (implh > 1) {\n    hydroIndex = {}\n    hydroIndex.text = implh.toString()\n    hydroIndex.path = render.paper.text(ps.x, ps.y, hydroIndex.text).attr({\n      font: options.font,\n      'font-size': options.fontszsub,\n      fill: atom.color\n    })\n    hydroIndex.rbb = util.relBox(hydroIndex.path.getBBox())\n    draw.recenterText(hydroIndex.path, hydroIndex.rbb)\n    if (!hydrogenLeft) {\n      pathAndRBoxTranslate(\n        hydroIndex.path,\n        hydroIndex.rbb,\n        data.rightMargin +\n          0.5 * hydroIndex.rbb.width * (options.zoom > 1 ? 1 : options.zoom) +\n          delta,\n        0.2 * atom.label!.rbb.height\n      )\n      data.rightMargin += hydroIndex.rbb.width + delta\n    }\n  }\n  if (hydrogenLeft) {\n    if (hydroIndex != null) {\n      pathAndRBoxTranslate(\n        hydroIndex.path,\n        hydroIndex.rbb,\n        data.leftMargin - 0.5 * hydroIndex.rbb.width - delta,\n        0.2 * atom.label!.rbb.height\n      )\n      data.leftMargin -= hydroIndex.rbb.width + delta\n    }\n    pathAndRBoxTranslate(\n      hydrogen.path,\n      hydrogen.rbb,\n      data.leftMargin -\n        0.5 *\n          hydrogen.rbb.width *\n          (implh > 1 && options.zoom < 1 ? options.zoom : 1) -\n        delta,\n      0\n    )\n    data.leftMargin -= hydrogen.rbb.width + delta\n  }\n  return Object.assign(data, { hydrogen, hydroIndex })\n}\n\nfunction showWarning(\n  atom,\n  render,\n  leftMargin,\n  rightMargin\n): { rbb: DOMRect; path: any } {\n  const ps = Scale.obj2scaled(atom.a.pp, render.options)\n  const delta = 0.5 * render.options.lineWidth\n  const tfx = util.tfx\n  const warning: any = {}\n  const y = ps.y + atom.label.rbb.height / 2 + delta\n  warning.path = render.paper\n    .path(\n      'M{0},{1}L{2},{3}',\n      tfx(ps.x + leftMargin),\n      tfx(y),\n      tfx(ps.x + rightMargin),\n      tfx(y)\n    )\n    .attr(render.options.lineattr)\n    .attr({ stroke: '#F00' })\n  warning.rbb = util.relBox(warning.path.getBBox())\n  return warning\n}\n\nfunction showAttpnt(atom, render, lsb, addReObjectPath) {\n  // eslint-disable-line max-statements\n  const asterisk = '‚àó'\n  const ps = Scale.obj2scaled(atom.a.pp, render.options)\n  const options = render.options\n  const tfx = util.tfx\n  let i, j\n  for (i = 0; i < 4; ++i) {\n    let attpntText = ''\n    if (atom.a.attpnt & (1 << i)) {\n      if (attpntText.length > 0) attpntText += ' '\n      attpntText += asterisk\n      for (j = 0; j < (i == 0 ? 0 : i + 1); ++j) attpntText += \"'\"\n      let pos0 = new Vec2(ps)\n      let pos1 = ps.addScaled(lsb, 0.7 * options.scale)\n\n      const attpntPath1 = render.paper.text(pos1.x, pos1.y, attpntText).attr({\n        font: options.font,\n        'font-size': options.fontsz,\n        fill: atom.color\n      })\n      const attpntRbb = util.relBox(attpntPath1.getBBox())\n      draw.recenterText(attpntPath1, attpntRbb)\n\n      const lsbn = lsb.negated()\n      /* eslint-disable no-mixed-operators*/\n      pos1 = pos1.addScaled(\n        lsbn,\n        util.shiftRayBox(pos1, lsbn, Box2Abs.fromRelBox(attpntRbb)) +\n          options.lineWidth / 2\n      )\n      /* eslint-enable no-mixed-operators*/\n      pos0 = shiftBondEnd(atom, pos0, lsb, options.lineWidth)\n      const n = lsb.rotateSC(1, 0)\n      const arrowLeft = pos1\n        .addScaled(n, 0.05 * options.scale)\n        .addScaled(lsbn, 0.09 * options.scale)\n      const arrowRight = pos1\n        .addScaled(n, -0.05 * options.scale)\n        .addScaled(lsbn, 0.09 * options.scale)\n      const attpntPath = render.paper.set()\n      attpntPath.push(\n        attpntPath1,\n        render.paper\n          .path(\n            'M{0},{1}L{2},{3}M{4},{5}L{2},{3}L{6},{7}',\n            tfx(pos0.x),\n            tfx(pos0.y),\n            tfx(pos1.x),\n            tfx(pos1.y),\n            tfx(arrowLeft.x),\n            tfx(arrowLeft.y),\n            tfx(arrowRight.x),\n            tfx(arrowRight.y)\n          )\n          .attr(render.options.lineattr)\n          .attr({ 'stroke-width': options.lineWidth / 2 })\n      )\n      addReObjectPath(LayerMap.indices, atom.visel, attpntPath, ps)\n      lsb = lsb.rotate(Math.PI / 6)\n    }\n  }\n}\n\n// function getStereoLabelText(atom, aid, render) {\n// \tconst struct = render.ctab.molecule;\n// \tconst frag = struct.frags.get(atom.a.fragment);\n// \tconst stereo = frag.getStereoAtomMark(aid);\n// \tif (!stereo.type) return null;\n//\n// \treturn stereo.type + (stereo.number || '');\n// }\n\nfunction getAamText(atom) {\n  let aamText = ''\n  if (atom.a.aam > 0) aamText += atom.a.aam\n  if (atom.a.invRet > 0) {\n    if (aamText.length > 0) aamText += ','\n    if (atom.a.invRet == 1) aamText += 'Inv'\n    else if (atom.a.invRet == 2) aamText += 'Ret'\n    else throw new Error('Invalid value for the invert/retain flag')\n  }\n  if (atom.a.exactChangeFlag > 0) {\n    if (aamText.length > 0) aamText += ','\n    if (atom.a.exactChangeFlag == 1) aamText += 'ext'\n    else throw new Error('Invalid value for the exact change flag')\n  }\n  return aamText\n}\n\nfunction getQueryAttrsText(atom) {\n  let queryAttrsText = ''\n  if (atom.a.ringBondCount != 0) {\n    if (atom.a.ringBondCount > 0)\n      queryAttrsText += 'rb' + atom.a.ringBondCount.toString()\n    else if (atom.a.ringBondCount == -1) queryAttrsText += 'rb0'\n    else if (atom.a.ringBondCount == -2) queryAttrsText += 'rb*'\n    else throw new Error('Ring bond count invalid')\n  }\n  if (atom.a.substitutionCount != 0) {\n    if (queryAttrsText.length > 0) queryAttrsText += ','\n    if (atom.a.substitutionCount > 0)\n      queryAttrsText += 's' + atom.a.substitutionCount.toString()\n    else if (atom.a.substitutionCount == -1) queryAttrsText += 's0'\n    else if (atom.a.substitutionCount == -2) queryAttrsText += 's*'\n    else throw new Error('Substitution count invalid')\n  }\n  if (atom.a.unsaturatedAtom > 0) {\n    if (queryAttrsText.length > 0) queryAttrsText += ','\n    if (atom.a.unsaturatedAtom == 1) queryAttrsText += 'u'\n    else throw new Error('Unsaturated atom invalid value')\n  }\n  if (atom.a.hCount > 0) {\n    if (queryAttrsText.length > 0) queryAttrsText += ','\n    queryAttrsText += 'H' + (atom.a.hCount - 1).toString()\n  }\n  return queryAttrsText\n}\n\nfunction pathAndRBoxTranslate(path, rbb, x, y) {\n  path.translateAbs(x, y)\n  rbb.x += x\n  rbb.y += y\n}\n\nfunction bisectLargestSector(atom: ReAtom, struct: Struct) {\n  let angles: Array<number> = []\n  atom.a.neighbors.forEach(hbid => {\n    const hb = struct.halfBonds.get(hbid)\n    hb && angles.push(hb.ang)\n  })\n  angles = angles.sort((a, b) => a - b)\n  const da: Array<number> = []\n  for (let i = 0; i < angles.length - 1; ++i) {\n    da.push(angles[(i + 1) % angles.length] - angles[i])\n  }\n  da.push(angles[0] - angles[angles.length - 1] + 2 * Math.PI)\n  let daMax = 0\n  let ang = -Math.PI / 2\n  for (let i = 0; i < angles.length; ++i) {\n    if (da[i] > daMax) {\n      daMax = da[i]\n      ang = angles[i] + da[i] / 2\n    }\n  }\n  return new Vec2(Math.cos(ang), Math.sin(ang))\n}\n\nfunction shiftBondEnd(atom, pos0, dir, margin) {\n  let t = 0\n  const visel = atom.visel\n  for (let k = 0; k < visel.exts.length; ++k) {\n    const box = visel.exts[k].translate(pos0)\n    t = Math.max(t, util.shiftRayBox(pos0, dir, box))\n  }\n  if (t > 0) pos0 = pos0.addScaled(dir, t + margin)\n  return pos0\n}\n\nexport default ReAtom\n","/****************************************************************************\n * Copyright 2021 EPAM Systems\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *    http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n ***************************************************************************/\n\nimport {\n  Atom,\n  Bond,\n  FunctionalGroup,\n  HalfBond,\n  Struct,\n  Vec2\n} from 'domain/entities'\nimport { LayerMap, StereoColoringType } from './generalEnumTypes'\nimport ReAtom, { getColorFromStereoLabel } from './reatom'\n\nimport ReObject from './reobject'\nimport ReStruct from './restruct'\nimport { Render } from '../raphaelRender'\nimport { Scale } from 'domain/helpers'\nimport draw from '../draw'\nimport util from '../util'\n\nclass ReBond extends ReObject {\n  b: Bond\n  doubleBondShift: number\n  path: any\n  neihbid1: number = -1\n  neihbid2: number = -1\n  boldStereo?: boolean\n  rbb?: { x: number; y: number; width: number; height: number }\n\n  constructor(bond: Bond) {\n    super('bond')\n    this.b = bond // TODO rename b to item\n    this.doubleBondShift = 0\n  }\n  static isSelectable() {\n    return true\n  }\n\n  drawHover(render: Render) {\n    const ret = this.makeHoverPlate(render)\n    render.ctab.addReObjectPath(LayerMap.hovering, this.visel, ret)\n    return ret\n  }\n\n  makeHoverPlate(render: Render) {\n    const options = render.options\n    bondRecalc(this, render.ctab, options)\n    const bond = this.b\n    const sgroups = render.ctab.sgroups\n    const functionalGroups = render.ctab.molecule.functionalGroups\n    if (\n      FunctionalGroup.isBondInContractedFunctionalGroup(\n        bond,\n        sgroups,\n        functionalGroups,\n        true\n      )\n    )\n      return null\n\n    const c = Scale.obj2scaled(this.b.center, options)\n    return render.paper\n      .circle(c.x, c.y, 0.8 * options.atomSelectionPlateRadius)\n      .attr(options.hoverStyle)\n  }\n  makeSelectionPlate(restruct: ReStruct, paper: any, options: any) {\n    bondRecalc(this, restruct, options)\n    const bond = this.b\n    const sgroups = restruct.render.ctab.sgroups\n    const functionalGroups = restruct.render.ctab.molecule.functionalGroups\n    if (\n      FunctionalGroup.isBondInContractedFunctionalGroup(\n        bond,\n        sgroups,\n        functionalGroups,\n        true\n      )\n    )\n      return null\n\n    const c = Scale.obj2scaled(this.b.center, options)\n    return paper\n      .circle(c.x, c.y, 0.8 * options.atomSelectionPlateRadius)\n      .attr(options.selectionStyle)\n  }\n\n  show(restruct: ReStruct, bid: number, options: any): void {\n    // eslint-disable-line max-statements\n    const render = restruct.render\n    const struct = restruct.molecule\n    const bond = restruct.molecule.bonds.get(bid)\n    const sgroups = restruct.molecule.sgroups\n    const functionalGroups = restruct.molecule.functionalGroups\n    if (\n      FunctionalGroup.isBondInContractedFunctionalGroup(\n        bond,\n        sgroups,\n        functionalGroups,\n        false\n      )\n    )\n      return\n\n    const paper = render.paper\n    const hb1 =\n        this.b.hb1 !== undefined ? struct.halfBonds.get(this.b.hb1) : null,\n      hb2 = this.b.hb2 !== undefined ? struct.halfBonds.get(this.b.hb2) : null\n\n    checkStereoBold(bid, this, restruct)\n    bondRecalc(this, restruct, options)\n    setDoubleBondShift(this, struct)\n    if (!hb1 || !hb2) return\n    this.path = getBondPath(restruct, this, hb1, hb2)\n    this.rbb = util.relBox(this.path.getBBox())\n    restruct.addReObjectPath(LayerMap.data, this.visel, this.path, null, true)\n    const reactingCenter: any = {}\n    reactingCenter.path = getReactingCenterPath(render, this, hb1, hb2)\n    if (reactingCenter.path) {\n      reactingCenter.rbb = util.relBox(reactingCenter.path.getBBox())\n      restruct.addReObjectPath(\n        LayerMap.data,\n        this.visel,\n        reactingCenter.path,\n        null,\n        true\n      )\n    }\n    const topology: any = {}\n    topology.path = getTopologyMark(render, this, hb1, hb2)\n    if (topology.path) {\n      topology.rbb = util.relBox(topology.path.getBBox())\n      restruct.addReObjectPath(\n        LayerMap.data,\n        this.visel,\n        topology.path,\n        null,\n        true\n      )\n    }\n    this.setHover(this.hover, render)\n\n    let ipath = null\n    const bondIdxOff = options.subFontSize * 0.6\n    if (options.showBondIds) {\n      ipath = getIdsPath(bid, paper, hb1, hb2, bondIdxOff, 0.5, 0.5, hb1.norm)\n      restruct.addReObjectPath(LayerMap.indices, this.visel, ipath)\n    }\n    if (options.showHalfBondIds) {\n      ipath = getIdsPath(\n        this.b.hb1!,\n        paper,\n        hb1,\n        hb2,\n        bondIdxOff,\n        0.8,\n        0.2,\n        hb1.norm\n      )\n      restruct.addReObjectPath(LayerMap.indices, this.visel, ipath)\n      ipath = getIdsPath(\n        this.b.hb2!,\n        paper,\n        hb1,\n        hb2,\n        bondIdxOff,\n        0.2,\n        0.8,\n        hb2.norm\n      )\n      restruct.addReObjectPath(LayerMap.indices, this.visel, ipath)\n    }\n    if (options.showLoopIds && !options.showBondIds) {\n      ipath = getIdsPath(\n        hb1.loop,\n        paper,\n        hb1,\n        hb2,\n        bondIdxOff,\n        0.5,\n        0.5,\n        hb2.norm\n      )\n      restruct.addReObjectPath(LayerMap.indices, this.visel, ipath)\n      ipath = getIdsPath(\n        hb2.loop,\n        paper,\n        hb1,\n        hb2,\n        bondIdxOff,\n        0.5,\n        0.5,\n        hb1.norm\n      )\n      restruct.addReObjectPath(LayerMap.indices, this.visel, ipath)\n    }\n\n    // Checking whether bond is highlighted and what is the last color\n    const highlights = restruct.molecule.highlights\n    let isHighlighted = false\n    let highlightColor = ''\n    highlights.forEach(highlight => {\n      const hasCurrentHighlight = highlight.bonds?.includes(bid)\n      isHighlighted = isHighlighted || hasCurrentHighlight\n      if (hasCurrentHighlight) {\n        highlightColor = highlight.color\n      }\n    })\n\n    // Drawing highlight\n    if (isHighlighted) {\n      const style = {\n        fill: highlightColor,\n        stroke: highlightColor,\n        'stroke-width': options.lineattr['stroke-width'] * 7,\n        'stroke-linecap': 'round'\n      }\n\n      const c = Scale.obj2scaled(this.b.center, restruct.render.options)\n\n      const highlightPath = getHighlightPath(restruct, hb1, hb2)\n      highlightPath.attr(style)\n\n      restruct.addReObjectPath(\n        LayerMap.hovering,\n        this.visel,\n        highlightPath,\n        c,\n        true\n      )\n    }\n  }\n}\n\nfunction getHighlightPath(restruct: ReStruct, hb1: HalfBond, hb2: HalfBond) {\n  const beginning = { x: hb1.p.x, y: hb1.p.y }\n  const end = { x: hb2.p.x, y: hb2.p.y }\n\n  const paper = restruct.render.paper\n\n  const pathString = `M${beginning.x},${beginning.y} L${end.x},${end.y}`\n\n  const path = paper.path(pathString)\n\n  return path\n}\n\nfunction findIncomingStereoUpBond(\n  atom: Atom,\n  bid0: number,\n  includeBoldStereoBond: boolean,\n  restruct: ReStruct\n): number {\n  return atom.neighbors.findIndex(hbid => {\n    const hb = restruct.molecule.halfBonds.get(hbid)\n\n    if (!hb || hb.bid === bid0) return false\n\n    const neibond = restruct.bonds.get(hb.bid)\n\n    if (!neibond) return false\n    const singleUp =\n      neibond.b.type === Bond.PATTERN.TYPE.SINGLE &&\n      neibond.b.stereo === Bond.PATTERN.STEREO.UP\n\n    if (singleUp)\n      return (\n        neibond.b.end === hb.begin ||\n        (neibond.boldStereo && includeBoldStereoBond)\n      )\n\n    return !!(\n      neibond.b.type === Bond.PATTERN.TYPE.DOUBLE &&\n      neibond.b.stereo === Bond.PATTERN.STEREO.NONE &&\n      includeBoldStereoBond &&\n      neibond.boldStereo\n    )\n  })\n}\n\nfunction findIncomingUpBonds(\n  bid0: number,\n  bond: ReBond,\n  restruct: ReStruct\n): void {\n  const halfbonds = [bond.b.begin, bond.b.end].map(aid => {\n    const atom = restruct.molecule.atoms.get(aid)\n    if (!atom) return -1\n    const pos = findIncomingStereoUpBond(atom, bid0, true, restruct)\n    return pos < 0 ? -1 : atom.neighbors[pos]\n  })\n\n  bond.neihbid1 = restruct.atoms.get(bond.b.begin)?.showLabel\n    ? -1\n    : halfbonds[0]\n  bond.neihbid2 = restruct.atoms.get(bond.b.end)?.showLabel ? -1 : halfbonds[1]\n}\n\nfunction checkStereoBold(bid0, bond, restruct) {\n  const halfbonds = [bond.b.begin, bond.b.end].map(aid => {\n    const atom = restruct.molecule.atoms.get(aid)\n    const pos = findIncomingStereoUpBond(atom, bid0, false, restruct)\n    return pos < 0 ? -1 : atom.neighbors[pos]\n  })\n  bond.boldStereo = halfbonds[0] >= 0 && halfbonds[1] >= 0\n}\n\nfunction getBondPath(\n  restruct: ReStruct,\n  bond: ReBond,\n  hb1: HalfBond,\n  hb2: HalfBond\n) {\n  let path = null\n  const render = restruct.render\n  const struct = restruct.molecule\n  const shiftA = !restruct.atoms.get(hb1.begin)?.showLabel\n  const shiftB = !restruct.atoms.get(hb2.begin)?.showLabel\n\n  switch (bond.b.type) {\n    case Bond.PATTERN.TYPE.SINGLE:\n      switch (bond.b.stereo) {\n        case Bond.PATTERN.STEREO.UP:\n          findIncomingUpBonds(hb1.bid, bond, restruct)\n          if (bond.boldStereo && bond.neihbid1 >= 0 && bond.neihbid2 >= 0)\n            path = getBondSingleStereoBoldPath(render, hb1, hb2, bond, struct)\n          else path = getBondSingleUpPath(render, hb1, hb2, bond, struct)\n          break\n        case Bond.PATTERN.STEREO.DOWN:\n          path = getBondSingleDownPath(render, hb1, hb2, bond, struct)\n          break\n        case Bond.PATTERN.STEREO.EITHER:\n          path = getBondSingleEitherPath(render, hb1, hb2, bond, struct)\n          break\n        default:\n          path = draw.bondSingle(\n            render.paper,\n            hb1,\n            hb2,\n            render.options,\n            getStereoBondColor(render.options, bond, struct)\n          )\n          break\n      }\n      break\n    case Bond.PATTERN.TYPE.DOUBLE:\n      findIncomingUpBonds(hb1.bid, bond, restruct)\n      if (\n        bond.b.stereo === Bond.PATTERN.STEREO.NONE &&\n        bond.boldStereo &&\n        bond.neihbid1 >= 0 &&\n        bond.neihbid2 >= 0\n      )\n        path = getBondDoubleStereoBoldPath(\n          render,\n          hb1,\n          hb2,\n          bond,\n          struct,\n          shiftA,\n          shiftB\n        )\n      else path = getBondDoublePath(render, hb1, hb2, bond, shiftA, shiftB)\n      break\n    case Bond.PATTERN.TYPE.TRIPLE:\n      path = draw.bondTriple(render.paper, hb1, hb2, render.options)\n      break\n    case Bond.PATTERN.TYPE.AROMATIC:\n      const inAromaticLoop =\n        (hb1.loop >= 0 && struct.loops.get(hb1.loop)?.aromatic) ||\n        (hb2.loop >= 0 && struct.loops.get(hb2.loop)?.aromatic)\n      path = inAromaticLoop\n        ? draw.bondSingle(render.paper, hb1, hb2, render.options)\n        : getBondAromaticPath(render, hb1, hb2, bond, shiftA, shiftB)\n      break\n    case Bond.PATTERN.TYPE.SINGLE_OR_DOUBLE:\n      path = getSingleOrDoublePath(render, hb1, hb2)\n      break\n    case Bond.PATTERN.TYPE.SINGLE_OR_AROMATIC:\n      path = getBondAromaticPath(render, hb1, hb2, bond, shiftA, shiftB)\n      break\n    case Bond.PATTERN.TYPE.DOUBLE_OR_AROMATIC:\n      path = getBondAromaticPath(render, hb1, hb2, bond, shiftA, shiftB)\n      break\n    case Bond.PATTERN.TYPE.ANY:\n      path = draw.bondAny(render.paper, hb1, hb2, render.options)\n      break\n    case Bond.PATTERN.TYPE.HYDROGEN:\n      path = draw.bondHydrogen(render.paper, hb1, hb2, render.options)\n      break\n    case Bond.PATTERN.TYPE.DATIVE:\n      path = draw.bondDative(render.paper, hb1, hb2, render.options)\n      break\n    default:\n      throw new Error('Bond type ' + bond.b.type + ' not supported')\n  }\n  return path\n}\n\n/* Get Path */\nfunction getBondSingleUpPath(\n  render: Render,\n  hb1: HalfBond,\n  hb2: HalfBond,\n  bond: ReBond,\n  struct: Struct\n) {\n  // eslint-disable-line max-params\n  const a = hb1.p,\n    b = hb2.p,\n    n = hb1.norm\n  const options = render.options\n  const bsp = 0.7 * options.stereoBond\n  let b2 = b.addScaled(n, bsp)\n  let b3 = b.addScaled(n, -bsp)\n  if (bond.neihbid2 >= 0) {\n    // if the end is shared with another up-bond heading this way\n    var coords = stereoUpBondGetCoordinates(\n      hb2,\n      bond.neihbid2,\n      options.stereoBond,\n      struct\n    )\n    b2 = coords[0]\n    b3 = coords[1]\n  }\n  return draw.bondSingleUp(\n    render.paper,\n    a,\n    b2,\n    b3,\n    options,\n    getStereoBondColor(options, bond, struct)\n  )\n}\n\nfunction getStereoBondColor(\n  options: any,\n  bond: ReBond,\n  struct: Struct\n): string {\n  const defaultColor = '#000'\n\n  if (bond.b.stereo === 0) return defaultColor\n\n  const beginAtomStereoLabel = struct.atoms.get(bond.b.begin)?.stereoLabel\n  const endAtomStereoLabel = struct.atoms.get(bond.b.end)?.stereoLabel\n\n  let stereoLabel = ''\n  if (beginAtomStereoLabel && !endAtomStereoLabel) {\n    stereoLabel = beginAtomStereoLabel\n  } else if (!beginAtomStereoLabel && endAtomStereoLabel) {\n    stereoLabel = endAtomStereoLabel\n  }\n\n  if (\n    // if no stereolabel presents or presents in both then use default color\n    !stereoLabel ||\n    options.colorStereogenicCenters === StereoColoringType.Off ||\n    options.colorStereogenicCenters === StereoColoringType.LabelsOnly\n  ) {\n    return defaultColor\n  }\n\n  return getColorFromStereoLabel(options, stereoLabel)\n}\n\nfunction getBondSingleStereoBoldPath(\n  render: Render,\n  hb1: HalfBond,\n  hb2: HalfBond,\n  bond: ReBond,\n  struct: Struct\n) {\n  // eslint-disable-line max-params\n  const options = render.options\n  const coords1 = stereoUpBondGetCoordinates(\n    hb1,\n    bond.neihbid1,\n    options.stereoBond,\n    struct\n  )\n  const coords2 = stereoUpBondGetCoordinates(\n    hb2,\n    bond.neihbid2,\n    options.stereoBond,\n    struct\n  )\n  const a1 = coords1[0]\n  const a2 = coords1[1]\n  const a3 = coords2[0]\n  const a4 = coords2[1]\n  return draw.bondSingleStereoBold(\n    render.paper,\n    a1,\n    a2,\n    a3,\n    a4,\n    options,\n    getStereoBondColor(options, bond, struct)\n  )\n}\n\nfunction getBondDoubleStereoBoldPath(\n  render: Render,\n  hb1: HalfBond,\n  hb2: HalfBond,\n  bond: ReBond,\n  struct: Struct,\n  shiftA: boolean,\n  shiftB: boolean\n) {\n  // eslint-disable-line max-params\n  const a = hb1.p,\n    b = hb2.p,\n    n = hb1.norm,\n    shift = bond.doubleBondShift\n  const bsp = 1.5 * render.options.stereoBond\n  let b1 = a.addScaled(n, bsp * shift)\n  let b2 = b.addScaled(n, bsp * shift)\n  if (shift > 0) {\n    if (shiftA)\n      b1 = b1.addScaled(\n        hb1.dir,\n        bsp * getBondLineShift(hb1.rightCos, hb1.rightSin)\n      )\n    if (shiftB)\n      b2 = b2.addScaled(\n        hb1.dir,\n        -bsp * getBondLineShift(hb2.leftCos, hb2.leftSin)\n      )\n  } else if (shift < 0) {\n    if (shiftA)\n      b1 = b1.addScaled(\n        hb1.dir,\n        bsp * getBondLineShift(hb1.leftCos, hb1.leftSin)\n      )\n    if (shiftB)\n      b2 = b2.addScaled(\n        hb1.dir,\n        -bsp * getBondLineShift(hb2.rightCos, hb2.rightSin)\n      )\n  }\n  const sgBondPath = getBondSingleStereoBoldPath(render, hb1, hb2, bond, struct)\n  return draw.bondDoubleStereoBold(\n    render.paper,\n    sgBondPath,\n    b1,\n    b2,\n    render.options,\n    getStereoBondColor(render.options, bond, struct)\n  )\n}\n\nfunction getBondLineShift(cos: number, sin: number): number {\n  if (sin < 0 || Math.abs(cos) > 0.9) return 0\n  return sin / (1 - cos)\n}\n\nfunction stereoUpBondGetCoordinates(\n  hb: HalfBond,\n  neihbid: number,\n  bondSpace: any,\n  struct: Struct\n): [Vec2, Vec2] {\n  const neihb = struct.halfBonds.get(neihbid)\n  const cos = Vec2.dot(hb.dir, neihb!.dir)\n  const sin = Vec2.cross(hb.dir, neihb!.dir)\n  const cosHalf = Math.sqrt(0.5 * (1 - cos))\n  const biss = neihb!.dir.rotateSC(\n    (sin >= 0 ? -1 : 1) * cosHalf,\n    Math.sqrt(0.5 * (1 + cos))\n  )\n\n  const denomAdd = 0.3\n  const scale = 0.7\n  const a1 = hb.p.addScaled(biss, (scale * bondSpace) / (cosHalf + denomAdd))\n  const a2 = hb.p.addScaled(\n    biss.negated(),\n    (scale * bondSpace) / (cosHalf + denomAdd)\n  )\n  return sin > 0 ? [a1, a2] : [a2, a1]\n}\n\nfunction getBondSingleDownPath(\n  render: Render,\n  hb1: HalfBond,\n  hb2: HalfBond,\n  bond: ReBond,\n  struct: Struct\n) {\n  const a = hb1.p,\n    b = hb2.p\n  const options = render.options\n  let d = b.sub(a)\n  const len = d.length() + 0.2\n  d = d.normalized()\n  const interval = 1.2 * options.lineWidth\n  const nlines =\n    Math.max(\n      Math.floor((len - options.lineWidth) / (options.lineWidth + interval)),\n      0\n    ) + 2\n  const step = len / (nlines - 1)\n  return draw.bondSingleDown(\n    render.paper,\n    hb1,\n    d,\n    nlines,\n    step,\n    options,\n    getStereoBondColor(options, bond, struct)\n  )\n}\n\nfunction getBondSingleEitherPath(\n  render: Render,\n  hb1: HalfBond,\n  hb2: HalfBond,\n  bond: ReBond,\n  struct: Struct\n) {\n  const a = hb1.p,\n    b = hb2.p\n  const options = render.options\n  let d = b.sub(a)\n  const len = d.length()\n  d = d.normalized()\n  const interval = 0.6 * options.lineWidth\n  const nlines =\n    Math.max(\n      Math.floor((len - options.lineWidth) / (options.lineWidth + interval)),\n      0\n    ) + 2\n  const step = len / (nlines - 0.5)\n  return draw.bondSingleEither(\n    render.paper,\n    hb1,\n    d,\n    nlines,\n    step,\n    options,\n    getStereoBondColor(options, bond, struct)\n  )\n}\n\nfunction getBondDoublePath(\n  render: Render,\n  hb1: HalfBond,\n  hb2: HalfBond,\n  bond: ReBond,\n  shiftA: boolean,\n  shiftB: boolean\n) {\n  // eslint-disable-line max-params, max-statements\n  const cisTrans = bond.b.stereo === Bond.PATTERN.STEREO.CIS_TRANS\n\n  const a = hb1.p\n  const b = hb2.p\n  const n = hb1.norm\n  const shift = cisTrans ? 0 : bond.doubleBondShift\n\n  const options = render.options\n  const bsp = options.bondSpace / 2\n  const s1 = bsp + shift * bsp\n  const s2 = -bsp + shift * bsp\n\n  let a1 = a.addScaled(n, s1)\n  let b1 = b.addScaled(n, s1)\n  let a2 = a.addScaled(n, s2)\n  let b2 = b.addScaled(n, s2)\n\n  if (shift > 0) {\n    if (shiftA) {\n      a1 = a1.addScaled(\n        hb1.dir,\n        options.bondSpace * getBondLineShift(hb1.rightCos, hb1.rightSin)\n      )\n    }\n    if (shiftB) {\n      b1 = b1.addScaled(\n        hb1.dir,\n        -options.bondSpace * getBondLineShift(hb2.leftCos, hb2.leftSin)\n      )\n    }\n  } else if (shift < 0) {\n    if (shiftA) {\n      a2 = a2.addScaled(\n        hb1.dir,\n        options.bondSpace * getBondLineShift(hb1.leftCos, hb1.leftSin)\n      )\n    }\n    if (shiftB) {\n      b2 = b2.addScaled(\n        hb1.dir,\n        -options.bondSpace * getBondLineShift(hb2.rightCos, hb2.rightSin)\n      )\n    }\n  }\n\n  return draw.bondDouble(render.paper, a1, a2, b1, b2, cisTrans, options)\n}\n\nfunction getSingleOrDoublePath(render: Render, hb1: HalfBond, hb2: HalfBond) {\n  const a = hb1.p,\n    b = hb2.p\n  const options = render.options\n\n  let nSect =\n    Vec2.dist(a, b) / Number((options.bondSpace + options.lineWidth).toFixed())\n  if (!(nSect & 1)) nSect += 1\n  return draw.bondSingleOrDouble(render.paper, hb1, hb2, nSect, options)\n}\n\nfunction getBondAromaticPath(\n  render: Render,\n  hb1: HalfBond,\n  hb2: HalfBond,\n  bond: ReBond,\n  shiftA: boolean,\n  shiftB: boolean\n) {\n  // eslint-disable-line max-params\n  const dashdotPattern = [0.125, 0.125, 0.005, 0.125]\n  let mark: number | null = null,\n    dash: number[] | null = null\n  const options = render.options\n  const bondShift = bond.doubleBondShift\n\n  if (bond.b.type === Bond.PATTERN.TYPE.SINGLE_OR_AROMATIC) {\n    mark = bondShift > 0 ? 1 : 2\n    dash = dashdotPattern.map(v => v * options.scale)\n  }\n  if (bond.b.type === Bond.PATTERN.TYPE.DOUBLE_OR_AROMATIC) {\n    mark = 3\n    dash = dashdotPattern.map(v => v * options.scale)\n  }\n  const paths = getAromaticBondPaths(\n    hb1,\n    hb2,\n    bondShift,\n    shiftA,\n    shiftB,\n    options.bondSpace,\n    mark,\n    dash\n  )\n  return draw.bondAromatic(render.paper, paths, bondShift, options)\n}\n\nfunction getAromaticBondPaths(\n  hb1: HalfBond,\n  hb2: HalfBond,\n  shift: number,\n  shiftA: boolean,\n  shiftB: boolean,\n  bondSpace: number,\n  mask: number | null,\n  dash: number[] | null\n) {\n  // eslint-disable-line max-params, max-statements\n  const a = hb1.p,\n    b = hb2.p,\n    n = hb1.norm\n  const bsp = bondSpace / 2\n  const s1 = bsp + shift * bsp,\n    s2 = -bsp + shift * bsp\n  let a2 = a.addScaled(n, s1)\n  let b2 = b.addScaled(n, s1)\n  let a3 = a.addScaled(n, s2)\n  let b3 = b.addScaled(n, s2)\n  if (shift > 0) {\n    if (shiftA) {\n      a2 = a2.addScaled(\n        hb1.dir,\n        bondSpace * getBondLineShift(hb1.rightCos, hb1.rightSin)\n      )\n    }\n    if (shiftB) {\n      b2 = b2.addScaled(\n        hb1.dir,\n        -bondSpace * getBondLineShift(hb2.leftCos, hb2.leftSin)\n      )\n    }\n  } else if (shift < 0) {\n    if (shiftA) {\n      a3 = a3.addScaled(\n        hb1.dir,\n        bondSpace * getBondLineShift(hb1.leftCos, hb1.leftSin)\n      )\n    }\n    if (shiftB) {\n      b3 = b3.addScaled(\n        hb1.dir,\n        -bondSpace * getBondLineShift(hb2.rightCos, hb2.rightSin)\n      )\n    }\n  }\n  return draw.aromaticBondPaths(a2, a3, b2, b3, mask, dash)\n}\n\nfunction getReactingCenterPath(\n  render: Render,\n  bond: ReBond,\n  hb1: HalfBond,\n  hb2: HalfBond\n) {\n  // eslint-disable-line max-statements\n  const a = hb1.p,\n    b = hb2.p\n  const c = b.add(a).scaled(0.5)\n  const d = b.sub(a).normalized()\n  const n = d.rotateSC(1, 0)\n\n  const p: Array<Vec2> = []\n\n  const lw = render.options.lineWidth,\n    bs = render.options.bondSpace / 2\n  const alongIntRc = lw, // half interval along for CENTER\n    alongIntMadeBroken = 2 * lw, // half interval between along for MADE_OR_BROKEN\n    alongSz = 1.5 * bs, // half size along for CENTER\n    acrossInt = 1.5 * bs, // half interval across for CENTER\n    acrossSz = 3.0 * bs, // half size across for all\n    tiltTan = 0.2 // tangent of the tilt angle\n\n  switch (bond.b.reactingCenterStatus) {\n    case Bond.PATTERN.REACTING_CENTER.NOT_CENTER: // X\n      p.push(c.addScaled(n, acrossSz).addScaled(d, tiltTan * acrossSz))\n      p.push(c.addScaled(n, -acrossSz).addScaled(d, -tiltTan * acrossSz))\n      p.push(c.addScaled(n, acrossSz).addScaled(d, -tiltTan * acrossSz))\n      p.push(c.addScaled(n, -acrossSz).addScaled(d, tiltTan * acrossSz))\n      break\n    case Bond.PATTERN.REACTING_CENTER.CENTER: // #\n      p.push(\n        c\n          .addScaled(n, acrossSz)\n          .addScaled(d, tiltTan * acrossSz)\n          .addScaled(d, alongIntRc)\n      )\n      p.push(\n        c\n          .addScaled(n, -acrossSz)\n          .addScaled(d, -tiltTan * acrossSz)\n          .addScaled(d, alongIntRc)\n      )\n      p.push(\n        c\n          .addScaled(n, acrossSz)\n          .addScaled(d, tiltTan * acrossSz)\n          .addScaled(d, -alongIntRc)\n      )\n      p.push(\n        c\n          .addScaled(n, -acrossSz)\n          .addScaled(d, -tiltTan * acrossSz)\n          .addScaled(d, -alongIntRc)\n      )\n      p.push(c.addScaled(d, alongSz).addScaled(n, acrossInt))\n      p.push(c.addScaled(d, -alongSz).addScaled(n, acrossInt))\n      p.push(c.addScaled(d, alongSz).addScaled(n, -acrossInt))\n      p.push(c.addScaled(d, -alongSz).addScaled(n, -acrossInt))\n      break\n    // case Bond.PATTERN.REACTING_CENTER.UNCHANGED: draw a circle\n    case Bond.PATTERN.REACTING_CENTER.MADE_OR_BROKEN:\n      p.push(c.addScaled(n, acrossSz).addScaled(d, alongIntMadeBroken))\n      p.push(c.addScaled(n, -acrossSz).addScaled(d, alongIntMadeBroken))\n      p.push(c.addScaled(n, acrossSz).addScaled(d, -alongIntMadeBroken))\n      p.push(c.addScaled(n, -acrossSz).addScaled(d, -alongIntMadeBroken))\n      break\n    case Bond.PATTERN.REACTING_CENTER.ORDER_CHANGED:\n      p.push(c.addScaled(n, acrossSz))\n      p.push(c.addScaled(n, -acrossSz))\n      break\n    case Bond.PATTERN.REACTING_CENTER.MADE_OR_BROKEN_AND_CHANGED:\n      p.push(c.addScaled(n, acrossSz).addScaled(d, alongIntMadeBroken))\n      p.push(c.addScaled(n, -acrossSz).addScaled(d, alongIntMadeBroken))\n      p.push(c.addScaled(n, acrossSz).addScaled(d, -alongIntMadeBroken))\n      p.push(c.addScaled(n, -acrossSz).addScaled(d, -alongIntMadeBroken))\n      p.push(c.addScaled(n, acrossSz))\n      p.push(c.addScaled(n, -acrossSz))\n      break\n    default:\n      return null\n  }\n  return draw.reactingCenter(render.paper, p, render.options)\n}\n\nfunction getTopologyMark(\n  render: Render,\n  bond: ReBond,\n  hb1: HalfBond,\n  hb2: HalfBond\n) {\n  // eslint-disable-line max-statements\n  const options = render.options\n  let mark: string | null = null\n\n  if (bond.b.topology === Bond.PATTERN.TOPOLOGY.RING) mark = 'rng'\n  else if (bond.b.topology === Bond.PATTERN.TOPOLOGY.CHAIN) mark = 'chn'\n  else return null\n\n  const a = hb1.p,\n    b = hb2.p\n  const c = b.add(a).scaled(0.5)\n  const d = b.sub(a).normalized()\n  let n = d.rotateSC(1, 0)\n  let fixed = options.lineWidth\n  if (bond.doubleBondShift > 0) n = n.scaled(-bond.doubleBondShift)\n  else if (bond.doubleBondShift == 0) fixed += options.bondSpace / 2\n\n  const s = new Vec2(2, 1).scaled(options.bondSpace)\n  if (bond.b.type == Bond.PATTERN.TYPE.TRIPLE) fixed += options.bondSpace\n  const p = c.add(new Vec2(n.x * (s.x + fixed), n.y * (s.y + fixed)))\n\n  return draw.topologyMark(render.paper, p, mark, options)\n}\n\nfunction getIdsPath(\n  bid: number,\n  paper: any,\n  hb1: HalfBond,\n  hb2: HalfBond,\n  bondIdxOff: number,\n  param1: number,\n  param2: number,\n  norm: Vec2\n) {\n  // eslint-disable-line max-params\n  const pb = Vec2.lc(hb1.p, param1, hb2.p, param2, norm, bondIdxOff)\n  const ipath = paper.text(pb.x, pb.y, bid.toString())\n  const irbb = util.relBox(ipath.getBBox())\n  draw.recenterText(ipath, irbb)\n  return ipath\n}\n/* ----- */\n\nfunction setDoubleBondShift(bond: ReBond, struct: Struct): void {\n  let loop1, loop2\n  const hb1 = bond.b.hb1\n  const hb2 = bond.b.hb2\n\n  if ((!hb1 && hb1 !== 0) || (!hb2 && hb2 !== 0)) {\n    bond.doubleBondShift = selectDoubleBondShiftChain(struct, bond)\n    return\n  }\n\n  loop1 = struct.halfBonds.get(hb1)?.loop\n  loop2 = struct.halfBonds.get(hb2)?.loop\n  if (loop1 >= 0 && loop2 >= 0) {\n    const d1 = struct.loops.get(loop1)!.dblBonds\n    const d2 = struct.loops.get(loop2)!.dblBonds\n    const n1 = struct.loops.get(loop1)!.hbs.length\n    const n2 = struct.loops.get(loop2)!.hbs.length\n    bond.doubleBondShift = selectDoubleBondShift(n1, n2, d1, d2)\n  } else if (loop1 >= 0) {\n    bond.doubleBondShift = -1\n  } else if (loop2 >= 0) {\n    bond.doubleBondShift = 1\n  } else {\n    bond.doubleBondShift = selectDoubleBondShiftChain(struct, bond)\n  }\n}\n\nfunction bondRecalc(bond: ReBond, restruct: ReStruct, options: any): void {\n  const render = restruct.render\n  const atom1 = restruct.atoms.get(bond.b.begin)\n  const atom2 = restruct.atoms.get(bond.b.end)\n\n  if (!atom1 || !atom2 || bond.b.hb1 === undefined || bond.b.hb2 === undefined)\n    return\n\n  const p1 = Scale.obj2scaled(atom1.a.pp, render.options)\n  const p2 = Scale.obj2scaled(atom2.a.pp, render.options)\n  const hb1 = restruct.molecule.halfBonds.get(bond.b.hb1)\n  const hb2 = restruct.molecule.halfBonds.get(bond.b.hb2)\n\n  if (!hb1?.dir || !hb2?.dir) return\n\n  hb1.p = shiftBondEnd(atom1, p1, hb1.dir, 2 * options.lineWidth)\n  hb2.p = shiftBondEnd(atom2, p2, hb2.dir, 2 * options.lineWidth)\n  bond.b.center = Vec2.lc2(atom1.a.pp, 0.5, atom2.a.pp, 0.5)\n  bond.b.len = Vec2.dist(p1, p2)\n  bond.b.sb = options.lineWidth * 5\n  /* eslint-disable no-mixed-operators*/\n  bond.b.sa = Math.max(bond.b.sb, bond.b.len / 2 - options.lineWidth * 2)\n  /* eslint-enable no-mixed-operators*/\n  bond.b.angle = (Math.atan2(hb1.dir.y, hb1.dir.x) * 180) / Math.PI\n}\n\nfunction shiftBondEnd(\n  atom: ReAtom,\n  pos0: Vec2,\n  dir: Vec2,\n  margin: number\n): Vec2 {\n  let t = 0\n  const visel = atom.visel\n  for (var k = 0; k < visel.exts.length; ++k) {\n    var box = visel.exts[k].translate(pos0)\n    t = Math.max(t, util.shiftRayBox(pos0, dir, box))\n  }\n  if (t > 0) pos0 = pos0.addScaled(dir, t + margin)\n  return pos0\n}\n\nfunction selectDoubleBondShift(\n  n1: number,\n  n2: number,\n  d1: number,\n  d2: number\n): number {\n  if (n1 == 6 && n2 != 6 && (d1 > 1 || d2 == 1)) return -1\n  if (n2 == 6 && n1 != 6 && (d2 > 1 || d1 == 1)) return 1\n  if (n2 * d1 > n1 * d2) return -1\n  if (n2 * d1 < n1 * d2) return 1\n  if (n2 > n1) return -1\n  return 1\n}\n\nfunction selectDoubleBondShiftChain(struct: Struct, bond: ReBond): number {\n  if ((!bond.b.hb1 && bond.b.hb1 !== 0) || (!bond.b.hb2 && bond.b.hb2 !== 0))\n    return 0\n\n  const hb1 = struct.halfBonds.get(bond.b.hb1)\n  const hb2 = struct.halfBonds.get(bond.b.hb2)\n  if (!hb1 || !hb2) return 0\n  const nLeft = (hb1.leftSin > 0.3 ? 1 : 0) + (hb2.rightSin > 0.3 ? 1 : 0)\n  const nRight = (hb2.leftSin > 0.3 ? 1 : 0) + (hb1.rightSin > 0.3 ? 1 : 0)\n  if (nLeft > nRight) return -1\n  if (nLeft < nRight) return 1\n  if ((hb1.leftSin > 0.3 ? 1 : 0) + (hb1.rightSin > 0.3 ? 1 : 0) == 1) return 1\n  return 0\n}\n\nexport default ReBond\n","/****************************************************************************\n * Copyright 2021 EPAM Systems\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *    http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n ***************************************************************************/\n\nimport { Box2Abs, Fragment, StereoFlag } from 'domain/entities'\n\nimport { LayerMap } from './generalEnumTypes'\nimport ReObject from './reobject'\nimport ReStruct from './restruct'\nimport { Render } from '../raphaelRender'\nimport { Scale } from 'domain/helpers'\n\nclass ReEnhancedFlag extends ReObject {\n  #path: any\n\n  constructor() {\n    super('enhancedFlag')\n  }\n\n  static isSelectable() {\n    return true\n  }\n\n  hoverPath(render: Render): any {\n    const box = Box2Abs.fromRelBox(this.#path.getBBox())\n    const sz = box.p1.sub(box.p0)\n    const p0 = box.p0.sub(render.options.offset)\n    return render.paper.rect(p0.x, p0.y, sz.x, sz.y)\n  }\n\n  drawHover(render: Render): any {\n    // TODO: after the enhanced flag stops being displayed, need to remove the reEnhancedflag object from ctab\n    if (!this.#path?.attrs) return null\n    const ret = this.hoverPath(render).attr(render.options.hoverStyle)\n    render.ctab.addReObjectPath(LayerMap.hovering, this.visel, ret)\n    return ret\n  }\n  // @ts-ignore\n  makeSelectionPlate(restruct: ReStruct, paper: any, options: any): any {\n    // TODO: after the enhanced flag stops being displayed, need to remove the reEnhancedflag object from ctab\n    if (!this.#path?.attrs) return null\n    return this.hoverPath(restruct.render).attr(options.selectionStyle)\n  }\n\n  show(restruct: ReStruct, fragmentId: number, options: any): void {\n    const render = restruct.render\n    const fragment = restruct.molecule.frags.get(fragmentId)\n    if (!fragment?.enhancedStereoFlag) return\n\n    const position = fragment.stereoFlagPosition\n      ? fragment.stereoFlagPosition\n      : Fragment.getDefaultStereoFlagPosition(restruct.molecule, fragmentId)!\n\n    const paper = render.paper\n    const ps = Scale.obj2scaled(position, options)\n\n    const stereoFlagMap = {\n      [StereoFlag.Abs]: options.absFlagLabel,\n      [StereoFlag.And]: options.andFlagLabel,\n      [StereoFlag.Mixed]: options.mixedFlagLabel,\n      [StereoFlag.Or]: options.orFlagLabel\n    }\n\n    if (options.showStereoFlags) {\n      this.#path = paper\n        .text(\n          ps.x,\n          ps.y,\n          fragment.enhancedStereoFlag\n            ? stereoFlagMap[fragment.enhancedStereoFlag]\n            : ''\n        )\n        .attr({\n          font: options.font,\n          'font-size': options.fontsz,\n          fill: '#000'\n        })\n    }\n    render.ctab.addReObjectPath(\n      LayerMap.data,\n      this.visel,\n      this.#path,\n      null,\n      true\n    )\n  }\n}\n\nexport default ReEnhancedFlag\n","/****************************************************************************\n * Copyright 2021 EPAM Systems\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *    http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n ***************************************************************************/\n\nimport { Box2Abs, Vec2 } from 'domain/entities'\n\nimport ReObject from './reobject'\nimport { Scale } from 'domain/helpers'\n\nclass ReFrag extends ReObject {\n  constructor(/* Struct.Fragment */ frag) {\n    super('frag')\n    this.item = frag\n  }\n  static isSelectable() {\n    return false\n  }\n  fragGetAtoms(restruct, fid) {\n    return Array.from(restruct.atoms.keys()).filter(\n      aid => restruct.atoms.get(aid).a.fragment === fid\n    )\n  }\n  fragGetBonds(restruct, fid) {\n    return Array.from(restruct.bonds.keys()).filter(bid => {\n      const bond = restruct.bonds.get(bid).b\n\n      const firstFrag = restruct.atoms.get(bond.begin).a.fragment\n      const secondFrag = restruct.atoms.get(bond.end).a.fragment\n\n      return firstFrag === fid && secondFrag === fid\n    })\n  }\n  calcBBox(restruct, fid, render) {\n    // TODO need to review parameter list\n    var ret\n    restruct.atoms.forEach(atom => {\n      if (atom.a.fragment !== fid) return\n\n      // TODO ReObject.calcBBox to be used instead\n      let bba = atom.visel.boundingBox\n      if (!bba) {\n        bba = new Box2Abs(atom.a.pp, atom.a.pp)\n        const ext = new Vec2(0.05 * 3, 0.05 * 3)\n        bba = bba.extend(ext, ext)\n      } else {\n        if (!render) render = global._ui_editor.render // eslint-disable-line\n        bba = bba\n          .translate((render.options.offset || new Vec2()).negated())\n          .transform(Scale.scaled2obj, render.options)\n      }\n      ret = ret ? Box2Abs.union(ret, bba) : bba\n    })\n\n    return ret\n  }\n  // TODO need to review parameter list\n  _draw(render, fid, attrs) {\n    // eslint-disable-line no-underscore-dangle\n    const bb = this.calcBBox(render.ctab, fid, render)\n\n    if (bb) {\n      const p0 = Scale.obj2scaled(new Vec2(bb.p0.x, bb.p0.y), render.options)\n      const p1 = Scale.obj2scaled(new Vec2(bb.p1.x, bb.p1.y), render.options)\n      return render.paper\n        .rect(p0.x, p0.y, p1.x - p0.x, p1.y - p0.y, 0)\n        .attr(attrs)\n    }\n\n    // TODO abnormal situation, empty fragments must be destroyed by tools\n    return\n  }\n  draw(render) {\n    // eslint-disable-line no-unused-vars\n    return null // this._draw(render, fid, { 'stroke' : 'lightgray' }); // [RB] for debugging only\n  }\n\n  drawHover(render) {\n    // eslint-disable-line no-unused-vars\n    // Do nothing. This method shouldn't actually be called.\n  }\n\n  setHover(hover, render) {\n    let fid = render.ctab.frags.keyOf(this)\n\n    if (!fid && fid !== 0) {\n      console.warn('Fragment does not belong to the render')\n      return\n    }\n\n    fid = parseInt(fid, 10)\n\n    render.ctab.atoms.forEach(atom => {\n      if (atom.a.fragment === fid) atom.setHover(hover, render)\n    })\n\n    render.ctab.bonds.forEach(bond => {\n      if (render.ctab.atoms.get(bond.b.begin).a.fragment === fid) {\n        bond.setHover(hover, render)\n      }\n    })\n  }\n}\nexport default ReFrag\n","/****************************************************************************\n * Copyright 2021 EPAM Systems\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *    http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n ***************************************************************************/\n\nimport { Box2Abs, Vec2 } from 'domain/entities'\n\nimport { LayerMap } from './generalEnumTypes'\nimport ReObject from './reobject'\nimport { Scale } from 'domain/helpers'\nimport draw from '../draw'\nimport util from '../util'\n\nvar BORDER_EXT = new Vec2(0.05 * 3, 0.05 * 3)\nclass ReRGroup extends ReObject {\n  constructor(/* RGroup*/ rgroup) {\n    super('rgroup')\n    this.labelBox = null\n    this.item = rgroup\n  }\n  static isSelectable() {\n    return false\n  }\n  getAtoms(render) {\n    var ret = []\n    this.item.frags.forEach(fid => {\n      ret = ret.concat(\n        render.ctab.frags.get(fid).fragGetAtoms(render.ctab, fid)\n      )\n    })\n    return ret\n  }\n  getBonds(render) {\n    var ret = []\n    this.item.frags.forEach(fid => {\n      ret = ret.concat(\n        render.ctab.frags.get(fid).fragGetBonds(render.ctab, fid)\n      )\n    })\n    return ret\n  }\n  calcBBox(render) {\n    let ret = null\n    this.item.frags.forEach(fid => {\n      const bbf = render.ctab.frags.get(fid).calcBBox(render.ctab, fid, render)\n      if (bbf) ret = ret ? Box2Abs.union(ret, bbf) : bbf\n    })\n\n    if (ret) ret = ret.extend(BORDER_EXT, BORDER_EXT)\n\n    return ret\n  }\n  // TODO need to review parameter list\n  draw(render, options) {\n    // eslint-disable-line max-statements\n    const bb = this.calcBBox(render)\n\n    if (!bb) {\n      console.error(\n        'Abnormal situation, empty fragments must be destroyed by tools'\n      )\n      return {}\n    }\n\n    const ret = { data: [] }\n    const p0 = Scale.obj2scaled(bb.p0, options)\n    const p1 = Scale.obj2scaled(bb.p1, options)\n    const brackets = render.paper.set()\n\n    rGroupdrawBrackets(brackets, render, bb) // eslint-disable-line new-cap\n\n    ret.data.push(brackets)\n    const key = render.ctab.rgroups.keyOf(this)\n    const labelSet = render.paper.set()\n    const label = render.paper\n      .text(p0.x, (p0.y + p1.y) / 2, 'R' + key + '=')\n      .attr({\n        font: options.font,\n        'font-size': options.fontRLabel,\n        fill: 'black'\n      })\n\n    const labelBox = util.relBox(label.getBBox())\n    label.translateAbs(-labelBox.width / 2 - options.lineWidth, 0)\n\n    labelSet.push(label)\n    const logicStyle = {\n      font: options.font,\n      'font-size': options.fontRLogic,\n      fill: 'black'\n    }\n\n    const logic = [rLogicToString(key, this.item)]\n\n    let shift = labelBox.height / 2 + options.lineWidth / 2\n    for (let i = 0; i < logic.length; ++i) {\n      const logicPath = render.paper\n        .text(p0.x, (p0.y + p1.y) / 2, logic[i])\n        .attr(logicStyle)\n      const logicBox = util.relBox(logicPath.getBBox())\n      shift += logicBox.height / 2\n      logicPath.translateAbs(-logicBox.width / 2 - 6 * options.lineWidth, shift)\n      shift += logicBox.height / 2 + options.lineWidth / 2\n      ret.data.push(logicPath)\n      labelSet.push(logicPath)\n    }\n\n    ret.data.push(label)\n    this.labelBox = Box2Abs.fromRelBox(labelSet.getBBox()).transform(\n      Scale.scaled2obj,\n      render.options\n    )\n    return ret\n  }\n  // TODO need to review parameter list\n  _draw(render, rgid, attrs) {\n    // eslint-disable-line no-underscore-dangle\n    if (!this.getVBoxObj(render)) return null\n    const bb = this.getVBoxObj(render).extend(BORDER_EXT, BORDER_EXT) // eslint-disable-line no-underscore-dangle\n\n    if (!bb) return null\n\n    const p0 = Scale.obj2scaled(bb.p0, render.options)\n    const p1 = Scale.obj2scaled(bb.p1, render.options)\n    return render.paper\n      .rect(p0.x, p0.y, p1.x - p0.x, p1.y - p0.y, 0)\n      .attr(attrs)\n  }\n\n  drawHover(render) {\n    const rgid = render.ctab.rgroups.keyOf(this)\n\n    if (!rgid) {\n      console.error(\n        'Abnormal situation, fragment does not belong to the render'\n      )\n      return null\n    }\n\n    const ret = this._draw(\n      render,\n      rgid,\n      render.options.hoverStyle /* { 'fill' : 'red' } */\n    ) // eslint-disable-line no-underscore-dangle\n    render.ctab.addReObjectPath(LayerMap.hovering, this.visel, ret)\n\n    this.item.frags.forEach((fnum, fid) => {\n      render.ctab.frags.get(fid).drawHover(render)\n    })\n\n    return ret\n  }\n  show(restruct, id, options) {\n    const drawing = this.draw(restruct.render, options)\n\n    Object.keys(drawing).forEach(group => {\n      while (drawing[group].length > 0)\n        restruct.addReObjectPath(\n          LayerMap.data,\n          this.visel,\n          drawing[group].shift(),\n          null,\n          true\n        )\n    })\n    // TODO rgroup selection & highlighting\n  }\n}\n\nfunction rGroupdrawBrackets(set, render, bb, d) {\n  d = Scale.obj2scaled(d || new Vec2(1, 0), render.options)\n  var bracketWidth = Math.min(0.25, bb.sz().x * 0.3)\n  var bracketHeight = bb.p1.y - bb.p0.y\n  var cy = 0.5 * (bb.p1.y + bb.p0.y)\n\n  var leftBracket = draw.bracket(\n    render.paper,\n    d.negated(),\n    d.negated().rotateSC(1, 0),\n    Scale.obj2scaled(new Vec2(bb.p0.x, cy), render.options),\n    bracketWidth,\n    bracketHeight,\n    render.options\n  )\n\n  var rightBracket = draw.bracket(\n    render.paper,\n    d,\n    d.rotateSC(1, 0),\n    Scale.obj2scaled(new Vec2(bb.p1.x, cy), render.options),\n    bracketWidth,\n    bracketHeight,\n    render.options\n  )\n\n  return set.push(leftBracket, rightBracket)\n}\n\nfunction rLogicToString(id, rLogic) {\n  const ifThen = rLogic.ifthen > 0 ? 'IF ' : ''\n\n  const rangeExists =\n    rLogic.range.startsWith('>') ||\n    rLogic.range.startsWith('<') ||\n    rLogic.range.startsWith('=')\n\n  let range = null\n  if (rLogic.range.length > 0)\n    range = rangeExists ? rLogic.range : '=' + rLogic.range\n  else range = '>0'\n\n  const restH = rLogic.resth ? ' (RestH)' : ''\n  const nextRg = rLogic.ifthen > 0 ? '\\nTHEN R' + rLogic.ifthen.toString() : ''\n\n  return `${ifThen}R${id.toString()}${range}${restH}${nextRg}`\n}\n\nexport default ReRGroup\n","/****************************************************************************\n * Copyright 2021 EPAM Systems\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *    http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n ***************************************************************************/\n\nimport { Box2Abs, Vec2 } from 'domain/entities'\n\nimport { LayerMap } from './generalEnumTypes'\nimport Raphael from '../raphael-ext'\nimport ReObject from './reobject'\nimport ReStruct from './restruct'\nimport { Render } from '../raphaelRender'\nimport { Scale } from 'domain/helpers'\nimport draw from '../draw'\nimport util from '../util'\n\ntype Arrow = {\n  pos: Array<Vec2>\n  mode: string\n}\n\ntype ArrowParams = {\n  length: number\n  angle: number\n}\ninterface MinDistanceWithReferencePoint {\n  minDist: number\n  refPoint: Vec2 | null\n}\n\nclass ReRxnArrow extends ReObject {\n  item: Arrow\n\n  constructor(/* chem.RxnArrow*/ arrow: Arrow) {\n    super('rxnArrow')\n    this.item = arrow\n  }\n  static isSelectable(): boolean {\n    return true\n  }\n\n  calcDistance(p: Vec2, s: any): MinDistanceWithReferencePoint {\n    const point: Vec2 = new Vec2(p.x, p.y)\n    let dist: number\n    let distRef: MinDistanceWithReferencePoint\n    const item = this.item\n\n    const pos = item.pos\n\n    dist = calculateDistanceToLine(pos, point)\n\n    distRef = this.getReferencePointDistance(p)\n    const refPoint: Vec2 | null =\n      distRef.minDist <= 8 / s ? distRef.refPoint : null\n    // distance is a smallest between dist to figure and it's reference points\n    dist = Math.min(distRef.minDist, dist)\n    return { minDist: dist, refPoint }\n  }\n\n  getReferencePointDistance(p: Vec2): MinDistanceWithReferencePoint {\n    let dist: any = []\n    const refPoints = this.getReferencePoints()\n    refPoints.forEach(rp => {\n      dist.push({ minDist: Math.abs(Vec2.dist(p, rp)), refPoint: rp })\n    })\n\n    const minDist: MinDistanceWithReferencePoint = dist.reduce(\n      (acc, current) =>\n        !acc ? current : acc.minDist < current.minDist ? acc : current,\n      null\n    )\n\n    return minDist\n  }\n\n  hoverPath(render: Render) {\n    const path = this.generatePath(render, render.options, 'selection')\n\n    return render.paper.path(path)\n  }\n\n  drawHover(render: Render) {\n    const ret = this.hoverPath(render).attr(render.options.hoverStyle)\n    render.ctab.addReObjectPath(LayerMap.hovering, this.visel, ret)\n    return ret\n  }\n\n  getReferencePoints(): Array<Vec2> {\n    const refPoints: Array<Vec2> = []\n\n    this.item.pos.forEach(i => refPoints.push(new Vec2(i.x, i.y, 0)))\n\n    return refPoints\n  }\n\n  makeSelectionPlate(restruct: ReStruct, _paper, styles) {\n    const render = restruct.render\n    const options = restruct.render.options\n\n    const refPoints = this.getReferencePoints()\n    const scaleFactor = options.scale\n    const selectionSet = restruct.render.paper.set()\n    selectionSet.push(\n      render.paper\n        .path(this.generatePath(render, options, 'selection'))\n        .attr(styles.selectionStyle)\n    )\n\n    refPoints.forEach(rp => {\n      const scaledRP = Scale.obj2scaled(rp, restruct.render.options)\n      selectionSet.push(\n        restruct.render.paper\n          .circle(scaledRP.x, scaledRP.y, scaleFactor / 8)\n          .attr({ fill: 'black' })\n      )\n    })\n    return selectionSet\n  }\n\n  generatePath(render: Render, options, type) {\n    let path\n\n    const pos = this.item.pos.map(p => {\n      return Scale.obj2scaled(p, options) || new Vec2()\n    })\n\n    const arrowParams: ArrowParams = this.getArrowParams(\n      pos[0].x,\n      pos[0].y,\n      pos[1].x,\n      pos[1].y\n    )\n\n    const startPoint = new Vec2(pos[0].x, pos[0].y)\n    const endPoint = new Vec2(pos[1].x, pos[1].y)\n\n    switch (type) {\n      case 'selection':\n        path = draw.rectangleWithAngle(\n          render.paper,\n          startPoint,\n          endPoint,\n          arrowParams.length,\n          arrowParams.angle,\n          options\n        )\n        break\n      case 'arrow':\n        path = draw.arrow(\n          render.paper,\n          startPoint,\n          endPoint,\n          arrowParams.length,\n          arrowParams.angle,\n          options,\n          this.item.mode\n        )\n        break\n    }\n\n    return path\n  }\n\n  getArrowParams(x1, y1, x2, y2): ArrowParams {\n    const length = Math.sqrt((x2 - x1) ** 2 + (y2 - y1) ** 2)\n    const angle = Raphael.angle(x1, y1, x2, y2) - 180\n\n    return { length, angle }\n  }\n\n  show(restruct: ReStruct, _id, options) {\n    const path = this.generatePath(restruct.render, options, 'arrow')\n\n    const offset = options.offset\n    if (offset != null) path.translateAbs(offset.x, offset.y)\n\n    this.visel.add(path, Box2Abs.fromRelBox(util.relBox(path.getBBox())))\n  }\n}\n\nfunction calculateDistanceToLine(pos: Array<Vec2>, point: Vec2): number {\n  let dist: number\n  if (\n    (point.x < Math.min(pos[0].x, pos[1].x) ||\n      point.x > Math.max(pos[0].x, pos[1].x)) &&\n    (point.y < Math.min(pos[0].y, pos[1].y) ||\n      point.y > Math.max(pos[0].y, pos[1].y))\n  )\n    dist = Math.min(Vec2.dist(pos[0], point), Vec2.dist(pos[1], point))\n  else {\n    const a = Vec2.dist(pos[0], pos[1])\n    const b = Vec2.dist(pos[0], point)\n    const c = Vec2.dist(pos[1], point)\n    const per = (a + b + c) / 2\n    dist = (2 / a) * Math.sqrt(per * (per - a) * (per - b) * (per - c))\n  }\n  return dist\n}\n\nexport default ReRxnArrow\n","/****************************************************************************\n * Copyright 2021 EPAM Systems\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *    http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n ***************************************************************************/\n\nimport { Box2Abs } from 'domain/entities'\nimport { LayerMap } from './generalEnumTypes'\nimport ReObject from './reobject'\nimport { Scale } from 'domain/helpers'\nimport draw from '../draw'\nimport util from '../util'\n\nclass ReRxnPlus extends ReObject {\n  constructor(/* chem.RxnPlus*/ plus) {\n    super('rxnPlus')\n    this.item = plus\n  }\n  static isSelectable() {\n    return true\n  }\n\n  hoverPath(render) {\n    const p = Scale.obj2scaled(this.item.pp, render.options)\n    const s = render.options.scale\n    /* eslint-disable no-mixed-operators */\n    return render.paper.rect(p.x - s / 4, p.y - s / 4, s / 2, s / 2, s / 8)\n    /* eslint-enable no-mixed-operators*/\n  }\n\n  drawHover(render) {\n    const ret = this.hoverPath(render).attr(render.options.hoverStyle)\n    render.ctab.addReObjectPath(LayerMap.hovering, this.visel, ret)\n    return ret\n  }\n  makeSelectionPlate(restruct, paper, styles) {\n    // TODO [MK] review parameters\n    return this.hoverPath(restruct.render).attr(styles.selectionStyle)\n  }\n  show(restruct, id, options) {\n    var render = restruct.render\n    var centre = Scale.obj2scaled(this.item.pp, options)\n    var path = draw.plus(render.paper, centre, options)\n    var offset = options.offset\n    if (offset != null) path.translateAbs(offset.x, offset.y)\n    this.visel.add(path, Box2Abs.fromRelBox(util.relBox(path.getBBox())))\n  }\n}\n\nexport default ReRxnPlus\n","/****************************************************************************\n * Copyright 2021 EPAM Systems\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *    http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n ***************************************************************************/\n\nimport { LayerMap } from './generalEnumTypes'\nimport ReObject from './reobject'\nimport { Scale } from 'domain/helpers'\n\nclass ReDataSGroupData extends ReObject {\n  constructor(sgroup) {\n    super('sgroupData')\n    this.sgroup = sgroup\n  }\n  static isSelectable() {\n    return true\n  }\n\n  hoverPath(render) {\n    const box = this.sgroup.dataArea\n    const p0 = Scale.obj2scaled(box.p0, render.options)\n    const sz = Scale.obj2scaled(box.p1, render.options).sub(p0)\n    return render.paper.rect(p0.x, p0.y, sz.x, sz.y)\n  }\n\n  drawHover(render) {\n    const ret = this.hoverPath(render).attr(render.options.hoverStyle)\n    render.ctab.addReObjectPath(LayerMap.hovering, this.visel, ret)\n    return ret\n  }\n  makeSelectionPlate(restruct, paper, styles) {\n    // TODO [MK] review parameters\n    return this.hoverPath(restruct.render).attr(styles.selectionStyle)\n  }\n}\n\nexport default ReDataSGroupData\n","/****************************************************************************\n * Copyright 2021 EPAM Systems\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *    http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n ***************************************************************************/\n\nimport { Box2Abs, FunctionalGroup, Pile, SGroup, Vec2 } from 'domain/entities'\n\nimport { LayerMap } from './generalEnumTypes'\nimport ReDataSGroupData from './redatasgroupdata'\nimport ReObject from './reobject'\nimport { Scale } from 'domain/helpers'\nimport draw from '../draw'\nimport util from '../util'\n\nconst tfx = util.tfx\n\nclass ReSGroup extends ReObject {\n  constructor(sgroup) {\n    super('sgroup')\n    this.item = sgroup\n  }\n  static isSelectable() {\n    return false\n  }\n  draw(remol, sgroup) {\n    this.render = remol.render\n    let set = this.render.paper.set()\n    const atomSet = new Pile(sgroup.atoms)\n    const crossBonds = SGroup.getCrossBonds(remol.molecule, atomSet)\n    SGroup.bracketPos(sgroup, remol.molecule, crossBonds)\n    const bracketBox = sgroup.bracketBox\n    const d = sgroup.bracketDir\n    sgroup.areas = [bracketBox]\n    const functionalGroups = remol.molecule.functionalGroups\n    if (\n      FunctionalGroup.isContractedFunctionalGroup(sgroup.id, functionalGroups)\n    ) {\n      sgroup.firstSgroupAtom = remol.molecule.atoms.get(sgroup.atoms[0])\n      sgroup.functionalGroup = true\n    } else {\n      switch (sgroup.type) {\n        case 'MUL':\n          SGroupdrawBrackets(\n            set,\n            this.render,\n            sgroup,\n            crossBonds,\n            atomSet,\n            bracketBox,\n            d,\n            sgroup.data.mul\n          )\n          break\n        case 'SRU':\n          let connectivity = sgroup.data.connectivity || 'eu'\n          if (connectivity === 'ht') connectivity = ''\n          const subscript = sgroup.data.subscript || 'n'\n          SGroupdrawBrackets(\n            set,\n            this.render,\n            sgroup,\n            crossBonds,\n            atomSet,\n            bracketBox,\n            d,\n            subscript,\n            connectivity\n          )\n          break\n        case 'SUP':\n          SGroupdrawBrackets(\n            set,\n            this.render,\n            sgroup,\n            crossBonds,\n            atomSet,\n            bracketBox,\n            d,\n            sgroup.data.name,\n            null,\n            { 'font-style': 'italic' }\n          )\n          break\n        case 'GEN':\n          SGroupdrawBrackets(\n            set,\n            this.render,\n            sgroup,\n            crossBonds,\n            atomSet,\n            bracketBox,\n            d\n          )\n          break\n        case 'DAT':\n          set = drawGroupDat(remol, sgroup)\n          break\n        default:\n          break\n      }\n    }\n    return set\n  }\n  makeSelectionPlate(restruct, paper, options) {\n    const sgroup = this.item\n    const { startX, startY, size } = getHighlighPathInfo(sgroup, options)\n    const functionalGroups = restruct.molecule.functionalGroups\n    if (\n      FunctionalGroup.isContractedFunctionalGroup(sgroup.id, functionalGroups)\n    ) {\n      return paper.rect(startX, startY, size, size).attr(options.selectionStyle)\n    }\n  }\n\n  drawHover(render) {\n    // eslint-disable-line max-statements\n    var options = render.options\n    var paper = render.paper\n    var sGroupItem = this.item\n    const { a0, a1, b0, b1 } = getHighlighPathInfo(sGroupItem, options)\n\n    const functionalGroups = render.ctab.molecule.functionalGroups\n    var set = paper.set()\n    if (\n      FunctionalGroup.isContractedFunctionalGroup(\n        sGroupItem.id,\n        functionalGroups\n      )\n    ) {\n      const { startX, startY, size } = getHighlighPathInfo(sGroupItem, options)\n      sGroupItem.hovering = paper\n        .rect(startX, startY, size, size)\n        .attr(options.hoverStyle)\n    } else {\n      sGroupItem.hovering = paper\n        .path(\n          'M{0},{1}L{2},{3}L{4},{5}L{6},{7}L{0},{1}',\n          tfx(a0.x),\n          tfx(a0.y),\n          tfx(a1.x),\n          tfx(a1.y),\n          tfx(b1.x),\n          tfx(b1.y),\n          tfx(b0.x),\n          tfx(b0.y)\n        )\n        .attr(options.hoverStyle)\n    }\n    set.push(sGroupItem.hovering)\n\n    SGroup.getAtoms(render.ctab.molecule, sGroupItem).forEach(aid => {\n      set.push(render.ctab.atoms.get(aid).makeHoverPlate(render))\n    }, this)\n    SGroup.getBonds(render.ctab.molecule, sGroupItem).forEach(bid => {\n      set.push(render.ctab.bonds.get(bid).makeHoverPlate(render))\n    }, this)\n    render.ctab.addReObjectPath(LayerMap.hovering, this.visel, set)\n  }\n  show(restruct) {\n    var render = restruct.render\n    var sgroup = this.item\n    if (sgroup.data.fieldName !== 'MRV_IMPLICIT_H') {\n      var remol = render.ctab\n      var path = this.draw(remol, sgroup)\n      restruct.addReObjectPath(LayerMap.data, this.visel, path, null, true)\n      this.setHover(this.hover, render) // TODO: fix this\n    }\n  }\n}\n\nfunction SGroupdrawBrackets(\n  set,\n  render,\n  sg,\n  crossBonds,\n  atomSet,\n  bracketBox,\n  d,\n  lowerIndexText,\n  upperIndexText,\n  indexAttribute\n) {\n  // eslint-disable-line max-params\n  var brackets = getBracketParameters(\n    render.ctab.molecule,\n    crossBonds,\n    atomSet,\n    bracketBox,\n    d,\n    render,\n    sg.id\n  )\n  var ir = -1\n  for (var i = 0; i < brackets.length; ++i) {\n    var bracket = brackets[i]\n    var path = draw.bracket(\n      render.paper,\n      Scale.obj2scaled(bracket.d, render.options),\n      Scale.obj2scaled(bracket.n, render.options),\n      Scale.obj2scaled(bracket.c, render.options),\n      bracket.w,\n      bracket.h,\n      render.options\n    )\n    set.push(path)\n    if (\n      ir < 0 ||\n      brackets[ir].d.x < bracket.d.x ||\n      (brackets[ir].d.x === bracket.d.x && brackets[ir].d.y > bracket.d.y)\n    )\n      ir = i\n  }\n  var bracketR = brackets[ir]\n  function renderIndex(text, shift) {\n    var indexPos = Scale.obj2scaled(\n      bracketR.c.addScaled(bracketR.n, shift * bracketR.h),\n      render.options\n    )\n    var indexPath = render.paper.text(indexPos.x, indexPos.y, text).attr({\n      font: render.options.font,\n      'font-size': render.options.fontszsub\n    })\n    if (indexAttribute) indexPath.attr(indexAttribute)\n    var indexBox = Box2Abs.fromRelBox(util.relBox(indexPath.getBBox()))\n    var t =\n      Math.max(util.shiftRayBox(indexPos, bracketR.d.negated(), indexBox), 3) +\n      2\n    indexPath.translateAbs(t * bracketR.d.x, t * bracketR.d.y)\n    set.push(indexPath)\n  }\n  if (lowerIndexText) renderIndex(lowerIndexText, 0.5)\n  if (upperIndexText) renderIndex(upperIndexText, -0.5)\n}\n\nfunction showValue(paper, pos, sg, options) {\n  var text = paper.text(pos.x, pos.y, sg.data.fieldValue).attr({\n    font: options.font,\n    'font-size': options.fontsz\n  })\n  var box = text.getBBox()\n  var rect = paper.rect(\n    box.x - 1,\n    box.y - 1,\n    box.width + 2,\n    box.height + 2,\n    3,\n    3\n  )\n  rect = sg.selected\n    ? rect.attr(options.selectionStyle)\n    : rect.attr({ fill: '#fff', stroke: '#fff' })\n  var st = paper.set()\n  st.push(rect, text.toFront())\n  return st\n}\n\nfunction drawGroupDat(restruct, sgroup) {\n  sgroup.areas = sgroup.bracketBox ? [sgroup.bracketBox] : []\n\n  if (sgroup.pp === null) sgroup.calculatePP(restruct.molecule)\n\n  return sgroup.data.attached\n    ? drawAttachedDat(restruct, sgroup)\n    : drawAbsoluteDat(restruct, sgroup)\n}\n\nfunction drawAbsoluteDat(restruct, sgroup) {\n  const render = restruct.render\n  const options = render.options\n  const paper = render.paper\n  const set = paper.set()\n\n  const ps = sgroup.pp.scaled(options.scale)\n  const name = showValue(paper, ps, sgroup, options)\n  const box = util.relBox(name.getBBox())\n\n  name.translateAbs(0.5 * box.width, -0.5 * box.height)\n  set.push(name)\n\n  const sbox = Box2Abs.fromRelBox(util.relBox(name.getBBox()))\n  sgroup.dataArea = sbox.transform(Scale.scaled2obj, render.options)\n\n  if (!restruct.sgroupData.has(sgroup.id))\n    restruct.sgroupData.set(sgroup.id, new ReDataSGroupData(sgroup))\n\n  return set\n}\n\nfunction drawAttachedDat(restruct, sgroup) {\n  const render = restruct.render\n  const options = render.options\n  const paper = render.paper\n  const set = paper.set()\n\n  SGroup.getAtoms(restruct, sgroup).forEach(aid => {\n    const atom = restruct.atoms.get(aid)\n    const p = Scale.obj2scaled(atom.a.pp, options)\n    const bb = atom.visel.boundingBox\n\n    if (bb !== null) p.x = Math.max(p.x, bb.p1.x)\n\n    p.x += options.lineWidth // shift a bit to the right\n\n    const nameI = showValue(paper, p, sgroup, options)\n    const boxI = util.relBox(nameI.getBBox())\n\n    nameI.translateAbs(0.5 * boxI.width, -0.3 * boxI.height)\n    set.push(nameI)\n\n    let sboxI = Box2Abs.fromRelBox(util.relBox(nameI.getBBox()))\n    sboxI = sboxI.transform(Scale.scaled2obj, render.options)\n    sgroup.areas.push(sboxI)\n  })\n\n  return set\n}\n\nfunction getBracketParameters(\n  mol,\n  crossBonds,\n  atomSet,\n  bracketBox,\n  d,\n  render,\n  id\n) {\n  // eslint-disable-line max-params\n  function BracketParams(c, d, w, h) {\n    this.c = c\n    this.d = d\n    this.n = d.rotateSC(1, 0)\n    this.w = w\n    this.h = h\n  }\n  var brackets = []\n  var n = d.rotateSC(1, 0)\n\n  const crossBondsPerAtom = Object.values(crossBonds)\n  const crossBondsValues = crossBondsPerAtom.flat()\n  if (crossBondsValues.length < 2) {\n    ;(function () {\n      d = d || new Vec2(1, 0)\n      n = n || d.rotateSC(1, 0)\n      var bracketWidth = Math.min(0.25, bracketBox.sz().x * 0.3)\n      var cl = Vec2.lc2(\n        d,\n        bracketBox.p0.x,\n        n,\n        0.5 * (bracketBox.p0.y + bracketBox.p1.y)\n      )\n      var cr = Vec2.lc2(\n        d,\n        bracketBox.p1.x,\n        n,\n        0.5 * (bracketBox.p0.y + bracketBox.p1.y)\n      )\n      var bracketHeight = bracketBox.sz().y\n\n      brackets.push(\n        new BracketParams(cl, d.negated(), bracketWidth, bracketHeight),\n        new BracketParams(cr, d, bracketWidth, bracketHeight)\n      )\n    })()\n  } else if (crossBondsValues.length === 2 && crossBondsPerAtom.length === 2) {\n    ;(function () {\n      // eslint-disable-line max-statements\n      var b1 = mol.bonds.get(crossBondsValues[0])\n      var b2 = mol.bonds.get(crossBondsValues[1])\n      var cl0 = b1.getCenter(mol)\n      var cr0 = b2.getCenter(mol)\n      var tl = -1\n      var tr = -1\n      var tt = -1\n      var tb = -1\n      var cc = Vec2.centre(cl0, cr0)\n      var dr = Vec2.diff(cr0, cl0).normalized()\n      var dl = dr.negated()\n      var dt = dr.rotateSC(1, 0)\n      var db = dt.negated()\n\n      mol.sGroupForest.children.get(id).forEach(sgid => {\n        var bba = render.ctab.sgroups.get(sgid).visel.boundingBox\n        bba = bba\n          .translate((render.options.offset || new Vec2()).negated())\n          .transform(Scale.scaled2obj, render.options)\n        tl = Math.max(tl, util.shiftRayBox(cl0, dl, bba))\n        tr = Math.max(tr, util.shiftRayBox(cr0, dr, bba))\n        tt = Math.max(tt, util.shiftRayBox(cc, dt, bba))\n        tb = Math.max(tb, util.shiftRayBox(cc, db, bba))\n      }, this)\n      tl = Math.max(tl + 0.2, 0)\n      tr = Math.max(tr + 0.2, 0)\n      tt = Math.max(Math.max(tt, tb) + 0.1, 0)\n      var bracketWidth = 0.25\n      var bracketHeight = 1.5 + tt\n      brackets.push(\n        new BracketParams(\n          cl0.addScaled(dl, tl),\n          dl,\n          bracketWidth,\n          bracketHeight\n        ),\n        new BracketParams(\n          cr0.addScaled(dr, tr),\n          dr,\n          bracketWidth,\n          bracketHeight\n        )\n      )\n    })()\n  } else {\n    ;(function () {\n      for (var i = 0; i < crossBondsValues.length; ++i) {\n        var b = mol.bonds.get(crossBondsValues[i])\n        var c = b.getCenter(mol)\n        var d = atomSet.has(b.begin) ? b.getDir(mol) : b.getDir(mol).negated()\n        brackets.push(new BracketParams(c, d, 0.2, 1.0))\n      }\n    })()\n  }\n  return brackets\n}\n\nfunction getHighlighPathInfo(sgroup, options) {\n  let bracketBox = sgroup.bracketBox.transform(Scale.obj2scaled, options)\n  const lineWidth = options.lineWidth\n  const vext = new Vec2(lineWidth * 4, lineWidth * 6)\n  bracketBox = bracketBox.extend(vext, vext)\n  const d = sgroup.bracketDir,\n    n = d.rotateSC(1, 0)\n  const a0 = Vec2.lc2(d, bracketBox.p0.x, n, bracketBox.p0.y)\n  const a1 = Vec2.lc2(d, bracketBox.p0.x, n, bracketBox.p1.y)\n  const b0 = Vec2.lc2(d, bracketBox.p1.x, n, bracketBox.p0.y)\n  const b1 = Vec2.lc2(d, bracketBox.p1.x, n, bracketBox.p1.y)\n  const size = options.contractedFunctionalGroupSize\n  let startX = (b0.x + a0.x) / 2 - size / 2\n  let startY = (a1.y + a0.y) / 2 - size / 2\n  if (sgroup.firstSgroupAtom) {\n    const shift = new Vec2(size / 2, size / 2, 0)\n    const hoverPp = Vec2.diff(sgroup.firstSgroupAtom.pp.scaled(40), shift)\n    startX = hoverPp.x\n    startY = hoverPp.y\n  }\n  return {\n    a0,\n    a1,\n    b0,\n    b1,\n    startX,\n    startY,\n    size\n  }\n}\n\nexport default ReSGroup\n","/****************************************************************************\n * Copyright 2021 EPAM Systems\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *    http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n ***************************************************************************/\n\nimport { Box2Abs, SimpleObjectMode, Vec2 } from 'domain/entities'\n\nimport { LayerMap } from './generalEnumTypes'\nimport ReObject from './reobject'\nimport ReStruct from './restruct'\nimport { Render } from '../raphaelRender'\nimport { Scale } from 'domain/helpers'\nimport draw from '../draw'\nimport util from '../util'\n\nconst tfx = util.tfx\ninterface MinDistanceWithReferencePoint {\n  minDist: number\n  refPoint: Vec2 | null\n}\ninterface StyledPath {\n  path: any\n  stylesApplied: boolean\n}\nclass ReSimpleObject extends ReObject {\n  private item: any\n\n  constructor(simpleObject: any) {\n    super('simpleObject')\n    this.item = simpleObject\n  }\n  static isSelectable(): boolean {\n    return true\n  }\n  calcDistance(p: Vec2, s: any): MinDistanceWithReferencePoint {\n    const point: Vec2 = new Vec2(p.x, p.y)\n    let dist: number\n    let distRef: MinDistanceWithReferencePoint\n    const item = this.item\n    const mode = item.mode\n    const pos = item.pos\n\n    switch (mode) {\n      case SimpleObjectMode.ellipse: {\n        const rad = Vec2.diff(pos[1], pos[0])\n        const rx = rad.x / 2\n        const ry = rad.y / 2\n        const center = Vec2.sum(pos[0], new Vec2(rx, ry))\n        const pointToCenter = Vec2.diff(point, center)\n        if (rx !== 0 && ry !== 0) {\n          dist = Math.abs(\n            1 -\n              (pointToCenter.x * pointToCenter.x) / (rx * rx) -\n              (pointToCenter.y * pointToCenter.y) / (ry * ry)\n          )\n        } else {\n          // in case rx or ry is equal to 0 we have a line as a trivial case of ellipse\n          // in such case distance need to be calculated as a distance between line and current point\n          dist = calculateDistanceToLine(pos, point)\n        }\n        break\n      }\n      case SimpleObjectMode.rectangle: {\n        const topX = Math.min(pos[0].x, pos[1].x)\n        const topY = Math.min(pos[0].y, pos[1].y)\n        const bottomX = Math.max(pos[0].x, pos[1].x)\n        const bottomY = Math.max(pos[0].y, pos[1].y)\n\n        const distances: Array<number> = []\n\n        if (point.x >= topX && point.x <= bottomX) {\n          if (point.y < topY) {\n            distances.push(topY - point.y)\n          } else if (point.y > bottomY) {\n            distances.push(point.y - bottomY)\n          } else {\n            distances.push(point.y - topY, bottomY - point.y)\n          }\n        }\n        if (point.x < topX && point.y < topY) {\n          distances.push(Vec2.dist(new Vec2(topX, topY), point))\n        }\n        if (point.x > bottomX && point.y > bottomY) {\n          distances.push(Vec2.dist(new Vec2(bottomX, bottomY), point))\n        }\n        if (point.x < topX && point.y > bottomY) {\n          distances.push(Vec2.dist(new Vec2(topX, bottomY), point))\n        }\n        if (point.x > bottomX && point.y < topY) {\n          distances.push(Vec2.dist(new Vec2(bottomX, topY), point))\n        }\n        if (point.y >= topY && point.y <= bottomY) {\n          if (point.x < topX) {\n            distances.push(topX - point.x)\n          } else if (point.x > bottomX) {\n            distances.push(point.x - bottomX)\n          } else {\n            distances.push(point.x - topX, bottomX - point.x)\n          }\n        }\n        dist = Math.min(...distances)\n        break\n      }\n      case SimpleObjectMode.line: {\n        dist = calculateDistanceToLine(pos, point)\n        break\n      }\n\n      default: {\n        throw new Error('Unsupported shape type')\n      }\n    }\n\n    distRef = this.getReferencePointDistance(p)\n    const refPoint: Vec2 | null =\n      distRef.minDist <= 8 / s ? distRef.refPoint : null\n    // distance is a smallest between dist to figure and it's reference points\n    dist = Math.min(distRef.minDist, dist)\n    return { minDist: dist, refPoint }\n  }\n\n  getReferencePointDistance(p: Vec2): MinDistanceWithReferencePoint {\n    let dist: any = []\n    const refPoints = this.getReferencePoints()\n    refPoints.forEach(rp => {\n      dist.push({ minDist: Math.abs(Vec2.dist(p, rp)), refPoint: rp })\n    })\n\n    const minDist: MinDistanceWithReferencePoint = dist.reduce(\n      (acc, current) =>\n        !acc ? current : acc.minDist < current.minDist ? acc : current,\n      null\n    )\n\n    return minDist\n  }\n  getReferencePoints(onlyOnObject: boolean = false): Array<Vec2> {\n    const refPoints: Array<Vec2> = []\n    switch (this.item.mode) {\n      case SimpleObjectMode.ellipse:\n      case SimpleObjectMode.rectangle: {\n        const p0: Vec2 = new Vec2(\n          Math.min(this.item.pos[0].x, this.item.pos[1].x),\n          Math.min(this.item.pos[0].y, this.item.pos[1].y)\n        )\n        const w = Math.abs(Vec2.diff(this.item.pos[0], this.item.pos[1]).x)\n        const h = Math.abs(Vec2.diff(this.item.pos[0], this.item.pos[1]).y)\n\n        refPoints.push(\n          new Vec2(p0.x + 0.5 * w, p0.y),\n          new Vec2(p0.x + w, p0.y + 0.5 * h),\n          new Vec2(p0.x + 0.5 * w, p0.y + h),\n          new Vec2(p0.x, p0.y + 0.5 * h)\n        )\n        if (!onlyOnObject || this.item.mode === SimpleObjectMode.rectangle) {\n          refPoints.push(\n            p0,\n            new Vec2(p0.x, p0.y + h),\n            new Vec2(p0.x + w, p0.y + h),\n            new Vec2(p0.x + w, p0.y)\n          )\n        }\n        break\n      }\n      case SimpleObjectMode.line: {\n        this.item.pos.forEach(i => refPoints.push(new Vec2(i.x, i.y, 0)))\n        break\n      }\n\n      default: {\n        throw new Error('Unsupported shape type')\n      }\n    }\n    return refPoints\n  }\n\n  hoverPath(render: Render): Array<StyledPath> {\n    const point: Array<Vec2> = []\n\n    this.item.pos.forEach((p, index) => {\n      point[index] = Scale.obj2scaled(p, render.options)\n    })\n    const scaleFactor = render.options.scale\n\n    const path: Array<any> = []\n\n    //TODO: It seems that inheritance will be the better approach here\n    switch (this.item.mode) {\n      case SimpleObjectMode.ellipse: {\n        const rad = Vec2.diff(point[1], point[0])\n        const rx = rad.x / 2\n        const ry = rad.y / 2\n        path.push(\n          render.paper.ellipse(\n            tfx(point[0].x + rx),\n            tfx(point[0].y + ry),\n            tfx(Math.abs(rx) + scaleFactor / 8),\n            tfx(Math.abs(ry) + scaleFactor / 8)\n          )\n        )\n        if (\n          Math.abs(rx) - scaleFactor / 8 > 0 &&\n          Math.abs(ry) - scaleFactor / 8 > 0\n        )\n          path.push(\n            render.paper.ellipse(\n              tfx(point[0].x + rx),\n              tfx(point[0].y + ry),\n              tfx(Math.abs(rx) - scaleFactor / 8),\n              tfx(Math.abs(ry) - scaleFactor / 8)\n            )\n          )\n        break\n      }\n\n      case SimpleObjectMode.rectangle: {\n        path.push(\n          render.paper.rect(\n            tfx(Math.min(point[0].x, point[1].x) - scaleFactor / 8),\n            tfx(Math.min(point[0].y, point[1].y) - scaleFactor / 8),\n            tfx(\n              Math.max(point[0].x, point[1].x) -\n                Math.min(point[0].x, point[1].x) +\n                scaleFactor / 4\n            ),\n            tfx(\n              Math.max(point[0].y, point[1].y) -\n                Math.min(point[0].y, point[1].y) +\n                scaleFactor / 4\n            )\n          )\n        )\n\n        if (\n          Math.max(point[0].x, point[1].x) -\n            Math.min(point[0].x, point[1].x) -\n            scaleFactor / 4 >\n            0 &&\n          Math.max(point[0].y, point[1].y) -\n            Math.min(point[0].y, point[1].y) -\n            scaleFactor / 4 >\n            0\n        )\n          path.push(\n            render.paper.rect(\n              tfx(Math.min(point[0].x, point[1].x) + scaleFactor / 8),\n              tfx(Math.min(point[0].y, point[1].y) + scaleFactor / 8),\n              tfx(\n                Math.max(point[0].x, point[1].x) -\n                  Math.min(point[0].x, point[1].x) -\n                  scaleFactor / 4\n              ),\n              tfx(\n                Math.max(point[0].y, point[1].y) -\n                  Math.min(point[0].y, point[1].y) -\n                  scaleFactor / 4\n              )\n            )\n          )\n\n        break\n      }\n      case SimpleObjectMode.line: {\n        //TODO: reuse this code for polyline\n        const poly: Array<string | number> = []\n\n        let angle = Math.atan(\n          (point[1].y - point[0].y) / (point[1].x - point[0].x)\n        )\n\n        const p0 = { x: 0, y: 0 }\n        const p1 = { x: 0, y: 0 }\n\n        const k = point[0].x > point[1].x ? -1 : 1\n\n        p0.x = point[0].x - k * ((scaleFactor / 8) * Math.cos(angle))\n        p0.y = point[0].y - k * ((scaleFactor / 8) * Math.sin(angle))\n        p1.x = point[1].x + k * ((scaleFactor / 8) * Math.cos(angle))\n        p1.y = point[1].y + k * ((scaleFactor / 8) * Math.sin(angle))\n\n        poly.push(\n          'M',\n          p0.x + ((k * scaleFactor) / 8) * Math.sin(angle),\n          p0.y - ((k * scaleFactor) / 8) * Math.cos(angle)\n        )\n        poly.push(\n          'L',\n          p1.x + ((k * scaleFactor) / 8) * Math.sin(angle),\n          p1.y - ((k * scaleFactor) / 8) * Math.cos(angle)\n        )\n        poly.push(\n          'L',\n          p1.x - ((k * scaleFactor) / 8) * Math.sin(angle),\n          p1.y + ((k * scaleFactor) / 8) * Math.cos(angle)\n        )\n        poly.push(\n          'L',\n          p0.x - ((k * scaleFactor) / 8) * Math.sin(angle),\n          p0.y + ((k * scaleFactor) / 8) * Math.cos(angle)\n        )\n        poly.push(\n          'L',\n          p0.x + ((k * scaleFactor) / 8) * Math.sin(angle),\n          p0.y - ((k * scaleFactor) / 8) * Math.cos(angle)\n        )\n\n        path.push(render.paper.path(poly))\n        break\n      }\n      default: {\n        throw new Error('Unsupported shape type')\n      }\n    }\n\n    const enhPaths: Array<StyledPath> = path.map(p => {\n      return { path: p, stylesApplied: false }\n    })\n\n    return enhPaths\n  }\n\n  drawHover(render: Render): Array<any> {\n    const paths: Array<any> = this.hoverPath(render).map(enhPath => {\n      if (!enhPath.stylesApplied) {\n        return enhPath.path.attr(render.options.hoverStyle)\n      }\n      return enhPath.path\n    })\n\n    render.ctab.addReObjectPath(LayerMap.hovering, this.visel, paths)\n    return paths\n  }\n\n  makeSelectionPlate(restruct: ReStruct, paper: any, styles: any): any {\n    const pos = this.item.pos.map(p => {\n      return Scale.obj2scaled(p, restruct.render.options) || new Vec2()\n    })\n\n    const refPoints = this.getReferencePoints()\n    const scaleFactor = restruct.render.options.scale\n    var selectionSet = restruct.render.paper.set()\n    selectionSet.push(\n      generatePath(this.item.mode, paper, pos).attr(\n        styles.hoverStyleSimpleObject\n      )\n    )\n    refPoints.forEach(rp => {\n      const scaledRP = Scale.obj2scaled(rp, restruct.render.options)\n      selectionSet.push(\n        restruct.render.paper\n          .circle(scaledRP.x, scaledRP.y, scaleFactor / 8)\n          .attr({ fill: 'black' })\n      )\n    })\n    return selectionSet\n  }\n  show(restruct: ReStruct, options: any): void {\n    const render = restruct.render\n    const pos = this.item.pos.map(p => {\n      return Scale.obj2scaled(p, options) || new Vec2()\n    })\n\n    const path = generatePath(this.item.mode, render.paper, pos, options)\n\n    var offset = options.offset\n    if (offset != null) path.translateAbs(offset.x, offset.y)\n\n    // @ts-ignore\n    this.visel.add(path, Box2Abs.fromRelBox(util.relBox(path.getBBox())))\n  }\n}\nfunction calculateDistanceToLine(pos: Array<Vec2>, point: Vec2): number {\n  let dist: number\n  if (\n    (point.x < Math.min(pos[0].x, pos[1].x) ||\n      point.x > Math.max(pos[0].x, pos[1].x)) &&\n    (point.y < Math.min(pos[0].y, pos[1].y) ||\n      point.y > Math.max(pos[0].y, pos[1].y))\n  )\n    dist = Math.min(Vec2.dist(pos[0], point), Vec2.dist(pos[1], point))\n  else {\n    const a = Vec2.dist(pos[0], pos[1])\n    const b = Vec2.dist(pos[0], point)\n    const c = Vec2.dist(pos[1], point)\n    const per = (a + b + c) / 2\n    dist = (2 / a) * Math.sqrt(per * (per - a) * (per - b) * (per - c))\n  }\n  return dist\n}\n\nfunction generatePath(mode: SimpleObjectMode, paper, pos: Vec2, options?): any {\n  let path: any\n  switch (mode) {\n    case SimpleObjectMode.ellipse: {\n      path = draw.ellipse(paper, pos, options)\n      break\n    }\n    case SimpleObjectMode.rectangle: {\n      path = draw.rectangle(paper, pos, options)\n      break\n    }\n    case SimpleObjectMode.line: {\n      path = draw.line(paper, pos, options)\n      break\n    }\n    default: {\n      throw new Error('Unsupported shape type')\n    }\n  }\n\n  return path\n}\n\nexport default ReSimpleObject\n","/****************************************************************************\n * Copyright 2021 EPAM Systems\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *    http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n ***************************************************************************/\n\nimport { Bond, Vec2 } from 'domain/entities'\n\nimport { LayerMap } from './generalEnumTypes'\nimport ReObject from './reobject'\nimport { Scale } from 'domain/helpers'\nimport util from '../util'\n\nconst tfx = util.tfx\n\nclass ReLoop extends ReObject {\n  constructor(loop) {\n    super('loop')\n    this.loop = loop\n    this.centre = new Vec2()\n    this.radius = new Vec2()\n  }\n  static isSelectable() {\n    return false\n  }\n  show(restruct, rlid, options) {\n    // eslint-disable-line max-statements\n    var render = restruct.render\n    var paper = render.paper\n    var molecule = restruct.molecule\n    var loop = this.loop\n    this.centre = new Vec2()\n    loop.hbs.forEach(hbid => {\n      var hb = molecule.halfBonds.get(hbid)\n      var bond = restruct.bonds.get(hb.bid)\n      var apos = Scale.obj2scaled(restruct.atoms.get(hb.begin).a.pp, options)\n      if (bond.b.type !== Bond.PATTERN.TYPE.AROMATIC) loop.aromatic = false\n      this.centre.add_(apos) // eslint-disable-line no-underscore-dangle\n    })\n    loop.convex = true\n    for (var k = 0; k < this.loop.hbs.length; ++k) {\n      var hba = molecule.halfBonds.get(loop.hbs[k])\n      var hbb = molecule.halfBonds.get(loop.hbs[(k + 1) % loop.hbs.length])\n      var angle = Math.atan2(\n        Vec2.cross(hba.dir, hbb.dir),\n        Vec2.dot(hba.dir, hbb.dir)\n      )\n      if (angle > 0) loop.convex = false\n    }\n\n    this.centre = this.centre.scaled(1.0 / loop.hbs.length)\n    this.radius = -1\n    loop.hbs.forEach(hbid => {\n      var hb = molecule.halfBonds.get(hbid)\n      var apos = Scale.obj2scaled(restruct.atoms.get(hb.begin).a.pp, options)\n      var bpos = Scale.obj2scaled(restruct.atoms.get(hb.end).a.pp, options)\n      var n = Vec2.diff(bpos, apos).rotateSC(1, 0).normalized()\n      var dist = Vec2.dot(Vec2.diff(apos, this.centre), n)\n      this.radius = this.radius < 0 ? dist : Math.min(this.radius, dist)\n    })\n    this.radius *= 0.7\n    if (!loop.aromatic) return\n    var path = null\n    if (loop.convex && options.aromaticCircle) {\n      path = paper.circle(this.centre.x, this.centre.y, this.radius).attr({\n        stroke: '#000',\n        'stroke-width': options.lineattr['stroke-width']\n      })\n    } else {\n      var pathStr = ''\n      for (k = 0; k < loop.hbs.length; ++k) {\n        hba = molecule.halfBonds.get(loop.hbs[k])\n        hbb = molecule.halfBonds.get(loop.hbs[(k + 1) % loop.hbs.length])\n        angle = Math.atan2(\n          Vec2.cross(hba.dir, hbb.dir),\n          Vec2.dot(hba.dir, hbb.dir)\n        )\n        var halfAngle = (Math.PI - angle) / 2\n        var dir = hbb.dir.rotate(halfAngle)\n        var pi = Scale.obj2scaled(restruct.atoms.get(hbb.begin).a.pp, options)\n        var sin = Math.sin(halfAngle)\n        var minSin = 0.1\n        if (Math.abs(sin) < minSin) sin = (sin * minSin) / Math.abs(sin)\n        var offset = options.bondSpace / sin\n        var qi = pi.addScaled(dir, -offset)\n        pathStr += k === 0 ? 'M' : 'L'\n        pathStr += tfx(qi.x) + ',' + tfx(qi.y)\n      }\n      pathStr += 'Z'\n      path = paper.path(pathStr).attr({\n        stroke: '#000',\n        'stroke-width': options.lineattr['stroke-width'],\n        'stroke-dasharray': '- '\n      })\n    }\n    restruct.addReObjectPath(LayerMap.data, this.visel, path, null, true)\n  }\n  isValid(struct, rlid) {\n    const halfBonds = struct.halfBonds\n    return this.loop.hbs.every(\n      hbid => halfBonds.has(hbid) && halfBonds.get(hbid).loop === rlid\n    )\n  }\n}\n\nexport default ReLoop\n","/****************************************************************************\n * Copyright 2021 EPAM Systems\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *    http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n ***************************************************************************/\n\nimport {\n  DraftInlineStyleType,\n  RawDraftContentBlock,\n  RawDraftContentState,\n  RawDraftInlineStyleRange\n} from 'draft-js'\nimport { Text, TextCommand, Vec2 } from 'domain/entities'\nimport { flatten, isEqual } from 'lodash/fp'\n\nimport { LayerMap } from './generalEnumTypes'\nimport ReObject from './reobject'\nimport ReStruct from './restruct'\nimport { Scale } from 'domain/helpers'\n\nclass ReText extends ReObject {\n  private item: Text\n  paths: Array<Array<any>> = []\n\n  constructor(text: Text) {\n    super('text')\n    this.item = text\n  }\n  static isSelectable() {\n    return true\n  }\n\n  getReferencePoints(): Array<Vec2> {\n    const { p0, p1 } = this.getRelBox(this.paths)\n\n    const p = this.item.position\n    const w = Math.abs(Vec2.diff(p0, p1).x) / 40\n    const h = Math.abs(Vec2.diff(p0, p1).y) / 40\n\n    const refPoints: Array<Vec2> = []\n\n    refPoints.push(\n      this.item.position,\n      new Vec2(p.x, p.y + h),\n      new Vec2(p.x + w, p.y + h),\n      new Vec2(p.x + w, p.y)\n    )\n\n    return refPoints\n  }\n\n  hoverPath(render: any): any {\n    const { p0, p1 } = this.getRelBox(this.paths)\n    const topLeft = p0.sub(render.options.offset)\n    const { x: width, y: height } = p1.sub(p0)\n\n    return render.paper.rect(topLeft.x, topLeft.y, width, height, 5)\n  }\n\n  getRelBox(paths: Array<Array<any>>): { p0: Vec2; p1: Vec2 } {\n    const firstElOfFirstRow: any = paths[0][0]\n    const leftEdge = firstElOfFirstRow.getBBox().x\n\n    const firstRow: Array<any> = paths[0]\n    const topEdge: number = Math.min(...firstRow.map(path => path.getBBox().y))\n\n    const widestRow: Array<any> = paths.reduce(\n      (widestRow, nextRow) =>\n        this.getRowWidth(nextRow) > this.getRowWidth(widestRow)\n          ? nextRow\n          : widestRow,\n      paths[0]\n    )\n    const lastElOfWidestRow: any = widestRow[widestRow.length - 1]\n    const rightEdge: number =\n      lastElOfWidestRow.getBBox().x + lastElOfWidestRow.getBBox().width\n\n    const lastRow: Array<any> = paths[paths.length - 1]\n    const bottomEdge: number = Math.max(\n      ...lastRow.map(path => path.getBBox().y + path.getBBox().height)\n    )\n\n    return {\n      p0: new Vec2(leftEdge, topEdge),\n      p1: new Vec2(rightEdge, bottomEdge)\n    }\n  }\n\n  getRowWidth(row: Array<any>): number {\n    return row.reduce((rowWidth, nextRow) => {\n      rowWidth += nextRow.getBBox().width\n      return rowWidth\n    }, 0)\n  }\n\n  drawHover(render: any): any {\n    if (!this.paths.length) return null\n    const ret = this.hoverPath(render).attr(render.options.hoverStyle)\n    render.ctab.addReObjectPath(LayerMap.hovering, this.visel, ret)\n    return ret\n  }\n\n  makeSelectionPlate(restruct: ReStruct, paper: any, options: any): any {\n    if (!this.paths.length || !paper) return null\n    return this.hoverPath(restruct.render).attr(options.selectionStyle)\n  }\n\n  show(restruct: ReStruct, _id: number, options: any): void {\n    const render = restruct.render\n    const paper = render.paper\n    const paperScale = Scale.obj2scaled(this.item.position, options)\n\n    let shiftY: number = 0\n    this.paths = []\n    //TODO: create parser in ketcher-core package\n    const rawContentState: RawDraftContentState | null = this.item.content\n      ? (JSON.parse(this.item.content) as RawDraftContentState)\n      : null\n    if (!rawContentState) return\n    rawContentState.blocks.forEach((block: RawDraftContentBlock) => {\n      const ranges: Array<[number, number, Record<string, any>]> =\n        this.getRanges(block, options)\n      let shiftX: number = 0\n      const row: Array<any> = []\n      ranges.forEach(([start, end, styles]) => {\n        block.text = block.text.replace(/[^\\S\\r\\n]/g, '\\u00a0')\n\n        const path = paper\n          .text(\n            paperScale.x,\n            paperScale.y,\n            block.text.substring(start, end + 1) || '\\u00a0'\n          )\n          .attr({\n            font: options.font,\n            'font-size': options.fontsz,\n            'text-anchor': 'start',\n            fill: '#000000',\n            ...styles\n          })\n\n        path.translateAbs(shiftX, shiftY + (styles.shiftY || 0))\n\n        row.push(path)\n        shiftX += path.getBBox().width\n      })\n\n      this.paths.push(row)\n\n      const { p0, p1 } = this.getRelBox([row])\n      shiftY += Math.abs(Vec2.diff(p0, p1).y)\n    })\n\n    render.ctab.addReObjectPath(\n      LayerMap.data,\n      this.visel,\n      flatten(this.paths),\n      null,\n      true\n    )\n  }\n\n  getRanges(\n    block: RawDraftContentBlock,\n    options: any\n  ): Array<[number, number, Record<string, any>]> {\n    const ranges: Array<[number, number, Record<string, any>]> = []\n\n    let start: number = 0\n    let styles: Record<string, any> = this.getStyles(block, start, options)\n    for (let i = 1; i < block.text.length; i++) {\n      const nextStyles = this.getStyles(block, i, options)\n\n      if (!isEqual(styles, nextStyles)) {\n        ranges.push([start, i - 1, styles])\n        styles = nextStyles\n        start = i\n      }\n    }\n    ranges.push([start, block.text.length - 1, styles])\n\n    return ranges\n  }\n\n  getStyles(\n    block: RawDraftContentBlock,\n    index: number,\n    options: any\n  ): Record<string, string> {\n    const ranges = block.inlineStyleRanges.filter(\n      (inlineRange: CustomRawDraftInlineStyleRange) =>\n        inlineRange.offset <= index &&\n        index < inlineRange.offset + inlineRange.length\n    )\n\n    const customFontSize: number | null = ranges.reduce(\n      (acc: number | null, range: any) => {\n        if (range.style.includes(TextCommand.FontSize)) {\n          return range.style.match(/\\d+/)?.[0]\n        }\n        return acc\n      },\n      null\n    )\n\n    return ranges.reduce(\n      (styles: any, textRange: CustomRawDraftInlineStyleRange) => {\n        const fontsz = customFontSize || options.fontsz\n        const fontszsub = (customFontSize || options.fontszsub) * 0.8\n        switch (textRange.style) {\n          case TextCommand.Bold:\n            styles['font-weight'] = 'bold'\n            break\n\n          case TextCommand.Italic:\n            styles['font-style'] = 'italic'\n            break\n\n          case TextCommand.Subscript:\n            styles['font-size'] = fontszsub + 'px'\n            styles.shiftY = fontsz / 3\n\n            break\n\n          case TextCommand.Superscript:\n            styles['font-size'] = fontszsub + 'px'\n            styles.shiftY = -fontsz / 3\n            break\n\n          case `${TextCommand.FontSize}_${customFontSize}px`:\n            styles['font-size'] = customFontSize + 'px'\n            break\n\n          default:\n        }\n\n        return styles\n      },\n      {}\n    )\n  }\n}\n\ninterface CustomRawDraftInlineStyleRange\n  extends Omit<RawDraftInlineStyleRange, 'style'> {\n  style:\n    | DraftInlineStyleType\n    | TextCommand.Subscript\n    | TextCommand.Superscript\n    | TextCommand.FontSize\n}\n\nexport default ReText\n","/****************************************************************************\n * Copyright 2021 EPAM Systems\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *    http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n ***************************************************************************/\n\nimport {\n  Box2Abs,\n  FunctionalGroup,\n  Pile,\n  Pool,\n  Struct,\n  Vec2\n} from 'domain/entities'\n\nimport { LayerMap } from './generalEnumTypes'\nimport ReAtom from './reatom'\nimport ReBond from './rebond'\nimport ReDataSGroupData from './redatasgroupdata'\nimport ReEnhancedFlag from './reenhancedFlag'\nimport ReFrag from './refrag'\nimport ReLoop from './reloop'\nimport ReRGroup from './rergroup'\nimport ReRxnArrow from './rerxnarrow'\nimport ReRxnPlus from './rerxnplus'\nimport ReSGroup from './resgroup'\nimport ReSimpleObject from './resimpleObject'\nimport ReText from './retext'\nimport { Render } from '../raphaelRender'\nimport Visel from './visel'\nimport util from '../util'\n\nclass ReStruct {\n  public static maps = {\n    atoms: ReAtom,\n    bonds: ReBond,\n    rxnPluses: ReRxnPlus,\n    rxnArrows: ReRxnArrow,\n    frags: ReFrag,\n    rgroups: ReRGroup,\n    sgroupData: ReDataSGroupData,\n    enhancedFlags: ReEnhancedFlag,\n    sgroups: ReSGroup,\n    reloops: ReLoop,\n    simpleObjects: ReSimpleObject,\n    texts: ReText\n  }\n  public render: Render\n  public molecule: Struct\n  public atoms: Map<number, ReAtom> = new Map()\n  public bonds: Map<number, ReBond> = new Map()\n  public reloops: Map<number, ReLoop> = new Map()\n  public rxnPluses: Map<number, ReRxnPlus> = new Map()\n  public rxnArrows: Map<number, ReRxnArrow> = new Map()\n  public frags: Pool = new Pool()\n  public rgroups: Pool = new Pool()\n  public sgroups: Map<number, ReSGroup> = new Map()\n  public sgroupData: Map<number, ReDataSGroupData> = new Map()\n  public enhancedFlags: Map<number, ReEnhancedFlag> = new Map()\n  private simpleObjects: Map<number, ReSimpleObject> = new Map()\n  public texts: Map<number, ReText> = new Map()\n  private initialized: boolean = false\n  private layers: Array<any> = []\n  public connectedComponents: Pool = new Pool()\n  private ccFragmentType: Pool = new Pool()\n  private structChanged: boolean = false\n\n  private atomsChanged: Map<number, ReAtom> = new Map()\n  private simpleObjectsChanged: Map<number, ReSimpleObject> = new Map()\n  private rxnArrowsChanged: Map<number, ReRxnArrow> = new Map()\n  private rxnPlusesChanged: Map<number, ReRxnPlus> = new Map()\n  private enhancedFlagsChanged: Map<number, ReEnhancedFlag> = new Map()\n  private bondsChanged: Map<number, ReEnhancedFlag> = new Map()\n  private textsChanged: Map<number, ReText> = new Map()\n  constructor(molecule, render: Render) {\n    // eslint-disable-line max-statements\n    this.render = render\n    this.molecule = molecule || new Struct()\n    this.initLayers()\n    this.clearMarks()\n    // TODO: eachItem ?\n\n    molecule.atoms.forEach((atom, aid) => {\n      this.atoms.set(aid, new ReAtom(atom))\n    })\n\n    molecule.bonds.forEach((bond, bid) => {\n      this.bonds.set(bid, new ReBond(bond))\n    })\n\n    molecule.loops.forEach((loop, lid) => {\n      this.reloops.set(lid, new ReLoop(loop))\n    })\n\n    molecule.rxnPluses.forEach((item, id) => {\n      this.rxnPluses.set(id, new ReRxnPlus(item))\n    })\n\n    molecule.rxnArrows.forEach((item, id) => {\n      this.rxnArrows.set(id, new ReRxnArrow(item))\n    })\n\n    molecule.simpleObjects.forEach((item, id) => {\n      this.simpleObjects.set(id, new ReSimpleObject(item))\n    })\n\n    molecule.texts.forEach((item, id) => {\n      this.texts.set(id, new ReText(item))\n    })\n\n    molecule.frags.forEach((item, id) => {\n      this.frags.set(id, new ReFrag(item))\n      if (item) this.enhancedFlags.set(id, new ReEnhancedFlag())\n    })\n\n    molecule.rgroups.forEach((item, id) => {\n      this.rgroups.set(id, new ReRGroup(item))\n    })\n\n    molecule.sgroups.forEach((item, id) => {\n      this.sgroups.set(id, new ReSGroup(item))\n      if (item.type === 'DAT' && !item.data.attached)\n        this.sgroupData.set(id, new ReDataSGroupData(item)) // [MK] sort of a hack, we use the SGroup id for the data field id\n      if (FunctionalGroup.isFunctionalGroup(item)) {\n        this.molecule.functionalGroups.set(id, new FunctionalGroup(item))\n      }\n    })\n  }\n\n  connectedComponentRemoveAtom(aid: number, reAtom?: ReAtom): void {\n    const atom = reAtom || this.atoms.get(aid)\n    if (!atom || atom.component < 0) return\n    var cc = this.connectedComponents.get(atom.component)\n\n    cc.delete(aid)\n    if (cc.size < 1) this.connectedComponents.delete(atom.component)\n\n    atom.component = -1\n  }\n\n  clearConnectedComponents(): void {\n    this.connectedComponents.clear()\n    this.atoms.forEach(atom => {\n      atom.component = -1\n    })\n  }\n\n  getConnectedComponent(\n    aid: Array<number> | number,\n    adjacentComponents: Pile\n  ): Pile {\n    const list = Array.isArray(aid) ? Array.from(aid) : [aid]\n    const ids = new Pile()\n\n    while (list.length > 0) {\n      const aid = list.pop()!\n      ids.add(aid)\n      const atom = this.atoms.get(aid)\n      if (!atom) continue\n      if (atom.component >= 0) adjacentComponents.add(atom.component)\n\n      atom.a.neighbors.forEach(neighbor => {\n        let halfBond = this.molecule.halfBonds.get(neighbor)\n        if (!halfBond) return\n        const neiId = halfBond.end\n        if (!ids.has(neiId)) list.push(neiId)\n      })\n    }\n\n    return ids\n  }\n\n  addConnectedComponent(idSet: Pile<number>): number {\n    const compId = this.connectedComponents.add(idSet)\n    const adjacentComponents = new Pile()\n    const aidSet = this.getConnectedComponent(\n      Array.from(idSet),\n      adjacentComponents\n    )\n\n    adjacentComponents.delete(compId)\n\n    let type = -1\n    aidSet.forEach(aid => {\n      const atom = this.atoms.get(aid)\n      if (!atom) return\n      atom.component = compId\n      if (atom.a.rxnFragmentType !== -1) type = atom.a.rxnFragmentType\n    })\n\n    this.ccFragmentType.set(compId, type)\n    return compId\n  }\n\n  removeConnectedComponent(ccid: number): boolean {\n    this.connectedComponents.get(ccid).forEach(aid => {\n      const atom = this.atoms.get(aid)\n      if (atom) atom.component = -1\n    })\n\n    return this.connectedComponents.delete(ccid)\n  }\n\n  assignConnectedComponents(): void {\n    this.atoms.forEach((atom, aid) => {\n      if (atom.component >= 0) return\n\n      const adjacentComponents = new Pile()\n      const idSet = this.getConnectedComponent(aid, adjacentComponents)\n      adjacentComponents.forEach(ccid => {\n        this.removeConnectedComponent(ccid)\n      })\n\n      this.addConnectedComponent(idSet)\n    })\n  }\n\n  initLayers(): void {\n    for (const group in LayerMap) {\n      this.layers[LayerMap[group]] = this.render.paper\n        .rect(0, 0, 10, 10)\n        .attr({\n          class: group + 'Layer',\n          fill: '#000',\n          opacity: '0.0'\n        })\n        .toFront()\n    }\n  }\n\n  addReObjectPath(\n    group: LayerMap,\n    visel: Visel,\n    path,\n    pos: Vec2 | null = null,\n    visible: boolean = false\n  ): void {\n    // eslint-disable-line max-params\n    if (!path || !this.layers[group].node.parentNode) return\n\n    const paths = Array.isArray(path) ? path : [path]\n\n    paths.forEach(path => {\n      const offset = this.render.options.offset\n      let bb = visible ? Box2Abs.fromRelBox(util.relBox(path.getBBox())) : null\n      const ext = pos && bb ? bb.translate(pos.negated()) : null\n      if (offset !== null) {\n        path.translateAbs(offset.x, offset.y)\n        bb = bb ? bb.translate(offset) : null\n      }\n      visel.add(path, bb, ext)\n      path.insertBefore(this.layers[LayerMap[group]])\n    })\n  }\n\n  clearMarks(): void {\n    Object.keys(ReStruct.maps).forEach(map => {\n      this[map + 'Changed'] = new Map()\n    })\n\n    this.structChanged = false\n  }\n\n  markItemRemoved(): void {\n    this.structChanged = true\n  }\n\n  markBond(bid: number, mark: number): void {\n    this.markItem('bonds', bid, mark)\n  }\n\n  markAtom(aid: number, mark: number): void {\n    this.markItem('atoms', aid, mark)\n  }\n\n  markItem(map: string, id: number, mark: number): void {\n    const mapChanged = this[map + 'Changed']\n\n    const value = mapChanged.has(id) ? Math.max(mark, mapChanged.get(id)) : mark\n\n    mapChanged.set(id, value)\n\n    if (this[map].has(id)) this.clearVisel(this[map].get(id).visel)\n  }\n\n  clearVisel(visel: Visel): void {\n    visel.paths.forEach(path => {\n      path.remove()\n    })\n    visel.clear()\n  }\n\n  eachItem(func) {\n    Object.keys(ReStruct.maps).forEach(map => {\n      this[map].forEach(func)\n    })\n  }\n\n  getVBoxObj(selection): Box2Abs | null {\n    selection = selection || {}\n\n    if (isSelectionEmpty(selection)) {\n      Object.keys(ReStruct.maps).forEach(map => {\n        selection[map] = Array.from(this[map].keys())\n      })\n    }\n\n    let vbox: Box2Abs | null = null\n    Object.keys(ReStruct.maps).forEach(map => {\n      if (!selection[map]) return\n\n      selection[map].forEach(id => {\n        const box = this[map].get(id).getVBoxObj(this.render)\n        if (box) vbox = vbox ? Box2Abs.union(vbox, box) : box.clone()\n      })\n    })\n\n    vbox = vbox || new Box2Abs(0, 0, 0, 0)\n    return vbox\n  }\n\n  translate(d): void {\n    this.eachItem(item => item.visel.translate(d))\n  }\n\n  scale(s: number): void {\n    // NOTE: bounding boxes are not valid after scaling\n    this.eachItem(item => scaleVisel(item.visel, s))\n  }\n\n  clearVisels(): void {\n    this.eachItem(item => this.clearVisel(item.visel))\n  }\n\n  update(force: boolean): boolean {\n    // eslint-disable-line max-statements\n    force = force || !this.initialized\n\n    // check items to update\n    Object.keys(ReStruct.maps).forEach(map => {\n      const mapChanged = this[map + 'Changed']\n      if (force) {\n        this[map].forEach((_item, id) => mapChanged.set(id, 1))\n      } else {\n        // check if some of the items marked are already gone\n        mapChanged.forEach((_value, id) => {\n          if (!this[map].has(id)) mapChanged.delete(id)\n        })\n      }\n    })\n\n    this.atomsChanged.forEach((_value, aid) =>\n      this.connectedComponentRemoveAtom(aid)\n    )\n\n    // clean up empty fragments\n    // TODO: fragment removal should be triggered by the action responsible for the fragment contents removal and form an operation of its own\n    const emptyFrags = this.frags.filter(\n      (fid, frag) => !frag.calcBBox(this.render.ctab, fid, this.render)\n    )\n\n    emptyFrags.forEach((frag, fid) => {\n      this.clearVisel(frag.visel)\n      this.frags.delete(fid)\n      this.molecule.frags.delete(fid)\n    })\n\n    Object.keys(ReStruct.maps).forEach(map => {\n      const mapChanged = this[map + 'Changed']\n\n      mapChanged.forEach((_value, id) => {\n        this.clearVisel(this[map].get(id).visel)\n        this.structChanged = this.structChanged || mapChanged.get(id) > 0\n      })\n    })\n\n    // TODO: when to update sgroup?\n    this.sgroups.forEach(sgroup => {\n      this.clearVisel(sgroup.visel)\n      sgroup.hovering = null\n      sgroup.selectionPlate = null\n    })\n\n    // TODO [RB] need to implement update-on-demand for fragments and r-groups\n    this.frags.forEach(frag => {\n      this.clearVisel(frag.visel)\n    })\n\n    this.rgroups.forEach(rgroup => {\n      this.clearVisel(rgroup.visel)\n    })\n\n    if (force) {\n      // clear and recreate all half-bonds\n      this.clearConnectedComponents()\n      this.molecule.initHalfBonds()\n      this.molecule.initNeighbors()\n    }\n\n    // only update half-bonds adjacent to atoms that have moved\n    const atomsChangedArray = Array.from(this.atomsChanged.keys())\n    this.molecule.updateHalfBonds(atomsChangedArray)\n    this.molecule.sortNeighbors(atomsChangedArray)\n\n    this.assignConnectedComponents()\n    this.initialized = true\n\n    this.verifyLoops()\n    const updLoops = force || this.structChanged\n    if (updLoops) this.updateLoops()\n    this.showLabels()\n    this.showBonds()\n    if (updLoops) this.showLoops()\n    this.showReactionSymbols()\n    this.showSGroups()\n\n    this.showFragments()\n    this.showRGroups()\n    this.showEnhancedFlags()\n    this.showSimpleObjects()\n    this.showTexts()\n    this.clearMarks()\n\n    return true\n  }\n\n  updateLoops(): void {\n    this.reloops.forEach(reloop => {\n      this.clearVisel(reloop.visel)\n    })\n    const ret = this.molecule.findLoops()\n    ret.bondsToMark.forEach(bid => {\n      this.markBond(bid, 1)\n    })\n    ret.newLoops.forEach(loopId => {\n      this.reloops.set(loopId, new ReLoop(this.molecule.loops.get(loopId)))\n    })\n  }\n\n  showLoops(): void {\n    const options = this.render.options\n    this.reloops.forEach((reloop, rlid) => {\n      reloop.show(this, rlid, options)\n    })\n  }\n\n  showSimpleObjects(): void {\n    const options = this.render.options\n\n    this.simpleObjectsChanged.forEach((_value, id) => {\n      const simpleObject = this.simpleObjects.get(id)\n      if (simpleObject) simpleObject.show(this, options)\n    })\n  }\n\n  showTexts() {\n    const options = this.render.options\n\n    this.textsChanged.forEach((_value, id) => {\n      const text = this.texts.get(id)\n      if (text) text.show(this, id, options)\n    })\n  }\n\n  showReactionSymbols(): void {\n    const options = this.render.options\n\n    this.rxnArrowsChanged.forEach((_value, id) => {\n      const arrow = this.rxnArrows.get(id)\n      if (arrow) arrow.show(this, id, options)\n    })\n\n    this.rxnPlusesChanged.forEach((_value, id) => {\n      const plus = this.rxnPluses.get(id)\n      if (plus) plus.show(this, id, options)\n    })\n  }\n\n  showSGroups(): void {\n    this.molecule.sGroupForest\n      .getSGroupsBFS()\n      .reverse()\n      .forEach(id => {\n        const resgroup = this.sgroups.get(id)\n        if (!resgroup) return\n        resgroup.show(this)\n      })\n  }\n\n  showFragments(): void {\n    this.frags.forEach((frag, id) => {\n      const path = frag.draw(this.render, id)\n      if (path)\n        this.addReObjectPath(LayerMap.data, frag.visel, path, null, true)\n      // TODO fragment selection & highlighting\n    })\n  }\n\n  showRGroups(): void {\n    const options = this.render.options\n    this.rgroups.forEach((rgroup, id) => {\n      rgroup.show(this, id, options)\n    })\n  }\n\n  loopRemove(loopId: number): void {\n    const reloop = this.reloops.get(loopId)\n    if (!reloop) {\n      return\n    }\n    this.clearVisel(reloop.visel)\n\n    const bondlist: Array<number> = []\n\n    reloop.loop.hbs.forEach(hbid => {\n      const hb = this.molecule.halfBonds.get(hbid)\n      if (!hb) return\n      hb.loop = -1\n      this.markBond(hb.bid, 1)\n      this.markAtom(hb.begin, 1)\n      bondlist.push(hb.bid)\n    })\n\n    this.reloops.delete(loopId)\n    this.molecule.loops.delete(loopId)\n  }\n\n  verifyLoops(): void {\n    this.reloops.forEach((reloop, rlid) => {\n      if (!reloop.isValid(this.molecule, rlid)) this.loopRemove(rlid)\n    })\n  }\n\n  showLabels(): void {\n    // eslint-disable-line max-statements\n    const options = this.render.options\n\n    this.atomsChanged.forEach((_value, aid) => {\n      const atom = this.atoms.get(aid)\n      if (atom) atom.show(this, aid, options)\n    })\n  }\n\n  showEnhancedFlags(): void {\n    const options = this.render.options\n\n    this.enhancedFlagsChanged.forEach((_value, chid) => {\n      const flag = this.enhancedFlags.get(chid)\n      if (flag) flag.show(this, chid, options)\n    })\n  }\n\n  showBonds(): void {\n    // eslint-disable-line max-statements\n    const options = this.render.options\n\n    this.bondsChanged.forEach((_value, bid) => {\n      const bond = this.bonds.get(bid)\n      if (bond) bond.show(this, bid, options)\n    })\n  }\n\n  setSelection(selection) {\n    const redraw = arguments.length === 0 // render.update only\n    const atoms: { selected: boolean; sgroup: number }[] = []\n\n    Object.keys(ReStruct.maps).forEach(map => {\n      const [mapValues] = this[map].values() // hack to include ReSGroup, figure out better solution\n      if (ReStruct.maps[map].isSelectable() || mapValues instanceof ReSGroup) {\n        this[map].forEach((item, id) => {\n          if (item instanceof ReAtom) {\n            let sgroup\n            for (let sgId of item.a.sgs.values()) {\n              sgroup = sgId\n            }\n            atoms.push({\n              selected: item.selected,\n              sgroup: sgroup\n            })\n          }\n          if (\n            item instanceof ReSGroup &&\n            FunctionalGroup.isContractedFunctionalGroup(\n              item.item.id,\n              this.molecule.functionalGroups\n            )\n          ) {\n            const sGroupAtoms = atoms.filter(\n              atom => atom.sgroup === item.item.id\n            )\n            item.selected = sGroupAtoms.length > 0 && sGroupAtoms[0].selected\n          }\n          const selected = redraw\n            ? item.selected\n            : selection && selection[map] && selection[map].indexOf(id) > -1\n\n          this.showItemSelection(item, selected)\n        })\n      }\n    })\n  }\n  showItemSelection(item, selected) {\n    var exists = isSelectionSvgObjectExists(item)\n    // TODO: simplify me, who sets `removed`?\n    item.selected = selected\n    if (item instanceof ReDataSGroupData) item.sgroup.selected = selected\n    if (selected) {\n      if (!exists) {\n        var render = this.render\n        var options = render.options\n        var paper = render.paper\n\n        item.selectionPlate = item.makeSelectionPlate(this, paper, options)\n        this.addReObjectPath(\n          LayerMap.selectionPlate,\n          item.visel,\n          item.selectionPlate\n        )\n      }\n      if (item.selectionPlate) item.selectionPlate.show() // TODO [RB] review\n    } else if (exists && item.selectionPlate) {\n      item.selectionPlate.hide() // TODO [RB] review\n    }\n  }\n}\n\nfunction isSelectionEmpty(selection) {\n  if (!selection) return true\n\n  const anySelection = Object.keys(ReStruct.maps).some(\n    map => selection[map] && selection[map].length > 0\n  )\n\n  return !anySelection\n}\n\nfunction scaleRPath(path, scaleFactor: number): void {\n  if (path.type == 'set') {\n    // TODO: rework scaling\n    for (var i = 0; i < path.length; ++i) scaleRPath(path[i], scaleFactor)\n  } else {\n    if (!(typeof path.attrs === 'undefined')) {\n      if ('font-size' in path.attrs)\n        path.attr('font-size', path.attrs['font-size'] * scaleFactor)\n      else if ('stroke-width' in path.attrs)\n        path.attr('stroke-width', path.attrs['stroke-width'] * scaleFactor)\n    }\n    path.scale(scaleFactor, scaleFactor, 0, 0)\n  }\n}\n\nfunction scaleVisel(visel, s) {\n  for (let i = 0; i < visel.paths.length; ++i) scaleRPath(visel.paths[i], s)\n}\n\n/**\n * SelectionPlate could be an item then value would be in it\n * or it could be a set of items then removed value need to be check on at least one of items in set\n * @param item\n * @returns {boolean}\n */\nfunction isSelectionSvgObjectExists(item) {\n  return (\n    item &&\n    item.selectionPlate !== null &&\n    ((!item.selectionPlate?.items && !item.selectionPlate?.removed) ||\n      (Array.isArray(item.selectionPlate?.items) &&\n        !item.selectionPlate[0]?.removed))\n  )\n}\n\nexport default ReStruct\n","/****************************************************************************\n * Copyright 2021 EPAM Systems\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *    http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n ***************************************************************************/\n\nimport { Vec2 } from 'domain/entities'\nimport { inRange } from 'lodash'\n\nlet FRAC = Math.PI / 12 // '15¬∫'\n\nfunction setFracAngle(angle) {\n  FRAC = (Math.PI / 180) * angle\n}\n\nfunction calcAngle(pos0, pos1) {\n  const v = Vec2.diff(pos1, pos0)\n  return Math.atan2(v.y, v.x)\n}\n\nfunction fracAngle(angle, angle2) {\n  if (angle2) angle = calcAngle(angle, angle2)\n  return Math.round(angle / FRAC) * FRAC\n}\n\nfunction calcNewAtomPos(pos0, pos1, ctrlKey) {\n  const v = new Vec2(1, 0).rotate(\n    ctrlKey ? calcAngle(pos0, pos1) : fracAngle(pos0, pos1)\n  )\n  v.add_(pos0) // eslint-disable-line no-underscore-dangle\n  return v\n}\n\nfunction degrees(angle) {\n  let degree = Math.round((angle / Math.PI) * 180)\n  if (degree > 180) degree -= 360\n  else if (degree <= -180) degree += 360\n  return degree\n}\n\nconst BONDS_MERGE_ANGLE = 10 // '¬∫'\nconst BONDS_MERGE_SCALE = 0.2\n\nfunction mergeBondsParams(struct1, bond1, struct2, bond2) {\n  const begin1 = struct1.atoms.get(bond1.begin)\n  const begin2 = struct2.atoms.get(bond2.begin)\n  const end1 = struct1.atoms.get(bond1.end)\n  const end2 = struct2.atoms.get(bond2.end)\n\n  const angle = calcAngle(begin1.pp, end1.pp) - calcAngle(begin2.pp, end2.pp)\n  const mergeAngle = Math.abs(degrees(angle) % 180)\n\n  const scale = Vec2.dist(begin1.pp, end1.pp) / Vec2.dist(begin2.pp, end2.pp)\n\n  const merged =\n    !inRange(mergeAngle, BONDS_MERGE_ANGLE, 180 - BONDS_MERGE_ANGLE) &&\n    inRange(scale, 1 - BONDS_MERGE_SCALE, 1 + BONDS_MERGE_SCALE)\n\n  return { merged, angle, scale, cross: Math.abs(degrees(angle)) > 90 }\n}\n\nexport default {\n  calcAngle,\n  fracAngle,\n  calcNewAtomPos,\n  degrees,\n  setFracAngle,\n  mergeBondsParams\n}\n","/****************************************************************************\n * Copyright 2021 EPAM Systems\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *    http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n ***************************************************************************/\n\nimport { Box2Abs, Struct, Vec2 } from 'domain/entities'\n\nimport Raphael from './raphael-ext'\nimport { ReStruct } from './restruct'\nimport { Scale } from 'domain/helpers'\nimport defaultOptions from './options'\nimport draw from './draw'\n\nexport function Render(clientArea, opt) {\n  let renderWidth = clientArea.clientWidth - 10\n  let renderHeight = clientArea.clientHeight - 10\n  renderWidth = renderWidth > 0 ? renderWidth : 0\n  renderHeight = renderHeight > 0 ? renderHeight : 0\n\n  this.userOpts = opt\n  this.clientArea = clientArea\n  this.paper = new Raphael(clientArea, renderWidth, renderHeight)\n  this.sz = Vec2.ZERO\n  this.ctab = new ReStruct(new Struct(), this)\n  this.options = defaultOptions(this.userOpts)\n}\n\nRender.prototype.selectionPolygon = function (r) {\n  return draw.selectionPolygon(this.paper, r, this.options)\n}\n\nRender.prototype.selectionLine = function (p0, p1) {\n  return draw.selectionLine(this.paper, p0, p1, this.options)\n}\n\nRender.prototype.selectionRectangle = function (p0, p1) {\n  return draw.selectionRectangle(this.paper, p0, p1, this.options)\n}\n\nRender.prototype.view2obj = function (p, isRelative) {\n  var scroll = this.scrollPos()\n  if (!this.useOldZoom) {\n    p = p.scaled(1 / this.options.zoom)\n    scroll = scroll.scaled(1 / this.options.zoom)\n  }\n  p = isRelative ? p : p.add(scroll).sub(this.options.offset)\n  return Scale.scaled2obj(p, this.options)\n}\n\nRender.prototype.obj2view = function (v, isRelative) {\n  var p = Scale.obj2scaled(v, this.options)\n  p = isRelative\n    ? p\n    : p\n        .add(this.options.offset)\n        .sub(this.scrollPos().scaled(1 / this.options.zoom))\n  if (!this.useOldZoom) p = p.scaled(this.options.zoom)\n  return p\n}\n\nRender.prototype.scrollPos = function () {\n  return new Vec2(this.clientArea.scrollLeft, this.clientArea.scrollTop)\n}\n\nfunction cumulativeOffset(el) {\n  var curtop = 0\n  var curleft = 0\n  if (el.parentNode) {\n    do {\n      curtop += el.offsetTop || 0\n      curleft += el.offsetLeft || 0\n      el = el.offsetParent\n    } while (el)\n  }\n  return { left: curleft, top: curtop }\n}\n\nRender.prototype.page2obj = function (pagePos) {\n  var offset = cumulativeOffset(this.clientArea)\n  var pp = new Vec2(pagePos.pageX - offset.left, pagePos.pageY - offset.top)\n  return this.view2obj(pp)\n}\n\nRender.prototype.setPaperSize = function (sz) {\n  this.sz = sz\n  this.paper.setSize(sz.x * this.options.zoom, sz.y * this.options.zoom)\n  this.setViewBox(this.options.zoom)\n}\n\nRender.prototype.setOffset = function (newoffset) {\n  var delta = new Vec2(\n    newoffset.x - this.options.offset.x,\n    newoffset.y - this.options.offset.y\n  )\n  this.clientArea.scrollLeft += delta.x\n  this.clientArea.scrollTop += delta.y\n  this.options.offset = newoffset\n}\n\nRender.prototype.setZoom = function (zoom) {\n  // when scaling the canvas down it may happen that the scaled canvas is smaller than the view window\n  // don't forget to call setScrollOffset after zooming (or use extendCanvas directly)\n  this.options.zoom = zoom\n  this.paper.setSize(this.sz.x * zoom, this.sz.y * zoom)\n  this.setViewBox(zoom)\n}\n\nfunction calcExtend(sSz, x0, y0, x1, y1) {\n  // eslint-disable-line max-params\n  var ex = x0 < 0 ? -x0 : 0\n  var ey = y0 < 0 ? -y0 : 0\n\n  if (sSz.x < x1) ex += x1 - sSz.x\n  if (sSz.y < y1) ey += y1 - sSz.y\n  return new Vec2(ex, ey)\n}\n\nRender.prototype.setScrollOffset = function (x, y) {\n  var clientArea = this.clientArea\n  var cx = clientArea.clientWidth\n  var cy = clientArea.clientHeight\n  var e = calcExtend(\n    this.sz.scaled(this.options.zoom),\n    x,\n    y,\n    cx + x,\n    cy + y\n  ).scaled(1 / this.options.zoom)\n  if (e.x > 0 || e.y > 0) {\n    this.setPaperSize(this.sz.add(e))\n    var d = new Vec2(x < 0 ? -x : 0, y < 0 ? -y : 0).scaled(\n      1 / this.options.zoom\n    )\n    if (d.x > 0 || d.y > 0) {\n      this.ctab.translate(d)\n      this.setOffset(this.options.offset.add(d))\n    }\n  }\n  clientArea.scrollLeft = x\n  clientArea.scrollTop = y\n  // TODO: store drag position in scaled systems\n  // scrollLeft = clientArea.scrollLeft;\n  // scrollTop = clientArea.scrollTop;\n  this.update(false)\n}\n\nRender.prototype.setScale = function (z) {\n  if (this.options.offset)\n    this.options.offset = this.options.offset.scaled(1 / z).scaled(z)\n  this.userOpts.scale *= z\n  this.options = null\n  this.update(true)\n}\n\nRender.prototype.setViewBox = function (z) {\n  if (!this.useOldZoom)\n    this.paper.canvas.setAttribute(\n      'viewBox',\n      '0 0 ' + this.sz.x + ' ' + this.sz.y\n    )\n  else this.setScale(z)\n}\n\nRender.prototype.setMolecule = function (ctab) {\n  this.paper.clear()\n  this.ctab = new ReStruct(ctab, this)\n  this.options.offset = new Vec2()\n  this.update(false)\n}\n\nRender.prototype.update = function (force = false, viewSz = null) {\n  // eslint-disable-line max-statements\n  viewSz =\n    viewSz ||\n    new Vec2(\n      this.clientArea.clientWidth || 100,\n      this.clientArea.clientHeight || 100\n    )\n\n  var changes = this.ctab.update(force)\n  this.ctab.setSelection() // [MK] redraw the selection bits where necessary\n  if (changes) {\n    var sf = this.options.scale\n    var bb = this.ctab\n      .getVBoxObj()\n      .transform(Scale.obj2scaled, this.options)\n      .translate(this.options.offset || new Vec2())\n\n    if (!this.options.autoScale) {\n      var ext = Vec2.UNIT.scaled(sf)\n      var eb = bb.sz().length() > 0 ? bb.extend(ext, ext) : bb\n      var vb = new Box2Abs(\n        this.scrollPos(),\n        viewSz.scaled(1 / this.options.zoom).sub(Vec2.UNIT.scaled(20))\n      )\n      var cb = Box2Abs.union(vb, eb)\n      if (!this.oldCb) this.oldCb = new Box2Abs()\n\n      var sz = cb.sz().floor()\n      var delta = this.oldCb.p0.sub(cb.p0).ceil()\n      this.oldBb = bb\n      if (!this.sz || sz.x != this.sz.x || sz.y != this.sz.y)\n        this.setPaperSize(sz)\n\n      this.options.offset = this.options.offset || new Vec2()\n      if (delta.x != 0 || delta.y != 0) {\n        this.setOffset(this.options.offset.add(delta))\n        this.ctab.translate(delta)\n      }\n    } else {\n      var sz1 = bb.sz()\n      var marg = this.options.autoScaleMargin\n      var mv = new Vec2(marg, marg)\n      var csz = viewSz\n      if (csz.x < 2 * marg + 1 || csz.y < 2 * marg + 1)\n        throw new Error('View box too small for the given margin')\n      var rescale = Math.max(\n        sz1.x / (csz.x - 2 * marg),\n        sz1.y / (csz.y - 2 * marg)\n      )\n      if (this.options.maxBondLength / rescale > 1.0) rescale = 1.0\n      var sz2 = sz1.add(mv.scaled(2 * rescale))\n      /* eslint-disable no-mixed-operators*/\n      this.paper.setViewBox(\n        bb.pos().x - marg * rescale - (csz.x * rescale - sz2.x) / 2,\n        bb.pos().y - marg * rescale - (csz.y * rescale - sz2.y) / 2,\n        csz.x * rescale,\n        csz.y * rescale\n      )\n      /* eslint-enable no-mixed-operators*/\n    }\n  }\n}\n","/****************************************************************************\n * Copyright 2021 EPAM Systems\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *    http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n ***************************************************************************/\n\nimport { Vec2 } from 'domain/entities'\nimport utils from '../editor/shared/utils'\n\nfunction defaultOptions(opt) {\n  const scaleFactor = opt.scale || 100\n\n  if (opt.rotationStep) utils.setFracAngle(opt.rotationStep)\n\n  const labelFontSize = Math.ceil(1.9 * (scaleFactor / 6))\n  const subFontSize = Math.ceil(0.7 * labelFontSize)\n\n  const defaultOptions = {\n    // flags for debugging\n    showAtomIds: false,\n    showBondIds: false,\n    showHalfBondIds: false,\n    showLoopIds: false,\n    // rendering customization flags\n    // TODO: hide enhanced flags opts\n    showValenceWarnings: true,\n    autoScale: false, // scale structure to fit into the given view box, used in view mode\n    autoScaleMargin: 0,\n    maxBondLength: 0, // 0 stands for \"not specified\"\n    atomColoring: true,\n    hideImplicitHydrogen: false,\n    hideTerminalLabels: false,\n    // atoms\n    carbonExplicitly: false,\n    showCharge: true,\n    showHydrogenLabels: 'on',\n    showValence: true,\n    // bonds\n    aromaticCircle: true,\n\n    scale: scaleFactor,\n    zoom: 1.0,\n    offset: new Vec2(),\n\n    lineWidth: scaleFactor / 20,\n    bondSpace: opt.doubleBondWidth || scaleFactor / 7,\n    stereoBond: opt.stereoBondWidth || scaleFactor / 7,\n    subFontSize,\n    font: '30px Arial',\n    fontsz: labelFontSize,\n    fontszsub: subFontSize,\n    fontRLabel: labelFontSize * 1.2,\n    fontRLogic: labelFontSize * 0.7,\n\n    /* styles */\n    lineattr: {\n      stroke: '#000',\n      'stroke-width': opt.bondThickness || scaleFactor / 20,\n      'stroke-linecap': 'round',\n      'stroke-linejoin': 'round'\n    },\n    /* eslint-enable quote-props */\n    selectionStyle: {\n      fill: '#7f7',\n      stroke: 'none'\n    },\n    hoverStyle: {\n      stroke: '#0c0',\n      'stroke-width': (0.6 * scaleFactor) / 20\n    },\n    sgroupBracketStyle: {\n      stroke: 'darkgray',\n      'stroke-width': (0.5 * scaleFactor) / 20\n    },\n    lassoStyle: {\n      stroke: 'gray',\n      'stroke-width': '1px'\n    },\n    hoverStyleSimpleObject: {\n      stroke: '#0c0',\n      'stroke-width': scaleFactor / 4,\n      'stroke-linecap': 'round',\n      'stroke-opacity': 0.6\n    },\n    atomSelectionPlateRadius: labelFontSize * 1.2,\n    contractedFunctionalGroupSize: 50\n  }\n\n  return Object.assign({}, defaultOptions, opt)\n}\n\nexport default defaultOptions\n","/****************************************************************************\n * Copyright 2021 EPAM Systems\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *    http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n ***************************************************************************/\n\n// todo: rename file in another PR\nimport { ReStruct, StereLabelStyleType } from '../../render'\n\nimport { OperationType } from './OperationType'\n\ntype ValueOf<TObject extends object> = Readonly<TObject[keyof TObject]>\ntype OperationType = ValueOf<typeof OperationType>\n\nclass BaseOperation {\n  private _inverted: BaseOperation | undefined\n  type: OperationType\n  priority: number\n\n  constructor(type: OperationType, priority = 0) {\n    this.type = type\n    this.priority = priority\n  }\n\n  // @ts-ignore\n  execute(restruct: ReStruct): void {\n    throw new Error('Operation.execute() is not implemented')\n  }\n\n  perform(restruct: ReStruct): BaseOperation {\n    this.execute(restruct)\n    if (!this._inverted) {\n      this._inverted = this.invert()\n      this._inverted._inverted = this\n    }\n    return this._inverted\n  }\n\n  invert(): BaseOperation {\n    throw new Error('Operation.invert() is not implemented')\n  }\n\n  // @ts-ignore\n  isDummy(restruct: ReStruct): boolean {\n    return false\n  }\n\n  protected static invalidateAtom(restruct: ReStruct, atomId: number, level?) {\n    const atom = restruct.atoms.get(atomId)\n    if (!atom) {\n      return\n    }\n\n    restruct.markAtom(atomId, level ? 1 : 0)\n\n    const halfBonds = restruct.molecule.halfBonds\n\n    atom.a.neighbors.forEach(halfBondId => {\n      if (!halfBonds.has(halfBondId)) {\n        return\n      }\n\n      const halfBond = halfBonds.get(halfBondId)\n      if (!halfBond) {\n        return\n      }\n\n      restruct.markBond(halfBond.bid, 1)\n      restruct.markAtom(halfBond.end, 0)\n\n      if (level) {\n        BaseOperation.invalidateLoop(restruct, halfBond.bid)\n      }\n    })\n\n    const fragment = atom.a.fragment\n    const stereoLabelStyle = restruct.render.options.stereoLabelStyle\n\n    restruct.atoms.forEach((atom, atomId) => {\n      if (\n        stereoLabelStyle === StereLabelStyleType.IUPAC ||\n        stereoLabelStyle === StereLabelStyleType.Classic\n      ) {\n        if (atom.a.fragment === fragment) restruct.markAtom(atomId, 0)\n      }\n    })\n  }\n\n  protected static invalidateLoop(restruct: ReStruct, bondId: number) {\n    const bond = restruct.bonds.get(bondId)\n    if (!bond || !bond.b.hb1 || !bond.b.hb2) {\n      return\n    }\n\n    const halfBond1 = restruct.molecule.halfBonds.get(bond.b.hb1)\n    const halfBond2 = restruct.molecule.halfBonds.get(bond.b.hb2)\n\n    if (halfBond1 && halfBond1.loop >= 0) {\n      restruct.loopRemove(halfBond1.loop)\n    }\n\n    if (halfBond2 && halfBond2.loop >= 0) {\n      restruct.loopRemove(halfBond2.loop)\n    }\n  }\n\n  protected static invalidateBond(restruct: ReStruct, bondId: number) {\n    BaseOperation.invalidateLoop(restruct, bondId)\n\n    const bond = restruct.bonds.get(bondId)\n    if (!bond) {\n      return\n    }\n    BaseOperation.invalidateAtom(restruct, bond.b.begin, 0)\n    BaseOperation.invalidateAtom(restruct, bond.b.end, 0)\n  }\n\n  protected static invalidateItem(\n    restruct: ReStruct,\n    map,\n    id: number,\n    level?: any\n  ) {\n    if (map === 'atoms') {\n      BaseOperation.invalidateAtom(restruct, id, level)\n      return\n    }\n\n    if (map === 'bonds') {\n      BaseOperation.invalidateBond(restruct, id)\n\n      if (level > 0) {\n        BaseOperation.invalidateLoop(restruct, id)\n      }\n      return\n    }\n\n    restruct.markItem(map, id, level)\n  }\n\n  protected static invalidateEnhancedFlag(\n    restruct: ReStruct,\n    fragmentId: number\n  ) {\n    BaseOperation.invalidateItem(restruct, 'enhancedFlags', fragmentId, 1)\n  }\n}\n\nexport { BaseOperation }\nexport default BaseOperation\n","/****************************************************************************\n * Copyright 2021 EPAM Systems\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *    http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n ***************************************************************************/\n\nexport const OperationType = Object.freeze({\n  ATOM_ADD: 'Add atom',\n  ATOM_DELETE: 'Delete atom',\n  ATOM_ATTR: 'Set atom attribute',\n  ATOM_MOVE: 'Move atom',\n  CALC_IMPLICIT_H: 'Calculate implicit hydrogen',\n  BOND_ADD: 'Add bond',\n  BOND_DELETE: 'Delete bond',\n  BOND_ATTR: 'Set bond attribute',\n  BOND_MOVE: 'Move bond',\n  LOOP_MOVE: 'Move loop',\n  S_GROUP_ATOM_ADD: 'Add atom to s-group',\n  S_GROUP_ATOM_REMOVE: 'Remove atom from s-group',\n  S_GROUP_ATTR: 'Set s-group attribute',\n  S_GROUP_CREATE: 'Create s-group',\n  S_GROUP_DELETE: 'Delete s-group',\n  S_GROUP_ADD_TO_HIERACHY: 'Add s-group to hierarchy',\n  S_GROUP_REMOVE_FROM_HIERACHY: 'Delete s-group from hierarchy',\n  R_GROUP_ATTR: 'Set r-group attribute',\n  R_GROUP_FRAGMENT: 'R-group fragment',\n  UPDATE_IF_THEN: 'Update',\n  RESTORE_IF_THEN: 'Restore',\n  RXN_ARROW_ADD: 'Add rxn arrow',\n  RXN_ARROW_DELETE: 'Delete rxn arrow',\n  RXN_ARROW_MOVE: 'Move rxn arrow',\n  RXN_ARROW_RESIZE: 'Resize rxn arrow',\n  RXN_PLUS_ADD: 'Add rxn plus',\n  RXN_PLUS_DELETE: 'Delete rxn plus',\n  RXN_PLUS_MOVE: 'Move rxn plus',\n  S_GROUP_DATA_MOVE: 'Move s-group data',\n  CANVAS_LOAD: 'Load canvas',\n  ALIGN_DESCRIPTORS: 'Align descriptors',\n  SIMPLE_OBJECT_ADD: 'Add simple object',\n  SIMPLE_OBJECT_DELETE: 'Delete simple object',\n  SIMPLE_OBJECT_MOVE: 'Move simple object',\n  SIMPLE_OBJECT_RESIZE: 'Resize simple object',\n  RESTORE_DESCRIPTORS_POSITION: 'Restore descriptors position',\n  FRAGMENT_ADD: 'Add fragment',\n  FRAGMENT_DELETE: 'Delete fragment',\n  FRAGMENT_STEREO_FLAG: 'Add fragment stereo flag',\n  FRAGMENT_ADD_STEREO_ATOM: 'Add stereo atom to fragment',\n  FRAGMENT_DELETE_STEREO_ATOM: 'Delete stereo atom from fragment',\n  ENHANCED_FLAG_MOVE: 'Move enhanced flag',\n  TEXT_CREATE: 'Add text',\n  TEXT_UPDATE: 'Edit text',\n  TEXT_DELETE: 'Delete text',\n  TEXT_MOVE: 'Move text',\n  ADD_HIGHLIGHT: 'Highlight',\n  UPDATE_HIGHLIGHT: 'Update highlight',\n  REMOVE_HIGHLIGHT: 'Remove highlight'\n})\n","/****************************************************************************\n * Copyright 2021 EPAM Systems\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *    http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n ***************************************************************************/\n\nimport { BaseOperation } from '../base'\nimport { OperationType } from '../OperationType'\nimport { ReStruct } from '../../../render'\n\ntype Data = {\n  aid?: any\n  attribute?: any\n  value?: any\n}\n\nexport class AtomAttr extends BaseOperation {\n  data: Data\n  data2: Data | null\n\n  constructor(atomId?: any, attribute?: any, value?: any) {\n    super(OperationType.ATOM_ATTR, 1)\n    this.data = { aid: atomId, attribute, value }\n    this.data2 = null\n  }\n\n  execute(restruct: ReStruct) {\n    const { aid, attribute, value } = this.data\n\n    const atom = restruct.molecule.atoms.get(aid)!\n    if (!this.data2) {\n      this.data2 = {\n        aid,\n        attribute,\n        value: atom[attribute]\n      }\n    }\n\n    atom[attribute] = value\n    BaseOperation.invalidateAtom(restruct, aid)\n  }\n\n  invert() {\n    const inverted = new AtomAttr()\n    // @ts-ignore\n    inverted.data = this.data2\n    inverted.data2 = this.data\n    return inverted\n  }\n\n  isDummy(restruct: ReStruct) {\n    return (\n      restruct.molecule.atoms.get(this.data.aid)![this.data.attribute] ===\n      this.data.value\n    )\n  }\n}\n","/****************************************************************************\n * Copyright 2021 EPAM Systems\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *    http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n ***************************************************************************/\n\nimport { BaseOperation } from '../base'\nimport { OperationType } from '../OperationType'\nimport { ReStruct } from '../../../render'\nimport { Scale } from 'domain/helpers'\n\nexport class AtomMove extends BaseOperation {\n  data: {\n    aid: any\n    d: any\n    noinvalidate: any\n  }\n\n  constructor(atomId?: any, d?: any, noinvalidate?: any) {\n    super(OperationType.ATOM_MOVE, 2)\n    this.data = { aid: atomId, d, noinvalidate }\n  }\n\n  execute(restruct: ReStruct) {\n    const struct = restruct.molecule\n    const { aid, d } = this.data\n    const atom = struct.atoms.get(aid)\n    if (!atom) return\n    atom!.pp.add_(d) // eslint-disable-line no-underscore-dangle\n    const reatom = restruct.atoms.get(aid)\n    if (reatom) {\n      const scaled = Scale.obj2scaled(d, restruct.render.options)\n      reatom.visel.translate(scaled)\n    }\n\n    this.data.d = d.negated()\n\n    if (!this.data.noinvalidate) {\n      BaseOperation.invalidateAtom(restruct, aid, 1)\n    }\n  }\n\n  invert() {\n    const inverted = new AtomMove()\n    inverted.data = this.data\n    return inverted\n  }\n\n  isDummy() {\n    const { d } = this.data\n    return d.x === 0 && d.y === 0\n  }\n}\n","/****************************************************************************\n * Copyright 2021 EPAM Systems\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *    http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n ***************************************************************************/\n\nimport { Atom, Pile, Vec2 } from 'domain/entities'\nimport { ReAtom, ReStruct } from '../../../render'\n\nimport { BaseOperation } from '../base'\nimport { OperationType } from '../OperationType'\n\n// todo: separate classes: now here is circular dependency in `invert` method\n\ntype Data = {\n  aid: any\n  atom: any\n  pos: any\n}\n\nclass AtomAdd extends BaseOperation {\n  data: Data\n\n  constructor(atom?: any, pos?: any) {\n    super(OperationType.ATOM_ADD)\n    this.data = { atom, pos, aid: null }\n  }\n\n  execute(restruct: ReStruct) {\n    const { atom, pos } = this.data\n\n    const struct = restruct.molecule\n\n    const pp: { label?: string } = {}\n    if (atom) {\n      Object.keys(atom).forEach(p => {\n        pp[p] = atom[p]\n      })\n    }\n\n    pp.label = pp.label || 'C'\n    if (typeof this.data.aid !== 'number') {\n      // @ts-ignore\n      this.data.aid = struct.atoms.add(new Atom(pp))\n    } else {\n      // @ts-ignore\n      struct.atoms.set(this.data.aid, new Atom(pp))\n    }\n\n    const { aid } = this.data\n\n    // notifyAtomAdded\n    const atomData = new ReAtom(struct.atoms.get(aid)!)\n\n    atomData.component = restruct.connectedComponents.add(new Pile([aid]))\n    restruct.atoms.set(aid, atomData)\n    restruct.markAtom(aid, 1)\n\n    struct.atomSetPos(aid, new Vec2(pos))\n\n    const arrow = struct.rxnArrows.get(0)\n    if (arrow) {\n      const atom = struct.atoms.get(aid)!\n      atom.rxnFragmentType = struct.defineRxnFragmentTypeForAtomset(\n        new Pile([aid]),\n        arrow.pos[0].x\n      )\n    }\n  }\n\n  invert() {\n    const inverted = new AtomDelete()\n    inverted.data = this.data\n    return inverted\n  }\n}\n\nclass AtomDelete extends BaseOperation {\n  data: Data\n\n  constructor(atomId?: any) {\n    super(OperationType.ATOM_DELETE, 5)\n    this.data = { aid: atomId, atom: null, pos: null }\n  }\n\n  execute(restruct: ReStruct) {\n    const { aid } = this.data\n\n    const struct = restruct.molecule\n    if (!this.data.atom) {\n      this.data.atom = struct.atoms.get(aid)\n      this.data.pos = this.data.atom.pp\n    }\n\n    // notifyAtomRemoved(aid);\n    const restructedAtom = restruct.atoms.get(aid)\n    if (!restructedAtom) {\n      return\n    }\n\n    const set = restruct.connectedComponents.get(restructedAtom.component)\n    set.delete(aid)\n    if (set.size === 0) {\n      restruct.connectedComponents.delete(restructedAtom.component)\n    }\n\n    restruct.clearVisel(restructedAtom.visel)\n    restruct.atoms.delete(aid)\n    restruct.markItemRemoved()\n    struct.atoms.delete(aid)\n  }\n\n  invert() {\n    const inverted = new AtomAdd()\n    inverted.data = this.data\n    return inverted\n  }\n}\n\nexport { AtomAdd, AtomDelete }\nexport * from './AtomAttr'\nexport * from './AtomMove'\n","/****************************************************************************\n * Copyright 2021 EPAM Systems\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *    http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n ***************************************************************************/\n\nimport { BaseOperation } from '../base'\nimport { OperationType } from '../OperationType'\nimport { ReStruct } from '../../../render'\n\ntype Data = {\n  bid: any\n  attribute: any\n  value: any\n}\n\nexport class BondAttr extends BaseOperation {\n  data: Data\n  data2: Data | null\n\n  constructor(bondId?: any, attribute?: any, value?: any) {\n    super(OperationType.BOND_ATTR, 2)\n    this.data = { bid: bondId, attribute, value }\n    this.data2 = null\n  }\n\n  execute(restruct: ReStruct) {\n    const { attribute, bid, value } = this.data\n    const bond = restruct.molecule.bonds.get(bid)!\n\n    if (!this.data2) {\n      this.data2 = {\n        bid: bid,\n        attribute: attribute,\n        value: bond[attribute]\n      }\n    }\n\n    bond[attribute] = value\n\n    BaseOperation.invalidateBond(restruct, bid)\n    if (attribute === 'type') {\n      BaseOperation.invalidateLoop(restruct, bid)\n    }\n  }\n\n  isDummy(restruct: ReStruct) {\n    const { attribute, bid, value } = this.data\n    const bond = restruct.molecule.bonds.get(bid)!\n    return bond[attribute] === value\n  }\n\n  invert() {\n    const inverted = new BondAttr()\n    // @ts-ignore\n    inverted.data = this.data2\n    inverted.data2 = this.data\n    return inverted\n  }\n}\n","/****************************************************************************\n * Copyright 2021 EPAM Systems\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *    http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n ***************************************************************************/\n\nimport { BaseOperation } from '../base'\nimport { OperationType } from '../OperationType'\nimport { ReStruct } from '../../../render'\nimport { Scale } from 'domain/helpers'\n\nexport class BondMove extends BaseOperation {\n  data: {\n    bid: any\n    d: any\n  }\n\n  constructor(bondId?: any, d?: any) {\n    super(OperationType.BOND_MOVE, 2)\n    this.data = { bid: bondId, d }\n  }\n\n  execute(restruct: ReStruct) {\n    const { bid, d } = this.data\n    const bond = restruct.bonds.get(bid)\n    if (!bond) return\n\n    const scaled = Scale.obj2scaled(d, restruct.render.options)\n    bond.visel.translate(scaled)\n    this.data.d = d.negated()\n  }\n\n  invert() {\n    const inverted = new BondMove()\n    inverted.data = this.data\n    return inverted\n  }\n}\n","/****************************************************************************\n * Copyright 2021 EPAM Systems\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *    http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n ***************************************************************************/\n\nimport { ReBond, ReStruct } from '../../../render'\n\nimport { BaseOperation } from '../base'\nimport { Bond } from 'domain/entities'\nimport { OperationType } from '../OperationType'\n\n// todo: separate classes: now here is circular dependency in `invert` method\n\ntype Data = {\n  bond: any\n  begin: any\n  end: any\n  bid: any\n}\n\nclass BondAdd extends BaseOperation {\n  data: Data\n\n  constructor(begin?: any, end?: any, bond?: any) {\n    super(OperationType.BOND_ADD, 1)\n    this.data = { bond, begin, end, bid: null }\n  }\n\n  execute(restruct: ReStruct) {\n    const { begin, bond, end } = this.data\n    // eslint-disable-line max-statements\n    const struct = restruct.molecule\n\n    if (begin === end) {\n      throw new Error('Distinct atoms expected')\n    }\n\n    BaseOperation.invalidateAtom(restruct, begin, 1)\n    BaseOperation.invalidateAtom(restruct, end, 1)\n\n    const pp: {\n      type?: any\n      begin?: any\n      end?: any\n    } = {}\n\n    if (bond) {\n      Object.keys(bond).forEach(p => {\n        pp[p] = bond[p]\n      })\n    }\n\n    pp.type = pp.type || Bond.PATTERN.TYPE.SINGLE\n    pp.begin = begin\n    pp.end = end\n\n    // @ts-ignore\n    const newBond = new Bond(pp)\n    if (typeof this.data.bid === 'number') {\n      struct.bonds.set(this.data.bid, newBond)\n    } else {\n      this.data.bid = struct.bonds.add(newBond)\n    }\n\n    const { bid } = this.data\n    const structBond = struct.bonds.get(bid)!\n\n    struct.bondInitHalfBonds(bid)\n    struct.atomAddNeighbor(structBond.hb1)\n    struct.atomAddNeighbor(structBond.hb2)\n\n    // notifyBondAdded\n    restruct.bonds.set(bid, new ReBond(structBond))\n    restruct.markBond(bid, 1)\n  }\n\n  invert() {\n    const inverted = new BondDelete()\n    inverted.data = this.data\n    return inverted\n  }\n}\n\nclass BondDelete extends BaseOperation {\n  data: Data\n\n  constructor(bondId?: any) {\n    super(OperationType.BOND_DELETE, 3)\n    this.data = { bid: bondId, bond: null, begin: null, end: null }\n  }\n\n  execute(restruct: ReStruct) {\n    const { bid } = this.data\n\n    // eslint-disable-line max-statements\n    const struct = restruct.molecule\n    if (!this.data.bond) {\n      this.data.bond = struct.bonds.get(bid)\n      this.data.begin = this.data.bond.begin\n      this.data.end = this.data.bond.end\n    }\n\n    BaseOperation.invalidateBond(restruct, bid)\n\n    // notifyBondRemoved\n    const rebond = restruct.bonds.get(bid)\n    if (!rebond) return\n    ;[rebond.b.hb1, rebond.b.hb2].forEach(hbid => {\n      if (hbid === undefined) return\n      const halfBond = restruct.molecule.halfBonds.get(hbid)\n      if (halfBond && halfBond.loop >= 0) {\n        restruct.loopRemove(halfBond.loop)\n      }\n    }, restruct)\n    restruct.clearVisel(rebond.visel)\n    restruct.bonds.delete(bid)\n    restruct.markItemRemoved()\n\n    const structBond = struct.bonds.get(bid)!\n    ;[structBond.hb1, structBond.hb2].forEach(hbid => {\n      const halfBond = struct.halfBonds.get(hbid!)\n      if (!halfBond) {\n        return\n      }\n\n      const atom = struct.atoms.get(halfBond.begin)!\n      const pos = atom.neighbors.indexOf(hbid!)\n      const prev = (pos + atom.neighbors.length - 1) % atom.neighbors.length\n      const next = (pos + 1) % atom.neighbors.length\n      struct.setHbNext(atom.neighbors[prev], atom.neighbors[next])\n      atom.neighbors.splice(pos, 1)\n    })\n    struct.halfBonds.delete(structBond.hb1!)\n    struct.halfBonds.delete(structBond.hb2!)\n\n    struct.bonds.delete(bid)\n  }\n\n  invert() {\n    const inverted = new BondAdd()\n    inverted.data = this.data\n    return inverted\n  }\n}\n\nexport { BondAdd, BondDelete }\nexport * from './BondAttr'\nexport * from './BondMove'\n","/****************************************************************************\n * Copyright 2021 EPAM Systems\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *    http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n ***************************************************************************/\n\nimport { BaseOperation } from './base'\nimport { OperationType } from './OperationType'\nimport { ReStruct } from '../../render'\nimport { Struct } from 'domain/entities'\n\nexport class CanvasLoad extends BaseOperation {\n  data: {\n    struct?: Struct\n  }\n\n  constructor(struct?: Struct) {\n    super(OperationType.CANVAS_LOAD)\n    this.data = { struct }\n  }\n\n  execute(restruct: ReStruct) {\n    const oldStruct = restruct.molecule\n    restruct.clearVisels() // TODO: What is it?\n    restruct.render.setMolecule(this.data.struct)\n    this.data.struct = oldStruct\n  }\n\n  invert() {\n    const inverted = new CanvasLoad()\n    inverted.data = this.data\n    return inverted\n  }\n}\n","/****************************************************************************\n * Copyright 2021 EPAM Systems\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *    http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n ***************************************************************************/\n\nimport { BaseOperation } from './base'\nimport { OperationType } from './OperationType'\nimport { ReStruct } from '../../render'\nimport { Vec2 } from 'domain/entities'\n\n// todo: separate classes: now here is circular dependency in `invert` method\n\nclass AlignDescriptors extends BaseOperation {\n  history: any\n\n  constructor() {\n    super(OperationType.ALIGN_DESCRIPTORS)\n    this.history = {}\n  }\n\n  execute(restruct: ReStruct) {\n    const struct = restruct.molecule\n    const sgroups: any[] = Array.from(struct.sgroups.values()).reverse()\n\n    const structBox: any = struct.getCoordBoundingBoxObj()\n    let alignPoint = new Vec2(structBox.max.x, structBox.min.y).add(\n      new Vec2(2.0, -1.0)\n    )\n\n    sgroups.forEach(sgroup => {\n      this.history[sgroup.id] = new Vec2(sgroup.pp)\n      alignPoint = alignPoint.add(new Vec2(0.0, 0.5))\n      sgroup.pp = alignPoint\n      struct.sgroups.set(sgroup.id, sgroup)\n      BaseOperation.invalidateItem(restruct, 'sgroupData', sgroup.id, 1)\n    })\n  }\n\n  invert() {\n    return new RestoreDescriptorsPosition(this.history)\n  }\n}\n\nclass RestoreDescriptorsPosition extends BaseOperation {\n  history: any\n\n  constructor(history: any) {\n    super(OperationType.RESTORE_DESCRIPTORS_POSITION)\n    this.history = history\n  }\n\n  execute(restruct: ReStruct) {\n    const struct = restruct.molecule\n    const sgroups: any[] = Array.from(struct.sgroups.values())\n\n    sgroups.forEach(sgroup => {\n      sgroup.pp = this.history[sgroup.id]\n      struct.sgroups.set(sgroup.id, sgroup)\n      BaseOperation.invalidateItem(restruct, 'sgroupData', sgroup.id, 1)\n    })\n  }\n\n  invert() {\n    return new AlignDescriptors()\n  }\n}\n\nexport { AlignDescriptors, RestoreDescriptorsPosition }\n","/****************************************************************************\n * Copyright 2021 EPAM Systems\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *    http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n ***************************************************************************/\n\nimport { Fragment, Vec2 } from 'domain/entities'\n\nimport { BaseOperation } from './base'\nimport { OperationType } from './OperationType'\nimport { ReStruct } from '../../render'\n\nexport class EnhancedFlagMove extends BaseOperation {\n  data: {\n    frid: any\n    p: any\n  }\n\n  constructor(fragmentId?: any, p?: any) {\n    super(OperationType.ENHANCED_FLAG_MOVE)\n    this.data = { frid: fragmentId, p }\n  }\n\n  execute(restruct: ReStruct) {\n    const { frid } = this.data\n    const { p } = this.data\n    const fragment = restruct.molecule.frags.get(frid)\n    if (!fragment) return\n\n    const currentPosition = fragment.stereoFlagPosition\n      ? new Vec2(fragment.stereoFlagPosition.x, fragment.stereoFlagPosition.y)\n      : Fragment.getDefaultStereoFlagPosition(restruct.molecule, frid)!\n\n    const newPosition = Vec2.sum(currentPosition, p)\n    fragment.stereoFlagPosition = newPosition\n\n    this.data.p = p.negated()\n    BaseOperation.invalidateItem(restruct, 'enhancedFlags', frid, 1)\n  }\n\n  invert() {\n    const inverted = new EnhancedFlagMove()\n    inverted.data = this.data\n    return inverted\n  }\n}\n","/****************************************************************************\n * Copyright 2021 EPAM Systems\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *    http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n ***************************************************************************/\n\nimport { BaseOperation } from './base'\nimport { OperationType } from './OperationType'\nimport { ReStruct } from '../../render'\n\n// todo: separate classes: now here is circular dependency in `invert` method\n\nclass UpdateIfThen extends BaseOperation {\n  rgid_new: any\n  rgid_old: any\n  ifThenHistory: any\n  skipRgids: any[]\n\n  constructor(rgNew: any, rgOld: any, skipRgids: any = []) {\n    super(OperationType.UPDATE_IF_THEN)\n    this.rgid_new = rgNew\n    this.rgid_old = rgOld\n    this.ifThenHistory = new Map()\n    this.skipRgids = skipRgids || []\n  }\n\n  execute(restruct: ReStruct) {\n    const struct = restruct.molecule\n\n    struct.rgroups.forEach((rg, rgid) => {\n      if (rg.ifthen === this.rgid_old && !this.skipRgids.includes(rgid)) {\n        rg.ifthen = this.rgid_new\n        this.ifThenHistory.set(rgid, this.rgid_old)\n        struct.rgroups.set(rgid, rg)\n      }\n    })\n  }\n\n  invert() {\n    return new RestoreIfThen(this.rgid_new, this.rgid_old, this.ifThenHistory)\n  }\n}\n\nclass RestoreIfThen extends BaseOperation {\n  rgid_new: any\n  rgid_old: any\n  ifThenHistory: any\n\n  constructor(rgNew: any, rgOld: any, history: any) {\n    super(OperationType.RESTORE_IF_THEN)\n    this.rgid_new = rgNew\n    this.rgid_old = rgOld\n    this.ifThenHistory = history || new Map()\n  }\n\n  execute(restruct: ReStruct) {\n    const struct = restruct.molecule\n\n    this.ifThenHistory.forEach((rg, rgid) => {\n      const rgValue = struct.rgroups.get(rgid)!\n      rgValue.ifthen = rg\n      struct.rgroups.set(rgid, rgValue)\n    })\n  }\n\n  invert() {\n    return new UpdateIfThen(this.rgid_old, this.rgid_new)\n  }\n}\n\nexport { UpdateIfThen, RestoreIfThen }\n","/****************************************************************************\n * Copyright 2021 EPAM Systems\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *    http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n ***************************************************************************/\n\nimport { ReEnhancedFlag, ReFrag, ReStruct } from '../../render'\n\nimport { BaseOperation } from './base'\nimport { Fragment } from 'domain/entities'\nimport { OperationType } from './OperationType'\n\n// todo: separate classes: now here is circular dependency in `invert` method\n\nclass FragmentAdd extends BaseOperation {\n  frid: any\n\n  constructor(fragmentId?: any) {\n    super(OperationType.FRAGMENT_ADD)\n    this.frid = typeof fragmentId === 'undefined' ? null : fragmentId\n  }\n\n  execute(restruct: ReStruct) {\n    const struct = restruct.molecule\n    const frag = new Fragment()\n\n    if (this.frid === null) {\n      this.frid = struct.frags.add(frag)\n    } else {\n      struct.frags.set(this.frid, frag)\n    }\n\n    restruct.frags.set(this.frid, new ReFrag(frag)) // TODO add restruct.notifyFragmentAdded\n    restruct.enhancedFlags.set(this.frid, new ReEnhancedFlag())\n  }\n\n  invert() {\n    return new FragmentDelete(this.frid)\n  }\n}\n\nclass FragmentDelete extends BaseOperation {\n  frid: any\n\n  constructor(fragmentId: any) {\n    super(OperationType.FRAGMENT_DELETE, 100)\n    this.frid = fragmentId\n  }\n\n  execute(restruct: ReStruct) {\n    const struct = restruct.molecule\n    if (!struct.frags.get(this.frid)) {\n      return\n    }\n\n    BaseOperation.invalidateItem(restruct, 'frags', this.frid, 1)\n    restruct.frags.delete(this.frid)\n    struct.frags.delete(this.frid) // TODO add restruct.notifyFragmentRemoved\n\n    const enhancedFalg = restruct.enhancedFlags.get(this.frid)\n    if (!enhancedFalg) return\n    restruct.clearVisel(enhancedFalg.visel)\n    restruct.enhancedFlags.delete(this.frid)\n  }\n\n  invert() {\n    return new FragmentAdd(this.frid)\n  }\n}\n\nexport { FragmentAdd, FragmentDelete }\n","/****************************************************************************\n * Copyright 2021 EPAM Systems\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *    http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n ***************************************************************************/\n\nimport { BaseOperation } from './base'\nimport { OperationType } from './OperationType'\nimport { ReStruct } from '../../render'\n\n// todo: separate classes: now here is circular dependency in `invert` method\n\ntype Data = {\n  frid: any\n  aid: any\n}\n\n// todo : merge add and delete stereo atom\nclass FragmentAddStereoAtom extends BaseOperation {\n  data: Data\n\n  constructor(fragmentId: any, atomId: any) {\n    super(OperationType.FRAGMENT_ADD_STEREO_ATOM, 100)\n    this.data = { frid: fragmentId, aid: atomId }\n  }\n\n  execute(restruct: ReStruct) {\n    const { aid, frid } = this.data\n\n    const frag = restruct.molecule.frags.get(frid)\n    if (frag) {\n      frag.updateStereoAtom(restruct.molecule, aid, frid, true)\n\n      BaseOperation.invalidateEnhancedFlag(restruct, frid)\n    }\n  }\n\n  invert() {\n    return new FragmentDeleteStereoAtom(this.data.frid, this.data.aid)\n  }\n}\n\nclass FragmentDeleteStereoAtom extends BaseOperation {\n  data: Data\n\n  constructor(fragmentId: any, atomId: any) {\n    super(OperationType.FRAGMENT_DELETE_STEREO_ATOM, 90)\n    this.data = { frid: fragmentId, aid: atomId }\n  }\n\n  execute(restruct: ReStruct) {\n    const { aid, frid } = this.data\n\n    const frag = restruct.molecule.frags.get(frid)\n    if (frag) {\n      frag.updateStereoAtom(restruct.molecule, aid, frid, false)\n\n      BaseOperation.invalidateEnhancedFlag(restruct, frid)\n    }\n  }\n\n  invert() {\n    const { aid, frid } = this.data\n    return new FragmentAddStereoAtom(frid, aid)\n  }\n}\n\nexport { FragmentAddStereoAtom, FragmentDeleteStereoAtom }\n","/****************************************************************************\n * Copyright 2021 EPAM Systems\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *    http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n ***************************************************************************/\n\nimport { BaseOperation } from './base'\nimport { OperationType } from './OperationType'\nimport { ReStruct } from '../../render'\n\nexport class FragmentStereoFlag extends BaseOperation {\n  frid: number\n\n  constructor(fragmentId: number) {\n    super(OperationType.FRAGMENT_STEREO_FLAG, 6)\n    this.frid = fragmentId\n  }\n\n  execute(restruct: ReStruct) {\n    const struct = restruct.molecule\n\n    const fragment = struct.frags.get(this.frid)!\n    fragment.updateStereoFlag(struct)\n\n    BaseOperation.invalidateEnhancedFlag(restruct, this.frid)\n  }\n\n  invert() {\n    const inverted = new FragmentStereoFlag(this.frid)\n    return inverted\n  }\n}\n","/****************************************************************************\n * Copyright 2021 EPAM Systems\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *    http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n ***************************************************************************/\n\nimport { BaseOperation } from './base'\nimport { OperationType } from './OperationType'\nimport { ReStruct } from '../../render'\n\nexport class CalcImplicitH extends BaseOperation {\n  atomIds: Array<number>\n\n  constructor(aids: Array<number>) {\n    super(OperationType.CALC_IMPLICIT_H, 10)\n    this.atomIds = aids\n  }\n\n  execute(restruct: ReStruct) {\n    const aIds = this.atomIds\n\n    restruct.molecule.setImplicitHydrogen(aIds)\n  }\n\n  invert() {\n    return new CalcImplicitH(this.atomIds)\n  }\n}\n","/****************************************************************************\n * Copyright 2021 EPAM Systems\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *    http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n ***************************************************************************/\n\nimport { BaseOperation } from './base'\nimport { OperationType } from './OperationType'\nimport { ReStruct } from '../../render'\nimport { Scale } from 'domain/helpers'\n\nexport class LoopMove extends BaseOperation {\n  data: {\n    id: any\n    d: any\n  }\n\n  constructor(id?: any, d?: any) {\n    super(OperationType.LOOP_MOVE)\n    this.data = { id, d }\n  }\n\n  execute(restruct: ReStruct) {\n    // not sure if there should be an action to move a loop in the first place\n    // but we have to somehow move the aromatic ring,\n    // which is associated with the loop, rather than with any of the bonds\n    const { id, d } = this.data\n    const reloop = restruct.reloops.get(id)\n\n    if (reloop && reloop.visel) {\n      const scaled = Scale.obj2scaled(d, restruct.render.options)\n      reloop.visel.translate(scaled)\n    }\n    this.data.d = d.negated()\n  }\n\n  invert() {\n    const inverted = new LoopMove()\n    inverted.data = this.data\n    return inverted\n  }\n}\n","/****************************************************************************\n * Copyright 2021 EPAM Systems\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *    http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n ***************************************************************************/\n\nimport { BaseOperation } from '../base'\nimport { OperationType } from '../OperationType'\nimport { ReStruct } from '../../../render'\n\ntype Data = {\n  rgid: any\n  attribute: any\n  value: any\n}\n\nexport class RGroupAttr extends BaseOperation {\n  data: Data\n  data2: Data | null\n\n  constructor(rgroupId?: any, attribute?: any, value?: any) {\n    super(OperationType.R_GROUP_ATTR)\n    this.data = { rgid: rgroupId, attribute, value }\n    this.data2 = null\n  }\n\n  execute(restruct: ReStruct) {\n    const { rgid, attribute, value } = this.data\n\n    const rgp = restruct.molecule.rgroups.get(rgid)!\n\n    if (!rgp) {\n      return\n    }\n\n    if (!this.data2) {\n      this.data2 = {\n        rgid,\n        attribute,\n        value: rgp[attribute]\n      }\n    }\n\n    rgp[attribute] = value\n\n    BaseOperation.invalidateItem(restruct, 'rgroups', rgid)\n  }\n\n  invert() {\n    const inverted = new RGroupAttr()\n    // @ts-ignore\n    inverted.data = this.data2\n    inverted.data2 = this.data\n    return inverted\n  }\n\n  isDummy(restruct: ReStruct) {\n    const { rgid, attribute, value } = this.data\n    const rgroup = restruct.molecule.rgroups.get(rgid)!\n    return rgroup[attribute] === value\n  }\n}\n","/****************************************************************************\n * Copyright 2021 EPAM Systems\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *    http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n ***************************************************************************/\n\nimport { ReRGroup, ReStruct } from '../../../render'\n\nimport { BaseOperation } from '../base'\nimport { OperationType } from '../OperationType'\nimport { RGroup } from 'domain/entities'\n\nexport class RGroupFragment extends BaseOperation {\n  rgid_new: any\n  rg_new: any\n  rgid_old: any\n  rg_old: any\n  frid: any\n\n  constructor(rgroupId: any, fragmentId: any, rg?: any) {\n    super(OperationType.R_GROUP_FRAGMENT)\n    this.rgid_new = rgroupId\n    this.rg_new = rg\n    this.rgid_old = null\n    this.rg_old = null\n    this.frid = fragmentId\n  }\n\n  execute(restruct: ReStruct) {\n    // eslint-disable-line max-statements\n    const struct = restruct.molecule\n    this.rgid_old =\n      this.rgid_old || RGroup.findRGroupByFragment(struct.rgroups, this.frid)\n\n    this.rg_old = this.rgid_old ? struct.rgroups.get(this.rgid_old) : null\n\n    this.removeOld(struct, restruct)\n    this.setNew(struct, restruct)\n  }\n\n  private removeOld(struct: any, restruct: any) {\n    if (!this.rg_old) {\n      return\n    }\n\n    this.rg_old.frags.delete(this.frid)\n    restruct.clearVisel(restruct.rgroups.get(this.rgid_old).visel)\n\n    if (this.rg_old.frags.size === 0) {\n      restruct.rgroups.delete(this.rgid_old)\n      struct.rgroups.delete(this.rgid_old)\n      restruct.markItemRemoved()\n    } else {\n      restruct.markItem('rgroups', this.rgid_old, 1)\n    }\n  }\n\n  private setNew(struct: any, restruct: ReStruct) {\n    if (!this.rgid_new) {\n      return\n    }\n\n    let rgNew = struct.rgroups.get(this.rgid_new)\n    if (!rgNew) {\n      rgNew = this.rg_new || new RGroup()\n      struct.rgroups.set(this.rgid_new, rgNew)\n      restruct.rgroups.set(this.rgid_new, new ReRGroup(rgNew))\n    } else {\n      restruct.markItem('rgroups', this.rgid_new, 1)\n    }\n\n    rgNew.frags.add(this.frid)\n  }\n\n  invert() {\n    return new RGroupFragment(this.rgid_old, this.frid, this.rg_old)\n  }\n}\n","/****************************************************************************\n * Copyright 2021 EPAM Systems\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *    http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n ***************************************************************************/\n\nimport Base from '../base'\nimport { OperationType } from '../OperationType'\nimport { Scale } from 'domain/helpers'\n\ninterface RxnArrowMoveData {\n  id: number\n  d: any\n  noinvalidate: boolean\n}\n\nexport class RxnArrowMove extends Base {\n  data: RxnArrowMoveData\n\n  constructor(id?: any, d?: any, noinvalidate?: any) {\n    super(OperationType.RXN_ARROW_MOVE)\n    this.data = { id, d, noinvalidate }\n  }\n\n  execute(restruct: any): void {\n    const struct = restruct.molecule\n    const id = this.data.id\n    const d = this.data.d\n    const item = struct.rxnArrows.get(id)\n    item.pos.forEach(p => p.add_(d))\n    restruct.rxnArrows\n      .get(id)\n      .visel.translate(Scale.obj2scaled(d, restruct.render.options))\n    this.data.d = d.negated()\n    if (!this.data.noinvalidate) {\n      Base.invalidateItem(restruct, 'rxnArrows', id, 1)\n    }\n  }\n\n  invert() {\n    const move = new RxnArrowMove(\n      this.data.id,\n      this.data.d,\n      this.data.noinvalidate\n    )\n    move.data = this.data\n    return move\n  }\n}\n","/****************************************************************************\n * Copyright 2021 EPAM Systems\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *    http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n ***************************************************************************/\n\nimport Base from '../base'\nimport { OperationType } from '../OperationType'\nimport { Scale } from 'domain/helpers'\nimport { Vec2 } from 'domain/entities'\nimport { tfx } from 'utilities'\n\ninterface RxnArrowResizeData {\n  id: number\n  d: any\n  current: Vec2\n  anchor: Vec2\n  noinvalidate: boolean\n}\n\nexport class RxnArrowResize extends Base {\n  data: RxnArrowResizeData\n\n  constructor(\n    id: number,\n    d: any,\n    current: Vec2,\n    anchor: any,\n    noinvalidate: boolean\n  ) {\n    super(OperationType.RXN_ARROW_RESIZE)\n    this.data = { id, d, current, anchor, noinvalidate }\n  }\n\n  execute(restruct: any): void {\n    const struct = restruct.molecule\n    const id = this.data.id\n    const d = this.data.d\n    const current = this.data.current\n    const item = struct.rxnArrows.get(id)\n    const anchor = this.data.anchor\n\n    if (anchor) {\n      const previousPos0 = item.pos[0].get_xy0()\n      const previousPos1 = item.pos[1].get_xy0()\n\n      if (\n        tfx(anchor.x) === tfx(item.pos[1].x) &&\n        tfx(anchor.y) === tfx(item.pos[1].y)\n      ) {\n        item.pos[1].x = anchor.x = current.x\n        current.x = previousPos1.x\n        item.pos[1].y = anchor.y = current.y\n        current.y = previousPos1.y\n      }\n\n      if (\n        tfx(anchor.x) === tfx(item.pos[0].x) &&\n        tfx(anchor.y) === tfx(item.pos[0].y)\n      ) {\n        item.pos[0].x = anchor.x = current.x\n        current.x = previousPos0.x\n        item.pos[0].y = anchor.y = current.y\n        current.y = previousPos0.y\n      }\n    } else item.pos[1].add_(d)\n\n    restruct.rxnArrows\n      .get(id)\n      .visel.translate(Scale.obj2scaled(d, restruct.render.options))\n    this.data.d = d.negated()\n\n    if (!this.data.noinvalidate) {\n      Base.invalidateItem(\n        restruct,\n        'rxnArrows',\n        // @ts-ignore\n        id,\n        1\n      )\n    }\n  }\n\n  invert(): Base {\n    return new RxnArrowResize(\n      this.data.id,\n      this.data.d,\n      this.data.current,\n      this.data.anchor,\n      this.data.noinvalidate\n    )\n  }\n}\n","/****************************************************************************\n * Copyright 2021 EPAM Systems\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *    http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n ***************************************************************************/\n\nimport { BaseOperation } from '../../base'\nimport { OperationType } from '../../OperationType'\nimport { ReStruct } from '../../../../render'\nimport { Scale } from 'domain/helpers'\n\nexport class RxnPlusMove extends BaseOperation {\n  data: {\n    id: any\n    d: any\n    noinvalidate: any\n  }\n\n  constructor(id?: any, d?: any, noinvalidate?: any) {\n    super(OperationType.RXN_PLUS_MOVE)\n    this.data = { id, d, noinvalidate }\n  }\n\n  execute(restruct: ReStruct) {\n    const { id, d, noinvalidate } = this.data\n\n    const struct = restruct.molecule\n    struct.rxnPluses.get(id)!.pp.add_(d) // eslint-disable-line no-underscore-dangle\n\n    const rxn = restruct.rxnPluses.get(id)!\n    const scaled = Scale.obj2scaled(d, restruct.render.options)\n    rxn.visel.translate(scaled)\n\n    this.data.d = d.negated()\n\n    if (!noinvalidate) {\n      BaseOperation.invalidateItem(restruct, 'rxnPluses', id, 1)\n    }\n  }\n\n  invert() {\n    const inverted = new RxnPlusMove()\n    inverted.data = this.data\n    return inverted\n  }\n}\n","/****************************************************************************\n * Copyright 2021 EPAM Systems\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *    http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n ***************************************************************************/\n\nimport { ReRxnPlus, ReStruct } from '../../../../render'\nimport { RxnPlus, Vec2 } from 'domain/entities'\n\nimport { BaseOperation } from '../../base'\nimport { OperationType } from '../../OperationType'\n\n// todo: separate classes: now here is circular dependency in `invert` method\n\ntype Data = {\n  plid: any\n  pos: any\n}\n\nclass RxnPlusAdd extends BaseOperation {\n  data: Data\n\n  constructor(pos?: any) {\n    super(OperationType.RXN_PLUS_ADD)\n    this.data = { plid: null, pos }\n  }\n\n  execute(restruct: ReStruct) {\n    const struct = restruct.molecule\n\n    const newRxn = new RxnPlus()\n    if (typeof this.data.plid === 'number') {\n      struct.rxnPluses.set(this.data.plid, newRxn)\n    } else {\n      this.data.plid = struct.rxnPluses.add(newRxn)\n    }\n\n    const { pos, plid } = this.data\n\n    const structRxn = struct.rxnPluses.get(plid)\n    // notifyRxnPlusAdded\n    restruct.rxnPluses.set(plid, new ReRxnPlus(structRxn))\n\n    struct.rxnPlusSetPos(plid, new Vec2(pos))\n\n    BaseOperation.invalidateItem(restruct, 'rxnPluses', plid, 1)\n  }\n\n  invert() {\n    const inverted = new RxnPlusDelete()\n    inverted.data = this.data\n    return inverted\n  }\n}\n\nclass RxnPlusDelete extends BaseOperation {\n  data: Data\n\n  constructor(plid?: any) {\n    super(OperationType.RXN_PLUS_DELETE)\n    this.data = { plid, pos: null }\n  }\n\n  execute(restruct: ReStruct) {\n    const { plid } = this.data\n\n    const struct = restruct.molecule\n    if (!this.data.pos) {\n      this.data.pos = struct.rxnPluses.get(plid)!.pp\n    }\n\n    // notifyRxnPlusRemoved\n    restruct.markItemRemoved()\n    const rxn = restruct.rxnPluses.get(plid)\n    if (!rxn) return\n    restruct.clearVisel(rxn.visel)\n    restruct.rxnPluses.delete(plid)\n\n    struct.rxnPluses.delete(plid)\n  }\n\n  invert() {\n    const inverted = new RxnPlusAdd()\n    inverted.data = this.data\n    return inverted\n  }\n}\n\nexport { RxnPlusAdd, RxnPlusDelete }\nexport * from './RxnPlusMove'\n","/****************************************************************************\n * Copyright 2021 EPAM Systems\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *    http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n ***************************************************************************/\n\nimport { RxnArrow, RxnArrowMode, Vec2 } from 'domain/entities'\n\nimport Base from '../base'\nimport { OperationType } from '../OperationType'\nimport { ReRxnArrow } from '../../../render'\n\n// todo: separate classes: now here is circular dependency in `invert` method\n\ntype RxnArrowAddData = {\n  id?: number\n  pos: Array<Vec2>\n  mode: RxnArrowMode\n}\n\nclass RxnArrowAdd extends Base {\n  data: RxnArrowAddData\n\n  constructor(\n    pos: Array<Vec2> = [],\n    mode: RxnArrowMode = RxnArrowMode.OpenAngle,\n    id?: number\n  ) {\n    super(OperationType.RXN_ARROW_ADD)\n    this.data = { pos, mode, id }\n  }\n\n  execute(restruct: any): void {\n    const struct = restruct.molecule\n    const item = new RxnArrow({ mode: this.data.mode })\n\n    if (this.data.id == null) {\n      const index = struct.rxnArrows.add(item)\n      this.data.id = index\n    } else {\n      struct.rxnArrows.set(this.data.id!, item)\n    }\n\n    const itemId = this.data.id!\n\n    restruct.rxnArrows.set(itemId, new ReRxnArrow(item))\n\n    const positions = [...this.data.pos]\n\n    struct.rxnArrowSetPos(\n      itemId,\n      positions.map(p => new Vec2(p))\n    )\n\n    Base.invalidateItem(restruct, 'rxnArrows', itemId, 1)\n  }\n  invert(): Base {\n    return new RxnArrowDelete(this.data.id!)\n  }\n}\n\ninterface RxnArrowDeleteData {\n  id: number\n  pos?: Array<Vec2>\n  mode?: RxnArrowMode\n}\n\nclass RxnArrowDelete extends Base {\n  data: RxnArrowDeleteData\n  performed: boolean\n\n  constructor(id: number) {\n    super(OperationType.RXN_ARROW_DELETE)\n    this.data = { id, pos: [], mode: RxnArrowMode.OpenAngle }\n    this.performed = false\n  }\n\n  execute(restruct: any): void {\n    const struct = restruct.molecule\n    const item = struct.rxnArrows.get(this.data.id) as any\n    this.data.pos = item.pos\n    this.data.mode = item.mode\n    this.performed = true\n\n    restruct.markItemRemoved()\n    restruct.clearVisel(restruct.rxnArrows.get(this.data.id).visel)\n    restruct.rxnArrows.delete(this.data.id)\n\n    struct.rxnArrows.delete(this.data.id)\n  }\n\n  invert(): Base {\n    return new RxnArrowAdd(this.data.pos, this.data.mode, this.data.id)\n  }\n}\n\nexport { RxnArrowAdd, RxnArrowDelete }\nexport * from './RxnArrowMove'\nexport * from './RxnArrowResize'\nexport * from './plus'\n","/****************************************************************************\n * Copyright 2021 EPAM Systems\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *    http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n ***************************************************************************/\n\nimport { SimpleObject, SimpleObjectMode, Vec2 } from 'domain/entities'\n\nimport Base from './base'\nimport { OperationType } from './OperationType'\nimport { ReSimpleObject } from '../../render'\nimport { Scale } from 'domain/helpers'\nimport { tfx } from 'utilities'\n\ninterface SimpleObjectAddData {\n  id?: number\n  pos: Array<Vec2>\n  mode: SimpleObjectMode\n  toCircle: boolean\n}\nexport class SimpleObjectAdd extends Base {\n  data: SimpleObjectAddData\n\n  constructor(\n    pos: Array<Vec2> = [],\n    mode: SimpleObjectMode = SimpleObjectMode.line,\n    toCircle: boolean = false,\n    id?: number\n  ) {\n    super(OperationType.SIMPLE_OBJECT_ADD)\n    this.data = { pos, mode, toCircle, id }\n  }\n\n  execute(restruct: any): void {\n    const struct = restruct.molecule\n    const item = new SimpleObject({ mode: this.data.mode })\n\n    if (this.data.id == null) {\n      const index = struct.simpleObjects.add(item)\n      this.data.id = index\n    } else {\n      struct.simpleObjects.set(this.data.id!, item)\n    }\n\n    const itemId = this.data.id!\n\n    restruct.simpleObjects.set(itemId, new ReSimpleObject(item))\n\n    const positions = [...this.data.pos]\n    if (this.data.toCircle) {\n      positions[1] = makeCircleFromEllipse(positions[0], positions[1])\n    }\n    struct.simpleObjectSetPos(\n      itemId,\n      positions.map(p => new Vec2(p))\n    )\n\n    Base.invalidateItem(restruct, 'simpleObjects', itemId, 1)\n  }\n  invert(): Base {\n    return new SimpleObjectDelete(this.data.id!)\n  }\n}\n\ninterface SimpleObjectDeleteData {\n  id: number\n  pos?: Array<Vec2>\n  mode?: SimpleObjectMode\n  toCircle?: boolean\n}\n\nexport class SimpleObjectDelete extends Base {\n  data: SimpleObjectDeleteData\n  performed: boolean\n\n  constructor(id: number) {\n    super(OperationType.SIMPLE_OBJECT_DELETE)\n    this.data = { id, pos: [], mode: SimpleObjectMode.line, toCircle: false }\n    this.performed = false\n  }\n\n  execute(restruct: any): void {\n    const struct = restruct.molecule\n    const item = struct.simpleObjects.get(this.data.id) as any\n    //save to data current values. In future they could be used in invert for restoring simple object\n    this.data.pos = item.pos\n    this.data.mode = item.mode\n    this.data.toCircle = item.toCircle\n    this.performed = true\n\n    restruct.markItemRemoved()\n    restruct.clearVisel(restruct.simpleObjects.get(this.data.id).visel)\n    restruct.simpleObjects.delete(this.data.id)\n\n    struct.simpleObjects.delete(this.data.id)\n  }\n\n  invert(): Base {\n    return new SimpleObjectAdd(\n      this.data.pos,\n      this.data.mode,\n      this.data.toCircle,\n      this.data.id\n    )\n  }\n}\n\ninterface SimpleObjectMoveData {\n  id: number\n  d: any\n  noinvalidate: boolean\n}\n\nexport class SimpleObjectMove extends Base {\n  data: SimpleObjectMoveData\n\n  constructor(id: number, d: any, noinvalidate: boolean) {\n    super(OperationType.SIMPLE_OBJECT_MOVE)\n    this.data = { id, d, noinvalidate }\n  }\n  execute(restruct: any): void {\n    const struct = restruct.molecule\n    const id = this.data.id\n    const d = this.data.d\n    const item = struct.simpleObjects.get(id)\n    item.pos.forEach(p => p.add_(d))\n    restruct.simpleObjects\n      .get(id)\n      .visel.translate(Scale.obj2scaled(d, restruct.render.options))\n    this.data.d = d.negated()\n    if (!this.data.noinvalidate) {\n      Base.invalidateItem(restruct, 'simpleObjects', id, 1)\n    }\n  }\n\n  invert(): Base {\n    const move = new SimpleObjectMove(\n      this.data.id,\n      this.data.d,\n      this.data.noinvalidate\n    )\n    //todo Need further investigation on why this is needed?\n    move.data = this.data\n    return move\n  }\n}\n\ninterface SimpleObjectResizeData {\n  id: number\n  d: any\n  current: Vec2\n  anchor: Vec2\n  noinvalidate: boolean\n  toCircle: boolean\n}\n\nfunction handleRectangleChangeWithAnchor(item, anchor, current) {\n  const previousPos0 = item.pos[0].get_xy0()\n  const previousPos1 = item.pos[1].get_xy0()\n\n  if (tfx(anchor.x) === tfx(item.pos[1].x)) {\n    item.pos[1].x = anchor.x = current.x\n    current.x = previousPos1.x\n  }\n  if (tfx(anchor.y) === tfx(item.pos[1].y)) {\n    item.pos[1].y = anchor.y = current.y\n    current.y = previousPos1.y\n  }\n  if (tfx(anchor.x) === tfx(item.pos[0].x)) {\n    item.pos[0].x = anchor.x = current.x\n    current.x = previousPos0.x\n  }\n  if (tfx(anchor.y) === tfx(item.pos[0].y)) {\n    item.pos[0].y = anchor.y = current.y\n    current.y = previousPos0.y\n  }\n}\n\nexport class SimpleObjectResize extends Base {\n  data: SimpleObjectResizeData\n\n  constructor(\n    id: number,\n    d: any,\n    current: Vec2,\n    anchor: any,\n    noinvalidate: boolean,\n    toCircle: boolean\n  ) {\n    super(OperationType.SIMPLE_OBJECT_RESIZE)\n    this.data = { id, d, current, anchor, noinvalidate, toCircle }\n  }\n\n  execute(restruct: any): void {\n    const struct = restruct.molecule\n    const id = this.data.id\n    const d = this.data.d\n    const current = this.data.current\n    const item = struct.simpleObjects.get(id)\n    const anchor = this.data.anchor\n    if (item.mode === SimpleObjectMode.ellipse) {\n      if (anchor) {\n        handleRectangleChangeWithAnchor(item, anchor, current)\n      } else if (this.data.toCircle) {\n        const previousPos1 = item.pos[1].get_xy0()\n        const circlePoint = makeCircleFromEllipse(item.pos[0], current)\n        item.pos[1].x = circlePoint.x\n        item.pos[1].y = circlePoint.y\n        this.data.current = previousPos1\n      } else {\n        const previousPos1 = item.pos[1].get_xy0()\n        item.pos[1].x = current.x\n        item.pos[1].y = current.y\n        this.data.current = previousPos1\n      }\n    } else if (item.mode === SimpleObjectMode.line && anchor) {\n      const previousPos0 = item.pos[0].get_xy0()\n      const previousPos1 = item.pos[1].get_xy0()\n\n      if (\n        tfx(anchor.x) === tfx(item.pos[1].x) &&\n        tfx(anchor.y) === tfx(item.pos[1].y)\n      ) {\n        item.pos[1].x = anchor.x = current.x\n        current.x = previousPos1.x\n        item.pos[1].y = anchor.y = current.y\n        current.y = previousPos1.y\n      }\n\n      if (\n        tfx(anchor.x) === tfx(item.pos[0].x) &&\n        tfx(anchor.y) === tfx(item.pos[0].y)\n      ) {\n        item.pos[0].x = anchor.x = current.x\n        current.x = previousPos0.x\n        item.pos[0].y = anchor.y = current.y\n        current.y = previousPos0.y\n      }\n    } else if (item.mode === SimpleObjectMode.rectangle && anchor) {\n      handleRectangleChangeWithAnchor(item, anchor, current)\n    } else item.pos[1].add_(d)\n\n    restruct.simpleObjects\n      .get(id)\n      .visel.translate(Scale.obj2scaled(d, restruct.render.options))\n    this.data.d = d.negated()\n    if (!this.data.noinvalidate) {\n      Base.invalidateItem(\n        restruct,\n        'simpleObjects',\n        // @ts-ignore\n        id,\n        1\n      )\n    }\n  }\n  invert(): Base {\n    return new SimpleObjectResize(\n      this.data.id,\n      this.data.d,\n      this.data.current,\n      this.data.anchor,\n      this.data.noinvalidate,\n      this.data.toCircle\n    )\n  }\n}\n\nexport function makeCircleFromEllipse(position0: Vec2, position1: Vec2): Vec2 {\n  const diff = Vec2.diff(position1, position0)\n  const min = Math.abs(diff.x) < Math.abs(diff.y) ? diff.x : diff.y\n  return new Vec2(\n    position0.x + (diff.x > 0 ? 1 : -1) * Math.abs(min),\n    position0.y + (diff.y > 0 ? 1 : -1) * Math.abs(min),\n    0\n  )\n}\n","/****************************************************************************\n * Copyright 2021 EPAM Systems\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *    http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n ***************************************************************************/\n\nimport { BaseOperation } from '../base'\nimport { OperationType } from '../OperationType'\nimport { ReStruct } from '../../../render'\nimport { SGroup } from 'domain/entities'\n\n// todo: separate classes: now here is circular dependency in `invert` method\n\ntype Data = {\n  sgid: any\n  aid: any\n}\n\nclass SGroupAtomAdd extends BaseOperation {\n  data: Data\n\n  constructor(sgroupId?: any, aid?: any) {\n    super(OperationType.S_GROUP_ATOM_ADD, 3)\n    this.data = { sgid: sgroupId, aid }\n  }\n\n  execute(restruct: ReStruct) {\n    const { aid, sgid } = this.data\n\n    const struct = restruct.molecule\n    const atom = struct.atoms.get(aid)!\n    const sgroup = struct.sgroups.get(sgid)!\n\n    if (sgroup.atoms.indexOf(aid) >= 0) {\n      throw new Error(\n        'The same atom cannot be added to an S-group more than once'\n      )\n    }\n\n    if (!atom) {\n      throw new Error('OpSGroupAtomAdd: Atom ' + aid + ' not found')\n    }\n\n    struct.atomAddToSGroup(sgid, aid)\n    BaseOperation.invalidateAtom(restruct, aid)\n  }\n\n  invert() {\n    const inverted = new SGroupAtomRemove()\n    inverted.data = this.data\n    return inverted\n  }\n}\n\nclass SGroupAtomRemove extends BaseOperation {\n  data: Data\n\n  constructor(sgroupId?: any, aid?: any) {\n    super(OperationType.S_GROUP_ATOM_REMOVE, 4)\n    this.data = { sgid: sgroupId, aid }\n  }\n\n  execute(restruct: ReStruct) {\n    const { aid, sgid } = this.data\n\n    const struct = restruct.molecule\n    const atom = struct.atoms.get(aid)!\n    const sgroup = struct.sgroups.get(sgid)!\n\n    SGroup.removeAtom(sgroup, aid)\n    atom.sgs.delete(sgid)\n    BaseOperation.invalidateAtom(restruct, aid)\n  }\n\n  invert() {\n    const inverted = new SGroupAtomAdd()\n    inverted.data = this.data\n    return inverted\n  }\n}\n\nexport { SGroupAtomAdd, SGroupAtomRemove }\n","/****************************************************************************\n * Copyright 2021 EPAM Systems\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *    http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n ***************************************************************************/\n\nimport { BaseOperation } from '../base'\nimport { OperationType } from '../OperationType'\nimport { ReStruct } from '../../../render'\n\nexport class SGroupAttr extends BaseOperation {\n  data: {\n    sgid: any\n    attr: any\n    value: any\n  }\n\n  constructor(sgroupId?: any, attribute?: any, value?: any) {\n    super(OperationType.S_GROUP_ATTR, 4)\n    this.data = {\n      sgid: sgroupId,\n      attr: attribute,\n      value\n    }\n  }\n\n  execute(restruct: ReStruct) {\n    const struct = restruct.molecule\n    const sgroupId = this.data.sgid\n    const sgroup = struct.sgroups.get(sgroupId)!\n\n    const sgroupData = restruct.sgroupData.get(sgroupId)\n    if (sgroup.type === 'DAT' && sgroupData) {\n      // clean the stuff here, else it might be left behind if the sgroups is set to \"attached\"\n      restruct.clearVisel(sgroupData.visel)\n      restruct.sgroupData.delete(sgroupId)\n    }\n\n    this.data.value = sgroup.setAttr(this.data.attr, this.data.value)\n  }\n\n  invert() {\n    const inverted = new SGroupAttr()\n    inverted.data = this.data\n    return inverted\n  }\n}\n","/****************************************************************************\n * Copyright 2021 EPAM Systems\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *    http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n ***************************************************************************/\n\nimport { BaseOperation } from '../base'\nimport { OperationType } from '../OperationType'\nimport { ReStruct } from '../../../render'\n\nexport class SGroupDataMove extends BaseOperation {\n  data: {\n    id: any\n    d: any\n  }\n\n  constructor(id?: any, d?: any) {\n    super(OperationType.S_GROUP_DATA_MOVE)\n    this.data = { id, d }\n  }\n\n  execute(restruct: ReStruct) {\n    const { d, id } = this.data\n    const { sgroups } = restruct.molecule\n\n    sgroups.get(id)!.pp?.add_(d) // eslint-disable-line no-underscore-dangle\n    this.data.d = d.negated()\n\n    // [MK] this currently does nothing since the DataSGroupData Visel only contains the highlighting/selection and SGroups are redrawn every time anyway\n    BaseOperation.invalidateItem(restruct, 'sgroupData', id, 1)\n  }\n\n  invert() {\n    const inverted = new SGroupDataMove()\n    inverted.data = this.data\n    return inverted\n  }\n}\n","/****************************************************************************\n * Copyright 2021 EPAM Systems\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *    http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n ***************************************************************************/\n\nimport { BaseOperation } from '../base'\nimport { OperationType } from '../OperationType'\nimport { ReStruct } from '../../../render'\n\n// todo: separate classes: now here is circular dependency in `invert` method\n\ntype Data = {\n  sgid: any\n  parent?: any\n  children?: any\n}\n\nclass SGroupAddToHierarchy extends BaseOperation {\n  data: Data\n\n  constructor(sgroupId?: any, parent?: any, children?: any) {\n    super(OperationType.S_GROUP_ADD_TO_HIERACHY, 100)\n    this.data = { sgid: sgroupId, parent, children }\n  }\n\n  execute(restruct: ReStruct) {\n    const { sgid, parent, children } = this.data\n\n    const struct = restruct.molecule\n    const sgroup = struct.sgroups.get(sgid)!\n    const relations = struct.sGroupForest.insert(sgroup, parent, children)\n\n    this.data.parent = relations.parent\n    this.data.children = relations.children\n  }\n\n  invert() {\n    const inverted = new SGroupRemoveFromHierarchy()\n    inverted.data = this.data\n    return inverted\n  }\n}\n\nclass SGroupRemoveFromHierarchy extends BaseOperation {\n  data: Data\n\n  constructor(sgroupId?: any) {\n    super(OperationType.S_GROUP_REMOVE_FROM_HIERACHY, 110)\n    this.data = { sgid: sgroupId }\n  }\n\n  execute(restruct: any) {\n    const { sgid } = this.data\n    const struct = restruct.molecule\n\n    this.data.parent = struct.sGroupForest.parent.get(sgid)\n    this.data.children = struct.sGroupForest.children.get(sgid)\n    struct.sGroupForest.remove(sgid)\n  }\n\n  invert() {\n    const inverted = new SGroupAddToHierarchy()\n    inverted.data = this.data\n    return inverted\n  }\n}\n\nexport { SGroupAddToHierarchy, SGroupRemoveFromHierarchy }\n","/****************************************************************************\n * Copyright 2021 EPAM Systems\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *    http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n ***************************************************************************/\n\nimport { FunctionalGroup, SGroup, Vec2 } from 'domain/entities'\nimport { ReSGroup, ReStruct } from '../../../render'\n\nimport { BaseOperation } from '../base'\nimport { OperationType } from '../OperationType'\n\n// todo: separate classes: now here is circular dependency in `invert` method\n\ntype Data = {\n  sgid: any\n  type?: any\n  pp?: any\n  expanded?: boolean\n  name?: string\n}\n\nclass SGroupCreate extends BaseOperation {\n  data: Data\n\n  constructor(\n    sgroupId?: any,\n    type?: any,\n    pp?: any,\n    expanded?: boolean,\n    name?: string\n  ) {\n    super(OperationType.S_GROUP_CREATE)\n    this.data = {\n      sgid: sgroupId,\n      type,\n      pp,\n      expanded,\n      name\n    }\n  }\n\n  execute(restruct: ReStruct) {\n    const struct = restruct.molecule\n    const sgroup = new SGroup(this.data.type)\n    const { sgid, pp, expanded, name } = this.data\n\n    sgroup.id = sgid\n    struct.sgroups.set(sgid, sgroup)\n\n    if (pp) {\n      struct.sgroups.get(sgid)!.pp = new Vec2(pp)\n    }\n\n    if (expanded) {\n      sgroup.data.expanded = expanded\n    }\n\n    if (name) {\n      sgroup.data.name = name\n    }\n\n    restruct.sgroups.set(sgid, new ReSGroup(struct.sgroups.get(sgid)))\n    if (FunctionalGroup.isFunctionalGroup(sgroup)) {\n      restruct.molecule.functionalGroups.add(new FunctionalGroup(sgroup))\n    }\n    this.data.sgid = sgid\n  }\n\n  invert() {\n    const inverted = new SGroupDelete()\n    inverted.data = this.data\n    return inverted\n  }\n}\n\nclass SGroupDelete extends BaseOperation {\n  data: Data\n\n  constructor(sgroupId?: any) {\n    super(OperationType.S_GROUP_DELETE, 95)\n    this.data = { sgid: sgroupId }\n  }\n\n  execute(restruct: ReStruct) {\n    const struct = restruct.molecule\n    const { sgid } = this.data\n    const sgroup = restruct.sgroups.get(sgid)\n    const sgroupData = restruct.sgroupData.get(sgid)\n    if (!sgroup) return\n    this.data.type = sgroup.item.type\n    this.data.pp = sgroup.item.pp\n\n    if (sgroup.item.type === 'DAT' && sgroupData) {\n      restruct.clearVisel(sgroupData.visel)\n      restruct.sgroupData.delete(sgid)\n    }\n\n    restruct.clearVisel(sgroup.visel)\n    if (sgroup.item.atoms.length !== 0) {\n      throw new Error('S-Group not empty!')\n    }\n\n    if (FunctionalGroup.isFunctionalGroup(sgroup.item)) {\n      let relatedFGroupId\n      this.data.name = sgroup.item.data.name\n      this.data.expanded = sgroup.item.expanded\n      restruct.molecule.functionalGroups.forEach((fg, fgid) => {\n        if (fg.relatedSGroupId === sgid) {\n          relatedFGroupId = fgid\n        }\n      })\n      restruct.molecule.functionalGroups.delete(relatedFGroupId)\n    }\n\n    restruct.sgroups.delete(sgid)\n    struct.sgroups.delete(sgid)\n  }\n\n  invert() {\n    const inverted = new SGroupCreate()\n    inverted.data = this.data\n    return inverted\n  }\n}\n\nexport { SGroupCreate, SGroupDelete }\nexport * from './sgroupAtom'\nexport * from './SGroupAttr'\nexport * from './SGroupDataMove'\nexport * from './sgroupHierarchy'\n","/****************************************************************************\n * Copyright 2021 EPAM Systems\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *    http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n ***************************************************************************/\n\nimport { ReStruct, ReText } from '../../../render'\nimport { Text, Vec2 } from 'domain/entities'\n\nimport { BaseOperation } from '../base'\nimport { OperationType } from '../OperationType'\n\ninterface TextCreateData {\n  id?: number\n  content: string\n  position: Vec2\n}\n\nexport class TextCreate extends BaseOperation {\n  data: TextCreateData\n\n  constructor(content: string, position: Vec2, id?: number) {\n    super(OperationType.TEXT_CREATE)\n    this.data = { content: content, position, id }\n  }\n\n  execute(restruct: ReStruct): void {\n    const struct = restruct.molecule\n    const item = new Text(this.data)\n\n    if (this.data.id == null) {\n      const index = struct.texts.add(item)\n      this.data.id = index\n    } else {\n      struct.texts.set(this.data.id!, item)\n    }\n\n    const itemId = this.data.id!\n\n    restruct.texts.set(itemId, new ReText(item))\n\n    struct.textSetPosition(itemId, new Vec2(this.data.position))\n    BaseOperation.invalidateItem(restruct, 'texts', itemId, 1)\n  }\n\n  invert(): BaseOperation {\n    return new TextDelete(this.data.id!)\n  }\n}\n\ninterface TextDeleteData {\n  id: number\n  content?: string\n  position?: Vec2\n}\n\nexport class TextDelete extends BaseOperation {\n  data: TextDeleteData\n\n  constructor(id: number) {\n    super(OperationType.TEXT_DELETE)\n    this.data = { id }\n  }\n\n  execute(restruct: ReStruct): void {\n    const struct = restruct.molecule\n    const item = struct.texts.get(this.data.id)!\n    if (!item) return\n\n    this.data.content = item.content!\n    this.data.position = item.position\n\n    restruct.markItemRemoved()\n\n    restruct.clearVisel(restruct.texts.get(this.data.id)!.visel)\n    restruct.texts.delete(this.data.id)\n\n    struct.texts.delete(this.data.id)\n  }\n\n  invert(): BaseOperation {\n    return new TextCreate(this.data.content!, this.data.position!, this.data.id)\n  }\n}\n","/****************************************************************************\n * Copyright 2021 EPAM Systems\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *    http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n ***************************************************************************/\n\nimport { BaseOperation } from '../base'\nimport { OperationType } from '../OperationType'\nimport { ReStruct } from '../../../render'\n\ninterface TextUpdateData {\n  id: number\n  content: string\n  previousContent?: string\n}\n\nexport class TextUpdate extends BaseOperation {\n  data: TextUpdateData\n\n  constructor(id: number, content: string) {\n    super(OperationType.TEXT_UPDATE)\n    this.data = { id, content: content }\n  }\n\n  execute(restruct: ReStruct) {\n    const { id, content } = this.data\n    const text = restruct.molecule.texts.get(id)\n\n    if (text) {\n      this.data.previousContent = text.content!\n      text.content = content\n    }\n\n    BaseOperation.invalidateItem(restruct, 'texts', id, 1)\n  }\n\n  invert() {\n    const inverted = new TextUpdate(this.data.id, this.data.previousContent!)\n\n    inverted.data.previousContent = this.data.content\n    return inverted\n  }\n}\n","/****************************************************************************\n * Copyright 2021 EPAM Systems\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *    http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n ***************************************************************************/\n\nimport { BaseOperation } from '../base'\nimport { OperationType } from '../OperationType'\nimport { ReStruct } from '../../../render'\nimport { Scale } from 'domain/helpers'\n\ninterface TextMoveData {\n  id: any\n  d: any\n  noinvalidate: boolean\n}\n\nexport class TextMove extends BaseOperation {\n  data: TextMoveData\n\n  constructor(id: any, d: any, noinvalidate: boolean) {\n    super(OperationType.TEXT_MOVE)\n    this.data = { id, d, noinvalidate }\n  }\n\n  execute(restruct: ReStruct): void {\n    const struct = restruct.molecule\n    const id = this.data.id\n    const difference = this.data.d\n    const item = struct.texts.get(id)\n\n    item?.position?.add_(difference)\n    restruct.texts\n      .get(id)\n      ?.visel.translate(Scale.obj2scaled(difference, restruct.render.options))\n\n    this.data.d = difference.negated()\n\n    if (!this.data.noinvalidate) {\n      BaseOperation.invalidateItem(restruct, 'texts', id, 1)\n    }\n  }\n\n  invert(): BaseOperation {\n    const move = new TextMove(this.data.id, this.data.d, this.data.noinvalidate)\n\n    move.data = this.data\n\n    return move\n  }\n}\n","/****************************************************************************\n * Copyright 2021 EPAM Systems\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *    http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n ***************************************************************************/\n\nimport { BaseOperation } from '../operations/base'\nimport { ReStruct } from '../../render'\n//\n// Undo/redo actions\n//\nexport class Action {\n  operations: BaseOperation[]\n\n  constructor(operations = []) {\n    this.operations = operations\n  }\n\n  addOp(operation: BaseOperation, restruct?: ReStruct): BaseOperation {\n    if (!restruct || !operation.isDummy(restruct)) {\n      this.operations.push(operation)\n    }\n\n    return operation\n  }\n\n  mergeWith(action) {\n    this.operations = this.operations.concat(action.operations)\n    return this\n  }\n\n  // Perform action and return inverted one\n  perform(restruct: ReStruct) {\n    const action = new Action()\n    const sortedOperations = [...this.operations].sort(\n      (a, b) => a.priority - b.priority\n    )\n    sortedOperations.forEach(operation => {\n      const invertedOperation = operation.perform(restruct)\n      action.addOp(invertedOperation)\n    })\n\n    return action\n  }\n\n  isDummy(restruct?: ReStruct) {\n    return (\n      this.operations.find(\n        // TODO [RB] the condition is always true for op.* operations\n        operation => (restruct ? !operation.isDummy(restruct) : true)\n      ) === undefined\n    )\n  }\n}\n","/****************************************************************************\n * Copyright 2021 EPAM Systems\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *    http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n ***************************************************************************/\n\nimport { Action } from './action'\nimport { Bond } from 'domain/entities'\nimport { BondAttr } from '../operations'\nimport { MolSerializer } from 'domain/serializers'\n\n/**\n * @param restruct { ReStruct }\n * @param events { Array<PipelineSubscription> }\n * @param bid { number }\n * @param template {{\n * \t\tmolecule: Struct,\n * \t\tbid: number\n *  }}\n * @param simpleFusing { Function }\n * @returns { Promise }\n */\nexport function fromAromaticTemplateOnBond(\n  restruct,\n  template,\n  bid,\n  events,\n  simpleFusing\n) {\n  const tmpl = template.molecule\n  const struct = restruct.molecule\n\n  const frid = struct.getBondFragment(bid)\n  const beforeMerge = getFragmentWithBondMap(struct, frid)\n  let afterMerge: any = null\n  let pasteItems: any = null\n\n  let action = new Action()\n\n  if (true) {\n    action = simpleFusing(restruct, template, bid)\n    return Promise.resolve(action)\n  }\n\n  const molSerialzer = new MolSerializer()\n\n  return Promise.all([\n    events.aromatizeStruct\n      .dispatch(beforeMerge.frag)\n      .then(res => molSerialzer.deserialize(res.struct)),\n    events.aromatizeStruct\n      .dispatch(tmpl)\n      .then(res => molSerialzer.deserialize(res.struct))\n  ])\n    .then(([astruct, atmpl]) => {\n      // aromatize restruct fragment\n      const aromatizeAction = fromAromatize(\n        restruct,\n        astruct,\n        beforeMerge.bondMap\n      )\n      // merge template with fragment\n      const aromTemplate = { bid: template.bid, molecule: atmpl }\n      const templateFusingAction = simpleFusing(restruct, aromTemplate, bid)\n      pasteItems = templateFusingAction[1]\n\n      action = templateFusingAction[0].mergeWith(aromatizeAction)\n\n      afterMerge = getFragmentWithBondMap(restruct.molecule, frid)\n\n      return events.dearomatizeStruct\n        .dispatch(afterMerge.frag)\n        .then(res => molSerialzer.deserialize(res.struct))\n    })\n    .then(destruct => {\n      destruct.bonds.forEach(bond => {\n        if (bond.type === Bond.PATTERN.TYPE.AROMATIC)\n          throw Error('Bad dearomatize')\n      })\n\n      // dearomatize restruct fragment\n      const dearomatizeAction = fromDearomatize(\n        restruct,\n        destruct,\n        afterMerge.bondMap\n      )\n      action = dearomatizeAction.mergeWith(action)\n\n      return [action, pasteItems]\n    })\n    .catch(err => {\n      console.info(err.message)\n      action.perform(restruct) // revert actions if error\n\n      return simpleFusing(restruct, template, bid)\n    })\n}\n\nfunction fromAromatize(restruct, astruct, bondMap) {\n  const action = new Action()\n\n  astruct.bonds.forEach((bond, bid) => {\n    if (bond.type !== Bond.PATTERN.TYPE.AROMATIC) return\n    action.addOp(\n      new BondAttr(\n        bondMap.get(bid),\n        'type',\n        Bond.PATTERN.TYPE.AROMATIC\n      ).perform(restruct)\n    )\n  })\n\n  return action\n}\n\n/**\n * @param restruct { ReStruct }\n * @param dastruct { ReStruct }\n * @param bondMap { Map<number, number> }\n * @returns { Action }\n */\nfunction fromDearomatize(restruct, dastruct, bondMap) {\n  const action = new Action()\n\n  dastruct.bonds.forEach((bond, bid) => {\n    action.addOp(\n      new BondAttr(bondMap.get(bid), 'type', bond.type).perform(restruct)\n    )\n  })\n\n  return action\n}\n\n/* UTILS */\n\n// @ts-ignore\nfunction canBeAromatized(struct) {\n  // TODO correct this checking && move to chem.Struct ??\n  if (struct.loops.size === 0) struct.prepareLoopStructure()\n\n  const hasAromLoop = struct.loops.find((_id, loop) => loop.aromatic)\n  if (struct.loops.size === 0 || hasAromLoop) return false\n\n  const correctDblBonds = struct.loops.find(\n    (_id, loop) => loop.dblBonds === loop.hbs.length / 2\n  )\n\n  return correctDblBonds !== undefined\n}\n\n/**\n * @param struct { Struct }\n * @param frid { number }\n * @returns {{\n * \t\tfrag: Struct,\n * \t\tbondMap: Map<number, number>\n *  }}\n */\nfunction getFragmentWithBondMap(struct, frid) {\n  const atomSet = struct.getFragmentIds(frid)\n  const atomsInStruct = Array.from(atomSet)\n\n  const frag = struct.clone(atomSet)\n  const bondMap = new Map()\n  frag.bonds.forEach((bond, bid) => {\n    bondMap.set(\n      bid,\n      struct.findBondId(atomsInStruct[bond.begin], atomsInStruct[bond.end])\n    )\n  })\n\n  return { frag, bondMap }\n}\n","/****************************************************************************\n * Copyright 2021 EPAM Systems\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *    http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n ***************************************************************************/\n\nimport { Fragment, Vec2 } from 'domain/entities'\n\nconst SELECTION_DISTANCE_COEFFICIENT = 0.4\nconst SELECTION_WITHIN_TEXT = 0\n\nconst findMaps = {\n  atoms: findClosestAtom,\n  bonds: findClosestBond,\n  enhancedFlags: findClosestEnhancedFlag,\n  sgroupData: findClosestDataSGroupData,\n  sgroups: findClosestSGroup,\n  rxnArrows: findClosestRxnArrow,\n  rxnPluses: findClosestRxnPlus,\n  frags: findClosestFrag,\n  rgroups: findClosestRGroup,\n  simpleObjects: findClosestSimpleObject,\n  texts: findClosestText\n}\n\nfunction findClosestText(restruct, cursorPosition) {\n  let minDist = null\n  let ret = null\n\n  restruct.texts.forEach((text, id) => {\n    const referencePoints = text.getReferencePoints(restruct)\n    const topX = referencePoints[0].x\n    const topY = referencePoints[0].y\n    const bottomX = referencePoints[2].x\n    const bottomY = referencePoints[2].y\n\n    const distances = []\n\n    if (cursorPosition.x >= topX && cursorPosition.x <= bottomX) {\n      if (cursorPosition.y < topY) {\n        distances.push(topY - cursorPosition.y)\n      } else if (cursorPosition.y > bottomY) {\n        distances.push(cursorPosition.y - bottomY)\n      } else {\n        distances.push(cursorPosition.y - topY, bottomY - cursorPosition.y)\n      }\n    }\n\n    if (cursorPosition.x < topX && cursorPosition.y < topY) {\n      distances.push(Vec2.dist(new Vec2(topX, topY), cursorPosition))\n    }\n\n    if (cursorPosition.x > bottomX && cursorPosition.y > bottomY) {\n      distances.push(Vec2.dist(new Vec2(bottomX, bottomY), cursorPosition))\n    }\n\n    if (cursorPosition.x < topX && cursorPosition.y > bottomY) {\n      distances.push(Vec2.dist(new Vec2(topX, bottomY), cursorPosition))\n    }\n\n    if (cursorPosition.x > bottomX && cursorPosition.y < topY) {\n      distances.push(Vec2.dist(new Vec2(bottomX, topY), cursorPosition))\n    }\n\n    if (cursorPosition.y >= topY && cursorPosition.y <= bottomY) {\n      if (cursorPosition.x < topX) {\n        distances.push(topX - cursorPosition.x)\n      } else if (cursorPosition.x > bottomX) {\n        distances.push(cursorPosition.x - bottomX)\n      } else {\n        distances.push(SELECTION_WITHIN_TEXT)\n      }\n    }\n\n    let dist = Math.min(...distances)\n\n    if (dist < SELECTION_DISTANCE_COEFFICIENT && (!ret || dist < minDist)) {\n      minDist = dist\n      ret = { id, dist: minDist }\n    }\n  })\n  return ret\n}\n\nfunction findClosestSimpleObject(restruct, pos) {\n  let minDist = null\n  let refPoint = null\n  let ret = null\n\n  restruct.simpleObjects.forEach((simpleObject, id) => {\n    const dist = simpleObject.calcDistance(pos, restruct.render.options.scale)\n\n    if (dist.minDist < 0.3 && (!ret || dist.minDist < minDist)) {\n      minDist = dist.minDist\n      refPoint = dist.refPoint\n\n      ret = { id, dist: minDist, ref: refPoint }\n    }\n  })\n  return ret\n}\n\nfunction findClosestAtom(restruct, pos, skip, minDist) {\n  let closestAtom = null\n  const maxMinDist = SELECTION_DISTANCE_COEFFICIENT\n  const skipId = skip && skip.map === 'atoms' ? skip.id : null\n\n  minDist = minDist || maxMinDist\n  minDist = Math.min(minDist, maxMinDist)\n\n  restruct.atoms.forEach((atom, aid) => {\n    if (aid === skipId) return\n\n    const dist = Vec2.dist(pos, atom.a.pp)\n\n    if (dist < minDist) {\n      closestAtom = aid\n      minDist = dist\n    }\n  })\n\n  if (closestAtom !== null) {\n    return {\n      id: closestAtom,\n      dist: minDist\n    }\n  }\n\n  return null\n}\n\nfunction findClosestBond(restruct, pos, skip, minDist, scale) {\n  // eslint-disable-line max-params\n  let closestBond = null\n  let closestBondCenter = null\n  const maxMinDist = 0.8 * SELECTION_DISTANCE_COEFFICIENT\n  const skipId = skip && skip.map === 'bonds' ? skip.id : null\n\n  minDist = minDist || maxMinDist\n  minDist = Math.min(minDist, maxMinDist)\n\n  let minCDist = minDist\n\n  restruct.bonds.forEach((bond, bid) => {\n    if (bid === skipId) return\n\n    const p1 = restruct.atoms.get(bond.b.begin).a.pp\n    const p2 = restruct.atoms.get(bond.b.end).a.pp\n\n    const mid = Vec2.lc2(p1, 0.5, p2, 0.5)\n    const cdist = Vec2.dist(pos, mid)\n\n    if (cdist < minCDist) {\n      minCDist = cdist\n      closestBondCenter = bid\n    }\n  })\n\n  restruct.bonds.forEach((bond, bid) => {\n    if (bid === skipId) return\n\n    const hb = restruct.molecule.halfBonds.get(bond.b.hb1)\n    const dir = hb.dir\n    const norm = hb.norm\n\n    const p1 = restruct.atoms.get(bond.b.begin).a.pp\n    const p2 = restruct.atoms.get(bond.b.end).a.pp\n\n    const inStripe = Vec2.dot(pos.sub(p1), dir) * Vec2.dot(pos.sub(p2), dir) < 0\n\n    if (inStripe) {\n      const dist = Math.abs(Vec2.dot(pos.sub(p1), norm))\n\n      if (dist < minDist) {\n        closestBond = bid\n        minDist = dist\n      }\n    }\n  })\n\n  if (closestBondCenter !== null) {\n    return {\n      id: closestBondCenter,\n      dist: minCDist\n    }\n  }\n\n  if (\n    closestBond !== null &&\n    minDist > SELECTION_DISTANCE_COEFFICIENT * scale\n  ) {\n    return {\n      id: closestBond,\n      dist: minDist\n    }\n  }\n\n  return null\n}\n\nfunction findClosestEnhancedFlag(restruct, pos) {\n  let minDist\n  let ret = null\n  restruct.enhancedFlags.forEach((item, id) => {\n    const fragment = restruct.molecule.frags.get(id)\n    if (!fragment) return\n\n    const p = fragment.stereoFlagPosition\n      ? new Vec2(fragment.stereoFlagPosition.x, fragment.stereoFlagPosition.y)\n      : Fragment.getDefaultStereoFlagPosition(restruct.molecule, id)\n    if (!p || Math.abs(pos.x - p.x) >= 1.0) return\n\n    const dist = Math.abs(pos.y - p.y)\n\n    if (dist < 0.3 && (!ret || dist < minDist)) {\n      minDist = dist\n      ret = { id, dist: minDist }\n    }\n  })\n  return ret\n}\n\nfunction findClosestDataSGroupData(restruct, pos) {\n  let minDist = null\n  let ret = null\n\n  restruct.sgroupData.forEach((item, id) => {\n    if (item.sgroup.type !== 'DAT') throw new Error('Data group expected')\n\n    if (item.sgroup.data.fieldName !== 'MRV_IMPLICIT_H') {\n      const box = item.sgroup.dataArea\n      const inBox =\n        box.p0.y < pos.y &&\n        box.p1.y > pos.y &&\n        box.p0.x < pos.x &&\n        box.p1.x > pos.x\n      const xDist = Math.min(\n        Math.abs(box.p0.x - pos.x),\n        Math.abs(box.p1.x - pos.x)\n      )\n\n      if (inBox && (ret === null || xDist < minDist)) {\n        ret = { id, dist: xDist }\n        minDist = xDist\n      }\n    }\n  })\n\n  return ret\n}\n\nfunction findClosestFrag(restruct, pos, skip, minDist, scale) {\n  minDist = Math.min(\n    minDist || SELECTION_DISTANCE_COEFFICIENT,\n    SELECTION_DISTANCE_COEFFICIENT\n  )\n\n  const struct = restruct.molecule\n\n  const closestAtom = findClosestAtom(restruct, pos, skip, minDist)\n\n  if (closestAtom) {\n    return {\n      id: struct.atoms.get(closestAtom.id).fragment,\n      dist: closestAtom.dist\n    }\n  }\n\n  const closestBond = findClosestBond(restruct, pos, skip, minDist, scale)\n\n  if (closestBond) {\n    const atomId = struct.bonds.get(closestBond.id).begin\n    return {\n      id: struct.atoms.get(atomId).fragment,\n      dist: closestBond.dist\n    }\n  }\n\n  return null\n}\n\nfunction findClosestRGroup(restruct, pos, skip, minDist) {\n  minDist = Math.min(\n    minDist || SELECTION_DISTANCE_COEFFICIENT,\n    SELECTION_DISTANCE_COEFFICIENT\n  )\n\n  let ret = null\n\n  restruct.rgroups.forEach((rgroup, rgid) => {\n    if (\n      rgid !== skip &&\n      rgroup.labelBox &&\n      rgroup.labelBox.contains(pos, 0.5)\n    ) {\n      const dist = Vec2.dist(rgroup.labelBox.centre(), pos)\n\n      if (!ret || dist < minDist) {\n        minDist = dist\n        ret = { id: rgid, dist: minDist }\n      }\n    }\n  })\n\n  return ret\n}\n\nfunction findClosestRxnArrow(restruct, pos) {\n  let minDist = null\n  let refPoint = null\n  let ret = null\n\n  restruct.rxnArrows.forEach((rxnArrow, id) => {\n    const dist = rxnArrow.calcDistance(pos, restruct.render.options.scale)\n\n    if (dist.minDist < 0.3 && (!ret || dist.minDist < minDist)) {\n      minDist = dist.minDist\n      refPoint = dist.refPoint\n\n      ret = { id, dist: minDist, ref: refPoint }\n    }\n  })\n  return ret\n}\n\nfunction findClosestRxnPlus(restruct, pos) {\n  let minDist = null\n  let ret = null\n\n  restruct.rxnPluses.forEach((plus, id) => {\n    const p = plus.item.pp\n    const dist = Math.max(Math.abs(pos.x - p.x), Math.abs(pos.y - p.y))\n\n    if (dist < 0.3 && (!ret || dist < minDist)) {\n      minDist = dist\n      ret = { id, dist: minDist }\n    }\n  })\n\n  return ret\n}\n\nfunction findClosestSGroup(restruct, pos) {\n  let ret = null\n  let minDist = SELECTION_DISTANCE_COEFFICIENT\n\n  restruct.molecule.sgroups.forEach((sg, sgid) => {\n    if (sg.functionalGroup && !sg.expanded) {\n      const firstAtomPp = sg.firstSgroupAtom.pp\n      const d = sg.bracketDir\n      const n = d.rotateSC(1, 0)\n      const pg = new Vec2(Vec2.dot(pos, d), Vec2.dot(pos, n))\n      const shift = new Vec2(0.625, 0.625)\n      const box = {\n        p0: Vec2.diff(firstAtomPp, shift),\n        p1: Vec2.sum(firstAtomPp, shift)\n      }\n\n      const inBox =\n        box.p0.y < pg.y && box.p1.y > pg.y && box.p0.x < pg.x && box.p1.x > pg.x\n      const xDist = Math.min(\n        Math.abs(box.p0.x - pg.x),\n        Math.abs(box.p1.x - pg.x)\n      )\n\n      if (inBox && (ret === null || xDist < minDist)) {\n        ret = sgid\n        minDist = xDist\n      }\n    } else {\n      const d = sg.bracketDir\n      const n = d.rotateSC(1, 0)\n      const pg = new Vec2(Vec2.dot(pos, d), Vec2.dot(pos, n))\n\n      sg.areas.forEach(box => {\n        const inBox =\n          box.p0.y < pg.y &&\n          box.p1.y > pg.y &&\n          box.p0.x < pg.x &&\n          box.p1.x > pg.x\n        const xDist = Math.min(\n          Math.abs(box.p0.x - pg.x),\n          Math.abs(box.p1.x - pg.x)\n        )\n\n        if (inBox && (ret === null || xDist < minDist)) {\n          ret = sgid\n          minDist = xDist\n        }\n      })\n    }\n  })\n\n  if (ret !== null) {\n    return {\n      id: ret,\n      dist: minDist\n    }\n  }\n\n  return null\n}\n\nfunction findClosestItem(restruct, pos, maps, skip, scale) {\n  // eslint-disable-line max-params\n  maps = maps || Object.keys(findMaps)\n\n  return maps.reduce((res, mp) => {\n    const minDist = res ? res.dist : null\n    const item = findMaps[mp](restruct, pos, skip, minDist, scale)\n\n    if (item !== null && (res === null || item.dist < res.dist)) {\n      const { id, dist, ...other } = item\n      return {\n        map: mp,\n        id: id,\n        dist: dist,\n        ...other\n      }\n    }\n\n    return res\n  }, null)\n}\n\n/**\n * @param restruct { ReStruct }\n * @param selected { object }\n * @param maps { Array<string> }\n * @param scale { number }\n * @return {{\n * \t\tatoms: Map<number, number>?\n * \t\tbonds: Map<number, number>?\n * }}\n */\nfunction findCloseMerge(restruct, selected, maps = ['atoms', 'bonds'], scale) {\n  const pos = {\n    atoms: new Map(), // aid -> position\n    bonds: new Map() // bid -> position\n  }\n\n  const struct = restruct.molecule\n\n  selected.atoms.forEach(aid => {\n    pos.atoms.set(aid, struct.atoms.get(aid).pp)\n  })\n\n  selected.bonds.forEach(bid => {\n    const bond = struct.bonds.get(bid)\n    pos.bonds.set(\n      bid,\n      Vec2.lc2(\n        struct.atoms.get(bond.begin).pp,\n        0.5,\n        struct.atoms.get(bond.end).pp,\n        0.5\n      )\n    )\n  })\n\n  const result = {}\n  maps.forEach(mp => {\n    result[mp] = Array.from(pos[mp].keys()).reduce((res, srcId) => {\n      const skip = { map: mp, id: srcId }\n      const item = findMaps[mp](restruct, pos[mp].get(srcId), skip, null, scale)\n\n      if (item && !selected[mp].includes(item.id)) res.set(srcId, item.id)\n\n      return res\n    }, new Map())\n  })\n\n  return result\n}\n\nexport default {\n  atom: findClosestAtom, // used in Actions\n  item: findClosestItem,\n  merge: findCloseMerge\n}\n","/****************************************************************************\n * Copyright 2021 EPAM Systems\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *    http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n ***************************************************************************/\n\nimport { Bond, Vec2 } from 'domain/entities'\n\nimport closest from '../shared/closest'\nimport { difference } from 'lodash'\n\nexport function atomGetAttr(restruct, aid, name) {\n  return restruct.molecule.atoms.get(aid)[name]\n}\n\nexport function atomGetDegree(restruct, aid) {\n  return restruct.atoms.get(aid).a.neighbors.length\n}\n\nexport function atomGetSGroups(restruct, aid) {\n  return Array.from(restruct.atoms.get(aid).a.sgs)\n}\n\nexport function atomGetPos(restruct, id) {\n  return restruct.molecule.atoms.get(id).pp\n}\n\nexport function findStereoAtoms(struct, aids) {\n  return aids.filter(aid => struct.atoms.get(aid).stereoLabel !== null)\n}\n\nexport function structSelection(struct) {\n  return [\n    'atoms',\n    'bonds',\n    'frags',\n    'sgroups',\n    'rgroups',\n    'rxnArrows',\n    'rxnPluses',\n    'simpleObjects',\n    'texts'\n  ].reduce((res, key) => {\n    res[key] = Array.from(struct[key].keys())\n    return res\n  }, {})\n}\n\n// Get new atom id/label and pos for bond being added to existing atom\nexport function atomForNewBond(restruct, id, bond?) {\n  // eslint-disable-line max-statements\n  const neighbours: Array<any> = []\n  const pos = atomGetPos(restruct, id)\n  const prevBondId = restruct.molecule.findBondId(\n    id,\n    restruct.molecule.atomGetNeighbors(id)[0].aid\n  )\n  const prevBondType = restruct.molecule.bonds.get(prevBondId).type\n\n  restruct.molecule.atomGetNeighbors(id).forEach(nei => {\n    const neiPos = atomGetPos(restruct, nei.aid)\n\n    if (Vec2.dist(pos, neiPos) < 0.1) return\n\n    neighbours.push({ id: nei.aid, v: Vec2.diff(neiPos, pos) })\n  })\n\n  neighbours.sort(\n    (nei1, nei2) =>\n      Math.atan2(nei1.v.y, nei1.v.x) - Math.atan2(nei2.v.y, nei2.v.x)\n  )\n\n  var i\n  var maxI = 0\n  var angle\n  var maxAngle = 0\n\n  // TODO: impove layout: tree, ...\n\n  for (i = 0; i < neighbours.length; i++) {\n    angle = Vec2.angle(\n      neighbours[i].v,\n      neighbours[(i + 1) % neighbours.length].v\n    )\n\n    if (angle < 0) angle += 2 * Math.PI\n\n    if (angle > maxAngle) {\n      maxI = i\n      maxAngle = angle\n    }\n  }\n\n  let v = new Vec2(1, 0)\n\n  if (neighbours.length > 0) {\n    if (neighbours.length === 1) {\n      maxAngle = -((4 * Math.PI) / 3)\n\n      // zig-zag\n      const nei = restruct.molecule.atomGetNeighbors(id)[0]\n      if (atomGetDegree(restruct, nei.aid) > 1) {\n        const neiNeighbours: Array<any> = []\n        const neiPos = atomGetPos(restruct, nei.aid)\n        const neiV = Vec2.diff(pos, neiPos)\n        const neiAngle = Math.atan2(neiV.y, neiV.x)\n\n        restruct.molecule.atomGetNeighbors(nei.aid).forEach(neiNei => {\n          const neiNeiPos = atomGetPos(restruct, neiNei.aid)\n\n          if (neiNei.bid === nei.bid || Vec2.dist(neiPos, neiNeiPos) < 0.1)\n            return\n\n          const vDiff = Vec2.diff(neiNeiPos, neiPos)\n          let ang = Math.atan2(vDiff.y, vDiff.x) - neiAngle\n\n          if (ang < 0) ang += 2 * Math.PI\n\n          neiNeighbours.push(ang)\n        })\n        neiNeighbours.sort((nei1, nei2) => nei1 - nei2)\n\n        if (\n          neiNeighbours[0] <= Math.PI * 1.01 &&\n          neiNeighbours[neiNeighbours.length - 1] <= 1.01 * Math.PI\n        )\n          maxAngle *= -1\n      }\n    }\n\n    const shallBe180DegToPrevBond =\n      (neighbours.length === 1 &&\n        prevBondType === bond?.type &&\n        (bond?.type === Bond.PATTERN.TYPE.DOUBLE ||\n          bond?.type === Bond.PATTERN.TYPE.TRIPLE)) ||\n      (prevBondType === Bond.PATTERN.TYPE.SINGLE &&\n        bond?.type === Bond.PATTERN.TYPE.TRIPLE) ||\n      (prevBondType === Bond.PATTERN.TYPE.TRIPLE &&\n        bond?.type === Bond.PATTERN.TYPE.SINGLE)\n\n    if (shallBe180DegToPrevBond) {\n      const prevBondAngle = restruct.molecule.bonds.get(prevBondId).angle\n      if (prevBondAngle > -90 && prevBondAngle < 90 && neighbours[0].v.x > 0) {\n        angle = (prevBondAngle * Math.PI) / 180 + Math.PI\n      } else {\n        angle = (prevBondAngle * Math.PI) / 180\n      }\n    } else {\n      angle =\n        maxAngle / 2 + Math.atan2(neighbours[maxI].v.y, neighbours[maxI].v.x)\n    }\n\n    v = v.rotate(angle)\n  }\n\n  v.add_(pos) // eslint-disable-line no-underscore-dangle\n\n  let a: any = closest.atom(restruct, v, null, 0.1)\n  a = a === null ? { label: 'C' } : a.id\n\n  return { atom: a, pos: v }\n}\n\nexport function getRelSgroupsBySelection(restruct, selectedAtoms) {\n  return restruct.molecule.sgroups.filter(\n    (_sgid, sg) =>\n      !sg.data.attached &&\n      !sg.data.absolute &&\n      difference(sg.atoms, selectedAtoms).length === 0\n  )\n}\n","/****************************************************************************\n * Copyright 2021 EPAM Systems\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *    http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n ***************************************************************************/\n\nimport { RGroupAttr, RGroupFragment, UpdateIfThen } from '../operations'\n\nimport { Action } from './action'\n\nexport function fromRGroupAttrs(restruct, id, attrs) {\n  const action = new Action()\n\n  Object.keys(attrs).forEach(key => {\n    action.addOp(new RGroupAttr(id, key, attrs[key]))\n  })\n\n  return action.perform(restruct)\n}\n\nexport function fromRGroupFragment(restruct, rgidNew, frid) {\n  const action = new Action()\n  action.addOp(new RGroupFragment(rgidNew, frid))\n\n  return action.perform(restruct)\n}\n\nexport function fromUpdateIfThen(\n  restruct,\n  rgidNew,\n  rgidOld,\n  skipRgids: Array<number> = []\n) {\n  const action = new Action()\n  if (!restruct.molecule.rgroups.get(rgidOld))\n    action.addOp(new UpdateIfThen(rgidNew, rgidOld, skipRgids))\n\n  return action.perform(restruct)\n}\n","/****************************************************************************\n * Copyright 2021 EPAM Systems\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *    http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n ***************************************************************************/\n\nimport {\n  AtomAttr,\n  SGroupAddToHierarchy,\n  SGroupAtomAdd,\n  SGroupAtomRemove,\n  SGroupAttr,\n  SGroupCreate,\n  SGroupDelete,\n  SGroupRemoveFromHierarchy\n} from '../operations'\nimport { Pile, SGroup } from 'domain/entities'\nimport { atomGetAttr, atomGetDegree, atomGetSGroups } from './utils'\n\nimport { Action } from './action'\nimport { SgContexts } from '..'\nimport { uniq } from 'lodash/fp'\nimport { fromAtomsAttrs } from './atom'\n\nexport function fromSeveralSgroupAddition(restruct, type, atoms, attrs) {\n  const descriptors = attrs.fieldValue\n\n  if (typeof descriptors === 'string' || type !== 'DAT')\n    return fromSgroupAddition(\n      restruct,\n      type,\n      atoms,\n      attrs,\n      restruct.molecule.sgroups.newId()\n    )\n\n  return descriptors.reduce((acc, fValue) => {\n    const localAttrs = Object.assign({}, attrs)\n    localAttrs.fieldValue = fValue\n\n    return acc.mergeWith(\n      fromSgroupAddition(\n        restruct,\n        type,\n        atoms,\n        localAttrs,\n        restruct.molecule.sgroups.newId()\n      )\n    )\n  }, new Action())\n}\n\nexport function fromSgroupAttrs(restruct, id, attrs) {\n  const action = new Action()\n\n  Object.keys(attrs).forEach(key => {\n    action.addOp(new SGroupAttr(id, key, attrs[key]))\n  })\n\n  return action.perform(restruct)\n}\n\nexport function setExpandSGroup(restruct, sgid, attrs) {\n  const action = new Action()\n\n  Object.keys(attrs).forEach(key => {\n    action.addOp(new SGroupAttr(sgid, key, attrs[key]))\n  })\n\n  const sgroup = restruct.molecule.sgroups.get(sgid)\n  if (sgroup.firstSgroupAtom) delete sgroup.firstSgroupAtom\n  const atoms = SGroup.getAtoms(restruct, sgroup)\n\n  atoms.forEach(aid => {\n    action.mergeWith(\n      fromAtomsAttrs(restruct, aid, restruct.atoms.get(aid).a, false)\n    )\n  })\n\n  return action.perform(restruct)\n}\n\nexport function sGroupAttributeAction(id, attrs) {\n  const action = new Action()\n\n  Object.keys(attrs).forEach(key => {\n    action.addOp(new SGroupAttr(id, key, attrs[key]))\n  })\n\n  return action\n}\n\nexport function fromSgroupDeletion(restruct, id) {\n  let action = new Action()\n  const struct = restruct.molecule\n\n  const sG = restruct.sgroups.get(id).item\n\n  if (sG.type === 'SRU') {\n    struct.sGroupsRecalcCrossBonds()\n\n    sG.neiAtoms.forEach(aid => {\n      if (atomGetAttr(restruct, aid, 'label') === '*')\n        action.addOp(new AtomAttr(aid, 'label', 'C'))\n    })\n  }\n\n  const sg = struct.sgroups.get(id)\n  const atoms = SGroup.getAtoms(struct, sg)\n  const attrs = sg.getAttrs()\n\n  action.addOp(new SGroupRemoveFromHierarchy(id))\n\n  atoms.forEach(atom => {\n    action.addOp(new SGroupAtomRemove(id, atom))\n  })\n\n  action.addOp(new SGroupDelete(id))\n\n  action = action.perform(restruct)\n\n  action.mergeWith(sGroupAttributeAction(id, attrs))\n\n  return action\n}\n\nexport function fromSgroupAddition(\n  restruct,\n  type,\n  atoms,\n  attrs,\n  sgid,\n  pp?,\n  expanded?,\n  name?\n) {\n  // eslint-disable-line\n  let action = new Action()\n\n  // TODO: shoud the id be generated when OpSGroupCreate is executed?\n  //      if yes, how to pass it to the following operations?\n  sgid = sgid - 0 === sgid ? sgid : restruct.molecule.sgroups.newId()\n\n  if (type === 'SUP') {\n    action.addOp(new SGroupCreate(sgid, type, pp, expanded, name))\n  } else {\n    action.addOp(new SGroupCreate(sgid, type, pp))\n  }\n\n  atoms.forEach(atom => {\n    action.addOp(new SGroupAtomAdd(sgid, atom))\n  })\n\n  action.addOp(\n    type !== 'DAT'\n      ? new SGroupAddToHierarchy(sgid)\n      : new SGroupAddToHierarchy(sgid, -1, [])\n  )\n\n  action = action.perform(restruct)\n\n  if (type === 'SRU') {\n    restruct.molecule.sGroupsRecalcCrossBonds()\n    let asteriskAction = new Action()\n\n    restruct.sgroups.get(sgid).item.neiAtoms.forEach(aid => {\n      const plainCarbon = restruct.atoms.get(aid).a.isPlainCarbon()\n\n      if (atomGetDegree(restruct, aid) === 1 && plainCarbon)\n        asteriskAction.addOp(new AtomAttr(aid, 'label', '*'))\n    })\n\n    asteriskAction = asteriskAction.perform(restruct)\n    asteriskAction.mergeWith(action)\n    action = asteriskAction\n  }\n\n  return fromSgroupAttrs(restruct, sgid, attrs).mergeWith(action)\n}\n\nexport function fromSgroupAction(\n  context,\n  restruct,\n  newSg,\n  sourceAtoms,\n  selection\n) {\n  if (context === SgContexts.Bond)\n    return fromBondAction(restruct, newSg, sourceAtoms, selection)\n\n  const atomsFromBonds = getAtomsFromBonds(restruct.molecule, selection.bonds)\n  const newSourceAtoms = uniq(sourceAtoms.concat(atomsFromBonds))\n\n  if (context === SgContexts.Fragment)\n    return fromGroupAction(\n      restruct,\n      newSg,\n      newSourceAtoms,\n      Array.from(restruct.atoms.keys())\n    )\n\n  if (context === SgContexts.Multifragment)\n    return fromMultiFragmentAction(restruct, newSg, newSourceAtoms)\n\n  if (context === SgContexts.Group)\n    return fromGroupAction(restruct, newSg, newSourceAtoms, newSourceAtoms)\n\n  if (context === SgContexts.Atom)\n    return fromAtomAction(restruct, newSg, newSourceAtoms)\n\n  return {\n    action: fromSeveralSgroupAddition(\n      restruct,\n      newSg.type,\n      sourceAtoms,\n      newSg.attrs\n    )\n  }\n}\n\nfunction fromAtomAction(restruct, newSg, sourceAtoms) {\n  return sourceAtoms.reduce(\n    (acc, atom) => {\n      acc.action = acc.action.mergeWith(\n        fromSeveralSgroupAddition(restruct, newSg.type, [atom], newSg.attrs)\n      )\n      return acc\n    },\n    {\n      action: new Action(),\n      selection: {\n        atoms: sourceAtoms,\n        bonds: []\n      }\n    }\n  )\n}\n\nfunction fromGroupAction(restruct, newSg, sourceAtoms, targetAtoms) {\n  const allFragments = new Pile(\n    sourceAtoms.map(aid => restruct.atoms.get(aid).a.fragment)\n  )\n\n  return Array.from(allFragments).reduce(\n    (acc, fragId) => {\n      const atoms = targetAtoms.reduce((res, aid) => {\n        const atom = restruct.atoms.get(aid).a\n        if (fragId === atom.fragment) res.push(aid)\n\n        return res\n      }, [])\n\n      const bonds = getAtomsBondIds(restruct.molecule, atoms)\n\n      acc.action = acc.action.mergeWith(\n        fromSeveralSgroupAddition(restruct, newSg.type, atoms, newSg.attrs)\n      )\n\n      acc.selection.atoms = acc.selection.atoms.concat(atoms)\n      acc.selection.bonds = acc.selection.bonds.concat(bonds)\n\n      return acc\n    },\n    {\n      action: new Action(),\n      selection: {\n        atoms: [],\n        bonds: []\n      }\n    }\n  )\n}\n\nfunction fromBondAction(restruct, newSg, sourceAtoms, currSelection) {\n  const struct = restruct.molecule\n  let bonds = getAtomsBondIds(struct, sourceAtoms)\n\n  if (currSelection.bonds) bonds = uniq(bonds.concat(currSelection.bonds))\n\n  return bonds.reduce(\n    (acc: any, bondid) => {\n      const bond = struct.bonds.get(bondid)\n\n      acc.action = acc.action.mergeWith(\n        fromSeveralSgroupAddition(\n          restruct,\n          newSg.type,\n          [bond.begin, bond.end],\n          newSg.attrs\n        )\n      )\n\n      acc.selection.bonds.push(bondid)\n\n      return acc\n    },\n    {\n      action: new Action(),\n      selection: {\n        atoms: sourceAtoms,\n        bonds: []\n      }\n    }\n  )\n}\n\nfunction fromMultiFragmentAction(restruct, newSg, atoms) {\n  const bonds = getAtomsBondIds(restruct.molecule, atoms)\n  return {\n    action: fromSeveralSgroupAddition(restruct, newSg.type, atoms, newSg.attrs),\n    selection: {\n      atoms,\n      bonds\n    }\n  }\n}\n\n// Add action operation to remove atom from s-group if needed\nexport function removeAtomFromSgroupIfNeeded(action, restruct, id) {\n  const sgroups = atomGetSGroups(restruct, id)\n\n  if (sgroups.length > 0) {\n    sgroups.forEach(sid => {\n      action.addOp(new SGroupAtomRemove(sid, id))\n    })\n\n    return true\n  }\n\n  return false\n}\n\n// Add action operations to remove whole s-group if needed\nexport function removeSgroupIfNeeded(action, restruct, atoms) {\n  const struct = restruct.molecule\n  const sgCounts = new Map()\n\n  atoms.forEach(id => {\n    const sgroups = atomGetSGroups(restruct, id)\n\n    sgroups.forEach(sid => {\n      sgCounts.set(sid, sgCounts.has(sid) ? sgCounts.get(sid) + 1 : 1)\n    })\n  })\n\n  sgCounts.forEach((count, sid) => {\n    const sG = restruct.sgroups.get(sid).item\n    const sgAtoms = SGroup.getAtoms(restruct.molecule, sG)\n\n    if (sgAtoms.length === count) {\n      // delete whole s-group\n      const sgroup = struct.sgroups.get(sid)\n      action.mergeWith(sGroupAttributeAction(sid, sgroup.getAttrs()))\n      action.addOp(new SGroupRemoveFromHierarchy(sid))\n      action.addOp(new SGroupDelete(sid))\n    }\n  })\n}\n\nfunction getAtomsBondIds(struct, atoms) {\n  const atomSet = new Pile(atoms)\n\n  return Array.from(struct.bonds.keys()).filter(bid => {\n    const bond = struct.bonds.get(bid)\n    return atomSet.has(bond.begin) && atomSet.has(bond.end)\n  })\n}\n\nfunction getAtomsFromBonds(struct, bonds) {\n  bonds = bonds || []\n  return bonds.reduce((acc, bondid) => {\n    const bond = struct.bonds.get(bondid)\n    acc = acc.concat([bond.begin, bond.end])\n    return acc\n  }, [])\n}\n","/****************************************************************************\n * Copyright 2021 EPAM Systems\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *    http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n ***************************************************************************/\n\nimport {\n  Atom,\n  Bond,\n  Neighbor,\n  StereoLabel,\n  Struct,\n  Vec2\n} from 'domain/entities'\nimport {\n  AtomAdd,\n  AtomAttr,\n  BondAdd,\n  BondAttr,\n  BondDelete,\n  CalcImplicitH,\n  FragmentAdd,\n  FragmentStereoFlag\n} from '../operations'\nimport { atomForNewBond, atomGetAttr } from './utils'\nimport {\n  fromAtomMerge,\n  fromStereoAtomAttrs,\n  mergeFragmentsIfNeeded,\n  mergeSgroups\n} from './atom'\n\nimport { Action } from './action'\nimport { ReStruct } from '../../render'\nimport { StereoValidator } from 'domain/helpers'\nimport utils from '../shared/utils'\n\nexport function fromBondAddition(\n  restruct: ReStruct,\n  bond: any,\n  begin: any,\n  end: any,\n  pos?: Vec2,\n  pos2?: Vec2\n): [Action, number, number, number] {\n  // eslint-disable-line\n  if (end === undefined) {\n    const atom = atomForNewBond(restruct, begin, bond)\n    end = atom.atom\n    pos = atom.pos\n  }\n  const action = new Action()\n  const struct = restruct.molecule\n  let mergeFragments = false\n\n  let frid = null\n\n  if (!(typeof begin === 'number')) {\n    if (typeof end === 'number') frid = atomGetAttr(restruct, end, 'fragment')\n  } else {\n    frid = atomGetAttr(restruct, begin, 'fragment')\n    if (typeof end === 'number') mergeFragments = true\n  }\n\n  if (frid == null)\n    frid = (action.addOp(new FragmentAdd().perform(restruct)) as FragmentAdd)\n      .frid\n\n  if (!(typeof begin === 'number')) {\n    begin.fragment = frid\n    begin = (action.addOp(new AtomAdd(begin, pos).perform(restruct)) as AtomAdd)\n      .data.aid\n    if (typeof end === 'number') mergeSgroups(action, restruct, [begin], end)\n    pos = pos2\n  } else if (atomGetAttr(restruct, begin, 'label') === '*') {\n    action.addOp(new AtomAttr(begin, 'label', 'C').perform(restruct))\n  }\n\n  if (!(typeof end === 'number')) {\n    end.fragment = frid\n    // TODO: <op>.data.aid here is a hack, need a better way to access the id of a created atom\n    end = (action.addOp(new AtomAdd(end, pos).perform(restruct)) as AtomAdd)\n      .data.aid\n    if (typeof begin === 'number') mergeSgroups(action, restruct, [end], begin)\n  } else if (atomGetAttr(restruct, end, 'label') === '*') {\n    action.addOp(new AtomAttr(end, 'label', 'C').perform(restruct))\n  }\n\n  const bid = (\n    action.addOp(new BondAdd(begin, end, bond).perform(restruct)) as BondAdd\n  ).data.bid\n\n  const bnd = struct.bonds.get(bid)\n\n  if (bnd) {\n    action.addOp(new CalcImplicitH([bnd.begin, bnd.end]).perform(restruct))\n    action.mergeWith(fromBondStereoUpdate(restruct, bnd))\n  }\n\n  action.operations.reverse()\n\n  if (mergeFragments) mergeFragmentsIfNeeded(action, restruct, begin, end)\n\n  if (struct.frags.get(frid || 0)?.stereoAtoms && !bond.stereo) {\n    action.addOp(new FragmentStereoFlag(frid || 0).perform(restruct))\n  }\n\n  return [action, begin, end, bid]\n}\n\nexport function fromBondsAttrs(\n  restruct: ReStruct,\n  ids: Array<number> | number,\n  attrs: Bond,\n  reset?: boolean\n): Action {\n  const struct = restruct.molecule\n  const action = new Action()\n  const bids = Array.isArray(ids) ? ids : [ids]\n\n  bids.forEach(bid => {\n    Object.keys(Bond.attrlist).forEach(key => {\n      if (!(key in attrs) && !reset) return\n\n      const value = key in attrs ? attrs[key] : Bond.attrGetDefault(key)\n\n      action.addOp(new BondAttr(bid, key, value).perform(restruct))\n      if (key === 'stereo' && key in attrs) {\n        const bond = struct.bonds.get(bid)\n        if (bond) {\n          action.addOp(\n            new CalcImplicitH([bond.begin, bond.end]).perform(restruct)\n          )\n          action.mergeWith(fromBondStereoUpdate(restruct, bond))\n        }\n      }\n    })\n  })\n\n  return action\n}\n\nexport function fromBondsMerge(\n  restruct: ReStruct,\n  mergeMap: Map<number, number>\n): Action {\n  const struct = restruct.molecule\n\n  const atomPairs = new Map()\n  let action = new Action()\n\n  mergeMap.forEach((dstId, srcId) => {\n    const bond = struct.bonds.get(srcId)\n    const bondCI = struct.bonds.get(dstId)\n    if (!bond || !bondCI) return\n    const params = utils.mergeBondsParams(struct, bond, struct, bondCI)\n    if (!params.merged) return\n    atomPairs.set(bond.begin, !params.cross ? bondCI.begin : bondCI.end)\n    atomPairs.set(bond.end, !params.cross ? bondCI.end : bondCI.begin)\n  })\n\n  atomPairs.forEach((dst, src) => {\n    action = fromAtomMerge(restruct, src, dst).mergeWith(action)\n  })\n\n  return action\n}\n\nfunction fromBondFlipping(restruct: ReStruct, id: number): Action {\n  const bond = restruct.molecule.bonds.get(id)\n\n  const action = new Action()\n  action.addOp(new BondDelete(id).perform(restruct))\n\n  // TODO: find better way to avoid problem with bond.begin = 0\n  if (Number.isInteger(bond?.end) && Number.isInteger(bond?.begin)) {\n    action.addOp(new BondAdd(bond?.end, bond?.begin, bond).perform(restruct))\n  }\n\n  // todo: swap atoms stereoLabels and stereoAtoms in fragment\n\n  return action\n}\n\nexport function fromBondStereoUpdate(\n  restruct: ReStruct,\n  bond: Bond,\n  withReverse?: boolean\n): Action {\n  const action = new Action()\n  const struct = restruct.molecule\n\n  const beginFrId = struct.atoms.get(bond?.begin)?.fragment\n  const endFrId = struct.atoms.get(bond?.end)?.fragment\n\n  const fragmentStereoBonds: Array<Bond> = []\n\n  struct.bonds.forEach(bond => {\n    if (struct.atoms.get(bond.begin)?.fragment === beginFrId) {\n      fragmentStereoBonds.push(bond)\n    }\n\n    if (\n      beginFrId !== endFrId &&\n      struct.atoms.get(bond.begin)?.fragment === endFrId\n    ) {\n      fragmentStereoBonds.push(bond)\n    }\n  })\n\n  const stereoAtomsMap = getStereoAtomsMap(struct, fragmentStereoBonds, bond)\n\n  stereoAtomsMap.forEach((stereoProp, aId) => {\n    if (struct.atoms.get(aId)?.stereoLabel !== stereoProp.stereoLabel) {\n      action.mergeWith(\n        fromStereoAtomAttrs(restruct, aId, stereoProp, withReverse)\n      )\n    }\n  })\n\n  return action\n}\n\nexport function getStereoAtomsMap(\n  struct: Struct,\n  bonds: Array<Bond>,\n  bond?: Bond\n) {\n  const stereoAtomsMap = new Map()\n  const correctAtomIds: Array<number> = []\n\n  bonds.forEach((bond: Bond | undefined) => {\n    if (bond) {\n      const beginNeighs: Array<Neighbor> | undefined = struct.atomGetNeighbors(\n        bond.begin\n      )\n      const endNeighs: Array<Neighbor> | undefined = struct.atomGetNeighbors(\n        bond.end\n      )\n\n      if (\n        StereoValidator.isCorrectStereoCenter(\n          bond,\n          beginNeighs,\n          endNeighs,\n          struct\n        )\n      ) {\n        const stereoLabel = struct.atoms.get(bond.begin)?.stereoLabel\n        if (\n          stereoLabel == null ||\n          stereoAtomsMap.get(bond.begin)?.stereoLabel == null\n        ) {\n          stereoAtomsMap.set(bond.begin, {\n            stereoParity: getStereoParity(bond.stereo),\n            stereoLabel: stereoLabel || `${StereoLabel.Abs}`\n          })\n        }\n        correctAtomIds.push(bond.begin)\n      } else {\n        if (!correctAtomIds.includes(bond.begin)) {\n          stereoAtomsMap.set(bond.begin, {\n            stereoParity: Atom.PATTERN.STEREO_PARITY.NONE,\n            stereoLabel: null\n          })\n        }\n        if (!correctAtomIds.includes(bond.end)) {\n          stereoAtomsMap.set(bond.end, {\n            stereoParity: Atom.PATTERN.STEREO_PARITY.NONE,\n            stereoLabel: null\n          })\n        }\n      }\n    }\n  })\n\n  // in case the stereo band is flipped, changed or removed\n  // TODO the duplication of the code below should be fixed, mayby by function\n  if (bond) {\n    if (!correctAtomIds.includes(bond.begin)) {\n      stereoAtomsMap.set(bond.begin, {\n        stereoParity: Atom.PATTERN.STEREO_PARITY.NONE,\n        stereoLabel: null\n      })\n    }\n    if (!correctAtomIds.includes(bond.end)) {\n      stereoAtomsMap.set(bond.end, {\n        stereoParity: Atom.PATTERN.STEREO_PARITY.NONE,\n        stereoLabel: null\n      })\n    }\n  }\n\n  return stereoAtomsMap\n}\n\nfunction getStereoParity(stereo: Number): number | null {\n  let newAtomParity: number | null = null\n  switch (stereo) {\n    case Bond.PATTERN.STEREO.UP:\n      newAtomParity = Atom.PATTERN.STEREO_PARITY.ODD\n      break\n    case Bond.PATTERN.STEREO.EITHER:\n      newAtomParity = Atom.PATTERN.STEREO_PARITY.EITHER\n      break\n    case Bond.PATTERN.STEREO.DOWN:\n      newAtomParity = Atom.PATTERN.STEREO_PARITY.EVEN\n      break\n  }\n  return newAtomParity\n}\n\nexport function bondChangingAction(\n  restruct: ReStruct,\n  itemID: number,\n  bond: Bond,\n  bondProps: any\n): Action {\n  const action = new Action()\n  let newItemId = itemID\n  if (\n    ((bondProps.stereo !== Bond.PATTERN.STEREO.NONE && //\n      bondProps.type === Bond.PATTERN.TYPE.SINGLE) ||\n      bond.type === Bond.PATTERN.TYPE.DATIVE) &&\n    bond.type === bondProps.type &&\n    bond.stereo === bondProps.stereo\n  ) {\n    action.mergeWith(fromBondFlipping(restruct, itemID))\n    newItemId = (action.operations[1] as BondAdd).data.bid\n  }\n  // if bondTool is stereo and equal to bond for change\n\n  const loop = plainBondTypes.includes(bondProps.type) ? plainBondTypes : null\n  if (\n    bondProps.stereo === Bond.PATTERN.STEREO.NONE &&\n    bondProps.type === Bond.PATTERN.TYPE.SINGLE &&\n    bond.stereo === Bond.PATTERN.STEREO.NONE &&\n    loop\n  )\n    // if `Single bond` tool is chosen and bond for change in `plainBondTypes`\n    bondProps.type = loop[(loop.indexOf(bond.type) + 1) % loop.length]\n\n  return fromBondsAttrs(restruct, newItemId, bondProps).mergeWith(action)\n}\n\nconst plainBondTypes = [\n  Bond.PATTERN.TYPE.SINGLE,\n  Bond.PATTERN.TYPE.DOUBLE,\n  Bond.PATTERN.TYPE.TRIPLE\n]\n","/****************************************************************************\n * Copyright 2021 EPAM Systems\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *    http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n ***************************************************************************/\n\nimport { Atom, Bond, RGroup } from 'domain/entities'\nimport {\n  AtomAdd,\n  AtomAttr,\n  AtomDelete,\n  BondAdd,\n  BondAttr,\n  BondDelete,\n  CalcImplicitH,\n  FragmentAdd,\n  FragmentAddStereoAtom,\n  FragmentDelete,\n  FragmentDeleteStereoAtom,\n  SGroupAtomAdd\n} from '../operations'\nimport { atomGetAttr, atomGetDegree, atomGetSGroups } from './utils'\nimport { fromRGroupFragment, fromUpdateIfThen } from './rgroup'\nimport { removeAtomFromSgroupIfNeeded, removeSgroupIfNeeded } from './sgroup'\n\nimport { Action } from './action'\nimport { fromBondStereoUpdate } from './bond'\nimport { without } from 'lodash/fp'\n\nexport function fromAtomAddition(restruct, pos, atom) {\n  atom = Object.assign({}, atom)\n  const action = new Action()\n  atom.fragment = (\n    action.addOp(new FragmentAdd().perform(restruct)) as FragmentAdd\n  ).frid\n\n  const aid = (\n    action.addOp(new AtomAdd(atom, pos).perform(restruct)) as AtomAdd\n  ).data.aid\n  action.addOp(new CalcImplicitH([aid]).perform(restruct))\n\n  return action\n}\n\n/**\n * @param restruct { ReStruct }\n * @param ids { Array<number>|number }\n * @param attrs { object }\n * @param reset { boolean? }\n */\nexport function fromAtomsAttrs(restruct, ids, attrs, reset) {\n  const action = new Action()\n  const aids = Array.isArray(ids) ? ids : [ids]\n\n  aids.forEach(aid => {\n    Object.keys(Atom.attrlist).forEach(key => {\n      if (key === 'attpnt' && !(key in attrs)) return\n      if (!(key in attrs) && !reset) return\n\n      const value = key in attrs ? attrs[key] : Atom.attrGetDefault(key)\n\n      switch (key) {\n        case 'stereoLabel':\n          if (key in attrs && value)\n            action.addOp(new AtomAttr(aid, key, value).perform(restruct))\n          break\n        case 'stereoParity':\n          if (key in attrs && value)\n            action.addOp(new AtomAttr(aid, key, value).perform(restruct))\n          break\n        default:\n          action.addOp(new AtomAttr(aid, key, value).perform(restruct))\n          break\n      }\n    })\n\n    if (\n      !reset &&\n      'label' in attrs &&\n      attrs.label !== null &&\n      attrs.label !== 'L#' &&\n      !attrs['atomList']\n    )\n      action.addOp(new AtomAttr(aid, 'atomList', null).perform(restruct))\n\n    action.addOp(new CalcImplicitH([aid]).perform(restruct))\n\n    const atomNeighbors = restruct.molecule.atomGetNeighbors(aid)\n    const bond = restruct.molecule.bonds.get(atomNeighbors[0]?.bid)\n    if (bond) {\n      action.mergeWith(fromBondStereoUpdate(restruct, bond))\n    }\n  })\n\n  return action\n}\n\nexport function fromStereoAtomAttrs(restruct, aid, attrs, withReverse) {\n  const action = new Action()\n  const atom = restruct.molecule.atoms.get(aid)\n  if (atom) {\n    const frid = atom.fragment\n\n    if ('stereoParity' in attrs)\n      action.addOp(\n        new AtomAttr(aid, 'stereoParity', attrs['stereoParity']).perform(\n          restruct\n        )\n      )\n    if ('stereoLabel' in attrs) {\n      action.addOp(\n        new AtomAttr(aid, 'stereoLabel', attrs['stereoLabel']).perform(restruct)\n      )\n      if (attrs['stereoLabel'] === null) {\n        action.addOp(new FragmentDeleteStereoAtom(frid, aid).perform(restruct))\n      } else {\n        action.addOp(new FragmentAddStereoAtom(frid, aid).perform(restruct))\n      }\n    }\n    if (withReverse) action.operations.reverse()\n  }\n\n  return action\n}\n\nexport function fromAtomsFragmentAttr(restruct, aids, newfrid) {\n  const action = new Action()\n\n  aids.forEach(aid => {\n    const atom = restruct.molecule.atoms.get(aid)\n    const oldfrid = atom.fragment\n    action.addOp(new AtomAttr(aid, 'fragment', newfrid))\n\n    if (atom.stereoLabel !== null) {\n      action.addOp(new FragmentAddStereoAtom(newfrid, aid))\n      action.addOp(new FragmentDeleteStereoAtom(oldfrid, aid))\n    }\n  })\n\n  return action.perform(restruct)\n}\n\n/**\n * @param restruct { ReStruct }\n * @param srcId { number }\n * @param dstId { number }\n * @return { Action }\n */\nexport function fromAtomMerge(restruct, srcId, dstId) {\n  if (srcId === dstId) return new Action()\n\n  const fragAction = new Action()\n  mergeFragmentsIfNeeded(fragAction, restruct, srcId, dstId)\n\n  const action = new Action()\n\n  const atomNeighbors = restruct.molecule.atomGetNeighbors(srcId)\n  atomNeighbors.forEach(nei => {\n    const bond = restruct.molecule.bonds.get(nei.bid)\n\n    if (dstId === bond.begin || dstId === bond.end) {\n      // src & dst have one nei\n      action.addOp(new BondDelete(nei.bid))\n      return\n    }\n\n    const begin = bond.begin === nei.aid ? nei.aid : dstId\n    const end = bond.begin === nei.aid ? dstId : nei.aid\n\n    const mergeBondId = restruct.molecule.findBondId(begin, end)\n\n    if (mergeBondId === null) {\n      action.addOp(new BondAdd(begin, end, bond))\n    } else {\n      // replace old bond with new bond\n      const attrs = Bond.getAttrHash(bond)\n      Object.keys(attrs).forEach(key => {\n        action.addOp(new BondAttr(mergeBondId, key, attrs[key]))\n      })\n    }\n\n    action.addOp(new BondDelete(nei.bid))\n  })\n\n  const attrs = Atom.getAttrHash(restruct.molecule.atoms.get(srcId))\n\n  if (atomGetDegree(restruct, srcId) === 1 && attrs['label'] === '*')\n    attrs['label'] = 'C'\n\n  Object.keys(attrs).forEach(key => {\n    if (key !== 'stereoLabel' && key !== 'stereoParity') {\n      action.addOp(new AtomAttr(dstId, key, attrs[key]))\n    }\n  })\n\n  const sgChanged = removeAtomFromSgroupIfNeeded(action, restruct, srcId)\n\n  if (sgChanged) removeSgroupIfNeeded(action, restruct, [srcId])\n\n  action.addOp(new AtomDelete(srcId))\n  action.addOp(new CalcImplicitH([dstId]))\n  const dstAtomNeighbors = restruct.molecule.atomGetNeighbors(dstId)\n  const bond = restruct.molecule.bonds.get(\n    dstAtomNeighbors[0]?.bid || atomNeighbors[0]?.bid\n  )\n\n  return action\n    .perform(restruct)\n    .mergeWith(fragAction)\n    .mergeWith(fromBondStereoUpdate(restruct, bond))\n}\n\nexport function mergeFragmentsIfNeeded(action, restruct, srcId, dstId) {\n  const frid = atomGetAttr(restruct, srcId, 'fragment')\n  const frid2 = atomGetAttr(restruct, dstId, 'fragment')\n  if (frid2 === frid || typeof frid2 !== 'number') return\n\n  const struct = restruct.molecule\n\n  const rgid = RGroup.findRGroupByFragment(struct.rgroups, frid2)\n  if (!(typeof rgid === 'undefined')) {\n    action\n      .mergeWith(fromRGroupFragment(restruct, null, frid2))\n      .mergeWith(fromUpdateIfThen(restruct, 0, rgid))\n  }\n\n  const fridAtoms = struct.getFragmentIds(frid)\n\n  const atomsToNewFrag: Array<any> = []\n  struct.atoms.forEach((atom, aid) => {\n    if (atom.fragment === frid2) atomsToNewFrag.push(aid)\n  })\n  const moveAtomsAction = fromAtomsFragmentAttr(restruct, atomsToNewFrag, frid)\n\n  mergeSgroups(action, restruct, fridAtoms, dstId)\n  action.addOp(new FragmentDelete(frid2).perform(restruct))\n  action.mergeWith(moveAtomsAction)\n}\n\nexport function mergeSgroups(action, restruct, srcAtoms, dstAtom) {\n  const sgroups = atomGetSGroups(restruct, dstAtom)\n\n  sgroups.forEach(sid => {\n    const sgroup = restruct.molecule.sgroups.get(sid)\n    const notExpandedContexts = ['Atom', 'Bond', 'Group']\n    if (\n      sgroup.type === 'DAT' &&\n      notExpandedContexts.includes(sgroup.data.context)\n    )\n      return\n    const atomsToSgroup: any = without(sgroup.atoms, srcAtoms)\n    atomsToSgroup.forEach(aid =>\n      action.addOp(new SGroupAtomAdd(sid, aid).perform(restruct))\n    )\n  })\n}\n","/****************************************************************************\n * Copyright 2021 EPAM Systems\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *    http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n ***************************************************************************/\n\nimport { AlignDescriptors, CanvasLoad } from '../operations'\n\nimport { Action } from './action'\n\nexport function fromNewCanvas(restruct, struct) {\n  var action = new Action()\n\n  action.addOp(new CanvasLoad(struct))\n  return action.perform(restruct)\n}\n\nexport function fromDescriptorsAlign(restruct) {\n  const action = new Action()\n  action.addOp(new AlignDescriptors())\n  return action.perform(restruct)\n}\n","/****************************************************************************\n * Copyright 2021 EPAM Systems\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *    http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n ***************************************************************************/\n\nimport { AtomAdd, FragmentAdd } from '../operations'\n\nimport { Action } from './action'\nimport { Vec2 } from 'domain/entities'\nimport { atomGetAttr } from './utils'\nimport { fromBondAddition } from './bond'\n\nexport function fromChain(restruct, p0, v, nSect, atomId) {\n  // eslint-disable-line max-params\n  const dx = Math.cos(Math.PI / 6)\n  const dy = Math.sin(Math.PI / 6)\n\n  let action = new Action()\n\n  const frid =\n    atomId !== null\n      ? atomGetAttr(restruct, atomId, 'fragment')\n      : (action.addOp(new FragmentAdd().perform(restruct)) as FragmentAdd).frid\n\n  const chainItems: any = {\n    atoms: [],\n    bonds: []\n  }\n\n  let id0 =\n    atomId !== null\n      ? atomId\n      : (\n          action.addOp(\n            new AtomAdd({ label: 'C', fragment: frid }, p0).perform(restruct)\n          ) as AtomAdd\n        ).data.aid\n\n  chainItems.atoms.push(id0)\n  action.operations.reverse()\n\n  for (let i = 0; i < nSect; i++) {\n    const pos = new Vec2(dx * (i + 1), i & 1 ? 0 : dy).rotate(v).add(p0)\n\n    const ret = fromBondAddition(restruct, {}, id0, {}, pos)\n    action = ret[0].mergeWith(action)\n    id0 = ret[2]\n    chainItems.bonds.push(ret[3])\n    chainItems.atoms.push(id0)\n  }\n\n  return [action, chainItems]\n}\n","/****************************************************************************\n * Copyright 2021 EPAM Systems\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *    http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n ***************************************************************************/\n\nimport { Action } from './action'\nimport { fromAtomMerge } from './atom'\nimport { fromBondsMerge } from './bond'\nimport utils from '../shared/utils'\n\nexport function fromItemsFuse(restruct, items) {\n  let action = new Action()\n\n  if (!items) return action\n\n  const usedAtoms = new Set()\n\n  // merge single atoms\n  items.atoms.forEach((dst, src) => {\n    if (usedAtoms.has(dst) || usedAtoms.has(src)) return\n\n    action = fromAtomMerge(restruct, src, dst).mergeWith(action)\n    usedAtoms.add(dst).add(src)\n  })\n\n  // merge bonds\n  action = fromBondsMerge(restruct, items.bonds).mergeWith(action)\n\n  return action\n}\n\nexport function getItemsToFuse(editor, items) {\n  const struct = editor.render.ctab.molecule\n\n  const mergeItems = items || {\n    atoms: Array.from(struct.atoms.keys()),\n    bonds: Array.from(struct.bonds.keys())\n  }\n\n  return closestToMerge(\n    struct,\n    editor.findMerge(mergeItems, ['atoms', 'bonds'])\n  )\n}\n\nexport function getHoverToFuse(items) {\n  if (!items) return null\n\n  const hoverItems = {\n    atoms: Array.from(items.atoms.values()),\n    bonds: Array.from(items.bonds.values())\n  }\n\n  return { map: 'merge', id: +Date.now(), items: hoverItems }\n}\n\n/**\n * @param struct\n * @param closestMap {{\n * \t\tatoms: Map<number, number>,\n * \t\tbonds: Map<number, number>\n * }}\n * @return {{\n * \t\tatoms: Map<number, number>,\n * \t\tbonds: Map<number, number>\n * }}\n */\nfunction closestToMerge(struct, closestMap) {\n  const mergeMap = {\n    atoms: new Map(closestMap.atoms),\n    bonds: new Map(closestMap.bonds)\n  }\n\n  closestMap.bonds.forEach((dstId, srcId) => {\n    const bond = struct.bonds.get(srcId)\n    const bondCI = struct.bonds.get(dstId)\n\n    if (utils.mergeBondsParams(struct, bond, struct, bondCI).merged) {\n      mergeMap.atoms.delete(bond.begin)\n      mergeMap.atoms.delete(bond.end)\n    } else {\n      mergeMap.bonds.delete(srcId)\n    }\n  })\n\n  if (mergeMap.atoms.size === 0 && mergeMap.bonds.size === 0) return null\n\n  return mergeMap\n}\n","/****************************************************************************\n * Copyright 2021 EPAM Systems\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *    http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n ***************************************************************************/\n\nimport {\n  AtomMove,\n  BondMove,\n  EnhancedFlagMove,\n  FragmentAdd,\n  FragmentDelete,\n  FragmentDeleteStereoAtom,\n  FragmentStereoFlag,\n  LoopMove,\n  RxnArrowMove,\n  RxnPlusMove,\n  SGroupDataMove,\n  SimpleObjectMove,\n  TextMove\n} from '../operations'\nimport { Pile, RGroup, Vec2 } from 'domain/entities'\nimport { fromRGroupFragment, fromUpdateIfThen } from './rgroup'\n\nimport { Action } from './action'\nimport { fromAtomsFragmentAttr } from './atom'\nimport { getRelSgroupsBySelection } from './utils'\n\nexport function fromMultipleMove(restruct, lists, d) {\n  d = new Vec2(d)\n\n  const action = new Action()\n  const struct = restruct.molecule\n  const loops = new Pile()\n  const atomsToInvalidate = new Pile()\n\n  if (lists.atoms) {\n    const atomSet = new Pile(lists.atoms)\n    const bondlist: Array<number> = []\n\n    restruct.bonds.forEach((bond, bid) => {\n      if (atomSet.has(bond.b.begin) && atomSet.has(bond.b.end)) {\n        bondlist.push(bid)\n        // add all adjacent loops\n        // those that are not completely inside the structure will get redrawn anyway\n        ;['hb1', 'hb2'].forEach(hb => {\n          const loop = struct.halfBonds.get(bond.b[hb]).loop\n          if (loop >= 0) loops.add(loop)\n        })\n        return\n      }\n\n      if (atomSet.has(bond.b.begin)) {\n        atomsToInvalidate.add(bond.b.begin)\n        return\n      }\n\n      if (atomSet.has(bond.b.end)) atomsToInvalidate.add(bond.b.end)\n    })\n\n    bondlist.forEach(bond => {\n      action.addOp(new BondMove(bond, d))\n    })\n\n    loops.forEach(loopId => {\n      if (restruct.reloops.get(loopId) && restruct.reloops.get(loopId).visel)\n        // hack\n        action.addOp(new LoopMove(loopId, d))\n    })\n\n    lists.atoms.forEach(aid => {\n      action.addOp(new AtomMove(aid, d, !atomsToInvalidate.has(aid)))\n    })\n\n    if (lists.sgroupData && lists.sgroupData.length === 0) {\n      const sgroups = getRelSgroupsBySelection(restruct, lists.atoms)\n      sgroups.forEach(sg => {\n        action.addOp(new SGroupDataMove(sg.id, d))\n      })\n    }\n  }\n\n  if (lists.rxnArrows) {\n    lists.rxnArrows.forEach(rxnArrow => {\n      action.addOp(new RxnArrowMove(rxnArrow, d, true))\n    })\n  }\n\n  if (lists.rxnPluses) {\n    lists.rxnPluses.forEach(rxnPulse => {\n      action.addOp(new RxnPlusMove(rxnPulse, d, true))\n    })\n  }\n\n  if (lists.simpleObjects) {\n    lists.simpleObjects.forEach(simpleObject => {\n      action.addOp(new SimpleObjectMove(simpleObject, d, true))\n    })\n  }\n\n  if (lists.sgroupData) {\n    lists.sgroupData.forEach(sgData => {\n      action.addOp(new SGroupDataMove(sgData, d))\n    })\n  }\n\n  if (lists.enhancedFlags) {\n    lists.enhancedFlags.forEach(fid => {\n      action.addOp(new EnhancedFlagMove(fid, d))\n    })\n  }\n\n  if (lists.texts) {\n    lists.texts.forEach(text => {\n      action.addOp(new TextMove(text, d, true))\n    })\n  }\n\n  return action.perform(restruct)\n}\n\nexport function fromStereoFlagUpdate(restruct, frid, flag = null) {\n  const action = new Action()\n\n  if (!flag) {\n    const struct = restruct.molecule\n    const frag = restruct.molecule.frags.get(frid)\n    frag.stereoAtoms.forEach(aid => {\n      if (struct.atoms.get(aid).stereoLabel === null)\n        action.addOp(new FragmentDeleteStereoAtom(frid, aid))\n    })\n  }\n\n  action.addOp(new FragmentStereoFlag(frid))\n  return action.perform(restruct)\n}\n\n/**\n * @param restruct { ReStruct }\n * @param aid { number }\n * @param frid { number }\n * @param newfrid { number }\n * @returns { Action }\n */\nfunction processAtom(restruct, aid, frid, newfrid) {\n  const queue = [aid]\n  const usedIds = new Pile(queue)\n\n  while (queue.length > 0) {\n    const id = queue.shift()\n\n    restruct.molecule.atomGetNeighbors(id).forEach(nei => {\n      if (\n        restruct.molecule.atoms.get(nei.aid).fragment === frid &&\n        !usedIds.has(nei.aid)\n      ) {\n        usedIds.add(nei.aid)\n        queue.push(nei.aid)\n      }\n    })\n  }\n\n  return fromAtomsFragmentAttr(restruct, usedIds, newfrid)\n}\n\n/**\n * @param restruct { ReStruct }\n * @param frid { number }\n * @param rgForRemove\n * @return { Action }\n */\n// TODO [RB] the thing is too tricky :) need something else in future\nexport function fromFragmentSplit(\n  restruct,\n  frid,\n  rgForRemove: Array<number> = []\n) {\n  const action = new Action()\n  const rgid = RGroup.findRGroupByFragment(restruct.molecule.rgroups, frid)\n\n  restruct.molecule.atoms.forEach((atom, aid) => {\n    if (atom.fragment === frid) {\n      const newfrid = (\n        action.addOp(new FragmentAdd().perform(restruct)) as FragmentAdd\n      ).frid\n\n      action.mergeWith(processAtom(restruct, aid, frid, newfrid))\n\n      if (rgid) action.mergeWith(fromRGroupFragment(restruct, rgid, newfrid))\n    }\n  })\n\n  if (frid !== -1) {\n    action.mergeWith(fromRGroupFragment(restruct, 0, frid))\n    action.addOp(new FragmentDelete(frid).perform(restruct))\n    action.mergeWith(fromUpdateIfThen(restruct, 0, rgid, rgForRemove))\n  }\n\n  action.operations.reverse()\n  return action\n}\n","/****************************************************************************\n * Copyright 2021 EPAM Systems\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *    http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n ***************************************************************************/\n\nimport {\n  AtomDelete,\n  BondDelete,\n  CalcImplicitH,\n  RxnArrowDelete,\n  RxnPlusDelete,\n  SimpleObjectDelete,\n  TextDelete\n} from '../operations'\nimport { Pile, RGroup } from 'domain/entities'\nimport {\n  fromSgroupDeletion,\n  removeAtomFromSgroupIfNeeded,\n  removeSgroupIfNeeded\n} from './sgroup'\n\nimport { Action } from './action'\nimport assert from 'assert'\nimport { atomGetDegree } from './utils'\nimport { fromBondStereoUpdate } from '../actions/bond'\nimport { fromFragmentSplit } from './fragment'\n\nexport function fromOneAtomDeletion(restruct, id) {\n  return fromFragmentDeletion(restruct, { atoms: [id] })\n}\n\nfunction fromBondDeletion(restruct, bid: number, skipAtoms: Array<any> = []) {\n  let action = new Action()\n  const bond: any = restruct.molecule.bonds.get(bid)\n  const atomsToRemove: Array<any> = []\n\n  action.addOp(new BondDelete(bid))\n\n  if (\n    !skipAtoms.includes(bond.begin) &&\n    atomGetDegree(restruct, bond.begin) === 1\n  ) {\n    if (removeAtomFromSgroupIfNeeded(action, restruct, bond.begin))\n      atomsToRemove.push(bond.begin)\n\n    action.addOp(new AtomDelete(bond.begin))\n  }\n\n  if (\n    !skipAtoms.includes(bond.end) &&\n    atomGetDegree(restruct, bond.end) === 1\n  ) {\n    if (removeAtomFromSgroupIfNeeded(action, restruct, bond.end))\n      atomsToRemove.push(bond.end)\n\n    action.addOp(new AtomDelete(bond.end))\n  }\n\n  removeSgroupIfNeeded(action, restruct, atomsToRemove)\n  action = action.perform(restruct)\n  action.addOp(new CalcImplicitH([bond.begin, bond.end]).perform(restruct))\n  action.mergeWith(fromBondStereoUpdate(restruct, bond, false))\n\n  action.operations.reverse()\n\n  return action\n}\n\nexport function fromOneBondDeletion(restruct, id) {\n  const frid = restruct.molecule.getBondFragment(id)\n  let action = fromBondDeletion(restruct, id)\n\n  action = fromFragmentSplit(restruct, frid).mergeWith(action)\n\n  return action\n}\n\nexport function fromFragmentDeletion(restruct, selection) {\n  assert(!!selection != null)\n\n  let action = new Action()\n  const atomsToRemove: Array<number> = []\n  const frids: Array<number> = []\n\n  selection = {\n    // TODO: refactor me\n    atoms: selection.atoms || [],\n    bonds: selection.bonds || [],\n    rxnPluses: selection.rxnPluses || [],\n    rxnArrows: selection.rxnArrows || [],\n    sgroupData: selection.sgroupData || [],\n    simpleObjects: selection.simpleObjects || [],\n    texts: selection.texts || []\n  }\n\n  const actionRemoveDataSGroups = new Action()\n  restruct.molecule.sgroups.forEach((sg, id) => {\n    if (\n      selection.sgroupData.includes(id) ||\n      new Pile(selection.atoms).isSuperset(new Pile(sg.atoms))\n    )\n      actionRemoveDataSGroups.mergeWith(fromSgroupDeletion(restruct, id))\n  })\n\n  selection.atoms.forEach(aid => {\n    restruct.molecule.atomGetNeighbors(aid).forEach(nei => {\n      if (selection.bonds.indexOf(nei.bid) === -1) {\n        selection.bonds = selection.bonds.concat([nei.bid])\n      }\n    })\n  })\n\n  const actionRemoveBonds = new Action()\n  selection.bonds.forEach(bid => {\n    const frid = restruct.molecule.getBondFragment(bid)\n    if (frids.indexOf(frid) < 0) frids.push(frid)\n\n    actionRemoveBonds.mergeWith(\n      fromBondDeletion(restruct, bid, selection.atoms)\n    )\n  })\n\n  selection.atoms.forEach(aid => {\n    const frid3 = restruct.molecule.atoms.get(aid).fragment\n    if (frids.indexOf(frid3) < 0) frids.push(frid3)\n\n    if (removeAtomFromSgroupIfNeeded(action, restruct, aid))\n      atomsToRemove.push(aid)\n\n    action.addOp(new AtomDelete(aid))\n  })\n\n  removeSgroupIfNeeded(action, restruct, atomsToRemove)\n\n  selection.rxnArrows.forEach(id => {\n    action.addOp(new RxnArrowDelete(id))\n  })\n\n  selection.rxnPluses.forEach(id => {\n    action.addOp(new RxnPlusDelete(id))\n  })\n\n  selection.simpleObjects.forEach(id => {\n    action.addOp(new SimpleObjectDelete(id))\n  })\n\n  selection.texts.forEach(id => {\n    action.addOp(new TextDelete(id))\n  })\n\n  action = action.perform(restruct)\n  action.mergeWith(actionRemoveBonds)\n\n  const rgForRemove: Array<number> = frids.map(\n    frid => RGroup.findRGroupByFragment(restruct.molecule.rgroups, frid)!\n  )\n\n  while (frids.length > 0)\n    action = fromFragmentSplit(restruct, frids.pop(), rgForRemove).mergeWith(\n      action\n    )\n\n  action.mergeWith(actionRemoveDataSGroups)\n\n  return action\n}\n","/****************************************************************************\n * Copyright 2021 EPAM Systems\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *    http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n ***************************************************************************/\n\nimport {\n  AtomAdd,\n  BondAdd,\n  FragmentAdd,\n  FragmentAddStereoAtom,\n  RGroupFragment,\n  RxnArrowAdd,\n  RxnPlusAdd,\n  SimpleObjectAdd,\n  TextCreate\n} from '../operations'\nimport { fromRGroupAttrs, fromUpdateIfThen } from './rgroup'\n\nimport { Action } from './action'\nimport { Vec2 } from 'domain/entities'\nimport { fromSgroupAddition } from './sgroup'\n\nexport function fromPaste(restruct, pstruct, point, angle = 0) {\n  const xy0 = getStructCenter(pstruct)\n  const offset = Vec2.diff(point, xy0)\n\n  const action = new Action()\n\n  const aidMap = new Map()\n  const fridMap = new Map()\n\n  const pasteItems: any = {\n    // only atoms and bonds now\n    atoms: [],\n    bonds: []\n  }\n\n  pstruct.atoms.forEach((atom, aid) => {\n    if (!fridMap.has(atom.fragment))\n      fridMap.set(\n        atom.fragment,\n        (action.addOp(new FragmentAdd().perform(restruct)) as FragmentAdd).frid\n      )\n\n    const tmpAtom = Object.assign(atom.clone(), {\n      fragment: fridMap.get(atom.fragment)\n    })\n    const operation = new AtomAdd(\n      tmpAtom,\n      Vec2.diff(atom.pp, xy0).rotate(angle).add(point)\n    ).perform(restruct) as AtomAdd\n    action.addOp(operation)\n    aidMap.set(aid, operation.data.aid)\n\n    pasteItems.atoms.push(operation.data.aid)\n  })\n\n  pstruct.frags.forEach((frag, frid) => {\n    if (!frag) return\n    frag.stereoAtoms.forEach(aid =>\n      action.addOp(\n        new FragmentAddStereoAtom(fridMap.get(frid), aidMap.get(aid)).perform(\n          restruct\n        )\n      )\n    )\n  })\n\n  pstruct.bonds.forEach(bond => {\n    const operation = new BondAdd(\n      aidMap.get(bond.begin),\n      aidMap.get(bond.end),\n      bond\n    ).perform(restruct) as BondAdd\n    action.addOp(operation)\n\n    pasteItems.bonds.push(operation.data.bid)\n  })\n\n  pstruct.sgroups.forEach(sg => {\n    const newsgid = restruct.molecule.sgroups.newId()\n    const sgAtoms = sg.atoms.map(aid => aidMap.get(aid))\n    const sgAction = fromSgroupAddition(\n      restruct,\n      sg.type,\n      sgAtoms,\n      sg.data,\n      newsgid,\n      sg.pp ? sg.pp.add(offset) : null,\n      sg.type === 'SUP' ? sg.data.expanded : null,\n      sg.data.name\n    )\n    sgAction.operations.reverse().forEach(oper => {\n      action.addOp(oper)\n    })\n  })\n\n  pstruct.rxnArrows.forEach(rxnArrow => {\n    action.addOp(\n      new RxnArrowAdd(\n        rxnArrow.pos.map(p => p.add(offset)),\n        rxnArrow.mode\n      ).perform(restruct)\n    )\n  })\n\n  pstruct.rxnPluses.forEach(plus => {\n    action.addOp(new RxnPlusAdd(plus.pp.add(offset)).perform(restruct))\n  })\n\n  pstruct.simpleObjects.forEach(simpleObject => {\n    action.addOp(\n      new SimpleObjectAdd(\n        simpleObject.pos.map(p => p.add(offset)),\n        simpleObject.mode\n      ).perform(restruct)\n    )\n  })\n\n  pstruct.texts.forEach(text => {\n    action.addOp(\n      new TextCreate(text.content, text.position.add(offset)).perform(restruct)\n    )\n  })\n\n  pstruct.rgroups.forEach((rg, rgid) => {\n    rg.frags.forEach((__frag, frid) => {\n      action.addOp(\n        new RGroupFragment(rgid, fridMap.get(frid)).perform(restruct)\n      )\n    })\n    const ifThen = pstruct.rgroups.get(rgid).ifthen\n    const newRgId = pstruct.rgroups.get(ifThen) ? ifThen : 0\n    action\n      .mergeWith(fromRGroupAttrs(restruct, rgid, rg.getAttrs()))\n      .mergeWith(fromUpdateIfThen(restruct, newRgId, rg.ifthen))\n  })\n\n  action.operations.reverse()\n  return [action, pasteItems]\n}\n\nfunction getStructCenter(struct) {\n  //TODO: Review, function may not work sometimes\n  const onlyOneStructsSgroupId = struct.sgroups.keys().next().value\n  if (\n    struct.sgroups.size === 1 &&\n    !struct.sgroups.get(onlyOneStructsSgroupId).data.expanded\n  ) {\n    return struct.atoms.get(0).pp\n  }\n  if (struct.atoms.size > 0) {\n    let xmin = 1e50\n    let ymin = xmin\n    let xmax = -xmin\n    let ymax = -ymin\n\n    struct.atoms.forEach(atom => {\n      xmin = Math.min(xmin, atom.pp.x)\n      ymin = Math.min(ymin, atom.pp.y)\n      xmax = Math.max(xmax, atom.pp.x)\n      ymax = Math.max(ymax, atom.pp.y)\n    })\n    return new Vec2((xmin + xmax) / 2, (ymin + ymax) / 2) // TODO: check\n  }\n  if (struct.rxnArrows.size > 0) return struct.rxnArrows.get(0).center()\n  if (struct.rxnPluses.size > 0) return struct.rxnPluses.get(0).pp\n  if (struct.simpleObjects.size > 0) return struct.simpleObjects.get(0).center()\n  if (struct.texts.size > 0) return struct.texts.get(0).position\n\n  return null\n}\n","/****************************************************************************\n * Copyright 2021 EPAM Systems\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *    http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n ***************************************************************************/\n\nimport {\n  RxnArrowAdd,\n  RxnArrowDelete,\n  RxnArrowResize,\n  RxnPlusAdd,\n  RxnPlusDelete\n} from '../operations'\n\nimport { Action } from './action'\n\nexport function fromArrowAddition(restruct, pos, mode) {\n  const action = new Action()\n  action.addOp(new RxnArrowAdd(pos, mode))\n  return action.perform(restruct)\n}\n\nexport function fromArrowResizing(restruct, id, d, current, anchor) {\n  var action = new Action()\n  action.addOp(new RxnArrowResize(id, d, current, anchor, false))\n  return action.perform(restruct)\n}\n\nexport function fromArrowDeletion(restruct, id) {\n  var action = new Action()\n  action.addOp(new RxnArrowDelete(id))\n  return action.perform(restruct)\n}\n\nexport function fromPlusAddition(restruct, pos) {\n  var action = new Action()\n  action.addOp(new RxnPlusAdd(pos).perform(restruct))\n  return action\n}\n\nexport function fromPlusDeletion(restruct, id) {\n  var action = new Action()\n  action.addOp(new RxnPlusDelete(id))\n  return action.perform(restruct)\n}\n","/****************************************************************************\n * Copyright 2021 EPAM Systems\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *    http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n ***************************************************************************/\n\nimport {\n  AtomMove,\n  BondAttr,\n  EnhancedFlagMove,\n  RxnArrowMove,\n  RxnPlusMove,\n  SGroupDataMove\n} from '../operations'\nimport { Bond, Fragment, Pile, Vec2 } from 'domain/entities'\nimport { getRelSgroupsBySelection, structSelection } from './utils'\n\nimport { Action } from './action'\nimport utils from '../shared/utils'\n\nexport function fromFlip(restruct, selection, dir, center) {\n  // eslint-disable-line max-statements\n  const struct = restruct.molecule\n\n  const action = new Action()\n\n  if (!selection) {\n    selection = structSelection(struct)\n  }\n\n  if (!selection.atoms) {\n    return action.perform(restruct)\n  }\n\n  const fids = selection.atoms.reduce((acc, aid) => {\n    const atom = struct.atoms.get(aid)\n\n    if (!acc[atom.fragment]) {\n      acc[atom.fragment] = []\n    }\n\n    acc[atom.fragment].push(aid)\n    return acc\n  }, {})\n\n  const fidsNumberKeys = Object.keys(fids).map(frag => parseInt(frag, 10))\n\n  const isFragFound = fidsNumberKeys.find(frag => {\n    const allFragmentsOfStructure = struct.getFragmentIds(frag)\n    const selectedFragmentsOfStructure = new Pile(fids[frag])\n    const res = allFragmentsOfStructure.equals(selectedFragmentsOfStructure)\n    return !res\n  })\n\n  if (typeof isFragFound === 'number') {\n    return action // empty action\n  }\n\n  Object.keys(fids).forEach(frag => {\n    const fragment = new Pile(fids[frag])\n\n    const bbox = struct.getCoordBoundingBox(fragment)\n    const calcCenter =\n      center ||\n      new Vec2((bbox.max.x + bbox.min.x) / 2, (bbox.max.y + bbox.min.y) / 2)\n\n    fragment.forEach(aid => {\n      const atom = struct.atoms.get(aid)\n      const d = flipItemByCenter(atom, calcCenter, dir)\n      action.addOp(new AtomMove(aid, d))\n    })\n\n    const sgroups = getRelSgroupsBySelection(restruct, Array.from(fragment))\n    sgroups.forEach(sg => {\n      const d = flipItemByCenter(sg, calcCenter, dir)\n      action.addOp(new SGroupDataMove(sg.id, d))\n    })\n  })\n\n  if (selection.bonds) {\n    selection.bonds.forEach(bid => {\n      const bond = struct.bonds.get(bid)\n\n      if (bond.type !== Bond.PATTERN.TYPE.SINGLE) {\n        return\n      }\n\n      if (bond.stereo === Bond.PATTERN.STEREO.UP) {\n        action.addOp(new BondAttr(bid, 'stereo', Bond.PATTERN.STEREO.DOWN))\n        return\n      }\n\n      if (bond.stereo === Bond.PATTERN.STEREO.DOWN)\n        action.addOp(new BondAttr(bid, 'stereo', Bond.PATTERN.STEREO.UP))\n    })\n  }\n\n  return action.perform(restruct)\n}\n\nfunction flipItemByCenter(item, center, dir) {\n  const d = new Vec2()\n  /* eslint-disable no-mixed-operators*/\n  if (dir === 'horizontal') {\n    d.x =\n      center.x > item.pp.x\n        ? 2 * (center.x - item.pp.x)\n        : -2 * (item.pp.x - center.x)\n  } else {\n    // 'vertical'\n    d.y =\n      center.y > item.pp.y\n        ? 2 * (center.y - item.pp.y)\n        : -2 * (item.pp.y - center.y)\n  }\n  /* eslint-enable no-mixed-operators*/\n  return d\n}\n\nexport function fromRotate(restruct, selection, center, angle) {\n  // eslint-disable-line\n  const struct = restruct.molecule\n\n  const action = new Action()\n\n  if (!selection) {\n    selection = structSelection(struct)\n  }\n\n  if (selection.atoms) {\n    selection.atoms.forEach(aid => {\n      const atom = struct.atoms.get(aid)\n      action.addOp(new AtomMove(aid, rotateDelta(atom.pp, center, angle)))\n    })\n\n    if (!selection.sgroupData) {\n      const sgroups = getRelSgroupsBySelection(restruct, selection.atoms)\n\n      sgroups.forEach(sg => {\n        action.addOp(\n          new SGroupDataMove(sg.id, rotateDelta(sg.pp, center, angle))\n        )\n      })\n    }\n  }\n\n  if (selection.rxnArrows) {\n    selection.rxnArrows.forEach(aid => {\n      var arrow = struct.rxnArrows.get(aid)\n      action.addOp(\n        new RxnArrowMove(aid, rotateDelta(arrow.center(), center, angle))\n      )\n    })\n  }\n\n  if (selection.rxnPluses) {\n    selection.rxnPluses.forEach(pid => {\n      var plus = struct.rxnPluses.get(pid)\n      action.addOp(new RxnPlusMove(pid, rotateDelta(plus.pp, center, angle)))\n    })\n  }\n\n  if (selection.sgroupData) {\n    selection.sgroupData.forEach(did => {\n      var data = struct.sgroups.get(did)\n      action.addOp(new SGroupDataMove(did, rotateDelta(data.pp, center, angle)))\n    })\n  }\n\n  const stereoFlags =\n    selection.enhancedFlags || Array.from(restruct.enhancedFlags.keys())\n  if (stereoFlags) {\n    stereoFlags.forEach(flagId => {\n      const frId = flagId\n      const frag = restruct.molecule.frags.get(frId)\n      action.addOp(\n        new EnhancedFlagMove(\n          flagId,\n          rotateDelta(\n            frag.stereoFlagPosition ||\n              Fragment.getDefaultStereoFlagPosition(restruct.molecule, frId),\n            center,\n            angle\n          )\n        )\n      )\n    })\n  }\n\n  return action.perform(restruct)\n}\n\nexport function fromBondAlign(restruct, bid, dir) {\n  const struct = restruct.molecule\n  const bond = struct.bonds.get(bid)\n  const begin = struct.atoms.get(bond.begin)\n  const end = struct.atoms.get(bond.end)\n\n  const center = begin.pp.add(end.pp).scaled(0.5)\n  let angle = utils.calcAngle(begin.pp, end.pp)\n  const atoms = Array.from(struct.getFragmentIds(begin.fragment))\n\n  // TODO: choose minimal angle\n  angle = dir === 'horizontal' ? -angle : Math.PI / 2 - angle\n\n  if (angle === 0 || Math.abs(angle) === Math.PI)\n    return fromFlip(restruct, { atoms }, dir, center)\n\n  return fromRotate(restruct, { atoms }, center, angle)\n}\n\nfunction rotateDelta(v, center, angle) {\n  var v1 = v.sub(center)\n  v1 = v1.rotate(angle)\n  v1.add_(center) // eslint-disable-line no-underscore-dangle\n  return v1.sub(v)\n}\n","/****************************************************************************\n * Copyright 2021 EPAM Systems\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *    http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n ***************************************************************************/\n\nimport {\n  SimpleObjectAdd,\n  SimpleObjectDelete,\n  SimpleObjectResize\n} from '../operations'\n\nimport { Action } from './action'\n\nexport function fromSimpleObjectDeletion(restruct, id) {\n  const action = new Action()\n  action.addOp(new SimpleObjectDelete(id))\n  return action.perform(restruct)\n}\n\nexport function fromSimpleObjectAddition(restruct, pos, mode, toCircle) {\n  var action = new Action()\n  action.addOp(new SimpleObjectAdd(pos, mode, toCircle))\n  return action.perform(restruct)\n}\n\nexport function fromSimpleObjectResizing(\n  restruct,\n  id,\n  d,\n  current,\n  anchor,\n  toCircle\n) {\n  var action = new Action()\n  action.addOp(new SimpleObjectResize(id, d, current, anchor, false, toCircle))\n  return action.perform(restruct)\n}\n","/****************************************************************************\n * Copyright 2021 EPAM Systems\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *    http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n ***************************************************************************/\n\nimport { Atom, Vec2 } from 'domain/entities'\nimport { AtomAdd, BondAdd, CalcImplicitH } from '../operations'\nimport { atomForNewBond, atomGetAttr } from './utils'\nimport { fromAtomsAttrs, mergeSgroups } from './atom'\nimport { fromBondAddition, fromBondStereoUpdate, fromBondsAttrs } from './bond'\n\nimport { Action } from './action'\nimport closest from '../shared/closest'\nimport { fromAromaticTemplateOnBond } from './aromaticFusing'\nimport { fromPaste } from './paste'\nimport utils from '../shared/utils'\nimport { fromSgroupAddition } from './sgroup'\n\nexport function fromTemplateOnCanvas(restruct, template, pos, angle) {\n  const [action, pasteItems] = fromPaste(\n    restruct,\n    template.molecule,\n    pos,\n    angle\n  )\n\n  action.addOp(new CalcImplicitH(pasteItems.atoms).perform(restruct))\n\n  return [action, pasteItems]\n}\n\nfunction extraBondAction(restruct, aid, angle) {\n  let action = new Action()\n  const frid = atomGetAttr(restruct, aid, 'fragment')\n  let additionalAtom: any = null\n\n  if (angle === null) {\n    const middleAtom = atomForNewBond(restruct, aid)\n    const actionRes = fromBondAddition(\n      restruct,\n      { type: 1 },\n      aid,\n      middleAtom.atom,\n      middleAtom.pos.get_xy0()\n    )\n    action = actionRes[0]\n    action.operations.reverse()\n    additionalAtom = actionRes[2]\n  } else {\n    const operation = new AtomAdd(\n      { label: 'C', fragment: frid },\n      new Vec2(1, 0)\n        .rotate(angle)\n        .add(restruct.molecule.atoms.get(aid).pp)\n        .get_xy0()\n    ).perform(restruct) as AtomAdd\n\n    action.addOp(operation)\n    action.addOp(\n      new BondAdd(aid, operation.data.aid, { type: 1 }).perform(restruct)\n    )\n\n    additionalAtom = operation.data.aid\n  }\n\n  return { action, aid1: additionalAtom }\n}\n\nexport function fromTemplateOnAtom(restruct, template, aid, angle, extraBond) {\n  let action = new Action()\n\n  const tmpl = template.molecule\n  const struct = restruct.molecule\n\n  let atom = struct.atoms.get(aid) // aid - the atom that was clicked on\n  let aid1 = aid // aid1 - the atom on the other end of the extra bond || aid\n\n  let delta: any = null\n\n  if (extraBond) {\n    // create extra bond after click on atom\n    const extraRes = extraBondAction(restruct, aid, angle)\n    action = extraRes.action\n    aid1 = extraRes.aid1\n\n    atom = struct.atoms.get(aid1)\n    delta = utils.calcAngle(struct.atoms.get(aid).pp, atom.pp) - template.angle0\n  } else {\n    if (angle === null)\n      angle = utils.calcAngle(atom.pp, atomForNewBond(restruct, aid).pos)\n    delta = angle - template.angle0\n  }\n\n  const map = new Map()\n  const xy0 = tmpl.atoms.get(template.aid).pp\n  const frid = atomGetAttr(restruct, aid, 'fragment')\n\n  /* For merge */\n  const pasteItems: any = {\n    // only atoms and bonds now\n    atoms: [],\n    bonds: []\n  }\n  /* ----- */\n\n  tmpl.atoms.forEach((a, id) => {\n    const attrs: any = Atom.getAttrHash(a)\n    attrs.fragment = frid\n\n    if (id === template.aid) {\n      action.mergeWith(fromAtomsAttrs(restruct, aid1, attrs, true))\n      map.set(id, aid1)\n      pasteItems.atoms.push(aid1)\n    } else {\n      const v = Vec2.diff(a.pp, xy0).rotate(delta).add(atom.pp)\n\n      const operation = new AtomAdd(attrs, v.get_xy0()).perform(\n        restruct\n      ) as AtomAdd\n      action.addOp(operation)\n      map.set(id, operation.data.aid)\n      pasteItems.atoms.push(operation.data.aid)\n    }\n  })\n  mergeSgroups(action, restruct, pasteItems.atoms, aid)\n\n  tmpl.bonds.forEach(bond => {\n    const operation = new BondAdd(\n      map.get(bond.begin),\n      map.get(bond.end),\n      bond\n    ).perform(restruct) as BondAdd\n    action.addOp(operation)\n\n    pasteItems.bonds.push(operation.data.bid)\n  })\n\n  tmpl.sgroups.forEach(sg => {\n    const newsgid = restruct.molecule.sgroups.newId()\n    const sgAtoms = sg.atoms.map(aid => map.get(aid))\n    const sgAction = fromSgroupAddition(\n      restruct,\n      sg.type,\n      sgAtoms,\n      sg.data,\n      newsgid,\n      atom.pp,\n      sg.type === 'SUP' ? sg.expanded : null,\n      sg.data.name\n    )\n    sgAction.operations.reverse().forEach(oper => {\n      action.addOp(oper)\n    })\n  })\n\n  action.operations.reverse()\n\n  action.addOp(new CalcImplicitH(pasteItems.atoms).perform(restruct))\n  action.mergeWith(\n    fromBondStereoUpdate(\n      restruct,\n      restruct.molecule.bonds.get(pasteItems.bonds[0])\n    )\n  )\n\n  return [action, pasteItems]\n}\n\nexport function fromTemplateOnBondAction(\n  restruct,\n  template,\n  bid,\n  events,\n  flip,\n  force\n) {\n  if (!force) return fromTemplateOnBond(restruct, template, bid, flip)\n\n  const simpleFusing = (restruct, template, bid) =>\n    fromTemplateOnBond(restruct, template, bid, flip) // eslint-disable-line\n  /* aromatic merge (Promise)*/\n  return fromAromaticTemplateOnBond(\n    restruct,\n    template,\n    bid,\n    events,\n    simpleFusing\n  )\n}\n\nfunction fromTemplateOnBond(restruct, template, bid, flip) {\n  // TODO: refactor function !!\n  const action = new Action()\n\n  const tmpl = template.molecule\n  const struct = restruct.molecule\n\n  const bond = struct.bonds.get(bid)\n  const tmplBond = tmpl.bonds.get(template.bid)\n\n  const tmplBegin = tmpl.atoms.get(flip ? tmplBond.end : tmplBond.begin)\n\n  const atomsMap = new Map([\n    [tmplBond.begin, flip ? bond.end : bond.begin],\n    [tmplBond.end, flip ? bond.begin : bond.end]\n  ])\n\n  // calc angle\n  const bondAtoms = {\n    begin: flip ? tmplBond.end : tmplBond.begin,\n    end: flip ? tmplBond.begin : tmplBond.end\n  }\n  const { angle, scale } = utils.mergeBondsParams(struct, bond, tmpl, bondAtoms)\n\n  const frid = struct.getBondFragment(bid)\n\n  /* For merge */\n  const pasteItems: any = {\n    // only atoms and bonds now\n    atoms: [],\n    bonds: []\n  }\n  /* ----- */\n\n  tmpl.atoms.forEach((atom, id) => {\n    const attrs: any = Atom.getAttrHash(atom)\n    attrs.fragment = frid\n    if (id === tmplBond.begin || id === tmplBond.end) {\n      action.mergeWith(fromAtomsAttrs(restruct, atomsMap.get(id), attrs, true))\n      return\n    }\n\n    const v = Vec2.diff(atom.pp, tmplBegin.pp)\n      .rotate(angle)\n      .scaled(scale)\n      .add(struct.atoms.get(bond.begin).pp)\n    const mergeA = closest.atom(restruct, v, null, 0.1)\n\n    if (mergeA === null) {\n      const operation = new AtomAdd(attrs, v).perform(restruct) as AtomAdd\n      action.addOp(operation)\n      atomsMap.set(id, operation.data.aid)\n      pasteItems.atoms.push(operation.data.aid)\n    } else {\n      atomsMap.set(id, mergeA.id)\n\n      action.mergeWith(fromAtomsAttrs(restruct, atomsMap.get(id), attrs, true))\n      // TODO [RB] need to merge fragments?\n    }\n  })\n  mergeSgroups(action, restruct, pasteItems.atoms, bond.begin)\n\n  tmpl.bonds.forEach(tBond => {\n    const existId = struct.findBondId(\n      atomsMap.get(tBond.begin),\n      atomsMap.get(tBond.end)\n    )\n    if (existId === null) {\n      const operation = new BondAdd(\n        atomsMap.get(tBond.begin),\n        atomsMap.get(tBond.end),\n        tBond\n      ).perform(restruct) as BondAdd\n      action.addOp(operation)\n\n      pasteItems.bonds.push(operation.data.bid)\n    } else {\n      action.mergeWith(fromBondsAttrs(restruct, existId, tmplBond, true))\n    }\n  })\n\n  if (pasteItems.atoms.length) {\n    action.addOp(\n      new CalcImplicitH([bond.begin, bond.end, ...pasteItems.atoms]).perform(\n        restruct\n      )\n    )\n  }\n\n  if (pasteItems.bonds.length) {\n    action.mergeWith(\n      fromBondStereoUpdate(\n        restruct,\n        restruct.molecule.bonds.get(pasteItems.bonds[0])\n      )\n    )\n  }\n\n  action.operations.reverse()\n\n  return [action, pasteItems]\n}\n","/****************************************************************************\n * Copyright 2021 EPAM Systems\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *    http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n ***************************************************************************/\n\nimport { TextCreate, TextDelete, TextUpdate } from '../operations'\n\nimport { Action } from './action'\nimport { ReStruct } from '../../render'\nimport { Vec2 } from 'domain/entities'\n\nexport function fromTextCreation(\n  restruct: ReStruct,\n  content: string,\n  position: Vec2\n) {\n  const action = new Action()\n  action.addOp(new TextCreate(content, position))\n  return action.perform(restruct)\n}\n\nexport function fromTextUpdating(\n  restruct: ReStruct,\n  id: number,\n  content: string\n) {\n  const action = new Action()\n  action.addOp(new TextUpdate(id, content))\n  return action.perform(restruct)\n}\n\nexport function fromTextDeletion(restruct: ReStruct, id: number) {\n  const action = new Action()\n\n  action.addOp(new TextDelete(id))\n\n  return action.perform(restruct)\n}\n","/****************************************************************************\n * Copyright 2021 EPAM Systems\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *    http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n ***************************************************************************/\n\nimport { Highlight } from 'domain/entities'\nimport { ReStruct } from '../../render'\n\nimport { BaseOperation } from './base'\nimport { OperationType } from './OperationType'\n\ntype Data = {\n  atoms: Array<number>\n  bonds: Array<number>\n  color: string\n  highlightId?: number\n}\n\nexport class HighlightAdd extends BaseOperation {\n  data: Data\n\n  constructor(\n    atoms: Array<number>,\n    bonds: Array<number>,\n    color: string,\n    highlightId?: number\n  ) {\n    super(OperationType.ADD_HIGHLIGHT)\n    this.data = {\n      atoms: atoms,\n      bonds: bonds,\n      color: color,\n      highlightId: highlightId\n    }\n  }\n\n  execute(restruct: ReStruct) {\n    const { atoms, bonds, color } = this.data\n\n    if (!color) {\n      return\n    }\n\n    const struct = restruct.molecule\n    const highlight = new Highlight({\n      atoms,\n      bonds,\n      color\n    })\n\n    if (typeof this.data.highlightId !== 'number') {\n      this.data.highlightId = struct.highlights.add(highlight)\n    } else {\n      struct.highlights.set(this.data.highlightId, highlight)\n    }\n\n    notifyChanged(restruct, atoms, bonds)\n  }\n\n  invert() {\n    const { atoms, bonds, color, highlightId } = this.data\n    const inverted = new HighlightDelete(highlightId, atoms, bonds, color)\n    return inverted\n  }\n}\n\nexport class HighlightDelete extends BaseOperation {\n  data: Data\n\n  constructor(\n    highlightId?: number,\n    atoms?: Array<number>,\n    bonds?: Array<number>,\n    color?: string\n  ) {\n    super(OperationType.REMOVE_HIGHLIGHT, 5)\n    this.data = {\n      highlightId: highlightId,\n      atoms: atoms || [],\n      bonds: bonds || [],\n      color: color || 'white'\n    }\n  }\n\n  execute(restruct: ReStruct) {\n    if (typeof this.data.highlightId === 'number') {\n      const struct = restruct.molecule\n\n      const highlightToRemove = struct.highlights.get(this.data.highlightId)\n      if (typeof highlightToRemove === 'undefined') {\n        return\n      }\n\n      const { atoms, bonds, color } = highlightToRemove\n\n      this.data.atoms = atoms\n      this.data.bonds = bonds\n      this.data.color = color\n\n      struct.highlights.delete(this.data.highlightId)\n      notifyChanged(restruct, atoms, bonds)\n    }\n  }\n\n  invert() {\n    const { atoms, bonds, color, highlightId } = this.data\n    const inverted = new HighlightAdd(atoms, bonds, color, highlightId)\n    inverted.data = this.data\n    return inverted\n  }\n}\n\nexport class HighlightUpdate extends BaseOperation {\n  // making sure highlightId is not optional\n  newData: Data & { highlightId: number }\n  oldData: Data & { highlightId: number }\n\n  constructor(\n    highlightId: number,\n    atoms: Array<number>,\n    bonds: Array<number>,\n    color: string\n  ) {\n    super(OperationType.UPDATE_HIGHLIGHT)\n    this.newData = {\n      atoms: atoms,\n      bonds: bonds,\n      color: color,\n      highlightId: highlightId\n    }\n\n    // pre-filling with new data. Upon execution this will be replaced\n    this.oldData = {\n      atoms: atoms,\n      bonds: bonds,\n      color: color,\n      highlightId: highlightId\n    }\n  }\n\n  execute(restruct: ReStruct) {\n    const { atoms, bonds, color } = this.newData\n    if (!color) {\n      return\n    }\n\n    const highlightId = this.newData.highlightId\n    const struct = restruct.molecule\n\n    const highlightToUpdate = struct.highlights.get(highlightId)\n\n    if (highlightToUpdate) {\n      // saving data of existing highlight\n      const {\n        atoms: oldAtoms,\n        bonds: oldBonds,\n        color: oldColor\n      } = highlightToUpdate\n      this.oldData = {\n        atoms: oldAtoms,\n        bonds: oldBonds,\n        color: oldColor,\n        highlightId\n      }\n\n      // creating new highlight with new data\n      const updatedHighlight = new Highlight({\n        atoms,\n        bonds,\n        color\n      })\n\n      // setting the new highlight\n      struct.highlights.set(this.newData.highlightId, updatedHighlight)\n\n      // notify atoms from both collections that repaint is needed\n      notifyChanged(restruct, [...atoms, ...oldAtoms], [...bonds, ...oldBonds])\n    }\n  }\n\n  invert() {\n    const { atoms, bonds, color } = this.oldData\n    const inverted = new HighlightUpdate(\n      this.newData.highlightId,\n      atoms,\n      bonds,\n      color\n    )\n    return inverted\n  }\n}\n\nfunction notifyChanged(restruct: ReStruct, atoms?: number[], bonds?: number[]) {\n  // Notifying ReStruct that repaint needed\n  const reAtoms = restruct.atoms\n  const reBonds = restruct.bonds\n\n  if (atoms) {\n    atoms.forEach(atomId => {\n      if (typeof reAtoms.get(atomId) !== 'undefined') {\n        restruct.markAtom(atomId, 1)\n      }\n    })\n  }\n\n  if (bonds) {\n    bonds.forEach(bondId => {\n      if (typeof reBonds.get(bondId) !== 'undefined') {\n        restruct.markBond(bondId, 1)\n      }\n    })\n  }\n}\n","/****************************************************************************\n * Copyright 2021 EPAM Systems\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *    http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n ***************************************************************************/\n\nimport { ReStruct } from '../../render'\n\nimport { HighlightAdd, HighlightDelete } from '../operations/highlight'\n\nimport { Action } from './action'\n\ntype HighlightType = {\n  atoms: number[]\n  bonds: number[]\n  color: string\n}\n\nexport function fromHighlightCreate(\n  restruct: ReStruct,\n  highlights: HighlightType[]\n): Action {\n  const action = new Action()\n\n  highlights.forEach(highlight => {\n    const { atoms, bonds, color } = highlight\n\n    action.addOp(new HighlightAdd(atoms, bonds, color))\n  })\n  return action.perform(restruct)\n}\n\nexport function fromHighlightClear(restruct: ReStruct): Action {\n  const action = new Action()\n\n  const highlights = restruct.molecule.highlights\n\n  highlights.forEach((_, key) => {\n    action.addOp(new HighlightDelete(key))\n  })\n\n  return action.perform(restruct)\n}\n\n/*\n// Update highlight by placing new one on the given id\nexport function fromHighlightUpdate(\n  highlightId: number,\n  restruct: ReStruct,\n  atoms: number[],\n  bonds: number[],\n  color: string\n): Action {\n  const action = new Action()\n\n  const highlights = restruct.molecule.highlights\n\n  const selectedHighlight = highlights.get(highlightId)\n  if (!selectedHighlight) {\n    return action\n  }\n\n  const updateOperation = new HighlightUpdate(highlightId, atoms, bonds, color)\n  action.addOp(updateOperation)\n\n  return action.perform(restruct)\n}\n*/\n\n/*\n// Delete single highlight by id\nexport function fromHighlightDelete(\n  restruct: ReStruct,\n  highlightId: number\n): Action {\n  const action = new Action()\n\n  const highlights = restruct.molecule.highlights\n  if (highlights.has(highlightId)) {\n    action.addOp(new HighlightDelete(highlightId))\n\n    return action.perform(restruct)\n  }\n  return action\n}\n*/\n","/****************************************************************************\n * Copyright 2021 EPAM Systems\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *    http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n ***************************************************************************/\n\nexport const SgContexts = {\n  Fragment: 'Fragment',\n  Multifragment: 'Multifragment',\n  Bond: 'Bond',\n  Atom: 'Atom',\n  Group: 'Group'\n}\n","/****************************************************************************\n * Copyright 2021 EPAM Systems\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *    http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n ***************************************************************************/\n\nimport utils from './shared/utils'\n\n// TODO: delete it\nexport const fracAngle = utils.fracAngle\nexport * from './operations'\nexport * from './actions'\nexport * from './shared/constants'\nexport * from './editor.types'\n","/****************************************************************************\n * Copyright 2021 EPAM Systems\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *    http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n ***************************************************************************/\n\nimport {\n  FormatterFactory,\n  SupportedFormat,\n  identifyStructFormat\n} from './formatters'\nimport { GenerateImageOptions, StructService } from 'domain/services'\n\nimport { Editor } from './editor'\nimport { MolfileFormat } from 'domain/serializers'\nimport { Struct } from 'domain/entities'\nimport assert from 'assert'\n\nfunction parseStruct(structStr: string, structService: StructService) {\n  const format = identifyStructFormat(structStr)\n  const factory = new FormatterFactory(structService)\n\n  const service = factory.create(format)\n  return service.getStructureFromStringAsync(structStr)\n}\n\nfunction getStructure(\n  structureFormat: SupportedFormat = 'rxn',\n  formatterFactory: FormatterFactory,\n  struct: Struct\n): Promise<string> {\n  const formatter = formatterFactory.create(structureFormat)\n  return formatter.getStructureFromStructAsync(struct)\n}\n\nexport class Ketcher {\n  #structService: StructService\n  #formatterFactory: FormatterFactory\n  #editor: Editor\n\n  get editor(): Editor {\n    return this.#editor\n  }\n\n  constructor(\n    editor: Editor,\n    structService: StructService,\n    formatterFactory: FormatterFactory\n  ) {\n    assert(editor != null)\n    assert(structService != null)\n    assert(formatterFactory != null)\n\n    this.#editor = editor\n    this.#structService = structService\n    this.#formatterFactory = formatterFactory\n  }\n\n  getSmiles(isExtended: boolean = false): Promise<string> {\n    const format: SupportedFormat = isExtended ? 'smilesExt' : 'smiles'\n    return getStructure(format, this.#formatterFactory, this.editor.struct())\n  }\n\n  async getMolfile(molfileFormat: MolfileFormat = 'v2000'): Promise<string> {\n    if (this.containsReaction()) {\n      throw Error(\n        'The structure cannot be saved as *.MOL due to reaction arrrows.'\n      )\n    }\n\n    const format: SupportedFormat =\n      molfileFormat === 'v3000' ? 'molV3000' : 'mol'\n    const molfile = await getStructure(\n      format,\n      this.#formatterFactory,\n      this.#editor.struct()\n    )\n\n    return molfile\n  }\n\n  async getRxn(molfileFormat: MolfileFormat = 'v2000'): Promise<string> {\n    if (!this.containsReaction()) {\n      throw Error(\n        'The structure cannot be saved as *.RXN: there is no reaction arrows.'\n      )\n    }\n    const format: SupportedFormat =\n      molfileFormat === 'v3000' ? 'rxnV3000' : 'rxn'\n    const rxnfile = await getStructure(\n      format,\n      this.#formatterFactory,\n      this.#editor.struct()\n    )\n\n    return rxnfile\n  }\n\n  getKet(): Promise<string> {\n    return getStructure('ket', this.#formatterFactory, this.#editor.struct())\n  }\n\n  getSmarts(): Promise<string> {\n    return getStructure('smarts', this.#formatterFactory, this.#editor.struct())\n  }\n\n  getCml(): Promise<string> {\n    return getStructure('cml', this.#formatterFactory, this.#editor.struct())\n  }\n\n  getInchi(withAuxInfo = false): Promise<string> {\n    return getStructure(\n      withAuxInfo ? 'inChIAuxInfo' : 'inChI',\n      this.#formatterFactory,\n      this.#editor.struct()\n    )\n  }\n\n  containsReaction(): boolean {\n    return this.editor.struct().hasRxnArrow()\n  }\n\n  async setMolecule(structStr: string): Promise<void> {\n    assert(typeof structStr === 'string')\n\n    const struct: Struct = await parseStruct(structStr, this.#structService)\n    struct.initHalfBonds()\n    struct.initNeighbors()\n    struct.setImplicitHydrogen()\n    struct.markFragments()\n    this.#editor.struct(struct)\n  }\n\n  async addFragment(fragment: string): Promise<void> {\n    assert(typeof fragment === 'string')\n\n    throw Error('not implemented yet')\n  }\n\n  async generateImage(\n    data: string,\n    options: GenerateImageOptions = { outputFormat: 'png' }\n  ): Promise<Blob> {\n    let meta = ''\n\n    switch (options.outputFormat) {\n      case 'svg':\n        meta = 'image/svg+xml'\n        break\n\n      case 'png':\n      default:\n        meta = 'image/png'\n        options.outputFormat = 'png'\n    }\n\n    const base64 = await this.#structService.generateImageAsBase64(\n      data,\n      options\n    )\n    const byteCharacters = atob(base64)\n    const byteNumbers = new Array(byteCharacters.length)\n    for (let i = 0; i < byteCharacters.length; i++) {\n      byteNumbers[i] = byteCharacters.charCodeAt(i)\n    }\n    const byteArray = new Uint8Array(byteNumbers)\n    const blob = new Blob([byteArray], { type: meta })\n    return blob\n  }\n}\n","/****************************************************************************\n * Copyright 2021 EPAM Systems\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *    http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n ***************************************************************************/\n\nimport {\n  StructService,\n  StructServiceOptions,\n  StructServiceProvider\n} from 'domain/services'\n\nimport { Editor } from 'application/editor'\nimport { FormatterFactory } from 'application/formatters'\nimport { Ketcher } from './ketcher'\nimport assert from 'assert'\n\nconst DefaultStructServiceOptions = {\n  'smart-layout': true,\n  'ignore-stereochemistry-errors': true,\n  'mass-skip-error-on-pseudoatoms': false,\n  'gross-formula-add-rsites': true,\n  'aromatize-skip-superatoms': true\n}\n\nexport class KetcherBuilder {\n  #structServiceProvider?: StructServiceProvider\n\n  withStructServiceProvider(\n    structServiceProvider: StructServiceProvider\n  ): KetcherBuilder {\n    this.#structServiceProvider = structServiceProvider\n    return this\n  }\n\n  build(editor: Editor, serviceOptions?: StructServiceOptions): Ketcher {\n    assert(editor != null)\n    assert(this.#structServiceProvider != null)\n\n    const mergedServiceOptions: StructServiceOptions = {\n      ...DefaultStructServiceOptions,\n      ...serviceOptions\n    }\n    const structService: StructService =\n      this.#structServiceProvider!.createStructService(mergedServiceOptions)\n    const ketcher = new Ketcher(\n      editor,\n      structService,\n      new FormatterFactory(structService)\n    )\n    ketcher[this.#structServiceProvider.mode] = true\n\n    return ketcher\n  }\n}\n","import 'miew/dist/Miew.min.css'\nimport 'ketcher-react/dist/index.css'\n\nimport { ButtonsConfig, Editor } from 'ketcher-react'\nimport { Ketcher, RemoteStructServiceProvider } from 'ketcher-core'\n\nimport ErrorModal from './ErrorModal/ErrorModal'\n// @ts-ignore\nimport Miew from 'miew'\nimport { useState } from 'react'\n\nconst getHiddenButtonsConfig = (): ButtonsConfig => {\n  const searchParams = new URLSearchParams(window.location.search)\n  const hiddenButtons = searchParams.get('hiddenControls')\n\n  if (!hiddenButtons) return {}\n\n  return hiddenButtons.split(',').reduce((acc, button) => {\n    if (button) acc[button] = { hidden: true }\n\n    return acc\n  }, {})\n}\n\n;(global as any).Miew = Miew\n\nlet structServiceProvider: any = new RemoteStructServiceProvider(\n  process.env.API_PATH || process.env.REACT_APP_API_PATH!\n)\nif (process.env.MODE === 'standalone') {\n  const { StandaloneStructServiceProvider } = require('ketcher-standalone')\n  structServiceProvider = new StandaloneStructServiceProvider()\n}\n\nconst App = () => {\n  const hiddenButtonsConfig = getHiddenButtonsConfig()\n  const [hasError, setHasError] = useState(false)\n  const [errorMessage, setErrorMessage] = useState('')\n\n  return (\n    <>\n      <Editor\n        errorHandler={(message: string) => {\n          setHasError(true)\n          setErrorMessage(message.toString())\n        }}\n        buttons={hiddenButtonsConfig}\n        staticResourcesUrl={process.env.PUBLIC_URL}\n        structServiceProvider={structServiceProvider}\n        onInit={(ketcher: Ketcher) => {\n          ;(global as any).ketcher = ketcher\n        }}\n      />\n      {hasError && (\n        <ErrorModal\n          message={errorMessage}\n          close={() => {\n            setHasError(false)\n\n            // Focus on editor after modal is closed\n            const cliparea: HTMLElement = document.querySelector('.cliparea')!\n            cliparea?.focus()\n          }}\n        />\n      )}\n    </>\n  )\n}\n\nexport default App\n","/****************************************************************************\n * Copyright 2021 EPAM Systems\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *    http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n ***************************************************************************/\n\nimport {\n  InfoResult,\n  StructService,\n  StructServiceOptions,\n  StructServiceProvider\n} from 'ketcher-core'\n\ntype Api = StructService & Promise<InfoResult>\n\n// todo: remove\nfunction createApi(\n  structServiceProvider: StructServiceProvider,\n  defaultOptions: StructServiceOptions\n): Api {\n  const structService =\n    structServiceProvider.createStructService(defaultOptions)\n  const info = structService.info()\n\n  return Object.assign(info, {\n    info: structService.info.bind(structService),\n    convert: structService.convert.bind(structService),\n    layout: structService.layout.bind(structService),\n    clean: structService.clean.bind(structService),\n    aromatize: structService.aromatize.bind(structService),\n    dearomatize: structService.dearomatize.bind(structService),\n    calculateCip: structService.calculateCip.bind(structService),\n    automap: structService.automap.bind(structService),\n    check: structService.check.bind(structService),\n    calculate: structService.calculate.bind(structService),\n    recognize: structService.recognize.bind(structService),\n    generateImageAsBase64:\n      structService.generateImageAsBase64.bind(structService)\n  })\n}\n\nexport default createApi\n","/****************************************************************************\n * Copyright 2021 EPAM Systems\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *    http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n ***************************************************************************/\n\nimport { Ketcher } from 'ketcher-core'\nimport React from 'react'\n\nexport interface IAppContext {\n  getKetcherInstance: () => Ketcher\n}\n\nconst appContext = React.createContext<IAppContext>({} as IAppContext)\n\nexport default appContext\n","/****************************************************************************\n * Copyright 2021 EPAM Systems\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *    http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n ***************************************************************************/\n\nimport React from 'react'\n\nexport interface IErrorsContext {\n  errorHandler: (message: string) => void\n}\n\nconst errorsContext = React.createContext<IErrorsContext>({} as IErrorsContext)\n\nexport default errorsContext\n","/****************************************************************************\n * Copyright 2021 EPAM Systems\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *    http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n ***************************************************************************/\n\nimport React from 'react'\n\nexport interface ISettingsContext {\n  staticResourcesUrl: string\n}\n\nconst settingsContext = React.createContext<ISettingsContext>(\n  {} as ISettingsContext\n)\n\nexport default settingsContext\n","/****************************************************************************\n * Copyright 2021 EPAM Systems\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *    http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n ***************************************************************************/\n\nimport React from 'react'\n\nconst formContext = React.createContext(null)\n\nexport default formContext\n","/****************************************************************************\n * Copyright 2021 EPAM Systems\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *    http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n ***************************************************************************/\n\nexport const basicAtoms = ['H', 'C', 'N', 'O', 'S', 'P', 'F', 'Cl', 'Br', 'I']\n\nexport const atomCuts = {\n  H: 'h',\n  C: 'c',\n  N: 'n',\n  O: 'o',\n  S: 's',\n  P: 'p',\n  F: 'f',\n  Cl: 'Shift+c',\n  Br: 'Shift+b',\n  I: 'i',\n  A: 'a'\n}\n\nexport default Object.keys(atomCuts).reduce((res, label) => {\n  res[`atom-${label.toLowerCase()}`] = {\n    title: `Atom ${label}`,\n    shortcut: atomCuts[label],\n    action: {\n      tool: 'atom',\n      opts: { label }\n    }\n  }\n  return res\n}, {})\n","/****************************************************************************\n * Copyright 2021 EPAM Systems\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *    http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n ***************************************************************************/\n\nimport { KetSerializer, MolSerializer } from 'ketcher-core'\n\nexport default function copyAs(type) {\n  const state = global.currentState\n  const editor = state.editor\n  const struct = editor.structSelected()\n  const errorHandler = editor.errorHandler\n  let serializer\n  try {\n    switch (type) {\n      case 'mol': {\n        serializer = new MolSerializer()\n        break\n      }\n      case 'ket': {\n        serializer = new KetSerializer()\n        break\n      }\n      default: {\n        serializer = new KetSerializer()\n        break\n      }\n    }\n\n    const simpleObjectOrText = Boolean(\n      struct.simpleObjects.size || struct.texts.size\n    )\n\n    if (simpleObjectOrText && serializer instanceof MolSerializer) {\n      errorHandler(\n        'This feature is not available for Simple objects and Text objects'\n      )\n      return null\n    }\n\n    const structData = serializer.serialize(struct)\n\n    if (window.clipboardData) {\n      window.clipboardData.setData('text', structData)\n    } else {\n      navigator.clipboard.writeText(structData)\n    }\n  } catch {\n    errorHandler('This feature is not available in your browser')\n  }\n}\n","/****************************************************************************\n * Copyright 2021 EPAM Systems\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *    http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n ***************************************************************************/\n\nimport { FormatterFactory, Ketcher } from 'ketcher-core'\n\nasync function copyImageToClipboard() {\n  const state = global.currentState\n  const editor = state.editor\n  const server = state.server\n  const options = state.options\n  const struct = editor.structSelected()\n  const errorHandler = editor.errorHandler\n\n  try {\n    const factory = new FormatterFactory(server)\n    const service = factory.create('mol', options)\n    const structStr = await service.getStructureFromStructAsync(struct)\n    const ketcher = new Ketcher(editor, server, {}, factory)\n    const image = await ketcher.generateImage(structStr, {\n      outputFormat: 'png',\n      backgroundColor: '255, 255, 255'\n    })\n    const item = new ClipboardItem({ [image.type]: image }) // eslint-disable-line no-undef\n    await navigator.clipboard.write([item])\n  } catch {\n    errorHandler('This feature is not available in your browser')\n  }\n}\n\nexport default copyImageToClipboard\n","/****************************************************************************\n * Copyright 2021 EPAM Systems\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *    http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n ***************************************************************************/\n\nexport default function isHidden(\n  options: { buttons?: {} },\n  buttonName: string\n): boolean {\n  return Boolean(options.buttons?.[buttonName]?.hidden)\n}\n","/****************************************************************************\n * Copyright 2021 EPAM Systems\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *    http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n ***************************************************************************/\n\nimport { MolSerializer } from 'ketcher-core'\nimport isHidden from './isHidden'\n\nconst debugObj = {\n  // original: for dev purposes\n  'force-update': {\n    shortcut: 'Ctrl+Shift+r',\n    action: editor => {\n      editor.update(true)\n    },\n    hidden: options => isHidden(options, 'force-update')\n  },\n  'qs-serialize': {\n    shortcut: 'Alt+Shift+r',\n    action: editor => {\n      const molSerializer = new MolSerializer()\n      const molStr = molSerializer.serialize(editor.struct())\n      const molQs = 'mol=' + encodeURIComponent(molStr).replace(/%20/g, '+')\n      const qs = document.location.search\n      document.location.search = !qs\n        ? '?' + molQs // eslint-disable-line\n        : qs.search('mol=') === -1\n        ? qs + '&' + molQs\n        : qs.replace(/mol=[^&$]*/, molQs)\n    }\n  },\n  hidden: options => isHidden(options, 'qs-serialize')\n}\n\nexport default debugObj\n","/****************************************************************************\n * Copyright 2021 EPAM Systems\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *    http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n ***************************************************************************/\n\nimport { Component, createRef } from 'react'\nimport clsx from 'clsx'\nimport classes from './cliparea.module.less'\n\nconst ieCb = window.clipboardData\n\nclass ClipArea extends Component {\n  constructor(props) {\n    super(props)\n    this.textAreaRef = createRef()\n  }\n\n  componentDidMount() {\n    const el = this.textAreaRef.current\n    this.target = this.props.target || el.parentNode\n\n    this.listeners = {\n      mouseup: event => {\n        if (\n          el === event.target ||\n          (!isActiveElement(event.target) && this.props.focused())\n        )\n          autofocus(el)\n      },\n      mousedown: event => {\n        if (event.shiftKey && !isActiveElement(event.target))\n          event.preventDefault()\n      },\n      copy: event => {\n        if (this.props.focused() && this.props.onCopy) {\n          const data = this.props.onCopy()\n\n          if (data) copy(event.clipboardData, data)\n\n          event.preventDefault()\n        }\n      },\n      cut: event => {\n        if (this.props.focused() && this.props.onCut) {\n          const data = this.props.onCut()\n\n          if (data) copy(event.clipboardData, data)\n\n          event.preventDefault()\n        }\n      },\n      paste: event => {\n        if (this.props.focused() && this.props.onPaste) {\n          const data = paste(event.clipboardData, this.props.formats)\n\n          if (data) this.props.onPaste(data)\n\n          event.preventDefault()\n        }\n      }\n    }\n\n    Object.keys(this.listeners).forEach(en => {\n      this.target.addEventListener(en, this.listeners[en])\n    })\n  }\n\n  shouldComponentUpdate() {\n    return false\n  }\n\n  componentWillUnmount() {\n    Object.keys(this.listeners).forEach(en => {\n      this.target.removeEventListener(en, this.listeners[en])\n    })\n  }\n\n  render() {\n    return (\n      <textarea\n        ref={this.textAreaRef}\n        className={clsx('cliparea', classes.cliparea)}\n        contentEditable\n        autoFocus // eslint-disable-line jsx-a11y/no-autofocus\n        suppressContentEditableWarning={true}\n      />\n    )\n  }\n}\n\nfunction isActiveElement(el) {\n  if (el.tagName === 'INPUT' && el.type === 'button') return false\n  return ['INPUT', 'SELECT', 'TEXTAREA', 'OPTION', 'LABEL'].includes(el.tagName)\n}\n\nfunction autofocus(cliparea) {\n  cliparea.value = ' '\n  cliparea.focus()\n  cliparea.select()\n}\n\nfunction copy(cb, data) {\n  if (!cb && ieCb) {\n    ieCb.setData('text', data['text/plain'])\n  } else {\n    let curFmt = null\n    cb.setData('text/plain', data['text/plain'])\n    try {\n      Object.keys(data).forEach(fmt => {\n        curFmt = fmt\n        cb.setData(fmt, data[fmt])\n      })\n    } catch (ex) {\n      console.info(`Could not write exact type ${curFmt}`)\n    }\n  }\n}\n\nfunction paste(cb, formats) {\n  let data = {}\n  if (!cb && ieCb) {\n    data['text/plain'] = ieCb.getData('text')\n  } else {\n    data['text/plain'] = cb.getData('text/plain')\n    data = formats.reduce((res, fmt) => {\n      const d = cb.getData(fmt)\n      if (d) res[fmt] = d\n      return res\n    }, data)\n  }\n  return data\n}\n\nexport const actions = ['cut', 'copy', 'paste']\n\nexport function exec(action) {\n  let enabled = document.queryCommandSupported(action)\n  if (enabled) {\n    try {\n      enabled = document.execCommand(action) || window.ClipboardEvent || ieCb\n    } catch (ex) {\n      // FF < 41\n      enabled = false\n    }\n  }\n  return enabled\n}\n\nexport default ClipArea\n","/****************************************************************************\n * Copyright 2021 EPAM Systems\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *    http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n ***************************************************************************/\n\nimport { StereLabelStyleType, StereoColoringType } from 'ketcher-core'\nimport jsonschema, { Schema } from 'jsonschema'\n\ntype ExtendedSchema = Schema & { enumNames?: Array<string>; default?: any }\n\nconst editor: {\n  resetToSelect: ExtendedSchema\n  rotationStep: ExtendedSchema\n} = {\n  resetToSelect: {\n    title: 'Reset to Select Tool',\n    enum: [true, 'paste', false],\n    enumNames: ['on', 'After Paste', 'off'],\n    default: 'paste'\n  },\n  rotationStep: {\n    title: 'Rotation Step, ¬∫',\n    type: 'integer',\n    minimum: 1,\n    maximum: 90,\n    default: 15\n  }\n}\n\nconst render: {\n  showValenceWarnings: ExtendedSchema\n  atomColoring: ExtendedSchema\n  showStereoFlags: ExtendedSchema\n  stereoLabelStyle: ExtendedSchema\n  colorOfAbsoluteCenters: ExtendedSchema\n  colorOfAndCenters: ExtendedSchema\n  colorOfOrCenters: ExtendedSchema\n  colorStereogenicCenters: ExtendedSchema\n  autoFadeOfStereoLabels: ExtendedSchema\n  absFlagLabel: ExtendedSchema\n  andFlagLabel: ExtendedSchema\n  mixedFlagLabel: ExtendedSchema\n  orFlagLabel: ExtendedSchema\n  font: ExtendedSchema\n  fontsz: ExtendedSchema\n  fontszsub: ExtendedSchema\n  carbonExplicitly: ExtendedSchema\n  showCharge: ExtendedSchema\n  showValence: ExtendedSchema\n  showHydrogenLabels: ExtendedSchema\n  aromaticCircle: ExtendedSchema\n  doubleBondWidth: ExtendedSchema\n  bondThickness: ExtendedSchema\n  stereoBondWidth: ExtendedSchema\n} = {\n  showValenceWarnings: {\n    title: 'Show valence warnings',\n    type: 'boolean',\n    default: true\n  },\n  atomColoring: {\n    title: 'Atom coloring',\n    type: 'boolean',\n    default: true\n  },\n  showStereoFlags: {\n    title: 'Show the Stereo flags',\n    type: 'boolean',\n    default: true\n  },\n  stereoLabelStyle: {\n    title: 'Label display at stereogenic centers',\n    enum: [\n      StereLabelStyleType.IUPAC,\n      StereLabelStyleType.Classic,\n      StereLabelStyleType.On,\n      StereLabelStyleType.Off\n    ],\n    enumNames: ['IUPAC style', 'Classic', 'On', 'Off'],\n    default: StereLabelStyleType.IUPAC\n  },\n  colorOfAbsoluteCenters: {\n    title: ' Color of Absolute Center',\n    type: 'string',\n    default: '#ff0000'\n  },\n  colorOfAndCenters: {\n    title: 'Color of AND Centers',\n    type: 'string',\n    default: '#0000cd'\n  },\n  colorOfOrCenters: {\n    title: 'Color of OR Centers',\n    type: 'string',\n    default: '#228b22'\n  },\n  colorStereogenicCenters: {\n    title: 'Color stereogenic centers',\n    enum: [\n      StereoColoringType.LabelsOnly,\n      StereoColoringType.BondsOnly,\n      StereoColoringType.LabelsAndBonds,\n      StereoColoringType.Off\n    ],\n    enumNames: ['Labels Only', 'Bonds Only', 'Labels And Bonds', 'Off'],\n    default: StereoColoringType.LabelsOnly\n  },\n  autoFadeOfStereoLabels: {\n    title: 'Auto fade And/Or center labels',\n    type: 'boolean',\n    default: true\n  },\n  absFlagLabel: {\n    title: 'Text of Absolute flag',\n    type: 'String',\n    default: 'ABS (Chiral)'\n  },\n  andFlagLabel: {\n    title: 'Text of AND flag',\n    type: 'String',\n    default: 'AND Enantiomer'\n  },\n  mixedFlagLabel: {\n    title: 'Text of Mixed flag',\n    type: 'String',\n    default: 'Mixed'\n  },\n  orFlagLabel: {\n    title: 'Text of OR flag',\n    type: 'String',\n    default: 'OR Enantiomer'\n  },\n  font: {\n    title: 'Font',\n    type: 'string',\n    default: '30px Arial'\n  },\n  fontsz: {\n    title: 'Font size',\n    type: 'integer',\n    default: 13,\n    minimum: 1,\n    maximum: 96\n  },\n  fontszsub: {\n    title: 'Sub font size',\n    type: 'integer',\n    default: 13,\n    minimum: 1,\n    maximum: 96\n  },\n  // Atom\n  carbonExplicitly: {\n    title: 'Display carbon explicitly',\n    type: 'boolean',\n    default: false\n  },\n  showCharge: {\n    title: 'Display charge',\n    type: 'boolean',\n    default: true\n  },\n  showValence: {\n    title: 'Display valence',\n    type: 'boolean',\n    default: true\n  },\n  showHydrogenLabels: {\n    title: 'Show hydrogen labels',\n    enum: ['off', 'Hetero', 'Terminal', 'Terminal and Hetero', 'on'],\n    default: 'on'\n  },\n  // Bonds\n  aromaticCircle: {\n    title: 'Aromatic Bonds as circle',\n    type: 'boolean',\n    default: true\n  },\n  doubleBondWidth: {\n    title: 'Double bond width',\n    type: 'integer',\n    default: 6,\n    minimum: 1,\n    maximum: 96\n  },\n  bondThickness: {\n    title: 'Bond thickness',\n    type: 'integer',\n    default: 2,\n    minimum: 1,\n    maximum: 96\n  },\n  stereoBondWidth: {\n    title: 'Stereo (Wedge) bond width',\n    type: 'integer',\n    default: 6,\n    minimum: 1,\n    maximum: 96\n  }\n}\n\nconst server: {\n  'smart-layout': ExtendedSchema\n  'ignore-stereochemistry-errors': ExtendedSchema\n  'mass-skip-error-on-pseudoatoms': ExtendedSchema\n  'gross-formula-add-rsites': ExtendedSchema\n  'gross-formula-add-isotopes': ExtendedSchema\n} = {\n  'smart-layout': {\n    title: 'Smart-layout',\n    type: 'boolean',\n    default: true\n  },\n  'ignore-stereochemistry-errors': {\n    title: 'Ignore stereochemistry errors',\n    type: 'boolean',\n    default: true\n  },\n  'mass-skip-error-on-pseudoatoms': {\n    title: 'Ignore pseudoatoms at mass',\n    type: 'boolean',\n    default: false\n  },\n  'gross-formula-add-rsites': {\n    title: 'Add Rsites at mass calculation',\n    type: 'boolean',\n    default: true\n  },\n  'gross-formula-add-isotopes': {\n    title: 'Add Isotopes at mass calculation',\n    type: 'boolean',\n    default: true\n  }\n}\n\nexport const SERVER_OPTIONS = Object.keys(server)\n\nconst debug: {\n  showAtomIds: ExtendedSchema\n  showBondIds: ExtendedSchema\n  showHalfBondIds: ExtendedSchema\n  showLoopIds: ExtendedSchema\n} = {\n  showAtomIds: {\n    title: 'Show atom Ids',\n    type: 'boolean',\n    default: false\n  },\n  showBondIds: {\n    title: 'Show bonds Ids',\n    type: 'boolean',\n    default: false\n  },\n  showHalfBondIds: {\n    title: 'Show half bonds Ids',\n    type: 'boolean',\n    default: false\n  },\n  showLoopIds: {\n    title: 'Show loop Ids',\n    type: 'boolean',\n    default: false\n  }\n}\n\nconst miew: {\n  miewMode: ExtendedSchema\n  miewTheme: ExtendedSchema\n  miewAtomLabel: ExtendedSchema\n} = {\n  miewMode: {\n    title: 'Display mode',\n    enum: ['LN', 'BS', 'LC'],\n    enumNames: ['Lines', 'Balls and Sticks', 'Licorice'],\n    default: 'LN'\n  },\n  miewTheme: {\n    title: 'Background color',\n    enum: ['light', 'dark'],\n    enumNames: ['Light', 'Dark'],\n    default: 'light'\n  },\n  miewAtomLabel: {\n    title: 'Label coloring',\n    enum: ['no', 'bright', 'blackAndWhite', 'black'],\n    enumNames: ['No', 'Bright', 'Black and White', 'Black'],\n    default: 'bright'\n  }\n}\n\nexport const MIEW_OPTIONS = Object.keys(miew)\n\nconst optionsSchema: ExtendedSchema = {\n  title: 'Settings',\n  type: 'object',\n  required: [],\n  properties: {\n    ...editor,\n    ...render,\n    ...server,\n    ...debug,\n    ...miew\n  }\n}\n\nexport default optionsSchema\n\nexport function getDefaultOptions(): Record<string, any> {\n  if (!optionsSchema.properties) return {}\n\n  return Object.keys(optionsSchema.properties).reduce((res, prop) => {\n    res[prop] = (optionsSchema.properties![prop] as ExtendedSchema).default\n    return res\n  }, {})\n}\n\nexport function validation(settings): Record<string, string> | null {\n  if (typeof settings !== 'object' || settings === null) return null\n\n  const v = new jsonschema.Validator()\n  const { errors } = v.validate(settings, optionsSchema)\n  const errProps = errors.map(err => err.property.split('.')[1])\n\n  return Object.keys(settings).reduce((res, prop) => {\n    if (!optionsSchema.properties) return res\n\n    if (optionsSchema.properties[prop] && errProps.indexOf(prop) === -1)\n      res[prop] = settings[prop]\n\n    return res\n  }, {})\n}\n","/****************************************************************************\n * Copyright 2021 EPAM Systems\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *    http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n ***************************************************************************/\n\n/* local storage */\nexport const storage = {\n  warningMessage:\n    'Your changes will be lost after the tab closing. See Help (Note 2).',\n  isAvailable() {\n    try {\n      return localStorage\n    } catch (ex) {\n      return false\n    }\n  },\n  getItem(key) {\n    let item = null\n    try {\n      item = JSON.parse(localStorage.getItem(key))\n    } catch (ex) {\n      console.info('LocalStorage:', ex.name)\n    }\n    return item\n  },\n  setItem(key, data) {\n    let isSet = null\n    try {\n      localStorage.setItem(key, JSON.stringify(data))\n      isSet = true\n    } catch (ex) {\n      console.info('LocalStorage:', ex.name)\n      isSet = false\n    }\n    return isSet\n  }\n}\n","/****************************************************************************\n * Copyright 2021 EPAM Systems\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *    http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n ***************************************************************************/\n\nimport {\n  SERVER_OPTIONS,\n  getDefaultOptions,\n  validation\n} from '../../data/schema/options-schema'\n\nimport { pick } from 'lodash/fp'\nimport { storage } from '../../storage-ext'\n\nexport const initOptionsState = {\n  app: {\n    server: false,\n    templates: false,\n    functionalGroups: false\n  },\n  analyse: {\n    values: null,\n    roundWeight: 3,\n    roundMass: 3,\n    roundElAnalysis: 1\n  },\n  check: {\n    checkOptions: [\n      'valence',\n      'radicals',\n      'pseudoatoms',\n      'stereo',\n      'query',\n      'overlapping_atoms',\n      'overlapping_bonds',\n      'rgroups',\n      'chiral',\n      '3d',\n      'chiral_flag'\n    ]\n  },\n  recognize: {\n    file: null,\n    structStr: null,\n    fragment: false,\n    version: null\n  },\n  settings: Object.assign(\n    getDefaultOptions(),\n    validation(storage.getItem('ketcher-opts'))\n  ),\n  getServerSettings() {\n    return pick(SERVER_OPTIONS, this.settings)\n  }\n}\n\nexport function appUpdate(data) {\n  return dispatch => {\n    dispatch({ type: 'APP_OPTIONS', data })\n    dispatch({ type: 'UPDATE' })\n  }\n}\n\n/* SETTINGS */\nexport function saveSettings(newSettings) {\n  storage.setItem('ketcher-opts', newSettings)\n  return {\n    type: 'SAVE_SETTINGS',\n    data: newSettings\n  }\n}\n\n/* ANALYZE */\nexport function changeRound(roundName, value) {\n  return {\n    type: 'CHANGE_ANALYSE',\n    data: { [roundName]: value }\n  }\n}\n\n/* RECOGNIZE */\nconst recognizeActions = [\n  'SET_RECOGNIZE_STRUCT',\n  'CHANGE_RECOGNIZE_FILE',\n  'CHANGE_IMAGO_VERSION',\n  'IS_FRAGMENT_RECOGNIZE'\n]\n\nexport function setStruct(str) {\n  return {\n    type: 'SET_RECOGNIZE_STRUCT',\n    data: { structStr: str }\n  }\n}\n\nexport function changeVersion(version) {\n  return {\n    type: 'CHANGE_IMAGO_VERSION',\n    data: { version }\n  }\n}\n\nexport function changeImage(file) {\n  return {\n    type: 'CHANGE_RECOGNIZE_FILE',\n    data: {\n      file,\n      structStr: null\n    }\n  }\n}\n\nexport function shouldFragment(isFrag) {\n  return {\n    type: 'IS_FRAGMENT_RECOGNIZE',\n    data: { fragment: isFrag }\n  }\n}\n\n/* CHECK */\nexport function checkOpts(data) {\n  return {\n    type: 'SAVE_CHECK_OPTS',\n    data\n  }\n}\n\n/* REDUCER */\nfunction optionsReducer(state = {}, action) {\n  const { type, data } = action\n\n  if (type === 'APP_OPTIONS')\n    return { ...state, app: { ...state.app, ...data } }\n\n  if (type === 'SAVE_SETTINGS') return { ...state, settings: data }\n\n  if (type === 'SAVE_CHECK_OPTS') return { ...state, check: data }\n\n  if (type === 'CHANGE_ANALYSE')\n    return { ...state, analyse: { ...state.analyse, ...data, loading: false } }\n\n  if (type === 'ANALYSE_LOADING')\n    return { ...state, analyse: { ...state.analyse, loading: true } }\n\n  if (recognizeActions.includes(type))\n    return { ...state, recognize: { ...state.recognize, ...data } }\n  return state\n}\n\nexport default optionsReducer\n","/****************************************************************************\n * Copyright 2021 EPAM Systems\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *    http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n ***************************************************************************/\n\n/* schema utils */\nfunction constant(schema, prop) {\n  const desc = schema.properties[prop]\n  return desc.constant || desc.enum[0] // see https://git.io/v6hyP\n}\n\nexport function mapOf(schema, prop) {\n  console.assert(schema.oneOf)\n  return schema.oneOf.reduce((res, desc) => {\n    res[constant(desc, prop)] = desc\n    return res\n  }, {})\n}\n\nexport function selectListOf(schema, prop) {\n  const desc = schema.properties && schema.properties[prop]\n  if (desc) {\n    return desc.enum.map((value, i) => {\n      const title = desc.enumNames && desc.enumNames[i]\n      return title ? { title, value } : value\n    })\n  }\n  return schema.oneOf.map(ds =>\n    !ds.title\n      ? constant(ds, prop)\n      : {\n          title: ds.title,\n          value: constant(ds, prop)\n        }\n  )\n}\n","/****************************************************************************\n * Copyright 2021 EPAM Systems\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *    http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n ***************************************************************************/\n\nimport { mapOf } from './schema-helper'\n\nconst radioButtonsSchema = {\n  enum: ['Absolute', 'Relative', 'Attached'],\n  default: 'Absolute'\n}\n\nconst contextSchema = {\n  title: 'Context',\n  enum: ['Fragment', 'Multifragment', 'Bond', 'Atom', 'Group'],\n  default: 'Fragment'\n}\n\nconst sData = {\n  Fragment: {\n    title: 'Fragment',\n    type: 'Object',\n    oneOf: [\n      {\n        key: 'FRG_STR',\n        title: 'MDLBG_FRAGMENT_STEREO',\n        properties: {\n          type: { enum: ['DAT'] },\n          fieldName: {\n            title: 'Field name',\n            enum: ['MDLBG_FRAGMENT_STEREO'],\n            default: 'MDLBG_FRAGMENT_STEREO'\n          },\n          fieldValue: {\n            title: 'Field value',\n            type: 'array',\n            items: {\n              enum: [\n                'abs',\n                '(+)-enantiomer',\n                '(-)-enantiomer',\n                'racemate',\n                'steric',\n                'rel',\n                'R(a)',\n                'S(a)',\n                'R(p)',\n                'S(p)'\n              ]\n            },\n            default: ['abs']\n          },\n          radiobuttons: radioButtonsSchema\n        },\n        required: ['fieldName', 'fieldValue', 'radiobuttons']\n      },\n      {\n        key: 'FRG_COEFF',\n        title: 'MDLBG_FRAGMENT_COEFFICIENT',\n        properties: {\n          type: { enum: ['DAT'] },\n          fieldName: {\n            title: 'Field name',\n            enum: ['MDLBG_FRAGMENT_COEFFICIENT'],\n            default: 'MDLBG_FRAGMENT_COEFFICIENT'\n          },\n          fieldValue: {\n            title: 'Field value',\n            type: 'string',\n            default: '',\n            minLength: 1,\n            invalidMessage: 'Please, specify field name'\n          },\n          radiobuttons: radioButtonsSchema\n        },\n        required: ['fieldName', 'fieldValue', 'radiobuttons']\n      },\n      {\n        key: 'FRG_CHRG',\n        title: 'MDLBG_FRAGMENT_CHARGE',\n        properties: {\n          type: { enum: ['DAT'] },\n          fieldName: {\n            title: 'Field name',\n            enum: ['MDLBG_FRAGMENT_CHARGE'],\n            default: 'MDLBG_FRAGMENT_CHARGE'\n          },\n          fieldValue: {\n            title: 'Field value',\n            type: 'string',\n            default: '',\n            minLength: 1,\n            invalidMessage: 'Please, specify field name'\n          },\n          radiobuttons: radioButtonsSchema\n        },\n        required: ['fieldName', 'fieldValue', 'radiobuttons']\n      },\n      {\n        key: 'FRG_RAD',\n        title: 'MDLBG_FRAGMENT_RADICALS',\n        properties: {\n          type: { enum: ['DAT'] },\n          fieldName: {\n            title: 'Field name',\n            enum: ['MDLBG_FRAGMENT_RADICALS'],\n            default: 'MDLBG_FRAGMENT_RADICALS'\n          },\n          fieldValue: {\n            title: 'Field value',\n            type: 'string',\n            default: '',\n            minLength: 1,\n            invalidMessage: 'Please, specify field name'\n          },\n          radiobuttons: radioButtonsSchema\n        },\n        required: ['fieldName', 'fieldValue', 'radiobuttons']\n      }\n    ]\n  },\n  Multifragment: {\n    title: 'Multifragment',\n    type: 'Object',\n    oneOf: [\n      {\n        key: 'MLT_FRG',\n        title: 'KETCHER_MULTIPLE_FRAGMENT',\n        properties: {\n          type: { enum: ['DAT'] },\n          fieldName: {\n            title: 'Field name',\n            enum: ['KETCHER_MULTIPLE_FRAGMENT'],\n            default: 'KETCHER_MULTIPLE_FRAGMENT'\n          },\n          fieldValue: {\n            title: 'Field value',\n            type: 'array',\n            items: {\n              enum: [\n                'aerosol',\n                'alloy',\n                'catenane',\n                'complex',\n                'composite',\n                'co-polymer',\n                'emulsion',\n                'host-guest complex',\n                'mixture',\n                'rotaxane',\n                'suspension'\n              ]\n            },\n            default: ['aerosol']\n          },\n          radiobuttons: radioButtonsSchema\n        },\n        required: ['fieldName', 'fieldValue', 'radiobuttons']\n      }\n    ]\n  },\n  Bond: {\n    title: 'Bond',\n    type: 'Object',\n    oneOf: [\n      {\n        key: 'SB_STR',\n        title: 'MDLBG_STEREO_KEY',\n        properties: {\n          type: { enum: ['DAT'] },\n          fieldName: {\n            title: 'Field name',\n            enum: ['MDLBG_STEREO_KEY'],\n            default: 'MDLBG_STEREO_KEY'\n          },\n          fieldValue: {\n            title: 'Field value',\n            type: 'array',\n            items: {\n              enum: [\n                'erythro',\n                'threo',\n                'alpha',\n                'beta',\n                'endo',\n                'exo',\n                'anti',\n                'syn',\n                'ECL',\n                'STG'\n              ]\n            },\n            default: ['erythro']\n          },\n          radiobuttons: radioButtonsSchema\n        },\n        required: ['fieldName', 'fieldValue', 'radiobuttons']\n      },\n      {\n        key: 'SB_BND',\n        title: 'MDLBG_BOND_KEY',\n        properties: {\n          type: { enum: ['DAT'] },\n          fieldName: {\n            title: 'Field name',\n            enum: ['MDLBG_BOND_KEY'],\n            default: 'MDLBG_BOND_KEY'\n          },\n          fieldValue: {\n            title: 'Field value',\n            type: 'array',\n            items: {\n              enum: ['Value=4']\n            },\n            default: ['Value=4']\n          },\n          radiobuttons: radioButtonsSchema\n        },\n        required: ['fieldName', 'fieldValue', 'radiobuttons']\n      }\n    ]\n  },\n  Atom: {\n    title: 'Atom',\n    type: 'Object',\n    oneOf: [\n      {\n        key: 'AT_STR',\n        title: 'MDLBG_STEREO_KEY',\n        properties: {\n          type: { enum: ['DAT'] },\n          fieldName: {\n            title: 'Field name',\n            enum: ['MDLBG_STEREO_KEY'],\n            default: 'MDLBG_STEREO_KEY'\n          },\n          fieldValue: {\n            title: 'Field value',\n            type: 'array',\n            items: {\n              enum: [\n                'RS',\n                'SR',\n                'P-3',\n                'P-3-PI',\n                'SP-4',\n                'SP-4-PI',\n                'T-4',\n                'T-4-PI',\n                'SP-5',\n                'SP-5-PI',\n                'TB-5',\n                'TB-5-PI',\n                'OC-6',\n                'TP-6',\n                'PB-7',\n                'CU-8',\n                'SA-8',\n                'DD-8',\n                'HB-9',\n                'TPS-9'\n              ]\n            },\n            default: ['RS']\n          },\n          radiobuttons: radioButtonsSchema\n        },\n        required: ['fieldName', 'fieldValue', 'radiobuttons']\n      }\n    ]\n  },\n  Group: {\n    title: 'Group',\n    type: 'Object',\n    oneOf: [\n      {\n        key: 'GRP_STR',\n        title: 'MDLBG_STEREO_KEY',\n        properties: {\n          type: { enum: ['DAT'] },\n          fieldName: {\n            title: 'Field name',\n            enum: ['MDLBG_STEREO_KEY'],\n            default: 'MDLBG_STEREO_KEY'\n          },\n          fieldValue: {\n            title: 'Field value',\n            type: 'array',\n            items: {\n              enum: ['cis', 'trans']\n            },\n            default: ['cis']\n          },\n          radiobuttons: radioButtonsSchema\n        },\n        required: ['fieldName', 'fieldValue', 'radiobuttons']\n      }\n    ]\n  }\n}\n\nexport const sdataCustomSchema = {\n  key: 'Custom',\n  properties: {\n    type: { enum: ['DAT'] },\n    context: {\n      title: 'Context',\n      enum: ['Fragment', 'Multifragment', 'Bond', 'Atom', 'Group'],\n      default: 'Fragment'\n    },\n    fieldName: {\n      title: 'Field name',\n      type: 'string',\n      default: '',\n      minLength: 1,\n      invalidMessage: 'Please, specify field name'\n    },\n    fieldValue: {\n      title: 'Field value',\n      type: 'string',\n      default: '',\n      minLength: 1,\n      invalidMessage: 'Please, specify field value'\n    },\n    radiobuttons: {\n      enum: ['Absolute', 'Relative', 'Attached'],\n      default: 'Absolute'\n    }\n  },\n  required: ['context', 'fieldName', 'fieldValue', 'radiobuttons']\n}\n\nexport const sdataSchema = Object.keys(sData).reduce((acc, title) => {\n  acc[title] = mapOf(sData[title], 'fieldName')\n  Object.keys(acc[title]).forEach(fieldName => {\n    acc[title][fieldName].properties.context = contextSchema\n  })\n  return acc\n}, {})\n\n/**\n * Returns first key of passed object\n * @param obj { object }\n */\nfunction firstKeyOf(obj) {\n  return Object.keys(obj)[0]\n}\n\n/**\n * Returns schema default values. Depends on passed arguments:\n * pass schema only -> returns default context\n * pass schema & context -> returns default fieldName\n * pass schema & context & fieldName -> returns default fieldValue\n * @param context? { string }\n * @param fieldName? { string }\n * @returns { string }\n */\nexport function getSdataDefault(context, fieldName) {\n  if (!context && !fieldName) return firstKeyOf(sdataSchema)\n\n  if (!fieldName) return firstKeyOf(sdataSchema[context])\n\n  return sdataSchema[context][fieldName]\n    ? sdataSchema[context][fieldName].properties.fieldValue.default\n    : ''\n}\n","/****************************************************************************\n * Copyright 2021 EPAM Systems\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *    http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n ***************************************************************************/\n\nimport { getSdataDefault, sdataSchema } from '../../data/schema/sdata-schema'\n\nexport const initSdata = () => {\n  const context = getSdataDefault()\n  const fieldName = getSdataDefault(context)\n  const fieldValue = getSdataDefault(context, fieldName)\n  const radiobuttons = 'Absolute'\n\n  return {\n    errors: {},\n    valid: true,\n    result: {\n      context,\n      fieldName,\n      fieldValue,\n      radiobuttons,\n      type: 'DAT'\n    }\n  }\n}\n\nexport function sdataReducer(state, action) {\n  if (action.data.result.init) {\n    return correctErrors(\n      {\n        ...state,\n        result: Object.assign({}, state.result, action.data.result)\n      },\n      action.data\n    )\n  }\n\n  const actionContext = action.data.result.context\n  const actionFieldName = action.data.result.fieldName\n\n  let newstate = null\n\n  if (actionContext !== state.result.context)\n    newstate = onContextChange(state, action.data.result)\n  else if (actionFieldName !== state.result.fieldName)\n    newstate = onFieldNameChange(state, action.data.result)\n\n  newstate = newstate || {\n    ...state,\n    result: Object.assign({}, state.result, action.data.result)\n  }\n\n  return correctErrors(newstate, action.data)\n}\n\nconst correctErrors = (state, payload) => {\n  const { valid, errors } = payload\n  const { fieldName, fieldValue } = state.result\n\n  return {\n    result: state.result,\n    valid: valid && !!fieldName && !!fieldValue,\n    errors\n  }\n}\n\nconst onContextChange = (state, payload) => {\n  const { context, fieldValue } = payload\n\n  const fieldName = getSdataDefault(context)\n\n  let fValue = fieldValue\n  if (fValue === state.result.fieldValue)\n    fValue = getSdataDefault(context, fieldName)\n\n  return {\n    result: {\n      ...payload,\n      context,\n      fieldName,\n      fieldValue: fValue\n    }\n  }\n}\n\nconst onFieldNameChange = (state, payload) => {\n  const { fieldName } = payload\n\n  const context = state.result.context\n\n  let fieldValue = payload.fieldValue\n\n  if (sdataSchema[context][fieldName])\n    fieldValue = getSdataDefault(context, fieldName)\n\n  if (\n    fieldValue === state.result.fieldValue &&\n    sdataSchema[context][state.result.fieldName]\n  )\n    fieldValue = ''\n\n  return {\n    result: {\n      ...payload,\n      fieldName,\n      fieldValue\n    }\n  }\n}\n","/****************************************************************************\n * Copyright 2021 EPAM Systems\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *    http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n ***************************************************************************/\n\nimport { initSdata, sdataReducer } from './sdata'\n\nimport { getDefaultOptions } from '../../data/schema/options-schema'\n\nexport const formsState = {\n  // TODO: create from schema.{smth}.defaultValue\n  // TODO: change validation method, no 'valid:true' props as default\n  atomProps: {\n    errors: {},\n    valid: true,\n    result: {\n      label: '',\n      charge: 0,\n      explicitValence: -1,\n      hCount: 0,\n      invRet: 0,\n      isotope: 0,\n      radical: 0,\n      ringBondCount: 0,\n      substitutionCount: 0\n    }\n  },\n  attachmentPoints: {\n    errors: {},\n    valid: true,\n    result: {\n      primary: false,\n      secondary: false\n    }\n  },\n  automap: {\n    errors: {},\n    valid: true,\n    result: {\n      mode: 'discard'\n    }\n  },\n  bondProps: {\n    errors: {},\n    valid: true,\n    result: {\n      type: 'single',\n      topology: 0,\n      center: 0\n    }\n  },\n  check: {\n    errors: {},\n    moleculeErrors: {}\n  },\n  labelEdit: {\n    errors: {},\n    valid: true,\n    result: {\n      label: ''\n    }\n  },\n  rgroup: {\n    errors: {},\n    valid: true,\n    result: {\n      values: []\n    }\n  },\n  rgroupLogic: {\n    errors: {},\n    valid: true,\n    result: {\n      ifthen: 0,\n      range: '>0',\n      resth: false\n    }\n  },\n  save: {\n    errors: {},\n    valid: true,\n    result: {\n      filename: 'ketcher',\n      format: 'mol'\n    }\n  },\n  settings: {\n    errors: {},\n    valid: true,\n    result: getDefaultOptions()\n  },\n  sgroup: {\n    errors: {},\n    valid: true,\n    result: {\n      type: 'GEN'\n    }\n  },\n  text: {\n    errors: {},\n    valid: true,\n    result: {}\n  },\n  attach: {\n    errors: {},\n    valid: true,\n    result: {}\n  },\n  sdata: initSdata()\n}\n\nexport function updateFormState(data) {\n  return {\n    type: 'UPDATE_FORM',\n    data\n  }\n}\n\nexport function checkErrors(errors) {\n  return {\n    type: 'UPDATE_FORM',\n    data: { moleculeErrors: errors }\n  }\n}\n\nexport function setDefaultSettings() {\n  return {\n    type: 'UPDATE_FORM',\n    data: {\n      result: getDefaultOptions(),\n      valid: true,\n      errors: {}\n    }\n  }\n}\n\nexport function formReducer(state, action, formName) {\n  if (formName === 'sdata') return sdataReducer(state, action)\n\n  return Object.assign({}, state, action.data)\n}\n","/****************************************************************************\n * Copyright 2021 EPAM Systems\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *    http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n ***************************************************************************/\n\nexport const INDIGO_VERIFICATION = 'INDIGO_VERIFICATION'\n\nexport interface RequestState {\n  indigoVerification: boolean\n}\n\ninterface IndigoVerificationAction {\n  type: typeof INDIGO_VERIFICATION\n  data: boolean\n}\n\nexport type RequestActionTypes = IndigoVerificationAction\n","/****************************************************************************\n * Copyright 2021 EPAM Systems\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *    http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n ***************************************************************************/\n\nimport {\n  INDIGO_VERIFICATION,\n  RequestActionTypes,\n  RequestState\n} from './request.types'\n\nexport function indigoVerification(data: boolean): RequestActionTypes {\n  return {\n    type: INDIGO_VERIFICATION,\n    data\n  }\n}\n\nconst initialState = {\n  indigoVerification: false\n}\n\nexport default function (\n  state = initialState,\n  action: RequestActionTypes\n): RequestState {\n  const { type, data } = action\n\n  switch (type) {\n    case INDIGO_VERIFICATION: {\n      return {\n        ...state,\n        indigoVerification: data\n      }\n    }\n    default:\n      return state\n  }\n}\n","/****************************************************************************\n * Copyright 2021 EPAM Systems\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *    http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n ***************************************************************************/\n\nexport const supportedSGroupTypes = {\n  MUL: 'MUL',\n  SRU: 'SRU',\n  SUP: 'SUP',\n  DAT: 'DAT',\n  GEN: 'GEN'\n}\n","/****************************************************************************\n * Copyright 2021 EPAM Systems\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *    http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n ***************************************************************************/\n\nimport { mapOf } from './schema-helper'\nimport { range } from 'lodash/fp'\n\nexport const atom = {\n  title: 'Atom',\n  type: 'object',\n  required: 'label',\n  properties: {\n    label: {\n      title: 'Label',\n      type: 'string', // TODO:should really be enum of elements\n      maxLength: 3,\n      invalidMessage: 'Wrong label'\n    },\n    alias: {\n      title: 'Alias',\n      type: 'string',\n      invalidMessage: 'Leading and trailing spaces are not allowed'\n    },\n    charge: {\n      title: 'Charge',\n      type: 'string',\n      pattern: /^([+-]?)(\\d{1,3}|1000)([+-]?)$/,\n      maxLength: 5,\n      default: '0',\n      invalidMessage: 'Invalid charge value'\n    },\n    explicitValence: {\n      title: 'Valence',\n      enum: [-1, 0, 1, 2, 3, 4, 5, 6, 7, 8],\n      enumNames: ['', '0', 'I', 'II', 'III', 'IV', 'V', 'VI', 'VII', 'VIII'],\n      default: -1\n    },\n    isotope: {\n      title: 'Isotope',\n      type: 'integer',\n      minimum: 0,\n      default: 0,\n      invalidMessage: 'There must be integer'\n    },\n    radical: {\n      title: 'Radical',\n      enum: [0, 2, 1, 3],\n      enumNames: [\n        '',\n        'Monoradical',\n        'Diradical (singlet)',\n        'Diradical (triplet)'\n      ],\n      default: 0\n    },\n    ringBondCount: {\n      title: 'Ring bond count',\n      enum: [0, -2, -1, 2, 3, 4],\n      enumNames: ['', 'As drawn', '0', '2', '3', '4'],\n      default: 0\n    },\n    hCount: {\n      title: 'H count',\n      enum: [0, 1, 2, 3, 4, 5],\n      enumNames: ['', '0', '1', '2', '3', '4'],\n      default: 0\n    },\n    substitutionCount: {\n      title: 'Substitution count',\n      enum: [0, -2, -1, 1, 2, 3, 4, 5, 6],\n      enumNames: ['', 'As drawn', '0', '1', '2', '3', '4', '5', '6'],\n      default: 0\n    },\n    unsaturatedAtom: {\n      title: 'Unsaturated',\n      type: 'boolean',\n      default: false\n    },\n    invRet: {\n      title: 'Inversion',\n      enum: [0, 1, 2],\n      enumNames: ['', 'Inverts', 'Retains'],\n      default: 0\n    },\n    exactChangeFlag: {\n      title: 'Exact change',\n      type: 'boolean',\n      default: false\n    }\n  }\n}\n\nexport const rgroupSchema = {\n  title: 'R-group',\n  type: 'object',\n  properties: {\n    values: {\n      type: 'array',\n      items: {\n        type: 'string',\n        enum: range(1, 33),\n        enumNames: range(1, 33).map(item => 'R' + item)\n      }\n    }\n  }\n}\n\nexport const labelEdit = {\n  title: 'Label Edit',\n  type: 'object',\n  required: ['label'],\n  properties: {\n    label: {\n      title: 'Atom',\n      default: '',\n      invalidMessage: 'Wrong atom symbol'\n    }\n  }\n}\n\nexport const attachmentPoints = {\n  title: 'Attachment Points',\n  type: 'object',\n  properties: {\n    primary: {\n      title: 'Primary attachment point',\n      type: 'boolean'\n    },\n    secondary: {\n      title: 'Secondary attachment point',\n      type: 'boolean'\n    }\n  }\n}\n\nexport const bond = {\n  title: 'Bond',\n  type: 'object',\n  required: ['type'],\n  properties: {\n    type: {\n      title: 'Type',\n      enum: [\n        'single',\n        'up',\n        'down',\n        'updown',\n        'double',\n        'crossed',\n        'triple',\n        'aromatic',\n        'any',\n        'hydrogen',\n        'singledouble',\n        'singlearomatic',\n        'doublearomatic',\n        'dative'\n      ],\n      enumNames: [\n        'Single',\n        'Single Up',\n        'Single Down',\n        'Single Up/Down',\n        'Double',\n        'Double Cis/Trans',\n        'Triple',\n        'Aromatic',\n        'Any',\n        'Hydrogen',\n        'Single/Double',\n        'Single/Aromatic',\n        'Double/Aromatic',\n        'Dative'\n      ],\n      default: 'single'\n    },\n    topology: {\n      title: 'Topology',\n      enum: [0, 1, 2],\n      enumNames: ['Either', 'Ring', 'Chain'],\n      default: 0\n    },\n    center: {\n      title: 'Reacting Center',\n      enum: [0, -1, 1, 2, 4, 8, 12], // 5, 9, 13\n      enumNames: [\n        'Unmarked',\n        'Not center',\n        'Center',\n        'No change',\n        'Made/broken',\n        'Order changes',\n        'Made/broken and changes'\n      ], // \"Order changes\" x 3\n      default: 0\n    }\n  }\n}\n\nconst sgroup = {\n  title: 'SGroup',\n  type: 'object',\n  required: ['type'],\n  oneOf: [\n    {\n      key: 'GEN',\n      title: 'Generic',\n      properties: {\n        type: { enum: ['GEN'] }\n      }\n    },\n    {\n      key: 'MUL',\n      title: 'Multiple group',\n      type: 'object',\n      properties: {\n        type: { enum: ['MUL'] },\n        mul: {\n          title: 'Repeat count',\n          type: 'integer',\n          default: 1,\n          minimum: 1,\n          maximum: 1000,\n          invalidMessage: 'Value out of range: must be between 1 and 1000'\n        }\n      },\n      required: ['mul']\n    },\n    {\n      key: 'SRU',\n      title: 'SRU polymer',\n      properties: {\n        type: { enum: ['SRU'] },\n        subscript: {\n          title: 'Polymer label',\n          type: 'string',\n          default: 'n',\n          pattern: /^[a-zA-Z]$/,\n          invalidMessage: 'SRU subscript should consist of a single letter'\n        },\n        connectivity: {\n          title: 'Repeat Pattern',\n          enum: ['ht', 'hh', 'eu'],\n          enumNames: ['Head-to-tail', 'Head-to-head', 'Either unknown'],\n          default: 'ht'\n        }\n      },\n      required: ['subscript', 'connectivity']\n    },\n    {\n      key: 'SUP',\n      title: 'Superatom',\n      properties: {\n        type: { enum: ['SUP'] },\n        name: {\n          title: 'Name',\n          type: 'string',\n          default: '',\n          minLength: 1,\n          invalidMessage: 'Please, provide a name for the superatom'\n        }\n      },\n      required: ['name']\n    }\n  ]\n}\nexport const sgroupMap = mapOf(sgroup, 'type')\n\nexport const rgroupLogic = {\n  title: 'R-Group',\n  type: 'object',\n  properties: {\n    range: {\n      title: 'Occurrence',\n      type: 'string',\n      maxLength: 50,\n      invalidMessage: 'Wrong value'\n    },\n    resth: {\n      title: 'RestH',\n      type: 'boolean'\n    },\n    ifthen: {\n      title: 'Condition',\n      type: 'integer',\n      minium: 0\n    }\n  }\n}\n\nexport const textSchema = {\n  title: 'Text Edit',\n  type: 'object',\n  required: ['label'],\n  properties: {\n    label: {\n      default: '',\n      type: 'string'\n    }\n  }\n}\n\nexport const attachSchema = {\n  title: 'Template Edit',\n  type: 'object',\n  required: ['name'],\n  properties: {\n    name: {\n      title: 'Template name',\n      type: 'string',\n      minLength: 1,\n      maxLength: 128,\n      invalidMessage:\n        'Template must have a unique name and no more than 128 symbols in length'\n    }\n  }\n}\n","/****************************************************************************\n * Copyright 2021 EPAM Systems\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *    http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n ***************************************************************************/\n\nimport { AtomList, Bond, Elements, StereoLabel } from 'ketcher-core'\n\nimport { atom as atomSchema } from '../schema/struct-schema'\nimport { capitalize } from 'lodash/fp'\nimport { sdataSchema } from '../schema/sdata-schema'\n\nconst DefaultStereoGroupNumber = 1\n\nexport function fromElement(selem) {\n  if (selem.label === 'R#') {\n    return {\n      type: 'rlabel',\n      values: fromRlabel(selem.rglabel),\n      ...selem\n    }\n  }\n  if (selem.label === 'L#') return fromAtomList(selem)\n\n  if (Elements.get(selem.label)) return fromAtom(selem)\n\n  if (!selem.label && 'attpnt' in selem) return { ap: fromApoint(selem.attpnt) }\n\n  return selem // probably generic\n}\n\nexport function toElement(elem) {\n  if (elem.type === 'rlabel') {\n    return {\n      label: elem.values.length ? 'R#' : 'C',\n      rglabel: elem.values.length === 0 ? null : toRlabel(elem.values)\n    }\n  }\n  if (elem.type === 'list' || elem.type === 'not-list') return toAtomList(elem)\n\n  if (!elem.label && 'ap' in elem) return { attpnt: toApoint(elem.ap) }\n\n  if (Elements.get(capitalize(elem.label))) return toAtom(elem)\n\n  if (\n    elem.label === 'A' ||\n    elem.label === '*' ||\n    elem.label === 'Q' ||\n    elem.label === 'X' ||\n    elem.label === 'R'\n  ) {\n    elem.pseudo = elem.label\n    return toAtom(elem)\n  }\n\n  return elem\n}\n\nfunction fromAtom(satom) {\n  const alias = satom.alias || ''\n  const charge = satom.charge.toString()\n\n  return {\n    alias,\n    label: satom.label,\n    charge,\n    isotope: satom.isotope,\n    explicitValence: satom.explicitValence,\n    radical: satom.radical,\n    invRet: satom.invRet,\n    exactChangeFlag: !!satom.exactChangeFlag,\n    ringBondCount: satom.ringBondCount,\n    substitutionCount: satom.substitutionCount,\n    unsaturatedAtom: !!satom.unsaturatedAtom,\n    hCount: satom.hCount,\n    stereoParity: satom.stereoParity\n  }\n}\n\nfunction toAtom(atom) {\n  // TODO merge this to Atom.attrlist?\n  //      see ratomtool\n  const chargeRegexp = atomSchema.properties.charge.pattern\n  const pch = chargeRegexp.exec(atom.charge)\n  const charge = pch ? parseInt(pch[1] + pch[3] + pch[2]) : atom.charge\n\n  const conv = Object.assign({}, atom, {\n    label: capitalize(atom.label),\n    alias: atom.alias || null\n  })\n  if (charge !== undefined) conv.charge = charge\n  return conv\n}\n\nfunction fromAtomList(satom) {\n  return {\n    type: satom.atomList.notList ? 'not-list' : 'list',\n    values: satom.atomList.ids.map(i => Elements.get(i).label)\n  }\n}\n\nfunction toAtomList(atom) {\n  return {\n    pseudo: null,\n    label: 'L#',\n    atomList: new AtomList({\n      notList: atom.type === 'not-list',\n      ids: atom.values.map(el => Elements.get(el).number)\n    })\n  }\n}\n\nexport function fromStereoLabel(stereoLabel) {\n  if (stereoLabel === null) return { type: null }\n  const type = stereoLabel.match(/\\D+/g)[0]\n  const number = +stereoLabel.replace(type, '')\n\n  if (type === StereoLabel.Abs) {\n    return {\n      type: stereoLabel,\n      orNumber: DefaultStereoGroupNumber,\n      andNumber: DefaultStereoGroupNumber\n    }\n  }\n\n  if (type === StereoLabel.And) {\n    return {\n      type: type,\n      orNumber: DefaultStereoGroupNumber,\n      andNumber: number\n    }\n  }\n\n  if (type === StereoLabel.Or) {\n    return {\n      type: type,\n      orNumber: number,\n      andNumber: DefaultStereoGroupNumber\n    }\n  }\n}\n\nexport function toStereoLabel(stereoLabel) {\n  switch (stereoLabel.type) {\n    case StereoLabel.And:\n      return `${StereoLabel.And}${stereoLabel.andNumber || 1}`\n\n    case StereoLabel.Or:\n      return `${StereoLabel.Or}${stereoLabel.orNumber || 1}`\n\n    default:\n      return stereoLabel.type\n  }\n}\n\nfunction fromApoint(sap) {\n  return {\n    primary: ((sap || 0) & 1) > 0,\n    secondary: ((sap || 0) & 2) > 0\n  }\n}\n\nfunction toApoint(ap) {\n  return (ap.primary && 1) + (ap.secondary && 2)\n}\n\nfunction fromRlabel(rg) {\n  const res = []\n  let rgi\n  let val\n  for (rgi = 0; rgi < 32; rgi++) {\n    if (rg & (1 << rgi)) {\n      val = rgi + 1\n      res.push(val) // push the string\n    }\n  }\n  return res\n}\n\nfunction toRlabel(values) {\n  let res = 0\n  values.forEach(val => {\n    const rgi = val - 1\n    res |= 1 << rgi\n  })\n  return res\n}\n\nexport function fromBond(sbond) {\n  const type = sbond.type\n  const stereo = sbond.stereo\n  return {\n    type: fromBondType(type, stereo),\n    topology: sbond.topology || 0,\n    center: sbond.reactingCenterStatus || 0\n  }\n}\n\nexport function toBond(bond) {\n  return {\n    topology: bond.topology,\n    reactingCenterStatus: bond.center,\n    ...toBondType(bond.type)\n  }\n}\n\nexport function toBondType(caption) {\n  return Object.assign({}, bondCaptionMap[caption])\n}\n\nfunction fromBondType(type, stereo) {\n  for (const caption in bondCaptionMap) {\n    if (\n      bondCaptionMap[caption].type === type &&\n      bondCaptionMap[caption].stereo === stereo\n    )\n      return caption\n  }\n  throw Error('No such bond caption')\n}\n\nconst bondCaptionMap = {\n  single: {\n    type: Bond.PATTERN.TYPE.SINGLE,\n    stereo: Bond.PATTERN.STEREO.NONE\n  },\n  up: {\n    type: Bond.PATTERN.TYPE.SINGLE,\n    stereo: Bond.PATTERN.STEREO.UP\n  },\n  down: {\n    type: Bond.PATTERN.TYPE.SINGLE,\n    stereo: Bond.PATTERN.STEREO.DOWN\n  },\n  updown: {\n    type: Bond.PATTERN.TYPE.SINGLE,\n    stereo: Bond.PATTERN.STEREO.EITHER\n  },\n  double: {\n    type: Bond.PATTERN.TYPE.DOUBLE,\n    stereo: Bond.PATTERN.STEREO.NONE\n  },\n  crossed: {\n    type: Bond.PATTERN.TYPE.DOUBLE,\n    stereo: Bond.PATTERN.STEREO.CIS_TRANS\n  },\n  triple: {\n    type: Bond.PATTERN.TYPE.TRIPLE,\n    stereo: Bond.PATTERN.STEREO.NONE\n  },\n  aromatic: {\n    type: Bond.PATTERN.TYPE.AROMATIC,\n    stereo: Bond.PATTERN.STEREO.NONE\n  },\n  singledouble: {\n    type: Bond.PATTERN.TYPE.SINGLE_OR_DOUBLE,\n    stereo: Bond.PATTERN.STEREO.NONE\n  },\n  singlearomatic: {\n    type: Bond.PATTERN.TYPE.SINGLE_OR_AROMATIC,\n    stereo: Bond.PATTERN.STEREO.NONE\n  },\n  doublearomatic: {\n    type: Bond.PATTERN.TYPE.DOUBLE_OR_AROMATIC,\n    stereo: Bond.PATTERN.STEREO.NONE\n  },\n  any: {\n    type: Bond.PATTERN.TYPE.ANY,\n    stereo: Bond.PATTERN.STEREO.NONE\n  },\n  hydrogen: {\n    type: Bond.PATTERN.TYPE.HYDROGEN,\n    stereo: Bond.PATTERN.STEREO.NONE\n  },\n  dative: {\n    type: Bond.PATTERN.TYPE.DATIVE,\n    stereo: Bond.PATTERN.STEREO.NONE\n  }\n}\n\nexport function fromSgroup(ssgroup) {\n  const type = ssgroup.type || 'GEN'\n  const { context, fieldName, fieldValue, absolute, attached } = ssgroup.attrs\n\n  if (absolute === false && attached === false)\n    ssgroup.attrs.radiobuttons = 'Relative'\n  else ssgroup.attrs.radiobuttons = attached ? 'Attached' : 'Absolute'\n\n  if (\n    sdataSchema[context][fieldName] &&\n    sdataSchema[context][fieldName].properties.fieldValue.items\n  )\n    ssgroup.attrs.fieldValue = fieldValue.split('\\n')\n\n  return Object.assign({ type }, ssgroup.attrs)\n}\n\nexport function toSgroup(sgroup) {\n  const { type, radiobuttons, ...props } = sgroup\n  const attrs = { ...props }\n\n  const absolute = 'absolute'\n  const attached = 'attached'\n\n  switch (radiobuttons) {\n    case 'Absolute':\n      attrs[absolute] = true\n      attrs[attached] = false\n      break\n    case 'Attached':\n      attrs[absolute] = false\n      attrs[attached] = true\n      break\n    case 'Relative':\n      attrs[absolute] = false\n      attrs[attached] = false\n      break\n    default:\n      break\n  }\n\n  if (attrs.fieldName) attrs.fieldName = attrs.fieldName.trim()\n\n  if (attrs.fieldValue) {\n    attrs.fieldValue =\n      typeof attrs.fieldValue === 'string'\n        ? attrs.fieldValue.trim()\n        : attrs.fieldValue\n  }\n\n  return {\n    type,\n    attrs\n  }\n}\n","/****************************************************************************\n * Copyright 2021 EPAM Systems\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *    http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n ***************************************************************************/\n\nimport { RxnArrowMode, SimpleObjectMode } from 'ketcher-core'\n\nimport { bond as bondSchema } from '../data/schema/struct-schema'\nimport isHidden from './isHidden'\nimport { toBondType } from '../data/convert/structconv'\n\nconst toolActions = {\n  'select-lasso': {\n    title: 'Lasso Selection',\n    shortcut: 'Escape',\n    action: { tool: 'select', opts: 'lasso' }\n  },\n  'select-rectangle': {\n    title: 'Rectangle Selection',\n    shortcut: 'Escape',\n    action: { tool: 'select', opts: 'rectangle' },\n    hidden: options => isHidden(options, 'select-rectangle')\n  },\n  'select-fragment': {\n    title: 'Fragment Selection',\n    shortcut: 'Escape',\n    action: { tool: 'select', opts: 'fragment' },\n    hidden: options => isHidden(options, 'select-fragment')\n  },\n  erase: {\n    title: 'Erase',\n    shortcut: ['Delete', 'Backspace'],\n    action: { tool: 'eraser', opts: 1 }, // TODO last selector mode is better\n    hidden: options => isHidden(options, 'erase')\n  },\n  chain: {\n    title: 'Chain',\n    action: { tool: 'chain' },\n    hidden: options => isHidden(options, 'chain')\n  },\n  'enhanced-stereo': {\n    shortcut: 'Alt+e',\n    title: 'Stereochemistry',\n    action: { tool: 'enhancedStereo' },\n    hidden: options => isHidden(options, 'enhanced-stereo')\n  },\n  'charge-plus': {\n    shortcut: '5',\n    title: 'Charge Plus',\n    action: { tool: 'charge', opts: 1 },\n    hidden: options => isHidden(options, 'charge-plus')\n  },\n  'charge-minus': {\n    shortcut: '5',\n    title: 'Charge Minus',\n    action: { tool: 'charge', opts: -1 },\n    hidden: options => isHidden(options, 'charge-minus')\n  },\n  transforms: {\n    hidden: options => isHidden(options, 'transforms')\n  },\n  'transform-rotate': {\n    shortcut: 'Alt+r',\n    title: 'Rotate Tool',\n    action: { tool: 'rotate' },\n    hidden: options => isHidden(options, 'transform-rotate')\n  },\n  'transform-flip-h': {\n    shortcut: 'Alt+h',\n    title: 'Horizontal Flip',\n    action: { tool: 'rotate', opts: 'horizontal' },\n    hidden: options => isHidden(options, 'transform-flip-h')\n  },\n  'transform-flip-v': {\n    shortcut: 'Alt+v',\n    title: 'Vertical Flip',\n    action: { tool: 'rotate', opts: 'vertical' },\n    hidden: options => isHidden(options, 'transform-flip-v')\n  },\n  sgroup: {\n    shortcut: 'Mod+g',\n    title: 'S-Group',\n    action: { tool: 'sgroup' },\n    hidden: options => isHidden(options, 'sgroup')\n  },\n  'sgroup-data': {\n    shortcut: 'Mod+g',\n    title: 'Data S-Group',\n    action: { tool: 'sgroup', opts: 'DAT' },\n    hidden: options => isHidden(options, 'sgroup-data')\n  },\n  arrows: {\n    hidden: options => isHidden(options, 'arrows')\n  },\n  'reaction-arrow-open-angle': {\n    title: 'Arrow Open Angle Tool',\n    action: { tool: 'reactionarrow', opts: RxnArrowMode.OpenAngle },\n    hidden: options => isHidden(options, 'reaction-arrow-open-angle')\n  },\n  'reaction-arrow-filled-triangle': {\n    title: 'Arrow Filled Triangle',\n    action: { tool: 'reactionarrow', opts: RxnArrowMode.FilledTriangle },\n    hidden: options => isHidden(options, 'reaction-arrow-filled-triangle')\n  },\n  'reaction-arrow-filled-bow': {\n    title: 'Arrow Filled Bow Tool',\n    action: { tool: 'reactionarrow', opts: RxnArrowMode.FilledBow },\n    hidden: options => isHidden(options, 'reaction-arrow-filled-bow')\n  },\n  'reaction-arrow-dashed-open-angle': {\n    title: 'Arrow Dashed Open Angle Tool',\n    action: { tool: 'reactionarrow', opts: RxnArrowMode.DashedOpenAngle },\n    hidden: options => isHidden(options, 'reaction-arrow-dashed-open-angle')\n  },\n  'reaction-arrow-failed': {\n    title: 'Failed Arrow Tool',\n    action: { tool: 'reactionarrow', opts: RxnArrowMode.Failed },\n    hidden: options => isHidden(options, 'reaction-arrow-failed')\n  },\n  'reaction-arrow-both-ends-filled-triangle': {\n    title: 'Arrow Both Ends Filled Triangle Tool',\n    action: {\n      tool: 'reactionarrow',\n      opts: RxnArrowMode.BothEndsFilledTriangle\n    },\n    hidden: options =>\n      isHidden(options, 'reaction-arrow-both-ends-filled-triangle')\n  },\n  'reaction-arrow-equilibrium-filled-half-bow': {\n    title: 'Arrow Equilibrium Filled Half Bow Tool',\n    action: {\n      tool: 'reactionarrow',\n      opts: RxnArrowMode.EquilibriumFilledHalfBow\n    },\n    hidden: options =>\n      isHidden(options, 'reaction-arrow-equilibrium-filled-half-bow')\n  },\n  'reaction-arrow-equilibrium-filled-triangle': {\n    title: 'Arrow Equilibrium Filled Triangle Tool',\n    action: {\n      tool: 'reactionarrow',\n      opts: RxnArrowMode.EquilibriumFilledTriangle\n    },\n    hidden: options =>\n      isHidden(options, 'reaction-arrow-equilibrium-filled-triangle')\n  },\n  'reaction-arrow-equilibrium-open-angle': {\n    title: 'Arrow Equilibrium Open Angle Tool',\n    action: { tool: 'reactionarrow', opts: RxnArrowMode.EquilibriumOpenAngle },\n    hidden: options =>\n      isHidden(options, 'reaction-arrow-equilibrium-open-angle')\n  },\n  'reaction-arrow-unbalanced-equilibrium-filled-half-bow': {\n    title: 'Arrow Unbalanced Equilibrium Filled Half Bow Tool',\n    action: {\n      tool: 'reactionarrow',\n      opts: RxnArrowMode.UnbalancedEquilibriumFilledHalfBow\n    },\n    hidden: options =>\n      isHidden(options, 'reaction-arrow-unbalanced-equilibrium-filled-half-bow')\n  },\n  'reaction-arrow-unbalanced-equilibrium-open-half-angle': {\n    title: 'Arrow Unbalanced Equilibrium Open Half Angle Tool',\n    action: {\n      tool: 'reactionarrow',\n      opts: RxnArrowMode.UnbalancedEquilibriumOpenHalfAngle\n    },\n    hidden: options =>\n      isHidden(options, 'reaction-arrow-unbalanced-equilibrium-open-half-angle')\n  },\n  'reaction-arrow-unbalanced-equilibrium-large-filled-half-bow': {\n    title: 'Arrow Unbalanced Equilibrium Large Filled Half Bow Tool',\n    action: {\n      tool: 'reactionarrow',\n      opts: RxnArrowMode.UnbalancedEquilibriumLargeFilledHalfBow\n    },\n    hidden: options =>\n      isHidden(\n        options,\n        'reaction-arrow-unbalanced-equilibrium-large-filled-half-bow'\n      )\n  },\n  'reaction-arrow-unbalanced-equilibrium-filled-half-triangle': {\n    title: 'Arrow Unbalanced Equilibrium Filled Half Triangle Tool',\n    action: {\n      tool: 'reactionarrow',\n      opts: RxnArrowMode.UnbalancedEquilibriumFilleHalfTriangle\n    },\n    hidden: options =>\n      isHidden(\n        options,\n        'reaction-arrow-unbalanced-equilibrium-filled-half-triangle'\n      )\n  },\n  'reaction-plus': {\n    title: 'Reaction Plus Tool',\n    action: { tool: 'reactionplus' },\n    hidden: options => isHidden(options, 'reaction-plus')\n  },\n  'reaction-mapping-tools': {\n    hidden: options => isHidden(options, 'reaction-mapping-tools')\n  },\n  'reaction-map': {\n    title: 'Reaction Mapping Tool',\n    action: { tool: 'reactionmap' },\n    hidden: options => isHidden(options, 'reaction-map')\n  },\n  'reaction-unmap': {\n    title: 'Reaction Unmapping Tool',\n    action: { tool: 'reactionunmap' },\n    hidden: options => isHidden(options, 'reaction-unmap')\n  },\n  rgroup: {\n    hidden: options => isHidden(options, 'rgroup')\n  },\n  'rgroup-label': {\n    shortcut: 'Mod+r',\n    title: 'R-Group Label Tool',\n    action: { tool: 'rgroupatom' },\n    hidden: options => isHidden(options, 'rgroup-label')\n  },\n  'rgroup-fragment': {\n    shortcut: ['Mod+Shift+r', 'Mod+r'],\n    title: 'R-Group Fragment Tool',\n    action: { tool: 'rgroupfragment' },\n    hidden: options => isHidden(options, 'rgroup-fragment')\n  },\n  'rgroup-attpoints': {\n    shortcut: 'Mod+r',\n    title: 'Attachment Point Tool',\n    action: { tool: 'apoint' },\n    hidden: options => isHidden(options, 'rgroup-attpoints')\n  },\n  shapes: {\n    hidden: options => isHidden(options, 'shapes')\n  },\n  'shape-ellipse': {\n    title: 'Shape Ellipse',\n    action: { tool: 'simpleobject', opts: SimpleObjectMode.ellipse },\n    hidden: options => isHidden(options, 'shape-ellipse')\n  },\n  'shape-rectangle': {\n    title: 'Shape Rectangle',\n    action: { tool: 'simpleobject', opts: SimpleObjectMode.rectangle },\n    hidden: options => isHidden(options, 'shape-rectangle')\n  },\n  'shape-line': {\n    title: 'Shape Line',\n    action: { tool: 'simpleobject', opts: SimpleObjectMode.line },\n    hidden: options => isHidden(options, 'shape-line')\n  },\n  text: {\n    title: 'Add text',\n    action: { tool: 'text' },\n    hidden: options => isHidden(options, 'text')\n  },\n  bonds: {\n    hidden: options => isHidden(options, 'bonds')\n  }\n}\n\nconst bondCuts = {\n  single: '1',\n  double: '2',\n  triple: '3',\n  up: '1',\n  down: '1',\n  updown: '1',\n  crossed: '2',\n  any: '0',\n  aromatic: '4'\n}\n\nconst typeSchema = bondSchema.properties.type\n\nexport default typeSchema.enum.reduce((res, type, i) => {\n  res[`bond-${type}`] = {\n    title: `${typeSchema.enumNames[i]} Bond`,\n    shortcut: bondCuts[type],\n    action: {\n      tool: 'bond',\n      opts: toBondType(type)\n    },\n    hidden: options => isHidden(options, `bond-${type}`)\n  }\n  return res\n}, toolActions)\n","/****************************************************************************\n * Copyright 2021 EPAM Systems\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *    http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n ***************************************************************************/\n\nimport {\n  FormatterFactory,\n  Pile,\n  SGroup,\n  getStereoAtomsMap,\n  identifyStructFormat\n} from 'ketcher-core'\n\nimport { supportedSGroupTypes } from './constants'\nimport tools from '../action/tools'\n\nexport function onAction(action) {\n  if (action && action.dialog) {\n    return {\n      type: 'MODAL_OPEN',\n      data: { name: action.dialog }\n    }\n  }\n  if (action && action.thunk) {\n    return action.thunk\n  }\n\n  return {\n    type: 'ACTION',\n    action\n  }\n}\n\nexport function loadStruct(struct) {\n  return (dispatch, getState) => {\n    const editor = getState().editor\n    editor.struct(struct)\n  }\n}\n\nfunction parseStruct(struct, server, options) {\n  if (typeof struct === 'string') {\n    options = options || {}\n    const { rescale, fragment, ...formatterOptions } = options\n\n    const format = identifyStructFormat(struct)\n    const factory = new FormatterFactory(server)\n\n    const service = factory.create(format, formatterOptions)\n    return service.getStructureFromStringAsync(struct)\n  } else {\n    return Promise.resolve(struct)\n  }\n}\n\nexport function load(struct, options) {\n  return (dispatch, getState) => {\n    const state = getState()\n    const editor = state.editor\n    const server = state.server\n    const errorHandler = editor.errorHandler\n\n    options = options || {}\n\n    return parseStruct(struct, server, options)\n      .then(\n        struct => {\n          const { fragment } = options\n\n          if (\n            struct.sgroups.some(sGroup => !supportedSGroupTypes[sGroup.type])\n          ) {\n            const isConfirmed = window.confirm(\n              `Unsupported S-group type found. Would you like to import structure without it?`\n            )\n\n            if (!isConfirmed) {\n              return\n            }\n\n            struct.sgroups = struct.sgroups.filter(\n              (key, sGroup) => supportedSGroupTypes[sGroup.type]\n            )\n          }\n\n          struct.rescale() // TODO: move out parsing?\n\n          if (editor.struct().atoms.size) {\n            //NB: reset id\n            const oldStruct = editor.struct().clone()\n\n            struct.sgroups.forEach((sg, sgId) => {\n              const offset = SGroup.getOffset(oldStruct.sgroups.get(sgId))\n              const atomSet = new Pile(sg.atoms)\n              const crossBonds = SGroup.getCrossBonds(struct, atomSet)\n              SGroup.bracketPos(sg, struct, crossBonds)\n              if (offset) sg.updateOffset(offset)\n            })\n          }\n\n          struct.findConnectedComponents()\n          struct.setImplicitHydrogen()\n\n          const stereAtomsMap = getStereoAtomsMap(\n            struct,\n            Array.from(struct.bonds.values())\n          )\n\n          struct.atoms.forEach((atom, id) => {\n            if (struct.atomGetNeighbors(id).length === 0) {\n              atom.stereoLabel = null\n              atom.stereoParity = 0\n            } else {\n              const stereoProp = stereAtomsMap.get(id)\n              if (stereoProp) {\n                atom.stereoLabel = stereoProp.stereoLabel\n                atom.stereoParity = stereoProp.stereoParity\n              }\n            }\n          })\n\n          struct.markFragments()\n\n          if (fragment) {\n            if (struct.isBlank()) {\n              dispatch({ type: 'ACTION', action: tools['select-lasso'].action })\n            } else {\n              dispatch(onAction({ tool: 'paste', opts: struct }))\n            }\n          } else {\n            editor.struct(struct)\n          }\n\n          dispatch({ type: 'MODAL_CLOSE' })\n        },\n        err => {\n          errorHandler(err.message)\n        }\n      )\n      .catch(err => {\n        errorHandler(err.message)\n      })\n  }\n}\n","/****************************************************************************\n * Copyright 2021 EPAM Systems\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *    http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n ***************************************************************************/\n\nimport { ChemicalMimeType, KetSerializer } from 'ketcher-core'\nimport { appUpdate, setStruct } from '../options'\nimport { omit, without } from 'lodash/fp'\n\nimport { checkErrors } from '../modal/form'\nimport { indigoVerification } from '../request'\nimport { load } from '../shared'\n\nexport function checkServer() {\n  return (dispatch, getState) => {\n    const { editor, server } = getState()\n\n    server.then(\n      res =>\n        dispatch(\n          appUpdate({\n            indigoVersion: res?.indigoVersion,\n            imagoVersions: res?.imagoVersions,\n            server: res?.isAvailable\n          })\n        ),\n      e => editor.errorHandler(e)\n    )\n  }\n}\n\nexport function recognize(file, version) {\n  return (dispatch, getState) => {\n    const rec = getState().server.recognize\n    const editor = getState().editor\n\n    const process = rec(file, version).then(\n      res => {\n        dispatch(setStruct(res.struct))\n      },\n      e => {\n        dispatch(setStruct(null))\n        editor.errorHandler(e)\n      }\n    )\n    dispatch(setStruct(process))\n  }\n}\n\nfunction ketcherCheck(struct, checkParams) {\n  const errors = {}\n\n  if (checkParams.includes('chiral_flag')) {\n    const isAbs = Array.from(struct.frags.values()).some(fr =>\n      fr ? fr.enhancedStereoFlag === 'abs' : false\n    )\n    if (isAbs) errors['chiral_flag'] = 'Chiral flag is present on the canvas'\n  }\n\n  if (checkParams.includes('valence')) {\n    let badVal = 0\n    struct.atoms.forEach(atom => atom.badConn && badVal++)\n    if (badVal > 0)\n      errors['valence'] = `Structure contains ${badVal} atom${\n        badVal !== 1 ? 's' : ''\n      } with bad valence`\n  }\n\n  return errors\n}\n\nexport function check(optsTypes) {\n  return (dispatch, getState) => {\n    const { editor, server } = getState()\n    const ketcherErrors = ketcherCheck(editor.struct(), optsTypes)\n\n    const options = getState().options.getServerSettings()\n    options.data = { types: without(['valence', 'chiral_flag'], optsTypes) }\n\n    return serverCall(editor, server, 'check', options)\n      .then(res => {\n        res = Object.assign(res, ketcherErrors) // merge Indigo check with Ketcher check\n        dispatch(checkErrors(res))\n      })\n      .catch(e => {\n        editor.errorHandler(e)\n      })\n  }\n}\n\nexport function automap(res) {\n  return serverTransform('automap', res)\n}\n\nexport function analyse() {\n  return (dispatch, getState) => {\n    //reset values to initial state\n    dispatch({\n      type: 'ANALYSE_LOADING'\n    })\n    const { editor, server, options } = getState()\n    const serverSettings = options.getServerSettings()\n    serverSettings.data = {\n      properties: [\n        'molecular-weight',\n        'most-abundant-mass',\n        'monoisotopic-mass',\n        'gross',\n        'mass-composition'\n      ]\n    }\n\n    return serverCall(editor, server, 'calculate', serverSettings)\n      .then(values =>\n        dispatch({\n          type: 'CHANGE_ANALYSE',\n          data: { values }\n        })\n      )\n      .catch(e => {\n        editor.errorHandler(e)\n      })\n  }\n}\n\nexport function serverTransform(method, data, struct) {\n  return (dispatch, getState) => {\n    const state = getState()\n    const opts = state.options.getServerSettings()\n    opts.data = data\n    dispatch(indigoVerification(true))\n\n    serverCall(state.editor, state.server, method, opts, struct)\n      .then(res => {\n        const loadedStruct = new KetSerializer().deserialize(res.struct)\n\n        return dispatch(\n          load(loadedStruct, {\n            rescale: method === 'layout',\n            reactionRelayout: method === 'clean'\n          })\n        )\n      })\n      .catch(e => {\n        state.editor.errorHandler(e)\n      })\n      .finally(() => {\n        dispatch(indigoVerification(false))\n      })\n    // TODO: notification\n  }\n}\n\n//TODO: serverCall function should not be exported\nexport function serverCall(editor, server, method, options, struct) {\n  const selection = editor.selection()\n  let selectedAtoms = []\n  const aidMap = new Map()\n  const currentStruct = (struct || editor.struct()).clone(\n    null,\n    null,\n    false,\n    aidMap\n  )\n  if (selection) {\n    selectedAtoms = (\n      selection.atoms ? selection.atoms : editor.explicitSelected().atoms\n    ).map(aid => aidMap.get(aid))\n  }\n  const ketSerializer = new KetSerializer()\n  return server.then(() =>\n    server[method](\n      Object.assign(\n        {\n          struct: ketSerializer.serialize(currentStruct)\n        },\n        method !== 'calculate' && method !== 'check'\n          ? {\n              output_format: ChemicalMimeType.KET\n            }\n          : null,\n        selectedAtoms && selectedAtoms.length > 0\n          ? {\n              selected: selectedAtoms\n            }\n          : null,\n        options.data\n      ),\n      omit('data', options)\n    )\n  )\n}\n","/****************************************************************************\n * Copyright 2021 EPAM Systems\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *    http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n ***************************************************************************/\n\nimport isHidden from './isHidden'\nimport { serverTransform } from '../state/server'\n\nconst config = {\n  layout: {\n    shortcut: 'Mod+l',\n    title: 'Layout',\n    action: {\n      thunk: serverTransform('layout')\n    },\n    disabled: (editor, server, options) => !options.app.server,\n    hidden: options => isHidden(options, 'layout')\n  },\n  clean: {\n    shortcut: 'Mod+Shift+l',\n    title: 'Clean Up',\n    action: {\n      thunk: serverTransform('clean')\n    },\n    disabled: (editor, server, options) => !options.app.server,\n    hidden: options => isHidden(options, 'clean')\n  },\n  arom: {\n    title: 'Aromatize',\n    action: {\n      thunk: serverTransform('aromatize')\n    },\n    disabled: (editor, server, options) => !options.app.server,\n    hidden: options => isHidden(options, 'arom')\n  },\n  dearom: {\n    title: 'Dearomatize',\n    action: {\n      thunk: serverTransform('dearomatize')\n    },\n    disabled: (editor, server, options) => !options.app.server,\n    hidden: options => isHidden(options, 'dearom')\n  },\n  cip: {\n    shortcut: 'Mod+p',\n    title: 'Calculate CIP',\n    action: {\n      thunk: serverTransform('calculateCip')\n    },\n    disabled: (editor, server, options) => !options.app.server,\n    hidden: options => isHidden(options, 'cip')\n  },\n  check: {\n    title: 'Check Structure',\n    action: { dialog: 'check' },\n    disabled: (editor, server, options) => !options.app.server,\n    hidden: options => isHidden(options, 'check')\n  },\n  analyse: {\n    title: 'Calculated Values',\n    action: { dialog: 'analyse' },\n    disabled: (editor, server, options) => !options.app.server,\n    hidden: options => isHidden(options, 'analyse')\n  },\n  recognize: {\n    title: 'Recognize Molecule',\n    action: { dialog: 'recognize' },\n    disabled: (editor, server, options) =>\n      //TODO: provide the list of disabled functions as array\n      !options.app.server ||\n      global.ketcher.standalone ||\n      !options.app.imagoVersions,\n    hidden: options => isHidden(options, 'recognize')\n  },\n  miew: {\n    title: '3D Viewer',\n    action: { dialog: 'miew' },\n    disabled: () => !window.Miew,\n    hidden: options => isHidden(options, 'miew')\n  }\n}\n\nexport default config\n","/****************************************************************************\n * Copyright 2021 EPAM Systems\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *    http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n ***************************************************************************/\n\nimport { MolSerializer } from 'ketcher-core'\n\nconst molSerializer = new MolSerializer()\n\nexport default [\n  'Benzene\\n' +\n    '  Ketcher 11161218352D 1   1.00000     0.00000     0\\n' +\n    '\\n' +\n    '  6  6  0     0  0            999 V2000\\n' +\n    '    0.8660    2.0000    0.0000 C   0  0  0  0  0  0        0  0  0\\n' +\n    '    1.7320    1.5000    0.0000 C   0  0  0  0  0  0        0  0  0\\n' +\n    '    1.7320    0.5000    0.0000 C   0  0  0  0  0  0        0  0  0\\n' +\n    '    0.8660    0.0000    0.0000 C   0  0  0  0  0  0        0  0  0\\n' +\n    '    0.0000    0.5000    0.0000 C   0  0  0  0  0  0        0  0  0\\n' +\n    '    0.0000    1.5000    0.0000 C   0  0  0  0  0  0        0  0  0\\n' +\n    '  1  2  1  0     0  0\\n' +\n    '  2  3  2  0     0  0\\n' +\n    '  3  4  1  0     0  0\\n' +\n    '  4  5  2  0     0  0\\n' +\n    '  5  6  1  0     0  0\\n' +\n    '  6  1  2  0     0  0\\n' +\n    'M  END\\n',\n  'Cyclopentadiene\\n' +\n    '  Ketcher 11161218352D 1   1.00000     0.00000     0\\n' +\n    '\\n' +\n    '  5  5  0     0  0            999 V2000\\n' +\n    '    0.0000    1.4257    0.0000 C   0  0  0  0  0  0        0  0  0\\n' +\n    '    0.8090    0.8379    0.0000 C   0  0  0  0  0  0        0  0  0\\n' +\n    '    0.5000   -0.1132    0.0000 C   0  0  0  0  0  0        0  0  0\\n' +\n    '   -0.5000   -0.1132    0.0000 C   0  0  0  0  0  0        0  0  0\\n' +\n    '   -0.8090    0.8379    0.0000 C   0  0  0  0  0  0        0  0  0\\n' +\n    '  1  2  1  0     0  0\\n' +\n    '  2  3  2  0     0  0\\n' +\n    '  3  4  1  0     0  0\\n' +\n    '  4  5  2  0     0  0\\n' +\n    '  5  1  1  0     0  0\\n' +\n    'M  END\\n',\n\n  'Cyclohexane\\n' +\n    '  Ketcher 11161218352D 1   1.00000     0.00000     0\\n' +\n    '\\n' +\n    '  6  6  0     0  0            999 V2000\\n' +\n    '    0.8660    2.0000    0.0000 C   0  0  0  0  0  0        0  0  0\\n' +\n    '    1.7320    1.5000    0.0000 C   0  0  0  0  0  0        0  0  0\\n' +\n    '    1.7320    0.5000    0.0000 C   0  0  0  0  0  0        0  0  0\\n' +\n    '    0.8660    0.0000    0.0000 C   0  0  0  0  0  0        0  0  0\\n' +\n    '    0.0000    0.5000    0.0000 C   0  0  0  0  0  0        0  0  0\\n' +\n    '    0.0000    1.5000    0.0000 C   0  0  0  0  0  0        0  0  0\\n' +\n    '  1  2  1  0     0  0\\n' +\n    '  2  3  1  0     0  0\\n' +\n    '  3  4  1  0     0  0\\n' +\n    '  4  5  1  0     0  0\\n' +\n    '  5  6  1  0     0  0\\n' +\n    '  6  1  1  0     0  0\\n' +\n    'M  END\\n',\n\n  'Cyclopentane\\n' +\n    '  Ketcher 11161218352D 1   1.00000     0.00000     0\\n' +\n    '\\n' +\n    '  5  5  0     0  0            999 V2000\\n' +\n    '    0.8090    1.5389    0.0000 C   0  0  0  0  0  0        0  0  0\\n' +\n    '    1.6180    0.9511    0.0000 C   0  0  0  0  0  0        0  0  0\\n' +\n    '    1.3090    0.0000    0.0000 C   0  0  0  0  0  0        0  0  0\\n' +\n    '    0.3090    0.0000    0.0000 C   0  0  0  0  0  0        0  0  0\\n' +\n    '    0.0000    0.9511    0.0000 C   0  0  0  0  0  0        0  0  0\\n' +\n    '  1  2  1  0     0  0\\n' +\n    '  2  3  1  0     0  0\\n' +\n    '  3  4  1  0     0  0\\n' +\n    '  4  5  1  0     0  0\\n' +\n    '  5  1  1  0     0  0\\n' +\n    'M  END\\n',\n\n  'Cyclopropane\\n' +\n    '  Ketcher 11161218352D 1   1.00000     0.00000     0\\n' +\n    '\\n' +\n    '  3  3  0     0  0            999 V2000\\n' +\n    '   -3.2250   -0.2750    0.0000 C   0  0  0  0  0  0        0  0  0\\n' +\n    '   -2.2250   -0.2750    0.0000 C   0  0  0  0  0  0        0  0  0\\n' +\n    '   -2.7250    0.5910    0.0000 C   0  0  0  0  0  0        0  0  0\\n' +\n    '  1  2  1  0     0  0\\n' +\n    '  2  3  1  0     0  0\\n' +\n    '  1  3  1  0     0  0\\n' +\n    'M  END\\n',\n\n  'Cyclobutane\\n' +\n    '  Ketcher 11161218352D 1   1.00000     0.00000     0\\n' +\n    '\\n' +\n    '  4  4  0     0  0            999 V2000\\n' +\n    '   -3.8250    1.5500    0.0000 C   0  0  0  0  0  0        0  0  0\\n' +\n    '   -3.8250    0.5500    0.0000 C   0  0  0  0  0  0        0  0  0\\n' +\n    '   -2.8250    1.5500    0.0000 C   0  0  0  0  0  0        0  0  0\\n' +\n    '   -2.8250    0.5500    0.0000 C   0  0  0  0  0  0        0  0  0\\n' +\n    '  1  2  1  0     0  0\\n' +\n    '  1  3  1  0     0  0\\n' +\n    '  3  4  1  0     0  0\\n' +\n    '  4  2  1  0     0  0\\n' +\n    'M  END\\n',\n\n  'Cycloheptane\\n' +\n    '  Ketcher 11161218352D 1   1.00000     0.00000     0\\n' +\n    '\\n' +\n    '  7  7  0     0  0            999 V2000\\n' +\n    '    0.0000    1.6293    0.0000 C   0  0  0  0  0  0        0  0  0\\n' +\n    '    0.7835    2.2465    0.0000 C   0  0  0  0  0  0        0  0  0\\n' +\n    '    1.7559    2.0242    0.0000 C   0  0  0  0  0  0        0  0  0\\n' +\n    '    2.1897    1.1289    0.0000 C   0  0  0  0  0  0        0  0  0\\n' +\n    '    0.0000    0.6228    0.0000 C   0  0  0  0  0  0        0  0  0\\n' +\n    '    1.7566    0.2224    0.0000 C   0  0  0  0  0  0        0  0  0\\n' +\n    '    0.7835    0.0000    0.0000 C   0  0  0  0  0  0        0  0  0\\n' +\n    '  6  7  1  0     0  0\\n' +\n    '  5  7  1  0     0  0\\n' +\n    '  1  5  1  0     0  0\\n' +\n    '  4  6  1  0     0  0\\n' +\n    '  3  4  1  0     0  0\\n' +\n    '  2  3  1  0     0  0\\n' +\n    '  1  2  1  0     0  0\\n' +\n    'M  END\\n',\n\n  'Cyclooctane\\n' +\n    '  Ketcher 11161218352D 1   1.00000     0.00000     0\\n' +\n    '\\n' +\n    '  8  8  0     0  0            999 V2000\\n' +\n    '    0.0000    0.7053    0.0000 C   0  0  0  0  0  0        0  0  0\\n' +\n    '    0.0000    1.7078    0.0000 C   0  0  0  0  0  0        0  0  0\\n' +\n    '    0.7053    2.4131    0.0000 C   0  0  0  0  0  0        0  0  0\\n' +\n    '    0.7056    0.0000    0.0000 C   0  0  0  0  0  0        0  0  0\\n' +\n    '    1.7079    0.0000    0.0000 C   0  0  0  0  0  0        0  0  0\\n' +\n    '    2.4133    0.7053    0.0000 C   0  0  0  0  0  0        0  0  0\\n' +\n    '    2.4133    1.7078    0.0000 C   0  0  0  0  0  0        0  0  0\\n' +\n    '    1.7079    2.4131    0.0000 C   0  0  0  0  0  0        0  0  0\\n' +\n    '  8  3  1  0     0  0\\n' +\n    '  7  8  1  0     0  0\\n' +\n    '  6  7  1  0     0  0\\n' +\n    '  5  6  1  0     0  0\\n' +\n    '  4  5  1  0     0  0\\n' +\n    '  1  4  1  0     0  0\\n' +\n    '  2  3  1  0     0  0\\n' +\n    '  1  2  1  0     0  0\\n' +\n    'M  END\\n'\n].map(structStr => molSerializer.deserialize(structStr))\n","/****************************************************************************\n * Copyright 2021 EPAM Systems\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *    http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n ***************************************************************************/\n\nimport templates from '../data/templates'\nimport isHidden from './isHidden'\n\nconst templateLib = {\n  'template-lib': {\n    shortcut: 'Shift+t',\n    title: 'Custom Templates',\n    action: { dialog: 'templates' },\n    selected: editor => editor._tool.mode === 'classic',\n    disabled: (editor, server, options) => !options.app.templates,\n    hidden: options => isHidden(options, 'template-lib')\n  }\n}\n\nexport default templates.reduce((res, struct, i) => {\n  res[`template-${i}`] = {\n    title: `${struct.name}`,\n    shortcut: 't',\n    action: {\n      tool: 'template',\n      opts: { struct }\n    }\n  }\n  return res\n}, templateLib)\n","/****************************************************************************\n * Copyright 2021 EPAM Systems\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *    http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n ***************************************************************************/\n\nimport { findIndex, findLastIndex } from 'lodash/fp'\nimport isHidden from './isHidden'\n\nexport const zoomList = [\n  0.2, 0.3, 0.4, 0.5, 0.6, 0.7, 0.8, 0.9, 1, 1.1, 1.2, 1.3, 1.4, 1.5, 1.7, 2,\n  2.5, 3, 3.5, 4\n]\n\nexport default {\n  zoom: {\n    selected: editor => editor.zoom(),\n    hidden: options => isHidden(options, 'zoom')\n  },\n  'zoom-out': {\n    shortcut: ['-', '_', 'Shift+-'],\n    title: 'Zoom Out',\n    disabled: editor => editor.zoom() <= zoomList[0], // unsave\n    action: editor => {\n      const zoom = editor.zoom()\n      const i = findIndex(z => z >= zoom, zoomList)\n      editor.zoom(zoomList[zoomList[i] === zoom && i > 0 ? i - 1 : i])\n    },\n    hidden: options => isHidden(options, 'zoom-out')\n  },\n  'zoom-in': {\n    shortcut: ['+', '=', 'Shift+='],\n    title: 'Zoom In',\n    disabled: editor => zoomList[zoomList.length - 1] <= editor.zoom(),\n    action: editor => {\n      const zoom = editor.zoom()\n      const i = findLastIndex(z => z <= zoom, zoomList)\n      editor.zoom(\n        zoomList[zoomList[i] === zoom && i < zoomList.length - 1 ? i + 1 : i]\n      )\n    },\n    hidden: options => isHidden(options, 'zoom-in')\n  },\n  'zoom-list': {\n    hidden: options => isHidden(options, 'zoom-list')\n  }\n}\n","/****************************************************************************\n * Copyright 2021 EPAM Systems\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *    http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n ***************************************************************************/\n\nimport isHidden from './isHidden'\n\nconst functionalGroupsLib = {\n  'functional-groups': {\n    shortcut: 'Shift+f',\n    // TODO Update HELP about current tools\n    title: 'Functional Groups',\n    action: { dialog: 'fGroups' },\n    selected: editor => editor._tool.mode === 'fg',\n    disabled: (_, __, options) => {\n      return !options.app.functionalGroups\n    },\n    hidden: options => isHidden(options, 'functional-groups')\n  }\n}\n\nexport default functionalGroupsLib\n","/****************************************************************************\n * Copyright 2021 EPAM Systems\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *    http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n ***************************************************************************/\n\nimport atoms from './atoms'\nimport copyAs from './copyAs'\nimport copyImageToClipboard from './copyImageToClipboard'\nimport debug from './debug'\nimport { exec } from '../component/cliparea/cliparea'\nimport isHidden from './isHidden'\nimport server from './server'\nimport templates from './templates'\nimport tools from './tools'\nimport zoom from './zoom'\nimport functionalGroups from './functionalGroups'\n\nexport * from './action.types'\n\nconst config = {\n  clear: {\n    shortcut: 'Mod+Delete',\n    title: 'Clear Canvas',\n    action: {\n      thunk: (dispatch, getState) => {\n        const editor = getState().editor\n        if (!editor.struct().isBlank()) editor.struct(null)\n        dispatch({ type: 'ACTION', action: tools['select-lasso'].action })\n      }\n    },\n    hidden: options => isHidden(options, 'clear')\n  },\n  open: {\n    shortcut: 'Mod+o',\n    title: 'Open‚Ä¶',\n    action: { dialog: 'open' },\n    hidden: options => isHidden(options, 'open')\n  },\n  save: {\n    shortcut: 'Mod+s',\n    title: 'Save As‚Ä¶',\n    action: { dialog: 'save' },\n    hidden: options => isHidden(options, 'save')\n  },\n  undo: {\n    shortcut: 'Mod+z',\n    title: 'Undo',\n    action: editor => {\n      editor.undo()\n    },\n    disabled: editor => editor.historySize().undo === 0,\n    hidden: options => isHidden(options, 'undo')\n  },\n  redo: {\n    shortcut: ['Mod+Shift+z', 'Mod+y'],\n    title: 'Redo',\n    action: editor => {\n      editor.redo()\n    },\n    disabled: editor => editor.historySize().redo === 0,\n    hidden: options => isHidden(options, 'redo')\n  },\n  cut: {\n    shortcut: 'Mod+x',\n    title: 'Cut',\n    action: editor => {\n      exec('cut') || dontClipMessage('Cut', editor.errorHandler) // eslint-disable-line no-unused-expressions\n    },\n    disabled: editor => !hasSelection(editor),\n    hidden: options => isHidden(options, 'cut')\n  },\n  copies: {\n    disabled: editor => !hasSelection(editor),\n    hidden: options => isHidden(options, 'copies')\n  },\n  copy: {\n    shortcut: 'Mod+c',\n    title: 'Copy',\n    action: editor => {\n      exec('copy') || dontClipMessage('Copy', editor.errorHandler) // eslint-disable-line no-unused-expressions\n    },\n    disabled: editor => !hasSelection(editor),\n    hidden: options => isHidden(options, 'copy')\n  },\n  'copy-image': {\n    shortcut: 'Mod+Shift+f',\n    title: 'Copy Image',\n    action: () => {\n      copyImageToClipboard()\n    },\n    disabled: editor => !hasSelection(editor),\n    hidden: options => isHidden(options, 'copy-image')\n  },\n  'copy-mol': {\n    shortcut: 'Mod+m',\n    title: 'Copy as MOL',\n    action: () => {\n      copyAs('mol')\n    },\n    disabled: editor => !hasSelection(editor),\n    hidden: options => isHidden(options, 'copy-mol')\n  },\n  'copy-ket': {\n    shortcut: 'Mod+Shift+k',\n    title: 'Copy as KET',\n    action: () => {\n      copyAs('ket')\n    },\n    disabled: editor => !hasSelection(editor),\n    hidden: options => isHidden(options, 'copy-ket')\n  },\n  paste: {\n    shortcut: 'Mod+v',\n    title: 'Paste',\n    action: editor => {\n      exec('paste') || dontClipMessage('Paste', editor.errorHandler) // eslint-disable-line no-unused-expressions\n    },\n    selected: ({ actions }) =>\n      actions && // TMP\n      actions.active &&\n      actions.active.tool === 'paste',\n    hidden: options => isHidden(options, 'paste')\n  },\n  settings: {\n    title: 'Settings',\n    action: { dialog: 'settings' },\n    hidden: options => isHidden(options, 'settings')\n  },\n  help: {\n    hidden: options => isHidden(options, 'help')\n  },\n  about: {\n    title: 'About',\n    action: { dialog: 'about' },\n    hidden: options => isHidden(options, 'about')\n  },\n  'reaction-automap': {\n    title: 'Reaction Auto-Mapping Tool',\n    action: { dialog: 'automap' },\n    hidden: options => isHidden(options, 'reaction-automap'),\n    disabled: (editor, server, options) =>\n      !options.app.server || !editor.struct().hasRxnArrow()\n  },\n  'period-table': {\n    title: 'Periodic Table',\n    action: { dialog: 'period-table' },\n    hidden: options => isHidden(options, 'period-table')\n  },\n  'select-all': {\n    title: 'Select All',\n    shortcut: 'Mod+a',\n    action: {\n      thunk: (dispatch, getState) => {\n        getState().editor.selection('all')\n        const selectionTool = getState().toolbar.visibleTools.select\n        dispatch({ type: 'ACTION', action: tools[selectionTool].action })\n      }\n    },\n    hidden: options => isHidden(options, 'select-all')\n  },\n  'deselect-all': {\n    title: 'Deselect All',\n    shortcut: 'Mod+Shift+a',\n    action: editor => {\n      editor.selection(null)\n    },\n    hidden: options => isHidden(options, 'deselect-all')\n  },\n  'select-descriptors': {\n    title: 'Select descriptors',\n    shortcut: 'Mod+d',\n    action: {\n      thunk: (dispatch, getState) => {\n        const selectionTool = getState().toolbar.visibleTools.select\n        const editor = getState().editor\n        editor.alignDescriptors()\n        editor.selection('descriptors')\n        dispatch({ type: 'ACTION', action: tools[selectionTool].action })\n      }\n    },\n    hidden: options => isHidden(options, 'select-descriptors')\n  },\n  ...server,\n  ...debug,\n  ...tools,\n  ...atoms,\n  ...zoom,\n  ...templates,\n  ...functionalGroups\n}\n\nfunction hasSelection(editor) {\n  const selection = editor.selection()\n  return (\n    selection && // if not only sgroupData selected\n    Object.keys(selection).filter(key => !['sgroupData'].includes(key)).length >\n      0\n  )\n}\n\nfunction dontClipMessage(title, errorHandler) {\n  errorHandler(\n    'This action is unavailable via menu.\\n' + // eslint-disable-line no-undef\n      'Instead, use shortcut to ' +\n      title +\n      '.'\n  )\n}\n\nexport default config\n","/****************************************************************************\n * Copyright 2021 EPAM Systems\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *    http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n ***************************************************************************/\n\nimport AboutIcon from './files/about.svg'\nimport AnalyseIcon from './files/analyse.svg'\nimport AromIcon from './files/arom.svg'\nimport BondAnyIcon from './files/bond-any.svg'\nimport BondAromaticIcon from './files/bond-aromatic.svg'\nimport BondCrossedIcon from './files/bond-crossed.svg'\nimport BondDative from './files/bond-dative.svg'\nimport BondDoubleAromaticIcon from './files/bond-doublearomatic.svg'\nimport BondDoubleIcon from './files/bond-double.svg'\nimport BondDownIcon from './files/bond-down.svg'\nimport BondHydrogenIcon from './files/bond-hydrogen.svg'\nimport BondSingleAromaticIcon from './files/bond-singlearomatic.svg'\nimport BondSingleDoubleIcon from './files/bond-singledouble.svg'\nimport BondSingleIcon from './files/bond-single.svg'\nimport BondTripleIcon from './files/bond-triple.svg'\nimport BondUpIcon from './files/bond-up.svg'\nimport BondUpdownIcon from './files/bond-updown.svg'\nimport ChainIcon from './files/chain.svg'\nimport ChargeMinusIcon from './files/charge-minus.svg'\nimport ChargePlusIcon from './files/charge-plus.svg'\nimport CheckIcon from './files/check.svg'\nimport ChiralFlagIcon from './files/chiral-flag.svg'\nimport CipIcon from './files/cip.svg'\nimport CleanIcon from './files/clean.svg'\nimport CopyIcon from './files/copy.svg'\nimport CopyImageIcon from './files/copy-image.svg'\nimport CopyKetIcon from './files/copy-ket.svg'\nimport CopyMolIcon from './files/copy-mol.svg'\nimport CutIcon from './files/cut.svg'\nimport DearomIcon from './files/dearom.svg'\nimport DropdownIcon from './files/dropdown.svg'\nimport EnhancedStereoIcon from './files/enhanced-stereo.svg'\nimport EraseIcon from './files/erase.svg'\nimport GenericGroupsIcon from './files/generic-groups.svg'\nimport HelpIcon from './files/help.svg'\nimport LayoutIcon from './files/layout.svg'\nimport LogoIcon from './files/logo.svg'\nimport MiewIcon from './files/miew.svg'\nimport ClearIcon from './files/clear.svg'\nimport OpenIcon from './files/open.svg'\nimport PasteIcon from './files/paste.svg'\nimport PeriodTableIcon from './files/period-table.svg'\nimport ReactionArrowBothEndsFilledTriangle from './files/reaction-arrow-both-ends-filled-triangle.svg'\nimport ReactionArrowDashedOpenAngle from './files/reaction-arrow-dashed-open-angle.svg'\nimport ReactionArrowEquilibriumFilledHalfBow from './files/reaction-arrow-equilibrium-filled-half-bow.svg'\nimport ReactionArrowEquilibriumFilledTriangle from './files/reaction-arrow-equilibrium-filled-triangle.svg'\nimport ReactionArrowEquilibriumOpenAngle from './files/reaction-arrow-equilibrium-open-angle.svg'\nimport ReactionArrowFailed from './files/reaction-arrow-failed.svg'\nimport ReactionArrowFilledBow from './files/reaction-arrow-filled-bow.svg'\nimport ReactionArrowFilledTriangle from './files/reaction-arrow-filled-triangle.svg'\nimport ReactionArrowOpenAngleIcon from './files/reaction-arrow-open-angle.svg'\nimport ReactionArrowUnbalancedEquilibriumFilledHalfBow from './files/reaction-arrow-unbalanced-equilibrium-filled-half-bow.svg'\nimport ReactionArrowUnbalancedEquilibriumFilledHalfTriangle from './files/reaction-arrow-unbalanced-equilibrium-fille-half-triangle.svg'\nimport ReactionArrowUnbalancedEquilibriumLargeFilledHalfBow from './files/reaction-arrow-unbalanced-equilibrium-large-filled-half-bow.svg'\nimport ReactionArrowUnbalancedEquilibriumOpenHalfAngle from './files/reaction-arrow-unbalanced-equilibrium-open-half-angle.svg'\nimport ReactionAutomapIcon from './files/reaction-automap.svg'\nimport ReactionMapIcon from './files/reaction-map.svg'\nimport ReactionPlusIcon from './files/reaction-plus.svg'\nimport ReactionUnmapIcon from './files/reaction-unmap.svg'\nimport RecognizeIcon from './files/recognize.svg'\nimport RedoIcon from './files/redo.svg'\nimport RgroupAttpointsIcon from './files/rgroup-attpoints.svg'\nimport RgroupFragmentIcon from './files/rgroup-fragment.svg'\nimport RgroupLabelIcon from './files/rgroup-label.svg'\nimport SaveIcon from './files/save.svg'\nimport SelectFragmentIcon from './files/select-fragment.svg'\nimport SelectLassoIcon from './files/select-lasso.svg'\nimport SelectRectangleIcon from './files/select-rectangle.svg'\nimport SettingsIcon from './files/settings.svg'\nimport SgroupDataIcon from './files/sgroup-data.svg'\nimport SgroupIcon from './files/sgroup.svg'\nimport ShapeEllipseIcon from './files/shape-ellipse.svg'\nimport ShapeLineIcon from './files/shape-line.svg'\nimport ShapePolylineIcon from './files/shape-polyline.svg'\nimport ShapeRectangleIcon from './files/shape-rectangle.svg'\nimport Template0Icon from './files/template-0.svg'\nimport Template1Icon from './files/template-1.svg'\nimport Template2Icon from './files/template-2.svg'\nimport Template3Icon from './files/template-3.svg'\nimport Template4Icon from './files/template-4.svg'\nimport Template5Icon from './files/template-5.svg'\nimport Template6Icon from './files/template-6.svg'\nimport Template7Icon from './files/template-7.svg'\nimport TemplateLibIcon from './files/template-lib.svg'\nimport TextBold from './files/text-bold.svg'\nimport TextIcon from './files/text.svg'\nimport TextItalic from './files/text-italic.svg'\nimport TextSubscript from './files/text-subscript.svg'\nimport TextSuperscript from './files/text-superscript.svg'\nimport TransformRotateIcon from './files/transform-rotate.svg'\nimport TransfromFlipHIcon from './files/transform-flip-h.svg'\nimport TransfromFlipVIcon from './files/transform-flip-v.svg'\nimport UndoIcon from './files/undo.svg'\nimport ZoomInIcon from './files/zoom-in.svg'\nimport ZoomOutIcon from './files/zoom-out.svg'\nimport FunctionalGroupsIcon from './files/functional-groups.svg'\n\nconst icons = {\n  about: AboutIcon,\n  analyse: AnalyseIcon,\n  arom: AromIcon,\n  'bond-any': BondAnyIcon,\n  'bond-aromatic': BondAromaticIcon,\n  'bond-crossed': BondCrossedIcon,\n  'bond-hydrogen': BondHydrogenIcon,\n  'bond-dative': BondDative,\n  'bond-double': BondDoubleIcon,\n  'bond-doublearomatic': BondDoubleAromaticIcon,\n  'bond-down': BondDownIcon,\n  'bond-single': BondSingleIcon,\n  'bond-singlearomatic': BondSingleAromaticIcon,\n  'bond-singledouble': BondSingleDoubleIcon,\n  'bond-triple': BondTripleIcon,\n  'bond-up': BondUpIcon,\n  'bond-updown': BondUpdownIcon,\n  chain: ChainIcon,\n  'charge-minus': ChargeMinusIcon,\n  'charge-plus': ChargePlusIcon,\n  check: CheckIcon,\n  'chiral-flag': ChiralFlagIcon,\n  cip: CipIcon,\n  clean: CleanIcon,\n  copies: CopyIcon,\n  copy: CopyIcon,\n  'copy-image': CopyImageIcon,\n  'copy-mol': CopyMolIcon,\n  'copy-ket': CopyKetIcon,\n  cut: CutIcon,\n  dearom: DearomIcon,\n  dropdown: DropdownIcon,\n  'enhanced-stereo': EnhancedStereoIcon,\n  erase: EraseIcon,\n  'functional-groups': FunctionalGroupsIcon,\n  'generic-groups': GenericGroupsIcon,\n  help: HelpIcon,\n  layout: LayoutIcon,\n  logo: LogoIcon,\n  miew: MiewIcon,\n  clear: ClearIcon,\n  open: OpenIcon,\n  paste: PasteIcon,\n  'period-table': PeriodTableIcon,\n  'reaction-arrow-open-angle': ReactionArrowOpenAngleIcon,\n  'reaction-arrow-filled-triangle': ReactionArrowFilledTriangle,\n  'reaction-arrow-filled-bow': ReactionArrowFilledBow,\n  'reaction-arrow-dashed-open-angle': ReactionArrowDashedOpenAngle,\n  'reaction-arrow-failed': ReactionArrowFailed,\n  'reaction-arrow-both-ends-filled-triangle':\n    ReactionArrowBothEndsFilledTriangle,\n  'reaction-arrow-equilibrium-filled-half-bow':\n    ReactionArrowEquilibriumFilledHalfBow,\n  'reaction-arrow-equilibrium-filled-triangle':\n    ReactionArrowEquilibriumFilledTriangle,\n  'reaction-arrow-equilibrium-open-angle': ReactionArrowEquilibriumOpenAngle,\n  'reaction-arrow-unbalanced-equilibrium-filled-half-bow':\n    ReactionArrowUnbalancedEquilibriumFilledHalfBow,\n  'reaction-arrow-unbalanced-equilibrium-open-half-angle':\n    ReactionArrowUnbalancedEquilibriumOpenHalfAngle,\n  'reaction-arrow-unbalanced-equilibrium-large-filled-half-bow':\n    ReactionArrowUnbalancedEquilibriumLargeFilledHalfBow,\n  'reaction-arrow-unbalanced-equilibrium-filled-half-triangle':\n    ReactionArrowUnbalancedEquilibriumFilledHalfTriangle,\n  'reaction-automap': ReactionAutomapIcon,\n  'reaction-map': ReactionMapIcon,\n  'reaction-plus': ReactionPlusIcon,\n  'reaction-unmap': ReactionUnmapIcon,\n  recognize: RecognizeIcon,\n  redo: RedoIcon,\n  'rgroup-attpoints': RgroupAttpointsIcon,\n  'rgroup-fragment': RgroupFragmentIcon,\n  'rgroup-label': RgroupLabelIcon,\n  save: SaveIcon,\n  'select-fragment': SelectFragmentIcon,\n  'select-lasso': SelectLassoIcon,\n  'select-rectangle': SelectRectangleIcon,\n  settings: SettingsIcon,\n  'sgroup-data': SgroupDataIcon,\n  sgroup: SgroupIcon,\n  'template-0': Template0Icon,\n  'template-1': Template1Icon,\n  'template-2': Template2Icon,\n  'template-3': Template3Icon,\n  'template-4': Template4Icon,\n  'template-5': Template5Icon,\n  'template-6': Template6Icon,\n  'template-7': Template7Icon,\n  'template-lib': TemplateLibIcon,\n  text: TextIcon,\n  'text-bold': TextBold,\n  'text-italic': TextItalic,\n  'text-subscript': TextSubscript,\n  'text-superscript': TextSuperscript,\n  'transform-flip-h': TransfromFlipHIcon,\n  'transform-flip-v': TransfromFlipVIcon,\n  'transform-rotate': TransformRotateIcon,\n  undo: UndoIcon,\n  'zoom-in': ZoomInIcon,\n  'zoom-out': ZoomOutIcon,\n  'shape-ellipse': ShapeEllipseIcon,\n  'shape-rectangle': ShapeRectangleIcon,\n  'shape-polyline': ShapePolylineIcon,\n  'shape-line': ShapeLineIcon\n}\n\nfunction emptyIcon() {\n  return null\n}\n\nexport default function findIconByName(name) {\n  if (name && icons.hasOwnProperty(name)) {\n    const component = icons[name]\n    return component\n  } else {\n    return emptyIcon\n  }\n}\n","/****************************************************************************\n * Copyright 2021 EPAM Systems\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *    http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n ***************************************************************************/\n\nimport findIconByName from './../../../../icons'\n\nfunction Icon({ name, ...props }) {\n  const Component = findIconByName(name)\n  return <Component {...props} />\n}\nexport default Icon\n","/****************************************************************************\n * Copyright 2021 EPAM Systems\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *    http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n ***************************************************************************/\n\nconst isMac = /Mac/.test(navigator.platform) // eslint-disable-line no-undef\nconst shortcutAliasMap = {\n  Escape: 'Esc',\n  Delete: 'Del',\n  Mod: isMac ? '‚åò' : 'Ctrl'\n}\n\nexport function shortcutStr(shortcut?: string | string[]) {\n  if (!shortcut) {\n    return ''\n  }\n\n  const shortcutKey = Array.isArray(shortcut) ? shortcut[0] : shortcut\n  return shortcutKey.replace(\n    /(\\b[a-z]\\b$|Mod|Escape|Delete)/g,\n    key => shortcutAliasMap[key] || key.toUpperCase()\n  )\n}\n","/****************************************************************************\n * Copyright 2021 EPAM Systems\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *    http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n ***************************************************************************/\n\nimport { UiAction, UiActionAction } from '../../../../action'\n\nimport Icon from '../../../../component/view/icon'\nimport classes from './ActionButton.module.less'\nimport clsx from 'clsx'\nimport { shortcutStr } from '../../shortcutStr'\n\ninterface ActionButtonProps {\n  name: string\n  action?: UiAction\n  status?: {\n    disabled?: boolean\n    hidden?: boolean\n  }\n  selected?: boolean\n  disableableButtons: string[]\n  indigoVerification: boolean\n  className?: string\n}\n\ninterface ActionButtonCallProps {\n  onAction: (action: UiActionAction) => void\n}\n\ntype Props = ActionButtonProps & ActionButtonCallProps\n\nconst ActionButton = (props: Props) => {\n  const {\n    name,\n    action,\n    status = {},\n    selected = false,\n    disableableButtons,\n    indigoVerification,\n    className,\n    onAction\n  } = props\n\n  if (status.hidden) {\n    return null\n  }\n\n  const shortcut = shortcutStr(action?.shortcut)\n  const disabled =\n    status.disabled || (indigoVerification && disableableButtons.includes(name))\n\n  const handleClick = event => {\n    if (action?.action) {\n      onAction(action.action)\n    }\n    event.stopPropagation()\n  }\n\n  return (\n    <button\n      disabled={disabled}\n      onClick={handleClick}\n      title={shortcut ? `${action?.title} (${shortcut})` : action?.title}\n      className={clsx(\n        classes.button,\n        {\n          [classes.selected]: selected\n        },\n        className\n      )}\n    >\n      <Icon name={name} />\n      <kbd>{shortcut}</kbd>\n    </button>\n  )\n}\n\nexport type { ActionButtonProps, ActionButtonCallProps }\nexport { ActionButton }\n","/****************************************************************************\n * Copyright 2021 EPAM Systems\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *    http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n ***************************************************************************/\n\nimport { CSSProperties, Component } from 'react'\n\nimport ReactDOM from 'react-dom'\n\nconst CLASSNAME_SEPARATOR = ' '\n\ninterface PortalProps {\n  isOpen: boolean\n  className?: string\n  style?: CSSProperties\n}\n\ntype Props = PortalProps\n\nclass Portal extends Component<Props> {\n  private readonly element: HTMLDivElement\n  private isElementInDom: boolean\n\n  constructor(props) {\n    super(props)\n    this.element = document.createElement('div')\n    this.isElementInDom = false\n  }\n\n  componentDidMount() {\n    if (!this.isElementInDom && this.props.isOpen) {\n      this.addElementInDOM()\n    }\n\n    const { className, style } = this.props\n    if (className) {\n      this.addClassName(className)\n    }\n    if (style) {\n      this.updateStyle(style)\n    }\n  }\n\n  componentWillUnmount() {\n    if (this.isElementInDom) {\n      this.removeElementFromDOM()\n    }\n  }\n\n  componentDidUpdate(prevProps: Readonly<Props>) {\n    const { isOpen, className, style } = this.props\n    if (className !== prevProps.className) {\n      this.removeClassNames(prevProps.className)\n      this.addClassName(className)\n    }\n\n    if (style !== prevProps.style) {\n      this.updateStyle(style, prevProps.style)\n    }\n\n    if (isOpen === prevProps.isOpen) {\n      return\n    }\n\n    if (isOpen && !this.isElementInDom) {\n      this.addElementInDOM()\n    } else if (this.isElementInDom) {\n      this.removeElementFromDOM()\n    }\n  }\n\n  private addElementInDOM() {\n    document.querySelector('body')?.appendChild(this.element)\n    this.isElementInDom = true\n  }\n\n  private removeElementFromDOM() {\n    document.querySelector('body')?.removeChild(this.element)\n    this.isElementInDom = false\n  }\n\n  private removeClassNames(classNames?: string) {\n    if (!classNames) {\n      return\n    }\n\n    classNames.split(CLASSNAME_SEPARATOR).forEach(className => {\n      this.element.classList.remove(className)\n    })\n  }\n\n  private addClassName(classNames?: string) {\n    if (!classNames) {\n      return\n    }\n\n    classNames.split(CLASSNAME_SEPARATOR).forEach(className => {\n      this.element.classList.add(className)\n    })\n  }\n\n  private updateStyle(style?: CSSProperties, prevStyle?: CSSProperties) {\n    if (prevStyle) {\n      Object.keys(prevStyle).forEach(property => {\n        this.element.style[property] = ''\n      }, this)\n    }\n\n    if (!style) {\n      return\n    }\n\n    Object.keys(style).forEach(property => {\n      this.element.style[property] = style[property]\n    }, this)\n  }\n\n  render() {\n    const { children } = this.props\n    return ReactDOM.createPortal(children, this.element)\n  }\n}\n\nexport { Portal }\n","/****************************************************************************\n * Copyright 2021 EPAM Systems\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *    http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n ***************************************************************************/\n\nimport { MultiToolCallProps, MultiToolProps } from '../variants.types'\n\nimport { ActionButton } from '../../../ActionButton'\nimport action from '../../../../../../action'\n\ninterface DefaultMultiToolProps extends MultiToolProps {}\ninterface DefaultMultiToolCallProps extends MultiToolCallProps {}\n\ntype Props = DefaultMultiToolProps & DefaultMultiToolCallProps\n\nconst DefaultMultiTool = (props: Props) => {\n  const { options, status, disableableButtons, indigoVerification, onAction } =\n    props\n\n  return (\n    <>\n      {options.map(toolbarItem => {\n        const currentStatus = status[toolbarItem.id]\n        return (\n          <ActionButton\n            key={toolbarItem.id}\n            name={toolbarItem.id}\n            action={action[toolbarItem.id]}\n            // @ts-ignore\n            status={currentStatus}\n            selected={!!currentStatus?.selected}\n            disableableButtons={disableableButtons}\n            indigoVerification={indigoVerification}\n            onAction={onAction}\n          />\n        )\n      })}\n    </>\n  )\n}\n\nexport type { DefaultMultiToolProps, DefaultMultiToolCallProps }\nexport { DefaultMultiTool }\n","/****************************************************************************\n * Copyright 2021 EPAM Systems\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *    http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n ***************************************************************************/\n\nimport { MultiToolCallProps, MultiToolProps } from '../variants.types'\n\nimport { ActionButton } from '../../../ActionButton'\nimport action from '../../../../../../action'\nimport classes from './GroupedMultiTool.module.less'\n\ninterface GroupedMultiToolProps extends MultiToolProps {}\ninterface GroupedMultiToolCallProps extends MultiToolCallProps {}\n\ntype Props = GroupedMultiToolProps & GroupedMultiToolCallProps\n\nconst GroupedMultiTool = (props: Props) => {\n  const {\n    groups,\n    options,\n    status,\n    disableableButtons,\n    indigoVerification,\n    onAction\n  } = props\n\n  if (!groups) {\n    return null\n  }\n\n  return (\n    <>\n      {groups.map(descriptor => (\n        <div className={classes.group} key={descriptor.start}>\n          {options.slice(descriptor.start, descriptor.end).map(toolbarItem => {\n            const currentStatus = status[toolbarItem.id]\n            return (\n              <ActionButton\n                key={toolbarItem.id}\n                name={toolbarItem.id}\n                action={action[toolbarItem.id]}\n                // @ts-ignore\n                status={currentStatus}\n                selected={!!currentStatus?.selected}\n                disableableButtons={disableableButtons}\n                indigoVerification={indigoVerification}\n                onAction={onAction}\n              />\n            )\n          })}\n        </div>\n      ))}\n    </>\n  )\n}\n\nexport type { GroupedMultiToolProps, GroupedMultiToolCallProps }\nexport { GroupedMultiTool }\n","/****************************************************************************\n * Copyright 2021 EPAM Systems\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *    http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n ***************************************************************************/\n\nimport {\n  ActionButton,\n  ActionButtonCallProps,\n  ActionButtonProps\n} from '../ActionButton'\nimport { GroupDescriptor, MultiToolVariant } from './variants/variants.types'\nimport { useRef } from 'react'\nimport { ToolbarItem, ToolbarItemVariant } from '../../toolbar.types'\nimport action, { UiAction, UiActionAction } from '../../../../action'\n\nimport Icon from '../../../../component/view/icon'\nimport { Portal } from '../../../../Portal'\nimport { chooseMultiTool } from './variants/chooseMultiTool'\nimport classes from './ToolbarMultiToolItem.module.less'\nimport clsx from 'clsx'\nimport { usePortalOpening } from './usePortalOpening'\nimport { usePortalStyle } from './usePortalStyle'\n\ninterface ToolbarMultiToolItemProps {\n  id: ToolbarItemVariant\n  options: ToolbarItem[]\n  groups?: GroupDescriptor[]\n  variant?: MultiToolVariant\n  status: {\n    [key in string]?: UiAction\n  }\n  opened: string | null\n  disableableButtons: string[]\n  indigoVerification: boolean\n  className?: string\n  vertical?: boolean\n}\n\ninterface ToolbarMultiToolItemCallProps {\n  onAction: (action: UiActionAction) => void\n  onOpen: (menuName: string, isSelected: boolean) => void\n}\n\ntype Props = ToolbarMultiToolItemProps & ToolbarMultiToolItemCallProps\n\nconst ToolbarMultiToolItem = (props: Props) => {\n  const {\n    id,\n    options,\n    groups,\n    variant,\n    status,\n    opened,\n    indigoVerification,\n    disableableButtons,\n    className,\n    vertical,\n    onAction,\n    onOpen\n  } = props\n\n  const ref = useRef<HTMLDivElement>(null)\n  const [isOpen] = usePortalOpening([id, opened, options])\n  const [portalStyle] = usePortalStyle([ref, isOpen])\n\n  let selected = false\n  let currentId = id\n\n  const selectedTool = options.find(\n    toolbarItem => status[toolbarItem.id]?.selected\n  )\n  if (selectedTool) {\n    currentId = selectedTool.id\n    selected = true\n  }\n\n  const currentStatus = status[currentId]\n  // todo: #type find out real type, possible GetActionState is no acceptable here\n  // and check this type convert is redundant\n  selected = selected || Boolean(currentStatus?.selected)\n\n  const allInnerItemsHidden: boolean = options.every(\n    option => status[option.id]?.hidden\n  )\n\n  const displayMultiToolItem: boolean = !(\n    allInnerItemsHidden || currentStatus?.hidden\n  )\n\n  if (!currentStatus && options.length) {\n    currentId =\n      options.filter(option => !status[option.id]?.hidden)[0]?.id ||\n      options[0].id\n  }\n\n  const actionButtonProps: Omit<\n    ActionButtonProps & ActionButtonCallProps,\n    'name' | 'status' | 'action'\n  > = {\n    disableableButtons,\n    indigoVerification,\n    onAction\n  }\n\n  const onOpenOptions = () => {\n    // todo: same as #type above\n    onOpen(id, Boolean(currentStatus?.selected))\n  }\n\n  const [Component, portalClassName] = chooseMultiTool(variant)\n\n  return displayMultiToolItem ? (\n    <div ref={ref} className={classes.root}>\n      <ActionButton\n        {...actionButtonProps}\n        className={className}\n        name={currentId}\n        action={action[currentId]}\n        // @ts-ignore\n        status={currentStatus}\n        selected={selected}\n      />\n      <Icon className={classes.icon} name=\"dropdown\" onClick={onOpenOptions} />\n\n      {isOpen ? (\n        <Portal\n          isOpen={isOpen}\n          className={clsx(\n            classes.portal,\n            vertical && classes['portal-vertical'],\n            portalClassName\n          )}\n          style={portalStyle}\n        >\n          <Component\n            options={options}\n            groups={groups}\n            status={status}\n            disableableButtons={disableableButtons}\n            indigoVerification={indigoVerification}\n            onAction={onAction}\n          />\n        </Portal>\n      ) : null}\n    </div>\n  ) : null\n}\n\nexport type { ToolbarMultiToolItemProps, ToolbarMultiToolItemCallProps }\nexport { ToolbarMultiToolItem }\n","/****************************************************************************\n * Copyright 2021 EPAM Systems\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *    http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n ***************************************************************************/\n\nimport { useEffect, useState } from 'react'\n\nimport { ToolbarItem } from '../../toolbar.types'\n\ntype HookParams = [string, string | null, ToolbarItem[]]\n\nfunction usePortalOpening([id, opened, options]: HookParams): [boolean] {\n  const [isOpen, setIsOpen] = useState<boolean>(false)\n\n  useEffect(() => {\n    const currentId = (options.length && options![0].id) || ''\n    const newState = opened === id || opened === currentId\n    setIsOpen(newState)\n  }, [opened, options])\n\n  return [isOpen]\n}\n\nexport { usePortalOpening }\n","/****************************************************************************\n * Copyright 2021 EPAM Systems\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *    http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n ***************************************************************************/\n\nimport { CSSProperties, RefObject, useEffect, useState } from 'react'\n\ntype HookParams = [RefObject<HTMLDivElement>, boolean]\n\nfunction usePortalStyle([ref, isOpen]: HookParams): [CSSProperties] {\n  const [portalStyle, setPortalStyle] = useState<CSSProperties>({})\n\n  useEffect(() => {\n    if (!ref.current) {\n      return\n    }\n\n    const rect = ref.current.getBoundingClientRect()\n    // if content is bigger than page height and user scrolled document, we should correct portal position\n    const scrollOffset = document.scrollingElement?.scrollTop || 0\n    const top = rect.top + scrollOffset\n\n    const spaceBetween = 4\n    const left = rect.left + rect.width + spaceBetween\n\n    setPortalStyle({ top: `${top}px`, left: `${left}px` })\n  }, [ref, ref.current, isOpen])\n\n  return [portalStyle]\n}\n\nexport { usePortalStyle }\n","/****************************************************************************\n * Copyright 2021 EPAM Systems\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *    http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n ***************************************************************************/\n\nimport { DefaultMultiTool, classes as defaultClasses } from './DefaultMultiTool'\nimport {\n  MultiToolCallProps,\n  MultiToolProps,\n  MultiToolVariant\n} from './variants.types'\n\nimport { ComponentType } from 'react'\nimport { GroupedMultiTool } from './GroupedMultiTool'\n\nexport function chooseMultiTool(\n  variant: MultiToolVariant = 'default'\n): [ComponentType<MultiToolProps & MultiToolCallProps>, string?] {\n  switch (variant) {\n    case 'default':\n      return [DefaultMultiTool, defaultClasses.default]\n\n    case 'grouped':\n      return [GroupedMultiTool]\n\n    default:\n      throw new Error(`Unsupported variant ${variant}`)\n  }\n}\n","/****************************************************************************\n * Copyright 2021 EPAM Systems\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *    http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n ***************************************************************************/\n\nimport action, { UiAction, UiActionAction } from '../../../action'\n\nimport { ActionButton } from './ActionButton'\nimport { ToolbarItem } from '../toolbar.types'\nimport { ToolbarMultiToolItem } from './ToolbarMultiToolItem'\n\ninterface ToolbarGroupItemProps extends ToolbarItem {\n  status: {\n    [key in string]?: UiAction\n  }\n  opened: string | null\n  disableableButtons: string[]\n  indigoVerification: boolean\n  className?: string\n  vertical?: boolean\n}\n\ninterface ToolbarGroupItemCallProps {\n  onAction: (action: UiActionAction) => void\n  onOpen: (menuName: string, isSelected: boolean) => void\n}\n\ntype Props = ToolbarGroupItemProps & ToolbarGroupItemCallProps\n\nconst ToolbarGroupItem = (props: Props) => {\n  const {\n    id,\n    options,\n    status,\n    className,\n    opened,\n    indigoVerification,\n    disableableButtons,\n    vertical,\n    onAction,\n    onOpen\n  } = props\n\n  if (!options?.length) {\n    return (\n      <ActionButton\n        className={className}\n        name={id}\n        action={action[id]}\n        // @ts-ignore\n        status={status[id]}\n        selected={!!status[id]?.selected}\n        indigoVerification={indigoVerification}\n        disableableButtons={disableableButtons}\n        onAction={onAction}\n      />\n    )\n  }\n\n  return (\n    <ToolbarMultiToolItem\n      className={className}\n      id={id}\n      options={options}\n      status={status}\n      opened={opened}\n      disableableButtons={disableableButtons}\n      indigoVerification={indigoVerification}\n      onAction={onAction}\n      onOpen={onOpen}\n      vertical={vertical}\n    />\n  )\n}\n\nexport type { ToolbarGroupItemProps, ToolbarGroupItemCallProps }\nexport { ToolbarGroupItem }\n","/****************************************************************************\n * Copyright 2021 EPAM Systems\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *    http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n ***************************************************************************/\n\nimport action, { UiAction, UiActionAction } from '../../../../action'\n\nimport { ActionButton } from '../../ToolbarGroupItem/ActionButton'\nimport templates from '../../../../data/templates'\n\ninterface TemplatesListProps {\n  active?: {\n    tool?: string\n    opts: {\n      struct: any\n    }\n  }\n  disableableButtons: string[]\n  indigoVerification: boolean\n}\n\ninterface TemplatesListCallProps {\n  onAction: (action: UiActionAction) => void\n}\n\ntype Props = TemplatesListProps & TemplatesListCallProps\n\nconst TemplatesList = (props: Props) => {\n  const { active, disableableButtons, indigoVerification, onAction } = props\n\n  const isTemplate = active && active.tool === 'template'\n\n  const makeAction = (struct, index): UiAction => ({\n    shortcut: action[`template-${index}`].shortcut,\n    action: { tool: 'template', opts: { struct } },\n    title: struct.name\n  })\n\n  return (\n    <>\n      {templates.map((struct, index) => (\n        <ActionButton\n          key={`template-${index}`}\n          name={`template-${index}`}\n          action={makeAction(struct, index)}\n          onAction={onAction}\n          selected={isTemplate && active && active.opts.struct === struct}\n          status={action[`template-${index}`]}\n          disableableButtons={disableableButtons}\n          indigoVerification={indigoVerification}\n        />\n      ))}\n    </>\n  )\n}\n\nexport type { TemplatesListProps, TemplatesListCallProps }\nexport { TemplatesList }\n","/****************************************************************************\n * Copyright 2021 EPAM Systems\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *    http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n ***************************************************************************/\n\nimport { FC } from 'react'\nimport {\n  ToolbarGroupItem,\n  ToolbarGroupItemCallProps,\n  ToolbarGroupItemProps\n} from '../ToolbarGroupItem'\n\nimport { TemplatesList } from './TemplatesList'\nimport classes from './BottomToolbar.module.less'\nimport clsx from 'clsx'\n\nconst Group: FC<{ className?: string }> = ({ children, className }) => (\n  <div className={clsx(classes.group, className)}>{children}</div>\n)\n\ninterface BottomToolbarProps\n  extends Omit<ToolbarGroupItemProps, 'id' | 'options'> {\n  className?: string\n  active?: {\n    opts: any\n    tool: string\n  }\n}\n\ninterface BottomToolbarCallProps extends ToolbarGroupItemCallProps {}\n\ntype Props = BottomToolbarProps & BottomToolbarCallProps\n\nconst BottomToolbar = (props: Props) => {\n  const { className, ...rest } = props\n  const { active, disableableButtons, indigoVerification, onAction } = rest\n\n  return (\n    <div className={clsx(classes.root, className)}>\n      <Group>\n        <TemplatesList\n          active={active}\n          indigoVerification={indigoVerification}\n          disableableButtons={disableableButtons}\n          onAction={onAction}\n        />\n      </Group>\n\n      <Group>\n        <ToolbarGroupItem id=\"template-lib\" {...rest} />\n        <ToolbarGroupItem id=\"functional-groups\" {...rest} />\n      </Group>\n    </div>\n  )\n}\n\nexport type { BottomToolbarProps, BottomToolbarCallProps }\nexport { BottomToolbar }\n","/****************************************************************************\n * Copyright 2021 EPAM Systems\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *    http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n ***************************************************************************/\n\nimport { MolSerializer, SdfSerializer } from 'ketcher-core'\n\nimport { appUpdate } from '../options'\nimport { storage } from '../../storage-ext'\n\nexport function initLib(lib) {\n  return {\n    type: 'TMPL_INIT',\n    data: { lib }\n  }\n}\n\nexport default function initTmplLib(dispatch, baseUrl, cacheEl) {\n  const fileName = 'library.sdf'\n  return deserializeSdfTemplates(baseUrl, cacheEl, fileName).then(res => {\n    const lib = res.concat(userTmpls())\n    dispatch(initLib(lib))\n    dispatch(appUpdate({ templates: true }))\n  })\n}\n\nconst deserializeSdfTemplates = (baseUrl, cacheEl, fileName) => {\n  const sdfSerializer = new SdfSerializer()\n  return prefetchStatic(`${baseUrl}/templates/${fileName}`).then(text => {\n    const tmpls = sdfSerializer.deserialize(text)\n    const prefetch = prefetchRender(tmpls, baseUrl + '/templates/', cacheEl)\n\n    return prefetch.then(cachedFiles =>\n      tmpls.map(tmpl => {\n        const pr = prefetchSplit(tmpl)\n        if (pr.file)\n          tmpl.props.prerender =\n            cachedFiles.indexOf(pr.file) !== -1 ? `#${pr.id}` : ''\n\n        return tmpl\n      })\n    )\n  })\n}\n\nfunction userTmpls() {\n  const userLib = storage.getItem('ketcher-tmpls')\n  if (!Array.isArray(userLib) || userLib.length === 0) return []\n  const molSerializer = new MolSerializer()\n  return userLib\n    .map(tmpl => {\n      try {\n        if (tmpl.props === '') tmpl.props = {}\n        tmpl.props.group = 'User Templates'\n\n        return {\n          struct: molSerializer.deserialize(tmpl.struct),\n          props: tmpl.props\n        }\n      } catch (ex) {\n        return null\n      }\n    })\n    .filter(tmpl => tmpl !== null)\n}\n\nexport function prefetchStatic(url) {\n  return fetch(url, { credentials: 'same-origin' }).then(resp => {\n    if (resp.ok) return resp.text()\n    throw Error('Could not fetch ' + url)\n  })\n}\n\nfunction prefetchSplit(tmpl) {\n  const pr = tmpl.props.prerender\n  const res = pr && pr.split('#', 2)\n\n  return {\n    file: pr && res[0],\n    id: pr && res[1]\n  }\n}\n\nfunction prefetchRender(tmpls, baseUrl, cacheEl) {\n  const files = tmpls.reduce((res, tmpl) => {\n    const file = prefetchSplit(tmpl).file\n\n    if (file && res.indexOf(file) === -1) res.push(file)\n\n    return res\n  }, [])\n  const fetch = Promise.all(\n    files.map(fn => prefetchStatic(baseUrl + fn).catch(() => null))\n  )\n\n  return fetch.then(svgs => {\n    svgs.forEach(svgContent => {\n      if (svgContent) cacheEl.innerHTML += svgContent\n    })\n\n    return files.filter((file, i) => !!svgs[i])\n  })\n}\n","/****************************************************************************\n * Copyright 2021 EPAM Systems\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *    http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n ***************************************************************************/\n\nimport { formReducer, formsState } from './form'\n\nexport function openDialog(dispatch, dialogName, props) {\n  return new Promise((resolve, reject) => {\n    dispatch({\n      type: 'MODAL_OPEN',\n      data: {\n        name: dialogName,\n        prop: {\n          ...props,\n          onResult: resolve,\n          onCancel: reject\n        }\n      }\n    })\n  })\n}\n\nfunction modalReducer(state = null, action) {\n  const { type, data } = action\n\n  if (type === 'UPDATE_FORM') {\n    const formState = formReducer(state.form, action, state.name)\n    return { ...state, form: formState }\n  }\n\n  switch (type) {\n    case 'MODAL_CLOSE':\n      return null\n    case 'MODAL_OPEN':\n      return {\n        name: data.name,\n        form: formsState[data.name] || null,\n        prop: data.prop || null\n      }\n    default:\n      return state\n  }\n}\n\nexport default modalReducer\n","/****************************************************************************\n * Copyright 2021 EPAM Systems\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *    http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n ***************************************************************************/\n\nimport initTmplLib, { initLib } from './init-lib'\n\nimport { MolSerializer } from 'ketcher-core'\nimport { omit } from 'lodash/fp'\nimport { openDialog } from '../modal'\nimport { storage } from '../../storage-ext'\n\nexport { initTmplLib }\n\n/* TEMPLATES */\nexport function selectTmpl(tmpl) {\n  return {\n    type: 'TMPL_SELECT',\n    data: { selected: tmpl }\n  }\n}\n\nexport function changeGroup(group) {\n  return {\n    type: 'TMPL_CHANGE_GROUP',\n    data: { group, selected: null }\n  }\n}\n\nexport function changeFilter(filter) {\n  return {\n    type: 'TMPL_CHANGE_FILTER',\n    data: { filter: filter.trim(), selected: null } // TODO: change this\n  }\n}\n\n/* TEMPLATE-ATTACH-EDIT */\nexport function initAttach(name, attach) {\n  return {\n    type: 'INIT_ATTACH',\n    data: {\n      name,\n      atomid: attach.atomid,\n      bondid: attach.bondid\n    }\n  }\n}\n\nexport function setAttachPoints(attach) {\n  return {\n    type: 'SET_ATTACH_POINTS',\n    data: {\n      atomid: attach.atomid,\n      bondid: attach.bondid\n    }\n  }\n}\n\nexport function setTmplName(name) {\n  return {\n    type: 'SET_TMPL_NAME',\n    data: { name }\n  }\n}\n\nexport function editTmpl(tmpl) {\n  return (dispatch, getState) => {\n    openDialog(dispatch, 'attach', { tmpl })\n      .then(\n        formData => {\n          tmpl.struct.name = formData ? formData.name.trim() : tmpl.struct.name\n          tmpl.props = formData\n            ? Object.assign({}, tmpl.props, formData.attach)\n            : tmpl.props\n\n          if (tmpl.props.group === 'User Templates')\n            updateLocalStore(getState().templates.lib)\n        },\n        () => null\n      )\n      .then(() => openDialog(dispatch, 'templates').catch(() => null))\n  }\n}\n\nexport function deleteUserTmpl(tmpl) {\n  return {\n    type: 'TMPL_DELETE',\n    data: {\n      tmpl: tmpl\n    }\n  }\n}\n\nexport function deleteTmpl(tmpl) {\n  return (dispatch, getState) => {\n    const lib = getState().templates.lib.filter(value => value !== tmpl)\n    dispatch(deleteUserTmpl(tmpl))\n    updateLocalStore(lib)\n  }\n}\n\n/* SAVE */\nexport function saveUserTmpl(struct) {\n  // TODO: structStr can be not in mol format => structformat.toString ...\n  const tmpl = { struct: struct.clone(), props: {} }\n\n  return (dispatch, getState) => {\n    openDialog(dispatch, 'attach', { tmpl })\n      .then(({ name, attach }) => {\n        tmpl.struct.name = name.trim()\n        tmpl.props = { ...attach, group: 'User Templates' }\n\n        const lib = getState().templates.lib.concat(tmpl)\n        dispatch(initLib(lib))\n        updateLocalStore(lib)\n      })\n      .catch(() => null)\n  }\n}\n\nfunction updateLocalStore(lib) {\n  const molSerializer = new MolSerializer()\n  const userLib = lib\n    .filter(item => item.props.group === 'User Templates')\n    .map(item => ({\n      struct: molSerializer.serialize(item.struct),\n      props: Object.assign({}, omit(['group'], item.props))\n    }))\n\n  storage.setItem('ketcher-tmpls', userLib)\n}\n\n/* REDUCER */\nexport const initTmplsState = {\n  lib: [],\n  selected: null,\n  filter: '',\n  group: null,\n  attach: {},\n  mode: 'classic'\n}\n\nconst tmplActions = [\n  'TMPL_INIT',\n  'TMPL_SELECT',\n  'TMPL_CHANGE_GROUP',\n  'TMPL_CHANGE_FILTER'\n]\n\nconst attachActions = ['INIT_ATTACH', 'SET_ATTACH_POINTS', 'SET_TMPL_NAME']\n\nfunction templatesReducer(state = initTmplsState, action) {\n  if (tmplActions.includes(action.type))\n    return Object.assign({}, state, action.data)\n\n  if (attachActions.includes(action.type)) {\n    const attach = Object.assign({}, state.attach, action.data)\n    return { ...state, attach }\n  }\n\n  if (action.type === 'TMPL_DELETE') {\n    const currentState = Object.assign({}, state)\n    const lib = currentState.lib.filter(value => value !== action.data.tmpl)\n    return { ...currentState, lib: lib }\n  }\n\n  return state\n}\n\nexport default templatesReducer\n","/****************************************************************************\n * Copyright 2021 EPAM Systems\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *    http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n ***************************************************************************/\n\nimport { isEmpty, isEqual, pickBy } from 'lodash/fp'\n\nimport actions from '../../action'\n\nfunction execute(activeTool, { action, editor, server, options }) {\n  if (action.tool) {\n    if (editor.tool(action.tool, action.opts)) {\n      return action\n    }\n  } else if (typeof action === 'function') {\n    action(editor, server, options)\n  } else {\n    console.info('no action')\n  }\n  return activeTool\n}\n\nfunction selected(actObj, activeTool, { editor, server }) {\n  if (typeof actObj.selected === 'function')\n    return actObj.selected(editor, server)\n  else if (actObj.action && actObj.action.tool)\n    return isEqual(activeTool, actObj.action)\n  return false\n}\n\nfunction disabled(actObj, { editor, server, options }) {\n  if (typeof actObj.disabled === 'function')\n    return actObj.disabled(editor, server, options)\n  return false\n}\n\nfunction hidden(actObj, { options }) {\n  if (typeof actObj.hidden === 'function') return actObj.hidden(options)\n  return false\n}\n\nfunction status(actionName, activeTool, params) {\n  const actObj = actions[actionName]\n  return pickBy(x => x, {\n    selected: selected(actObj, activeTool, params),\n    disabled: disabled(actObj, params),\n    hidden: hidden(actObj, params)\n  })\n}\n\nexport default function (state = null, { type, action, ...params }) {\n  let activeTool\n  switch (type) {\n    case 'INIT':\n      action = actions['select-lasso'].action\n    case 'ACTION': // eslint-disable-line no-case-declarations\n      activeTool = execute(state && state.activeTool, {\n        ...params,\n        action\n      })\n    case 'UPDATE':\n      return Object.keys(actions).reduce(\n        (res, actionName) => {\n          const value = status(actionName, res.activeTool, params)\n          if (!isEmpty(value)) res[actionName] = value\n          return res\n        },\n        { activeTool: activeTool || state.activeTool }\n      )\n    default:\n      return state\n  }\n}\n","/****************************************************************************\n * Copyright 2021 EPAM Systems\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *    http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n ***************************************************************************/\n\nimport { capitalize, isEqual, throttle } from 'lodash/fp'\n\nimport { basicAtoms } from '../../action/atoms'\nimport tools from '../../action/tools'\n\nconst initial = {\n  freqAtoms: [],\n  currentAtom: 0,\n  opened: null,\n  visibleTools: {\n    select: 'select-lasso'\n  }\n}\nconst MAX_ATOMS = 7\n\nfunction updateVisibleTools(visibleTool, activeTool) {\n  const regExp = /(bond)(-)(common|stereo|query)/\n  const menuHeight = window.innerHeight\n\n  return Object.keys(visibleTool).reduce(\n    (res, key) => {\n      if (key === 'bond' && menuHeight > 700) return res // TODO remove me after update styles\n      if (key === 'transform' && menuHeight > 800) return res\n      if (key === 'rgroup' && menuHeight > 850) return res\n      if (key === 'shape' && menuHeight > 900) return res\n      if (!key.match(regExp) || menuHeight > 700) res[key] = visibleTool[key]\n      return res\n    },\n    { ...activeTool }\n  )\n}\n\nexport function initResize() {\n  return function (dispatch, getState) {\n    const onResize = throttle(250, () => {\n      const state = getState()\n      state.editor.render.update()\n      dispatch({ type: 'CLEAR_VISIBLE', data: state.actionState.activeTool })\n    })\n    addEventListener('resize', onResize) // eslint-disable-line\n  }\n}\n\n/* REDUCER */\nexport default function (state = initial, action) {\n  const { type, data } = action\n\n  switch (type) {\n    case 'ACTION': {\n      const visibleTool = toolInMenu(action.action)\n      return visibleTool\n        ? {\n            ...state,\n            opened: null,\n            visibleTools: { ...state.visibleTools, ...visibleTool }\n          }\n        : { ...state, opened: null }\n    }\n    case 'ADD_ATOMS': {\n      const newState = addFreqAtom(data, state.freqAtoms, state.currentAtom)\n      return { ...state, ...newState }\n    }\n    case 'CLEAR_VISIBLE': {\n      const activeTool = toolInMenu(action.data)\n      const correctTools = updateVisibleTools(state.visibleTools, activeTool)\n      return { ...state, opened: null, visibleTools: { ...correctTools } }\n    }\n    case 'OPENED': {\n      return data.isSelected && state.opened\n        ? { ...state, opened: null }\n        : { ...state, opened: data.menuName }\n    }\n    case 'UPDATE':\n      return { ...state, opened: null }\n    case 'MODAL_OPEN':\n      return { ...state, opened: null }\n    default:\n      return state\n  }\n}\n/* ------- */\n\nfunction addFreqAtom(label, freqAtoms, index) {\n  label = capitalize(label)\n  if (basicAtoms.indexOf(label) > -1 || freqAtoms.indexOf(label) !== -1)\n    return { freqAtoms }\n\n  freqAtoms[index] = label\n  index = (index + 1) % MAX_ATOMS\n\n  return { freqAtoms, currentAtom: index }\n}\n\nexport function addAtoms(atomLabel) {\n  return {\n    type: 'ADD_ATOMS',\n    data: atomLabel\n  }\n}\n\nfunction toolInMenu(action) {\n  const tool = Object.keys(tools).find(toolName =>\n    isEqual(action, tools[toolName].action)\n  )\n\n  const sel = document.getElementById(tool)\n  const dropdown = sel && hiddenAncestor(sel)\n\n  return dropdown && dropdown.id !== '' ? { [dropdown.id]: sel.id } : null\n}\n\nexport function hiddenAncestor(el, base) {\n  base = base || document.body\n  let findEl = el\n\n  while (\n    findEl &&\n    window.getComputedStyle(findEl).overflow !== 'hidden' &&\n    !findEl.classList.contains('opened')\n  ) {\n    if (findEl === base) return null\n    findEl = findEl.parentNode\n  }\n\n  return findEl\n}\n","/****************************************************************************\n * Copyright 2021 EPAM Systems\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *    http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n ***************************************************************************/\n\nimport { AnyAction } from 'redux'\nimport { appUpdate } from '../options'\nimport {\n  FunctionalGroupsProvider,\n  SdfItem,\n  SdfSerializer,\n  Struct\n} from 'ketcher-core'\nimport { prefetchStatic } from '../templates/init-lib'\n\ninterface FGState {\n  lib: []\n  mode: string\n}\n\nconst initialState: FGState = {\n  lib: [],\n  mode: 'fg'\n}\n\nconst functionalGroupsReducer = (\n  state = initialState,\n  { type, payload }: AnyAction\n) => {\n  switch (type) {\n    case 'FG_INIT':\n      return { ...state, ...payload }\n\n    default:\n      return state\n  }\n}\n\nconst initFGroups = (lib: SdfItem[]) => ({ type: 'FG_INIT', payload: { lib } })\n\nexport function initFGTemplates(baseUrl: string) {\n  return async dispatch => {\n    const fileName = 'fg.sdf'\n    const url = `${baseUrl}/templates/${fileName}`\n    const provider = FunctionalGroupsProvider.getInstance()\n    const sdfSerializer = new SdfSerializer()\n    const text = await prefetchStatic(url)\n    const templates = sdfSerializer.deserialize(text)\n    const functionalGroups = templates.reduce(\n      (acc: Struct[], { struct }) => [...acc, struct],\n      []\n    )\n    provider.setFunctionalGroupsList(functionalGroups)\n    dispatch(initFGroups(templates))\n    dispatch(appUpdate({ functionalGroups: true }))\n  }\n}\n\nexport default functionalGroupsReducer\n","/****************************************************************************\n * Copyright 2021 EPAM Systems\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *    http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n ***************************************************************************/\n\nimport { applyMiddleware, combineReducers, createStore } from 'redux'\nimport { load, onAction } from './shared'\nimport optionsReducer, { initOptionsState } from './options'\nimport templatesReducer, { initTmplsState } from './templates'\n\nimport actionStateReducer from './action'\nimport { logger } from 'redux-logger'\nimport modalReducer from './modal'\nimport { pick } from 'lodash/fp'\nimport requestReducer from './request'\nimport thunk from 'redux-thunk'\nimport toolbarReducer from './toolbar'\nimport functionalGroupsReducer from './functionalGroups'\n\nexport { onAction, load }\n\nconst shared = combineReducers({\n  actionState: actionStateReducer,\n  toolbar: toolbarReducer,\n  modal: modalReducer,\n  server: (store = null) => store,\n  editor: (store = null) => store,\n  options: optionsReducer,\n  templates: templatesReducer,\n  functionalGroups: functionalGroupsReducer,\n  requestsStatuses: requestReducer\n})\n\nfunction getRootReducer(setEditor) {\n  return function root(state, action) {\n    switch (\n      action.type // eslint-disable-line default-case\n    ) {\n      case 'INIT':\n        setEditor(action.editor)\n\n      case 'UPDATE': // eslint-disable-line no-case-declarations\n        const { type, ...data } = action\n        if (data) state = { ...state, ...data }\n    }\n\n    const sh = shared(state, {\n      ...action,\n      ...pick(['editor', 'server', 'options'], state)\n    })\n\n    const finalState =\n      sh === state.shared\n        ? state\n        : {\n            ...state,\n            ...sh\n          }\n\n    //TODO: temporary solution. Need to review work with redux store\n    global.currentState = finalState\n    return finalState\n  }\n}\n\nexport default function (options, server, setEditor) {\n  const { buttons = {}, ...restOptions } = options\n\n  // TODO: redux localStorage here\n  const initState = {\n    actionState: null,\n    editor: null,\n    modal: null,\n    options: Object.assign(initOptionsState, { app: restOptions, buttons }),\n    server: server || Promise.reject(new Error('Standalone mode!')),\n    templates: initTmplsState\n  }\n\n  const middleware = [thunk]\n\n  if (process.env.NODE_ENV !== 'production') middleware.push(logger)\n\n  const rootReducer = getRootReducer(setEditor)\n  return createStore(rootReducer, initState, applyMiddleware(...middleware))\n}\n","/****************************************************************************\n * Copyright 2021 EPAM Systems\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *    http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n ***************************************************************************/\n\nimport {\n  BottomToolbar,\n  BottomToolbarCallProps,\n  BottomToolbarProps\n} from './BottomToolbar'\n\nimport { ComponentType } from 'react'\nimport { Dispatch } from 'redux'\nimport { connect } from 'react-redux'\nimport { onAction } from '../../../state'\n\ntype StateProps = Omit<BottomToolbarProps, 'className'>\ntype OwnProps = Pick<BottomToolbarProps, 'className'>\n\nconst mapStateToProps = (state): StateProps => ({\n  active: state.actionState && state.actionState.activeTool,\n  status: state.actionState || {},\n  opened: state.toolbar.opened,\n  indigoVerification: state.requestsStatuses.indigoVerification,\n  disableableButtons: []\n})\n\nconst mapDispatchToProps = (dispatch: Dispatch): BottomToolbarCallProps => ({\n  onAction: action => dispatch(onAction(action)),\n  onOpen: (menuName, isSelected) =>\n    dispatch({\n      type: 'OPENED',\n      data: { menuName, isSelected }\n    })\n})\n\nconst BottomToolbarContainer: ComponentType<OwnProps> = connect(\n  mapStateToProps,\n  mapDispatchToProps\n)(BottomToolbar)\n\nexport { BottomToolbarContainer }\n","/****************************************************************************\n * Copyright 2021 EPAM Systems\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *    http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n ***************************************************************************/\n\nimport { ToolbarItem, ToolbarItemVariant } from '../../toolbar.types'\n\nfunction makeItems(ids: ToolbarItemVariant[]): ToolbarItem[] {\n  return ids.map(id => ({ id }))\n}\n\nexport { makeItems }\n","/****************************************************************************\n * Copyright 2021 EPAM Systems\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *    http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n ***************************************************************************/\n\nimport { GroupDescriptor } from '../../ToolbarGroupItem/ToolbarMultiToolItem/variants/variants.types'\nimport { ToolbarItem } from '../../toolbar.types'\nimport { makeItems } from '../../ToolbarGroupItem/utils'\n\nconst bondCommon: ToolbarItem[] = makeItems([\n  'bond-single',\n  'bond-double',\n  'bond-triple'\n])\nconst bondStereo: ToolbarItem[] = makeItems([\n  'bond-up',\n  'bond-down',\n  'bond-updown',\n  'bond-crossed'\n])\nconst bondQuery: ToolbarItem[] = makeItems([\n  'bond-any',\n  'bond-aromatic',\n  'bond-singledouble',\n  'bond-singlearomatic',\n  'bond-doublearomatic'\n])\nconst bondSpecial: ToolbarItem[] = makeItems(['bond-dative', 'bond-hydrogen'])\n\nconst groups = [bondCommon, bondStereo, bondQuery, bondSpecial]\nconst groupOptions = groups.flat()\nconst groupDescriptors = groups.reduce((accum, group, index) => {\n  const start = accum[index - 1]?.end || 0\n\n  accum.push({\n    start: start,\n    end: start + group.length\n  })\n\n  return accum\n}, [] as GroupDescriptor[])\n\nexport {\n  bondCommon,\n  bondStereo,\n  bondQuery,\n  bondSpecial,\n  groupOptions,\n  groupDescriptors\n}\n","import { bondCommon, bondQuery, bondSpecial, bondStereo } from './Bond/options'\nimport { makeItems } from '../ToolbarGroupItem/utils'\nimport { ToolbarItem } from '../toolbar.types'\n\nconst rGroupOptions: ToolbarItem[] = makeItems([\n  'rgroup-label',\n  'rgroup-fragment',\n  'rgroup-attpoints'\n])\n\nconst shapeOptions: ToolbarItem[] = makeItems([\n  'shape-ellipse',\n  'shape-rectangle',\n  'shape-line'\n])\n\nconst transformOptions: ToolbarItem[] = makeItems([\n  'transform-rotate',\n  'transform-flip-h',\n  'transform-flip-v'\n])\n\nconst selectOptions: ToolbarItem[] = makeItems([\n  'select-lasso',\n  'select-rectangle',\n  'select-fragment'\n])\n\nconst arrowsOptions: ToolbarItem[] = makeItems([\n  'reaction-arrow-open-angle',\n  'reaction-arrow-filled-triangle',\n  'reaction-arrow-filled-bow',\n  'reaction-arrow-dashed-open-angle',\n  'reaction-arrow-failed',\n  'reaction-arrow-both-ends-filled-triangle',\n  'reaction-arrow-equilibrium-filled-half-bow',\n  'reaction-arrow-equilibrium-filled-triangle',\n  'reaction-arrow-equilibrium-open-angle',\n  'reaction-arrow-unbalanced-equilibrium-filled-half-bow',\n  'reaction-arrow-unbalanced-equilibrium-open-half-angle',\n  'reaction-arrow-unbalanced-equilibrium-large-filled-half-bow',\n  'reaction-arrow-unbalanced-equilibrium-filled-half-triangle'\n])\n\nconst mappingOptions: ToolbarItem[] = makeItems([\n  'reaction-map',\n  'reaction-unmap',\n  'reaction-automap'\n])\n\nexport {\n  rGroupOptions,\n  bondCommon,\n  bondQuery,\n  bondSpecial,\n  bondStereo,\n  shapeOptions,\n  transformOptions,\n  selectOptions,\n  arrowsOptions,\n  mappingOptions\n}\n","/****************************************************************************\n * Copyright 2021 EPAM Systems\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *    http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n ***************************************************************************/\n\nimport React from 'react'\nimport SettingsContext from './../contexts/settingsContext'\n\nexport function useSettingsContext() {\n  return React.useContext(SettingsContext)\n}\n","/****************************************************************************\n * Copyright 2021 EPAM Systems\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *    http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n ***************************************************************************/\n\nimport { RefCallback, RefObject, useMemo, useState } from 'react'\n\nimport { throttle } from 'lodash'\nimport useResizeObserver from 'use-resize-observer/polyfilled'\n\nconst throttleMilliseconds = 100\n\ntype Size = {\n  width: number | undefined\n  height: number | undefined\n}\n\ntype Options<THTMLElement extends HTMLElement> = {\n  ref?: RefObject<THTMLElement> | THTMLElement | null | undefined\n}\n\ntype HookResponse<THTMLElement extends HTMLElement> = {\n  ref: RefCallback<THTMLElement>\n  width: number | undefined\n  height: number | undefined\n}\n\nfunction useThrottleResizeObserver<THTMLElement extends HTMLElement>(\n  options: Options<THTMLElement> = {}\n): HookResponse<THTMLElement> {\n  const [size, setSize] = useState<Size>({\n    height: undefined,\n    width: undefined\n  })\n\n  const onResize = useMemo(() => throttle(setSize, throttleMilliseconds), [])\n\n  const { ref } = useResizeObserver<THTMLElement>({ onResize, ...options })\n  return { ref, ...size }\n}\n\nexport { useThrottleResizeObserver as useResizeObserver }\n","/****************************************************************************\n * Copyright 2021 EPAM Systems\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *    http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n ***************************************************************************/\n\nimport FormContext from './../contexts/formContext'\nimport React from 'react'\n\nexport function useFormContext() {\n  return React.useContext(FormContext)\n}\n","/****************************************************************************\n * Copyright 2021 EPAM Systems\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *    http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n ***************************************************************************/\n\nimport AppContext from '../contexts/appContext'\nimport React from 'react'\n\nexport const useAppContext = () => React.useContext(AppContext)\n","/****************************************************************************\n * Copyright 2021 EPAM Systems\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *    http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n ***************************************************************************/\n\nimport { useEffect, useRef } from 'react'\n\nexport const useInterval = (callback: () => void, delay: number | null) => {\n  const savedCallback = useRef(callback)\n\n  // Remember the latest callback if it changes.\n  useEffect(() => {\n    savedCallback.current = callback\n  }, [callback])\n\n  // Set up the interval.\n  useEffect(() => {\n    // Don't schedule if no delay is specified.\n    if (delay === null) {\n      return\n    }\n\n    const id = setInterval(() => savedCallback.current(), delay)\n\n    return () => clearInterval(id)\n  }, [delay])\n}\n","/****************************************************************************\n * Copyright 2021 EPAM Systems\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *    http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n ***************************************************************************/\n\nimport classes from './ArrowScroll.module.less'\nimport clsx from 'clsx'\nimport { useEffect, useState } from 'react'\nimport { useInterval } from '../../../../../hooks'\n\ninterface ArrowScrollProps {\n  startInView: boolean\n  endInView: boolean\n  scrollUp: any\n  scrollDown: any\n}\n\nconst ArrowScroll = ({\n  startInView,\n  endInView,\n  scrollUp,\n  scrollDown\n}: ArrowScrollProps) => {\n  const [isScrollDown, setScrollDown] = useState(false)\n  const [isScrollUp, setScrollUp] = useState(false)\n  useInterval(scrollDown, isScrollDown ? 100 : null)\n  useInterval(scrollUp, isScrollUp ? 100 : null)\n\n  useEffect(() => {\n    return () => {\n      setScrollUp(false)\n    }\n  }, [startInView])\n\n  useEffect(() => {\n    return () => {\n      setScrollDown(false)\n    }\n  }, [endInView])\n\n  return (\n    <div className={classes.scroll}>\n      {endInView ? (\n        <></>\n      ) : (\n        <button\n          onClick={() => scrollDown()}\n          onMouseUp={() => setScrollDown(false)}\n          onMouseDown={() => setScrollDown(true)}\n          className={clsx(classes.button, classes.down)}\n        >\n          ‚ñº\n        </button>\n      )}\n      {startInView ? (\n        <></>\n      ) : (\n        <button\n          onClick={() => scrollUp()}\n          onMouseUp={() => setScrollUp(false)}\n          onMouseDown={() => setScrollUp(true)}\n          className={clsx(classes.button, classes.up)}\n        >\n          ‚ñ≤\n        </button>\n      )}\n    </div>\n  )\n}\n\nexport { ArrowScroll }\n","/****************************************************************************\n * Copyright 2021 EPAM Systems\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *    http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n ***************************************************************************/\n\nconst mediaSizes = {\n  topSeparatorsShowingWidth: 1080,\n  zoomShowingWidth: 780,\n  infoShowingWidth: 790,\n  bondCollapsableHeight: 770,\n  rGroupCollapsableHeight: 1000,\n  shapeCollapsableHeight: 1000,\n  transformCollapsableHeight: 870\n}\n\nexport { mediaSizes }\n","/****************************************************************************\n * Copyright 2021 EPAM Systems\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *    http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n ***************************************************************************/\n\nimport {\n  ToolbarGroupItemCallProps,\n  ToolbarGroupItemProps\n} from '../../ToolbarGroupItem'\nimport {\n  bondCommon,\n  bondQuery,\n  bondSpecial,\n  bondStereo,\n  groupDescriptors,\n  groupOptions\n} from './options'\n\nimport { ToolbarMultiToolItem } from '../../ToolbarGroupItem/ToolbarMultiToolItem'\nimport { mediaSizes } from '../../mediaSizes'\n\ninterface BondProps extends Omit<ToolbarGroupItemProps, 'id' | 'options'> {\n  height?: number\n}\ninterface BondCallProps extends ToolbarGroupItemCallProps {}\n\ntype Props = BondProps & BondCallProps\n\nconst Bond = (props: Props) => {\n  const { height, ...rest } = props\n\n  if (height && height <= mediaSizes.bondCollapsableHeight) {\n    return (\n      <ToolbarMultiToolItem\n        id=\"bonds\"\n        options={groupOptions}\n        variant=\"grouped\"\n        groups={groupDescriptors}\n        {...rest}\n      />\n    )\n  }\n\n  return (\n    <>\n      <ToolbarMultiToolItem id=\"bond-common\" options={bondCommon} {...rest} />\n      <ToolbarMultiToolItem id=\"bond-stereo\" options={bondStereo} {...rest} />\n      <ToolbarMultiToolItem id=\"bond-query\" options={bondQuery} {...rest} />\n      <ToolbarMultiToolItem id=\"bond-special\" options={bondSpecial} {...rest} />\n    </>\n  )\n}\n\nexport type { BondProps, BondCallProps }\nexport { Bond }\n","/****************************************************************************\n * Copyright 2021 EPAM Systems\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *    http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n ***************************************************************************/\n\nimport {\n  ToolbarGroupItem,\n  ToolbarGroupItemCallProps,\n  ToolbarGroupItemProps\n} from '../../ToolbarGroupItem'\n\nimport { rGroupOptions } from '../leftToolbarOptions'\n\ninterface RGroupProps extends Omit<ToolbarGroupItemProps, 'id' | 'options'> {\n  height?: number\n}\ninterface RGroupCallProps extends ToolbarGroupItemCallProps {}\n\ntype Props = RGroupProps & RGroupCallProps\n\nconst RGroup = (props: Props) => {\n  return <ToolbarGroupItem id=\"rgroup\" options={rGroupOptions} {...props} />\n}\n\nexport type { RGroupProps, RGroupCallProps }\nexport { RGroup }\n","/****************************************************************************\n * Copyright 2021 EPAM Systems\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *    http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n ***************************************************************************/\n\nimport {\n  ToolbarGroupItem,\n  ToolbarGroupItemCallProps,\n  ToolbarGroupItemProps\n} from '../../ToolbarGroupItem'\n\nimport { shapeOptions } from '../leftToolbarOptions'\n\ninterface ShapeProps extends Omit<ToolbarGroupItemProps, 'id' | 'options'> {\n  height?: number\n}\ninterface ShapeCallProps extends ToolbarGroupItemCallProps {}\n\ntype Props = ShapeProps & ShapeCallProps\n\nconst Shape = (props: Props) => {\n  return <ToolbarGroupItem id=\"shapes\" options={shapeOptions} {...props} />\n}\n\nexport type { ShapeProps, ShapeCallProps }\nexport { Shape }\n","/****************************************************************************\n * Copyright 2021 EPAM Systems\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *    http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n ***************************************************************************/\n\nimport {\n  ToolbarGroupItem,\n  ToolbarGroupItemCallProps,\n  ToolbarGroupItemProps\n} from '../../ToolbarGroupItem'\n\nimport { transformOptions } from '../leftToolbarOptions'\nimport { mediaSizes } from '../../mediaSizes'\n\ninterface TransformProps extends Omit<ToolbarGroupItemProps, 'id' | 'options'> {\n  height?: number\n}\ninterface TransformCallProps extends ToolbarGroupItemCallProps {}\n\ntype Props = TransformProps & TransformCallProps\n\nconst Transform = (props: Props) => {\n  const { height, ...rest } = props\n\n  if (height && height <= mediaSizes.transformCollapsableHeight) {\n    return (\n      <ToolbarGroupItem id=\"transforms\" options={transformOptions} {...rest} />\n    )\n  }\n\n  return (\n    <>\n      <ToolbarGroupItem id=\"transform-rotate\" {...rest} />\n      <ToolbarGroupItem id=\"transform-flip-h\" {...rest} />\n      <ToolbarGroupItem id=\"transform-flip-v\" {...rest} />\n    </>\n  )\n}\n\nexport type { TransformProps, TransformCallProps }\nexport { Transform }\n","/****************************************************************************\n * Copyright 2021 EPAM Systems\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *    http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n ***************************************************************************/\n\nimport { FC, MutableRefObject, useRef } from 'react'\nimport {\n  ToolbarGroupItem,\n  ToolbarGroupItemCallProps,\n  ToolbarGroupItemProps\n} from '../ToolbarGroupItem'\nimport { ToolbarItem, ToolbarItemVariant } from '../toolbar.types'\nimport {\n  arrowsOptions,\n  bondCommon,\n  bondQuery,\n  bondSpecial,\n  bondStereo,\n  mappingOptions,\n  rGroupOptions,\n  selectOptions,\n  shapeOptions,\n  transformOptions\n} from './leftToolbarOptions'\n\nimport { ArrowScroll } from '../ArrowScroll'\nimport { Bond } from './Bond'\nimport { RGroup } from './RGroup'\nimport { Shape } from './Shape'\nimport { Transform } from './Transform'\nimport classes from './LeftToolbar.module.less'\nimport clsx from 'clsx'\nimport { useInView } from 'react-intersection-observer'\nimport { useResizeObserver } from '../../../../../hooks'\n\ninterface LeftToolbarProps\n  extends Omit<ToolbarGroupItemProps, 'id' | 'options'> {\n  className?: string\n}\n\ninterface LeftToolbarCallProps extends ToolbarGroupItemCallProps {}\n\ntype Props = LeftToolbarProps & LeftToolbarCallProps\n\nconst LeftToolbar = (props: Props) => {\n  const { className, ...rest } = props\n  const { ref, height } = useResizeObserver<HTMLDivElement>()\n  const scrollRef = useRef() as MutableRefObject<HTMLDivElement>\n  const [startRef, startInView] = useInView({ threshold: 0.8 })\n  const [endRef, endInView] = useInView({ threshold: 0.8 })\n  const sizeRef = useRef() as MutableRefObject<HTMLDivElement>\n\n  type ItemProps = {\n    id: ToolbarItemVariant\n    options?: ToolbarItem[]\n  }\n  const Item = ({ id, options }: ItemProps) =>\n    ToolbarGroupItem({ id, options, ...rest })\n\n  const scrollUp = () => {\n    scrollRef.current.scrollTop -= sizeRef.current.offsetHeight\n  }\n\n  const scrollDown = () => {\n    scrollRef.current.scrollTop += sizeRef.current.offsetHeight\n  }\n\n  const status = rest.status\n\n  type GroupItem = ItemProps\n\n  const Group: FC<{ items?: GroupItem[]; className?: string }> = ({\n    items,\n    className\n  }) => {\n    const visibleItems: GroupItem[] = []\n    if (items) {\n      items.forEach(item => {\n        let visible = true\n        if (status[item.id]?.hidden) {\n          visible = false\n        } else if (item.options?.every(option => status[option.id]?.hidden)) {\n          visible = false\n        }\n        if (visible) visibleItems.push(item)\n      })\n    }\n    return visibleItems.length ? (\n      <div className={clsx(classes.group, className)}>\n        {visibleItems.map(item => {\n          switch (item.id) {\n            case 'bond-common':\n              return <Bond {...rest} height={height} key={item.id} />\n            case 'transform-rotate':\n              return <Transform {...rest} height={height} key={item.id} />\n            case 'rgroup':\n              return <RGroup {...rest} key={item.id} />\n            case 'shapes':\n              return <Shape {...rest} key={item.id} />\n            default:\n              return <Item id={item.id} options={item.options} key={item.id} />\n          }\n        })}\n      </div>\n    ) : null\n  }\n\n  return (\n    <div className={clsx(classes.root, className)} ref={ref}>\n      <div className={classes.buttons} ref={scrollRef}>\n        <div className={classes.listener} ref={startRef}>\n          <Group\n            items={[{ id: 'select', options: selectOptions }, { id: 'erase' }]}\n          />\n        </div>\n\n        <Group\n          items={[\n            {\n              id: 'bonds',\n              options: [\n                ...bondCommon,\n                ...bondQuery,\n                ...bondSpecial,\n                ...bondStereo\n              ]\n            },\n            { id: 'chain' }\n          ]}\n        />\n\n        <Group items={[{ id: 'charge-plus' }, { id: 'charge-minus' }]} />\n\n        <Group\n          items={[\n            {\n              id: 'transforms',\n              options: transformOptions\n            }\n          ]}\n        />\n\n        <Group items={[{ id: 'sgroup' }, { id: 'sgroup-data' }]} />\n\n        <Group\n          items={[\n            { id: 'reaction-plus' },\n            { id: 'arrows', options: arrowsOptions },\n            {\n              id: 'reaction-mapping-tools',\n              options: mappingOptions\n            }\n          ]}\n        />\n        <div className={classes.listener} ref={sizeRef}>\n          <Group items={[{ id: 'rgroup', options: rGroupOptions }]} />\n        </div>\n\n        <Group items={[{ id: 'shapes', options: shapeOptions }]} />\n\n        <div ref={endRef}>\n          <Group items={[{ id: 'text' }]} />\n        </div>\n      </div>\n      <ArrowScroll\n        startInView={startInView}\n        endInView={endInView}\n        scrollUp={scrollUp}\n        scrollDown={scrollDown}\n      />\n    </div>\n  )\n}\n\nexport type { LeftToolbarProps, LeftToolbarCallProps }\nexport { LeftToolbar }\n","/****************************************************************************\n * Copyright 2021 EPAM Systems\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *    http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n ***************************************************************************/\n\nimport {\n  LeftToolbar,\n  LeftToolbarCallProps,\n  LeftToolbarProps\n} from './LeftToolbar'\n\nimport { Dispatch } from 'redux'\nimport { connect } from 'react-redux'\nimport { onAction } from '../../../state'\n\ntype StateProps = Omit<LeftToolbarProps, 'className'>\n\nconst mapStateToProps = (state: any): StateProps => ({\n  status: state.actionState || {},\n  opened: state.toolbar.opened,\n  indigoVerification: state.requestsStatuses.indigoVerification,\n  disableableButtons: []\n})\n\nconst mapDispatchToProps = (dispatch: Dispatch): LeftToolbarCallProps => ({\n  onAction: action => dispatch(onAction(action)),\n  onOpen: (menuName, isSelected) =>\n    dispatch({\n      type: 'OPENED',\n      data: { menuName, isSelected }\n    })\n})\n\nconst LeftToolbarContainer = connect(\n  mapStateToProps,\n  mapDispatchToProps\n)(LeftToolbar)\n\nexport { LeftToolbarContainer }\n","/****************************************************************************\n * Copyright 2021 EPAM Systems\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *    http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n ***************************************************************************/\n\nimport { ElementColor } from 'ketcher-core'\n\nfunction Atom({ el, shortcut, className, ...props }) {\n  return (\n    <button\n      title={shortcut ? `${el.title} (${shortcut})` : el.title}\n      className={className}\n      style={{ color: ElementColor[el.label] }}\n      value={el.number}\n      {...props}\n    >\n      <span>{el.label}</span>\n    </button>\n  )\n}\n\nexport default Atom\n","/****************************************************************************\n * Copyright 2021 EPAM Systems\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *    http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n ***************************************************************************/\n\nimport { atomCuts, basicAtoms } from '../../../../action/atoms'\n\nimport Atom from '../../../../component/view/Atom'\nimport { Elements } from 'ketcher-core'\nimport { UiActionAction } from '../../../../action'\nimport classes from '../../ToolbarGroupItem/ActionButton/ActionButton.module.less'\nimport clsx from 'clsx'\nimport { shortcutStr } from '../../shortcutStr'\nimport { forwardRef } from 'react'\n\ninterface AtomsListProps {\n  atoms: string[]\n  active?: {\n    tool?: string\n    opts: {\n      label: any\n    }\n  }\n}\n\ninterface AtomsListCallProps {\n  onAction: (action: UiActionAction) => void\n}\n\ntype Props = AtomsListProps & AtomsListCallProps\n\nconst AtomsList = forwardRef((props: Props, ref) => {\n  const { atoms, active, onAction } = props\n  const isAtom = active && active.tool === 'atom'\n\n  return (\n    <>\n      {atoms.map(label => {\n        const element = Elements.get(label)\n        const shortcut =\n          basicAtoms.indexOf(label) > -1 ? shortcutStr(atomCuts[label]) : null\n\n        if (basicAtoms.indexOf(label) === 0) {\n          return (\n            // @ts-ignore\n            <div key={label} ref={ref}>\n              <Atom\n                key={label}\n                el={element}\n                shortcut={shortcut}\n                className={clsx(classes.button, {\n                  [classes.selected]:\n                    isAtom && active && active.opts.label === label\n                })}\n                onClick={() => onAction({ tool: 'atom', opts: { label } })}\n              />\n            </div>\n          )\n        }\n        return (\n          <Atom\n            key={label}\n            el={element}\n            shortcut={shortcut}\n            className={clsx(classes.button, {\n              [classes.selected]:\n                isAtom && active && active.opts.label === label\n            })}\n            onClick={() => onAction({ tool: 'atom', opts: { label } })}\n          />\n        )\n      })}\n    </>\n  )\n})\n\nexport type { AtomsListProps, AtomsListCallProps }\nexport { AtomsList }\n","/****************************************************************************\n * Copyright 2021 EPAM Systems\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *    http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n ***************************************************************************/\n\nimport { FC, MutableRefObject, useRef } from 'react'\nimport {\n  ToolbarGroupItem,\n  ToolbarGroupItemCallProps,\n  ToolbarGroupItemProps\n} from '../ToolbarGroupItem'\n\nimport { ArrowScroll } from '../ArrowScroll'\nimport { AtomsList } from './AtomsList'\nimport { basicAtoms } from '../../../action/atoms'\nimport classes from './RightToolbar.module.less'\nimport clsx from 'clsx'\nimport { useInView } from 'react-intersection-observer'\n\nconst Group: FC<{ className?: string }> = ({ children, className }) => (\n  <div className={clsx(classes.group, className)}>{children}</div>\n)\n\ninterface RightToolbarProps\n  extends Omit<ToolbarGroupItemProps, 'id' | 'options'> {\n  className?: string\n  active?: {\n    opts: any\n    tool: string\n  }\n  freqAtoms: any[]\n}\n\ninterface RightToolbarCallProps extends ToolbarGroupItemCallProps {}\n\ntype Props = RightToolbarProps & RightToolbarCallProps\n\nconst RightToolbar = (props: Props) => {\n  const { className, ...rest } = props\n  const { active, onAction, freqAtoms } = rest\n  const [startRef, startInView] = useInView({ threshold: 0.9 })\n  const [endRef, endInView] = useInView({ threshold: 0.9 })\n  const sizeRef = useRef() as MutableRefObject<HTMLDivElement>\n  const scrollRef = useRef() as MutableRefObject<HTMLDivElement>\n\n  const scrollUp = () => {\n    scrollRef.current.scrollTop -= sizeRef.current.offsetHeight\n  }\n\n  const scrollDown = () => {\n    scrollRef.current.scrollTop += sizeRef.current.offsetHeight\n  }\n\n  return (\n    <div className={clsx(classes.root, className)}>\n      <div className={classes.buttons} ref={scrollRef}>\n        <Group>\n          <AtomsList\n            ref={startRef}\n            atoms={basicAtoms}\n            active={active}\n            onAction={onAction}\n          />\n          <AtomsList atoms={freqAtoms} active={active} onAction={onAction} />\n        </Group>\n\n        <Group>\n          <div ref={sizeRef}>\n            <ToolbarGroupItem id=\"period-table\" {...rest} />\n          </div>\n        </Group>\n        <div ref={endRef}>\n          <Group>\n            <ToolbarGroupItem id=\"enhanced-stereo\" {...rest} />\n          </Group>\n        </div>\n      </div>\n      <ArrowScroll\n        startInView={startInView}\n        endInView={endInView}\n        scrollUp={scrollUp}\n        scrollDown={scrollDown}\n      />\n    </div>\n  )\n}\n\nexport type { RightToolbarProps, RightToolbarCallProps }\nexport { RightToolbar }\n","/****************************************************************************\n * Copyright 2021 EPAM Systems\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *    http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n ***************************************************************************/\n\nimport {\n  RightToolbar,\n  RightToolbarCallProps,\n  RightToolbarProps\n} from './RightToolbar'\n\nimport { ComponentType } from 'react'\nimport { Dispatch } from 'redux'\nimport { connect } from 'react-redux'\nimport { onAction } from '../../../state'\n\ntype StateProps = Omit<RightToolbarProps, 'className'>\ntype OwnProps = Pick<RightToolbarProps, 'className'>\n\nconst mapStateToProps = (state): StateProps => ({\n  active: state.actionState && state.actionState.activeTool,\n  status: state.actionState || {},\n  freqAtoms: state.toolbar.freqAtoms,\n  opened: state.toolbar.opened,\n  indigoVerification: state.requestsStatuses.indigoVerification,\n  disableableButtons: []\n})\n\nconst mapDispatchToProps = (dispatch: Dispatch): RightToolbarCallProps => ({\n  onAction: action => dispatch(onAction(action)),\n  onOpen: (menuName, isSelected) =>\n    dispatch({\n      type: 'OPENED',\n      data: { menuName, isSelected }\n    })\n})\n\nconst RightToolbarContainer: ComponentType<OwnProps> = connect(\n  mapStateToProps,\n  mapDispatchToProps\n)(RightToolbar)\n\nexport { RightToolbarContainer }\nexport default RightToolbarContainer\n","/****************************************************************************\n * Copyright 2021 EPAM Systems\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *    http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n ***************************************************************************/\n\nimport { UiActionAction } from '../../../../action'\nimport { zoomList } from '../../../../action/zoom'\n\nfunction toPercent(value: number): string {\n  const percentLimit = 100\n  return (value * percentLimit).toFixed()\n}\n\ninterface ZoomListProps {\n  status: {\n    zoom?: {\n      selected?: number\n    }\n  }\n}\n\ninterface ZoomListCallProps {\n  onAction: (action: UiActionAction) => void\n}\n\ntype Props = ZoomListProps & ZoomListCallProps\n\nconst ZoomList = (props: Props) => {\n  const { status = {}, onAction } = props\n  const zoom = status.zoom && status.zoom.selected // TMP\n\n  const handleChange = event => {\n    const parsedValue = parseFloat(event.target.value)\n    onAction(editor => editor.zoom(parsedValue))\n  }\n\n  return (\n    <select value={zoom} onChange={handleChange}>\n      {zoomList.map(value => (\n        <option key={value.toString()} value={value}>\n          {toPercent(value)}%\n        </option>\n      ))}\n    </select>\n  )\n}\n\nexport type { ZoomListProps, ZoomListCallProps }\nexport { ZoomList }\n","/****************************************************************************\n * Copyright 2021 EPAM Systems\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *    http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n ***************************************************************************/\n\nimport Icon from '../../../../component/view/icon'\nimport { shortcutStr } from '../../shortcutStr'\nimport classes from './HelpLink.module.less'\n\nconst HelpLink = ({ status }) => {\n  if (status?.hidden) {\n    return null\n  }\n  const shortcut = shortcutStr(['?', '&', 'Shift+/'])\n  const helpLink = process.env.HELP_LINK\n\n  return (\n    <a\n      target=\"_blank\"\n      className={classes.button}\n      title={`Help (${shortcut})`}\n      href={`https://github.com/epam/ketcher/blob/${helpLink}/documentation/help.md#ketcher-overview`}\n      rel=\"noreferrer\"\n    >\n      <Icon name=\"help\" />\n      <kbd>{shortcut}</kbd>\n    </a>\n  )\n}\n\nexport { HelpLink }\n","/****************************************************************************\n * Copyright 2021 EPAM Systems\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *    http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n ***************************************************************************/\n\nimport { FC } from 'react'\nimport {\n  ToolbarGroupItem,\n  ToolbarGroupItemCallProps,\n  ToolbarGroupItemProps\n} from '../ToolbarGroupItem'\nimport { ToolbarItem, ToolbarItemVariant } from '../toolbar.types'\n\nimport { ZoomList } from './ZoomList'\nimport classes from './TopToolbar.module.less'\nimport clsx from 'clsx'\nimport { makeItems } from '../ToolbarGroupItem/utils'\nimport { mediaSizes } from '../mediaSizes'\nimport { useResizeObserver } from '../../../../../hooks'\nimport { HelpLink } from './HelpLink/HelpLink'\n\nconst Group: FC<{ className?: string }> = ({ children, className }) => (\n  <div className={clsx(classes.group, className)}>{children}</div>\n)\n\nconst copyOptions: ToolbarItem[] = makeItems([\n  'copy',\n  'copy-mol',\n  'copy-ket',\n  'copy-image'\n])\n\ninterface TopToolbarProps\n  extends Omit<ToolbarGroupItemProps, 'id' | 'options'> {\n  className?: string\n}\n\ninterface TopToolbarCallProps extends ToolbarGroupItemCallProps {}\n\ntype Props = TopToolbarProps & TopToolbarCallProps\n\nconst TopToolbar = (props: Props) => {\n  const { className, status, ...rest } = props\n  const { ref, width } = useResizeObserver<HTMLDivElement>()\n  const isZoomListHidden = !status['zoom-list']?.hidden\n\n  type ItemProps = {\n    id: ToolbarItemVariant\n    options?: ToolbarItem[]\n    className?: string\n    vertical?: boolean\n  }\n  const Item = ({ id, options, className, vertical }: ItemProps) =>\n    ToolbarGroupItem({ id, options, className, vertical, status, ...rest })\n\n  return (\n    <div\n      ref={ref}\n      className={clsx(classes.root, className, {\n        [classes.hideSeparators]:\n          width && width < mediaSizes.topSeparatorsShowingWidth\n      })}\n    >\n      <Group>\n        <Item id=\"clear\" />\n        <Item id=\"open\" />\n        <Item id=\"save\" />\n      </Group>\n\n      <Group>\n        <Item id=\"undo\" />\n        <Item id=\"redo\" />\n        <Item id=\"cut\" />\n        <Item id=\"copies\" options={copyOptions} vertical={true} />\n        <Item id=\"paste\" />\n      </Group>\n\n      <Group>\n        {width && width >= mediaSizes.zoomShowingWidth ? (\n          <>\n            <Item id=\"zoom-in\" />\n            <Item id=\"zoom-out\" />\n          </>\n        ) : null}\n        {isZoomListHidden && (\n          <ZoomList status={status} onAction={rest.onAction} />\n        )}\n      </Group>\n\n      <Group>\n        <Item id=\"layout\" />\n        <Item id=\"clean\" />\n        <Item id=\"arom\" />\n        <Item id=\"dearom\" />\n        <Item id=\"cip\" />\n        <Item id=\"check\" />\n        <Item id=\"analyse\" />\n      </Group>\n\n      <Group className={classes.recognize}>\n        <Item id=\"recognize\" />\n        <Item id=\"miew\" />\n      </Group>\n\n      <Group className={classes.meta}>\n        <Item id=\"settings\" />\n        {width && width >= mediaSizes.infoShowingWidth ? (\n          <>\n            <HelpLink status={status['help']} />\n            <Item id=\"about\" />\n          </>\n        ) : null}\n      </Group>\n    </div>\n  )\n}\n\nexport type { TopToolbarProps, TopToolbarCallProps }\nexport { TopToolbar }\n","/****************************************************************************\n * Copyright 2021 EPAM Systems\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *    http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n ***************************************************************************/\n\nimport { TopToolbar, TopToolbarCallProps, TopToolbarProps } from './TopToolbar'\n\nimport { Dispatch } from 'redux'\nimport { connect } from 'react-redux'\nimport { onAction } from '../../../state'\n\ntype StateProps = Omit<TopToolbarProps, 'className'>\n\nconst mapStateToProps = (state: any): StateProps => ({\n  status: state.actionState || {},\n  opened: state.toolbar.opened,\n  indigoVerification: state.requestsStatuses.indigoVerification,\n  disableableButtons: ['layout', 'clean', 'arom', 'dearom', 'cip']\n})\n\nconst mapDispatchToProps = (dispatch: Dispatch): TopToolbarCallProps => ({\n  onAction: action => dispatch(onAction(action)),\n  onOpen: (menuName, isSelected) =>\n    dispatch({\n      type: 'OPENED',\n      data: { menuName, isSelected }\n    })\n})\n\nconst TopToolbarContainer = connect(\n  mapStateToProps,\n  mapDispatchToProps\n)(TopToolbar)\n\nexport { TopToolbarContainer }\n","/****************************************************************************\n * Copyright 2021 EPAM Systems\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *    http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n ***************************************************************************/\n\nimport * as KN from 'w3c-keyname'\n\nconst mac =\n  typeof navigator !== 'undefined' ? /Mac/.test(navigator.platform) : false // eslint-disable-line no-undef\n\nfunction normalizeKeyName(name) {\n  const parts = name.split(/\\+(?!$)/)\n  let result = parts[parts.length - 1]\n  if (result === 'Space') result = ' '\n  let alt\n  let ctrl\n  let shift\n  let meta\n\n  for (let i = 0; i < parts.length - 1; i++) {\n    const mod = parts[i]\n    if (/^(cmd|meta|m)$/i.test(mod)) meta = true\n    else if (/^a(lt)?$/i.test(mod)) alt = true\n    else if (/^(c|ctrl|control)$/i.test(mod)) ctrl = true\n    else if (/^s(hift)?$/i.test(mod)) shift = true\n    else if (/^mod$/i.test(mod))\n      if (mac) meta = true\n      else ctrl = true\n    else throw new Error('Unrecognized modifier name: ' + mod)\n  }\n\n  if (alt) result = 'Alt+' + result\n  if (ctrl) result = 'Ctrl+' + result\n  if (meta) result = 'Meta+' + result\n  if (shift) result = 'Shift+' + result\n\n  return result\n}\n\nfunction normalizeKeyMap(map) {\n  const copy = Object.create(null)\n\n  Object.keys(map).forEach(prop => {\n    copy[normalizeKeyName(prop)] = map[prop]\n  })\n\n  return copy\n}\n\nfunction modifiers(name, event, shift) {\n  if (event.altKey) name = 'Alt+' + name\n  if (event.ctrlKey) name = 'Ctrl+' + name\n  if (event.metaKey) name = 'Meta+' + name\n  if (shift !== false && event.shiftKey) name = 'Shift+' + name\n\n  return name\n}\n\nfunction rusToEng(name, event) {\n  return name\n    .replace(/[–∞-—è]/, KN.base[event.keyCode])\n    .replace(/[–ê-–Ø]/, KN.shift[event.keyCode])\n}\n\nfunction normalizeKeyEvent(event, base = false) {\n  const name = rusToEng(KN.keyName(event), event)\n  const isChar = name.length === 1 && name !== ' '\n\n  return isChar && !base\n    ? modifiers(name, event, !isChar)\n    : modifiers(KN.base[event.keyCode], event, true)\n}\n\nfunction keyNorm(obj) {\n  if (obj instanceof KeyboardEvent)\n    // eslint-disable-line no-undef\n    return normalizeKeyEvent(...arguments) // eslint-disable-line prefer-rest-params\n\n  return typeof obj === 'object' ? normalizeKeyMap(obj) : normalizeKeyName(obj)\n}\n\nfunction lookup(map, event) {\n  let name = rusToEng(KN.keyName(event), event)\n  if (name === 'Add') name = '+' // numpad '+' and '-'\n  if (name === 'Subtract') name = '-'\n\n  const isChar = name.length === 1 && name !== ' '\n  let res = map[modifiers(name, event, !isChar)]\n  let baseName\n\n  if (event.shiftKey && isChar && (baseName = KN.base[event.keyCode]))\n    res = map[modifiers(baseName, event, true)] || res\n\n  return res\n}\n\nkeyNorm.lookup = lookup\n\nexport default keyNorm\n","/****************************************************************************\n * Copyright 2021 EPAM Systems\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *    http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n ***************************************************************************/\n\nimport * as clipArea from '../component/cliparea/cliparea'\n\nimport {\n  KetSerializer,\n  MolSerializer,\n  formatProperties,\n  ChemicalMimeType\n} from 'ketcher-core'\nimport { debounce, isEqual } from 'lodash/fp'\nimport { load, onAction } from './shared'\n\nimport actions from '../action'\nimport keyNorm from '../data/convert/keynorm'\nimport { openDialog } from './modal'\n\nexport function initKeydownListener(element) {\n  return function (dispatch, getState) {\n    const hotKeys = initHotKeys()\n    element.addEventListener('keydown', event =>\n      keyHandle(dispatch, getState(), hotKeys, event)\n    )\n  }\n}\n\n/* HotKeys */\nfunction keyHandle(dispatch, state, hotKeys, event) {\n  if (state.modal) return\n\n  const editor = state.editor\n  const actionState = state.actionState\n  const actionTool = actionState.activeTool\n\n  const key = keyNorm(event)\n  const atomsSelected = editor.selection() && editor.selection().atoms\n\n  let group = null\n\n  if (key && key.length === 1 && atomsSelected && key.match(/\\w/)) {\n    openDialog(dispatch, 'labelEdit', { letter: key })\n      .then(res => {\n        dispatch(onAction({ tool: 'atom', opts: res }))\n      })\n      .catch(() => null)\n    event.preventDefault()\n  } else if ((group = keyNorm.lookup(hotKeys, event)) !== undefined) {\n    let index = checkGroupOnTool(group, actionTool) // index currentTool in group || -1\n    index = (index + 1) % group.length\n\n    const actName = group[index]\n    if (actionState[actName] && actionState[actName].disabled === true) {\n      event.preventDefault()\n      return\n    }\n    if (clipArea.actions.indexOf(actName) === -1) {\n      const newAction = actions[actName].action\n      dispatch(onAction(newAction))\n      event.preventDefault()\n    } else if (window.clipboardData) {\n      // IE support\n      clipArea.exec(event)\n    }\n  }\n}\n\nfunction setHotKey(key, actName, hotKeys) {\n  if (Array.isArray(hotKeys[key])) hotKeys[key].push(actName)\n  else hotKeys[key] = [actName]\n}\n\nfunction initHotKeys() {\n  const hotKeys = {}\n  let act\n\n  Object.keys(actions).forEach(actName => {\n    act = actions[actName]\n    if (!act.shortcut) return\n\n    if (Array.isArray(act.shortcut)) {\n      act.shortcut.forEach(key => {\n        setHotKey(key, actName, hotKeys)\n      })\n    } else {\n      setHotKey(act.shortcut, actName, hotKeys)\n    }\n  })\n\n  return keyNorm(hotKeys)\n}\n\nfunction checkGroupOnTool(group, actionTool) {\n  let index = group.indexOf(actionTool.tool)\n\n  group.forEach((actName, i) => {\n    if (isEqual(actions[actName].action, actionTool)) index = i\n  })\n\n  return index\n}\n\nconst rxnTextPlain = /\\$RXN\\n+\\s+0\\s+0\\s+0\\n*/\n\n/* ClipArea */\nexport function initClipboard(dispatch, getState) {\n  const formats = Object.keys(formatProperties).map(\n    format => formatProperties[format].mime\n  )\n\n  const debAction = debounce(0, action => dispatch(onAction(action)))\n  const loadStruct = debounce(0, (structStr, opts) =>\n    dispatch(load(structStr, opts))\n  )\n\n  return {\n    formats,\n    focused() {\n      const state = global.currentState\n      return !state.modal\n    },\n    onCut() {\n      const state = global.currentState\n      const editor = state.editor\n      const data = clipData(editor)\n      if (data) debAction({ tool: 'eraser', opts: 1 })\n      else editor.selection(null)\n      return data\n    },\n    onCopy() {\n      const state = global.currentState\n      const editor = state.editor\n      const data = clipData(editor)\n      editor.selection(null)\n      return data\n    },\n    onPaste(data) {\n      const structStr =\n        data[ChemicalMimeType.KET] ||\n        data[ChemicalMimeType.Mol] ||\n        data[ChemicalMimeType.Rxn] ||\n        data['text/plain']\n\n      if (structStr || !rxnTextPlain.test(data['text/plain']))\n        loadStruct(structStr, { fragment: true })\n    }\n  }\n}\n\nfunction clipData(editor) {\n  const res = {}\n  const struct = editor.structSelected()\n  const errorHandler = editor.errorHandler\n\n  if (struct.isBlank()) return null\n  const simpleObjectOrText = Boolean(\n    struct.simpleObjects.size || struct.texts.size\n  )\n  if (simpleObjectOrText && window.clipboardData) {\n    errorHandler(\n      'The structure you are trying to copy contains Simple object or/and Text object.' +\n        'To copy Simple object or Text object in Internet Explorer try \"Copy as KET\" button'\n    )\n    return null\n  }\n  const molSerializer = new MolSerializer()\n  try {\n    const serializer = new KetSerializer()\n    const ket = serializer.serialize(struct)\n    res[ChemicalMimeType.KET] = ket\n\n    const type = struct.isReaction ? ChemicalMimeType.Mol : ChemicalMimeType.Rxn\n    const data = molSerializer.serialize(struct)\n    res['text/plain'] = data\n    res[type] = data\n\n    // res['chemical/x-daylight-smiles'] = smiles.stringify(struct);\n    return res\n  } catch (ex) {\n    errorHandler(ex.message)\n  }\n\n  return null\n}\n","/****************************************************************************\n * Copyright 2021 EPAM Systems\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *    http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n ***************************************************************************/\n\nimport ClipArea from '../component/cliparea/cliparea'\nimport { connect } from 'react-redux'\nimport { initClipboard } from '../state/hotkeys'\n\nconst AppClipArea = connect(null, dispatch => dispatch(initClipboard as any))(\n  ClipArea\n)\n\nexport default AppClipArea\n","/****************************************************************************\n * Copyright 2021 EPAM Systems\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *    http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n ***************************************************************************/\n\nimport { AppHidden, AppHiddenCallProps } from './AppHidden'\n\nimport { Dispatch } from 'redux'\nimport { connect } from 'react-redux'\nimport { initTmplLib } from '../../state/templates'\n\nconst mapDispatchToProps = (dispatch: Dispatch): AppHiddenCallProps => ({\n  onInitTmpls: (cacheEl, url) => {\n    initTmplLib(dispatch, url, cacheEl)\n  }\n})\n\nconst AppHiddenContainer = connect(null, mapDispatchToProps)(AppHidden)\n\nexport { AppHiddenContainer }\n","/****************************************************************************\n * Copyright 2021 EPAM Systems\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *    http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n ***************************************************************************/\n\nimport { useEffect, useRef } from 'react'\nimport { useSettingsContext } from '../../../../hooks'\n\ninterface AppHiddenCallProps {\n  onInitTmpls: (cacheEl, url) => void\n}\n\ntype Props = AppHiddenCallProps\n// todo: come up with better name\nconst AppHidden = (props: Props) => {\n  const { onInitTmpls } = props\n\n  const ref = useRef(null)\n  const { staticResourcesUrl } = useSettingsContext()\n\n  useEffect(() => {\n    onInitTmpls(ref.current, staticResourcesUrl)\n  }, [])\n\n  return <div style={{ display: 'none' }} ref={ref} />\n}\n\nexport type { AppHiddenCallProps }\nexport { AppHidden }\n","/****************************************************************************\n * Copyright 2021 EPAM Systems\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *    http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n ***************************************************************************/\n\nconst mediaSizes = {\n  smallWidth: 600,\n  smallHeight: 600\n}\n\nexport default mediaSizes\n","/****************************************************************************\n * Copyright 2021 EPAM Systems\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *    http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n ***************************************************************************/\n\nimport * as KN from 'w3c-keyname'\n\nimport { FC, useLayoutEffect, useRef, ReactElement } from 'react'\n\nimport clsx from 'clsx'\nimport styles from './Dialog.module.less'\n\ninterface DialogProps {\n  title: string\n  params: DialogParams\n  buttons?: Array<string | ReactElement>\n  className: string\n}\nexport interface DialogParams extends DialogParamsCallProps {\n  className?: string\n}\n\ninterface DialogParamsCallProps {\n  onCancel: () => void\n  onOk: (result: any) => void\n}\n\ninterface DialogCallProps {\n  result: () => any\n  valid?: () => boolean\n}\n\ntype Props = DialogProps & DialogCallProps\n\nconst Dialog: FC<Props> = props => {\n  const {\n    children,\n    title,\n    params,\n    result = () => null,\n    valid = () => !!result(),\n    buttons = ['Cancel', 'OK'],\n    className,\n    ...rest\n  } = props\n  const dialogRef = useRef<HTMLDivElement>(null)\n\n  useLayoutEffect(() => {\n    ;(dialogRef.current as any).focus()\n    return () => {\n      ;(\n        dialogRef.current\n          ?.closest('.Ketcher-root')\n          ?.getElementsByClassName('cliparea')[0] as any\n      ).focus()\n    }\n  }, [])\n\n  const exit = mode => {\n    const key = mode === 'OK' ? 'onOk' : 'onCancel'\n    if (params && key in params && (key !== 'onOk' || valid()))\n      params[key](result())\n  }\n\n  const keyDown = event => {\n    const key = KN.keyName(event)\n    const active = document.activeElement\n    const activeTextarea = active && active.tagName === 'TEXTAREA'\n    if (key === 'Escape' || (key === 'Enter' && !activeTextarea)) {\n      exit(key === 'Enter' ? 'OK' : 'Cancel')\n      event.preventDefault()\n      event.stopPropagation()\n    }\n  }\n\n  return (\n    <div\n      ref={dialogRef}\n      role=\"dialog\"\n      onSubmit={event => event.preventDefault()}\n      onKeyDown={keyDown}\n      tabIndex={-1}\n      className={clsx(styles.form, className, params.className)}\n      {...rest}\n    >\n      <header>{title}</header>\n      <div className={styles.dialog_body}>{children}</div>\n\n      <footer>\n        {buttons.map(button =>\n          typeof button !== 'string' ? (\n            button\n          ) : (\n            <input\n              key={button}\n              type=\"button\"\n              className={button === 'OK' ? styles.ok : styles.cancel}\n              value={button}\n              disabled={button === 'OK' && !valid()}\n              onClick={() => exit(button)}\n            />\n          )\n        )}\n      </footer>\n    </div>\n  )\n}\n\nexport default Dialog\n","/****************************************************************************\n * Copyright 2021 EPAM Systems\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *    http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n ***************************************************************************/\n\nimport { ReactElement } from 'react'\n\nimport classes from './Spinner.module.less'\n\nfunction Spinner(): ReactElement {\n  return <div className={classes.spinner} />\n}\n\nexport default Spinner\n","/****************************************************************************\n * Copyright 2021 EPAM Systems\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *    http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n ***************************************************************************/\n\nimport { Fragment, FunctionalGroup, Vec2 } from 'ketcher-core'\n\nconst SELECTION_DISTANCE_COEFFICIENT = 0.4\nconst SELECTION_WITHIN_TEXT = 0\n\nconst findMaps = {\n  atoms: findClosestAtom,\n  bonds: findClosestBond,\n  enhancedFlags: findClosestEnhancedFlag,\n  sgroupData: findClosestDataSGroupData,\n  sgroups: findClosestSGroup,\n  functionalGroups: findClosestFG,\n  rxnArrows: findClosestRxnArrow,\n  rxnPluses: findClosestRxnPlus,\n  frags: findClosestFrag,\n  rgroups: findClosestRGroup,\n  simpleObjects: findClosestSimpleObject,\n  texts: findClosestText\n}\n\nfunction findClosestText(restruct, cursorPosition) {\n  let minDist = null\n  let ret = null\n\n  restruct.texts.forEach((text, id) => {\n    const referencePoints = text.getReferencePoints(restruct)\n    const topX = referencePoints[0].x\n    const topY = referencePoints[0].y\n    const bottomX = referencePoints[2].x\n    const bottomY = referencePoints[2].y\n\n    const distances = []\n\n    if (cursorPosition.x >= topX && cursorPosition.x <= bottomX) {\n      if (cursorPosition.y < topY) {\n        distances.push(topY - cursorPosition.y)\n      } else if (cursorPosition.y > bottomY) {\n        distances.push(cursorPosition.y - bottomY)\n      } else {\n        distances.push(cursorPosition.y - topY, bottomY - cursorPosition.y)\n      }\n    }\n\n    if (cursorPosition.x < topX && cursorPosition.y < topY) {\n      distances.push(Vec2.dist(new Vec2(topX, topY), cursorPosition))\n    }\n\n    if (cursorPosition.x > bottomX && cursorPosition.y > bottomY) {\n      distances.push(Vec2.dist(new Vec2(bottomX, bottomY), cursorPosition))\n    }\n\n    if (cursorPosition.x < topX && cursorPosition.y > bottomY) {\n      distances.push(Vec2.dist(new Vec2(topX, bottomY), cursorPosition))\n    }\n\n    if (cursorPosition.x > bottomX && cursorPosition.y < topY) {\n      distances.push(Vec2.dist(new Vec2(bottomX, topY), cursorPosition))\n    }\n\n    if (cursorPosition.y >= topY && cursorPosition.y <= bottomY) {\n      if (cursorPosition.x < topX) {\n        distances.push(topX - cursorPosition.x)\n      } else if (cursorPosition.x > bottomX) {\n        distances.push(cursorPosition.x - bottomX)\n      } else {\n        distances.push(SELECTION_WITHIN_TEXT)\n      }\n    }\n\n    let dist = Math.min(...distances)\n\n    if (dist < SELECTION_DISTANCE_COEFFICIENT && (!ret || dist < minDist)) {\n      minDist = dist\n      ret = { id, dist: minDist }\n    }\n  })\n  return ret\n}\n\nfunction findClosestSimpleObject(restruct, pos) {\n  let minDist = null\n  let refPoint = null\n  let ret = null\n\n  restruct.simpleObjects.forEach((simpleObject, id) => {\n    const dist = simpleObject.calcDistance(pos, restruct.render.options.scale)\n\n    if (dist.minDist < 0.3 && (!ret || dist.minDist < minDist)) {\n      minDist = dist.minDist\n      refPoint = dist.refPoint\n\n      ret = { id, dist: minDist, ref: refPoint }\n    }\n  })\n  return ret\n}\n\nfunction findClosestAtom(restruct, pos, skip, minDist) {\n  let closestAtom = null\n  const maxMinDist = SELECTION_DISTANCE_COEFFICIENT\n  const skipId = skip && skip.map === 'atoms' ? skip.id : null\n  const sGroups = restruct.sgroups\n  const functionalGroups = restruct.molecule.functionalGroups\n\n  minDist = minDist || maxMinDist\n  minDist = Math.min(minDist, maxMinDist)\n\n  restruct.atoms.forEach((atom, aid) => {\n    if (\n      FunctionalGroup.isAtomInContractedFunctionalGroup(\n        atom.a,\n        sGroups,\n        functionalGroups,\n        true\n      )\n    )\n      return null\n    if (aid === skipId) return\n\n    const dist = Vec2.dist(pos, atom.a.pp)\n\n    if (dist < minDist) {\n      closestAtom = aid\n      minDist = dist\n    }\n  })\n\n  if (closestAtom !== null) {\n    return {\n      id: closestAtom,\n      dist: minDist\n    }\n  }\n\n  return null\n}\n\nfunction findClosestBond(restruct, pos, skip, minDist, scale) {\n  // eslint-disable-line max-params\n  let closestBond = null\n  let closestBondCenter = null\n  const maxMinDist = 0.8 * SELECTION_DISTANCE_COEFFICIENT\n  const skipId = skip && skip.map === 'bonds' ? skip.id : null\n  const sGroups = restruct.sgroups\n  const functionalGroups = restruct.molecule.functionalGroups\n\n  minDist = minDist || maxMinDist\n  minDist = Math.min(minDist, maxMinDist)\n\n  let minCDist = minDist\n\n  restruct.bonds.forEach((bond, bid) => {\n    if (bid === skipId) return\n\n    const a1 = restruct.atoms.get(bond.b.begin).a\n    const a2 = restruct.atoms.get(bond.b.end).a\n    if (\n      FunctionalGroup.isBondInContractedFunctionalGroup(\n        bond.b,\n        sGroups,\n        functionalGroups,\n        true\n      )\n    )\n      return null\n\n    const mid = Vec2.lc2(a1.pp, 0.5, a2.pp, 0.5)\n    const cdist = Vec2.dist(pos, mid)\n\n    if (cdist < minCDist) {\n      minCDist = cdist\n      closestBondCenter = bid\n    }\n  })\n\n  restruct.bonds.forEach((bond, bid) => {\n    if (bid === skipId) return\n    if (\n      FunctionalGroup.isBondInContractedFunctionalGroup(\n        bond.b,\n        sGroups,\n        functionalGroups,\n        true\n      )\n    )\n      return null\n\n    const hb = restruct.molecule.halfBonds.get(bond.b.hb1)\n    const dir = hb.dir\n    const norm = hb.norm\n\n    const p1 = restruct.atoms.get(bond.b.begin).a.pp\n    const p2 = restruct.atoms.get(bond.b.end).a.pp\n\n    const inStripe = Vec2.dot(pos.sub(p1), dir) * Vec2.dot(pos.sub(p2), dir) < 0\n\n    if (inStripe) {\n      const dist = Math.abs(Vec2.dot(pos.sub(p1), norm))\n\n      if (dist < minDist) {\n        closestBond = bid\n        minDist = dist\n      }\n    }\n  })\n\n  if (closestBondCenter !== null) {\n    return {\n      id: closestBondCenter,\n      dist: minCDist\n    }\n  }\n\n  if (\n    closestBond !== null &&\n    minDist > SELECTION_DISTANCE_COEFFICIENT * scale\n  ) {\n    return {\n      id: closestBond,\n      dist: minDist\n    }\n  }\n\n  return null\n}\n\nfunction findClosestEnhancedFlag(restruct, pos) {\n  let minDist\n  let ret = null\n  restruct.enhancedFlags.forEach((item, id) => {\n    const fragment = restruct.molecule.frags.get(id)\n    if (!fragment) return\n\n    const p = fragment.stereoFlagPosition\n      ? new Vec2(fragment.stereoFlagPosition.x, fragment.stereoFlagPosition.y)\n      : Fragment.getDefaultStereoFlagPosition(restruct.molecule, id)\n    if (!p || Math.abs(pos.x - p.x) >= 1.0) return\n\n    const dist = Math.abs(pos.y - p.y)\n\n    if (dist < 0.3 && (!ret || dist < minDist)) {\n      minDist = dist\n      ret = { id, dist: minDist }\n    }\n  })\n  return ret\n}\n\nfunction findClosestDataSGroupData(restruct, pos) {\n  let minDist = null\n  let ret = null\n\n  restruct.sgroupData.forEach((item, id) => {\n    if (item.sgroup.type !== 'DAT') throw new Error('Data group expected')\n\n    if (item.sgroup.data.fieldName !== 'MRV_IMPLICIT_H') {\n      const box = item.sgroup.dataArea\n      const inBox =\n        box.p0.y < pos.y &&\n        box.p1.y > pos.y &&\n        box.p0.x < pos.x &&\n        box.p1.x > pos.x\n      const xDist = Math.min(\n        Math.abs(box.p0.x - pos.x),\n        Math.abs(box.p1.x - pos.x)\n      )\n\n      if (inBox && (ret === null || xDist < minDist)) {\n        ret = { id, dist: xDist }\n        minDist = xDist\n      }\n    }\n  })\n\n  return ret\n}\n\nfunction findClosestFrag(restruct, pos, skip, minDist, scale) {\n  minDist = Math.min(\n    minDist || SELECTION_DISTANCE_COEFFICIENT,\n    SELECTION_DISTANCE_COEFFICIENT\n  )\n\n  const struct = restruct.molecule\n\n  const closestAtom = findClosestAtom(restruct, pos, skip, minDist)\n\n  if (closestAtom) {\n    return {\n      id: struct.atoms.get(closestAtom.id).fragment,\n      dist: closestAtom.dist\n    }\n  }\n\n  const closestBond = findClosestBond(restruct, pos, skip, minDist, scale)\n\n  if (closestBond) {\n    const atomId = struct.bonds.get(closestBond.id).begin\n    return {\n      id: struct.atoms.get(atomId).fragment,\n      dist: closestBond.dist\n    }\n  }\n\n  return null\n}\n\nfunction findClosestRGroup(restruct, pos, skip, minDist) {\n  minDist = Math.min(\n    minDist || SELECTION_DISTANCE_COEFFICIENT,\n    SELECTION_DISTANCE_COEFFICIENT\n  )\n\n  let ret = null\n\n  restruct.rgroups.forEach((rgroup, rgid) => {\n    if (\n      rgid !== skip &&\n      rgroup.labelBox &&\n      rgroup.labelBox.contains(pos, 0.5)\n    ) {\n      const dist = Vec2.dist(rgroup.labelBox.centre(), pos)\n\n      if (!ret || dist < minDist) {\n        minDist = dist\n        ret = { id: rgid, dist: minDist }\n      }\n    }\n  })\n\n  return ret\n}\n\nfunction findClosestRxnArrow(restruct, pos) {\n  let minDist = null\n  let refPoint = null\n  let ret = null\n\n  restruct.rxnArrows.forEach((rxnArrow, id) => {\n    const dist = rxnArrow.calcDistance(pos, restruct.render.options.scale)\n\n    if (dist.minDist < 0.3 && (!ret || dist.minDist < minDist)) {\n      minDist = dist.minDist\n      refPoint = dist.refPoint\n\n      ret = { id, dist: minDist, ref: refPoint }\n    }\n  })\n  return ret\n}\n\nfunction findClosestRxnPlus(restruct, pos) {\n  let minDist = null\n  let ret = null\n\n  restruct.rxnPluses.forEach((plus, id) => {\n    const p = plus.item.pp\n    const dist = Math.max(Math.abs(pos.x - p.x), Math.abs(pos.y - p.y))\n\n    if (dist < 0.3 && (!ret || dist < minDist)) {\n      minDist = dist\n      ret = { id, dist: minDist }\n    }\n  })\n\n  return ret\n}\n\nfunction findClosestSGroup(restruct, pos) {\n  let ret = null\n  let minDist = SELECTION_DISTANCE_COEFFICIENT\n\n  restruct.molecule.sgroups.forEach((sg, sgid) => {\n    if (sg.functionalGroup && !sg.expanded && sg.firstSgroupAtom) return null\n\n    const d = sg.bracketDir\n    const n = d.rotateSC(1, 0)\n    const pg = new Vec2(Vec2.dot(pos, d), Vec2.dot(pos, n))\n\n    sg.areas.forEach(box => {\n      const inBox =\n        box.p0.y < pg.y && box.p1.y > pg.y && box.p0.x < pg.x && box.p1.x > pg.x\n      const xDist = Math.min(\n        Math.abs(box.p0.x - pg.x),\n        Math.abs(box.p1.x - pg.x)\n      )\n\n      if (inBox && (ret === null || xDist < minDist)) {\n        ret = sgid\n        minDist = xDist\n      }\n    })\n  })\n\n  if (ret !== null) {\n    return {\n      id: ret,\n      dist: minDist\n    }\n  }\n\n  return null\n}\n\nfunction findClosestFG(restruct, pos) {\n  let ret = null\n  let minDist = SELECTION_DISTANCE_COEFFICIENT\n  restruct.molecule.sgroups.forEach((sg, sgid) => {\n    if (sg.functionalGroup && !sg.data.expanded && sg.firstSgroupAtom) {\n      const firstAtomPp = sg.firstSgroupAtom.pp\n      const shift = new Vec2(0.625, 0.625)\n      const box = {\n        p0: Vec2.diff(firstAtomPp, shift),\n        p1: Vec2.sum(firstAtomPp, shift)\n      }\n\n      const inBox =\n        box.p0.y < pos.y &&\n        box.p1.y > pos.y &&\n        box.p0.x < pos.x &&\n        box.p1.x > pos.x\n      const xDist = Math.min(\n        Math.abs(box.p0.x - pos.x),\n        Math.abs(box.p0.y - pos.y),\n        Math.abs(box.p1.x - pos.x),\n        Math.abs(box.p0.y - pos.y)\n      )\n\n      if (inBox && (ret === null || xDist < minDist)) {\n        ret = sgid\n        minDist = xDist\n      }\n    }\n  })\n  if (ret !== null) {\n    return {\n      id: ret,\n      dist: minDist\n    }\n  }\n\n  return null\n}\n\nfunction findClosestItem(restruct, pos, maps, skip, scale) {\n  // eslint-disable-line max-params\n  maps = maps || Object.keys(findMaps)\n\n  return maps.reduce((res, mp) => {\n    const minDist = res ? res.dist : null\n    const item = findMaps[mp](restruct, pos, skip, minDist, scale)\n\n    if (item !== null && (res === null || item.dist < res.dist)) {\n      const { id, dist, ...other } = item\n      return {\n        map: mp,\n        id: id,\n        dist: dist,\n        ...other\n      }\n    }\n\n    return res\n  }, null)\n}\n\n/**\n * @param restruct { ReStruct }\n * @param selected { object }\n * @param maps { Array<string> }\n * @param scale { number }\n * @return {{\n * \t\tatoms: Map<number, number>?\n * \t\tbonds: Map<number, number>?\n * }}\n */\nfunction findCloseMerge(restruct, selected, maps = ['atoms', 'bonds'], scale) {\n  const pos = {\n    atoms: new Map(), // aid -> position\n    bonds: new Map() // bid -> position\n  }\n\n  const struct = restruct.molecule\n\n  selected.atoms.forEach(aid => {\n    pos.atoms.set(aid, struct.atoms.get(aid).pp)\n  })\n\n  selected.bonds.forEach(bid => {\n    const bond = struct.bonds.get(bid)\n    pos.bonds.set(\n      bid,\n      Vec2.lc2(\n        struct.atoms.get(bond.begin).pp,\n        0.5,\n        struct.atoms.get(bond.end).pp,\n        0.5\n      )\n    )\n  })\n\n  const result = {}\n  maps.forEach(mp => {\n    result[mp] = Array.from(pos[mp].keys()).reduce((res, srcId) => {\n      const skip = { map: mp, id: srcId }\n      const item = findMaps[mp](restruct, pos[mp].get(srcId), skip, null, scale)\n\n      if (item && !selected[mp].includes(item.id)) res.set(srcId, item.id)\n\n      return res\n    }, new Map())\n  })\n\n  return result\n}\n\nexport default {\n  atom: findClosestAtom, // used in Actions\n  item: findClosestItem,\n  merge: findCloseMerge\n}\n","/****************************************************************************\n * Copyright 2021 EPAM Systems\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *    http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n ***************************************************************************/\n\nimport { fromAtomsAttrs, FunctionalGroup } from 'ketcher-core'\n\nfunction APointTool(editor) {\n  if (!(this instanceof APointTool)) return new APointTool(editor)\n\n  this.editor = editor\n  this.sgroups = editor.render.ctab.sgroups\n  this.struct = editor.render.ctab\n  this.molecule = editor.render.ctab.molecule\n  this.functionalGroups = this.molecule.functionalGroups\n  this.editor.selection(null)\n}\n\nAPointTool.prototype.mousemove = function (event) {\n  const struct = this.editor.render.ctab.molecule\n  const ci = this.editor.findItem(event, ['atoms'])\n  if (ci) {\n    const atom = struct.atoms.get(ci.id)\n    if (atom.label !== 'R#' && atom.rglabel === null) this.editor.hover(ci)\n  } else {\n    this.editor.hover(null)\n  }\n}\n\nAPointTool.prototype.click = function (event) {\n  var editor = this.editor\n  var struct = editor.render.ctab.molecule\n  var ci = editor.findItem(event, ['atoms'])\n  const atomResult = []\n  const result = []\n  if (ci && this.functionalGroups.size && ci.map === 'atoms') {\n    const atomId = FunctionalGroup.atomsInFunctionalGroup(\n      this.functionalGroups,\n      ci.id\n    )\n    if (atomId !== null) atomResult.push(atomId)\n  }\n  if (atomResult.length > 0) {\n    for (let id of atomResult) {\n      const fgId = FunctionalGroup.findFunctionalGroupByAtom(\n        this.functionalGroups,\n        id\n      )\n      if (fgId !== null && !result.includes(fgId)) {\n        result.push(fgId)\n      }\n    }\n    this.editor.event.removeFG.dispatch({ fgIds: result })\n    return\n  }\n\n  if (ci && ci.map === 'atoms') {\n    this.editor.hover(null)\n    var atom = struct.atoms.get(ci.id)\n    if (atom.label === 'R#' && atom.rglabel !== null) return\n    var res = editor.event.elementEdit.dispatch({\n      attpnt: atom.attpnt\n    })\n    Promise.resolve(res)\n      .then(newatom => {\n        if (atom.attpnt !== newatom.attpnt) {\n          var action = fromAtomsAttrs(editor.render.ctab, ci.id, newatom)\n          editor.update(action)\n        }\n      })\n      .catch(() => null) // w/o changes\n    return true\n  }\n  return true\n}\n\nexport default APointTool\n","/****************************************************************************\n * Copyright 2021 EPAM Systems\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *    http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n ***************************************************************************/\n\nimport { Vec2, fracAngle } from 'ketcher-core'\n\nimport { inRange } from 'lodash'\n\nfunction calcAngle(pos0, pos1) {\n  const v = Vec2.diff(pos1, pos0)\n  return Math.atan2(v.y, v.x)\n}\n\nfunction calcNewAtomPos(pos0, pos1, ctrlKey) {\n  const v = new Vec2(1, 0).rotate(\n    ctrlKey ? calcAngle(pos0, pos1) : fracAngle(pos0, pos1)\n  )\n  v.add_(pos0) // eslint-disable-line no-underscore-dangle\n  return v\n}\n\nfunction degrees(angle) {\n  let degree = Math.round((angle / Math.PI) * 180)\n  if (degree > 180) degree -= 360\n  else if (degree <= -180) degree += 360\n  return degree\n}\n\nconst BONDS_MERGE_ANGLE = 10 // '¬∫'\nconst BONDS_MERGE_SCALE = 0.2\n\nfunction mergeBondsParams(struct1, bond1, struct2, bond2) {\n  const begin1 = struct1.atoms.get(bond1.begin)\n  const begin2 = struct2.atoms.get(bond2.begin)\n  const end1 = struct1.atoms.get(bond1.end)\n  const end2 = struct2.atoms.get(bond2.end)\n\n  const angle = calcAngle(begin1.pp, end1.pp) - calcAngle(begin2.pp, end2.pp)\n  const mergeAngle = Math.abs(degrees(angle) % 180)\n\n  const scale = Vec2.dist(begin1.pp, end1.pp) / Vec2.dist(begin2.pp, end2.pp)\n\n  const merged =\n    !inRange(mergeAngle, BONDS_MERGE_ANGLE, 180 - BONDS_MERGE_ANGLE) &&\n    inRange(scale, 1 - BONDS_MERGE_SCALE, 1 + BONDS_MERGE_SCALE)\n\n  return { merged, angle, scale, cross: Math.abs(degrees(angle)) > 90 }\n}\n\nexport default {\n  calcAngle,\n  fracAngle,\n  calcNewAtomPos,\n  degrees,\n  mergeBondsParams\n}\n","/****************************************************************************\n * Copyright 2021 EPAM Systems\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *    http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n ***************************************************************************/\n\nimport {\n  Action,\n  Atom,\n  Bond,\n  fromAtomAddition,\n  fromAtomsAttrs,\n  fromBondAddition,\n  fromFragmentDeletion,\n  fromSgroupDeletion,\n  FunctionalGroup,\n  SGroup\n} from 'ketcher-core'\n\nimport utils from '../shared/utils'\n\nfunction AtomTool(editor, atomProps) {\n  if (!(this instanceof AtomTool)) {\n    if (!editor.selection() || !editor.selection().atoms)\n      return new AtomTool(editor, atomProps)\n\n    const action = fromAtomsAttrs(\n      editor.render.ctab,\n      editor.selection().atoms,\n      atomProps,\n      true\n    )\n    editor.update(action)\n    editor.selection(null)\n    return null\n  }\n\n  this.editor = editor\n  this.atomProps = atomProps\n  this.struct = editor.render.ctab\n  this.bondProps = { type: 1, stereo: Bond.PATTERN.STEREO.NONE }\n  this.sgroups = editor.render.ctab.sgroups\n  this.molecule = editor.render.ctab.molecule\n  this.functionalGroups = this.molecule.functionalGroups\n}\n\nAtomTool.prototype.mousedown = function (event) {\n  this.editor.hover(null)\n  this.editor.selection(null)\n  const ci = this.editor.findItem(event, ['atoms', 'functionalGroups'])\n  if (\n    ci &&\n    ci.map === 'functionalGroups' &&\n    this.functionalGroups &&\n    FunctionalGroup.isContractedFunctionalGroup(ci.id, this.functionalGroups)\n  ) {\n    const action = new Action()\n    const selectedSgroup = this.sgroups.get(ci.id)\n    const sGroupAtoms = SGroup.getAtoms(this.molecule, selectedSgroup.item)\n    const [firstAtom, ...atoms] = sGroupAtoms\n    const atomNeighbours = this.struct.molecule.atomGetNeighbors(firstAtom)\n    const extraNeighbour = atomNeighbours.some(\n      atom => !sGroupAtoms.includes(atom.aid)\n    )\n    if (extraNeighbour) {\n      action.mergeWith(fromSgroupDeletion(this.struct, ci.id))\n      action.mergeWith(fromFragmentDeletion(this.struct, { atoms: atoms }))\n      action.mergeWith(\n        fromAtomsAttrs(this.struct, firstAtom, this.atomProps, true)\n      )\n    } else {\n      const firstAtomPp = this.struct.atoms.get(firstAtom).a.pp\n      action.mergeWith(\n        fromFragmentDeletion(this.struct, {\n          atoms: SGroup.getAtoms(this.molecule, selectedSgroup.item),\n          bonds: SGroup.getBonds(this.molecule, selectedSgroup.item)\n        })\n      )\n      action.mergeWith(\n        fromAtomAddition(this.struct, firstAtomPp, this.atomProps)\n      )\n    }\n    this.editor.update(action)\n  }\n  const atomResult = []\n  const result = []\n  if (ci && this.functionalGroups.size && ci.map === 'atoms') {\n    const atomId = FunctionalGroup.atomsInFunctionalGroup(\n      this.functionalGroups,\n      ci.id\n    )\n    if (atomId !== null) atomResult.push(atomId)\n  }\n  if (atomResult.length > 0) {\n    for (let id of atomResult) {\n      const fgId = FunctionalGroup.findFunctionalGroupByAtom(\n        this.functionalGroups,\n        id\n      )\n      if (fgId !== null && !result.includes(fgId)) {\n        result.push(fgId)\n      }\n    }\n    this.editor.event.removeFG.dispatch({ fgIds: result })\n    return\n  }\n  if (!ci) {\n    // ci.type == 'Canvas'\n    this.dragCtx = {}\n  } else if (ci.map === 'atoms') {\n    this.dragCtx = { item: ci }\n  }\n}\n\nAtomTool.prototype.mousemove = function (event) {\n  const rnd = this.editor.render\n  if (!this.dragCtx || !this.dragCtx.item) {\n    this.editor.hover(\n      this.editor.findItem(event, ['atoms', 'functionalGroups'])\n    )\n    return\n  }\n\n  const dragCtx = this.dragCtx\n  const ci = this.editor.findItem(event, ['atoms'])\n\n  if (ci && ci.map === 'atoms' && ci.id === dragCtx.item.id) {\n    // fromAtomsAttrs\n    this.editor.hover(this.editor.findItem(event, ['atoms']))\n    return\n  }\n\n  // fromAtomAddition\n  const atom = rnd.ctab.molecule.atoms.get(dragCtx.item.id)\n  let angle = utils.calcAngle(atom.pp, rnd.page2obj(event))\n  if (!event.ctrlKey) angle = utils.fracAngle(angle)\n  const degrees = utils.degrees(angle)\n  this.editor.event.message.dispatch({ info: degrees + '¬∫' })\n  const newAtomPos = utils.calcNewAtomPos(\n    atom.pp,\n    rnd.page2obj(event),\n    event.ctrlKey\n  )\n  if (dragCtx.action) dragCtx.action.perform(rnd.ctab)\n\n  dragCtx.action = fromBondAddition(\n    rnd.ctab,\n    this.bondProps,\n    dragCtx.item.id,\n    Object.assign({}, this.atomProps),\n    newAtomPos,\n    newAtomPos\n  )[0]\n  this.editor.update(dragCtx.action, true)\n}\n\nAtomTool.prototype.mouseup = function (event) {\n  const ci = this.editor.findItem(event, ['atoms', 'bonds'])\n  const atomResult = []\n  const result = []\n  if (ci && this.functionalGroups && ci.map === 'atoms') {\n    const atomId = FunctionalGroup.atomsInFunctionalGroup(\n      this.functionalGroups,\n      ci.id\n    )\n    if (atomId !== null) atomResult.push(atomId)\n  }\n  if (atomResult.length > 0) {\n    for (let id of atomResult) {\n      const fgId = FunctionalGroup.findFunctionalGroupByAtom(\n        this.functionalGroups,\n        id\n      )\n      if (fgId !== null && !result.includes(fgId)) {\n        result.push(fgId)\n      }\n    }\n    this.editor.event.removeFG.dispatch({ fgIds: result })\n    return\n  }\n\n  if (this.dragCtx) {\n    const dragCtx = this.dragCtx\n    const rnd = this.editor.render\n\n    this.editor.update(\n      dragCtx.action ||\n        (dragCtx.item\n          ? fromAtomsAttrs(rnd.ctab, dragCtx.item.id, this.atomProps, true)\n          : fromAtomAddition(rnd.ctab, rnd.page2obj(event), this.atomProps))\n    )\n\n    delete this.dragCtx\n  }\n  this.editor.event.message.dispatch({\n    info: false\n  })\n}\n\nexport function atomLongtapEvent(tool, render) {\n  const { dragCtx, editor } = tool\n  const atomid = dragCtx.item?.id\n  const fgs = render.ctab.molecule.functionalGroups\n  // edit atom or add atom\n  const atom =\n    atomid !== undefined && atomid !== null\n      ? render.ctab.molecule.atoms.get(atomid)\n      : new Atom({ label: '' })\n  const fgId = FunctionalGroup.findFunctionalGroupByAtom(fgs, atomid)\n  // TODO: longtab event\n  dragCtx.timeout = setTimeout(() => {\n    delete tool.dragCtx\n    if (fgId != null) {\n      editor.event.removeFG.dispatch({ fgIds: [fgId] })\n      return\n    }\n    editor.selection(null)\n    const res = editor.event.quickEdit.dispatch(atom)\n    Promise.resolve(res)\n      .then(newatom => {\n        const action = atomid\n          ? fromAtomsAttrs(render.ctab, atomid, newatom)\n          : fromAtomAddition(render.ctab, dragCtx.xy0, newatom)\n        editor.update(action)\n      })\n      .catch(() => null) // w/o changes\n  }, 750)\n\n  dragCtx.stopTapping = function () {\n    if (dragCtx.timeout) {\n      clearTimeout(dragCtx.timeout)\n      delete dragCtx.timeout\n    }\n  }\n}\n\nexport default AtomTool\n","/****************************************************************************\n * Copyright 2021 EPAM Systems\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *    http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n ***************************************************************************/\n\nimport { Elements, FunctionalGroup } from 'ketcher-core'\n\nfunction AttachTool(editor, attachPoints) {\n  if (!(this instanceof AttachTool)) return new AttachTool(editor, attachPoints)\n\n  this.attach = {\n    atomid: attachPoints.atomid || 0,\n    bondid: attachPoints.bondid || 0\n  }\n  this.editor = editor\n  this.struct = editor.render.ctab\n  this.sgroups = editor.render.ctab.sgroups\n  this.molecule = editor.render.ctab.molecule\n  this.functionalGroups = this.molecule.functionalGroups\n\n  this.editor.selection({\n    atoms: [this.attach.atomid],\n    bonds: [this.attach.bondid]\n  })\n}\n\nAttachTool.prototype.mousemove = function (event) {\n  const rnd = this.editor.render\n\n  const ci = this.editor.findItem(event, ['atoms', 'bonds'])\n  const struct = rnd.ctab.molecule\n  if (\n    ci &&\n    ((ci.map === 'atoms' && Elements.get(struct.atoms.get(ci.id)?.label)) ||\n      ci.map === 'bonds')\n  )\n    this.editor.hover(ci)\n  else this.editor.hover(null)\n  return true\n}\n\nAttachTool.prototype.click = function (event) {\n  const editor = this.editor\n  const rnd = editor.render\n  const struct = rnd.ctab.molecule\n  const ci = editor.findItem(event, ['atoms', 'bonds'])\n  const atomResult = []\n  const bondResult = []\n  const result = []\n  if (ci && this.functionalGroups.size && ci.map === 'atoms') {\n    const atomId = FunctionalGroup.atomsInFunctionalGroup(\n      this.functionalGroups,\n      ci.id\n    )\n    if (atomId !== null) atomResult.push(atomId)\n  }\n  if (ci && this.functionalGroups.size && ci.map === 'bonds') {\n    const bondId = FunctionalGroup.bondsInFunctionalGroup(\n      this.molecule,\n      this.functionalGroups,\n      ci.id\n    )\n    if (bondId !== null) bondResult.push(bondId)\n  }\n  if (atomResult.length > 0) {\n    for (let id of atomResult) {\n      const fgId = FunctionalGroup.findFunctionalGroupByAtom(\n        this.functionalGroups,\n        id\n      )\n      if (fgId !== null && !result.includes(fgId)) {\n        result.push(fgId)\n      }\n    }\n    this.editor.event.removeFG.dispatch({ fgIds: result })\n    return\n  } else if (bondResult.length > 0) {\n    for (let id of bondResult) {\n      const fgId = FunctionalGroup.findFunctionalGroupByBond(\n        this.molecule,\n        this.functionalGroups,\n        id\n      )\n      if (fgId !== null && !result.includes(fgId)) {\n        result.push(fgId)\n      }\n    }\n    this.editor.event.removeFG.dispatch({ fgIds: result })\n    return\n  }\n\n  if (\n    ci &&\n    ((ci.map === 'atoms' && Elements.get(struct.atoms.get(ci.id)?.label)) ||\n      ci.map === 'bonds')\n  ) {\n    if (ci.map === 'atoms') this.attach.atomid = ci.id\n    else this.attach.bondid = ci.id\n\n    this.editor.selection({\n      atoms: [this.attach.atomid],\n      bonds: [this.attach.bondid]\n    })\n    this.editor.event.attachEdit.dispatch(this.attach)\n  }\n  return true\n}\n\nexport default AttachTool\n","/****************************************************************************\n * Copyright 2021 EPAM Systems\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *    http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n ***************************************************************************/\n\nimport {\n  Bond,\n  Vec2,\n  bondChangingAction,\n  fromBondAddition,\n  fromBondsAttrs,\n  FunctionalGroup,\n  SGroup\n} from 'ketcher-core'\n\nimport utils from '../shared/utils'\n\nfunction BondTool(editor, bondProps) {\n  if (!(this instanceof BondTool)) {\n    if (!editor.selection() || !editor.selection().bonds)\n      return new BondTool(editor, bondProps)\n\n    const action = fromBondsAttrs(\n      editor.render.ctab,\n      editor.selection().bonds,\n      bondProps\n    )\n    editor.update(action)\n    editor.selection(null)\n    return null\n  }\n\n  this.editor = editor\n  this.atomProps = { label: 'C' }\n  this.bondProps = bondProps\n  this.struct = editor.render.ctab\n  this.sgroups = editor.render.ctab.sgroups\n  this.molecule = editor.render.ctab.molecule\n  this.functionalGroups = this.molecule.functionalGroups\n}\n\nBondTool.prototype.mousedown = function (event) {\n  if (this.dragCtx) return\n  const ci = this.editor.findItem(event, ['atoms', 'bonds'])\n  const atomResult = []\n  const bondResult = []\n  const result = []\n  if (ci && this.functionalGroups.size && ci.map === 'atoms') {\n    const atomId = FunctionalGroup.atomsInFunctionalGroup(\n      this.functionalGroups,\n      ci.id\n    )\n    if (atomId !== null) atomResult.push(atomId)\n  }\n  if (ci && this.functionalGroups.size && ci.map === 'bonds') {\n    const bondId = FunctionalGroup.bondsInFunctionalGroup(\n      this.molecule,\n      this.functionalGroups,\n      ci.id\n    )\n    if (bondId !== null) bondResult.push(bondId)\n  }\n  if (atomResult.length > 0) {\n    for (let id of atomResult) {\n      const fgId = FunctionalGroup.findFunctionalGroupByAtom(\n        this.functionalGroups,\n        id\n      )\n      if (fgId !== null && !result.includes(fgId)) {\n        result.push(fgId)\n      }\n    }\n    this.editor.event.removeFG.dispatch({ fgIds: result })\n    return\n  } else if (bondResult.length > 0) {\n    for (let id of bondResult) {\n      const fgId = FunctionalGroup.findFunctionalGroupByBond(\n        this.molecule,\n        this.functionalGroups,\n        id\n      )\n      if (fgId !== null && !result.includes(fgId)) {\n        result.push(fgId)\n      }\n    }\n    this.editor.event.removeFG.dispatch({ fgIds: result })\n    return\n  }\n  const rnd = this.editor.render\n  this.editor.hover(null)\n  this.editor.selection(null)\n  this.dragCtx = {\n    xy0: rnd.page2obj(event),\n    item: this.editor.findItem(event, ['atoms', 'bonds'])\n  }\n  if (!this.dragCtx.item)\n    // ci.type == 'Canvas'\n    delete this.dragCtx.item\n  return true\n}\n\nBondTool.prototype.mousemove = function (event) {\n  // eslint-disable-line max-statements\n  const editor = this.editor\n  const rnd = editor.render\n  if ('dragCtx' in this) {\n    const dragCtx = this.dragCtx\n\n    const pos = rnd.page2obj(event)\n    let angle = utils.calcAngle(dragCtx.xy0, pos)\n    if (!event.ctrlKey) angle = utils.fracAngle(angle)\n\n    const degrees = utils.degrees(angle)\n    this.editor.event.message.dispatch({ info: degrees + '¬∫' })\n\n    if (!('item' in dragCtx) || dragCtx.item.map === 'atoms') {\n      if ('action' in dragCtx) dragCtx.action.perform(rnd.ctab)\n      let beginAtom\n      let endAtom\n      let beginPos\n      let endPos\n      const extraNeighbour = []\n      if ('item' in dragCtx && dragCtx.item.map === 'atoms') {\n        // first mousedown event intersect with any atom\n        beginAtom = dragCtx.item.id\n        endAtom = editor.findItem(event, ['atoms'], dragCtx.item)\n        const closestSGroup = editor.findItem(event, ['functionalGroups'])\n        if (\n          closestSGroup &&\n          FunctionalGroup.isContractedFunctionalGroup(\n            closestSGroup.id,\n            this.functionalGroups\n          )\n        ) {\n          const sGroup = this.sgroups.get(closestSGroup.id)\n          const sGroupAtoms = SGroup.getAtoms(this.molecule, sGroup.item)\n          endAtom = {\n            id: sGroupAtoms[0],\n            map: 'atoms'\n          }\n        }\n        const fGroupId =\n          endAtom &&\n          FunctionalGroup.findFunctionalGroupByAtom(\n            this.functionalGroups,\n            endAtom.id\n          )\n        const fGroup =\n          typeof fGroupId === 'number' && this.sgroups.get(fGroupId)\n        const fGroupAtoms =\n          fGroup && SGroup.getAtoms(this.molecule, fGroup.item)\n        if (endAtom && fGroup && endAtom.id !== fGroupAtoms[0]) {\n          this.editor.event.removeFG.dispatch({ fgIds: [fGroupId] })\n          endAtom = null\n        }\n        if (endAtom && fGroup && endAtom.id === fGroupAtoms[0]) {\n          const atomNeighbours = this.molecule.atomGetNeighbors(endAtom.id)\n          atomNeighbours.forEach(nei => {\n            !fGroupAtoms.includes(nei.aid) &&\n              !extraNeighbour.includes(nei.aid) &&\n              extraNeighbour.push(nei.aid)\n          })\n        }\n        if (extraNeighbour.length >= 1) {\n          endAtom = null\n        }\n      } else {\n        // first mousedown event intersect with any canvas\n        beginAtom = this.atomProps\n        beginPos = dragCtx.xy0\n        endAtom = editor.findItem(event, ['atoms'])\n        const atomResult = []\n        const result = []\n        if (\n          endAtom &&\n          endAtom.map === 'atoms' &&\n          this.functionalGroups.size &&\n          this.dragCtx\n        ) {\n          const atomId = FunctionalGroup.atomsInFunctionalGroup(\n            this.functionalGroups,\n            endAtom.id\n          )\n          if (atomId !== null) atomResult.push(atomId)\n        }\n        if (atomResult.length > 0) {\n          for (let id of atomResult) {\n            const fgId = FunctionalGroup.findFunctionalGroupByAtom(\n              this.functionalGroups,\n              id\n            )\n            fgId !== null && !result.includes(fgId) && result.push(fgId)\n          }\n        }\n        if (result.length > 0) {\n          this.editor.event.removeFG.dispatch({ fgIds: result })\n          delete this.dragCtx\n          return\n        }\n      }\n      let dist = Number.MAX_VALUE\n      if (endAtom && endAtom.map === 'atoms') {\n        // after mousedown events is appered, cursor is moved and then cursor intersects any atoms\n        endAtom = endAtom.id\n      } else {\n        endAtom = this.atomProps\n        const xy1 = rnd.page2obj(event)\n        dist = Vec2.dist(dragCtx.xy0, xy1)\n        if (beginPos) {\n          // rotation only, leght of bond = 1;\n          endPos = utils.calcNewAtomPos(beginPos, xy1, event.ctrlKey)\n        } else {\n          // first mousedown event intersect with any atom and\n          // rotation only, leght of bond = 1;\n          const atom = rnd.ctab.molecule.atoms.get(beginAtom)\n          beginPos = utils.calcNewAtomPos(atom.pp.get_xy0(), xy1, event.ctrlKey)\n        }\n      }\n      // don't rotate the bond if the distance between the start and end point is too small\n      if (dist > 0.3)\n        dragCtx.action = fromBondAddition(\n          rnd.ctab,\n          this.bondProps,\n          beginAtom,\n          endAtom,\n          beginPos,\n          endPos\n        )[0]\n      else delete dragCtx.action\n      this.editor.update(dragCtx.action, true)\n      return true\n    }\n  }\n  this.editor.hover(this.editor.findItem(event, ['atoms', 'bonds']))\n  return true\n}\n\nBondTool.prototype.mouseup = function (event) {\n  // eslint-disable-line max-statements\n  if ('dragCtx' in this) {\n    var dragCtx = this.dragCtx\n    var rnd = this.editor.render\n    var struct = rnd.ctab.molecule\n    if ('action' in dragCtx) {\n      this.editor.update(dragCtx.action)\n    } else if (!('item' in dragCtx)) {\n      var xy = rnd.page2obj(event)\n      var v = new Vec2(1.0 / 2, 0).rotate(\n        this.bondProps.type === Bond.PATTERN.TYPE.SINGLE ? -Math.PI / 6 : 0\n      )\n      var bondAddition = fromBondAddition(\n        rnd.ctab,\n        this.bondProps,\n        { label: 'C' },\n        { label: 'C' },\n        Vec2.diff(xy, v),\n        Vec2.sum(xy, v)\n      )\n\n      this.editor.update(bondAddition[0])\n    } else if (dragCtx.item.map === 'atoms') {\n      // when does it hapend?\n      this.editor.update(\n        fromBondAddition(rnd.ctab, this.bondProps, dragCtx.item.id)[0]\n      )\n    } else if (dragCtx.item.map === 'bonds') {\n      var bondProps = Object.assign({}, this.bondProps)\n      var bond = struct.bonds.get(dragCtx.item.id)\n\n      this.editor.update(\n        bondChangingAction(rnd.ctab, dragCtx.item.id, bond, bondProps)\n      )\n    }\n    delete this.dragCtx\n  }\n  this.editor.event.message.dispatch({\n    info: false\n  })\n  return true\n}\n\nexport default BondTool\n","/****************************************************************************\n * Copyright 2021 EPAM Systems\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *    http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n ***************************************************************************/\n\nimport {\n  Bond,\n  Vec2,\n  bondChangingAction,\n  fromChain,\n  fromItemsFuse,\n  getHoverToFuse,\n  getItemsToFuse,\n  FunctionalGroup\n} from 'ketcher-core'\n\nimport { atomLongtapEvent } from './atom'\nimport utils from '../shared/utils'\n\nfunction ChainTool(editor) {\n  if (!(this instanceof ChainTool)) return new ChainTool(editor)\n\n  this.editor = editor\n  this.editor.selection(null)\n  this.struct = editor.render.ctab\n  this.sgroups = editor.render.ctab.sgroups\n  this.molecule = editor.render.ctab.molecule\n  this.functionalGroups = this.molecule.functionalGroups\n}\n\nChainTool.prototype.mousedown = function (event) {\n  if (this.dragCtx) return\n  const rnd = this.editor.render\n  const ci = this.editor.findItem(event, ['atoms', 'bonds'])\n  const atomResult = []\n  const bondResult = []\n  const result = []\n  if (ci && this.functionalGroups.size && ci.map === 'atoms') {\n    const atomId = FunctionalGroup.atomsInFunctionalGroup(\n      this.functionalGroups,\n      ci.id\n    )\n    if (atomId !== null) atomResult.push(atomId)\n  }\n  if (ci && this.functionalGroups.size && ci.map === 'bonds') {\n    const bondId = FunctionalGroup.bondsInFunctionalGroup(\n      this.molecule,\n      this.functionalGroups,\n      ci.id\n    )\n    if (bondId !== null) bondResult.push(bondId)\n  }\n  if (atomResult.length > 0) {\n    for (let id of atomResult) {\n      const fgId = FunctionalGroup.findFunctionalGroupByAtom(\n        this.functionalGroups,\n        id\n      )\n      if (fgId !== null && !result.includes(fgId)) {\n        result.push(fgId)\n      }\n    }\n    this.editor.event.removeFG.dispatch({ fgIds: result })\n    return\n  } else if (bondResult.length > 0) {\n    for (let id of bondResult) {\n      const fgId = FunctionalGroup.findFunctionalGroupByBond(\n        this.molecule,\n        this.functionalGroups,\n        id\n      )\n      if (fgId !== null && !result.includes(fgId)) {\n        result.push(fgId)\n      }\n    }\n    this.editor.event.removeFG.dispatch({ fgIds: result })\n    return\n  }\n\n  this.editor.hover(null)\n  this.dragCtx = {\n    xy0: rnd.page2obj(event),\n    item: ci\n  }\n  if (ci && ci.map === 'atoms') {\n    this.editor.selection({ atoms: [ci.id] }) // for change atom\n    // this event has to be stopped in others events by `tool.dragCtx.stopTapping()`\n    atomLongtapEvent(this, rnd)\n  }\n  if (!this.dragCtx.item)\n    // ci.type == 'Canvas'\n    delete this.dragCtx.item\n  return true\n}\n\nChainTool.prototype.mousemove = function (event) {\n  // eslint-disable-line max-statements\n  const editor = this.editor\n  const restruct = editor.render.ctab\n  const dragCtx = this.dragCtx\n\n  editor.hover(this.editor.findItem(event, ['atoms', 'bonds']))\n  if (!dragCtx) return true\n\n  if (dragCtx && dragCtx.stopTapping) dragCtx.stopTapping()\n\n  editor.selection(null)\n\n  if (!dragCtx.item || dragCtx.item.map === 'atoms') {\n    if (dragCtx.action) dragCtx.action.perform(restruct)\n\n    const atoms = restruct.molecule.atoms\n\n    const pos0 = dragCtx.item ? atoms.get(dragCtx.item.id).pp : dragCtx.xy0\n\n    const pos1 = editor.render.page2obj(event)\n    const sectCount = Math.ceil(Vec2.diff(pos1, pos0).length())\n\n    const angle = event.ctrlKey\n      ? utils.calcAngle(pos0, pos1)\n      : utils.fracAngle(pos0, pos1)\n\n    const [action, newItems] = fromChain(\n      restruct,\n      pos0,\n      angle,\n      sectCount,\n      dragCtx.item ? dragCtx.item.id : null\n    )\n\n    editor.event.message.dispatch({\n      info: sectCount + ' sectors'\n    })\n\n    dragCtx.action = action\n    editor.update(dragCtx.action, true)\n\n    dragCtx.mergeItems = getItemsToFuse(editor, newItems)\n    editor.hover(getHoverToFuse(dragCtx.mergeItems))\n\n    return true\n  }\n\n  return true\n}\n\nChainTool.prototype.mouseup = function () {\n  let atom\n  const atomResult = []\n  const result = []\n  if (this.dragCtx && this.dragCtx.mergeItems && this.functionalGroups.size) {\n    atom = this.dragCtx.mergeItems.atoms.values().next().value\n  }\n  if (atom) {\n    const atomId = FunctionalGroup.atomsInFunctionalGroup(\n      this.functionalGroups,\n      atom\n    )\n    if (atomId !== null) atomResult.push(atomId)\n  }\n  if (atomResult.length > 0) {\n    for (let id of atomResult) {\n      const fgId = FunctionalGroup.findFunctionalGroupByAtom(\n        this.functionalGroups,\n        id\n      )\n      if (fgId !== null && !result.includes(fgId)) {\n        result.push(fgId)\n      }\n    }\n    this.editor.event.removeFG.dispatch({ fgIds: result })\n    return\n  }\n  const dragCtx = this.dragCtx\n  if (!dragCtx) return true\n  delete this.dragCtx\n\n  const editor = this.editor\n  const restruct = editor.render.ctab\n  const struct = restruct.molecule\n\n  if (dragCtx.stopTapping) dragCtx.stopTapping()\n\n  if (!dragCtx.action && dragCtx.item && dragCtx.item.map === 'bonds') {\n    const bond = struct.bonds.get(dragCtx.item.id)\n\n    dragCtx.action = bondChangingAction(restruct, dragCtx.item.id, bond, {\n      type: Bond.PATTERN.TYPE.SINGLE,\n      stereo: Bond.PATTERN.STEREO.NONE\n    })\n  } else {\n    dragCtx.action = dragCtx.action\n      ? fromItemsFuse(restruct, dragCtx.mergeItems).mergeWith(dragCtx.action)\n      : fromItemsFuse(restruct, dragCtx.mergeItems)\n  }\n\n  editor.selection(null)\n  editor.hover(null)\n\n  if (dragCtx.action) editor.update(dragCtx.action)\n\n  editor.event.message.dispatch({\n    info: false\n  })\n\n  return true\n}\n\nChainTool.prototype.cancel = ChainTool.prototype.mouseup\n\nChainTool.prototype.mouseleave = ChainTool.prototype.mouseup\n\nexport default ChainTool\n","/****************************************************************************\n * Copyright 2021 EPAM Systems\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *    http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n ***************************************************************************/\n\nimport { Elements, fromAtomsAttrs, FunctionalGroup } from 'ketcher-core'\n\nfunction ChargeTool(editor, charge) {\n  if (!(this instanceof ChargeTool)) return new ChargeTool(editor, charge)\n\n  this.editor = editor\n  this.editor.selection(null)\n  this.charge = charge\n  this.struct = editor.render.ctab\n  this.sgroups = editor.render.ctab.sgroups\n  this.molecule = editor.render.ctab.molecule\n  this.functionalGroups = this.molecule.functionalGroups\n}\n\nChargeTool.prototype.mousemove = function (event) {\n  var rnd = this.editor.render\n  var ci = this.editor.findItem(event, ['atoms'])\n  var struct = rnd.ctab.molecule\n  if (ci && ci.map === 'atoms' && Elements.get(struct.atoms.get(ci.id)?.label))\n    this.editor.hover(ci)\n  else this.editor.hover(null)\n  return true\n}\n\nChargeTool.prototype.click = function (event) {\n  var editor = this.editor\n  var rnd = editor.render\n  var struct = rnd.ctab.molecule\n  const ci = editor.findItem(event, ['atoms', 'bonds'])\n  const atomResult = []\n  const result = []\n  if (ci && this.functionalGroups.size && ci.map === 'atoms') {\n    const atomId = FunctionalGroup.atomsInFunctionalGroup(\n      this.functionalGroups,\n      ci.id\n    )\n    if (atomId !== null) atomResult.push(atomId)\n  }\n  if (atomResult.length > 0) {\n    for (let id of atomResult) {\n      const fgId = FunctionalGroup.findFunctionalGroupByAtom(\n        this.functionalGroups,\n        id\n      )\n      if (fgId !== null && !result.includes(fgId)) {\n        result.push(fgId)\n      }\n    }\n    this.editor.event.removeFG.dispatch({ fgIds: result })\n    return\n  }\n  if (\n    ci &&\n    ci.map === 'atoms' &&\n    Elements.get(struct.atoms.get(ci.id)?.label)\n  ) {\n    this.editor.hover(null)\n    this.editor.update(\n      fromAtomsAttrs(rnd.ctab, ci.id, {\n        charge: struct.atoms.get(ci.id).charge + this.charge\n      })\n    )\n  }\n  return true\n}\n\nexport default ChargeTool\n","/****************************************************************************\n * Copyright 2021 EPAM Systems\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *    http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n ***************************************************************************/\n\nimport { FunctionalGroup, Vec2 } from 'ketcher-core'\n\nfunction getElementsInRectangle(restruct, p0, p1) {\n  const bondList = []\n  const atomList = []\n  const sGroups = restruct.sgroups\n  const functionalGroups = restruct.molecule.functionalGroups\n\n  const x0 = Math.min(p0.x, p1.x)\n  const x1 = Math.max(p0.x, p1.x)\n  const y0 = Math.min(p0.y, p1.y)\n  const y1 = Math.max(p0.y, p1.y)\n\n  restruct.bonds.forEach((bond, bid) => {\n    const centre = Vec2.lc2(\n      restruct.atoms.get(bond.b.begin).a.pp,\n      0.5,\n      restruct.atoms.get(bond.b.end).a.pp,\n      0.5\n    )\n    if (\n      centre.x > x0 &&\n      centre.x < x1 &&\n      centre.y > y0 &&\n      centre.y < y1 &&\n      !FunctionalGroup.isBondInContractedFunctionalGroup(\n        bond.b,\n        sGroups,\n        functionalGroups,\n        true\n      )\n    )\n      bondList.push(bid)\n  })\n\n  restruct.atoms.forEach((atom, aid) => {\n    const relatedFGId = FunctionalGroup.findFunctionalGroupByAtom(\n      functionalGroups,\n      aid\n    )\n    const sGroup = restruct.sgroups.get(relatedFGId)\n    if (\n      atom.a.pp.x > x0 &&\n      atom.a.pp.x < x1 &&\n      atom.a.pp.y > y0 &&\n      atom.a.pp.y < y1 &&\n      (!FunctionalGroup.isAtomInContractedFunctionalGroup(\n        atom.a,\n        sGroups,\n        functionalGroups,\n        true\n      ) ||\n        aid === sGroup.item.atoms[0])\n    )\n      atomList.push(aid)\n  })\n\n  const rxnArrowsList = []\n  const rxnPlusesList = []\n  const simpleObjectsList = []\n\n  restruct.rxnArrows.forEach((item, id) => {\n    if (\n      item.item.center().x > x0 &&\n      item.item.center().x < x1 &&\n      item.item.center().y > y0 &&\n      item.item.center().y < y1\n    )\n      rxnArrowsList.push(id)\n  })\n\n  restruct.rxnPluses.forEach((item, id) => {\n    if (\n      item.item.pp.x > x0 &&\n      item.item.pp.x < x1 &&\n      item.item.pp.y > y0 &&\n      item.item.pp.y < y1\n    )\n      rxnPlusesList.push(id)\n  })\n\n  restruct.simpleObjects.forEach((item, id) => {\n    const referencePoints = item.getReferencePoints(true)\n    const referencePointInRectangle = referencePoints.find(\n      point => point.x > x0 && point.x < x1 && point.y > y0 && point.y < y1\n    )\n    if (referencePointInRectangle) simpleObjectsList.push(id)\n  })\n\n  const enhancedFlagList = []\n  restruct.enhancedFlags.forEach((item, id) => {\n    if (!item.pp) return\n    if (item.pp.x > x0 && item.pp.x < x1 && item.pp.y > y0 && item.pp.y < y1)\n      enhancedFlagList.push(id)\n  })\n\n  const sgroupDataList = []\n  restruct.sgroupData.forEach((item, id) => {\n    if (\n      item.sgroup.pp.x > x0 &&\n      item.sgroup.pp.x < x1 &&\n      item.sgroup.pp.y > y0 &&\n      item.sgroup.pp.y < y1\n    )\n      sgroupDataList.push(id)\n  })\n\n  const textsList = []\n  restruct.texts.forEach((item, id) => {\n    const referencePoints = item.getReferencePoints()\n    const referencePointInRectangle = referencePoints.find(point => {\n      return point.x > x0 && point.x < x1 && point.y > y0 && point.y < y1\n    })\n\n    if (referencePointInRectangle) {\n      textsList.push(id)\n    }\n  })\n\n  return {\n    atoms: atomList,\n    bonds: bondList,\n    rxnArrows: rxnArrowsList,\n    rxnPluses: rxnPlusesList,\n    enhancedFlags: enhancedFlagList,\n    sgroupData: sgroupDataList,\n    simpleObjects: simpleObjectsList,\n    texts: textsList\n  }\n}\n\nfunction getElementsInPolygon(restruct, rr) {\n  // eslint-disable-line max-statements\n  const bondList = []\n  const atomList = []\n  const r = []\n  const sGroups = restruct.sgroups\n  const functionalGroups = restruct.molecule.functionalGroups\n\n  for (let i = 0; i < rr.length; ++i) r[i] = new Vec2(rr[i].x, rr[i].y)\n\n  restruct.bonds.forEach((bond, bid) => {\n    const centre = Vec2.lc2(\n      restruct.atoms.get(bond.b.begin).a.pp,\n      0.5,\n      restruct.atoms.get(bond.b.end).a.pp,\n      0.5\n    )\n    if (\n      isPointInPolygon(r, centre) &&\n      !FunctionalGroup.isBondInContractedFunctionalGroup(\n        bond.b,\n        sGroups,\n        functionalGroups,\n        true\n      )\n    )\n      bondList.push(bid)\n  })\n\n  restruct.atoms.forEach((atom, aid) => {\n    const relatedFGId = FunctionalGroup.findFunctionalGroupByAtom(\n      functionalGroups,\n      aid\n    )\n    const sGroup = restruct.sgroups.get(relatedFGId)\n    if (\n      isPointInPolygon(r, atom.a.pp) &&\n      (!FunctionalGroup.isAtomInContractedFunctionalGroup(\n        atom.a,\n        sGroups,\n        functionalGroups,\n        true\n      ) ||\n        aid === sGroup.item.atoms[0])\n    )\n      atomList.push(aid)\n  })\n\n  const rxnArrowsList = []\n  const rxnPlusesList = []\n  const simpleObjectsList = []\n  const textsList = []\n\n  restruct.rxnArrows.forEach((item, id) => {\n    const referencePoints = item.getReferencePoints(true)\n    const referencePointInPolygon = referencePoints.find(point =>\n      isPointInPolygon(r, point)\n    )\n    if (referencePointInPolygon) rxnArrowsList.push(id)\n  })\n\n  restruct.rxnPluses.forEach((item, id) => {\n    if (isPointInPolygon(r, item.item.pp)) rxnPlusesList.push(id)\n  })\n\n  restruct.simpleObjects.forEach((item, id) => {\n    const referencePoints = item.getReferencePoints(true)\n    const referencePointInPolygon = referencePoints.find(point =>\n      isPointInPolygon(r, point)\n    )\n    if (referencePointInPolygon) simpleObjectsList.push(id)\n  })\n\n  restruct.texts.forEach((item, id) => {\n    const referencePoints = item.getReferencePoints()\n    const referencePointInPolygon = referencePoints.find(point =>\n      isPointInPolygon(r, point)\n    )\n\n    if (referencePointInPolygon) {\n      textsList.push(id)\n    }\n  })\n\n  const enhancedFlagList = []\n  restruct.enhancedFlags.forEach((item, id) => {\n    if (item.pp && isPointInPolygon(r, item.pp)) enhancedFlagList.push(id)\n  })\n\n  const sgroupDataList = []\n  restruct.sgroupData.forEach((item, id) => {\n    if (isPointInPolygon(r, item.sgroup.pp)) sgroupDataList.push(id)\n  })\n\n  return {\n    atoms: atomList,\n    bonds: bondList,\n    rxnArrows: rxnArrowsList,\n    rxnPluses: rxnPlusesList,\n    enhancedFlags: enhancedFlagList,\n    sgroupData: sgroupDataList,\n    simpleObjects: simpleObjectsList,\n    texts: textsList\n  }\n}\n\n// TODO: test me see testPolygon from\n// 'Remove unused methods from render' commit\nfunction isPointInPolygon(r, p) {\n  // eslint-disable-line max-statements\n  var d = new Vec2(0, 1)\n  var n = d.rotate(Math.PI / 2)\n  var v0 = Vec2.diff(r[r.length - 1], p)\n  var n0 = Vec2.dot(n, v0)\n  var d0 = Vec2.dot(d, v0)\n  var w0 = null\n  var counter = 0\n  var eps = 1e-5\n  var flag1 = false\n  var flag0 = false\n\n  for (var i = 0; i < r.length; ++i) {\n    var v1 = Vec2.diff(r[i], p)\n    var w1 = Vec2.diff(v1, v0)\n    var n1 = Vec2.dot(n, v1)\n    var d1 = Vec2.dot(d, v1)\n    flag1 = false\n    if (n1 * n0 < 0) {\n      if (d1 * d0 > -eps) {\n        if (d0 > -eps) flag1 = true\n        /* eslint-disable no-mixed-operators*/\n      } else if (\n        (Math.abs(n0) * Math.abs(d1) - Math.abs(n1) * Math.abs(d0)) * d1 >\n        0\n      ) {\n        /* eslint-enable no-mixed-operators*/\n        flag1 = true\n      }\n    }\n    if (flag1 && flag0 && Vec2.dot(w1, n) * Vec2.dot(w0, n) >= 0) flag1 = false\n    if (flag1) counter++\n    v0 = v1\n    n0 = n1\n    d0 = d1\n    w0 = w1\n    flag0 = flag1\n  }\n  return counter % 2 !== 0\n}\n\nexport default {\n  inRectangle: getElementsInRectangle,\n  inPolygon: getElementsInPolygon\n}\n","/****************************************************************************\n * Copyright 2021 EPAM Systems\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *    http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n ***************************************************************************/\n\nimport { Scale } from 'ketcher-core'\nimport locate from './locate'\n\nfunction LassoHelper(mode, editor, fragment) {\n  this.mode = mode\n  this.fragment = fragment\n  this.editor = editor\n}\n\nLassoHelper.prototype.getSelection = function () {\n  const rnd = this.editor.render\n\n  if (this.mode === 0) return locate.inPolygon(rnd.ctab, this.points)\n\n  if (this.mode === 1)\n    return locate.inRectangle(rnd.ctab, this.points[0], this.points[1])\n\n  throw new Error('Selector mode unknown') // eslint-disable-line no-else-return\n}\n\nLassoHelper.prototype.begin = function (event) {\n  const rnd = this.editor.render\n  this.points = [rnd.page2obj(event)]\n  if (this.mode === 1) this.points.push(this.points[0])\n}\n\nLassoHelper.prototype.running = function () {\n  return !!this.points\n}\n\nLassoHelper.prototype.addPoint = function (event) {\n  if (!this.points) return null\n\n  const rnd = this.editor.render\n\n  if (this.mode === 0) this.points.push(rnd.page2obj(event))\n  else if (this.mode === 1) this.points = [this.points[0], rnd.page2obj(event)]\n\n  this.update()\n  return this.getSelection()\n}\n\nLassoHelper.prototype.update = function () {\n  if (this.selection) {\n    this.selection.remove()\n    this.selection = null\n  }\n\n  if (this.points && this.points.length > 1) {\n    const rnd = this.editor.render\n    const dp = this.points.map(p =>\n      Scale.obj2scaled(p, rnd.options).add(rnd.options.offset)\n    )\n    this.selection =\n      this.mode === 0\n        ? rnd.selectionPolygon(dp)\n        : rnd.selectionRectangle(dp[0], dp[1])\n  }\n}\n\nLassoHelper.prototype.end = function () {\n  const ret = this.getSelection()\n  this.points = null\n  this.update(null)\n  return ret\n}\n\nLassoHelper.prototype.cancel = function () {\n  this.points = null\n  this.update(null)\n}\n\nexport default LassoHelper\n","/****************************************************************************\n * Copyright 2021 EPAM Systems\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *    http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n ***************************************************************************/\n\nimport {\n  Pile,\n  SgContexts,\n  checkOverlapping,\n  fromSeveralSgroupAddition,\n  fromSgroupAction,\n  fromSgroupDeletion,\n  FunctionalGroup,\n  SGroup\n} from 'ketcher-core'\n\nimport LassoHelper from './helper/lasso'\nimport { isEqual } from 'lodash/fp'\nimport { selMerge } from './select'\n\nconst searchMaps = [\n  'atoms',\n  'bonds',\n  'sgroups',\n  'functionalGroups',\n  'sgroupData'\n]\n\nfunction SGroupTool(editor, type) {\n  if (!(this instanceof SGroupTool)) {\n    var selection = editor.selection() || {}\n    if (!selection.atoms && !selection.bonds)\n      return new SGroupTool(editor, type)\n\n    var sgroups = editor.render.ctab.molecule.sgroups\n    var selectedAtoms = editor.selection().atoms\n    const molecule = editor.render.ctab.molecule\n    const struct = editor.render.ctab\n    const newSelected = { atoms: [], bonds: [] }\n    let actualSgroupId\n    let atomsResult = []\n    let extraAtoms\n    const functionalGroups = editor.render.ctab.molecule.functionalGroups\n    const result = []\n\n    var id = sgroups.find((_, sgroup) => isEqual(sgroup.atoms, selectedAtoms))\n\n    if (selectedAtoms && functionalGroups.size) {\n      for (let atom of selectedAtoms) {\n        const atomId = FunctionalGroup.atomsInFunctionalGroup(\n          functionalGroups,\n          atom\n        )\n        if (atomId == null) extraAtoms = true\n        const atomFromStruct = atomId !== null && struct.atoms.get(atomId).a\n\n        if (atomFromStruct) {\n          for (let sgId of atomFromStruct.sgs.values()) {\n            actualSgroupId = sgId\n          }\n        }\n        if (\n          atomFromStruct &&\n          FunctionalGroup.isAtomInContractedFunctionalGroup(\n            atomFromStruct,\n            sgroups,\n            functionalGroups,\n            false\n          )\n        ) {\n          const sgroupAtoms =\n            actualSgroupId !== undefined &&\n            SGroup.getAtoms(molecule, sgroups.get(actualSgroupId))\n          const sgroupBonds =\n            actualSgroupId !== undefined &&\n            SGroup.getBonds(molecule, sgroups.get(actualSgroupId))\n          atom === sgroupAtoms[0] &&\n            newSelected.atoms.push(...sgroupAtoms) &&\n            newSelected.bonds.push(...sgroupBonds)\n        }\n\n        if (atomFromStruct) atomsResult.push(atomId)\n      }\n    }\n    if (extraAtoms) atomsResult = []\n\n    if (atomsResult && atomsResult.length > 0) {\n      for (let id of atomsResult) {\n        const fgId = FunctionalGroup.findFunctionalGroupByAtom(\n          functionalGroups,\n          id\n        )\n        if (fgId !== null && !result.includes(fgId)) result.push(fgId)\n      }\n    }\n\n    if (result.length) {\n      editor.selection(null)\n      editor.event.removeFG.dispatch({ fgIds: result })\n      return\n    }\n\n    sgroupDialog(editor, id !== undefined ? id : null, type)\n    return null\n  }\n\n  this.editor = editor\n  this.struct = editor.render.ctab\n  this.sgroups = editor.render.ctab.sgroups\n  this.molecule = editor.render.ctab.molecule\n  this.functionalGroups = this.molecule.functionalGroups\n  this.type = type\n\n  this.lassoHelper = new LassoHelper(1, editor)\n  this.editor.selection(null)\n}\n\nSGroupTool.prototype.mousedown = function (event) {\n  var ci = this.editor.findItem(event, searchMaps)\n  const atomResult = []\n  const bondResult = []\n  const result = []\n  if (ci && this.functionalGroups.size && ci.map === 'atoms') {\n    const atomId = FunctionalGroup.atomsInFunctionalGroup(\n      this.functionalGroups,\n      ci.id\n    )\n    const atomFromStruct = atomId !== null && this.struct.atoms.get(atomId).a\n    if (\n      atomFromStruct &&\n      !FunctionalGroup.isAtomInContractedFunctionalGroup(\n        atomFromStruct,\n        this.sgroups,\n        this.functionalGroups,\n        true\n      )\n    )\n      atomResult.push(atomId)\n  }\n  if (ci && this.functionalGroups.size && ci.map === 'bonds') {\n    const bondId = FunctionalGroup.bondsInFunctionalGroup(\n      this.molecule,\n      this.functionalGroups,\n      ci.id\n    )\n    const bondFromStruct = bondId !== null && this.struct.bonds.get(bondId).b\n    if (\n      bondFromStruct &&\n      !FunctionalGroup.isBondInContractedFunctionalGroup(\n        bondFromStruct,\n        this.sgroups,\n        this.functionalGroups,\n        true\n      )\n    )\n      bondResult.push(bondId)\n  }\n  if (ci && this.functionalGroups.size && ci.map === 'functionalGroups') {\n    const sgroup = this.sgroups.get(ci.id)\n    if (FunctionalGroup.isFunctionalGroup(sgroup.item)) {\n      this.editor.event.removeFG.dispatch({ fgIds: [ci.id] })\n      return\n    }\n  }\n  if (atomResult.length > 0) {\n    for (let id of atomResult) {\n      const fgId = FunctionalGroup.findFunctionalGroupByAtom(\n        this.functionalGroups,\n        id\n      )\n      if (fgId !== null && !result.includes(fgId)) {\n        result.push(fgId)\n      }\n    }\n    this.editor.event.removeFG.dispatch({ fgIds: result })\n    return\n  } else if (bondResult.length > 0) {\n    for (let id of bondResult) {\n      const fgId = FunctionalGroup.findFunctionalGroupByBond(\n        this.molecule,\n        this.functionalGroups,\n        id\n      )\n      if (fgId !== null && !result.includes(fgId)) {\n        result.push(fgId)\n      }\n    }\n    this.editor.event.removeFG.dispatch({ fgIds: result })\n    return\n  }\n  if (!ci)\n    //  ci.type == 'Canvas'\n    this.lassoHelper.begin(event)\n}\n\nSGroupTool.prototype.mousemove = function (event) {\n  if (this.lassoHelper.running(event))\n    this.editor.selection(this.lassoHelper.addPoint(event))\n  else this.editor.hover(this.editor.findItem(event, searchMaps))\n}\n\nSGroupTool.prototype.mouseleave = function (event) {\n  if (this.lassoHelper.running(event)) this.lassoHelper.end(event)\n}\n\nSGroupTool.prototype.mouseup = function (event) {\n  let ci = this.editor.findItem(event, searchMaps)\n  const selected = this.editor.selection()\n  let newSelected = { atoms: [], bonds: [] }\n  let actualSgroupId\n  let atomsResult = []\n  let extraAtoms\n  let bondsResult = []\n  let extraBonds\n  const result = []\n\n  if (\n    ci &&\n    ci.map === 'functionalGroups' &&\n    this.functionalGroups.size &&\n    FunctionalGroup.isContractedFunctionalGroup(ci.id, this.functionalGroups)\n  )\n    return\n\n  if (selected && this.functionalGroups.size && selected.atoms) {\n    for (let atom of selected.atoms) {\n      const atomId = FunctionalGroup.atomsInFunctionalGroup(\n        this.functionalGroups,\n        atom\n      )\n      if (atomId == null) extraAtoms = true\n      const atomFromStruct = atomId !== null && this.struct.atoms.get(atomId).a\n\n      if (atomFromStruct) {\n        for (let sgId of atomFromStruct.sgs.values()) {\n          actualSgroupId = sgId\n        }\n      }\n      if (\n        atomFromStruct &&\n        FunctionalGroup.isAtomInContractedFunctionalGroup(\n          atomFromStruct,\n          this.sgroups,\n          this.functionalGroups,\n          true\n        )\n      ) {\n        const sgroupAtoms =\n          actualSgroupId !== undefined &&\n          SGroup.getAtoms(\n            this.molecule,\n            this.struct.sgroups.get(actualSgroupId).item\n          )\n        const sgroupBonds =\n          actualSgroupId !== undefined &&\n          SGroup.getBonds(\n            this.molecule,\n            this.struct.sgroups.get(actualSgroupId).item\n          )\n        atom === sgroupAtoms[0] &&\n          newSelected.atoms.push(...sgroupAtoms) &&\n          newSelected.bonds.push(...sgroupBonds)\n      }\n\n      if (atomFromStruct) atomsResult.push(atomId)\n    }\n  }\n  if (selected && this.functionalGroups.size && selected.bonds) {\n    for (let bond of selected.bonds) {\n      const bondId = FunctionalGroup.bondsInFunctionalGroup(\n        this.molecule,\n        this.functionalGroups,\n        bond\n      )\n      if (bondId === null) extraBonds = true\n      const bondFromStruct = bondId !== null && this.struct.bonds.get(bondId).b\n      if (bondFromStruct) bondsResult.push(bondId)\n    }\n  }\n\n  if (atomsResult.length) {\n    atomsResult.forEach(id => {\n      const fgId = FunctionalGroup.findFunctionalGroupByAtom(\n        this.functionalGroups,\n        id\n      )\n      const sgroupAtoms = SGroup.getAtoms(\n        this.molecule,\n        this.struct.sgroups.get(fgId).item\n      )\n      newSelected.atoms.push(...sgroupAtoms)\n    })\n  }\n  if (bondsResult.length) {\n    bondsResult.forEach(id => {\n      const fgId = FunctionalGroup.findFunctionalGroupByBond(\n        this.molecule,\n        this.functionalGroups,\n        id\n      )\n      const sgroupBonds = SGroup.getBonds(\n        this.molecule,\n        this.struct.sgroups.get(fgId).item\n      )\n      newSelected.bonds.push(...sgroupBonds)\n    })\n  }\n  if (extraAtoms || extraBonds) {\n    atomsResult = null\n    bondsResult = null\n  }\n  if (atomsResult && atomsResult.length > 0) {\n    for (let id of atomsResult) {\n      const fgId = FunctionalGroup.findFunctionalGroupByAtom(\n        this.functionalGroups,\n        id\n      )\n      if (fgId !== null && !result.includes(fgId)) {\n        result.push(fgId)\n      }\n    }\n  }\n  if (bondsResult && bondsResult.length > 0) {\n    for (let id of bondsResult) {\n      const fgId = FunctionalGroup.findFunctionalGroupByBond(\n        this.molecule,\n        this.functionalGroups,\n        id\n      )\n      if (fgId !== null && !result.includes(fgId)) {\n        result.push(fgId)\n      }\n    }\n  }\n  if (result.length === 1) {\n    this.editor.selection(null)\n    this.lassoHelper.cancel()\n    this.editor.event.removeFG.dispatch({ fgIds: result })\n    return\n  }\n  var id = null // id of an existing group, if we're editing one\n  var selection = null // atoms to include in a newly created group\n  if (this.lassoHelper.running(event)) {\n    // TODO it catches more events than needed, to be re-factored\n    selection =\n      newSelected.atoms.length > 0\n        ? selMerge(this.lassoHelper.end(event), newSelected)\n        : this.lassoHelper.end(event)\n    this.editor.selection(selection)\n  } else {\n    if (!ci)\n      // ci.type == 'Canvas'\n      return\n    this.editor.hover(null)\n\n    if (ci.map === 'atoms') {\n      // if we click the SGroup tool on a single atom or bond, make a group out of those\n      selection = { atoms: [ci.id] }\n    } else if (ci.map === 'bonds') {\n      var bond = this.editor.render.ctab.bonds.get(ci.id)\n      selection = { atoms: [bond.b.begin, bond.b.end] }\n    } else if (ci.map === 'sgroups' || ci.map === 'sgroupData') {\n      id = ci.id\n    } else {\n      return\n    }\n  }\n\n  // TODO: handle click on an existing group?\n  if (id !== null || (selection && selection.atoms))\n    sgroupDialog(this.editor, id, this.type)\n}\n\nSGroupTool.prototype.cancel = function () {\n  if (this.lassoHelper.running()) this.lassoHelper.end()\n  this.editor.selection(null)\n}\n\nexport function sgroupDialog(editor, id, defaultType) {\n  const restruct = editor.render.ctab\n  const struct = restruct.molecule\n  const selection = editor.selection() || {}\n  const sg = id !== null ? struct.sgroups.get(id) : null\n  const type = sg ? sg.type : defaultType\n  const eventName = type === 'DAT' ? 'sdataEdit' : 'sgroupEdit'\n\n  if (!selection.atoms && !selection.bonds && !sg) {\n    console.info('There is no selection or sgroup')\n    return\n  }\n\n  let attrs = null\n  if (sg) {\n    attrs = sg.getAttrs()\n    attrs.context = getContextBySgroup(restruct, sg.atoms)\n  } else {\n    attrs = {\n      context: getContextBySelection(restruct, selection)\n    }\n  }\n\n  const res = editor.event[eventName].dispatch({\n    type,\n    attrs\n  })\n\n  Promise.resolve(res)\n    .then(newSg => {\n      // TODO: check before signal\n      if (\n        newSg.type !== 'DAT' && // when data s-group separates\n        checkOverlapping(struct, selection.atoms || [])\n      ) {\n        editor.event.message.dispatch({\n          error: 'Partial S-group overlapping is not allowed.'\n        })\n      } else {\n        if (\n          !sg &&\n          newSg.type !== 'DAT' &&\n          (!selection.atoms || selection.atoms.length === 0)\n        )\n          return\n\n        const isDataSg = sg && sg.getAttrs().context === newSg.attrs.context\n\n        if (isDataSg) {\n          const action = fromSeveralSgroupAddition(\n            restruct,\n            newSg.type,\n            sg.atoms,\n            newSg.attrs\n          ).mergeWith(fromSgroupDeletion(restruct, id))\n\n          editor.update(action)\n          editor.selection(selection)\n          return\n        }\n\n        const result = fromContextType(id, editor, newSg, selection)\n        editor.update(result.action)\n        editor.selection(null)\n      }\n    })\n    .catch(() => null)\n}\n\nfunction getContextBySgroup(restruct, sgAtoms) {\n  const struct = restruct.molecule\n\n  if (sgAtoms.length === 1) return SgContexts.Atom\n\n  if (manyComponentsSelected(restruct, sgAtoms)) return SgContexts.Multifragment\n\n  if (singleComponentSelected(restruct, sgAtoms)) return SgContexts.Fragment\n\n  const atomSet = new Pile(sgAtoms)\n\n  const sgBonds = Array.from(struct.bonds.values()).filter(\n    bond => atomSet.has(bond.begin) && atomSet.has(bond.end)\n  )\n\n  return anyChainedBonds(sgBonds) ? SgContexts.Group : SgContexts.Bond\n}\n\nfunction getContextBySelection(restruct, selection) {\n  const struct = restruct.molecule\n\n  if (selection.atoms && !selection.bonds) return SgContexts.Atom\n\n  const bonds = selection.bonds.map(bondid => struct.bonds.get(bondid))\n\n  if (!anyChainedBonds(bonds)) return SgContexts.Bond\n\n  selection.atoms = selection.atoms || []\n\n  const atomSet = new Pile(selection.atoms)\n  const allBondsSelected = bonds.every(\n    bond => atomSet.has(bond.begin) && atomSet.has(bond.end)\n  )\n\n  if (singleComponentSelected(restruct, selection.atoms) && allBondsSelected)\n    return SgContexts.Fragment\n\n  return manyComponentsSelected(restruct, selection.atoms)\n    ? SgContexts.Multifragment\n    : SgContexts.Group\n}\n\nfunction fromContextType(id, editor, newSg, currSelection) {\n  const restruct = editor.render.ctab\n  const sg = restruct.molecule.sgroups.get(id)\n  const sourceAtoms = (sg && sg.atoms) || currSelection.atoms || []\n  const context = newSg.attrs.context\n\n  const result = fromSgroupAction(\n    context,\n    restruct,\n    newSg,\n    sourceAtoms,\n    currSelection\n  )\n\n  result.selection = result.selection || currSelection\n\n  if (id !== null && id !== undefined)\n    result.action = result.action.mergeWith(fromSgroupDeletion(restruct, id))\n\n  editor.selection(result.selection)\n\n  return result\n}\n\nfunction anyChainedBonds(bonds) {\n  if (bonds.length === 0) return true\n\n  for (let i = 0; i < bonds.length; ++i) {\n    const fixedBond = bonds[i]\n    for (let j = 0; j < bonds.length; ++j) {\n      if (i === j) continue\n\n      const bond = bonds[j]\n\n      if (fixedBond.end === bond.begin || fixedBond.end === bond.end)\n        return true\n    }\n  }\n\n  return false\n}\n\nfunction singleComponentSelected(restruct, atoms) {\n  return countOfSelectedComponents(restruct, atoms) === 1\n}\n\nfunction manyComponentsSelected(restruct, atoms) {\n  return countOfSelectedComponents(restruct, atoms) > 1\n}\n\nfunction countOfSelectedComponents(restruct, atoms) {\n  const atomSet = new Pile(atoms)\n\n  return Array.from(restruct.connectedComponents.values()).reduce(\n    (acc, component) => acc + (atomSet.isSuperset(component) ? 1 : 0),\n    0\n  )\n}\n\nexport default SGroupTool\n","/****************************************************************************\n * Copyright 2021 EPAM Systems\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *    http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n ***************************************************************************/\n\nimport {\n  Action,\n  SGroup,\n  fromAtomsAttrs,\n  fromBondsAttrs,\n  fromItemsFuse,\n  fromMultipleMove,\n  fromTextDeletion,\n  fromTextUpdating,\n  getHoverToFuse,\n  getItemsToFuse,\n  FunctionalGroup,\n  fromSimpleObjectResizing,\n  fromArrowResizing\n} from 'ketcher-core'\n\nimport LassoHelper from './helper/lasso'\nimport { atomLongtapEvent } from './atom'\nimport { sgroupDialog } from './sgroup'\nimport utils from '../shared/utils'\nimport { xor } from 'lodash/fp'\nimport { Editor } from '../Editor'\n\nclass SelectTool {\n  #mode: string\n  #lassoHelper: any\n  editor: Editor\n  dragCtx: any\n\n  constructor(editor, mode) {\n    this.editor = editor\n    this.#mode = mode\n    this.#lassoHelper = new LassoHelper(\n      this.#mode === 'lasso' ? 0 : 1,\n      editor,\n      this.#mode === 'fragment'\n    )\n  }\n\n  mousedown(event) {\n    const rnd = this.editor.render\n    const ctab = rnd.ctab\n    const molecule = ctab.molecule\n    const functionalGroups = molecule.functionalGroups\n    const selectedSgroups: any[] = []\n    const newSelected = { atoms: [] as any[], bonds: [] as any[] }\n    let actualSgroupId\n\n    this.editor.hover(null) // TODO review hovering for touch devicess\n\n    const selectFragment = this.#lassoHelper.fragment || event.ctrlKey\n    const ci = this.editor.findItem(\n      event,\n      selectFragment\n        ? [\n            'frags',\n            'sgroups',\n            'functionalGroups',\n            'sgroupData',\n            'rgroups',\n            'rxnArrows',\n            'rxnPluses',\n            'enhancedFlags',\n            'simpleObjects',\n            'texts'\n          ]\n        : [\n            'atoms',\n            'bonds',\n            'sgroups',\n            'functionalGroups',\n            'sgroupData',\n            'rgroups',\n            'rxnArrows',\n            'rxnPluses',\n            'enhancedFlags',\n            'simpleObjects',\n            'texts'\n          ],\n      null\n    )\n\n    if (ci && ci.map === 'atoms' && functionalGroups.size) {\n      const atomId = FunctionalGroup.atomsInFunctionalGroup(\n        functionalGroups,\n        ci.id\n      )\n      const atomFromStruct = atomId !== null && ctab.atoms.get(ci.id)?.a\n\n      if (atomFromStruct) {\n        for (let sgId of atomFromStruct.sgs.values()) {\n          actualSgroupId = sgId\n        }\n      }\n      if (\n        atomFromStruct &&\n        actualSgroupId !== undefined &&\n        !selectedSgroups.includes(actualSgroupId)\n      )\n        selectedSgroups.push(actualSgroupId)\n    }\n    if (ci && ci.map === 'bonds' && functionalGroups.size) {\n      const bondId = FunctionalGroup.bondsInFunctionalGroup(\n        molecule,\n        functionalGroups,\n        ci.id\n      )\n      const sGroupId = FunctionalGroup.findFunctionalGroupByBond(\n        molecule,\n        functionalGroups,\n        bondId\n      )\n      if (sGroupId !== null && !selectedSgroups.includes(sGroupId))\n        selectedSgroups.push(sGroupId)\n    }\n\n    if (selectedSgroups.length) {\n      for (let sgId of selectedSgroups) {\n        const sgroup = ctab.sgroups.get(sgId)\n        if (sgroup) {\n          const sgroupAtoms = SGroup.getAtoms(molecule, sgroup.item)\n          const sgroupBonds = SGroup.getBonds(molecule, sgroup.item)\n          newSelected.atoms.push(...sgroupAtoms) &&\n            newSelected.bonds.push(...sgroupBonds)\n        }\n      }\n      this.editor.selection(newSelected)\n    }\n\n    this.dragCtx = {\n      item: ci,\n      xy0: rnd.page2obj(event)\n    }\n\n    if (!ci || ci.map === 'atoms') {\n      atomLongtapEvent(this, rnd)\n    }\n\n    if (!ci) {\n      //  ci.type == 'Canvas'\n      this.editor.selection(null)\n      delete this.dragCtx.item\n      if (!this.#lassoHelper.fragment) this.#lassoHelper.begin(event)\n      return true\n    }\n\n    let sel = closestToSel(ci)\n    let sgroups = ctab.sgroups.get(ci.id)\n    const selection = this.editor.selection()\n    if (ci.map === 'frags') {\n      const frag = ctab.frags.get(ci.id)\n      sel = {\n        atoms: frag.fragGetAtoms(ctab, ci.id),\n        bonds: frag.fragGetBonds(ctab, ci.id)\n      }\n    } else if (\n      (ci.map === 'sgroups' || ci.map === 'functionalGroups') &&\n      sgroups\n    ) {\n      const sgroup = sgroups.item\n      sel = {\n        atoms: SGroup.getAtoms(molecule, sgroup),\n        bonds: SGroup.getBonds(molecule, sgroup)\n      }\n    } else if (ci.map === 'rgroups') {\n      const rgroup = ctab.rgroups.get(ci.id)\n      sel = {\n        atoms: rgroup.getAtoms(rnd),\n        bonds: rgroup.getBonds(rnd)\n      }\n    } else if (ci.map === 'sgroupData') {\n      if (isSelected(selection, ci)) return true\n    }\n\n    if (!event.shiftKey) {\n      this.editor.selection(isSelected(selection, ci) ? selection : sel)\n    } else {\n      this.editor.selection(selMerge(sel, selection, true))\n    }\n    return true\n  }\n\n  mousemove(event) {\n    const editor = this.editor\n    const rnd = editor.render\n    const restruct = editor.render.ctab\n    const dragCtx = this.dragCtx\n    if (dragCtx && dragCtx.stopTapping) dragCtx.stopTapping()\n    if (dragCtx && dragCtx.item) {\n      const atoms = restruct.molecule.atoms\n      const selection = editor.selection()\n      const shouldDisplayDegree =\n        dragCtx.item.map === 'atoms' &&\n        atoms?.get(dragCtx.item.id)?.neighbors.length === 1 &&\n        selection?.atoms?.length === 1 &&\n        !selection.bonds\n      if (shouldDisplayDegree) {\n        // moving selected objects\n        const pos = rnd.page2obj(event)\n        const angle = utils.calcAngle(dragCtx.xy0, pos)\n        const degrees = utils.degrees(angle)\n        this.editor.event.message.dispatch({ info: degrees + '¬∫' })\n      }\n      if (dragCtx.item.map === 'simpleObjects' && dragCtx.item.ref) {\n        if (dragCtx?.action) dragCtx.action.perform(rnd.ctab)\n        const current = rnd.page2obj(event)\n        const diff = current.sub(this.dragCtx.xy0)\n        dragCtx.action = fromSimpleObjectResizing(\n          rnd.ctab,\n          dragCtx.item.id,\n          diff,\n          current,\n          dragCtx.item.ref,\n          event.shiftKey\n        )\n        editor.update(dragCtx.action, true)\n        return true\n      }\n      if (dragCtx.item.map === 'rxnArrows' && dragCtx.item.ref) {\n        if (dragCtx?.action) dragCtx.action.perform(rnd.ctab)\n        const current = rnd.page2obj(event)\n        const diff = current.sub(dragCtx.xy0)\n        dragCtx.previous = current\n        dragCtx.action = fromArrowResizing(\n          rnd.ctab,\n          dragCtx.item.id,\n          diff,\n          current,\n          dragCtx.item.ref\n        )\n        editor.update(dragCtx.action, true)\n        return true\n      }\n      if (dragCtx.action) {\n        dragCtx.action.perform(restruct)\n        // redraw the elements in unshifted position, lest the have different offset\n        editor.update(dragCtx.action, true)\n      }\n\n      const expSel = editor.explicitSelected()\n      dragCtx.action = fromMultipleMove(\n        restruct,\n        expSel,\n        editor.render.page2obj(event).sub(dragCtx.xy0)\n      )\n\n      dragCtx.mergeItems = getItemsToFuse(editor, expSel)\n      editor.hover(getHoverToFuse(dragCtx.mergeItems))\n\n      editor.update(dragCtx.action, true)\n      return true\n    }\n\n    if (this.#lassoHelper.running()) {\n      const sel = this.#lassoHelper.addPoint(event)\n      editor.selection(\n        !event.shiftKey ? sel : selMerge(sel, editor.selection(), false)\n      )\n      return true\n    }\n\n    const maps =\n      this.#lassoHelper.fragment || event.ctrlKey\n        ? [\n            'frags',\n            'sgroups',\n            'functionalGroups',\n            'sgroupData',\n            'rgroups',\n            'rxnArrows',\n            'rxnPluses',\n            'enhancedFlags',\n            'simpleObjects',\n            'texts'\n          ]\n        : [\n            'atoms',\n            'bonds',\n            'sgroups',\n            'functionalGroups',\n            'sgroupData',\n            'rgroups',\n            'rxnArrows',\n            'rxnPluses',\n            'enhancedFlags',\n            'simpleObjects',\n            'texts'\n          ]\n\n    editor.hover(editor.findItem(event, maps, null))\n\n    return true\n  }\n\n  mouseup(event) {\n    const editor = this.editor\n    const selected = editor.selection()\n    const struct = editor.render.ctab\n    const molecule = struct.molecule\n    const functionalGroups = molecule.functionalGroups\n    const selectedSgroups: any[] = []\n    const newSelected = { atoms: [] as any[], bonds: [] as any[] }\n    let actualSgroupId\n\n    if (selected && functionalGroups.size && selected.atoms) {\n      for (let atom of selected.atoms) {\n        const atomId = FunctionalGroup.atomsInFunctionalGroup(\n          functionalGroups,\n          atom\n        )\n        const atomFromStruct = atomId !== null && struct.atoms.get(atomId)?.a\n\n        if (atomFromStruct) {\n          for (let sgId of atomFromStruct.sgs.values()) {\n            actualSgroupId = sgId\n          }\n        }\n        if (\n          atomFromStruct &&\n          actualSgroupId !== undefined &&\n          !selectedSgroups.includes(actualSgroupId)\n        )\n          selectedSgroups.push(actualSgroupId)\n      }\n    }\n\n    if (selected && functionalGroups.size && selected.bonds) {\n      for (let atom of selected.bonds) {\n        const bondId = FunctionalGroup.bondsInFunctionalGroup(\n          molecule,\n          functionalGroups,\n          atom\n        )\n        const sGroupId = FunctionalGroup.findFunctionalGroupByBond(\n          molecule,\n          functionalGroups,\n          bondId\n        )\n        if (sGroupId !== null && !selectedSgroups.includes(sGroupId))\n          selectedSgroups.push(sGroupId)\n      }\n    }\n\n    if (selectedSgroups.length) {\n      for (let sgId of selectedSgroups) {\n        const sgroup = struct.sgroups.get(sgId)\n        if (sgroup) {\n          const sgroupAtoms = SGroup.getAtoms(molecule, sgroup.item)\n          const sgroupBonds = SGroup.getBonds(molecule, sgroup.item)\n          newSelected.atoms.push(...sgroupAtoms) &&\n            newSelected.bonds.push(...sgroupBonds)\n        }\n      }\n    }\n\n    const dragCtx = this.dragCtx\n\n    if (dragCtx && dragCtx.stopTapping) dragCtx.stopTapping()\n\n    if (dragCtx && dragCtx.item) {\n      dragCtx.action = dragCtx.action\n        ? fromItemsFuse(struct, dragCtx.mergeItems).mergeWith(dragCtx.action)\n        : fromItemsFuse(struct, dragCtx.mergeItems)\n\n      editor.hover(null)\n      if (dragCtx.mergeItems) editor.selection(null)\n      if (dragCtx.action.operations.length !== 0) editor.update(dragCtx.action)\n\n      delete this.dragCtx\n    } else if (this.#lassoHelper.running()) {\n      // TODO it catches more events than needed, to be re-factored\n      const sel =\n        newSelected.atoms.length > 0\n          ? selMerge(this.#lassoHelper.end(), newSelected, false)\n          : this.#lassoHelper.end()\n      editor.selection(\n        !event.shiftKey ? sel : selMerge(sel, editor.selection(), false)\n      )\n    } else if (this.#lassoHelper.fragment) {\n      if (!event.shiftKey) editor.selection(null)\n    }\n    editor.event.message.dispatch({\n      info: false\n    })\n    return true\n  }\n\n  dblclick(event) {\n    const editor = this.editor\n    const struct = editor.render.ctab\n    const { molecule, sgroups } = struct\n    const functionalGroups = molecule.functionalGroups\n    const rnd = editor.render\n    const ci = editor.findItem(\n      event,\n      ['atoms', 'bonds', 'sgroups', 'functionalGroups', 'sgroupData', 'texts'],\n      null\n    )\n\n    const atomResult: any[] = []\n    const bondResult: any[] = []\n    const result: any[] = []\n    if (ci && functionalGroups && ci.map === 'atoms') {\n      const atomId = FunctionalGroup.atomsInFunctionalGroup(\n        functionalGroups,\n        ci.id\n      )\n      const atomFromStruct = atomId !== null && struct.atoms.get(atomId)?.a\n      if (\n        atomId !== null &&\n        !FunctionalGroup.isAtomInContractedFunctionalGroup(\n          // TODO: examine if this code is really needed, seems like its a hack\n          atomFromStruct,\n          sgroups,\n          functionalGroups,\n          true\n        )\n      )\n        atomResult.push(atomId)\n    }\n    if (ci && functionalGroups && ci.map === 'bonds') {\n      const bondId = FunctionalGroup.bondsInFunctionalGroup(\n        molecule,\n        functionalGroups,\n        ci.id\n      )\n      const bondFromStruct = bondId !== null && struct.bonds.get(bondId)?.b\n      if (\n        bondId !== null &&\n        !FunctionalGroup.isBondInContractedFunctionalGroup(\n          // TODO: examine if this code is really needed, seems like its a hack\n          bondFromStruct,\n          sgroups,\n          functionalGroups,\n          true\n        )\n      )\n        bondResult.push(bondId)\n    }\n    if (atomResult.length > 0) {\n      for (let id of atomResult) {\n        const fgId = FunctionalGroup.findFunctionalGroupByAtom(\n          functionalGroups,\n          id\n        )\n        if (fgId !== null && !result.includes(fgId)) {\n          result.push(fgId)\n        }\n      }\n      editor.event.removeFG.dispatch({ fgIds: result })\n      return\n    } else if (bondResult.length > 0) {\n      for (let id of bondResult) {\n        const fgId = FunctionalGroup.findFunctionalGroupByBond(\n          molecule,\n          functionalGroups,\n          id\n        )\n        if (fgId !== null && !result.includes(fgId)) {\n          result.push(fgId)\n        }\n      }\n      this.editor.event.removeFG.dispatch({ fgIds: result })\n      return\n    }\n    if (!ci) return true\n\n    const selection = this.editor.selection()\n\n    if (ci.map === 'atoms') {\n      const action = new Action()\n      var atom = molecule.atoms.get(ci.id)\n      var ra = editor.event.elementEdit.dispatch(atom)\n      if (selection?.atoms) {\n        const selectionAtoms = selection.atoms\n        Promise.resolve(ra)\n          .then(newatom => {\n            // TODO: deep compare to not produce dummy, e.g.\n            // atom.label != attrs.label || !atom.atomList.equals(attrs.atomList)\n            selectionAtoms.forEach(aid => {\n              action.mergeWith(fromAtomsAttrs(struct, aid, newatom, false))\n            })\n            editor.update(action)\n          })\n          .catch(() => null)\n      }\n    } else if (ci.map === 'bonds') {\n      const bond = rnd.ctab.bonds.get(ci.id)?.b\n      const rb = editor.event.bondEdit.dispatch(bond)\n\n      if (selection?.bonds) {\n        const action = new Action()\n        const bondsSelection = selection.bonds\n        Promise.resolve(rb)\n          .then(newbond => {\n            bondsSelection.forEach(bid => {\n              action.mergeWith(fromBondsAttrs(struct, bid, newbond))\n            })\n            editor.update(action)\n          })\n          .catch(() => null) // w/o changes\n      }\n    } else if (\n      (ci.map === 'sgroups' &&\n        !FunctionalGroup.isFunctionalGroup(molecule.sgroups.get(ci.id))) ||\n      ci.map === 'sgroupData'\n    ) {\n      editor.selection(closestToSel(ci))\n      sgroupDialog(editor, ci.id)\n    } else if (ci.map === 'texts') {\n      editor.selection(closestToSel(ci))\n      const text = molecule.texts.get(ci.id)\n      const dialog = editor.event.elementEdit.dispatch({\n        ...text,\n        type: 'text'\n      })\n\n      dialog\n        .then(({ content }) => {\n          if (!content) {\n            editor.update(fromTextDeletion(struct, ci.id))\n          } else if (content !== text?.content) {\n            editor.update(fromTextUpdating(struct, ci.id, content))\n          }\n        })\n        .catch(() => null)\n    }\n    return true\n  }\n\n  mouseleave(_) {\n    if (this.dragCtx && this.dragCtx.stopTapping) this.dragCtx.stopTapping()\n\n    if (this.dragCtx && this.dragCtx.action) {\n      var action = this.dragCtx.action\n      this.editor.update(action)\n    }\n    if (this.#lassoHelper.running())\n      this.editor.selection(this.#lassoHelper.end())\n\n    delete this.dragCtx\n\n    this.editor.hover(null)\n  }\n}\nfunction closestToSel(ci) {\n  const res = {}\n  res[ci.map] = [ci.id]\n  return res\n}\n\n// TODO: deep-merge?\nexport function selMerge(selection, add, reversible: boolean) {\n  if (add) {\n    Object.keys(add).forEach(item => {\n      if (!selection[item]) selection[item] = add[item].slice()\n      else selection[item] = uniqArray(selection[item], add[item], reversible)\n    })\n  }\n  return selection\n}\n\nfunction isSelected(selection, item) {\n  return (\n    selection && selection[item.map] && selection[item.map].includes(item.id)\n  )\n}\n\nfunction uniqArray(dest, add, reversible: boolean) {\n  return add.reduce((_, item) => {\n    if (reversible) dest = xor(dest, [item])\n    else if (!dest.includes(item)) dest.push(item)\n    return dest\n  }, [])\n}\n\nexport default SelectTool\n","/****************************************************************************\n * Copyright 2021 EPAM Systems\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *    http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n ***************************************************************************/\n\nimport {\n  fromArrowDeletion,\n  fromFragmentDeletion,\n  fromOneAtomDeletion,\n  fromOneBondDeletion,\n  fromPlusDeletion,\n  fromSgroupDeletion,\n  fromSimpleObjectDeletion,\n  fromTextDeletion,\n  FunctionalGroup,\n  SGroup\n} from 'ketcher-core'\n\nimport LassoHelper from './helper/lasso'\nimport { selMerge } from './select'\n\nfunction EraserTool(editor, mode) {\n  if (!(this instanceof EraserTool)) {\n    if (!editor.selection()) return new EraserTool(editor, mode)\n\n    const action = fromFragmentDeletion(editor.render.ctab, editor.selection())\n    editor.update(action)\n    editor.selection(null)\n    return null\n  }\n\n  this.editor = editor\n  this.sgroups = editor.render.ctab.sgroups\n  this.struct = editor.render.ctab\n  this.molecule = editor.render.ctab.molecule\n  this.functionalGroups = this.molecule.functionalGroups\n\n  this.maps = [\n    'atoms',\n    'bonds',\n    'rxnArrows',\n    'rxnPluses',\n    'sgroups',\n    'functionalGroups',\n    'sgroupData',\n    'simpleObjects',\n    'texts'\n  ]\n  this.lassoHelper = new LassoHelper(mode || 0, editor)\n}\n\nEraserTool.prototype.mousedown = function (event) {\n  const ci = this.editor.findItem(event, this.maps)\n  if (!ci)\n    //  ci.type == 'Canvas'\n    this.lassoHelper.begin(event)\n}\n\nEraserTool.prototype.mousemove = function (event) {\n  if (this.lassoHelper.running())\n    this.editor.selection(this.lassoHelper.addPoint(event))\n  else this.editor.hover(this.editor.findItem(event, this.maps))\n}\n\nEraserTool.prototype.mouseup = function (event) {\n  const selected = this.editor.selection()\n  let newSelected = { atoms: [], bonds: [] }\n  let actualSgroupId\n  const atomsResult = []\n  const bondsResult = []\n  const preResult = []\n\n  if (selected && this.functionalGroups.size && selected.atoms) {\n    for (let atom of selected.atoms) {\n      const atomId = FunctionalGroup.atomsInFunctionalGroup(\n        this.functionalGroups,\n        atom\n      )\n      const atomFromStruct = atomId !== null && this.struct.atoms.get(atomId).a\n\n      if (atomFromStruct) {\n        for (let sgId of atomFromStruct.sgs.values()) {\n          actualSgroupId = sgId\n        }\n      }\n      if (\n        atomFromStruct &&\n        FunctionalGroup.isAtomInContractedFunctionalGroup(\n          atomFromStruct,\n          this.sgroups,\n          this.functionalGroups,\n          true\n        )\n      ) {\n        const sgroupAtoms =\n          actualSgroupId !== undefined &&\n          SGroup.getAtoms(\n            this.molecule,\n            this.struct.sgroups.get(actualSgroupId).item\n          )\n        const sgroupBonds =\n          actualSgroupId !== undefined &&\n          SGroup.getBonds(\n            this.molecule,\n            this.struct.sgroups.get(actualSgroupId).item\n          )\n        atom === sgroupAtoms[0] &&\n          newSelected.atoms.push(...sgroupAtoms) &&\n          newSelected.bonds.push(...sgroupBonds)\n      }\n\n      if (\n        atomFromStruct &&\n        !FunctionalGroup.isAtomInContractedFunctionalGroup(\n          atomFromStruct,\n          this.sgroups,\n          this.functionalGroups,\n          true\n        )\n      )\n        atomsResult.push(atomId)\n    }\n  }\n  if (selected && this.functionalGroups.size && selected.bonds) {\n    for (let bond of selected.bonds) {\n      const bondId = FunctionalGroup.bondsInFunctionalGroup(\n        this.molecule,\n        this.functionalGroups,\n        bond\n      )\n      const bondFromStruct = bondId !== null && this.struct.bonds.get(bondId).b\n      if (\n        bondFromStruct &&\n        !FunctionalGroup.isBondInContractedFunctionalGroup(\n          bondFromStruct,\n          this.sgroups,\n          this.functionalGroups,\n          true\n        )\n      )\n        bondsResult.push(bondId)\n    }\n  }\n  if (atomsResult.length > 0) {\n    for (let id of atomsResult) {\n      const fgId = FunctionalGroup.findFunctionalGroupByAtom(\n        this.functionalGroups,\n        id\n      )\n      fgId !== null && !preResult.includes(fgId) && preResult.push(fgId)\n    }\n  }\n  if (bondsResult.length > 0) {\n    for (let id of bondsResult) {\n      const fgId = FunctionalGroup.findFunctionalGroupByBond(\n        this.molecule,\n        this.functionalGroups,\n        id\n      )\n      fgId !== null && !preResult.includes(fgId) && preResult.push(fgId)\n    }\n  }\n  if (preResult.length > 0) {\n    const result = []\n    const sgroups = this.sgroups\n    preResult.forEach(fgId => {\n      const sgAtoms = sgroups.get(fgId).item.atoms\n      sgAtoms.forEach(atom => {\n        !atomsResult.includes(atom) &&\n          !result.includes(fgId) &&\n          result.push(fgId)\n      })\n    })\n    if (result.length > 0) {\n      this.editor.selection(null)\n      this.editor.event.removeFG.dispatch({ fgIds: result })\n      this.lassoHelper.cancel()\n    }\n  }\n\n  // eslint-disable-line max-statements\n  const rnd = this.editor.render\n\n  if (this.lassoHelper.running()) {\n    // TODO it catches more events than needed, to be re-factored\n    const sel =\n      newSelected.atoms.length > 0\n        ? selMerge(this.lassoHelper.end(event), newSelected)\n        : this.lassoHelper.end(event)\n    this.editor.update(fromFragmentDeletion(rnd.ctab, sel))\n    this.editor.selection(null)\n  }\n}\n\nEraserTool.prototype.click = function (event) {\n  const rnd = this.editor.render\n  const restruct = this.editor.render.ctab\n  const ci = this.editor.findItem(event, this.maps)\n  const atomResult = []\n  const bondResult = []\n  const result = []\n\n  if (\n    ci &&\n    this.functionalGroups &&\n    ci.map === 'functionalGroups' &&\n    !FunctionalGroup.isContractedFunctionalGroup(ci.id, this.functionalGroups)\n  ) {\n    const sGroup = this.sgroups.get(ci.id)\n    if (FunctionalGroup.isFunctionalGroup(sGroup.item)) {\n      result.push(ci.id)\n    }\n  } else if (ci && this.functionalGroups && ci.map === 'atoms') {\n    const atomId = FunctionalGroup.atomsInFunctionalGroup(\n      this.functionalGroups,\n      ci.id\n    )\n    const atomFromStruct = atomId !== null && this.struct.atoms.get(atomId).a\n    if (\n      atomFromStruct &&\n      !FunctionalGroup.isAtomInContractedFunctionalGroup(\n        atomFromStruct,\n        this.sgroups,\n        this.functionalGroups,\n        true\n      )\n    )\n      atomResult.push(atomId)\n  } else if (ci && this.functionalGroups && ci.map === 'bonds') {\n    const bondId = FunctionalGroup.bondsInFunctionalGroup(\n      this.molecule,\n      this.functionalGroups,\n      ci.id\n    )\n    const bondFromStruct = bondId !== null && this.struct.bonds.get(bondId).b\n    if (\n      bondFromStruct &&\n      !FunctionalGroup.isBondInContractedFunctionalGroup(\n        bondFromStruct,\n        this.sgroups,\n        this.functionalGroups,\n        true\n      )\n    )\n      bondResult.push(bondId)\n  }\n  if (atomResult.length) {\n    for (let id of atomResult) {\n      const fgId = FunctionalGroup.findFunctionalGroupByAtom(\n        this.functionalGroups,\n        id\n      )\n      if (fgId !== null && !result.includes(fgId)) {\n        result.push(fgId)\n      }\n    }\n  } else if (bondResult.length) {\n    for (let id of bondResult) {\n      const fgId = FunctionalGroup.findFunctionalGroupByBond(\n        this.molecule,\n        this.functionalGroups,\n        id\n      )\n      if (fgId !== null && !result.includes(fgId)) {\n        result.push(fgId)\n      }\n    }\n  }\n  if (result.length) {\n    this.editor.event.removeFG.dispatch({ fgIds: result })\n    return\n  }\n\n  if (!ci) return // ci.type == 'Canvas'\n\n  this.editor.hover(null)\n  if (ci.map === 'atoms') {\n    this.editor.update(fromOneAtomDeletion(restruct, ci.id))\n  } else if (ci.map === 'bonds') {\n    this.editor.update(fromOneBondDeletion(restruct, ci.id))\n  } else if (\n    ci.map === 'functionalGroups' &&\n    FunctionalGroup.isContractedFunctionalGroup(ci.id, this.functionalGroups)\n  ) {\n    const sGroup = this.sgroups.get(ci.id)\n    this.editor.update(\n      fromFragmentDeletion(rnd.ctab, {\n        atoms: [...SGroup.getAtoms(this.molecule, sGroup.item)],\n        bonds: [...SGroup.getBonds(this.molecule, sGroup.item)]\n      })\n    )\n  } else if (ci.map === 'sgroups' || ci.map === 'sgroupData') {\n    const sGroup = this.sgroups.get(ci.id)\n    if (FunctionalGroup.isFunctionalGroup(sGroup.item)) {\n      this.editor.event.removeFG.dispatch({ fgIds: [ci.id] })\n    } else {\n      this.editor.update(fromSgroupDeletion(restruct, ci.id))\n    }\n  } else if (ci.map === 'rxnArrows') {\n    this.editor.update(fromArrowDeletion(restruct, ci.id))\n  } else if (ci.map === 'rxnPluses') {\n    this.editor.update(fromPlusDeletion(restruct, ci.id))\n  } else if (ci.map === 'simpleObjects') {\n    this.editor.update(fromSimpleObjectDeletion(restruct, ci.id))\n  } else if (ci.map === 'texts') {\n    this.editor.update(fromTextDeletion(restruct, ci.id))\n  } else {\n    // TODO re-factoring needed - should be \"map-independent\"\n    console.error(\n      'EraserTool: unable to delete the object ' + ci.map + '[' + ci.id + ']'\n    )\n    return\n  }\n  this.editor.selection(null)\n}\n\nEraserTool.prototype.mouseleave = EraserTool.prototype.mouseup\n\nEraserTool.prototype.cancel = function () {\n  if (this.lassoHelper.running()) this.lassoHelper.end()\n  this.editor.selection(null)\n}\n\nexport default EraserTool\n","/****************************************************************************\n * Copyright 2021 EPAM Systems\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *    http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n ***************************************************************************/\n\nimport {\n  fromItemsFuse,\n  fromPaste,\n  FunctionalGroup,\n  getHoverToFuse,\n  getItemsToFuse\n} from 'ketcher-core'\n\nfunction PasteTool(editor, struct) {\n  if (!(this instanceof PasteTool)) return new PasteTool(editor, struct)\n\n  this.editor = editor\n  this.editor.selection(null)\n  this.struct = struct\n  this.sgroups = editor.render.ctab.sgroups\n  this.molecule = editor.render.ctab.molecule\n  this.functionalGroups = this.molecule.functionalGroups\n\n  const rnd = editor.render\n  const { clientHeight, clientWidth } = rnd.clientArea\n  const point = editor.lastEvent\n    ? rnd.page2obj(editor.lastEvent)\n    : rnd.page2obj({ pageX: clientWidth / 2, pageY: clientHeight / 2 })\n\n  const [action, pasteItems] = fromPaste(rnd.ctab, this.struct, point)\n  this.action = action\n  this.editor.update(this.action, true)\n\n  this.mergeItems = getItemsToFuse(this.editor, pasteItems)\n  this.editor.hover(getHoverToFuse(this.mergeItems), this)\n}\n\nPasteTool.prototype.mousemove = function (event) {\n  const rnd = this.editor.render\n\n  if (this.action) this.action.perform(rnd.ctab)\n\n  const [action, pasteItems] = fromPaste(\n    rnd.ctab,\n    this.struct,\n    rnd.page2obj(event)\n  )\n  this.action = action\n  this.editor.update(this.action, true)\n\n  this.mergeItems = getItemsToFuse(this.editor, pasteItems)\n  this.editor.hover(getHoverToFuse(this.mergeItems))\n}\n\nPasteTool.prototype.mouseup = function () {\n  const atomsResult = []\n  const bondsResult = []\n  const result = []\n  if (\n    this.mergeItems &&\n    this.functionalGroups.size &&\n    this.mergeItems.atoms.size\n  ) {\n    for (let id of this.mergeItems.atoms.values()) {\n      const atomId = FunctionalGroup.atomsInFunctionalGroup(\n        this.functionalGroups,\n        id\n      )\n      if (atomId !== null) atomsResult.push(atomId)\n    }\n  }\n  if (\n    this.mergeItems &&\n    this.functionalGroups.size &&\n    this.mergeItems.bonds.size\n  ) {\n    for (let id of this.mergeItems.bonds.values()) {\n      const bondId = FunctionalGroup.atomsInFunctionalGroup(\n        this.functionalGroups,\n        id\n      )\n      if (bondId !== null) bondsResult.push(bondId)\n    }\n  }\n  if (atomsResult.length > 0) {\n    for (let id of atomsResult) {\n      const fgId = FunctionalGroup.findFunctionalGroupByAtom(\n        this.functionalGroups,\n        id\n      )\n      if (fgId !== null && !result.includes(fgId)) {\n        result.push(fgId)\n      }\n    }\n    this.editor.event.removeFG.dispatch({ fgIds: result })\n    return\n  } else if (bondsResult.length > 0) {\n    for (let id of bondsResult) {\n      const fgId = FunctionalGroup.findFunctionalGroupByBond(\n        this.molecule,\n        this.functionalGroups,\n        id\n      )\n      if (fgId !== null && !result.includes(fgId)) {\n        result.push(fgId)\n      }\n    }\n    this.editor.event.removeFG.dispatch({ fgIds: result })\n    return\n  }\n  const editor = this.editor\n  const restruct = editor.render.ctab\n\n  editor.selection(null)\n\n  this.action = this.action\n    ? fromItemsFuse(restruct, this.mergeItems).mergeWith(this.action)\n    : fromItemsFuse(restruct, this.mergeItems)\n\n  editor.hover(null)\n\n  if (this.action) {\n    const action = this.action\n    delete this.action\n    this.editor.update(action)\n  }\n}\n\nPasteTool.prototype.cancel = function () {\n  const rnd = this.editor.render\n  this.editor.hover(null)\n  if (this.action) {\n    this.action.perform(rnd.ctab) // revert the action\n    delete this.action\n    rnd.update()\n  }\n}\nPasteTool.prototype.mouseleave = PasteTool.prototype.cancel\n\nexport default PasteTool\n","/****************************************************************************\n * Copyright 2021 EPAM Systems\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *    http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n ***************************************************************************/\n\nimport {\n  Atom,\n  fromAtomAddition,\n  fromAtomsAttrs,\n  FunctionalGroup\n} from 'ketcher-core'\n\nfunction RGroupAtomTool(editor) {\n  if (!(this instanceof RGroupAtomTool)) {\n    // TODO: map atoms with labels\n    editor.selection(null)\n    return new RGroupAtomTool(editor)\n  }\n\n  this.editor = editor\n  this.struct = editor.render.ctab\n  this.sgroups = editor.render.ctab.sgroups\n  this.functionalGroups = editor.render.ctab.molecule.functionalGroups\n}\n\nRGroupAtomTool.prototype.mousemove = function (event) {\n  const struct = this.editor.render.ctab.molecule\n  const ci = this.editor.findItem(event, ['atoms'])\n  if (ci) {\n    const atom = struct.atoms.get(ci.id)\n    if (atom.attpnt === null) this.editor.hover(ci)\n  } else {\n    this.editor.hover(null)\n  }\n}\n\nRGroupAtomTool.prototype.click = function (event) {\n  const rnd = this.editor.render\n  const ci = this.editor.findItem(event, ['atoms'])\n  const atomResult = []\n  const result = []\n  if (ci && this.functionalGroups && ci.map === 'atoms') {\n    const atomId = FunctionalGroup.atomsInFunctionalGroup(\n      this.functionalGroups,\n      ci.id\n    )\n    if (atomId !== null) atomResult.push(atomId)\n  }\n  if (atomResult.length > 0) {\n    for (let id of atomResult) {\n      const fgId = FunctionalGroup.findFunctionalGroupByAtom(\n        this.functionalGroups,\n        id\n      )\n      if (fgId !== null && !result.includes(fgId)) {\n        result.push(fgId)\n      }\n    }\n    this.editor.event.removeFG.dispatch({ fgIds: result })\n    return\n  }\n\n  if (!ci) {\n    //  ci.type == 'Canvas'\n    this.editor.hover(null)\n    propsDialog(this.editor, null, rnd.page2obj(event))\n    return true\n  } else if (ci.map === 'atoms') {\n    this.editor.hover(null)\n    const struct = this.editor.render.ctab.molecule\n    const atom = struct.atoms.get(ci.id)\n    if (atom.attpnt !== null) return\n    propsDialog(this.editor, ci.id)\n    return true\n  }\n  return true\n}\n\nfunction propsDialog(editor, id, pos) {\n  const struct = editor.render.ctab.molecule\n  const atom = id || id === 0 ? struct.atoms.get(id) : null\n  const rglabel = atom ? atom.rglabel : 0\n  const label = atom ? atom.label : 'R#'\n\n  const res = editor.event.elementEdit.dispatch({\n    label: 'R#',\n    rglabel,\n    fragId: atom ? atom.fragment : null\n  })\n\n  Promise.resolve(res)\n    .then(elem => {\n      // TODO review: using Atom.attrlist as a source of default property values\n      elem = Object.assign({}, Atom.attrlist, elem)\n\n      if (!id && id !== 0 && elem.rglabel) {\n        editor.update(fromAtomAddition(editor.render.ctab, pos, elem))\n      } else if (rglabel !== elem.rglabel) {\n        elem.aam = atom.aam // WTF??\n        elem.attpnt = atom.attpnt\n\n        if (!elem.rglabel && label !== 'R#') elem.label = label\n\n        editor.update(fromAtomsAttrs(editor.render.ctab, id, elem))\n      }\n    })\n    .catch(() => null) // w/o changes\n}\n\nexport default RGroupAtomTool\n","/****************************************************************************\n * Copyright 2021 EPAM Systems\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *    http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n ***************************************************************************/\n\nimport {\n  RGroup,\n  fromRGroupAttrs,\n  fromRGroupFragment,\n  fromUpdateIfThen,\n  FunctionalGroup\n} from 'ketcher-core'\n\nfunction RGroupFragmentTool(editor) {\n  if (!(this instanceof RGroupFragmentTool)) {\n    // TODO: check if it's a fragments already\n    editor.selection(null)\n    return new RGroupFragmentTool(editor)\n  }\n\n  this.editor = editor\n  this.struct = editor.render.ctab\n  this.sgroups = editor.render.ctab.sgroups\n  this.molecule = editor.render.ctab.molecule\n  this.functionalGroups = this.molecule.functionalGroups\n}\n\nRGroupFragmentTool.prototype.mousemove = function (event) {\n  this.editor.hover(this.editor.findItem(event, ['frags', 'rgroups']))\n}\n\nRGroupFragmentTool.prototype.click = function (event) {\n  const editor = this.editor\n  const struct = editor.render.ctab.molecule\n  const ci = editor.findItem(event, ['frags', 'rgroups'])\n  const ce = editor.findItem(event, ['atoms', 'bonds'])\n  const atomResult = []\n  const bondResult = []\n  const result = []\n  if (ce && this.functionalGroups && ce.map === 'atoms') {\n    const atomId = FunctionalGroup.atomsInFunctionalGroup(\n      this.functionalGroups,\n      ce.id\n    )\n    if (atomId !== null) atomResult.push(atomId)\n  }\n  if (ce && this.functionalGroups && ce.map === 'bonds') {\n    const bondId = FunctionalGroup.bondsInFunctionalGroup(\n      this.molecule,\n      this.functionalGroups,\n      ce.id\n    )\n    if (bondId !== null) bondResult.push(bondId)\n  }\n  if (atomResult.length > 0) {\n    for (let id of atomResult) {\n      const fgId = FunctionalGroup.findFunctionalGroupByAtom(\n        this.functionalGroups,\n        id\n      )\n      if (fgId !== null && !result.includes(fgId)) {\n        result.push(fgId)\n      }\n    }\n    this.editor.event.removeFG.dispatch({ fgIds: result })\n    return\n  } else if (bondResult.length > 0) {\n    for (let id of bondResult) {\n      const fgId = FunctionalGroup.findFunctionalGroupByBond(\n        this.molecule,\n        this.functionalGroups,\n        id\n      )\n      if (fgId !== null && !result.includes(fgId)) {\n        result.push(fgId)\n      }\n    }\n    this.editor.event.removeFG.dispatch({ fgIds: result })\n    return\n  }\n\n  if (!ci) return true\n\n  this.editor.hover(null)\n\n  const label =\n    ci.map === 'rgroups'\n      ? ci.id\n      : RGroup.findRGroupByFragment(struct.rgroups, ci.id)\n\n  const rg = Object.assign(\n    { label },\n    ci.map === 'frags' ? { fragId: ci.id } : struct.rgroups.get(ci.id)\n  )\n\n  const res = editor.event.rgroupEdit.dispatch(rg)\n\n  Promise.resolve(res)\n    .then(newRg => {\n      const restruct = editor.render.ctab\n\n      let action = null\n      if (ci.map !== 'rgroups') {\n        const rgidOld = RGroup.findRGroupByFragment(\n          restruct.molecule.rgroups,\n          ci.id\n        )\n\n        action = fromRGroupFragment(restruct, newRg.label, ci.id).mergeWith(\n          fromUpdateIfThen(restruct, newRg.label, rgidOld)\n        )\n      } else {\n        action = fromRGroupAttrs(restruct, ci.id, newRg)\n      }\n\n      editor.update(action)\n    })\n    .catch(() => null) // w/o changes\n\n  return true\n}\n\nRGroupFragmentTool.prototype.cancel = function () {\n  this.editor.hover(null)\n}\n\nexport default RGroupFragmentTool\n","/****************************************************************************\n * Copyright 2021 EPAM Systems\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *    http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n ***************************************************************************/\n\nimport {\n  Vec2,\n  fromArrowAddition,\n  fromArrowDeletion,\n  fromArrowResizing,\n  fromMultipleMove\n} from 'ketcher-core'\n\nfunction ReactionArrowTool(editor, mode) {\n  if (!(this instanceof ReactionArrowTool))\n    return new ReactionArrowTool(editor, mode)\n\n  this.mode = mode\n  this.editor = editor\n  this.editor.selection(null)\n}\n\nReactionArrowTool.prototype.mousedown = function (event) {\n  var rnd = this.editor.render\n  const p0 = rnd.page2obj(event)\n  this.dragCtx = { p0 }\n\n  var ci = this.editor.findItem(event, ['rxnArrows'])\n  if (ci && ci.map === 'rxnArrows') {\n    this.editor.hover(null)\n    this.editor.selection({ rxnArrows: [ci.id] })\n    this.dragCtx.ci = ci\n  } else {\n    this.dragCtx.isNew = true\n    this.editor.selection(null)\n  }\n}\n\nReactionArrowTool.prototype.mousemove = function (event) {\n  var rnd = this.editor.render\n  if (this.dragCtx) {\n    const current = rnd.page2obj(event)\n    const diff = current.sub(this.dragCtx.p0)\n    this.dragCtx.previous = current\n    if (this.dragCtx.ci) {\n      if (this.dragCtx.action) this.dragCtx.action.perform(rnd.ctab)\n      if (!this.dragCtx.ci.ref) {\n        this.dragCtx.action = fromMultipleMove(\n          rnd.ctab,\n          this.editor.selection() || {},\n          diff\n        )\n      } else {\n        this.dragCtx.action = fromArrowResizing(\n          rnd.ctab,\n          this.dragCtx.ci.id,\n          diff,\n          current,\n          this.dragCtx.ci.ref\n        )\n      }\n      this.editor.update(this.dragCtx.action, true)\n    } else {\n      if (!this.dragCtx.action) {\n        const action = fromArrowAddition(\n          rnd.ctab,\n          [this.dragCtx.p0, this.dragCtx.p0],\n          this.mode\n        )\n        //TODO: need to rework  actions/operations logic\n        const addOperation = action.operations[0]\n        const itemId = addOperation.data.id\n        this.dragCtx.itemId = itemId\n        this.dragCtx.action = action\n        this.editor.update(this.dragCtx.action, true)\n      } else {\n        this.dragCtx.action.perform(rnd.ctab)\n      }\n\n      this.dragCtx.action = fromArrowResizing(\n        rnd.ctab,\n        this.dragCtx.itemId,\n        diff,\n        current,\n        null\n      )\n      this.editor.update(this.dragCtx.action, true)\n    }\n  } else {\n    const items = this.editor.findItem(event, ['rxnArrows'])\n    this.editor.hover(items)\n  }\n}\n\nReactionArrowTool.prototype.mouseup = function (event) {\n  if (!this.dragCtx) return true\n  const rnd = this.editor.render\n\n  const p0 = this.dragCtx.p0\n  const p1 = getDefaultLengthPos(p0, this.dragCtx.previous)\n\n  if (this.dragCtx.action) {\n    if (this.dragCtx.isNew) {\n      this.editor.update(fromArrowDeletion(rnd.ctab, this.dragCtx.itemId), true)\n      this.dragCtx.action = fromArrowAddition(rnd.ctab, [p0, p1], this.mode)\n    }\n    this.editor.update(this.dragCtx.action)\n  }\n  delete this.dragCtx\n  return true\n}\n\nReactionArrowTool.prototype.click = function (event) {\n  const rnd = this.editor.render\n  const ci = this.editor.findItem(event, ['rxnArrows'])\n  const p0 = rnd.page2obj(event)\n  if (!ci) {\n    this.editor.update(\n      fromArrowAddition(rnd.ctab, [p0, getDefaultLengthPos(p0)], this.mode)\n    )\n  }\n}\n\nfunction getArrowParams(x1, y1, x2, y2) {\n  const length = Math.sqrt((x2 - x1) ** 2 + (y2 - y1) ** 2)\n  const angle = calcAngle(x2, y2, x1, y1)\n  return { length, angle }\n}\n\nfunction getDefaultLengthPos(pos1, pos2) {\n  const minLength = 1.5\n  const defaultLength = 2\n  if (!pos2) {\n    return new Vec2(pos1.x + defaultLength, pos1.y)\n  }\n  const arrowParams = getArrowParams(pos1.x, pos1.y, pos2.x, pos2.y)\n  if (arrowParams.length <= minLength) {\n    const newPos = new Vec2()\n    newPos.x =\n      pos1.x + defaultLength * Math.cos((Math.PI * arrowParams.angle) / 180)\n    newPos.y =\n      pos1.y + defaultLength * Math.sin((Math.PI * arrowParams.angle) / 180)\n    return newPos\n  }\n  return pos2\n}\n\nfunction calcAngle(x1, y1, x2, y2) {\n  const x = x1 - x2,\n    y = y1 - y2\n  if (!x && !y) {\n    return 0\n  }\n  return (180 + (Math.atan2(-y, -x) * 180) / Math.PI + 360) % 360\n}\n\nexport default ReactionArrowTool\n","/****************************************************************************\n * Copyright 2021 EPAM Systems\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *    http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n ***************************************************************************/\n\nimport { Action, Scale, fromAtomsAttrs } from 'ketcher-core'\n\nfunction ReactionMapTool(editor) {\n  if (!(this instanceof ReactionMapTool)) return new ReactionMapTool(editor)\n\n  this.editor = editor\n  this.editor.selection(null)\n}\n\nReactionMapTool.prototype.mousedown = function (event) {\n  const rnd = this.editor.render\n  this.rcs = rnd.ctab.molecule.getComponents()\n\n  const ci = this.editor.findItem(event, ['atoms'])\n  if (ci && ci.map === 'atoms') {\n    this.editor.hover(null)\n    this.dragCtx = {\n      item: ci,\n      xy0: rnd.page2obj(event)\n    }\n  }\n}\nReactionMapTool.prototype.mousemove = function (event) {\n  var rnd = this.editor.render\n  if ('dragCtx' in this) {\n    var ci = this.editor.findItem(event, ['atoms'], this.dragCtx.item)\n    var atoms = rnd.ctab.molecule.atoms\n    if (\n      ci &&\n      ci.map === 'atoms' &&\n      isValidMap(this.rcs, this.dragCtx.item.id, ci.id)\n    ) {\n      this.editor.hover(ci)\n      this.updateLine(atoms.get(this.dragCtx.item.id).pp, atoms.get(ci.id).pp)\n    } else {\n      this.editor.hover(null)\n      this.updateLine(atoms.get(this.dragCtx.item.id).pp, rnd.page2obj(event))\n    }\n  } else {\n    this.editor.hover(this.editor.findItem(event, ['atoms']))\n  }\n}\n\nReactionMapTool.prototype.updateLine = function (p1, p2) {\n  if (this.line) {\n    this.line.remove()\n    this.line = null\n  }\n  if (p1 && p2) {\n    var rnd = this.editor.render\n    this.line = rnd.selectionLine(\n      Scale.obj2scaled(p1, rnd.options).add(rnd.options.offset),\n      Scale.obj2scaled(p2, rnd.options).add(rnd.options.offset)\n    )\n  }\n}\n\nReactionMapTool.prototype.mouseup = function (event) {\n  // eslint-disable-line max-statements\n  if ('dragCtx' in this) {\n    var rnd = this.editor.render\n    var ci = this.editor.findItem(event, ['atoms'], this.dragCtx.item)\n    if (\n      ci &&\n      ci.map === 'atoms' &&\n      isValidMap(this.rcs, this.dragCtx.item.id, ci.id)\n    ) {\n      var action = new Action()\n      var atoms = rnd.ctab.molecule.atoms\n      var atom1 = atoms.get(this.dragCtx.item.id)\n      var atom2 = atoms.get(ci.id)\n      var aam1 = atom1.aam\n      var aam2 = atom2.aam\n      if (!aam1 || aam1 !== aam2) {\n        if ((aam1 && aam1 !== aam2) || (!aam1 && aam2)) {\n          // eslint-disable-line no-mixed-operators\n          atoms.forEach((atom, aid) => {\n            if (\n              aid !== this.dragCtx.item.id &&\n              ((aam1 && atom.aam === aam1) || (aam2 && atom.aam === aam2))\n            )\n              action.mergeWith(fromAtomsAttrs(rnd.ctab, aid, { aam: 0 }))\n          })\n        }\n        if (aam1) {\n          action.mergeWith(fromAtomsAttrs(rnd.ctab, ci.id, { aam: aam1 }))\n        } else {\n          var aam = 0\n          atoms.forEach(atom => {\n            aam = Math.max(aam, atom.aam || 0)\n          })\n          action.mergeWith(\n            fromAtomsAttrs(rnd.ctab, this.dragCtx.item.id, { aam: aam + 1 })\n          )\n          action.mergeWith(fromAtomsAttrs(rnd.ctab, ci.id, { aam: aam + 1 }))\n        }\n        this.editor.update(action)\n      }\n    }\n    this.updateLine(null)\n    delete this.dragCtx\n  }\n  this.editor.hover(null)\n}\n\nfunction isValidMap(rcs, aid1, aid2) {\n  var t1\n  var t2\n  for (var ri = 0; (!t1 || !t2) && ri < rcs.reactants.length; ri++) {\n    var ro = Array.from(rcs.reactants[ri])\n    if (!t1 && ro.indexOf(aid1) >= 0) t1 = 'r'\n    if (!t2 && ro.indexOf(aid2) >= 0) t2 = 'r'\n  }\n  for (var pi = 0; (!t1 || !t2) && pi < rcs.products.length; pi++) {\n    var po = Array.from(rcs.products[pi])\n    if (!t1 && po.indexOf(aid1) >= 0) t1 = 'p'\n    if (!t2 && po.indexOf(aid2) >= 0) t2 = 'p'\n  }\n  return t1 && t2 && t1 !== t2\n}\n\nexport default ReactionMapTool\n","/****************************************************************************\n * Copyright 2021 EPAM Systems\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *    http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n ***************************************************************************/\n\nimport { fromMultipleMove, fromPlusAddition } from 'ketcher-core'\n\nfunction ReactionPlusTool(editor) {\n  if (!(this instanceof ReactionPlusTool)) return new ReactionPlusTool(editor)\n\n  this.editor = editor\n  this.editor.selection(null)\n}\n\nReactionPlusTool.prototype.mousedown = function (event) {\n  var rnd = this.editor.render\n  var ci = this.editor.findItem(event, ['rxnPluses'])\n  if (ci && ci.map === 'rxnPluses') {\n    this.editor.hover(null)\n    this.editor.selection({ rxnPluses: [ci.id] })\n    this.dragCtx = { xy0: rnd.page2obj(event) }\n  }\n}\n\nReactionPlusTool.prototype.mousemove = function (event) {\n  var rnd = this.editor.render\n  if ('dragCtx' in this) {\n    if (this.dragCtx.action) this.dragCtx.action.perform(rnd.ctab)\n    this.dragCtx.action = fromMultipleMove(\n      rnd.ctab,\n      this.editor.selection() || {},\n      rnd.page2obj(event).sub(this.dragCtx.xy0)\n    )\n    this.editor.update(this.dragCtx.action, true)\n  } else {\n    this.editor.hover(this.editor.findItem(event, ['rxnPluses']))\n  }\n}\n\nReactionPlusTool.prototype.mouseup = function () {\n  if (!this.dragCtx) return true\n\n  if (this.dragCtx.action) {\n    this.editor.update(this.dragCtx.action) // TODO investigate, subsequent undo/redo fails\n  }\n\n  delete this.dragCtx\n  return true\n}\n\nReactionPlusTool.prototype.click = function (event) {\n  const rnd = this.editor.render\n  const ci = this.editor.findItem(event, ['rxnPluses'])\n  if (!ci) {\n    this.editor.update(fromPlusAddition(rnd.ctab, rnd.page2obj(event)))\n  }\n}\n\nexport default ReactionPlusTool\n","/****************************************************************************\n * Copyright 2021 EPAM Systems\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *    http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n ***************************************************************************/\n\nimport { Action, fromAtomsAttrs } from 'ketcher-core'\n\nfunction ReactionUnmapTool(editor) {\n  if (!(this instanceof ReactionUnmapTool)) return new ReactionUnmapTool(editor)\n\n  this.editor = editor\n  this.editor.selection(null)\n}\nReactionUnmapTool.prototype.mousemove = function (event) {\n  var ci = this.editor.findItem(event, ['atoms'])\n  if (ci && ci.map === 'atoms')\n    this.editor.hover(\n      this.editor.render.ctab.molecule.atoms.get(ci.id).aam ? ci : null\n    )\n  else this.editor.hover(null)\n}\nReactionUnmapTool.prototype.mouseup = function (event) {\n  var ci = this.editor.findItem(event, ['atoms'])\n  var atoms = this.editor.render.ctab.molecule.atoms\n  if (ci && ci.map === 'atoms' && atoms.get(ci.id).aam) {\n    var action = new Action()\n    var aam = atoms.get(ci.id).aam\n    atoms.forEach((atom, aid) => {\n      if (atom.aam === aam)\n        action.mergeWith(\n          fromAtomsAttrs(this.editor.render.ctab, aid, { aam: 0 })\n        )\n    })\n    this.editor.update(action)\n  }\n  this.editor.hover(null)\n}\n\nexport default ReactionUnmapTool\n","/****************************************************************************\n * Copyright 2021 EPAM Systems\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *    http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n ***************************************************************************/\n\nimport {\n  Vec2,\n  fromBondAlign,\n  fromFlip,\n  fromItemsFuse,\n  fromRotate,\n  getHoverToFuse,\n  getItemsToFuse\n} from 'ketcher-core'\n\nimport utils from '../shared/utils'\n\nfunction RotateTool(editor, dir) {\n  if (!(this instanceof RotateTool)) {\n    if (!dir) return new RotateTool(editor)\n\n    const restruct = editor.render.ctab\n    const selection = editor.selection()\n    const singleBond =\n      selection &&\n      selection.bonds &&\n      Object.keys(selection).length === 1 &&\n      selection.bonds.length === 1\n    const action = !singleBond\n      ? fromFlip(restruct, selection, dir)\n      : fromBondAlign(restruct, selection.bonds[0], dir)\n    editor.update(action)\n    return null\n  }\n\n  this.editor = editor\n\n  if (!editor.selection() || !editor.selection().atoms)\n    // otherwise, clear selection\n    this.editor.selection(null)\n}\n\nRotateTool.prototype.mousedown = function (event) {\n  var xy0 = new Vec2()\n  var selection = this.editor.selection()\n  var rnd = this.editor.render\n  var struct = rnd.ctab.molecule\n\n  if (selection && selection.atoms) {\n    var rotId = null\n    var rotAll = false\n\n    selection.atoms.forEach(aid => {\n      var atom = struct.atoms.get(aid)\n\n      xy0.add_(atom.pp) // eslint-disable-line no-underscore-dangle\n\n      if (rotAll) return\n\n      atom.neighbors.find(nei => {\n        var hb = struct.halfBonds.get(nei)\n\n        if (selection.atoms.indexOf(hb.end) === -1) {\n          if (hb.loop >= 0) {\n            var neiAtom = struct.atoms.get(aid)\n            if (\n              !neiAtom.neighbors.find(neiNei => {\n                var neiHb = struct.halfBonds.get(neiNei)\n                return (\n                  neiHb.loop >= 0 && selection.atoms.indexOf(neiHb.end) !== -1\n                )\n              })\n            ) {\n              rotAll = true\n              return true\n            }\n          }\n          if (rotId == null) {\n            rotId = aid\n          } else if (rotId !== aid) {\n            rotAll = true\n            return true\n          }\n        }\n        return false\n      })\n    })\n\n    if (!rotAll && rotId !== null) xy0 = struct.atoms.get(rotId).pp\n    else xy0 = xy0.scaled(1 / selection.atoms.length)\n  } else if (struct.atoms?.size) {\n    struct.atoms.forEach(atom => {\n      xy0.add_(atom.pp)\n    }) // eslint-disable-line no-underscore-dangle, max-len\n    // poor man struct center (without sdata, etc)\n    xy0 = xy0.scaled(1 / struct.atoms.size)\n  } else {\n    xy0 = rnd.page2obj(event)\n  }\n  this.dragCtx = {\n    xy0,\n    angle1: utils.calcAngle(xy0, rnd.page2obj(event))\n  }\n  return true\n}\n\nRotateTool.prototype.mousemove = function (event) {\n  // eslint-disable-line max-statements\n  if (!this.dragCtx) return true\n\n  const rnd = this.editor.render\n  const dragCtx = this.dragCtx\n\n  const pos = rnd.page2obj(event)\n  let angle = utils.calcAngle(dragCtx.xy0, pos) - dragCtx.angle1\n  if (!event.ctrlKey) angle = utils.fracAngle(angle)\n\n  const degrees = utils.degrees(angle)\n\n  if ('angle' in dragCtx && dragCtx.angle === degrees) return true\n  if ('action' in dragCtx) dragCtx.action.perform(rnd.ctab)\n\n  dragCtx.angle = degrees\n  dragCtx.action = fromRotate(\n    rnd.ctab,\n    this.editor.selection(),\n    dragCtx.xy0,\n    angle\n  )\n\n  this.editor.event.message.dispatch({ info: degrees + '¬∫' })\n\n  const expSel = this.editor.explicitSelected()\n  dragCtx.mergeItems = getItemsToFuse(this.editor, expSel)\n  this.editor.hover(getHoverToFuse(dragCtx.mergeItems))\n\n  this.editor.update(dragCtx.action, true)\n  return true\n}\n\nRotateTool.prototype.mouseup = function () {\n  if (!this.dragCtx) return true\n  const dragCtx = this.dragCtx\n  const restruct = this.editor.render.ctab\n\n  const action = dragCtx.action\n    ? fromItemsFuse(restruct, dragCtx.mergeItems).mergeWith(dragCtx.action)\n    : fromItemsFuse(restruct, dragCtx.mergeItems)\n  delete this.dragCtx\n\n  this.editor.update(action)\n  this.editor.hover(null)\n  if (dragCtx.mergeItems) this.editor.selection(null)\n  this.editor.event.message.dispatch({\n    info: false\n  })\n  return true\n}\n\nRotateTool.prototype.cancel = RotateTool.prototype.mouseup\nRotateTool.prototype.mouseleave = RotateTool.prototype.mouseup\n\nexport default RotateTool\n","/****************************************************************************\n * Copyright 2021 EPAM Systems\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *    http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n ***************************************************************************/\n\nimport {\n  fromMultipleMove,\n  fromSimpleObjectAddition,\n  fromSimpleObjectDeletion,\n  fromSimpleObjectResizing\n} from 'ketcher-core'\n\nfunction SimpleObjectTool(editor, mode) {\n  if (!(this instanceof SimpleObjectTool))\n    return new SimpleObjectTool(editor, mode)\n\n  this.mode = mode\n  this.editor = editor\n  this.editor.selection(null)\n}\n\nSimpleObjectTool.prototype.mousedown = function (event) {\n  var rnd = this.editor.render\n  const p0 = rnd.page2obj(event)\n  this.dragCtx = { p0 }\n\n  var ci = this.editor.findItem(event, ['simpleObjects'])\n  if (ci && ci.map === 'simpleObjects') {\n    this.editor.hover(null)\n    this.editor.selection({ simpleObjects: [ci.id] })\n    this.dragCtx.ci = ci\n  } else {\n    this.dragCtx.isNew = true\n    this.editor.selection(null)\n  }\n}\n\nSimpleObjectTool.prototype.mousemove = function (event) {\n  var rnd = this.editor.render\n  if (this.dragCtx) {\n    const current = rnd.page2obj(event)\n    const diff = current.sub(this.dragCtx.p0)\n    this.dragCtx.previous = current\n    if (this.dragCtx.ci) {\n      if (this.dragCtx.action) this.dragCtx.action.perform(rnd.ctab)\n      if (!this.dragCtx.ci.ref) {\n        this.dragCtx.action = fromMultipleMove(\n          rnd.ctab,\n          this.editor.selection() || {},\n          diff\n        )\n      } else {\n        this.dragCtx.action = fromSimpleObjectResizing(\n          rnd.ctab,\n          this.dragCtx.ci.id,\n          diff,\n          current,\n          this.dragCtx.ci.ref,\n          event.shiftKey\n        )\n      }\n      this.editor.update(this.dragCtx.action, true)\n    } else {\n      if (!this.dragCtx.action) {\n        const action = fromSimpleObjectAddition(\n          rnd.ctab,\n          [this.dragCtx.p0, this.dragCtx.p0],\n          this.mode\n        )\n        //TODO: need to rework  actions/operations logic\n        const addOperation = action.operations[0]\n        const itemId = addOperation.data.id\n        this.dragCtx.itemId = itemId\n        this.dragCtx.action = action\n        this.editor.update(this.dragCtx.action, true)\n      } else {\n        this.dragCtx.action.perform(rnd.ctab)\n      }\n\n      this.dragCtx.action = fromSimpleObjectResizing(\n        rnd.ctab,\n        this.dragCtx.itemId,\n        diff,\n        current,\n        null,\n        event.shiftKey\n      )\n      this.editor.update(this.dragCtx.action, true)\n    }\n  } else {\n    const items = this.editor.findItem(event, ['simpleObjects'])\n    this.editor.hover(items)\n  }\n}\n\nSimpleObjectTool.prototype.mouseup = function (event) {\n  if (!this.dragCtx) return true\n\n  if (this.dragCtx.action) {\n    if (this.dragCtx.isNew) {\n      const rnd = this.editor.render\n      this.editor.update(\n        fromSimpleObjectDeletion(rnd.ctab, this.dragCtx.itemId),\n        true\n      )\n      this.dragCtx.action = fromSimpleObjectAddition(\n        rnd.ctab,\n        [this.dragCtx.p0, this.dragCtx.previous],\n        this.mode,\n        event.shiftKey\n      )\n    }\n    this.editor.update(this.dragCtx.action)\n  }\n\n  delete this.dragCtx\n  return true\n}\n\nexport default SimpleObjectTool\n","/****************************************************************************\n * Copyright 2021 EPAM Systems\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *    http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n ***************************************************************************/\n\nimport {\n  Vec2,\n  fromItemsFuse,\n  fromTemplateOnAtom,\n  fromTemplateOnBondAction,\n  fromTemplateOnCanvas,\n  getHoverToFuse,\n  getItemsToFuse,\n  FunctionalGroup\n} from 'ketcher-core'\n\nimport utils from '../shared/utils'\n\nfunction TemplateTool(editor, tmpl) {\n  // eslint-disable-line max-statements\n  if (!(this instanceof TemplateTool)) return new TemplateTool(editor, tmpl)\n\n  this.editor = editor\n  this.mode = tmpl.mode\n  this.struct = editor.render.ctab\n  this.sgroups = this.struct.sgroups\n  this.molecule = this.struct.molecule\n  this.functionalGroups = this.molecule.functionalGroups\n  this.editor.selection(null)\n\n  this.template = {\n    aid: parseInt(tmpl.aid) || 0,\n    bid: parseInt(tmpl.bid) || 0\n  }\n\n  const frag = tmpl.struct\n  frag.rescale()\n\n  const xy0 = new Vec2()\n  frag.atoms.forEach(atom => {\n    xy0.add_(atom.pp) // eslint-disable-line no-underscore-dangle\n  })\n\n  this.template.molecule = frag // preloaded struct\n  this.findItems = []\n  this.template.xy0 = xy0.scaled(1 / (frag.atoms.size || 1)) // template center\n\n  const atom = frag.atoms.get(this.template.aid)\n  if (atom) {\n    this.template.angle0 = utils.calcAngle(atom.pp, this.template.xy0) // center tilt\n    this.findItems.push('atoms')\n  }\n\n  const bond = frag.bonds.get(this.template.bid)\n  if (bond && this.mode !== 'fg') {\n    // template location sign against attachment bond\n    this.template.sign = getSign(frag, bond, this.template.xy0)\n    this.findItems.push('bonds')\n  }\n\n  const sgroup = frag.sgroups.size\n  if (sgroup) {\n    this.findItems.push('sgroups')\n  }\n}\n\nTemplateTool.prototype.mousedown = function (event) {\n  const closestItem = this.editor.findItem(event, [\n    'atoms',\n    'bonds',\n    'sgroups',\n    'functionalGroups'\n  ])\n  const struct = this.editor.struct()\n  const atomResult = []\n  const bondResult = []\n  const sGroupResult = []\n  const result = []\n\n  if (\n    closestItem &&\n    struct.functionalGroups.size &&\n    closestItem.map === 'functionalGroups' &&\n    FunctionalGroup.isContractedFunctionalGroup(\n      closestItem.id,\n      struct.functionalGroups\n    )\n  ) {\n    sGroupResult.push(closestItem.id)\n  }\n  if (\n    closestItem &&\n    struct.functionalGroups.size &&\n    closestItem.map === 'atoms'\n  ) {\n    const atomId = FunctionalGroup.atomsInFunctionalGroup(\n      struct.functionalGroups,\n      closestItem.id\n    )\n    if (atomId !== null) atomResult.push(atomId)\n  }\n  if (\n    closestItem &&\n    struct.functionalGroups.size &&\n    closestItem.map === 'bonds'\n  ) {\n    const bondId = FunctionalGroup.bondsInFunctionalGroup(\n      this.molecule,\n      struct.functionalGroups,\n      closestItem.id\n    )\n    if (bondId !== null) bondResult.push(bondId)\n  }\n  if (sGroupResult.length > 0) {\n    for (let id of sGroupResult) {\n      if (!result.includes(id)) result.push(id)\n    }\n  }\n  if (atomResult.length > 0) {\n    for (let id of atomResult) {\n      const fgId = FunctionalGroup.findFunctionalGroupByAtom(\n        struct.functionalGroups,\n        id\n      )\n      if (fgId !== null && !result.includes(fgId)) {\n        result.push(fgId)\n      }\n    }\n  }\n  if (bondResult.length > 0) {\n    for (let id of bondResult) {\n      const fgId = FunctionalGroup.findFunctionalGroupByBond(\n        this.molecule,\n        struct.functionalGroups,\n        id\n      )\n      if (fgId !== null && !result.includes(fgId)) {\n        result.push(fgId)\n      }\n    }\n  }\n  if (result.length) {\n    this.editor.event.removeFG.dispatch({ fgIds: result })\n    return\n  }\n  // eslint-disable-line max-statements\n  const editor = this.editor\n  const restruct = editor.render.ctab\n  this.editor.hover(null)\n\n  this.dragCtx = {\n    xy0: editor.render.page2obj(event),\n    item: editor.findItem(event, this.findItems)\n  }\n\n  const dragCtx = this.dragCtx\n  const ci = dragCtx.item\n\n  if (!ci) {\n    //  ci.type == 'Canvas'\n    delete dragCtx.item\n    return true\n  }\n\n  if (ci.map === 'bonds' && this.mode !== 'fg') {\n    // calculate fragment center\n    const molecule = restruct.molecule\n    const xy0 = new Vec2()\n    const bond = molecule.bonds.get(ci.id)\n    const frid = molecule.atoms.get(bond.begin).fragment\n    const frIds = molecule.getFragmentIds(frid)\n    let count = 0\n\n    let loop = molecule.halfBonds.get(bond.hb1).loop\n\n    if (loop < 0) loop = molecule.halfBonds.get(bond.hb2).loop\n\n    if (loop >= 0) {\n      const loopHbs = molecule.loops.get(loop).hbs\n      loopHbs.forEach(hb => {\n        xy0.add_(molecule.atoms.get(molecule.halfBonds.get(hb).begin).pp) // eslint-disable-line no-underscore-dangle, max-len\n        count++\n      })\n    } else {\n      frIds.forEach(id => {\n        xy0.add_(molecule.atoms.get(id).pp) // eslint-disable-line no-underscore-dangle\n        count++\n      })\n    }\n\n    dragCtx.v0 = xy0.scaled(1 / count)\n\n    const sign = getSign(molecule, bond, dragCtx.v0)\n\n    // calculate default template flip\n    dragCtx.sign1 = sign || 1\n    dragCtx.sign2 = this.template.sign\n  }\n\n  return true\n}\n\nTemplateTool.prototype.mousemove = function (event) {\n  // eslint-disable-line max-statements\n  const restruct = this.editor.render.ctab\n\n  if (!this.dragCtx) {\n    this.editor.hover(this.editor.findItem(event, this.findItems))\n    return true\n  }\n\n  const dragCtx = this.dragCtx\n  const ci = dragCtx.item\n  let pos0 = null\n  const pos1 = this.editor.render.page2obj(event)\n  const struct = restruct.molecule\n\n  /* moving when attached to bond */\n  if (ci && ci.map === 'bonds' && this.mode !== 'fg') {\n    const bond = struct.bonds.get(ci.id)\n    let sign = getSign(struct, bond, pos1)\n\n    if (dragCtx.sign1 * this.template.sign > 0) sign = -sign\n\n    if (sign !== dragCtx.sign2 || !dragCtx.action) {\n      if (dragCtx.action) dragCtx.action.perform(restruct) // undo previous action\n\n      dragCtx.sign2 = sign\n      let [action, pasteItems] = fromTemplateOnBondAction(\n        restruct,\n        this.template,\n        ci.id,\n        this.editor.event,\n        dragCtx.sign1 * dragCtx.sign2 > 0,\n        false\n      )\n\n      dragCtx.action = action\n      this.editor.update(dragCtx.action, true)\n\n      dragCtx.mergeItems = getItemsToFuse(this.editor, pasteItems)\n      this.editor.hover(getHoverToFuse(dragCtx.mergeItems))\n    }\n    return true\n  }\n  /* end */\n\n  let extraBond = null\n  // calc initial pos and is extra bond needed\n  if (!ci) {\n    //  ci.type == 'Canvas'\n    pos0 = dragCtx.xy0\n  } else if (ci.map === 'atoms') {\n    pos0 = struct.atoms.get(ci.id).pp\n    extraBond = this.mode === 'fg' ? true : Vec2.dist(pos0, pos1) > 1\n  }\n\n  // calc angle\n  let angle = utils.calcAngle(pos0, pos1)\n  if (!event.ctrlKey) angle = utils.fracAngle(angle)\n  const degrees = utils.degrees(angle)\n  this.editor.event.message.dispatch({ info: degrees + '¬∫' })\n\n  // check if anything changed since last time\n  if (\n    dragCtx.hasOwnProperty('angle') &&\n    dragCtx.angle === degrees && // eslint-disable-line no-prototype-builtins\n    (!dragCtx.hasOwnProperty('extra_bond') || dragCtx.extra_bond === extraBond)\n  )\n    // eslint-disable-line no-prototype-builtins\n    return true\n\n  // undo previous action\n  if (dragCtx.action) dragCtx.action.perform(restruct)\n\n  // create new action\n  dragCtx.angle = degrees\n  let action = null\n  let pasteItems\n\n  if (!ci) {\n    // ci.type == 'Canvas'\n    ;[action, pasteItems] = fromTemplateOnCanvas(\n      restruct,\n      this.template,\n      pos0,\n      angle\n    )\n  } else if (ci.map === 'atoms') {\n    ;[action, pasteItems] = fromTemplateOnAtom(\n      restruct,\n      this.template,\n      ci.id,\n      angle,\n      extraBond\n    )\n    dragCtx.extra_bond = extraBond\n  }\n  dragCtx.action = action\n\n  this.editor.update(dragCtx.action, true)\n\n  if (this.mode !== 'fg') {\n    dragCtx.mergeItems = getItemsToFuse(this.editor, pasteItems)\n    this.editor.hover(getHoverToFuse(dragCtx.mergeItems))\n  }\n\n  return true\n}\n\nTemplateTool.prototype.mouseup = function (event) {\n  // eslint-disable-line max-statements\n  const dragCtx = this.dragCtx\n  if (!dragCtx) return true\n  delete this.dragCtx\n\n  const restruct = this.editor.render.ctab\n  const struct = restruct.molecule\n  const ci = dragCtx.item\n\n  /* after moving around bond */\n  if (dragCtx.action && ci && ci.map === 'bonds' && this.mode !== 'fg') {\n    dragCtx.action.perform(restruct) // revert drag action\n    fromTemplateOnBondAction(\n      restruct,\n      this.template,\n      ci.id,\n      this.editor.event,\n      dragCtx.sign1 * dragCtx.sign2 > 0,\n      true\n    ).then(([action, pasteItems]) => {\n      const mergeItems = getItemsToFuse(this.editor, pasteItems)\n      action = fromItemsFuse(restruct, mergeItems).mergeWith(action)\n      this.editor.update(action)\n    })\n    return true\n  }\n  /* end */\n\n  let action\n  let pasteItems = null\n\n  if (!dragCtx.action) {\n    if (!ci) {\n      //  ci.type == 'Canvas'\n      ;[action, pasteItems] = fromTemplateOnCanvas(\n        restruct,\n        this.template,\n        dragCtx.xy0,\n        0\n      )\n      dragCtx.action = action\n    } else if (ci.map === 'atoms') {\n      const degree = restruct.atoms.get(ci.id).a.neighbors.length\n      let angle\n      let extraBond\n\n      if (degree > 1) {\n        // common case\n        angle = null\n        extraBond = true\n      } else if (degree === 1) {\n        // on chain end\n        const atom = struct.atoms.get(ci.id)\n        const neiId = struct.halfBonds.get(atom.neighbors[0]).end\n        const nei = struct.atoms.get(neiId)\n\n        angle = event.ctrlKey\n          ? utils.calcAngle(nei.pp, atom.pp)\n          : utils.fracAngle(utils.calcAngle(nei.pp, atom.pp))\n        extraBond = false\n      } else {\n        // on single atom\n        angle = 0\n        extraBond = false\n      }\n\n      ;[action, pasteItems] = fromTemplateOnAtom(\n        restruct,\n        this.template,\n        ci.id,\n        angle,\n        extraBond\n      )\n      dragCtx.action = action\n    } else if (ci.map === 'bonds' && this.mode !== 'fg') {\n      fromTemplateOnBondAction(\n        restruct,\n        this.template,\n        ci.id,\n        this.editor.event,\n        dragCtx.sign1 * dragCtx.sign2 > 0,\n        true\n      ).then(([action, pasteItems]) => {\n        // eslint-disable-line no-shadow\n        if (this.mode !== 'fg') {\n          const mergeItems = getItemsToFuse(this.editor, pasteItems)\n          action = fromItemsFuse(restruct, mergeItems).mergeWith(action)\n          this.editor.update(action)\n        }\n      })\n\n      return true\n    }\n  }\n\n  this.editor.selection(null)\n\n  if (!dragCtx.mergeItems && pasteItems && this.mode !== 'fg')\n    dragCtx.mergeItems = getItemsToFuse(this.editor, pasteItems)\n  dragCtx.action = dragCtx.action\n    ? fromItemsFuse(restruct, dragCtx.mergeItems).mergeWith(dragCtx.action)\n    : fromItemsFuse(restruct, dragCtx.mergeItems)\n\n  this.editor.hover(null)\n  const completeAction = dragCtx.action\n  if (completeAction && !completeAction.isDummy())\n    this.editor.update(completeAction)\n  this.editor.event.message.dispatch({\n    info: false\n  })\n\n  return true\n}\n\nTemplateTool.prototype.cancel = TemplateTool.prototype.mouseup\nTemplateTool.prototype.mouseleave = TemplateTool.prototype.mouseup\n\nfunction getSign(molecule, bond, v) {\n  const begin = molecule.atoms.get(bond.begin).pp\n  const end = molecule.atoms.get(bond.end).pp\n\n  const sign = Vec2.cross(Vec2.diff(begin, end), Vec2.diff(v, end))\n\n  if (sign > 0) return 1\n  if (sign < 0) return -1\n  return 0\n}\n\nexport default TemplateTool\n","/****************************************************************************\n * Copyright 2021 EPAM Systems\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *    http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n ***************************************************************************/\n\nimport {\n  Action,\n  Text,\n  Vec2,\n  fromMultipleMove,\n  fromTextCreation,\n  fromTextDeletion,\n  fromTextUpdating\n} from 'ketcher-core'\n\ninterface Result {\n  content: string\n}\n\nclass TextTool {\n  editor: any\n  dragCtx: any\n\n  constructor(editor) {\n    this.editor = editor\n    this.editor.selection(null)\n  }\n\n  mousedown(event) {\n    const render = this.editor.render\n    const ci = this.editor.findItem(event, ['texts'])\n\n    this.editor.selection(null)\n\n    if (ci && ci.map === 'texts') {\n      this.editor.hover(null)\n      this.editor.selection({ texts: [ci.id] })\n      this.dragCtx = {\n        xy0: render.page2obj(event),\n        action: new Action()\n      }\n    }\n  }\n\n  mousemove(event) {\n    const render = this.editor.render\n\n    if (this.dragCtx) {\n      if (this.dragCtx.action) {\n        this.dragCtx.action.perform(render.ctab)\n      }\n\n      this.dragCtx.action = fromMultipleMove(\n        render.ctab,\n        this.editor.selection() || {},\n        render.page2obj(event).sub(this.dragCtx.xy0)\n      )\n      this.editor.update(this.dragCtx.action, true)\n    } else {\n      this.editor.hover(this.editor.findItem(event, ['texts']))\n    }\n  }\n\n  mouseup() {\n    if (this.dragCtx) {\n      this.editor.update(this.dragCtx.action)\n      delete this.dragCtx\n    }\n    return true\n  }\n\n  click(event) {\n    const render = this.editor.render\n    const ci = this.editor.findItem(event, ['texts'])\n    this.editor.hover(null)\n\n    if (!ci) {\n      propsDialog(this.editor, null, render.page2obj(event))\n    }\n\n    return true\n  }\n\n  dblclick(event) {\n    const ci = this.editor.findItem(event, ['texts'])\n    this.editor.hover(null)\n\n    if (ci.map === 'texts') {\n      propsDialog(this.editor, ci.id, ci.position)\n    }\n\n    return true\n  }\n}\n\nfunction propsDialog(editor: any, id: number | null, position: Vec2) {\n  const struct = editor.render.ctab.molecule\n  const text: Text | null = id || id === 0 ? struct.texts.get(id) : null\n  const origilContent = text ? text.content : ''\n\n  const res = editor.event.elementEdit.dispatch({\n    content: origilContent,\n    id,\n    position,\n    type: 'text'\n  })\n\n  res\n    .then(({ content }: Result) => {\n      if (!id && id !== 0 && content) {\n        editor.update(fromTextCreation(editor.render.ctab, content, position))\n      } else if (!content) {\n        editor.update(fromTextDeletion(editor.render.ctab, id!))\n      } else if (content !== origilContent) {\n        editor.update(fromTextUpdating(editor.render.ctab, id!, content))\n      }\n    })\n    .catch(() => null)\n}\n\nexport default function TextToolWrapper(editor) {\n  return new TextTool(editor)\n}\n","/****************************************************************************\n * Copyright 2021 EPAM Systems\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *    http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n ***************************************************************************/\n\nimport APointTool from './apoint'\nimport AtomTool from './atom'\nimport AttachTool from './attach'\nimport BondTool from './bond'\nimport ChainTool from './chain'\nimport ChargeTool from './charge'\nimport EnhancedStereoTool from './enhanced-stereo'\nimport EraserTool from './eraser'\nimport PasteTool from './paste'\nimport RGroupAtomTool from './rgroupatom'\nimport RGroupFragmentTool from './rgroupfragment'\nimport ReactionArrowTool from './reactionarrow'\nimport ReactionMapTool from './reactionmap'\nimport ReactionPlusTool from './reactionplus'\nimport ReactionUnmapTool from './reactionunmap'\nimport RotateTool from './rotate'\nimport SGroupTool from './sgroup'\nimport SelectTool from './select'\nimport SimpleObjectTool from './simpleobject'\nimport TemplateTool from './template'\nimport TextToolWrapper from './text'\n\nconst tools = {\n  rgroupatom: RGroupAtomTool,\n  select: SelectTool,\n  sgroup: SGroupTool,\n  eraser: EraserTool,\n  atom: AtomTool,\n  bond: BondTool,\n  chain: ChainTool,\n  template: TemplateTool,\n  charge: ChargeTool,\n  rgroupfragment: RGroupFragmentTool,\n  apoint: APointTool,\n  attach: AttachTool,\n  reactionarrow: ReactionArrowTool,\n  reactionplus: ReactionPlusTool,\n  reactionmap: ReactionMapTool,\n  reactionunmap: ReactionUnmapTool,\n  paste: PasteTool,\n  rotate: RotateTool,\n  enhancedStereo: EnhancedStereoTool,\n  simpleobject: SimpleObjectTool,\n  text: TextToolWrapper\n}\n\nexport default tools\n","/****************************************************************************\n * Copyright 2021 EPAM Systems\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *    http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n ***************************************************************************/\n\nimport {\n  Action,\n  findStereoAtoms,\n  fromAtomsAttrs,\n  fromStereoFlagUpdate\n} from 'ketcher-core'\n\nimport Editor from '../Editor'\n\nfunction EnhancedStereoTool(\n  this: typeof EnhancedStereoTool,\n  editor: Editor\n): null | void {\n  if (!(this instanceof EnhancedStereoTool)) {\n    const selection = editor.selection()\n\n    const stereoAtoms = findStereoAtoms(\n      editor.struct(),\n      selection\n        ? selection.atoms || []\n        : Array.from(editor.struct().atoms.keys())\n    )\n\n    if (stereoAtoms.length === 0) return null\n\n    changeAtomsStereoAction(editor, stereoAtoms).then(\n      action => action && editor.update(action)\n    )\n  }\n}\n\nfunction changeAtomsStereoAction(\n  editor: Editor,\n  stereoAtoms: number[]\n): Promise<Action> {\n  const struct = editor.struct()\n  const restruct = editor.render.ctab\n  const stereoLabels = stereoAtoms.map(stereoAtom => {\n    const atom = struct.atoms.get(stereoAtom)\n    return atom && atom.stereoLabel\n  })\n  const hasAnotherLabel = stereoLabels.some(\n    stereoLabel => stereoLabel !== stereoLabels[0]\n  )\n  const res = editor.event.enhancedStereoEdit.dispatch({\n    stereoLabel: hasAnotherLabel ? null : stereoLabels[0]\n  })\n  return res.then(stereoLabel => {\n    if (!stereoLabel) return null\n    const action = stereoAtoms.reduce(\n      (acc, stereoAtom) => {\n        return acc.mergeWith(\n          fromStereoFlagUpdate(restruct, struct.atoms.get(stereoAtom)?.fragment)\n        )\n      },\n      fromAtomsAttrs(\n        restruct,\n        stereoAtoms,\n        {\n          stereoLabel\n        },\n        false\n      )\n    )\n    action.operations.reverse()\n    return action\n  })\n}\n\nexport default EnhancedStereoTool\n","/****************************************************************************\n * Copyright 2021 EPAM Systems\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *    http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n ***************************************************************************/\n\nimport { fromHighlightCreate, fromHighlightClear } from 'ketcher-core'\nimport type { Struct } from 'ketcher-core'\n\nimport type { Editor } from './Editor'\n\ntype HighlightAttributes = {\n  atoms: number[]\n  bonds: number[]\n  color: string\n}\n\nexport class Highlighter {\n  editor: Editor\n\n  constructor(editor: Editor) {\n    this.editor = editor\n  }\n\n  getAll() {\n    const highlightsMap = this.editor.render.ctab.molecule.highlights\n    const highlightsArray = [...highlightsMap].map(([id, highlight]) => ({\n      id,\n      highlight\n    }))\n    return highlightsArray\n  }\n\n  create(...args: HighlightAttributes[]) {\n    const createdHighlights: HighlightAttributes[] = []\n\n    args.forEach(arg => {\n      const { atoms, bonds, color } = arg\n      if (typeof color !== 'string') {\n        return\n      }\n\n      if (!atoms && !bonds) {\n        return\n      }\n\n      const restruct = this.editor.render.ctab\n\n      const { validAtoms, validBonds } = getValidInputOnly(\n        restruct.molecule,\n        atoms,\n        bonds\n      )\n\n      if (validAtoms.length === 0 && validBonds.length === 0) {\n        return\n      }\n\n      createdHighlights.push({ atoms: validAtoms, bonds: validBonds, color })\n    })\n    const action = fromHighlightCreate(\n      this.editor.render.ctab,\n      createdHighlights\n    )\n    this.editor.update(action)\n  }\n\n  clear() {\n    const action = fromHighlightClear(this.editor.render.ctab)\n    this.editor.update(action)\n  }\n\n  /*\n  // Update by ID\n  update(\n    id: number,\n    {\n      atoms,\n      bonds,\n      color\n    }: {\n      atoms?: number[]\n      bonds?: number[]\n      color: string\n    }\n  ) {\n    if (typeof color !== 'string' || typeof id !== 'number') {\n      return\n    }\n    if (!atoms && !bonds) {\n      return\n    }\n\n    const restruct = this.editor.render.ctab\n\n    const { validAtoms, validBonds } = getValidInputOnly(\n      restruct.molecule,\n      atoms,\n      bonds\n    )\n\n    if (validAtoms.length === 0 && validBonds.length === 0) {\n      return\n    }\n\n    const action = fromHighlightUpdate(\n      id,\n      this.editor.render.ctab,\n      validAtoms,\n      validBonds,\n      color\n    )\n    this.editor.update(action)\n  }\n\n  // Add items to highlight by id\n  append(\n    id: number,\n    {\n      atoms,\n      bonds,\n      color\n    }: {\n      atoms?: number[]\n      bonds?: number[]\n      color?: string\n    }\n  ) {\n    if (!atoms && !bonds && !color) {\n      return\n    }\n    const restruct = this.editor.render.ctab\n\n    const { validAtoms, validBonds } = getValidInputOnly(\n      restruct.molecule,\n      atoms,\n      bonds\n    )\n\n    if (validAtoms.length === 0 && validBonds.length === 0 && !color) {\n      return\n    }\n\n    const currentHighlight = restruct.molecule.highlights.get(id)\n\n    if (currentHighlight) {\n      const mergedHighlight = {\n        atoms: union(currentHighlight.atoms, validAtoms),\n        bonds: union(currentHighlight.bonds, validBonds),\n        color: color || currentHighlight.color\n      }\n\n      const action = fromHighlightUpdate(\n        id,\n        restruct,\n        mergedHighlight.atoms,\n        mergedHighlight.bonds,\n        mergedHighlight.color\n      )\n      this.editor.update(action)\n    }\n  }\n\n  // Delete by ID\n  delete(id: number) {\n    if (typeof id !== 'number') {\n      return\n    }\n\n    const action = fromHighlightDelete(this.editor.render.ctab, id)\n    this.editor.update(action)\n  }\n  */\n}\n\ntype ValidInput = {\n  validAtoms: number[]\n  validBonds: number[]\n}\n\nfunction getValidInputOnly(struct: Struct, atoms, bonds): ValidInput {\n  if (!Array.isArray(atoms)) {\n    atoms = []\n  }\n\n  if (!Array.isArray(bonds)) {\n    bonds = []\n  }\n\n  const { atoms: structAtoms, bonds: structBonds } = struct\n\n  // Filter out atom ids that are not in struct\n  if (atoms.length > 0) {\n    atoms = atoms.filter(aid => structAtoms.has(aid))\n  }\n\n  // Filter out bond ids that are not in struct\n  if (bonds.length > 0) {\n    bonds = bonds.filter(bid => structBonds.has(bid))\n  }\n\n  return {\n    validAtoms: atoms,\n    validBonds: bonds\n  }\n}\n","/****************************************************************************\n * Copyright 2021 EPAM Systems\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *    http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n ***************************************************************************/\n\nimport {\n  Action,\n  Editor as KetcherEditor,\n  Pile,\n  Render,\n  Struct,\n  Vec2,\n  fromDescriptorsAlign,\n  fromNewCanvas\n} from 'ketcher-core'\nimport {\n  DOMSubscription,\n  PipelineSubscription,\n  Subscription\n} from 'subscription'\n\nimport closest from './shared/closest'\nimport { customOnChangeHandler } from './utils'\nimport { isEqual } from 'lodash/fp'\nimport toolMap from './tool'\nimport { Highlighter } from './highlighter'\n\nconst SCALE = 40\nconst HISTORY_SIZE = 32 // put me to options\n\nconst structObjects = [\n  'atoms',\n  'bonds',\n  'frags',\n  'sgroups',\n  'sgroupData',\n  'rgroups',\n  'rxnArrows',\n  'rxnPluses',\n  'enhancedFlags',\n  'simpleObjects',\n  'texts'\n]\n\nconst highlightTargets = [\n  'atoms',\n  'bonds',\n  'rxnArrows',\n  'rxnPluses',\n  'functionalGroups',\n  'frags',\n  'merge',\n  'rgroups',\n  'sgroups',\n  'sgroupData',\n  'enhancedFlags',\n  'simpleObjects',\n  'texts'\n]\n\nfunction selectStereoFlagsIfNecessary(\n  atoms: any,\n  expAtoms: number[]\n): number[] {\n  const atomsOfFragments = {}\n  atoms.forEach((atom, atomId) => {\n    atomsOfFragments[atom.fragment]\n      ? atomsOfFragments[atom.fragment].push(atomId)\n      : (atomsOfFragments[atom.fragment] = [atomId])\n  })\n\n  let stereoFlags: number[] = []\n\n  Object.keys(atomsOfFragments).forEach(fragId => {\n    let shouldSelSFlag: boolean = true\n    atomsOfFragments[fragId].forEach(atomId => {\n      if (!expAtoms.includes(atomId)) shouldSelSFlag = false\n    })\n    shouldSelSFlag && stereoFlags.push(Number(fragId))\n  })\n  return stereoFlags\n}\n\ninterface Selection {\n  atoms?: Array<number>\n  bonds?: Array<number>\n  enhancedFlags?: Array<number>\n  rxnPluses?: Array<number>\n  rxnArrows?: Array<number>\n}\nclass Editor implements KetcherEditor {\n  #origin?: any\n  render: Render\n  _selection: Selection | null\n  _tool: any\n  historyStack: any\n  historyPtr: any\n  errorHandler: ((message: string) => void) | null\n  highlights: Highlighter\n  event: {\n    message: Subscription\n    elementEdit: PipelineSubscription\n    bondEdit: PipelineSubscription\n    rgroupEdit: PipelineSubscription\n    sgroupEdit: PipelineSubscription\n    sdataEdit: PipelineSubscription\n    quickEdit: PipelineSubscription\n    attachEdit: PipelineSubscription\n    removeFG: PipelineSubscription\n    change: Subscription\n    selectionChange: PipelineSubscription\n    aromatizeStruct: PipelineSubscription\n    dearomatizeStruct: PipelineSubscription\n    enhancedStereoEdit: PipelineSubscription\n  }\n  lastEvent: any\n\n  constructor(clientArea, options) {\n    this.render = new Render(\n      clientArea,\n      Object.assign(\n        {\n          scale: SCALE\n        },\n        options\n      )\n    )\n\n    this._selection = null // eslint-disable-line\n    this._tool = null // eslint-disable-line\n    this.historyStack = []\n    this.historyPtr = 0\n    this.errorHandler = null\n    this.highlights = new Highlighter(this)\n\n    this.event = {\n      message: new Subscription(),\n      elementEdit: new PipelineSubscription(),\n      bondEdit: new PipelineSubscription(),\n      rgroupEdit: new PipelineSubscription(),\n      sgroupEdit: new PipelineSubscription(),\n      sdataEdit: new PipelineSubscription(),\n      quickEdit: new PipelineSubscription(),\n      attachEdit: new PipelineSubscription(),\n      removeFG: new PipelineSubscription(),\n      change: new Subscription(),\n      selectionChange: new PipelineSubscription(),\n      aromatizeStruct: new PipelineSubscription(),\n      dearomatizeStruct: new PipelineSubscription(),\n      // TODO: correct\n      enhancedStereoEdit: new PipelineSubscription()\n    }\n\n    domEventSetup(this, clientArea)\n  }\n\n  isDitrty(): boolean {\n    const position = this.historyPtr\n    const length = this.historyStack.length\n    if (!length || !this.#origin) {\n      return false\n    }\n    return !isEqual(this.historyStack[position - 1], this.#origin)\n  }\n\n  setOrigin(): void {\n    const position = this.historyPtr\n    this.#origin = position ? this.historyStack[position - 1] : null\n  }\n\n  tool(name?: any, opts?: any) {\n    /* eslint-disable no-underscore-dangle */\n    if (arguments.length === 0) {\n      return this._tool\n    }\n\n    if (this._tool && this._tool.cancel) {\n      this._tool.cancel()\n    }\n\n    // TODO: when all tools are refactored to classes, remove this check\n    // and use new keyword for every tool\n    let tool\n    if (name === 'select') {\n      tool = new toolMap[name](this, opts)\n    } else {\n      tool = toolMap[name](this, opts)\n    }\n    if (!tool) {\n      return null\n    }\n\n    this._tool = tool\n    return this._tool\n    /* eslint-enable no-underscore-dangle */\n  }\n\n  clear() {\n    this.struct(undefined)\n  }\n\n  struct(value?: Struct): Struct {\n    if (arguments.length === 0) {\n      return this.render.ctab.molecule\n    }\n\n    this.selection(null)\n    const struct = value || new Struct()\n    const action = fromNewCanvas(this.render.ctab, struct)\n    this.update(action)\n\n    const structCenter = getStructCenter(this.render.ctab)\n    recoordinate(this, structCenter)\n    return this.render.ctab.molecule\n  }\n\n  options(value?: any) {\n    if (arguments.length === 0) {\n      return this.render.options\n    }\n\n    const struct = this.render.ctab.molecule\n    const zoom = this.render.options.zoom\n    this.render.clientArea.innerHTML = ''\n\n    this.render = new Render(\n      this.render.clientArea,\n      Object.assign({ scale: SCALE }, value)\n    )\n    this.render.setMolecule(struct) // TODO: reuse this.struct here?\n    this.render.setZoom(zoom)\n    this.render.update()\n    return this.render.options\n  }\n\n  zoom(value?: any) {\n    if (arguments.length === 0) {\n      return this.render.options.zoom\n    }\n\n    this.render.setZoom(value)\n\n    const selection = this.selection()\n    const structCenter = getStructCenter(this.render.ctab, selection)\n    recoordinate(this, structCenter)\n\n    this.render.update()\n    return this.render.options.zoom\n  }\n\n  selection(ci?: any) {\n    if (arguments.length === 0) {\n      return this._selection // eslint-disable-line\n    }\n\n    let ReStruct = this.render.ctab\n\n    this._selection = null // eslint-disable-line\n    if (ci === 'all') {\n      // TODO: better way will be this.struct()\n      ci = structObjects.reduce((res, key) => {\n        res[key] = Array.from(ReStruct[key].keys())\n        return res\n      }, {})\n    }\n\n    if (ci === 'descriptors') {\n      ReStruct = this.render.ctab\n      ci = { sgroupData: Array.from(ReStruct['sgroupData'].keys()) }\n    }\n\n    if (ci) {\n      let res: Selection = {}\n\n      Object.keys(ci).forEach(key => {\n        if (ci[key].length > 0)\n          // TODO: deep merge\n          res[key] = ci[key].slice()\n      })\n\n      if (Object.keys(res).length !== 0) {\n        this._selection = res // eslint-disable-line\n      }\n      const stereoFlags = selectStereoFlagsIfNecessary(\n        this.struct().atoms,\n        this.explicitSelected().atoms\n      )\n      if (stereoFlags.length !== 0) {\n        this._selection && this._selection.enhancedFlags\n          ? (this._selection.enhancedFlags = Array.from(\n              new Set([...this._selection.enhancedFlags, ...stereoFlags])\n            ))\n          : (res.enhancedFlags = stereoFlags)\n      }\n    }\n\n    this.render.ctab.setSelection(this._selection) // eslint-disable-line\n    this.event.selectionChange.dispatch(this._selection) // eslint-disable-line\n\n    this.render.update()\n    return this._selection // eslint-disable-line\n  }\n\n  hover(ci: any, newTool?: any) {\n    const tool = newTool || this._tool // eslint-disable-line\n\n    if (\n      'ci' in tool &&\n      (!ci || tool.ci.map !== ci.map || tool.ci.id !== ci.id)\n    ) {\n      setHover(tool.ci, false, this.render)\n      delete tool.ci\n    }\n\n    if (ci && setHover(ci, true, this.render)) tool.ci = ci\n  }\n\n  update(action: Action | true, ignoreHistory?) {\n    if (action === true) {\n      this.render.update(true) // force\n    } else {\n      if (!ignoreHistory && !action.isDummy()) {\n        this.historyStack.splice(this.historyPtr, HISTORY_SIZE + 1, action)\n        if (this.historyStack.length > HISTORY_SIZE) {\n          this.historyStack.shift()\n        }\n        this.historyPtr = this.historyStack.length\n        this.event.change.dispatch(action) // TODO: stoppable here\n      }\n      this.render.update()\n    }\n  }\n\n  historySize() {\n    return {\n      undo: this.historyPtr,\n      redo: this.historyStack.length - this.historyPtr\n    }\n  }\n\n  undo() {\n    if (this.historyPtr === 0) {\n      throw new Error('Undo stack is empty')\n    }\n    if (this.tool() && this.tool().cancel) {\n      this.tool().cancel()\n    }\n\n    this.selection(null)\n\n    if (this._tool instanceof toolMap['paste']) {\n      this.event.change.dispatch()\n      return\n    }\n\n    this.historyPtr--\n    const stack = this.historyStack[this.historyPtr]\n    const action = stack.perform(this.render.ctab)\n\n    this.historyStack[this.historyPtr] = action\n    this.event.change.dispatch(action)\n    this.render.update()\n  }\n\n  redo() {\n    if (this.historyPtr === this.historyStack.length) {\n      throw new Error('Redo stack is empty')\n    }\n\n    if (this.tool() && this.tool().cancel) {\n      this.tool().cancel()\n    }\n\n    this.selection(null)\n    if (this._tool instanceof toolMap['paste']) {\n      this.event.change.dispatch()\n      return\n    }\n\n    const action = this.historyStack[this.historyPtr].perform(this.render.ctab)\n    this.historyStack[this.historyPtr] = action\n    this.historyPtr++\n    this.event.change.dispatch(action)\n    this.render.update()\n  }\n\n  subscribe(eventName: any, handler: any) {\n    let subscriber = {\n      handler: handler\n    }\n\n    switch (eventName) {\n      case 'change':\n        const subscribeFuncWrapper = action =>\n          customOnChangeHandler(action, handler)\n        subscriber.handler = subscribeFuncWrapper\n        this.event[eventName].add(subscribeFuncWrapper)\n        break\n\n      default:\n        this.event[eventName].add(handler)\n    }\n\n    return subscriber\n  }\n\n  unsubscribe(eventName: any, subscriber: any) {\n    //Only for event type - subscription\n    this.event[eventName].remove(subscriber.handler)\n  }\n\n  findItem(event: any, maps: any, skip: any) {\n    const pos = new Vec2(this.render.page2obj(event))\n\n    return closest.item(this.render.ctab, pos, maps, skip, this.render.options)\n  }\n\n  findMerge(srcItems: any, maps: any) {\n    return closest.merge(this.render.ctab, srcItems, maps, this.render.options)\n  }\n\n  explicitSelected() {\n    const selection = this.selection() || {}\n    const res = structObjects.reduce((acc, key) => {\n      acc[key] = selection[key] ? selection[key].slice() : []\n      return acc\n    }, {} as any)\n\n    const struct = this.render.ctab.molecule\n\n    // \"auto-select\" the atoms for the bonds in selection\n    if (res.bonds) {\n      res.bonds.forEach(bid => {\n        const bond = struct.bonds.get(bid)!\n        res.atoms = res.atoms || []\n        if (res.atoms.indexOf(bond.begin) < 0) {\n          res.atoms.push(bond.begin)\n        }\n\n        if (res.atoms.indexOf(bond.end) < 0) {\n          res.atoms.push(bond.end)\n        }\n      })\n    }\n\n    // \"auto-select\" the bonds with both atoms selected\n    if (res.atoms && res.bonds) {\n      struct.bonds.forEach((bond, bid) => {\n        if (\n          res.bonds.indexOf(bid) >= 0 &&\n          res.atoms.indexOf(bond.begin) >= 0 &&\n          res.atoms.indexOf(bond.end) >= 0\n        ) {\n          res.bonds = res.bonds || []\n          res.bonds.push(bid)\n        }\n      })\n    }\n\n    return res\n  }\n\n  structSelected() {\n    const struct = this.render.ctab.molecule\n    const selection = this.explicitSelected()\n    const dst = struct.clone(\n      new Pile(selection.atoms),\n      new Pile(selection.bonds),\n      true,\n      null,\n      new Pile(selection.simpleObjects),\n      new Pile(selection.texts)\n    )\n\n    // Copy by its own as Struct.clone doesn't support\n    // arrows/pluses id sets\n    struct.rxnArrows.forEach((item, id) => {\n      if (selection.rxnArrows.indexOf(id) !== -1)\n        dst.rxnArrows.add(item.clone())\n    })\n    struct.rxnPluses.forEach((item, id) => {\n      if (selection.rxnPluses.indexOf(id) !== -1)\n        dst.rxnPluses.add(item.clone())\n    })\n\n    dst.isReaction = struct.isReaction && struct.isRxn()\n\n    return dst\n  }\n\n  alignDescriptors() {\n    this.selection(null)\n    const action = fromDescriptorsAlign(this.render.ctab)\n    this.update(action)\n    this.render.update(true)\n  }\n}\n\nfunction isMouseRight(event) {\n  return (\n    (event.which && event.which === 3) || (event.button && event.button === 2)\n  )\n}\n\nfunction domEventSetup(editor: Editor, clientArea) {\n  // TODO: addEventListener('resize', ...);\n  ;[\n    'click',\n    'dblclick',\n    'mousedown',\n    'mousemove',\n    'mouseup',\n    'mouseleave'\n  ].forEach(eventName => {\n    editor.event[eventName] = new DOMSubscription()\n    const subs = editor.event[eventName]\n    clientArea.addEventListener(eventName, subs.dispatch.bind(subs))\n\n    subs.add(event => {\n      if (eventName !== 'mouseup' && eventName !== 'mouseleave') {\n        // to complete drag actions\n        if (\n          isMouseRight(event) ||\n          !event.target ||\n          event.target.nodeName === 'DIV'\n        ) {\n          // click on scroll\n          editor.hover(null)\n          return true\n        }\n      }\n      const EditorTool = editor.tool()\n      editor.lastEvent = event\n      if (EditorTool && eventName in EditorTool) {\n        EditorTool[eventName](event)\n      }\n      return true\n    }, -1)\n  })\n}\n\nfunction recoordinate(editor: Editor, rp /* , vp*/) {\n  // rp is a point in scaled coordinates, which will be positioned\n  // vp is the point where the reference point should now be (in view coordinates)\n  //    or the center if not set\n  console.assert(rp, 'Reference point not specified')\n  editor.render.setScrollOffset(0, 0)\n}\n\nfunction getStructCenter(ReStruct, selection?) {\n  const bb = ReStruct.getVBoxObj(selection || {})\n  return Vec2.lc2(bb.p0, 0.5, bb.p1, 0.5)\n}\n\nexport { Editor }\nexport default Editor\n\nfunction setHover(ci: any, visible: any, render: any) {\n  if (highlightTargets.indexOf(ci.map) === -1) {\n    return false\n  }\n\n  let item: any = null\n\n  if (ci.map === 'merge') {\n    Object.keys(ci.items).forEach(mp => {\n      ci.items[mp].forEach(dstId => {\n        item = render.ctab[mp].get(dstId)!\n\n        if (item) {\n          item.setHover(visible, render)\n        }\n      })\n    })\n\n    return true\n  }\n\n  if (ci.map === 'functionalGroups') ci.map = 'sgroups' // TODO: Refactor object\n\n  item = (render.ctab[ci.map] as Map<any, any>).get(ci.id)\n  if (!item) {\n    return true // TODO: fix, attempt to highlight a deleted item\n  }\n\n  if (\n    (ci.map === 'sgroups' && item.item.type === 'DAT') ||\n    ci.map === 'sgroupData'\n  ) {\n    // set highlight for both the group and the data item\n    const item1 = render.ctab.sgroups.get(ci.id)\n    if (item1) {\n      item1.setHover(visible, render)\n    }\n\n    const item2 = render.ctab.sgroupData.get(ci.id)\n    if (item2) {\n      item2.setHover(visible, render)\n    }\n  } else {\n    item.setHover(visible, render)\n  }\n  return true\n}\n","/****************************************************************************\n * Copyright 2021 EPAM Systems\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *    http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n ***************************************************************************/\n\nimport { OperationType } from 'ketcher-core'\n\ntype Data = {\n  operation: any\n  id?: number\n  label?: string\n  position?: {\n    x: number\n    y: number\n  }\n  attribute?: any\n  from?: any\n  to?: any\n  atomId?: any\n  fragId?: any\n  sGroupId?: any\n  type?: any\n  mode?: any\n}\n\nexport function customOnChangeHandler(action, handler) {\n  const data: Data[] = []\n\n  action.operations.reverse().forEach(operation => {\n    const op = operation._inverted\n    switch (op.type) {\n      case OperationType.ATOM_ADD:\n      case OperationType.ATOM_DELETE:\n        data.push({\n          operation: op.type,\n          id: op.data.aid,\n          label: op.data.atom.label ? op.data.atom.label : '',\n          position: {\n            x: +op.data.pos.x.toFixed(2),\n            y: +op.data.pos.y.toFixed(2)\n          }\n        })\n        break\n\n      case OperationType.ATOM_ATTR:\n        data.push({\n          operation: operation.type,\n          id: operation.data.aid,\n          attribute: operation.data.attribute,\n          from: operation.data.value,\n          to: operation.data2.value\n        })\n        break\n\n      case OperationType.ATOM_MOVE:\n        data.push({\n          operation: op.type,\n          id: op.data.aid,\n          position: {\n            x: +op.data.d.x.toFixed(2),\n            y: +op.data.d.y.toFixed(2)\n          }\n        })\n        break\n\n      case OperationType.BOND_ADD:\n      case OperationType.BOND_DELETE:\n        data.push({\n          operation: op.type,\n          id: op.data.bid\n        })\n        break\n\n      case OperationType.FRAGMENT_ADD:\n      case OperationType.FRAGMENT_DELETE:\n        data.push({\n          operation: op.type,\n          id: op.frid\n        })\n        break\n\n      case OperationType.FRAGMENT_ADD_STEREO_ATOM:\n      case OperationType.FRAGMENT_DELETE_STEREO_ATOM:\n        data.push({\n          operation: op.type,\n          atomId: op.data.aid,\n          fragId: op.data.frid\n        })\n        break\n\n      case OperationType.S_GROUP_ATOM_ADD:\n      case OperationType.S_GROUP_ATOM_REMOVE:\n        data.push({\n          operation: op.type,\n          atomId: op.data.aid,\n          sGroupId: op.data.sgid\n        })\n        break\n\n      case OperationType.S_GROUP_CREATE:\n      case OperationType.S_GROUP_DELETE:\n        data.push({\n          operation: op.type,\n          type: op.data.type,\n          sGroupId: op.data.sgid\n        })\n        break\n\n      case OperationType.RXN_ARROW_ADD:\n      case OperationType.RXN_ARROW_DELETE:\n        data.push({\n          operation: op.type,\n          id: op.data.arid,\n          position: {\n            x: +op.data.pos.x.toFixed(2),\n            y: +op.data.pos.y.toFixed(2)\n          }\n        })\n        break\n\n      case OperationType.RXN_ARROW_RESIZE:\n        data.push({\n          operation: op.type,\n          id: op.data.id\n        })\n        break\n\n      case OperationType.RXN_ARROW_MOVE:\n        data.push({\n          operation: op.type,\n          id: op.data.id,\n          position: {\n            x: +op.data.d.x.toFixed(2),\n            y: +op.data.d.y.toFixed(2)\n          }\n        })\n        break\n\n      case OperationType.R_GROUP_FRAGMENT:\n        data.push({\n          operation: operation.type,\n          id: op.frid\n        })\n        break\n\n      case OperationType.SIMPLE_OBJECT_ADD:\n      case OperationType.SIMPLE_OBJECT_DELETE:\n        data.push({\n          operation: op.type,\n          id: op.data.id,\n          mode: op.data.mode\n        })\n        break\n\n      case OperationType.SIMPLE_OBJECT_RESIZE:\n        data.push({\n          operation: op.type,\n          id: op.data.id\n        })\n        break\n\n      case OperationType.SIMPLE_OBJECT_MOVE:\n        data.push({\n          operation: operation.type,\n          id: operation.data.id,\n          position: {\n            x: +operation.data.d.x.toFixed(2),\n            y: +operation.data.d.y.toFixed(2)\n          }\n        })\n        break\n\n      default:\n        data.push({\n          operation: op.type\n        })\n    }\n  })\n\n  return handler(data)\n}\n","import { ContextMenu, MenuItem } from 'react-contextmenu'\nimport { useState } from 'react'\nimport {\n  FunctionalGroup,\n  setExpandSGroup,\n  fromSgroupDeletion,\n  Action\n} from 'ketcher-core'\nimport { useAppContext } from '../../../../hooks'\nimport clsx from 'clsx'\nimport classes from './ContextMenu.module.less'\n\nconst FGContextMenu = () => {\n  const { getKetcherInstance } = useAppContext()\n\n  const handleExpand = () => {\n    const editor = getKetcherInstance().editor as any\n    const action = new Action()\n    const expandData = targetItems[0].isExpanded\n    targetItems?.forEach(item => {\n      action.mergeWith(\n        setExpandSGroup(editor.render.ctab, item.relatedSGroupId, {\n          expanded: !expandData\n        })\n      )\n    })\n    editor.update(action)\n    setShowSGroupMenu(false)\n    setTargetItems([])\n  }\n\n  const handleRemove = function () {\n    const editor = getKetcherInstance().editor as any\n    const action = new Action()\n    targetItems?.forEach(item => {\n      action.mergeWith(\n        fromSgroupDeletion(editor.render.ctab, item.relatedSGroupId)\n      )\n    })\n    editor.update(action)\n    setShowSGroupMenu(false)\n    setTargetItems([])\n  }\n\n  const [showSGroupMenu, setShowSGroupMenu] = useState(false)\n  const [targetItems, setTargetItems] = useState([] as Array<any>)\n\n  function showMenu(e) {\n    const editor = getKetcherInstance().editor as any\n    const struct = editor.struct()\n    const selection = editor.selection()\n    setShowSGroupMenu(false)\n    setTargetItems([])\n    const selectedItems = [] as Array<any>\n    let fgId\n\n    const ci = editor.findItem(\n      {\n        pageX: e.detail.position.x,\n        pageY: e.detail.position.y\n      },\n      ['sgroups', 'functionalGroups', 'atoms', 'bonds']\n    )\n    if (ci) {\n      switch (ci.map) {\n        case 'atoms':\n          fgId = FunctionalGroup.findFunctionalGroupByAtom(\n            struct.functionalGroups,\n            ci.id\n          )\n          fgId !== null &&\n            struct.functionalGroups.forEach(fg => {\n              fg.relatedSGroupId === fgId &&\n                !selectedItems.includes(fg) &&\n                selectedItems.push(fg)\n            })\n          break\n        case 'bonds':\n          fgId = FunctionalGroup.findFunctionalGroupByBond(\n            struct,\n            struct.functionalGroups,\n            ci.id\n          )\n          fgId !== null &&\n            struct.functionalGroups.forEach(fg => {\n              fg.relatedSGroupId === fgId &&\n                !selectedItems.includes(fg) &&\n                selectedItems.push(fg)\n            })\n          break\n        case 'sgroups':\n          const sgroup = struct.sgroups.get(ci.id)\n          if (FunctionalGroup.isFunctionalGroup(sgroup)) {\n            struct.functionalGroups.forEach(fg => {\n              fg.relatedSGroupId === sgroup?.id &&\n                !selectedItems.includes(fg) &&\n                selectedItems.push(fg)\n            })\n          }\n          break\n        case 'functionalGroups':\n          const fgroup = struct.sgroups.get(ci.id)\n          if (FunctionalGroup.isFunctionalGroup(fgroup)) {\n            struct.functionalGroups.forEach(fg => {\n              fg.relatedSGroupId === fgroup?.id &&\n                !selectedItems.includes(fg) &&\n                selectedItems.push(fg)\n            })\n          }\n          break\n      }\n    }\n\n    if (selection && selection.atoms) {\n      selection.atoms.forEach(aid => {\n        const fgId = FunctionalGroup.findFunctionalGroupByAtom(\n          struct.functionalGroups,\n          aid\n        )\n        fgId !== null &&\n          struct.functionalGroups.forEach(fg => {\n            fg.relatedSGroupId === fgId &&\n              !selectedItems.includes(fg) &&\n              selectedItems.push(fg)\n          })\n      })\n    }\n    if (selectedItems.length) {\n      setTargetItems(selectedItems)\n      setShowSGroupMenu(true)\n    }\n  }\n\n  return (\n    <ContextMenu\n      id=\"contextmenu\"\n      onShow={e => showMenu(e)}\n      className={clsx({\n        [classes.isHidden]: !showSGroupMenu\n      })}\n    >\n      <MenuItem onClick={handleExpand}>\n        {targetItems.length && targetItems[0].isExpanded\n          ? 'Contract '\n          : 'Expand '}\n        Abbreviation\n      </MenuItem>\n      <MenuItem divider />\n      <MenuItem onClick={handleRemove}>Remove Abbreviation</MenuItem>\n    </ContextMenu>\n  )\n}\n\nexport { FGContextMenu }\n","/****************************************************************************\n * Copyright 2021 EPAM Systems\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *    http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n ***************************************************************************/\n\nimport { Component, createRef } from 'react'\n\nimport Editor from '../../../../editor'\nimport Spinner from '../Spinner'\nimport classes from './StructEditor.module.less'\nimport clsx from 'clsx'\nimport { upperFirst } from 'lodash/fp'\nimport { FGContextMenu } from '../../../component/ContextMenu/ContextMenu'\nimport { ContextMenuTrigger, hideMenu } from 'react-contextmenu'\n\n//TODO: need to update component after making refactoring of store\nfunction setupEditor(editor, props, oldProps = {}) {\n  const { struct, tool, toolOpts, options } = props\n\n  if (struct !== oldProps.struct) editor.struct(struct)\n\n  if (tool !== oldProps.tool || toolOpts !== oldProps.toolOpts) {\n    editor.tool(tool, toolOpts)\n    if (toolOpts !== oldProps.toolOpts) {\n      editor.event.message.dispatch({ info: JSON.stringify(toolOpts) })\n    }\n  }\n\n  if (oldProps.options && options !== oldProps.options) editor.options(options)\n\n  Object.keys(editor.event).forEach(name => {\n    const eventName = `on${upperFirst(name)}`\n\n    if (props[eventName] !== oldProps[eventName]) {\n      if (oldProps[eventName]) editor.event[name].remove(oldProps[eventName])\n\n      if (props[eventName]) editor.event[name].add(props[eventName])\n    }\n  })\n}\n\nfunction removeEditorHandlers(editor, props) {\n  Object.keys(editor.event).forEach(name => {\n    const eventName = `on${upperFirst(name)}`\n\n    if (props[eventName]) editor.event[name].remove(props[eventName])\n  })\n}\n\nclass StructEditor extends Component {\n  constructor(props) {\n    super(props)\n    this.editorRef = createRef()\n    this.logRef = createRef()\n  }\n\n  shouldComponentUpdate(nextProps) {\n    return this.props.indigoVerification !== nextProps.indigoVerification\n  }\n\n  UNSAFE_componentWillReceiveProps(props) {\n    setupEditor(this.editor, props, this.props)\n  }\n\n  componentDidMount() {\n    this.editor = new Editor(this.editorRef.current, {\n      ...this.props.options\n    })\n    setupEditor(this.editor, this.props)\n    if (this.props.onInit) this.props.onInit(this.editor)\n\n    this.editor.event.message.add(msg => {\n      const el = this.logRef.current\n      if (msg.info) {\n        try {\n          const parsedInfo = JSON.parse(msg.info)\n          el.innerHTML = `Atom Id: ${parsedInfo.atomid}, Bond Id: ${parsedInfo.bondid}`\n        } catch {\n          el.innerHTML = msg.info\n        }\n        el.classList.add(classes.visible)\n      } else {\n        el.classList.remove(classes.visible)\n      }\n    })\n\n    this.editor.event.message.dispatch({\n      info: JSON.stringify(this.props.toolOpts)\n    })\n  }\n\n  componentWillUnmount() {\n    removeEditorHandlers(this.editor, this.props)\n  }\n\n  render() {\n    const {\n      Tag = 'div',\n      struct,\n      tool,\n      toolOpts,\n      options,\n      onInit,\n      onSelectionChange,\n      onElementEdit,\n      onEnhancedStereoEdit,\n      onQuickEdit,\n      onBondEdit,\n      onRgroupEdit,\n      onSgroupEdit,\n      onSdataEdit,\n      onRemoveFG,\n      onMessage,\n      onAromatizeStruct,\n      onDearomatizeStruct,\n      onAttachEdit,\n      indigoVerification,\n      onCipChange,\n      className,\n      ...props\n    } = this.props\n\n    return (\n      <Tag\n        className={clsx(classes.canvas, className)}\n        onMouseDown={event => event.preventDefault()}\n        {...props}\n      >\n        <ContextMenuTrigger\n          id=\"contextmenu\"\n          attributes={{\n            onClick: hideMenu\n          }}\n          holdToDisplay={-1}\n        >\n          <div\n            ref={this.editorRef}\n            className={clsx(classes.intermediateCanvas)}\n            onMouseDown={event => event.preventDefault()}\n          >\n            {/* svg here */}\n          </div>\n          <div className={classes.measureLog} ref={this.logRef} />\n          {indigoVerification && (\n            <div className={classes.spinnerOverlay}>\n              <Spinner />\n            </div>\n          )}\n        </ContextMenuTrigger>\n        <FGContextMenu />\n      </Tag>\n    )\n  }\n}\n\nexport default StructEditor\n","/****************************************************************************\n * Copyright 2021 EPAM Systems\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *    http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n ***************************************************************************/\n\nimport { Dialog } from '../../../../components'\nimport Logo from './logo.svg'\nimport classes from './About.module.less'\nimport { connect } from 'react-redux'\n\nfunction AboutDialog(props) {\n  const indigoInfo = props.indigoVersion && props.indigoVersion.split('.r') // Indigo version and build info\n\n  return (\n    <Dialog\n      title=\"About\"\n      className={classes.about}\n      params={props}\n      buttons={['Close']}\n    >\n      <a\n        href=\"http://lifescience.opensource.epam.com/ketcher/\"\n        target=\"_blank\"\n        rel=\"noopener noreferrer\"\n      >\n        <Logo />\n      </a>\n      <dl>\n        <dt>\n          <a\n            href=\"http://lifescience.opensource.epam.com/ketcher/help.html\"\n            target=\"_blank\"\n            rel=\"noopener noreferrer\"\n          >\n            Ketcher\n          </a>\n        </dt>\n        <dd>\n          version\n          <var>{props.version}</var>\n        </dd>\n        <dd>\n          build at <time>{props.buildDate}</time>\n        </dd>\n        {props.indigoVersion ? (\n          <div>\n            <dt>\n              <a\n                href=\"http://lifescience.opensource.epam.com/indigo/\"\n                target=\"_blank\"\n                rel=\"noopener noreferrer\"\n              >\n                Indigo Toolkit\n              </a>\n            </dt>\n            <dd>\n              version\n              <var>{indigoInfo[0]}</var>\n            </dd>\n            <dd>\n              build #<var>{indigoInfo[1]}</var>\n            </dd>\n          </div>\n        ) : (\n          <dd>standalone</dd>\n        )}\n        <dt>\n          <a\n            href=\"http://lifescience.opensource.epam.com/\"\n            target=\"_blank\"\n            rel=\"noopener noreferrer\"\n          >\n            EPAM Life Sciences\n          </a>\n        </dt>\n        <dd>\n          <a\n            href=\"http://lifescience.opensource.epam.com/ketcher/#feedback\"\n            target=\"_blank\"\n            rel=\"noopener noreferrer\"\n          >\n            Feedback\n          </a>\n        </dd>\n      </dl>\n    </Dialog>\n  )\n}\n\nconst mapStateToProps = state => ({ ...state.options.app })\n\nconst About = connect(mapStateToProps)(AboutDialog)\n\nexport default About\n","/****************************************************************************\n * Copyright 2021 EPAM Systems\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *    http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n ***************************************************************************/\n\nimport { Component } from 'react'\n\nimport { omit } from 'lodash/fp'\nimport classes from './input.module.less'\n\nfunction GenericInput({\n  schema,\n  value = '',\n  onChange,\n  type = 'text',\n  ...props\n}) {\n  return (\n    <input\n      type={type}\n      value={value}\n      onInput={onChange}\n      onChange={onChange}\n      {...props}\n    />\n  )\n}\n\nGenericInput.val = function (ev, schema) {\n  const input = ev.target\n  const isNumber =\n    input.type === 'number' ||\n    input.type === 'range' ||\n    (schema && (schema.type === 'number' || schema.type === 'integer'))\n  const value = isNumber ? input.value.replace(/,/g, '.') : input.value\n\n  return isNumber && !isNaN(value - 0) ? value - 0 : value // eslint-disable-line\n}\n\nfunction TextArea({ schema, value, onChange, ...rest }) {\n  return <textarea value={value} onInput={onChange} {...rest} />\n}\n\nTextArea.val = ev => ev.target.value\n\nfunction CheckBox({ schema, value = '', onChange, ...rest }) {\n  return (\n    <input\n      type=\"checkbox\"\n      checked={value}\n      onClick={onChange}\n      onChange={onChange}\n      {...rest}\n    />\n  )\n}\n\nCheckBox.val = function (ev) {\n  ev.stopPropagation()\n  return !!ev.target.checked\n}\n\nfunction Select({\n  schema,\n  value,\n  name,\n  onSelect,\n  className,\n  multiple = false\n}) {\n  return (\n    <select\n      onChange={onSelect}\n      value={value}\n      name={name}\n      multiple={multiple}\n      className={className}\n    >\n      {enumSchema(schema, (title, val) => (\n        <option key={val} value={val}>\n          {title}\n        </option>\n      ))}\n    </select>\n  )\n}\n\nSelect.val = function (ev, schema) {\n  const select = ev.target\n  if (!select.multiple) return enumSchema(schema, select.selectedIndex)\n\n  return [].reduce.call(\n    select.options,\n    (res, o, i) => (!o.selected ? res : [enumSchema(schema, i), ...res]),\n    []\n  )\n}\n\nfunction FieldSet({\n  schema,\n  value,\n  selected,\n  onSelect,\n  type = 'radio',\n  checked,\n  ...rest\n}) {\n  return (\n    <fieldset onClick={onSelect} className=\"radio\">\n      {enumSchema(schema, (title, val) => (\n        <li key={title} className={classes.fieldSetItem}>\n          <label className={classes.fieldSetLabel}>\n            <input\n              type={type}\n              defaultChecked={\n                type === 'radio' ? selected(val, checked) : selected(val, value)\n              }\n              value={typeof val !== 'object' && val}\n              {...rest}\n            />\n            {type === 'checkbox' && (\n              <span className={classes.customCheckbox}></span>\n            )}\n            {title}\n          </label>\n        </li>\n      ))}\n    </fieldset>\n  )\n}\n\nFieldSet.val = function (ev, schema) {\n  const input = ev.target\n  if (ev.target.tagName !== 'INPUT') {\n    ev.stopPropagation()\n    return undefined\n  }\n  // Hm.. looks like premature optimization\n  //      should we inline this?\n  const fieldset = input.parentNode.parentNode.parentNode\n  const result = [].reduce.call(\n    fieldset.querySelectorAll('input'),\n    (res, inp, i) => (!inp.checked ? res : [enumSchema(schema, i), ...res]),\n    []\n  )\n  return input.type === 'radio' ? result[0] : result\n}\n\nfunction enumSchema(schema, cbOrIndex) {\n  const isTypeValue = Array.isArray(schema)\n  if (!isTypeValue && schema.items) schema = schema.items\n\n  if (typeof cbOrIndex === 'function') {\n    return (isTypeValue ? schema : schema.enum).map((item, i) => {\n      const title = isTypeValue\n        ? item.title\n        : schema.enumNames && schema.enumNames[i]\n      return cbOrIndex(\n        title !== undefined ? title : item,\n        item && item.value !== undefined ? item.value : item\n      )\n    })\n  }\n\n  if (!isTypeValue) return schema.enum[cbOrIndex]\n\n  const res = schema[cbOrIndex]\n  return res.value !== undefined ? res.value : res\n}\n\nfunction inputCtrl(component, schema, onChange) {\n  let props = {}\n  if (schema) {\n    // TODO: infer maxLength, min, max, step, etc\n    if (schema.type === 'number' || schema.type === 'integer')\n      props = { type: 'text' }\n  }\n\n  return {\n    onChange: ev => {\n      const val = !component.val ? ev : component.val(ev, schema)\n      onChange(val)\n    },\n    ...props\n  }\n}\n\nfunction singleSelectCtrl(component, schema, onChange) {\n  return {\n    selected: (testVal, value) => value === testVal,\n    onSelect: ev => {\n      const val = !component.val ? ev : component.val(ev, schema)\n      if (val !== undefined) onChange(val)\n    }\n  }\n}\n\nfunction multipleSelectCtrl(component, schema, onChange) {\n  return {\n    multiple: true,\n    selected: (testVal, values) => values && values.indexOf(testVal) >= 0,\n    onSelect: (ev, values) => {\n      if (component.val) {\n        const val = component.val(ev, schema)\n        if (val !== undefined) onChange(val)\n      } else {\n        const i = values ? values.indexOf(ev) : -1\n        if (i < 0) onChange(values ? [ev, ...values] : [ev])\n        else onChange([...values.slice(0, i), ...values.slice(i + 1)])\n      }\n    }\n  }\n}\n\nfunction ctrlMap(component, { schema, multiple, onChange }) {\n  if (\n    !schema ||\n    (!schema.enum && !schema.items && !Array.isArray(schema)) ||\n    schema.type === 'string'\n  )\n    return inputCtrl(component, schema, onChange)\n\n  if (multiple || schema.type === 'array')\n    return multipleSelectCtrl(component, schema, onChange)\n\n  return singleSelectCtrl(component, schema, onChange)\n}\n\nfunction componentMap({ schema, type, multiple }) {\n  if (!schema || (!schema.enum && !schema.items && !Array.isArray(schema))) {\n    if (type === 'checkbox' || (schema && schema.type === 'boolean'))\n      return CheckBox\n\n    return type === 'textarea' ? TextArea : GenericInput\n  }\n  if (multiple || schema.type === 'array')\n    return type === 'checkbox' ? FieldSet : Select\n\n  return type === 'radio' ? FieldSet : Select\n}\n\nfunction shallowCompare(a, b) {\n  for (const key in a) {\n    if (!(key in b)) return true\n  }\n  for (const key in b) {\n    if (a[key] !== b[key]) return true\n  }\n  return false\n}\n\nexport default class Input extends Component {\n  constructor(props) {\n    super(props)\n    const { component } = this.props\n    this.component = component || componentMap(props)\n    this.ctrl = ctrlMap(this.component, props)\n  }\n\n  shouldComponentUpdate({ children, onChange, style, ...nextProps }) {\n    const oldProps = omit(this.props, ['children', 'onChange', 'style'])\n    return shallowCompare(oldProps, nextProps)\n  }\n\n  render() {\n    const { children, onChange, ...props } = this.props\n    const Component = this.component\n    return <Component {...this.ctrl} {...props} />\n  }\n}\n","/****************************************************************************\n * Copyright 2021 EPAM Systems\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *    http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n ***************************************************************************/\n\nimport { Component } from 'react'\n\nimport { FormContext } from '../../../../../contexts'\nimport Input from '../input'\nimport classes from './form.module.less'\nimport clsx from 'clsx'\nimport { connect } from 'react-redux'\nimport jsonschema from 'jsonschema'\nimport { updateFormState } from '../../../state/modal/form'\nimport { useFormContext } from '../../../../../hooks'\n\nclass Form extends Component {\n  constructor(props) {\n    super(props)\n    const { onUpdate, schema, init } = this.props\n\n    this.schema = propSchema(schema, props)\n\n    if (init) {\n      const { valid, errors } = this.schema.serialize(init)\n      const errs = getErrorsObj(errors)\n      const initialState = { ...init, init: true }\n      onUpdate(initialState, valid, errs)\n    }\n  }\n\n  componentDidUpdate(prevProps) {\n    const { schema, result, customValid, ...rest } = this.props\n    if (schema.key && schema.key !== prevProps.schema.key) {\n      this.schema = propSchema(schema, rest)\n      this.schema.serialize(result) // hack: valid first state\n      this.updateState(result)\n    }\n  }\n\n  updateState(newState) {\n    const { onUpdate } = this.props\n    const { instance, valid, errors } = this.schema.serialize(newState)\n    const errs = getErrorsObj(errors)\n    onUpdate(instance, valid, errs)\n  }\n\n  field(name, onChange) {\n    const { result, errors } = this.props\n    const value = result[name]\n    const self = this\n    return {\n      dataError: errors && errors[name],\n      value,\n      onChange(val) {\n        const newState = Object.assign({}, self.props.result, { [name]: val })\n        self.updateState(newState)\n        if (onChange) onChange(val)\n      }\n    }\n  }\n\n  render() {\n    const { schema, children } = this.props\n\n    return (\n      <form>\n        <FormContext.Provider value={{ schema, stateStore: this }}>\n          {children}\n        </FormContext.Provider>\n      </form>\n    )\n  }\n}\n\nexport default connect(null, dispatch => ({\n  onUpdate: (result, valid, errors) => {\n    dispatch(updateFormState({ result, valid, errors }))\n  }\n}))(Form)\n\nfunction Label({ labelPos, title, children, ...props }) {\n  return (\n    <label {...props}>\n      {title && labelPos !== 'after' ? `${title}:` : ''}\n      {children}\n      {title && labelPos === 'after' ? title : ''}\n    </label>\n  )\n}\n\nfunction Field(props) {\n  const { name, onChange, component, labelPos, ...rest } = props\n  const { schema, stateStore } = useFormContext()\n  const desc = rest.schema || schema.properties[name]\n  const { dataError, ...fieldOpts } = stateStore.field(name, onChange)\n  const Component = component\n  const formField = component ? (\n    <Component name={name} schema={desc} {...fieldOpts} {...rest} />\n  ) : (\n    <Input name={name} schema={desc} {...fieldOpts} {...rest} />\n  )\n\n  if (labelPos === false) return formField\n  return (\n    <Label\n      className={clsx({ [classes.dataError]: dataError })}\n      error={dataError}\n      title={rest.title || desc.title}\n      labelPos={labelPos}\n    >\n      {formField}\n    </Label>\n  )\n}\n\nconst SelectOneOf = props => {\n  const { title, name, schema, ...prop } = props\n\n  const selectDesc = {\n    title,\n    enum: [],\n    enumNames: []\n  }\n\n  Object.keys(schema).forEach(item => {\n    selectDesc.enum.push(item)\n    selectDesc.enumNames.push(schema[item].title || item)\n  })\n\n  return <Field name={name} schema={selectDesc} {...prop} />\n}\n\n//\n\nfunction propSchema(schema, { customValid, serialize = {}, deserialize = {} }) {\n  const validator = new jsonschema.Validator()\n\n  if (customValid) {\n    schema = Object.assign({}, schema) // copy\n    schema.properties = Object.keys(customValid).reduce((res, prop) => {\n      validator.customFormats[prop] = customValid[prop]\n      res[prop] = { format: prop, ...res[prop] }\n      return res\n    }, schema.properties)\n  }\n\n  return {\n    key: schema.key || '',\n    serialize: inst =>\n      validator.validate(inst, schema, {\n        rewrite: serializeRewrite.bind(null, serialize)\n      }),\n    deserialize: inst =>\n      validator.validate(inst, schema, {\n        rewrite: deserializeRewrite.bind(null, deserialize)\n      })\n  }\n}\n\nfunction serializeRewrite(serializeMap, instance, schema) {\n  const res = {}\n  if (typeof instance !== 'object' || !schema.properties) {\n    return instance !== undefined ? instance : schema.default\n  }\n\n  Object.keys(schema.properties).forEach(p => {\n    if (p in instance) res[p] = instance[serializeMap[p]] || instance[p]\n  })\n\n  return res\n}\n\nfunction deserializeRewrite(deserializeMap, instance) {\n  return instance\n}\n\nfunction getInvalidMessage(item) {\n  if (!item.schema.invalidMessage) return item.message\n  return typeof item.schema.invalidMessage === 'function'\n    ? item.schema.invalidMessage(item.instance)\n    : item.schema.invalidMessage\n}\n\nfunction getErrorsObj(errors) {\n  const errs = {}\n  let field\n\n  errors.forEach(item => {\n    field = item.property.split('.')[1]\n    if (!errs[field]) errs[field] = getInvalidMessage(item)\n  })\n\n  return errs\n}\n\nexport { Field, SelectOneOf }\n","/****************************************************************************\n * Copyright 2021 EPAM Systems\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *    http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n ***************************************************************************/\n\nimport React, { Component, ReactNode } from 'react'\n\nimport classes from './Accordion.module.less'\nimport clsx from 'clsx'\nimport { xor } from 'lodash/fp'\n\ninterface AccordionProps {\n  className: string\n  multiple: boolean\n  active: Array<number>\n}\n\ninterface AccordionState {\n  active: Array<number>\n}\n\ninterface GroupProps {\n  caption: string\n  children: ReactNode\n}\n\ninterface ExtendedGroupProps extends GroupProps {\n  isActive: (index: Array<number>) => boolean\n  onActive: (index: Array<number>) => void\n  index: Array<number>\n}\n\nclass Accordion extends Component<AccordionProps, AccordionState> {\n  constructor(props: AccordionProps) {\n    super(props)\n    this.state = {\n      active: props.active || []\n    }\n  }\n  onActive(index: number): void {\n    const { multiple = true } = this.props\n\n    if (!multiple) this.setState({ active: [index] })\n    else\n      this.setState(prevState => ({ active: xor(prevState.active, [index]) }))\n  }\n\n  groupIsActive(index: number): boolean {\n    return this.state.active.includes(index)\n  }\n\n  static Group(props: GroupProps) {\n    const { caption, isActive, onActive, index, children } =\n      props as ExtendedGroupProps\n\n    return (\n      <li\n        className={clsx(classes.accordion_tab, {\n          [classes.hidden]: !isActive(index)\n        })}\n      >\n        <a // eslint-disable-line\n          onClick={() => onActive(index)}\n        >\n          {caption}\n        </a>\n        {children}\n      </li>\n    )\n  }\n  render() {\n    const { children, ...props } = this.props\n    const childrenWithProps = React.Children.map(\n      this.props.children,\n      (child, index) => {\n        // checking isValidElement is the safe way and avoids a typescript error too\n        const props = {\n          isActive: this.groupIsActive.bind(this),\n          onActive: this.onActive.bind(this),\n          index\n        }\n        if (React.isValidElement(child)) {\n          return React.cloneElement(child, props)\n        }\n        return child\n      }\n    )\n    return <ul {...props}>{childrenWithProps}</ul>\n  }\n}\n\nexport default Accordion\n","/****************************************************************************\n * Copyright 2021 EPAM Systems\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *    http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n ***************************************************************************/\n\nimport { useCallback, useState } from 'react'\n\nimport { HexColorPicker, HexColorInput } from 'react-colorful'\nimport classes from './ColorPicker.module.less'\n\ninterface ColorPickerProps {\n  value: string\n  name: string\n  schema: any\n  type?: string\n}\n\ninterface ColorPickerCallProps {\n  onChange: (value: string) => void\n}\n\ntype Props = ColorPickerProps & ColorPickerCallProps\n\nconst ColorPicker = (props: Props) => {\n  const [isOpen, setIsOpen] = useState(false)\n  const { onChange, value } = props\n\n  const handleChange = useCallback(\n    color => {\n      onChange(color)\n    },\n    [onChange]\n  )\n  const handleClick = () => {\n    setIsOpen(isOpen => !isOpen)\n  }\n  const handleClose = () => {\n    setIsOpen(false)\n  }\n\n  return (\n    <div className={classes.colorPickerInput}>\n      <div\n        className={classes.colorPickerBtn}\n        onClick={handleClick}\n        data-testid=\"color-picker-btn\"\n      >\n        {props.value}\n        <span\n          className={classes.colorPickerPreview}\n          data-testid=\"color-picker-preview\"\n          style={{ backgroundColor: value }}\n        />\n      </div>\n      <div className={classes.colorPickerWrap}>\n        {isOpen ? (\n          <>\n            <div\n              className={classes.colorPickerOverlay}\n              onClick={handleClose}\n              data-testid=\"color-picker-overlay\"\n            />\n            <div className={classes.colorPicker}>\n              <HexColorPicker color={value} onChange={handleChange} />\n              <HexColorInput\n                data-testid=\"color-picker-input\"\n                color={value}\n                onChange={handleChange}\n              />\n            </div>\n          </>\n        ) : null}\n      </div>\n    </div>\n  )\n}\n\nexport default ColorPicker\n","/****************************************************************************\n * Copyright 2021 EPAM Systems\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *    http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n ***************************************************************************/\n\nimport { Component } from 'react'\n\nimport Input from './input'\n\nclass MeasureInput extends Component {\n  constructor(props) {\n    super(props)\n    this.state = {\n      cust: props.value || props.schema.default,\n      meas: 'px'\n    }\n\n    this.calcValue = this.calcValue.bind(this)\n    this.handleChange = this.handleChange.bind(this)\n    this.handleMeasChange = this.handleMeasChange.bind(this)\n  }\n\n  handleChange(value) {\n    const convValue = convertValue(value, this.state.meas, 'px')\n    this.state.cust = value\n    this.props.onChange(convValue)\n  }\n\n  handleMeasChange(m) {\n    this.setState(state => ({\n      meas: m,\n      cust: convertValue(state.cust, state.meas, m)\n    }))\n  }\n\n  calcValue() {\n    this.setState(state => ({\n      cust: convertValue(this.props.value, 'px', state.meas)\n    }))\n  }\n\n  render() {\n    const { meas, cust } = this.state\n    const { schema, value, onChange, ...props } = this.props\n\n    if (meas === 'px' && cust.toFixed() - 0 !== value)\n      this.setState({ meas: 'px', cust: value }) // Hack: Set init value (RESET)\n\n    return (\n      <div style={{ display: 'inline-flex' }} {...props}>\n        <Input\n          schema={schema}\n          step={meas === 'px' || meas === 'pt' ? '1' : '0.001'}\n          style={{ width: '75%' }}\n          value={cust}\n          onChange={this.handleChange}\n          onBlur={this.calcValue}\n        />\n        <Input\n          schema={{ enum: ['cm', 'px', 'pt', 'inch'] }}\n          style={{ width: '25%' }}\n          value={meas}\n          onChange={this.handleMeasChange}\n        />\n      </div>\n    )\n  }\n}\n\nconst measureMap = {\n  px: 1,\n  cm: 37.795278,\n  pt: 1.333333,\n  inch: 96\n}\n\nfunction convertValue(value, measureFrom, measureTo) {\n  if ((!value && value !== 0) || isNaN(value)) return null // eslint-disable-line\n\n  return measureTo === 'px' || measureTo === 'pt'\n    ? ((value * measureMap[measureFrom]) / measureMap[measureTo]).toFixed() - 0\n    : ((value * measureMap[measureFrom]) / measureMap[measureTo]).toFixed(3) - 0\n}\n\nexport default MeasureInput\n","/****************************************************************************\n * Copyright 2021 EPAM Systems\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *    http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n ***************************************************************************/\n\nimport { Component } from 'react'\n\nimport classes from './buttons.module.less'\n\nclass OpenButton extends Component {\n  constructor(props) {\n    super(props)\n    this.state = {}\n    if (props.server) {\n      fileOpener(props.server).then(opener => {\n        this.setState({ opener })\n      })\n    }\n  }\n\n  open(ev) {\n    const files = ev.target.files\n    const noop = () => null\n    const { onLoad = noop, onError = noop } = this.props\n\n    if (this.state.opener && files.length)\n      this.state.opener(files[0]).then(onLoad, onError)\n    else if (files.length) onLoad(files[0])\n    ev.target.value = null\n    ev.preventDefault()\n  }\n\n  render() {\n    const { children, type, server, ...props } = this.props\n\n    return (\n      <button\n        onClick={() => this.btn.click()}\n        className={classes.openButton}\n        {...props}\n      >\n        <input\n          onChange={ev => this.open(ev)}\n          accept={type}\n          type=\"file\"\n          ref={el => {\n            this.btn = el\n          }}\n        />\n        {children}\n      </button>\n    )\n  }\n}\n\nfunction fileOpener(server) {\n  return new Promise((resolve, reject) => {\n    // TODO: refactor return\n    if (global.FileReader) {\n      resolve(throughFileReader)\n    } else if (global.ActiveXObject) {\n      try {\n        const fso = new ActiveXObject('Scripting.FileSystemObject') // eslint-disable-line no-undef\n        resolve(file => Promise.resolve(throughFileSystemObject(fso, file)))\n      } catch (e) {\n        reject(e)\n      }\n    } else if (server) {\n      resolve(\n        server.then(() => {\n          throw Error(\"Server doesn't still support echo method\")\n          // return resolve(throughForm2IframePosting);\n        })\n      )\n    } else {\n      reject(new Error('Your browser does not support opening files locally'))\n    }\n  })\n}\n\nfunction throughFileReader(file) {\n  return new Promise((resolve, reject) => {\n    const rd = new FileReader() // eslint-disable-line no-undef\n\n    rd.onload = () => {\n      const content = rd.result\n      if (file.msClose) file.msClose()\n      resolve(content)\n    }\n\n    rd.onerror = event => {\n      reject(event)\n    }\n\n    rd.readAsText(file, 'UTF-8')\n  })\n}\n\nfunction throughFileSystemObject(fso, file) {\n  // IE9 and below\n  const fd = fso.OpenTextFile(file.name, 1)\n  const content = fd.ReadAll()\n  fd.Close()\n  return content\n}\n\nexport default OpenButton\n","/****************************************************************************\n * Copyright 2021 EPAM Systems\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *    http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n ***************************************************************************/\n\nimport { saveAs } from 'file-saver'\nimport { useAppContext } from '../../../../hooks'\n\nconst SaveButton = props => {\n  const noop = () => null\n  const {\n    server,\n    filename = 'unnamed',\n    outputFormat,\n    data,\n    type,\n    mode = 'saveFile',\n    onSave = noop,\n    onError = noop\n  } = props\n  const { getKetcherInstance } = useAppContext()\n\n  const save = event => {\n    event.preventDefault()\n    switch (mode) {\n      case 'saveImage':\n        saveImage()\n        break\n      case 'saveFile':\n      default:\n        saveFile()\n    }\n  }\n\n  const saveFile = () => {\n    if (data) {\n      try {\n        fileSaver(server).then(saver => {\n          saver(data, filename, type)\n          onSave()\n        })\n      } catch (error) {\n        onError(error)\n      }\n    }\n  }\n\n  const saveImage = () => {\n    const ketcherInstance = getKetcherInstance()\n    ketcherInstance\n      .generateImage(data, { outputFormat })\n      .then(blob => {\n        saveAs(blob, `${filename}.${outputFormat}`)\n        onSave()\n      })\n      .catch(error => {\n        onError(error)\n      })\n  }\n\n  return (\n    <button\n      onClick={event => {\n        save(event)\n      }}\n      {...props}\n    >\n      {props.children}\n    </button>\n  )\n}\n\nconst fileSaver = server => {\n  return new Promise((resolve, reject) => {\n    if (global.Blob && saveAs) {\n      resolve((data, fn, type) => {\n        const blob = new Blob([data], { type }) // eslint-disable-line no-undef\n        saveAs(blob, fn)\n      })\n    } else if (server) {\n      resolve(\n        server.then(() => {\n          throw Error(\"Server doesn't still support echo method\")\n        })\n      )\n    } else {\n      reject(new Error('Your browser does not support opening files locally'))\n    }\n  })\n}\n\nexport default SaveButton\n","/****************************************************************************\n * Copyright 2021 EPAM Systems\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *    http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n ***************************************************************************/\n\nimport Input from './input'\n\nfunction SelectCheckbox({ schema, ...props }) {\n  let currentSchema = schema\n  if (schema.type === 'boolean') {\n    currentSchema = {\n      title: schema.title,\n      enum: [true, false],\n      enumNames: ['on', 'off'],\n      default: schema.default\n    }\n  }\n\n  return <Input schema={currentSchema} {...props} />\n}\n\nexport default SelectCheckbox\n","/****************************************************************************\n * Copyright 2021 EPAM Systems\n *\n * Licensed under the Apache License, Version 2.0 (the 'License');\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *    http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an 'AS IS' BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n ***************************************************************************/\n\nimport { useCallback, useEffect, useState } from 'react'\n\nimport FontFaceObserver from 'font-face-observer'\n\nconst commonFonts = [\n  'Arial',\n  'Arial Black',\n  'Comic Sans MS',\n  'Courier New',\n  'Georgia',\n  'Impact',\n  'Charcoal',\n  'Lucida Console',\n  'Monaco',\n  'Palatino Linotype',\n  'Book Antiqua',\n  'Palatino',\n  'Tahoma',\n  'Geneva',\n  'Times New Roman',\n  'Times',\n  'Verdana',\n  'Symbol',\n  'MS Serif',\n  'MS Sans Serif',\n  'New York',\n  'Droid Sans',\n  'Droid Serif',\n  'Droid Sans Mono',\n  'Roboto'\n]\n\nfunction checkInSystem() {\n  const availableFontsPromises = commonFonts.map(fontName => {\n    const observer = new FontFaceObserver(fontName)\n    return observer.check().then(\n      () => fontName,\n      () => null\n    )\n  })\n\n  return Promise.all(availableFontsPromises)\n}\n\nfunction SystemFonts(props) {\n  const [availableFonts, setAvailableFonts] = useState(null)\n  const { value, onChange } = props\n  const onChangeCallback = useCallback(\n    e => {\n      onChange(e.target.value)\n    },\n    [onChange]\n  )\n\n  useEffect(() => {\n    let mounted = true\n    checkInSystem().then(results => {\n      const fonts = results\n        .filter(i => i !== null)\n        .map(font => {\n          return { value: `30px ${font}`, label: font }\n        })\n      if (mounted) {\n        setAvailableFonts(fonts)\n      }\n    })\n\n    return () => (mounted = false)\n  }, [])\n\n  return (\n    <select\n      disabled={availableFonts == null}\n      value={value}\n      onChange={onChangeCallback}\n    >\n      {availableFonts?.map(({ value, label }) => (\n        <option key={value} value={value}>\n          {label}\n        </option>\n      ))}\n    </select>\n  )\n}\n\nexport default SystemFonts\n","/****************************************************************************\n * Copyright 2021 EPAM Systems\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *    http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n ***************************************************************************/\n\nimport { BaseCallProps, BaseProps } from '../../../modal.types'\nimport Form, { Field } from '../../../../../component/form/form/form'\nimport {\n  setDefaultSettings,\n  updateFormState\n} from '../../../../../state/modal/form'\n\nimport Accordion from './components/Accordion'\nimport ColorPicker from '../../../../../component/form/colorPicker/ColorPicker'\nimport { Dialog } from '../../../../components'\nimport MeasureInput from '../../../../../component/form/measure-input'\nimport OpenButton from '../../../../../component/view/openbutton'\nimport SaveButton from '../../../../../component/view/savebutton'\nimport SelectCheckbox from '../../../../../component/form/select-checkbox'\nimport { StructService } from 'ketcher-core'\nimport SystemFonts from '../../../../../component/form/systemfonts'\nimport classes from './Settings.module.less'\nimport { connect } from 'react-redux'\nimport { saveSettings } from '../../../../../state/options'\nimport settingsSchema from '../../../../../data/schema/options-schema'\nimport { storage } from '../../../../../storage-ext'\n\ninterface SettingsProps extends BaseProps {\n  initState: any\n  appOpts: {\n    version: string\n    buildDate: string\n    buildNumber: string\n    indigoVersion: string\n    imagoVersions: Array<string>\n    server: boolean\n    templates: boolean\n  }\n  server: StructService\n}\n\ninterface SettingsCallProps extends BaseCallProps {\n  onOpenFile: (any) => void\n  onReset: () => void\n}\n\ntype Props = SettingsProps & SettingsCallProps\n\nconst SettingsDialog = (props: Props) => {\n  const {\n    initState,\n    formState,\n    server,\n    onOpenFile,\n    onReset,\n    appOpts,\n    ...prop\n  } = props\n\n  return (\n    <Dialog\n      title=\"Settings\"\n      className={classes.settings}\n      result={() => formState.result}\n      valid={() => formState.valid}\n      params={prop}\n      buttons={[\n        <OpenButton key=\"settings\" server={server} onLoad={onOpenFile}>\n          Open From File‚Ä¶\n        </OpenButton>,\n        <SaveButton\n          key=\"ketcher-settings\"\n          data={JSON.stringify(formState.result)}\n          filename=\"ketcher-settings\"\n        >\n          Save To File‚Ä¶\n        </SaveButton>,\n        <button key=\"settings-button\" onClick={onReset}>\n          Reset\n        </button>,\n        'Cancel',\n        'OK'\n      ]}\n    >\n      <Form schema={settingsSchema} init={initState} {...formState}>\n        <Accordion className={classes.accordion} multiple={false} active={[0]}>\n          <Accordion.Group caption=\"General\">\n            <fieldset className={classes.general}>\n              <Field name=\"resetToSelect\" />\n              <Field name=\"rotationStep\" />\n              <Field name=\"showValenceWarnings\" component={SelectCheckbox} />\n              <Field name=\"atomColoring\" component={SelectCheckbox} />\n              <Field name=\"font\" component={SystemFonts} />\n              <Field name=\"fontsz\" component={MeasureInput} />\n              <Field name=\"fontszsub\" component={MeasureInput} />\n            </fieldset>\n          </Accordion.Group>\n          <Accordion.Group caption=\"Stereochemistry\">\n            <fieldset className={classes.stereochemistry}>\n              <Field name=\"showStereoFlags\" component={SelectCheckbox} />\n              <Field name=\"stereoLabelStyle\" />\n              <Field name=\"colorOfAbsoluteCenters\" component={ColorPicker} />\n              <Field name=\"colorOfAndCenters\" component={ColorPicker} />\n              <Field name=\"colorOfOrCenters\" component={ColorPicker} />\n              <Field name=\"colorStereogenicCenters\" />\n              <Field name=\"autoFadeOfStereoLabels\" component={SelectCheckbox} />\n              <Field name=\"absFlagLabel\" />\n              <Field name=\"andFlagLabel\" />\n              <Field name=\"orFlagLabel\" />\n              <Field name=\"mixedFlagLabel\" />\n            </fieldset>\n          </Accordion.Group>\n          <Accordion.Group caption=\"Atoms\">\n            <fieldset>\n              <Field name=\"carbonExplicitly\" component={SelectCheckbox} />\n              <Field name=\"showCharge\" component={SelectCheckbox} />\n              <Field name=\"showValence\" component={SelectCheckbox} />\n              <Field name=\"showHydrogenLabels\" component={SelectCheckbox} />\n            </fieldset>\n          </Accordion.Group>\n          <Accordion.Group caption=\"Bonds\">\n            <fieldset>\n              <Field name=\"aromaticCircle\" component={SelectCheckbox} />\n              <Field name=\"doubleBondWidth\" component={MeasureInput} />\n              <Field name=\"bondThickness\" component={MeasureInput} />\n              <Field name=\"stereoBondWidth\" component={MeasureInput} />\n            </fieldset>\n          </Accordion.Group>\n          <Accordion.Group caption=\"Server\">\n            <fieldset className={classes.server} disabled={!appOpts.server}>\n              <Field name=\"smart-layout\" component={SelectCheckbox} />\n              <Field\n                name=\"ignore-stereochemistry-errors\"\n                component={SelectCheckbox}\n              />\n              <Field\n                name=\"mass-skip-error-on-pseudoatoms\"\n                component={SelectCheckbox}\n              />\n              <Field\n                name=\"gross-formula-add-rsites\"\n                component={SelectCheckbox}\n              />\n              <Field\n                name=\"gross-formula-add-isotopes\"\n                component={SelectCheckbox}\n              />\n            </fieldset>\n          </Accordion.Group>\n          <Accordion.Group caption=\"3D Viewer\">\n            <fieldset className={classes.viewer} disabled={!window['Miew']}>\n              <Field name=\"miewMode\" />\n              <Field name=\"miewTheme\" />\n              <Field name=\"miewAtomLabel\" />\n            </fieldset>\n          </Accordion.Group>\n          <Accordion.Group caption=\"Options for debugging\">\n            <fieldset>\n              <Field name=\"showAtomIds\" component={SelectCheckbox} />\n              <Field name=\"showBondIds\" component={SelectCheckbox} />\n              <Field name=\"showHalfBondIds\" component={SelectCheckbox} />\n              <Field name=\"showLoopIds\" component={SelectCheckbox} />\n            </fieldset>\n          </Accordion.Group>\n        </Accordion>\n        {!storage.isAvailable() ? (\n          <div className={classes.warning}>{storage.warningMessage}</div>\n        ) : null}\n      </Form>\n    </Dialog>\n  )\n}\n\nconst mapStateToProps = state => ({\n  server: state.options.app.server ? state.server : null,\n  appOpts: state.options.app,\n  initState: state.options.settings,\n  formState: state.modal.form\n})\n\nconst mapDispatchToProps = (dispatch, ownProps) => ({\n  onOpenFile: newOpts => {\n    try {\n      dispatch(updateFormState({ result: JSON.parse(newOpts) }))\n    } catch (ex) {\n      console.info('Bad file')\n    }\n  },\n  onReset: () => dispatch(setDefaultSettings()),\n  onOk: res => {\n    dispatch(saveSettings(res))\n    ownProps.onOk(res)\n  }\n})\n\nconst Settings = connect(mapStateToProps, mapDispatchToProps)(SettingsDialog)\n\nexport default Settings\n","/****************************************************************************\n * Copyright 2021 EPAM Systems\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *    http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n ***************************************************************************/\n\nfunction ErrorsCheck(props) {\n  const { moleculeErrors, checkSchema } = props\n  const moleculeErrorsTypes = Object.keys(moleculeErrors)\n\n  const getOptionName = option => {\n    const { items } = checkSchema.properties.checkOptions\n    const nameIndex = items.enum.indexOf(option)\n    return items.enumNames[nameIndex]\n  }\n\n  return (\n    <fieldset>\n      {moleculeErrorsTypes.length === 0 ? (\n        <dt>No errors found</dt>\n      ) : (\n        moleculeErrorsTypes.map(type => (\n          <div>\n            <dt>{getOptionName(type)} warning:</dt>\n            <dd>{moleculeErrors[type]}</dd>\n          </div>\n        ))\n      )}\n    </fieldset>\n  )\n}\n\nexport default ErrorsCheck\n","/****************************************************************************\n * Copyright 2021 EPAM Systems\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *    http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n ***************************************************************************/\n\nimport { Component } from 'react'\n\nimport classes from './Tabs.module.less'\nimport clsx from 'clsx'\n\nclass Tabs extends Component {\n  constructor(props) {\n    super(props)\n    this.state = {}\n    this.state.tabIndex = props.tabIndex || 0\n    this.props.changeTab(this.state.tabIndex)\n  }\n\n  //TODO: refactor the component\n  changeTab(ev, index) {\n    this.setState({ tabIndex: index })\n    if (this.props.changeTab) this.props.changeTab(index)\n  }\n\n  render() {\n    const { tabs, contentClassName, className, tabIndex } = this.props\n    const tabPanel = tabs[this.state.tabIndex]\n    const Component = tabPanel?.component\n    const componentProps = tabPanel?.props\n    return (\n      <div>\n        <ul className={className} tabIndex={tabIndex}>\n          <li className={classes.tabs}>\n            {tabs.map((tabPanel, index) => (\n              <a // eslint-disable-line\n                key={index}\n                className={clsx({\n                  [classes.active]: this.state.tabIndex === index\n                })}\n                onClick={ev => this.changeTab(ev, index)}\n              >\n                {tabPanel.caption}\n              </a>\n            ))}\n          </li>\n        </ul>\n        {tabPanel && (\n          <div className={contentClassName}>\n            <Component {...componentProps} />\n          </div>\n        )}\n      </div>\n    )\n  }\n}\n\nexport default Tabs\n","/****************************************************************************\n * Copyright 2021 EPAM Systems\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *    http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n ***************************************************************************/\n\nimport Form, { Field } from '../../../../../component/form/form/form'\n\nimport { Dialog } from '../../../../components'\nimport ErrorsCheck from './components'\nimport Tabs from '../../../../../component/view/Tabs'\nimport { check } from '../../../../../state/server'\nimport { checkOpts } from '../../../../../state/options'\nimport { connect } from 'react-redux'\nimport style from './Check.module.less'\n\nconst checkSchema = {\n  title: 'Check',\n  type: 'object',\n  properties: {\n    checkOptions: {\n      type: 'array',\n      items: {\n        type: 'string',\n        enum: [\n          'valence',\n          'radicals',\n          'pseudoatoms',\n          'stereo',\n          'query',\n          'overlapping_atoms',\n          'overlapping_bonds',\n          'rgroups',\n          'chiral',\n          '3d',\n          'chiral_flag'\n        ],\n        enumNames: [\n          'Valence',\n          'Radical',\n          'Pseudoatom',\n          'Stereochemistry',\n          'Query',\n          'Overlapping Atoms',\n          'Overlapping Bonds',\n          'R-Groups',\n          'Chirality',\n          '3D Structure',\n          'Chiral flag'\n        ]\n      }\n    }\n  }\n}\n\nfunction CheckDialog(props) {\n  const { formState, checkState, onCheck, ...prop } = props\n  const { result = checkState, moleculeErrors } = formState\n  const tabs = [\n    {\n      caption: 'Check',\n      component: ErrorsCheck,\n      props: { moleculeErrors, checkSchema }\n    },\n    {\n      caption: 'Settings',\n      component: Field,\n      props: {\n        name: 'checkOptions',\n        multiple: true,\n        type: 'checkbox',\n        labelPos: false\n      }\n    }\n  ]\n\n  return (\n    <Dialog\n      title=\"Structure Check\"\n      className={style.check}\n      result={() => result}\n      params={prop}\n    >\n      <Form schema={checkSchema} init={checkState} {...formState}>\n        <Tabs\n          className={style.tabs}\n          captions={tabs}\n          changeTab={i => (i === 0 ? onCheck(result.checkOptions) : null)}\n          tabs={tabs}\n        >\n          <ErrorsCheck\n            moleculeErrors={moleculeErrors}\n            checkSchema={checkSchema}\n          />\n          <Field\n            name=\"checkOptions\"\n            multiple\n            type=\"checkbox\"\n            labelPos={false}\n          />\n        </Tabs>\n      </Form>\n    </Dialog>\n  )\n}\n\nconst mapStateToProps = state => ({\n  formState: state.modal.form,\n  checkState: state.options.check\n})\n\nconst mapDispatchToProps = (dispatch, ownProps) => ({\n  onCheck: opts => dispatch(check(opts)).catch(ownProps.onCancel),\n  onOk: res => {\n    dispatch(checkOpts(res))\n    ownProps.onOk(res)\n  }\n})\n\nconst Check = connect(mapStateToProps, mapDispatchToProps)(CheckDialog)\n\nexport default Check\n","/****************************************************************************\n * Copyright 2021 EPAM Systems\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *    http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n ***************************************************************************/\n\nimport styles from './FormulaInput.module.less'\n\nconst formulaRegexp = /\\b(\\d*)([A-Z][a-z]{0,3}#?)(\\d*)\\s*\\b/g\nconst errorRegexp = /error:.*/g\n\nfunction formulaInputMarkdown(content) {\n  const onKeyDown = e => {\n    if (e.keyCode === 8) {\n      e.preventDefault()\n      return false\n    }\n  }\n  return (\n    <div\n      className={styles.chem_input}\n      onKeyPress={e => e.preventDefault()}\n      onPaste={e => e.preventDefault()}\n      onKeyDown={onKeyDown}\n      contentEditable={true}\n      suppressContentEditableWarning={true}\n    >\n      {content}\n    </div>\n  )\n}\n\nfunction FormulaInput({ value }) {\n  if (errorRegexp.test(value)) return formulaInputMarkdown(value)\n\n  const content = []\n  let cnd\n  let pos = 0\n\n  while ((cnd = formulaRegexp.exec(value)) !== null) {\n    if (cnd[1].length > 0)\n      content.push(<sup key={content.length}>{cnd[1]}</sup>)\n    content.push(value.substring(pos, cnd.index) + cnd[2])\n    if (cnd[3].length > 0)\n      content.push(<sub key={content.length}>{cnd[3]}</sub>)\n    pos = cnd.index + cnd[0].length\n  }\n\n  if (pos === 0) content.push(value)\n  else content.push(value.substring(pos, value.length))\n\n  return formulaInputMarkdown(content)\n}\n\nexport default FormulaInput\n","/****************************************************************************\n * Copyright 2021 EPAM Systems\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *    http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n ***************************************************************************/\n\nfunction FrozenInput({ value }) {\n  return (\n    <input\n      type=\"text\"\n      spellCheck={false}\n      value={value}\n      onChange={event => event.preventDefault()}\n    />\n  )\n}\n\nexport default FrozenInput\n","/****************************************************************************\n * Copyright 2021 EPAM Systems\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *    http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n ***************************************************************************/\n\nimport { FormulaInput, FrozenInput } from './components'\nimport { Component } from 'react'\n\nimport { Dialog } from '../../../../components'\nimport { ErrorsContext } from '../../../../../../../contexts'\nimport Input from '../../../../../component/form/input'\nimport { analyse } from '../../../../../state/server'\nimport { changeRound } from '../../../../../state/options'\nimport classes from './Analyse.module.less'\nimport { connect } from 'react-redux'\nimport { range } from 'lodash/fp'\n\nfunction roundOff(value, round) {\n  if (typeof value === 'number') return value.toFixed(round)\n  return value.replace(/[0-9]*\\.[0-9]+/g, str => (+str).toFixed(round))\n}\n\nclass AnalyseDialog extends Component {\n  static contextType = ErrorsContext\n  constructor(props) {\n    super(props)\n  }\n\n  componentDidMount() {\n    this.props.onAnalyse()\n  }\n\n  render() {\n    const { values, round, loading, onAnalyse, onChangeRound, ...props } =\n      this.props\n    return (\n      <Dialog\n        title=\"Calculated Values\"\n        className={classes.analyse}\n        buttons={['Close']}\n        params={props}\n      >\n        <ul>\n          {[\n            {\n              name: 'Chemical Formula',\n              key: 'gross',\n              withSelector: false\n            },\n            {\n              name: 'Molecular Weight',\n              key: 'molecular-weight',\n              round: 'roundWeight',\n              withSelector: true\n            },\n            {\n              name: 'Exact Mass',\n              key: 'monoisotopic-mass',\n              round: 'roundMass',\n              withSelector: true\n            },\n            {\n              name: 'Elemental Analysis',\n              key: 'mass-composition',\n              round: 'roundElAnalysis',\n              withSelector: false\n            }\n          ].map(item => (\n            <li key={item.key}>\n              <label>{item.name}:</label>\n              {item.key === 'gross' ? (\n                <FormulaInput\n                  value={values && !loading ? values[item.key] : ''}\n                />\n              ) : (\n                <FrozenInput\n                  value={\n                    values && !loading\n                      ? roundOff(values[item.key], round[item.round])\n                      : 0\n                  }\n                />\n              )}\n              {item.withSelector ? (\n                <Input\n                  schema={{\n                    enum: range(0, 8),\n                    enumNames: range(0, 8).map(i => `${i} decimal places`)\n                  }}\n                  value={round[item.round]}\n                  onChange={val => onChangeRound(item.round, val)}\n                />\n              ) : null}\n            </li>\n          ))}\n        </ul>\n      </Dialog>\n    )\n  }\n}\n\nconst mapStateToProps = state => ({\n  values: state.options.analyse.values,\n  loading: state.options.analyse.loading,\n  round: {\n    roundWeight: state.options.analyse.roundWeight,\n    roundMass: state.options.analyse.roundMass,\n    roundElAnalysis: state.options.analyse.roundElAnalysis\n  }\n})\n\nconst mapDispatchToProps = dispatch => ({\n  onAnalyse: () => dispatch(analyse()),\n  onChangeRound: (roundName, val) => dispatch(changeRound(roundName, val))\n})\n\nconst Analyse = connect(mapStateToProps, mapDispatchToProps)(AnalyseDialog)\n\nexport default Analyse\n","/****************************************************************************\n * Copyright 2021 EPAM Systems\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *    http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n ***************************************************************************/\n\nimport classes from './spin.module.less'\n\nfunction Spin({ ...props }) {\n  return <div className={classes.ketSpinner} {...props} />\n}\n\nexport default Spin\n","/****************************************************************************\n * Copyright 2021 EPAM Systems\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *    http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n ***************************************************************************/\n\nimport { Component, createRef } from 'react'\nimport { MolSerializer, Render, Struct } from 'ketcher-core'\n\nfunction renderStruct(el, struct, options = {}) {\n  if (el) {\n    if (struct?.prerender) {\n      // Should it sit here?\n      el.innerHTML = struct.prerender\n    } else if (struct) {\n      console.info('render!', el.clientWidth, el.clientWidth)\n      const rnd = new Render(el, {\n        autoScale: true,\n        ...options\n      })\n      rnd.setMolecule(struct)\n      rnd.update()\n      // console.info('render!');//, el.innerHTML);\n      // struct.prerender = el.innerHTML;\n    }\n  }\n}\n\nclass StructRender extends Component {\n  constructor(props) {\n    super(props)\n    this.tagRef = createRef()\n  }\n\n  shouldComponentUpdate() {\n    return false\n  }\n\n  componentDidMount() {\n    const el = this.tagRef.current\n    const { struct, options } = this.props\n    let parsedStruct\n    if (!(struct instanceof Struct)) {\n      try {\n        const molSerialzer = new MolSerializer()\n        parsedStruct = molSerialzer.deserialize(struct)\n      } catch (e) {\n        //TODO: add error handler call\n        //legacy message: Could not parse structure\n        parsedStruct = null\n      }\n    } else {\n      parsedStruct = struct\n    }\n    renderStruct(el, parsedStruct, options)\n  }\n\n  render() {\n    const { struct, Tag = 'div', ...props } = this.props\n    return (\n      <Tag ref={this.tagRef} /* ref=\"el\" */ {...props}>\n        {struct ? null : 'No molecule'}\n      </Tag>\n    )\n  }\n}\n\nexport default StructRender\n","/****************************************************************************\n * Copyright 2021 EPAM Systems\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *    http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n ***************************************************************************/\n\nimport { useCallback, useState } from 'react'\nimport {\n  changeImage,\n  changeVersion,\n  shouldFragment\n} from '../../../../../state/options'\n\nimport { Dialog } from '../../../../components'\nimport Input from '../../../../../component/form/input'\nimport OpenButton from '../../../../../component/view/openbutton'\nimport Spin from '../../../../../component/view/spin'\nimport StructRender from '../../../../../component/structrender'\nimport classes from './Recognize.module.less'\nimport { connect } from 'react-redux'\nimport { load } from '../../../../../state'\nimport { range } from 'lodash/fp'\nimport { recognize } from '../../../../../state/server'\n\nfunction isImage(file) {\n  return file?.type?.includes('image')\n}\n\nfunction RecognizeDialog(prop) {\n  const { file, structStr, fragment, version, imagoVersions, ...partProps } =\n    prop\n  const { onRecognize, isFragment, onImage, onChangeImago, ...props } =\n    partProps\n  const [canPreviewImage, setCanPreviewImage] = useState(true)\n  const result = () =>\n    structStr && !(structStr instanceof Promise)\n      ? { structStr, fragment }\n      : null\n\n  const clearFile = useCallback(() => {\n    onImage(null)\n    return true\n  }, [onImage])\n\n  return (\n    <Dialog\n      title=\"Import From Image\"\n      className={classes.recognize}\n      params={props}\n      result={() => result(structStr, fragment)}\n      buttons={[\n        <OpenButton key=\"choose\" onLoad={onImage} type=\"image/*\">\n          Choose file‚Ä¶\n        </OpenButton>,\n        <span key=\"open-file\" className={classes.open_filename}>\n          {file ? file.name : null}\n        </span>,\n        file && (\n          <button\n            key=\"recognize\"\n            onClick={() => onRecognize(file, version)}\n            disabled={structStr && typeof structStr !== 'string'}\n          >\n            Recognize\n          </button>\n        ),\n        'Cancel',\n        'OK'\n      ]}\n    >\n      <label className={classes.change_version}>\n        Imago version:\n        <Input\n          schema={{\n            enum: imagoVersions,\n            enumNames: range(1, imagoVersions.length + 1).map(\n              i => `Version ${i}`\n            )\n          }}\n          value={version}\n          onChange={onChangeImago}\n        />\n      </label>\n      <div className={classes.picture}>\n        {file && isImage(file) && canPreviewImage && (\n          <img\n            alt=\"\"\n            id=\"pic\"\n            src={url(file) || ''}\n            onError={() => {\n              setCanPreviewImage(false)\n            }}\n          />\n        )}\n        {file && isImage(file) && !canPreviewImage && (\n          <div>\n            Preview of '{file.type}' MIME type does not supported by current\n            browser\n          </div>\n        )}\n        {(!file || (!isImage(file) && clearFile())) && (\n          <div>Please choose image</div>\n        )}\n      </div>\n      <div className={classes.output}>\n        {structStr &&\n          // in Edge 38: instanceof Promise always `false`\n          (structStr instanceof Promise || typeof structStr !== 'string' ? (\n            <Spin />\n          ) : (\n            <StructRender className={classes.struct} struct={structStr} />\n          ))}\n      </div>\n      <label>\n        <Input type=\"checkbox\" value={fragment} onChange={isFragment} />\n        Load as a fragment\n      </label>\n    </Dialog>\n  )\n}\n\nfunction url(file) {\n  if (!file) return null\n  const URL = window.URL || window.webkitURL\n  return URL ? URL.createObjectURL(file) : 'No preview'\n}\n\nconst mapStateToProps = state => ({\n  imagoVersions: state.options.app.imagoVersions,\n  file: state.options.recognize.file,\n  structStr: state.options.recognize.structStr,\n  fragment: state.options.recognize.fragment,\n  version: state.options.recognize.version || state.options.app.imagoVersions[0]\n})\n\nconst mapDispatchToProps = dispatch => ({\n  isFragment: v => dispatch(shouldFragment(v)),\n  onImage: file => dispatch(changeImage(file)),\n  onRecognize: (file, ver) => dispatch(recognize(file, ver)),\n  onChangeImago: ver => dispatch(changeVersion(ver)),\n  onOk: res => {\n    dispatch(\n      load(res.structStr, {\n        rescale: true,\n        fragment: res.fragment\n      })\n      // TODO: Removed ownProps.onOk call. consider refactoring of load function in release 2.4\n      // See PR #731 (https://github.com/epam/ketcher/pull/731)\n    )\n  }\n})\n\nconst Recognize = connect(mapStateToProps, mapDispatchToProps)(RecognizeDialog)\n\nexport default Recognize\n","/****************************************************************************\n * Copyright 2021 EPAM Systems\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *    http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n ***************************************************************************/\n\nimport { Component } from 'react'\n\nimport { Dialog } from '../../../../components'\nimport { FormatterFactory } from 'ketcher-core'\nimport { MIEW_OPTIONS } from '../../../../../data/schema/options-schema'\nimport classes from './Miew.module.less'\nimport { connect } from 'react-redux'\nimport { load } from '../../../../../state'\nimport { pick } from 'lodash/fp'\n\n/* OPTIONS for MIEW */\nconst BACKGROUND_COLOR = {\n  dark: '0x202020',\n  light: '0xcccccc'\n}\n\nconst MIEW_TX_TYPES = {\n  no: null,\n  bright: {\n    colorer: 'EL'\n  },\n  blackAndWhite: {\n    colorer: ['UN', { color: 0xffffff }],\n    bg: '0x000'\n  },\n  black: {\n    colorer: ['UN', { color: 0x000000 }]\n  }\n}\n\nconst TXoptions = userOpts => {\n  const type = userOpts.miewAtomLabel\n  if (MIEW_TX_TYPES[type] === null) return null\n  return {\n    colorer: MIEW_TX_TYPES[type].colorer,\n    selector: 'not elem C',\n    mode: [\n      'TX',\n      {\n        bg: MIEW_TX_TYPES[type].bg || BACKGROUND_COLOR[userOpts.miewTheme],\n        showBg: true,\n        template: '{{elem}}'\n      }\n    ]\n  }\n}\n\nfunction createMiewOptions(userOpts) {\n  const options = {\n    settings: {\n      bg: { color: Number(BACKGROUND_COLOR[userOpts.miewTheme]) },\n      autoPreset: false,\n      editing: true,\n      inversePanning: true\n    },\n    reps: [\n      {\n        mode: userOpts.miewMode\n      }\n    ]\n  }\n\n  const textMode = TXoptions(userOpts)\n  if (textMode) options.reps.push(textMode)\n\n  return options\n}\n/* ---------------- */\nconst CHANGING_WARNING =\n  'Stereocenters can be changed after the strong 3D rotation'\n\nclass MiewDialog extends Component {\n  componentDidMount() {\n    const { struct, server, miewOpts } = this.props\n    const Miew = window.Miew\n\n    this.viewer = new Miew({\n      container: this.miewContainer\n    })\n\n    if (this.viewer.init()) this.viewer.run()\n\n    const factory = new FormatterFactory(server)\n    const service = factory.create('cml')\n\n    service\n      .getStructureFromStructAsync(struct)\n      .then(res =>\n        this.viewer.load(res, { sourceType: 'immediate', fileType: 'cml' })\n      )\n      .then(() => this.viewer.setOptions(miewOpts))\n      .catch(ex => console.error(ex.message))\n  }\n\n  exportCML() {\n    const cmlStruct = this.viewer.exportCML()\n    if (!cmlStruct) {\n      return\n    }\n    this.props.onExportCML(cmlStruct)\n  }\n\n  render() {\n    const { miewOpts, server, struct, ...prop } = this.props\n\n    return (\n      <Dialog\n        title=\"Miew\"\n        params={prop}\n        buttons={[\n          <div key=\"warning\" className={classes.warning}>\n            {CHANGING_WARNING}\n          </div>,\n          'Close',\n          <button key=\"apply\" onClick={() => this.exportCML()}>\n            Apply\n          </button>\n        ]}\n      >\n        <div className={classes.dialog_body}>\n          <div\n            ref={el => {\n              this.miewContainer = el\n            }}\n            className={classes.miewContainer}\n            style={{ width: '1024px', height: '600px', position: 'relative' }}\n          />\n        </div>\n      </Dialog>\n    )\n  }\n}\n\nconst mapStateToProps = state => ({\n  miewOpts: createMiewOptions(pick(MIEW_OPTIONS, state.options.settings)),\n  server: state.options.app.server ? state.server : null,\n  struct: state.editor.struct()\n})\n\nconst mapDispatchToProps = dispatch => ({\n  onExportCML: cmlStruct => {\n    dispatch(load(cmlStruct))\n    // TODO: Removed ownProps.onOk call. consider refactoring of load function in release 2.4\n    // See PR #731 (https://github.com/epam/ketcher/pull/731)\n  }\n})\n\nconst Miew = connect(mapStateToProps, mapDispatchToProps)(MiewDialog)\n\nexport default Miew\n","/****************************************************************************\n * Copyright 2021 EPAM Systems\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *    http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n ***************************************************************************/\n\nimport { Elements } from 'ketcher-core'\nimport { capitalize } from 'lodash/fp'\n\ninterface ElementNumberProps {\n  label: string\n}\n\ntype Props = ElementNumberProps\n\nconst ElementNumber = (props: Props) => {\n  const { label } = props\n  const value = Elements.get(capitalize(label))?.number || ''\n\n  return (\n    <label>\n      Number:\n      <input type=\"text\" readOnly value={value} />\n    </label>\n  )\n}\n\nexport default ElementNumber\n","/****************************************************************************\n * Copyright 2021 EPAM Systems\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *    http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n ***************************************************************************/\n\nimport Atom from './Atom'\nimport { BaseProps } from '../../../modal.types'\nimport { connect } from 'react-redux'\n\ntype StateProps = Pick<BaseProps, 'formState'>\n\nconst mapStateToProps = (state: any): StateProps => ({\n  formState: state.modal.form\n})\n\nconst AtomContainer = connect(mapStateToProps)(Atom)\nexport default AtomContainer\n","/****************************************************************************\n * Copyright 2021 EPAM Systems\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *    http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n ***************************************************************************/\n\nimport { BaseCallProps, BaseProps } from '../../../modal.types'\n\nimport Form, { Field } from '../../../../../component/form/form/form'\nimport { FC, useCallback, useState } from 'react'\n\nimport { Dialog } from '../../../../components'\nimport ElementNumber from './ElementNumber'\nimport { Elements } from 'ketcher-core'\nimport { atom as atomSchema } from '../../../../../data/schema/struct-schema'\nimport { capitalize } from 'lodash/fp'\nimport classes from './Atom.module.less'\n\ninterface AtomProps extends BaseProps {\n  alias: string\n  charge: string\n  exactChangeFlag: boolean\n  explicitValence: number\n  hCount: number\n  invRet: number\n  isotope: number\n  label: string\n  radical: number\n  ringBondCount: number\n  stereoParity: number\n  substitutionCount: number\n  unsaturatedAtom: boolean\n}\n\ntype Props = AtomProps & BaseCallProps\n\nconst Atom: FC<Props> = props => {\n  const { formState, stereoParity, ...rest } = props\n  const [currentLabel, setCurrentLabel] = useState<string>(rest.label)\n\n  const onLabelChangeCallback = useCallback(newValue => {\n    setCurrentLabel(newValue)\n  }, [])\n\n  return (\n    <Dialog\n      title=\"Atom Properties\"\n      className={classes.atomProps}\n      result={() => formState.result}\n      valid={() => formState.valid}\n      params={rest}\n    >\n      <Form\n        schema={atomSchema}\n        customValid={{\n          label: label => atomValid(label),\n          charge: charge => chargeValid(charge)\n        }}\n        init={rest}\n        {...formState}\n      >\n        <fieldset className={classes.main}>\n          <Field name=\"label\" onChange={onLabelChangeCallback} autoFocus />\n          <Field name=\"alias\" />\n          <ElementNumber label={currentLabel} />\n          <Field name=\"charge\" maxLength=\"5\" />\n          <Field name=\"explicitValence\" />\n          <Field name=\"isotope\" />\n          <Field name=\"radical\" />\n        </fieldset>\n        <fieldset className={classes.query}>\n          <legend>Query specific</legend>\n          <Field name=\"ringBondCount\" />\n          <Field name=\"hCount\" />\n          <Field name=\"substitutionCount\" />\n          <Field name=\"unsaturatedAtom\" />\n        </fieldset>\n        <fieldset className={classes.reaction}>\n          <legend>Reaction flags</legend>\n          <Field name=\"invRet\" />\n          <Field name=\"exactChangeFlag\" />\n        </fieldset>\n      </Form>\n    </Dialog>\n  )\n}\n\nfunction atomValid(label) {\n  return label && !!Elements.get(capitalize(label))\n}\n\nfunction chargeValid(charge) {\n  const result = atomSchema.properties.charge.pattern.exec(charge)\n  return result && (result[1] === '' || result[3] === '')\n}\n\nexport type { AtomProps }\nexport default Atom\n","/****************************************************************************\n * Copyright 2021 EPAM Systems\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *    http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n ***************************************************************************/\n\nimport AttachPoints from './Attach'\nimport { BaseProps } from '../../../modal.types'\nimport { connect } from 'react-redux'\n\ntype StateProps = Pick<BaseProps, 'formState'>\n\nconst mapStateToProps = (state: any): StateProps => ({\n  formState: state.modal.form\n})\n\nconst AttachPointsContainer = connect(mapStateToProps)(AttachPoints)\nexport default AttachPointsContainer\n","/****************************************************************************\n * Copyright 2021 EPAM Systems\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *    http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n ***************************************************************************/\n\nimport { BaseCallProps, BaseProps } from '../../../modal.types'\nimport Form, { Field } from '../../../../../component/form/form/form'\nimport { Dialog } from '../../../../components'\nimport { attachmentPoints as attachmentPointsSchema } from '../../../../../data/schema/struct-schema'\nimport classes from './Attach.module.less'\n\ninterface AttachPointsProps extends BaseProps {\n  primary: boolean\n  secondary: boolean\n}\n\ntype Props = AttachPointsProps & BaseCallProps\n\nconst AttachPoints = (props: Props) => {\n  const { formState, ...rest } = props\n  return (\n    <Dialog\n      title=\"Attachment Points\"\n      className={classes.attachPoints}\n      result={() => formState.result}\n      valid={() => formState.valid}\n      params={rest}\n    >\n      <Form schema={attachmentPointsSchema} init={rest} {...formState}>\n        <Field name=\"primary\" />\n        <Field name=\"secondary\" />\n      </Form>\n    </Dialog>\n  )\n}\n\nexport type { AttachPointsProps }\nexport default AttachPoints\n","/****************************************************************************\n * Copyright 2021 EPAM Systems\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *    http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n ***************************************************************************/\n\nimport { BaseCallProps, BaseProps } from '../../../modal.types'\nimport Form, { Field } from '../../../../../component/form/form/form'\nimport { Dialog } from '../../../../components'\nimport classes from './Automap.module.less'\n\ntype Props = BaseProps & BaseCallProps\n\nexport const automapSchema = {\n  title: 'Reaction Auto-Mapping',\n  type: 'object',\n  required: ['mode'],\n  properties: {\n    mode: {\n      title: 'Mode',\n      enum: ['discard', 'keep', 'alter', 'clear'],\n      enumNames: ['Discard', 'Keep', 'Alter', 'Clear'],\n      default: 'discard'\n    }\n  }\n}\n\nconst Automap = (props: Props) => {\n  const { formState, ...rest } = props\n  return (\n    <Dialog\n      title=\"Reaction Auto-Mapping\"\n      className={classes.automap}\n      result={() => formState.result}\n      valid={() => formState.valid}\n      params={rest}\n    >\n      <Form schema={automapSchema} {...formState}>\n        <Field name=\"mode\" />\n      </Form>\n    </Dialog>\n  )\n}\n\nexport default Automap\n","/****************************************************************************\n * Copyright 2021 EPAM Systems\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *    http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n ***************************************************************************/\n\nimport { BaseCallProps, BaseProps } from '../../../modal.types'\n\nimport Automap from './Automap'\nimport { automap } from '../../../../../state/server'\nimport { connect } from 'react-redux'\n\ntype StateProps = Pick<BaseProps, 'formState'>\ntype DispatchProps = Pick<BaseCallProps, 'onOk'>\n\nconst mapStateToProps = (state: any): StateProps => ({\n  formState: state.modal.form\n})\n\nconst mapDispatchToProps = (dispatch: any, ownProps: any): DispatchProps => ({\n  onOk: result => {\n    dispatch(automap(result))\n    ownProps.onOk(result)\n  }\n})\n\nconst AutomapContainer = connect(mapStateToProps, mapDispatchToProps)(Automap)\nexport default AutomapContainer\n","/****************************************************************************\n * Copyright 2021 EPAM Systems\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *    http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n ***************************************************************************/\n\nimport { BaseProps } from '../../../modal.types'\nimport Bond from './Bond'\nimport { connect } from 'react-redux'\n\ntype StateProps = Pick<BaseProps, 'formState'>\n\nconst mapStateToProps = (state: any): StateProps => ({\n  formState: state.modal.form\n})\n\nconst BondContainer = connect(mapStateToProps)(Bond)\nexport default BondContainer\n","/****************************************************************************\n * Copyright 2021 EPAM Systems\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *    http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n ***************************************************************************/\n\nimport { BaseCallProps, BaseProps } from '../../../modal.types'\nimport Form, { Field } from '../../../../../component/form/form/form'\n\nimport { Dialog } from '../../../../components'\nimport { bond as bondSchema } from '../../../../../data/schema/struct-schema'\nimport classes from './Bond.module.less'\n\ninterface BondProps extends BaseProps {\n  center: number\n  topology: number\n  type: string\n}\n\ntype Props = BondProps & BaseCallProps\n\nconst Bond = (props: Props) => {\n  const { formState, ...rest } = props\n  return (\n    <Dialog\n      title=\"Bond Properties\"\n      className={classes.bond}\n      result={() => formState.result}\n      valid={() => formState.valid}\n      params={rest}\n    >\n      <Form schema={bondSchema} init={rest} {...formState}>\n        <Field name=\"type\" />\n        <Field name=\"topology\" />\n        <Field name=\"center\" />\n      </Form>\n    </Dialog>\n  )\n}\n\nexport type { BondProps }\nexport default Bond\n","/****************************************************************************\n * Copyright 2021 EPAM Systems\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *    http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n ***************************************************************************/\n\nimport { Field } from '../../../../../../../component/form/form/form'\nimport { RgroupLogicProps } from '../../RgroupLogic'\nimport classes from './IfThenSelect.module.less'\nimport { useFormContext } from '../../../../../../../../../hooks'\n\ntype Props = Pick<RgroupLogicProps, 'label' | 'rgroupLabels' | 'name'>\n\nconst IfThenSelect = (props: Props) => {\n  const { rgroupLabels, label, name } = props\n  const { schema } = useFormContext() as any\n  const desc = {\n    title: schema.properties[name!].title,\n    enum: [0],\n    enumNames: ['Always']\n  }\n\n  rgroupLabels.forEach(rgroupLabel => {\n    if (label !== rgroupLabel) {\n      desc.enum.push(rgroupLabel)\n      desc.enumNames.push(`IF R${label} THEN R${rgroupLabel}`)\n    }\n  })\n\n  return <Field schema={desc} className={classes.field} {...props} />\n}\n\nexport default IfThenSelect\n","/****************************************************************************\n * Copyright 2021 EPAM Systems\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *    http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n ***************************************************************************/\n\nimport { BaseProps } from '../../../modal.types'\nimport RgroupLogic from './RgroupLogic'\nimport { connect } from 'react-redux'\n\ntype StateProps = Pick<BaseProps, 'formState'>\n\nconst mapStateToProps = (state: any): StateProps => ({\n  formState: state.modal.form\n})\n\nconst RgroupLogicContainer = connect(mapStateToProps)(RgroupLogic)\nexport default RgroupLogicContainer\n","/****************************************************************************\n * Copyright 2021 EPAM Systems\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *    http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n ***************************************************************************/\nimport { BaseCallProps, BaseProps } from '../../../modal.types'\nimport Form, { Field } from '../../../../../component/form/form/form'\nimport { Dialog } from '../../../../components'\nimport IfThenSelect from './components'\nimport classes from './RgroupLogic.module.less'\nimport { rgroupLogic as rgroupSchema } from '../../../../../data/schema/struct-schema'\n\ninterface RgroupLogicProps extends BaseProps {\n  frags: Set<number>\n  ifthen: number\n  label: number\n  range: string\n  resth: boolean\n  rgroupLabels: Array<number>\n  name?: string\n}\n\ntype Props = RgroupLogicProps & BaseCallProps\n\nconst RgroupLogic = (props: Props) => {\n  const { formState, label, rgroupLabels, ...rest } = props\n  return (\n    <Dialog\n      title=\"R-Group Logic\"\n      className={classes.rgroupLogic}\n      result={() => formState.result}\n      valid={() => formState.valid}\n      params={rest}\n    >\n      <Form\n        schema={rgroupSchema}\n        customValid={{ range: r => rangeConv(r) }}\n        init={rest}\n        {...formState}\n      >\n        <Field name=\"range\" />\n        <Field name=\"resth\" />\n        <IfThenSelect name=\"ifthen\" label={label} rgroupLabels={rgroupLabels} />\n      </Form>\n    </Dialog>\n  )\n}\n\nfunction rangeConv(range) {\n  // structConv\n  const res = range\n    .replace(/\\s*/g, '')\n    .replace(/,+/g, ',')\n    .replace(/^,/, '')\n    .replace(/,$/, '')\n\n  return res\n    .split(',')\n    .every(s => s.match(/^[>,<=]?[0-9]+$/g) || s.match(/^[0-9]+-[0-9]+$/g))\n}\n\nexport type { RgroupLogicProps }\nexport default RgroupLogic\n","/****************************************************************************\n * Copyright 2021 EPAM Systems\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *    http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n ***************************************************************************/\n\nimport Open, { OpenProps } from './Open'\n\nimport { BaseCallProps } from '../../../modal.types'\nimport { connect } from 'react-redux'\nimport { exec } from '../../../../../component/cliparea/cliparea'\nimport { load } from '../../../../../state'\n\ntype StateProps = OpenProps\ntype DispatchProps = Pick<BaseCallProps, 'onOk'>\n\nconst mapStateToProps = (state): StateProps => ({ server: state.server })\n\nconst mapDispatchToProps = (dispatch): DispatchProps => ({\n  onOk: result => {\n    if (result.fragment) exec('copy')\n    dispatch(\n      load(result.structStr, {\n        badHeaderRecover: true,\n        fragment: result.fragment\n      })\n      // TODO: Removed ownProps.onOk call. consider refactoring of load function in release 2.4\n      // See PR #731 (https://github.com/epam/ketcher/pull/731)\n    )\n  }\n})\n\nconst OpenContainer = connect(mapStateToProps, mapDispatchToProps)(Open)\nexport default OpenContainer\n","/****************************************************************************\n * Copyright 2021 EPAM Systems\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *    http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n ***************************************************************************/\n\nimport { BaseCallProps, BaseProps } from '../../../modal.types'\nimport { FC, useState } from 'react'\nimport { Dialog } from '../../../../components'\nimport OpenButton from '../../../../../component/view/openbutton'\nimport classes from './Open.module.less'\nimport { formatProperties } from 'ketcher-core'\nimport ClipArea from '../../../../../component/cliparea/cliparea'\n\ninterface OpenProps {\n  server: any\n}\n\ntype Props = OpenProps & Pick<BaseProps, 'className'> & BaseCallProps\n\nconst Open: FC<Props> = props => {\n  const [structStr, setStructStr] = useState<string>('')\n  const [fragment, setFragment] = useState<boolean>(false)\n  const { server, ...rest } = props\n\n  const result = () => {\n    return structStr ? { structStr, fragment } : null\n  }\n\n  const structAcceptMimes = () => {\n    return Array.from(\n      new Set(\n        Object.keys(formatProperties).reduce(\n          (res, key) =>\n            res.concat(\n              formatProperties[key].mime,\n              ...formatProperties[key].extensions\n            ),\n          []\n        )\n      )\n    ).join(',')\n  }\n\n  return (\n    <Dialog\n      title=\"Open Structure\"\n      className={classes.open}\n      result={result}\n      params={rest}\n      buttons={[\n        <OpenButton\n          key={structAcceptMimes().toString()}\n          server={server}\n          type={structAcceptMimes()}\n          onLoad={setStructStr}\n        >\n          Open From File‚Ä¶\n        </OpenButton>,\n        'Cancel',\n        'OK'\n      ]}\n    >\n      <textarea\n        value={structStr}\n        onChange={event => setStructStr(event.target.value)}\n      />\n      <label>\n        <input\n          type=\"checkbox\"\n          checked={fragment}\n          onChange={event => setFragment(event.target.checked)}\n        />\n        Load as a fragment and copy to the Clipboard\n      </label>\n      <ClipArea\n        focused={() => true}\n        onCopy={() => ({ 'text/plain': structStr })}\n      />\n    </Dialog>\n  )\n}\n\nexport type { OpenProps }\nexport default Open\n","/****************************************************************************\n * Copyright 2021 EPAM Systems\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *    http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n ***************************************************************************/\n\nimport classes from './Save.module.less'\n\nconst SaveImageTab = ({ changeImageFormat }) => {\n  const formats = [\n    { extension: 'svg', text: 'SVG Document' },\n    { extension: 'png', text: 'PNG Image' }\n  ]\n\n  const renderOptions = formats => {\n    return formats.map(format => {\n      const { extension, text } = format\n      return (\n        <option key={extension} value={extension}>\n          {text}\n        </option>\n      )\n    })\n  }\n\n  const handleChange = ({ target }) => {\n    changeImageFormat(target.value)\n  }\n\n  return (\n    <div className={classes.saveImageContainer}>\n      <label>\n        Image Format: &nbsp;\n        <select onChange={handleChange}>{renderOptions(formats)}</select>\n      </label>\n    </div>\n  )\n}\n\nexport default SaveImageTab\n","/****************************************************************************\n * Copyright 2021 EPAM Systems\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *    http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n ***************************************************************************/\n\nimport * as structFormat from '../../../../../data/convert/structConverter'\n\nimport Form, { Field } from '../../../../../component/form/form/form'\nimport {\n  FormatterFactory,\n  formatProperties,\n  getPropertiesByFormat\n} from 'ketcher-core'\nimport { Component, createRef } from 'react'\n\nimport { Dialog } from '../../../../components'\nimport { ErrorsContext } from '../../../../../../../contexts'\nimport SaveButton from '../../../../../component/view/savebutton'\nimport SaveImageTab from './SaveImageTab'\nimport Tabs from '../../../../../component/view/Tabs'\nimport { check } from '../../../../../state/server'\nimport classes from './Save.module.less'\nimport { connect } from 'react-redux'\nimport { saveUserTmpl } from '../../../../../state/templates'\nimport { updateFormState } from '../../../../../state/modal/form'\n\nconst saveSchema = {\n  title: 'Save',\n  type: 'object',\n  properties: {\n    filename: {\n      title: 'Filename',\n      type: 'string',\n      maxLength: 128,\n      pattern: /^[^.<>:?\"*|/\\\\][^<>:?\"*|/\\\\]*$/,\n      invalidMessage: res => {\n        if (!res) return 'Filename should contain at least one character'\n        if (res.length > 128) return 'Filename is too long'\n        return \"A filename cannot contain characters: \\\\ / : * ? \\\" < > | and cannot start with '.'\"\n      }\n    },\n    format: {\n      title: 'Format',\n      enum: Object.keys(formatProperties),\n      enumNames: Object.keys(formatProperties).map(\n        format => formatProperties[format].name\n      )\n    }\n  }\n}\n\nclass SaveDialog extends Component {\n  static contextType = ErrorsContext\n  constructor(props) {\n    super(props)\n    this.state = {\n      disableControls: true,\n      imageFormat: 'svg',\n      tabIndex: 0\n    }\n    this.isRxn = this.props.struct.hasRxnArrow()\n    this.textAreaRef = createRef()\n    const formats = [this.isRxn ? 'rxn' : 'mol', 'smiles', 'ket']\n    if (this.props.server)\n      formats.push(\n        this.isRxn ? 'rxnV3000' : 'molV3000',\n        'smilesExt',\n        'smarts',\n        'inChI',\n        'inChIAuxInfo',\n        'cml'\n      )\n\n    this.saveSchema = saveSchema\n    this.saveSchema.properties.format = Object.assign(\n      this.saveSchema.properties.format,\n      {\n        enum: formats,\n        enumNames: formats.map(format => getPropertiesByFormat(format).name)\n      }\n    )\n  }\n\n  componentDidMount() {\n    const { checkOptions } = this.props.checkState\n    this.props.onCheck(checkOptions)\n    this.changeType(this.isRxn ? 'rxn' : 'mol').then(\n      res => res instanceof Error && this.setState({ disableControls: true })\n    )\n  }\n\n  showStructWarningMessage = format => {\n    const { errors } = this.props.formState\n    return format !== 'mol' && Object.keys(errors).length > 0\n  }\n\n  changeType = type => {\n    const errorHandler = this.context.errorHandler\n    this.setState({ disableControls: true })\n\n    const { struct, server, options, formState } = this.props\n\n    const factory = new FormatterFactory(server)\n\n    const service = factory.create(type, options)\n\n    return service\n      .getStructureFromStructAsync(struct)\n      .then(\n        structStr => {\n          this.setState({ structStr })\n          setTimeout(() => {\n            if (this.textAreaRef.current) {\n              this.textAreaRef.current.select()\n            }\n          }, 10) // TODO: remove hack\n        },\n        e => {\n          errorHandler(e.message)\n          this.props.onResetForm(formState)\n          return e\n        }\n      )\n      .finally(() => {\n        this.setState({ disableControls: false })\n      })\n  }\n\n  getWarnings = format => {\n    const { struct, moleculeErrors } = this.props\n    const warnings = []\n    const structWarning =\n      'Structure contains errors, please check the data, otherwise you ' +\n      'can lose some properties or the whole structure after saving in this format.'\n    const saveWarning = structFormat.couldBeSaved(struct, format)\n    const isStructInvalid = this.showStructWarningMessage(format)\n\n    if (isStructInvalid) {\n      warnings.push(structWarning)\n    }\n    if (saveWarning) {\n      warnings.push(saveWarning)\n    }\n\n    if (moleculeErrors) {\n      warnings.push(...Object.values(moleculeErrors))\n    }\n    return warnings\n  }\n\n  changeTab = tabIndex => {\n    this.setState({ tabIndex })\n  }\n\n  changeImageFormat = imageFormat => {\n    this.setState({ imageFormat })\n  }\n\n  renderSaveFile = () => {\n    const formState = Object.assign({}, this.props.formState)\n    delete formState.moleculeErrors\n    const { filename, format } = formState.result\n    const warnings = this.getWarnings(format)\n    const { structStr } = this.state\n    return (\n      <div className={classes.formContainer}>\n        <Form\n          schema={this.saveSchema}\n          init={{\n            filename,\n            format: this.isRxn ? 'rxn' : 'mol'\n          }}\n          {...formState}\n        >\n          <Field name=\"filename\" />\n          <Field name=\"format\" onChange={this.changeType} />\n        </Form>\n        <textarea\n          value={structStr}\n          className={classes.previewArea}\n          readOnly\n          ref={this.textAreaRef}\n        />\n        {warnings.length ? (\n          <div className={classes.warnings}>\n            {warnings.map(warning => (\n              <div className={classes.warningsContainer}>\n                <div className={classes.warning} />\n                <div className={classes.warningsArr}>{warning}</div>\n              </div>\n            ))}\n          </div>\n        ) : null}\n      </div>\n    )\n  }\n\n  getButtons = () => {\n    const { disableControls, imageFormat, structStr, tabIndex } = this.state\n    const formState = this.props.formState\n    const { filename, format } = formState.result\n    const isCleanStruct = this.props.struct.isBlank()\n    const isMoleculeContain =\n      this.props.struct.atoms.size && this.props.struct.bonds.size\n    const buttons = [\n      [\n        <SaveButton\n          mode=\"saveFile\"\n          data={structStr}\n          filename={filename + getPropertiesByFormat(format).extensions[0]}\n          key=\"save-file-button\"\n          type={format.mime}\n          server={this.props.server}\n          onSave={this.props.onOk}\n          disabled={disableControls || !formState.valid || isCleanStruct}\n        >\n          Save To File\n        </SaveButton>,\n        <button\n          key=\"save-tmpl\"\n          className={classes.saveTmpl}\n          disabled={disableControls || isCleanStruct || !isMoleculeContain}\n          onClick={() => this.props.onTmplSave(this.props.struct)}\n        >\n          Save to Templates...\n        </button>,\n        'Close'\n      ],\n      [\n        <SaveButton\n          mode=\"saveImage\"\n          data={structStr}\n          filename={filename}\n          outputFormat={imageFormat}\n          key=\"save-image-button\"\n          type=\"image/svg+xml\"\n          onSave={this.props.onOk}\n          disabled={\n            disableControls ||\n            !formState.valid ||\n            isCleanStruct ||\n            !this.props.server\n          }\n        >\n          Save As Image\n        </SaveButton>,\n        'Close'\n      ]\n    ]\n    return buttons[tabIndex]\n  }\n\n  render() {\n    const tabs = [\n      {\n        caption: 'Structure',\n        component: this.renderSaveFile\n      },\n      {\n        caption: 'Image',\n        component: SaveImageTab,\n        props: {\n          changeImageFormat: this.changeImageFormat\n        }\n      }\n    ]\n\n    return (\n      <Dialog\n        title=\"Save Structure\"\n        className={classes.save}\n        params={this.props}\n        buttons={this.getButtons()}\n      >\n        <Tabs\n          tabs={tabs}\n          changeTab={tab => {\n            this.changeTab(tab)\n          }}\n        />\n      </Dialog>\n    )\n  }\n}\n\nconst mapStateToProps = state => ({\n  server: state.options.app.server ? state.server : null,\n  struct: state.editor.struct(),\n  options: state.options.getServerSettings(),\n  formState: state.modal.form,\n  moleculeErrors: state.modal.form.moleculeErrors,\n  checkState: state.options.check\n})\n\nconst mapDispatchToProps = dispatch => ({\n  onCheck: checkOptions => dispatch(check(checkOptions)),\n  onTmplSave: struct => dispatch(saveUserTmpl(struct)),\n  onResetForm: prevState => dispatch(updateFormState(prevState))\n})\n\nconst Save = connect(mapStateToProps, mapDispatchToProps)(SaveDialog)\n\nexport default Save\n","/****************************************************************************\n * Copyright 2021 EPAM Systems\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *    http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n ***************************************************************************/\n\nimport {\n  RxnArrowMode,\n  StereoFlag,\n  Struct,\n  SupportedFormat,\n  getPropertiesByFormat\n} from 'ketcher-core'\n\nexport function couldBeSaved(\n  struct: Struct,\n  format: SupportedFormat\n): string | null {\n  let warnings: Array<string> = []\n  const formatName: string = getPropertiesByFormat(format).name\n\n  const rxnArrowsSize = struct.rxnArrows.size\n  const hasRxnArrow = struct.hasRxnArrow()\n\n  if (format === 'smiles' || format === 'smarts') {\n    warnings.push(\n      `Structure contains query properties of atoms and bonds that are not supported in the ${format?.toUpperCase()}. Query properties will not be reflected in the file saved.`\n    )\n  }\n\n  if (format === 'smiles') {\n    const arrayOfAtoms: Array<any> = Array.from(struct.atoms.values())\n    const hasGenerics = arrayOfAtoms.some(atom => atom.pseudo)\n    if (hasGenerics) {\n      warnings.push(\n        `Structure contains generic atoms. They will be saved as any atom (*).`\n      )\n    }\n  }\n\n  if (format !== 'ket') {\n    if (hasRxnArrow) {\n      const arrayOfArrows: Array<any> = Array.from(struct.rxnArrows.values())\n      const rxnArrowMode: RxnArrowMode = arrayOfArrows[0].mode\n      if (rxnArrowMode !== RxnArrowMode.OpenAngle) {\n        warnings.push(\n          `The ${formatName} format does not support drawn elements: the reaction ${rxnArrowMode} arrow will be replaced with the reaction arrow`\n        )\n      }\n    }\n\n    // TODO: find better solution for case when Arrows > 1\n    if (rxnArrowsSize > 1) {\n      warnings.push(\n        `The ${formatName} format does not support drawn elements: reaction arrows will be lost.`\n      )\n    }\n  }\n\n  if (\n    (\n      ['inChI', 'inChIAuxInfo', 'smiles', 'smilesExt'] as SupportedFormat[]\n    ).includes(format)\n  ) {\n    if (struct.rgroups.size !== 0)\n      warnings.push(\n        `In ${formatName} the structure will be saved without R-group fragments`\n      )\n\n    struct = struct.clone() // need this: .getScaffold()\n    // @ts-ignore\n    const isRg = struct.atoms.find((ind, atom) => atom.label === 'R#')\n    if (isRg !== null)\n      warnings.push(\n        `In ${formatName} the structure will be saved without R-group members`\n      )\n\n    const isSg = struct.sgroups.find(\n      // @ts-ignore\n      (ind, sg) =>\n        sg.type !== 'MUL' && !/^INDIGO_.+_DESC$/i.test(sg.data.fieldName)\n    )\n    if (isSg !== null)\n      warnings.push(\n        `In ${formatName} the structure will be saved without S-groups`\n      )\n  }\n\n  if (\n    (\n      [\n        'smiles',\n        'smilesExt',\n        'smarts',\n        'inChI',\n        'inChIAuxInfo',\n        'cml'\n      ] as SupportedFormat[]\n    ).includes(format)\n  ) {\n    // @ts-ignore\n    const isVal = struct.atoms.find((ind, atom) => atom.explicitValence >= 0)\n    if (isVal !== null)\n      warnings.push(`In ${formatName} valence is not supported`)\n  }\n\n  if (\n    (['mol', 'rxn'] as SupportedFormat[]).includes(format) &&\n    Array.from(struct.frags.values()).some(fr => {\n      if (fr?.enhancedStereoFlag) {\n        return fr.enhancedStereoFlag !== StereoFlag.Abs\n      }\n      return false\n    })\n  ) {\n    warnings.push(\n      `Structure contains enhanced stereochemistry features. Information will be partly lost.`\n    )\n  }\n\n  if (\n    (\n      ['inChI', 'inChIAuxInfo', 'smiles', 'smilesExt'] as SupportedFormat[]\n    ).includes(format)\n  ) {\n    if (struct.functionalGroups.size !== 0)\n      warnings.push(\n        `In ${formatName} the structure will be saved without functional groups.`\n      )\n  }\n\n  if ((['cml'] as SupportedFormat[]).includes(format)) {\n    if (struct.functionalGroups.size !== 0)\n      warnings.push(\n        `Structure contains functional groups. In ${formatName} information will be partly lost.`\n      )\n  }\n\n  if (warnings.length !== 0) return warnings.join('\\n')\n\n  return null\n}\n","/****************************************************************************\n * Copyright 2021 EPAM Systems\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *    http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n ***************************************************************************/\n\nimport Form, { Field } from '../../../component/form/form/form'\nimport { StereoLabel, Struct } from 'ketcher-core'\n\nimport { Dialog } from '../../../views/components'\nimport { FC } from 'react'\nimport classes from './enhancedStereo.module.less'\nimport { connect } from 'react-redux'\nimport { range } from 'lodash'\n\ninterface EnhancedStereoResult {\n  andNumber: number\n  orNumber: number\n  type: StereoLabel\n}\n\ninterface EnhancedStereoFormState {\n  result: EnhancedStereoResult\n  valid: boolean\n  errors: string[]\n}\n\ninterface EnhancedStereoProps {\n  className: string\n  init: EnhancedStereoResult & { init?: true }\n  formState: EnhancedStereoFormState\n  struct: Struct\n}\n\ninterface EnhancedStereoCallProps {\n  onCancel: () => void\n  onOk: (res: any) => void\n}\n\ntype Props = EnhancedStereoProps & EnhancedStereoCallProps\n\nconst EnhancedStereo: FC<Props> = props => {\n  const { struct, formState, init, ...rest } = props\n  const { result, valid } = formState\n\n  const stereoLabels: Array<string> = findStereLabels(\n    struct,\n    Array.from(struct.atoms.keys())\n  )\n\n  const maxAnd: number = maxOfAnds(stereoLabels)\n  const maxOr: number = maxOfOrs(stereoLabels)\n\n  const enhancedStereoSchema = {\n    title: 'Enhanced Stereo',\n    type: 'object',\n    properties: {\n      type: {\n        type: 'string'\n      },\n      andNumber: {\n        type: 'integer'\n      },\n      orNumber: {\n        type: 'integer'\n      }\n    }\n  }\n\n  return (\n    <Dialog\n      title=\"Enhanced Stereochemistry\"\n      className={classes.enhancedStereo}\n      params={rest}\n      result={() => result}\n      valid={() => valid}\n      buttons={['Cancel', 'OK']}\n    >\n      <Form schema={enhancedStereoSchema} init={init} {...formState}>\n        <fieldset>\n          <label className={classes.stereoLabelItem}>\n            <Field\n              name=\"type\"\n              labelPos={false}\n              type=\"radio\"\n              value={StereoLabel.Abs}\n              checked={result.type === StereoLabel.Abs}\n            />\n            ABS\n          </label>\n          {maxAnd !== 0 && (\n            <label className={classes.stereoLabelItem}>\n              <Field\n                name=\"type\"\n                labelPos={false}\n                type=\"radio\"\n                value={StereoLabel.And}\n                checked={result.type === StereoLabel.And}\n              />\n              Add to AND\n              <Field\n                name=\"andNumber\"\n                schema={range(1, maxAnd + 1)}\n                type=\"text\"\n                className={classes.labelGroupSelect}\n              />\n              Group\n            </label>\n          )}\n          {maxOr !== 0 && (\n            <label className={classes.stereoLabelItem}>\n              <Field\n                name=\"type\"\n                labelPos={false}\n                type=\"radio\"\n                value={StereoLabel.Or}\n                checked={result.type === StereoLabel.Or}\n              />\n              Add to OR\n              <Field\n                name=\"orNumber\"\n                schema={range(1, maxOr + 1)}\n                type=\"text\"\n                className={classes.labelGroupSelect}\n              />\n              Group\n            </label>\n          )}\n          <label className={classes.stereoLabelItem}>\n            <Field\n              name=\"type\"\n              labelPos={false}\n              type=\"radio\"\n              value={`&${maxAnd + 1}`}\n            />\n            Create new AND Group\n          </label>\n          <label className={classes.stereoLabelItem}>\n            <Field\n              name=\"type\"\n              labelPos={false}\n              type=\"radio\"\n              value={`or${maxOr + 1}`}\n            />\n            Create new OR Group\n          </label>\n        </fieldset>\n      </Form>\n    </Dialog>\n  )\n}\n\n// TODO: Move the function below to Struct class\nfunction findStereLabels(struct, aids): Array<string> {\n  const stereoIds = aids.filter(\n    aid => struct.atoms.get(aid).stereoLabel !== null\n  )\n  return stereoIds.map(aid => struct.atoms.get(aid).stereoLabel)\n}\n\nfunction maxOfAnds(stereLabels): number {\n  const numbers = stereLabels.map(label => {\n    return label.match(/&/) ? +label.match(/\\d+/)?.join() : 0\n  })\n  return Math.max(...numbers)\n}\n\nfunction maxOfOrs(stereLabels): number {\n  const numbers = stereLabels.map(label => {\n    return label.match(/or/) ? +label.match(/\\d+/)?.join() : 0\n  })\n  return Math.max(...numbers)\n}\n\nexport default connect(state => ({\n  formState: (state as any).modal.form || { result: {}, valid: false },\n  struct: (state as any).editor.struct()\n}))(EnhancedStereo)\n","/****************************************************************************\n * Copyright 2021 EPAM Systems\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *    http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n ***************************************************************************/\n\nimport classes from './emptySearchResult.module.less'\n\nconst EmptySearchResult = ({ textInfo }) => {\n  return <div className={classes.emptySearch}>{textInfo}</div>\n}\n\nexport default EmptySearchResult\n","/****************************************************************************\n * Copyright 2021 EPAM Systems\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *    http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n ***************************************************************************/\nimport { escapeRegExp, filter as _filter, flow, reduce } from 'lodash/fp'\n\nconst GREEK_SIMBOLS = {\n  Alpha: 'A',\n  alpha: 'Œ±',\n  Beta: 'B',\n  beta: 'Œ≤',\n  Gamma: '–ì',\n  gamma: 'Œ≥'\n}\n\nconst greekRe = new RegExp(\n  '\\\\b' + Object.keys(GREEK_SIMBOLS).join('\\\\b|\\\\b') + '\\\\b',\n  'g'\n)\n\nexport function greekify(str: string): string {\n  return str.replace(greekRe, sym => GREEK_SIMBOLS[sym])\n}\n\nexport function filterLib(lib, filter) {\n  console.warn('Filter', filter)\n  const re = new RegExp(escapeRegExp(greekify(filter)), 'i')\n  return flow(\n    _filter(\n      (item: any) =>\n        !filter ||\n        re.test(greekify(item.struct.name)) ||\n        re.test(greekify(item.props.group))\n    ),\n    reduce((res, item) => {\n      if (!res[item.props.group]) res[item.props.group] = [item]\n      else res[item.props.group].push(item)\n      return res\n    }, {})\n  )(lib)\n}\n\nexport function filterFGLib(lib, filter) {\n  console.warn('Filter', filter)\n  const re = new RegExp(escapeRegExp(greekify(filter)), 'i')\n  return flow(\n    _filter((item: any) => !filter || re.test(greekify(item.struct.name))),\n    reduce((res, item) => {\n      if (!res[item.props.group]) res[item.props.group] = [item]\n      else res[item.props.group].push(item)\n      return res\n    }, {})\n  )(lib)\n}\n","/****************************************************************************\n * Copyright 2021 EPAM Systems\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *    http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n ***************************************************************************/\n\nimport EmptySearchResult from './EmptySearchResult'\nimport { FC } from 'react'\nimport { Struct } from 'ketcher-core'\nimport StructRender from '../../component/structrender'\nimport classes from './TemplateTable.module.less'\nimport { greekify } from '../../utils'\n\ninterface TemplateTableProps {\n  templates: Array<Template>\n  selected: Template | null\n  onSelect: (tmpl: Template) => void\n  onDelete?: (tmpl: Template) => void\n  onAttach?: (tmpl: Template) => void\n}\n\nexport interface Template {\n  struct: Struct\n  props: {\n    atomid: number\n    bondid: number\n    group: string\n    prerender?: string\n  }\n}\n\nfunction tmplName(tmpl: Template, i: number): string {\n  return tmpl.struct.name || `${tmpl.props.group} template ${i + 1}`\n}\n\nconst RenderTmpl: FC<{\n  tmpl: Template\n  className: string\n  onClick: () => void\n}> = ({ tmpl, ...props }) => {\n  return tmpl.props && tmpl.props.prerender ? (\n    <svg {...props}>\n      <use href={tmpl.props.prerender} />\n    </svg>\n  ) : (\n    <StructRender\n      struct={tmpl.struct}\n      options={{ autoScaleMargin: 15 }}\n      {...props}\n    />\n  )\n}\n\nconst TemplateTable: FC<TemplateTableProps> = props => {\n  const { templates, selected, onSelect, onDelete, onAttach } = props\n  const ITEMS_COUNT = templates ? templates.length : 0\n  const ITEM_SIZE = { width: 178, height: 120 }\n  const tmplStyles = {\n    width: `${ITEM_SIZE.width}px`,\n    height: `${ITEM_SIZE.height}px`\n  }\n\n  return !ITEMS_COUNT ? (\n    <EmptySearchResult textInfo=\"No items found\" />\n  ) : (\n    <div className={classes.table} style={{ minWidth: ITEM_SIZE.width }}>\n      <div className={classes.tableContent}>\n        {templates.map((tmpl, i) => {\n          return (\n            <div\n              className={\n                tmpl === selected\n                  ? `${classes.td} ${classes.selected}`\n                  : classes.td\n              }\n              title={greekify(tmplName(tmpl, i))}\n              key={\n                tmpl.struct.name !== selected?.struct.name\n                  ? `${tmpl.struct.name}_${i}`\n                  : `${tmpl.struct.name}_${i}_selected`\n              }\n              style={tmplStyles}\n            >\n              <RenderTmpl\n                tmpl={tmpl}\n                className={classes.struct}\n                onClick={() => onSelect(tmpl)}\n              />\n              <div className={classes.btnContainer}>\n                {tmpl.props.group === 'User Templates' && (\n                  <button\n                    className={classes.deleteButton}\n                    onClick={() => onDelete!(tmpl)}\n                  >\n                    Delete\n                  </button>\n                )}\n                {tmpl.props.group !== 'Functional Groups' && (\n                  <button\n                    className={classes.attachButton}\n                    onClick={() => onAttach!(tmpl)}\n                  >\n                    Edit\n                  </button>\n                )}\n              </div>\n            </div>\n          )\n        })}\n      </div>\n    </div>\n  )\n}\n\nexport default TemplateTable\n","/****************************************************************************\n * Copyright 2021 EPAM Systems\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *    http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n ***************************************************************************/\n\nexport const functionalGroupsSelector = state => state.functionalGroups.lib\nexport const modeSelector = state => state.functionalGroups.mode\n","/****************************************************************************\n * Copyright 2021 EPAM Systems\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *    http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n ***************************************************************************/\n\nimport { FC, RefCallback, useEffect, useMemo, useState } from 'react'\nimport { FunctionalGroup, SdfItem, SdfSerializer, Struct } from 'ketcher-core'\nimport TemplateTable, { Template } from '../../../dialog/template/TemplateTable'\nimport {\n  functionalGroupsSelector,\n  modeSelector\n} from '../../../state/functionalGroups/selectors'\nimport { useDispatch, useSelector } from 'react-redux'\n\nimport { Dialog } from '../'\nimport { DialogParams } from '../Dialog/Dialog'\nimport Input from '../../../component/form/input'\nimport SaveButton from '../../../component/view/savebutton'\nimport classes from './functionalGroups.module.less'\nimport clsx from 'clsx'\nimport { filterFGLib } from '../../../utils'\nimport { onAction } from '../../../state'\nimport { useResizeObserver } from '../../../../../hooks'\n\nexport interface FGProps {\n  className: string\n  onOk: () => void\n  onCancel: () => void\n}\n\ninterface Result {\n  struct: Struct\n  aid: number | null\n  mode: string\n}\n\nconst group = 'Functional Groups'\n\nconst FunctionalGroups: FC<FGProps> = ({ onOk, onCancel, className }) => {\n  const dispatch = useDispatch()\n  const CONTAINER_MIN_WIDTH = 310\n  const lib: SdfItem[] = useSelector(functionalGroupsSelector)\n  const mode = useSelector(modeSelector)\n\n  const [selected, setSelected] = useState<Template | null>(null)\n  const [filter, setFilter] = useState<string>('')\n  const [filteredLib, setFilteredLib] = useState({})\n\n  const expandedTemplates: SdfItem[] = useMemo(() => {\n    return lib.map(template => {\n      const struct = template.struct.clone()\n      struct.sgroups.forEach(sgroup => {\n        if (FunctionalGroup.isFunctionalGroup(sgroup)) {\n          sgroup.data.expanded = true\n        }\n      })\n      return { ...template, struct }\n    })\n  }, [lib])\n\n  useEffect(() => {\n    setFilteredLib(filterFGLib(expandedTemplates, filter))\n  }, [expandedTemplates, filter])\n\n  const onFilter = (filter: string): void => setFilter(filter)\n  const onSelect = (tmpl: Template): void => setSelected(tmpl)\n  const handleOk = (res: Result | null): void => {\n    if (res) {\n      res.struct.sgroups.forEach(sgroup => {\n        if (FunctionalGroup.isFunctionalGroup(sgroup)) {\n          sgroup.data.expanded = false\n        }\n      })\n    }\n    dispatch(onAction({ tool: 'template', opts: res }))\n    onOk()\n  }\n\n  const handleResult = (): Result | null => {\n    const tmpl = selected\n    return tmpl\n      ? {\n          struct: tmpl.struct,\n          aid: parseInt(String(tmpl.props.atomid)) || null,\n          mode: mode\n        }\n      : null\n  }\n\n  const sdfSerializer = new SdfSerializer()\n  const molSaveData = sdfSerializer.serialize(lib)\n\n  const handleSelect = (tmpl: Template): void => {\n    if (tmpl === selected) {\n      handleOk(handleResult())\n    } else onSelect(tmpl)\n  }\n\n  const {\n    ref,\n    width\n  }: {\n    ref: RefCallback<HTMLDivElement>\n    width: number | undefined\n  } = useResizeObserver<HTMLDivElement>()\n\n  const params: DialogParams = {\n    onOk: handleOk,\n    onCancel,\n    className\n  }\n\n  return (\n    <Dialog\n      title=\"Functional Groups\"\n      className={classes.functionalGroups}\n      params={params}\n      result={() => handleResult()}\n      buttons={[\n        <SaveButton\n          key=\"save-to-SDF\"\n          data={molSaveData}\n          filename=\"ketcher-fg-tmpls.sdf\"\n        >\n          Save To SDF‚Ä¶\n        </SaveButton>,\n        'Cancel',\n        'OK'\n      ]}\n    >\n      <div className={classes.dialog_body}>\n        <label>\n          Filter:\n          <Input\n            type=\"search\"\n            value={filter}\n            onChange={value => onFilter(value)}\n          />\n        </label>\n        <div\n          className={clsx(classes.tableGroupWrap, {\n            [classes.singleColLayout]: width && width < CONTAINER_MIN_WIDTH\n          })}\n          ref={ref}\n        >\n          <TemplateTable\n            templates={filteredLib[group]}\n            onSelect={handleSelect}\n            selected={selected}\n          />\n        </div>\n      </div>\n    </Dialog>\n  )\n}\n\nexport default FunctionalGroups\n","/****************************************************************************\n * Copyright 2021 EPAM Systems\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *    http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n ***************************************************************************/\n\nimport Form, { Field } from '../../component/form/form/form'\n\nimport { Dialog } from '../../views/components'\nimport { Elements } from 'ketcher-core'\nimport { capitalize } from 'lodash/fp'\nimport { connect } from 'react-redux'\nimport { labelEdit as labelEditSchema } from '../../data/schema/struct-schema'\n\nfunction serialize(lc) {\n  const charge = Math.abs(lc.charge)\n  const radical = ['', ':', '.', '^^'][lc.radical] || ''\n  let sign = ''\n  if (charge) sign = lc.charge < 0 ? '-' : '+'\n  return (\n    (lc.isotope || '') + lc.label + radical + (charge > 1 ? charge : '') + sign\n  )\n}\n\nfunction deserialize(value) {\n  const match = value.match(/^(\\d+)?([a-z*]{1,3})(\\.|:|\\^\\^)?(\\d+[-+]|[-+])?$/i) // TODO: radical on last place\n  if (match) {\n    const label = match[2] === '*' ? 'A' : capitalize(match[2])\n    let charge = 0\n    let isotope = 0\n    let radical = 0\n\n    if (match[1]) isotope = parseInt(match[1])\n\n    if (match[3]) radical = { ':': 1, '.': 2, '^^': 3 }[match[3]]\n\n    if (match[4]) {\n      charge = parseInt(match[4])\n      if (isNaN(charge))\n        // eslint-disable-line\n        charge = 1\n      if (match[4].endsWith('-')) charge = -charge\n    }\n    // Not consistant\n    if (\n      label === 'A' ||\n      label === 'Q' ||\n      label === 'X' ||\n      label === 'M' ||\n      Elements.get(label)\n    )\n      return { label, charge, isotope, radical }\n  }\n  return null\n}\n\nfunction LabelEdit(props) {\n  const init = { label: props.letter || serialize(props) }\n  const { formState, ...prop } = props\n  const { result, valid } = formState\n  return (\n    <Dialog\n      title=\"Label Edit\"\n      className=\"labeledit\"\n      valid={() => valid}\n      result={() => deserialize(result.label)}\n      params={prop}\n    >\n      <Form\n        schema={labelEditSchema}\n        customValid={{ label: l => deserialize(l) }}\n        init={init}\n        {...formState}\n      >\n        <Field name=\"label\" maxLength=\"20\" size=\"10\" autoFocus />\n      </Form>\n    </Dialog>\n  )\n}\n\nexport default connect(store => ({ formState: store.modal.form }))(LabelEdit)\n","/****************************************************************************\n * Copyright 2021 EPAM Systems\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *    http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n ***************************************************************************/\n\nimport { ElementColor } from 'ketcher-core'\nimport classes from './AtomInfo.module.less'\nimport clsx from 'clsx'\n\nfunction AtomInfo({ el, isInfo }) {\n  const numberStyle = {\n    color: ElementColor[el.label] || 'black',\n    fontSize: '1.2em'\n  }\n  const elemStyle = {\n    color: ElementColor[el.label] || 'black',\n    fontWeight: 'bold',\n    fontSize: '2em'\n  }\n  return (\n    <div className={clsx(classes.ket_atom_info, !isInfo && classes.none)}>\n      <div style={numberStyle}>{el.number}</div>\n      <span style={elemStyle}>{el.label}</span>\n      <br />\n      {el.title}\n      <br />\n      {el.mass}\n    </div>\n  )\n}\n\nexport default AtomInfo\n","/****************************************************************************\n * Copyright 2021 EPAM Systems\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *    http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n ***************************************************************************/\n\nimport { range } from 'lodash/fp'\n\nconst PERIODIC_TABLE_COLUMNS = 19\n\nfunction Header() {\n  return (\n    <tbody>\n      <tr>\n        {range(0, PERIODIC_TABLE_COLUMNS).map(index => (\n          <th key={index}>{index || ''}</th>\n        ))}\n      </tr>\n    </tbody>\n  )\n}\n\nexport default Header\n","/****************************************************************************\n * Copyright 2021 EPAM Systems\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *    http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n ***************************************************************************/\n\nimport Atom from '../../../../../../../component/view/Atom'\nimport clsx from 'clsx'\n\nfunction MainRow({\n  row,\n  caption,\n  refer,\n  onSelect,\n  currentEvents,\n  atomClassNames,\n  className\n}) {\n  return (\n    <tbody>\n      <tr>\n        <th>{caption}</th>\n        {row.map((element, index) =>\n          typeof element !== 'number' ? ( // eslint-disable-line\n            <td key={index}>\n              <Atom\n                el={element}\n                className={clsx(...atomClassNames(element))}\n                onClick={() => onSelect(element.label)}\n                {...currentEvents(element)}\n              />\n            </td>\n          ) : refer(element) ? (\n            <td key={index} className={className}>\n              {refer(element)}\n            </td>\n          ) : (\n            <td key={index} colSpan={element} />\n          )\n        )}\n      </tr>\n    </tbody>\n  )\n}\n\nexport default MainRow\n","/****************************************************************************\n * Copyright 2021 EPAM Systems\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *    http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n ***************************************************************************/\n\nimport Atom from '../../../../../../../component/view/Atom'\nimport clsx from 'clsx'\n\nfunction OutinerRow({\n  row,\n  caption,\n  onSelect,\n  currentEvents,\n  atomClassNames,\n  className\n}) {\n  return (\n    <tbody>\n      <tr>\n        <th colSpan=\"3\" className={className}>\n          {caption}\n        </th>\n        {row.map(element => (\n          <td key={element.label}>\n            <Atom\n              el={element}\n              className={clsx(...atomClassNames(element))}\n              onClick={() => onSelect(element.label)}\n              {...currentEvents(element)}\n            />\n          </td>\n        ))}\n        <td />\n      </tr>\n    </tbody>\n  )\n}\n\nexport default OutinerRow\n","/****************************************************************************\n * Copyright 2021 EPAM Systems\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *    http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n ***************************************************************************/\n\nimport { Header, MainRow, OutinerRow } from './components'\nimport { Component } from 'react'\n\nimport { Elements } from 'ketcher-core'\nimport styles from './ElementsTable.module.less'\n\nconst metalPrefix = [\n  'alkali',\n  'alkaline-earth',\n  'transition',\n  'post-transition'\n] // 'lanthanide', 'actinide'\nconst atomClassNames = {\n  metal: 'metal',\n  unknownProps: 'unknown-props',\n  unknownState: 'unknown-state',\n  button: 'button',\n  selected: 'selected'\n}\nconst beforeSpan = {\n  He: 16,\n  B: 10,\n  Al: 10,\n  Hf: 1,\n  Rf: 1\n}\nconst ACTINIDE = 'actinide'\nconst LANTHANIDE = 'lanthanide'\nconst main = rowPartition(\n  Elements.filter(\n    item => item && item.type !== ACTINIDE && item.type !== LANTHANIDE\n  )\n)\nconst lanthanides = Elements.filter(item => item && item.type === LANTHANIDE)\nconst actinides = Elements.filter(item => item && item.type === ACTINIDE)\n\nfunction rowPartition(elements) {\n  return elements.reduce((result, item) => {\n    const row = result[item.period - 1]\n    if (!row) {\n      result.push([item])\n    } else {\n      if (beforeSpan[item.label]) row.push(beforeSpan[item.label])\n      row.push(item)\n    }\n    return result\n  }, [])\n}\n\nclass ElementsTable extends Component {\n  // eslint-disable-line\n  shouldComponentUpdate(nextProps) {\n    return nextProps.value !== this.props.value\n  }\n\n  getAtomClassNames = item => {\n    const { selected } = this.props\n\n    const type = metalPrefix.includes(item.type)\n      ? `${item.type} ${atomClassNames.metal}`\n      : item.type || atomClassNames.unknownProps\n\n    const classes = [\n      ...type.split(' '),\n      item.state || atomClassNames.unknownState,\n      item.origin,\n      atomClassNames.button,\n      selected(item.label) && atomClassNames.selected\n    ]\n\n    return classes.map(className => {\n      return styles[className]\n    })\n  }\n\n  render() {\n    const { currentEvents, onSelect } = this.props\n    const callbacks = { currentEvents, onSelect }\n    return (\n      <table\n        className={styles.table}\n        summary=\"Periodic table of the chemical elements\"\n      >\n        <Header />\n        {main.map((row, index) => (\n          <MainRow\n            atomClassNames={this.getAtomClassNames}\n            className={styles.main_row}\n            key={index}\n            row={row}\n            caption={index + 1}\n            refer={element => element === 1 && (index === 5 ? '*' : '**')}\n            {...callbacks}\n          />\n        ))}\n        <OutinerRow\n          atomClassNames={this.getAtomClassNames}\n          className={styles.outiner_row}\n          row={lanthanides}\n          caption=\"*\"\n          {...callbacks}\n        />\n        <OutinerRow\n          atomClassNames={this.getAtomClassNames}\n          className={styles.outiner_row}\n          row={actinides}\n          caption=\"**\"\n          {...callbacks}\n        />\n      </table>\n    )\n  }\n}\n\nexport default ElementsTable\n","/****************************************************************************\n * Copyright 2021 EPAM Systems\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *    http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n ***************************************************************************/\n\nimport classes from './GenSet.module.less'\nimport clsx from 'clsx'\n\nfunction GenSet({ labels, caption = '', selected, onSelect, ...props }) {\n  return (\n    <fieldset {...props}>\n      {labels.map((label, index) => (\n        <button\n          key={index}\n          onClick={() => onSelect(label)}\n          className={clsx(\n            {\n              [classes.selected]: selected(label)\n            },\n            classes.button\n          )}\n        >\n          {label}\n        </button>\n      ))}\n      {caption ? <legend>{caption}</legend> : null}\n    </fieldset>\n  )\n}\n\nexport default GenSet\n","/****************************************************************************\n * Copyright 2021 EPAM Systems\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *    http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n ***************************************************************************/\n\nimport GenSet from './components'\nimport classes from './GenGroup.module.less'\nimport clsx from 'clsx'\n\nconst viewSchema = {\n  atom: {\n    caption: 'Atom Generics',\n    order: ['any', 'no-carbon', 'metal', 'halogen']\n  },\n  group: {\n    caption: 'Group Generics',\n    order: ['acyclic', 'cyclic']\n  },\n  special: {\n    caption: 'Special Nodes',\n    order: []\n  },\n  'group/acyclic': {\n    caption: 'Acyclic',\n    order: ['carbo', 'hetero']\n  },\n  'group/cyclic': {\n    caption: 'Cyclic',\n    order: ['no-carbon', 'carbo', 'hetero']\n  },\n  'group/acyclic/carbo': {\n    caption: 'Carbo',\n    order: ['alkynyl', 'alkyl', 'alkenyl']\n  },\n  'group/acyclic/hetero': {\n    caption: 'Hetero',\n    order: ['alkoxy']\n  },\n  'group/cyclic/carbo': {\n    caption: 'Carbo',\n    order: ['aryl', 'cycloalkyl', 'cycloalkenyl']\n  },\n  'group/cyclic/hetero': {\n    caption: 'Hetero',\n    order: ['aryl']\n  },\n  'atom/any': 'any atom',\n  'atom/no-carbon': 'except C or H',\n  'atom/metal': 'any metal',\n  'atom/halogen': 'any halogen',\n  'group/cyclic/no-carbon': 'no carbon',\n  'group/cyclic/hetero/aryl': 'hetero aryl'\n}\n\nfunction GenGroup({ gen, name, path, selected, onSelect }) {\n  const group = gen[name]\n  const pk = path ? `${path}/${name}` : name\n  const schema = viewSchema[pk]\n\n  return schema && schema.caption ? (\n    <fieldset className={clsx(classes[name], classes.fieldset)}>\n      <legend>{schema.caption}</legend>\n      {group.labels ? (\n        <GenSet\n          labels={group.labels}\n          selected={selected}\n          onSelect={onSelect}\n          className={classes.subgroup}\n        />\n      ) : null}\n      {schema.order.map(\n        (\n          child, // TODO:order = Object.keys ifndef\n          index\n        ) => (\n          <GenGroup\n            key={index}\n            gen={group}\n            name={child}\n            path={pk}\n            selected={selected}\n            onSelect={onSelect}\n          />\n        )\n      )}\n    </fieldset>\n  ) : (\n    <GenSet\n      labels={group.labels}\n      caption={schema || name}\n      className={classes[name]}\n      selected={selected}\n      onSelect={onSelect}\n    />\n  )\n}\n\nexport default GenGroup\n","/****************************************************************************\n * Copyright 2021 EPAM Systems\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *    http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n ***************************************************************************/\n\nimport GenGroup from './components'\nimport { Generics } from 'ketcher-core'\nimport classes from './GenericGroups.module.less'\n\nfunction GenericGroups({ selected, onSelect, className, ...props }) {\n  return (\n    <div summary=\"Generic Groups\" className={classes[className]} {...props}>\n      <div className={classes.col}>\n        <GenGroup\n          gen={Generics}\n          name=\"atom\"\n          selected={selected}\n          onSelect={onSelect}\n        />\n        <GenGroup\n          gen={Generics}\n          name=\"special\"\n          selected={selected}\n          onSelect={onSelect}\n        />\n      </div>\n      <div className={classes.col}>\n        <GenGroup\n          gen={Generics}\n          name=\"group\"\n          selected={selected}\n          onSelect={onSelect}\n        />\n      </div>\n    </div>\n  )\n}\n\nexport default GenericGroups\n","/****************************************************************************\n * Copyright 2021 EPAM Systems\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *    http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n ***************************************************************************/\n\nimport classes from './TypeChoice.module.less'\n\nconst typeSchema = [\n  { title: 'Single', value: 'atom' },\n  { title: 'List', value: 'list' },\n  { title: 'Not List', value: 'not-list' }\n]\n\nfunction TypeChoice({ value, onChange, ...props }) {\n  return (\n    <fieldset className={classes.fieldset}>\n      {typeSchema.map(type => (\n        <label key={type.title}>\n          <input\n            type=\"radio\"\n            value={type.value}\n            checked={type.value === value}\n            onChange={() => onChange(type.value)}\n            {...props}\n          />\n          {type.title}\n        </label>\n      ))}\n    </fieldset>\n  )\n}\n\nexport default TypeChoice\n","/****************************************************************************\n * Copyright 2021 EPAM Systems\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *    http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n ***************************************************************************/\n\nimport {\n  AtomInfo,\n  ElementsTable,\n  GenericGroups,\n  TypeChoice\n} from './components'\nimport { Component } from 'react'\nimport { fromElement, toElement } from '../../../../data/convert/structconv'\n\nimport { Dialog } from '../../../components'\nimport { Elements } from 'ketcher-core'\nimport Tabs from '../../../../component/view/Tabs'\nimport { addAtoms } from '../../../../state/toolbar'\nimport classes from './PeriodTable.module.less'\nimport { connect } from 'react-redux'\nimport { onAction } from '../../../../state'\nimport { xor } from 'lodash/fp'\n\nclass Table extends Component {\n  constructor(props) {\n    super(props)\n    const genType = !this.props.pseudo ? null : 'gen'\n    this.state = {\n      type: props.type || genType || 'atom',\n      value: props.values || props.label || null,\n      current: Elements.get(2),\n      isInfo: false\n    }\n    this.firstType = true\n  }\n\n  changeType = type => {\n    if (this.firstType) {\n      this.firstType = false\n      return\n    }\n    const prevChoice =\n      this.state.type === 'list' || this.state.type === 'not-list'\n    const currentChoice = type === 'list' || type === 'not-list'\n    if (prevChoice && currentChoice) {\n      this.setState({ type })\n    } else {\n      this.setState({\n        type,\n        value: type === 'atom' || type === 'gen' ? null : []\n      })\n    }\n  }\n\n  changeTabType = event => {\n    const type = event === 0 ? 'atom' : 'gen'\n    this.changeType(type)\n  }\n\n  selected = label => {\n    const { type, value } = this.state\n    return type === 'atom' || type === 'gen'\n      ? value === label\n      : value.includes(label)\n  }\n\n  onSelect = label => {\n    const { type, value } = this.state\n    this.setState({\n      value: type === 'atom' || type === 'gen' ? label : xor([label], value)\n    })\n  }\n\n  result = () => {\n    const { type, value } = this.state\n    if (!value || !value.length) {\n      return null\n    }\n    if (type === 'atom') {\n      return { label: value, pseudo: null }\n    } else if (type === 'gen') {\n      return { type, label: value, pseudo: value }\n    }\n    return { type, values: value }\n  }\n\n  currentEvents = element => {\n    return {\n      onMouseEnter: () => this.setState({ current: element, isInfo: true }),\n      onMouseLeave: () => this.setState({ isInfo: false })\n    }\n  }\n\n  periodicTable = value => {\n    const { type, current, isInfo } = this.state\n    return (\n      <div className={classes.period_table}>\n        <AtomInfo el={current} isInfo={isInfo} />\n        <ElementsTable\n          value={value}\n          currentEvents={this.currentEvents}\n          selected={this.selected}\n          onSelect={this.onSelect}\n        />\n        <TypeChoice value={type} onChange={this.changeType} />\n      </div>\n    )\n  }\n\n  render() {\n    const { type, value } = this.state\n    const tabs = [\n      {\n        caption: 'Table',\n        component: this.periodicTable,\n        props: { value }\n      },\n      {\n        caption: 'Extended',\n        component: GenericGroups,\n        props: {\n          className: 'generic-groups',\n          selected: this.selected,\n          onSelect: this.onSelect\n        }\n      }\n    ]\n\n    return (\n      <Dialog\n        title=\"Periodic table\"\n        className={classes.elements_table}\n        params={this.props}\n        result={this.result}\n      >\n        <Tabs\n          className={classes.tabs}\n          contentClassName={classes.tabs_content}\n          captions={tabs}\n          tabIndex={type !== 'gen' ? 0 : 1}\n          changeTab={this.changeTabType}\n          tabs={tabs}\n        />\n      </Dialog>\n    )\n  }\n}\n\nfunction mapSelectionToProps(editor) {\n  const selection = editor.selection()\n\n  if (\n    selection &&\n    Object.keys(selection).length === 1 &&\n    selection.atoms &&\n    Object.keys(selection.atoms).length === 1\n  ) {\n    const struct = editor.struct()\n    const atom = struct.atoms.get(selection.atoms[0])\n    return { ...fromElement(atom) }\n  }\n\n  return {}\n}\n\nconst mapStateToProps = (state, ownProps) => {\n  if (ownProps.values || ownProps.label) {\n    return {}\n  }\n  return mapSelectionToProps(state.editor)\n}\n\nconst mapDispatchToProps = (dispatch, ownProps) => {\n  return {\n    onOk: result => {\n      if (!result.type || result.type === 'atom') {\n        dispatch(addAtoms(result.label))\n      }\n      dispatch(onAction({ tool: 'atom', opts: toElement(result) }))\n      ownProps.onOk(result)\n    }\n  }\n}\n\nconst PeriodTable = connect(mapStateToProps, mapDispatchToProps)(Table)\n\nexport default PeriodTable\n","/****************************************************************************\n * Copyright 2021 EPAM Systems\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *    http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n ***************************************************************************/\n\nimport { xor } from 'lodash/fp'\n\nfunction oneOrMore(multipl, values, item) {\n  if (multipl) return xor(values, [item])\n  return xor(values, values.concat([item]))\n}\n\nfunction ButtonList({\n  value,\n  onChange,\n  schema,\n  disabledIds,\n  multiple,\n  classes\n}) {\n  let className\n  const selected = classes.selected || 'selected'\n  return (\n    <ul>\n      {schema.items.enum.map((item, i) => {\n        className = value.includes(item) ? selected : ''\n        return (\n          <li key={item}>\n            <button\n              disabled={disabledIds.includes(item)}\n              type=\"button\"\n              className={className}\n              onClick={() => onChange(oneOrMore(multiple, value, item))}\n            >\n              {schema.items.enumNames[i]}\n            </button>\n          </li>\n        )\n      })}\n    </ul>\n  )\n}\n\nexport default ButtonList\n","/****************************************************************************\n * Copyright 2021 EPAM Systems\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *    http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n ***************************************************************************/\n\nimport Form, { Field } from '../../../component/form/form/form'\n\nimport ButtonList from '../../../component/form/buttonlist'\nimport { Dialog } from '../../../views/components'\nimport classes from './rgroup.module.less'\nimport { connect } from 'react-redux'\nimport { rgroupSchema } from '../../../data/schema/struct-schema'\n\nfunction RGroup({ disabledIds, values, formState, type, ...props }) {\n  return (\n    <Dialog\n      title=\"R-Group\"\n      className={classes.rgroup}\n      params={props}\n      result={() => formState.result}\n    >\n      <Form schema={rgroupSchema} init={{ values }} {...formState}>\n        <Field\n          name=\"values\"\n          multiple={type === 'atom'}\n          labelPos={false}\n          component={ButtonList}\n          disabledIds={disabledIds}\n          classes={classes}\n        />\n      </Form>\n    </Dialog>\n  )\n}\n\nexport default connect(store => ({ formState: store.modal.form }))(RGroup)\n","/****************************************************************************\n * Copyright 2021 EPAM Systems\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *    http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n ***************************************************************************/\n\nimport { Component } from 'react'\n\nimport classes from './combobox.module.less'\n\nclass ComboBox extends Component {\n  constructor(props) {\n    super(props)\n    this.state = {\n      suggestsHidden: true\n    }\n\n    this.click = this.click.bind(this)\n    this.blur = this.blur.bind(this)\n    this.updateInput = this.updateInput.bind(this)\n  }\n\n  updateInput(event) {\n    const value = event.target.value || event.target.textContent\n    this.setState({ suggestsHidden: true })\n    this.props.onChange(value)\n  }\n\n  click() {\n    this.setState({ suggestsHidden: false })\n  }\n\n  blur() {\n    this.setState({ suggestsHidden: true })\n  }\n\n  render() {\n    const { value, type = 'text', schema } = this.props\n    const suggestList = schema.enumNames\n      .filter(item => item !== value)\n      .map(item => (\n        <li key={item} onMouseDown={this.updateInput}>\n          {item}\n        </li>\n      ))\n    const suggestListStyles = {\n      display: this.state.suggestsHidden ? 'none' : 'block'\n    }\n    return (\n      <div>\n        <input\n          type={type}\n          value={value}\n          onClick={this.click}\n          onBlur={this.blur}\n          onChange={this.updateInput}\n          autoComplete=\"off\"\n        />\n        {suggestList.length !== 0 ? (\n          <ul className={classes.suggestList} style={suggestListStyles}>\n            {suggestList}\n          </ul>\n        ) : (\n          ''\n        )}\n      </div>\n    )\n  }\n}\n\nexport default ComboBox\n","/****************************************************************************\n * Copyright 2021 EPAM Systems\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *    http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n ***************************************************************************/\n\nimport Form, { Field, SelectOneOf } from '../../component/form/form/form'\nimport {\n  getSdataDefault,\n  sdataCustomSchema,\n  sdataSchema\n} from '../../data/schema/sdata-schema'\n\nimport ComboBox from '../../component/form/combobox/combobox'\nimport { Dialog } from '../../views/components'\nimport classes from './sgroup.module.less'\nimport { connect } from 'react-redux'\n\nfunction SelectInput({ title, name, schema, ...prop }) {\n  const inputSelect = Object.keys(schema).reduce(\n    (acc, item) => {\n      acc.enum.push(item)\n      acc.enumNames.push(schema[item].title || item)\n      return acc\n    },\n    {\n      title,\n      type: 'string',\n      default: '',\n      minLength: 1,\n      enum: [],\n      enumNames: []\n    }\n  )\n\n  return (\n    <Field name={name} schema={inputSelect} component={ComboBox} {...prop} />\n  )\n}\n\nfunction SData({\n  context,\n  fieldName,\n  fieldValue,\n  type,\n  radiobuttons,\n  formState,\n  ...prop\n}) {\n  const { result, valid } = formState\n\n  const init = {\n    context,\n    fieldName: fieldName || getSdataDefault(context),\n    type,\n    radiobuttons\n  }\n\n  init.fieldValue = fieldValue || getSdataDefault(context, init.fieldName)\n\n  const formSchema =\n    sdataSchema[result.context][result.fieldName] || sdataCustomSchema\n\n  const serialize = {\n    context: result.context.trim(),\n    fieldName: result.fieldName.trim(),\n    fieldValue:\n      typeof result.fieldValue === 'string'\n        ? result.fieldValue.trim()\n        : result.fieldValue\n  }\n\n  return (\n    <Dialog\n      title=\"S-Group Properties\"\n      className={classes.sgroup}\n      result={() => result}\n      valid={() => valid}\n      params={prop}\n    >\n      <Form\n        serialize={serialize}\n        schema={formSchema}\n        init={init}\n        {...formState}\n      >\n        <SelectOneOf title=\"Context\" name=\"context\" schema={sdataSchema} />\n        <fieldset className={classes.data}>\n          <SelectInput\n            title=\"Field name\"\n            name=\"fieldName\"\n            schema={sdataSchema[result.context]}\n          />\n          {content(formSchema, result.context, result.fieldName, radiobuttons)}\n        </fieldset>\n      </Form>\n    </Dialog>\n  )\n}\n\nconst content = (schema, context, fieldName, checked) =>\n  Object.keys(schema.properties)\n    .filter(\n      prop => prop !== 'type' && prop !== 'context' && prop !== 'fieldName'\n    )\n    .map(prop =>\n      prop === 'radiobuttons' ? (\n        <Field\n          name={prop}\n          checked={checked}\n          type=\"radio\"\n          key={`${context}-${fieldName}-${prop}-radio`}\n        />\n      ) : (\n        <Field\n          name={prop}\n          type=\"textarea\"\n          multiple\n          size=\"10\"\n          key={`${context}-${fieldName}-${prop}-select`}\n        />\n      )\n    )\n\nexport default connect(store => ({ formState: store.modal.form }))(SData)\n","/****************************************************************************\n * Copyright 2021 EPAM Systems\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *    http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n ***************************************************************************/\n\nimport Form, { Field, SelectOneOf } from '../../component/form/form/form'\n\nimport { Dialog } from '../../views/components'\nimport classes from './sgroup.module.less'\nimport { connect } from 'react-redux'\nimport { sgroupMap as schemes } from '../../data/schema/struct-schema'\n\nfunction Sgroup({ formState, ...prop }) {\n  const { result, valid } = formState\n\n  const type = result.type\n\n  return (\n    <Dialog\n      title=\"S-Group Properties\"\n      className={classes.sgroup}\n      result={() => result}\n      valid={() => valid}\n      params={prop}\n    >\n      <Form schema={schemes[type]} init={prop} {...formState}>\n        <SelectOneOf title=\"Type\" name=\"type\" schema={schemes} />\n        {type !== 'GEN' && (\n          <fieldset className={type === 'DAT' ? classes.data : 'base'}>\n            {content(type)}\n          </fieldset>\n        )}\n      </Form>\n    </Dialog>\n  )\n}\n\nconst content = type =>\n  Object.keys(schemes[type].properties)\n    .filter(prop => prop !== 'type')\n    .map(prop => {\n      const props = {}\n      if (prop === 'name') props.maxLength = 15\n      if (prop === 'fieldName') props.maxLength = 30\n      if (prop === 'fieldValue') props.type = 'textarea'\n      if (prop === 'radiobuttons') props.type = 'radio'\n\n      return <Field name={prop} key={`${type}-${prop}`} {...props} />\n    })\n\nexport default connect(store => ({ formState: store.modal.form }))(Sgroup)\n","/****************************************************************************\n * Copyright 2021 EPAM Systems\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *    http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n ***************************************************************************/\n\nimport { Dialog, StructEditor } from '../../views/components'\nimport { Component } from 'react'\nimport { initAttach, setAttachPoints, setTmplName } from '../../state/templates'\n\nimport classes from './template-lib.module.less'\nimport { connect } from 'react-redux'\nimport { storage } from '../../storage-ext'\nimport Form, { Field } from '../../component/form/form/form'\nimport { attachSchema } from '../../data/schema/struct-schema'\n\nconst EDITOR_STYLES = {\n  selectionStyle: { fill: '#47b3ec', stroke: 'none' },\n  hoverStyle: { stroke: '#1a7090', 'stroke-width': 1.2 },\n  hoverStyleSimpleObject: { 'stroke-opacity': 0.3 }\n}\n\nclass Attach extends Component {\n  constructor({ onInit, ...props }) {\n    super()\n    this.tmpl = initTmpl(props.tmpl)\n    onInit(this.tmpl.struct.name, this.tmpl.props)\n    this.onResult = this.onResult.bind(this)\n  }\n\n  onResult() {\n    const { name, atomid, bondid } = this.props\n    return name &&\n      (name !== this.tmpl.struct.name ||\n        atomid !== this.tmpl.props.atomid ||\n        bondid !== this.tmpl.props.bondid) &&\n      name.trim().length\n      ? { name, attach: { atomid, bondid } }\n      : null\n  }\n\n  checkUniqueName(name) {\n    return !this.props.templateLib.some(\n      tmpl => tmpl.struct.name === name && tmpl.props.group === 'User Templates'\n    )\n  }\n\n  render() {\n    const { name, onNameEdit, onAttachEdit, ...prop } = this.props\n    const struct = this.tmpl.struct\n    const { atomid, bondid } =\n      struct.atoms.get(this.props.atomid) && struct.bonds.get(this.props.bondid)\n        ? this.props\n        : this.tmpl.props\n    const options = Object.assign(EDITOR_STYLES, { scale: getScale(struct) })\n\n    return (\n      <Dialog\n        title=\"Template Edit\"\n        className={classes.attach}\n        result={this.onResult}\n        valid={() => this.props.formState.valid && name}\n        params={prop}\n      >\n        <Form\n          schema={attachSchema}\n          customValid={{\n            name: name => this.checkUniqueName(name)\n          }}\n          {...this.props.formState}\n        >\n          <Field\n            name=\"name\"\n            value={name}\n            onChange={onNameEdit}\n            placeholder=\"template\"\n          />\n          <label>Choose attachment atom and bond:</label>\n          <StructEditor\n            className={classes.editor}\n            struct={struct}\n            onAttachEdit={onAttachEdit}\n            tool=\"attach\"\n            toolOpts={{ atomid, bondid }}\n            options={options}\n          />\n          {!storage.isAvailable() ? (\n            <div className={classes.warning}>{storage.warningMessage}</div>\n          ) : null}\n        </Form>\n      </Dialog>\n    )\n  }\n}\n\nexport default connect(\n  store => ({\n    ...store.templates.attach,\n    templateLib: store.templates.lib,\n    formState: store.modal.form\n  }),\n  dispatch => ({\n    onInit: (name, ap) => dispatch(initAttach(name, ap)),\n    onAttachEdit: ap => dispatch(setAttachPoints(ap)),\n    onNameEdit: name => dispatch(setTmplName(name))\n  })\n)(Attach)\n\nfunction initTmpl(tmpl) {\n  const normTmpl = {\n    struct: structNormalization(tmpl.struct),\n    props: {\n      atomid: +tmpl.props.atomid || 0,\n      bondid: +tmpl.props.bondid || 0\n    }\n  }\n  normTmpl.struct.name = tmpl.struct.name\n  return normTmpl\n}\n\nfunction structNormalization(struct) {\n  const normStruct = struct.clone()\n  const cbb = normStruct.getCoordBoundingBox()\n\n  normStruct.atoms.forEach(atom => {\n    atom.pp = atom.pp.sub(cbb.min)\n  })\n\n  normStruct.sgroups.forEach(sg => {\n    sg.pp = sg.pp ? sg.pp.sub(cbb.min) : cbb.min\n  })\n\n  normStruct.rxnArrows.forEach(rxnArrow => {\n    rxnArrow.pos = rxnArrow.pos.map(p => p.sub(cbb.min))\n  })\n\n  normStruct.rxnPluses.forEach(rxnPlus => {\n    rxnPlus.pp = rxnPlus.pp.sub(cbb.min)\n  })\n\n  normStruct.simpleObjects.forEach(simpleObject => {\n    simpleObject.pos = simpleObject.pos.map(p => p.sub(cbb.min))\n  })\n\n  normStruct.texts.forEach(text => {\n    text.position = text.position.sub(cbb.min)\n  })\n\n  return normStruct\n}\n\nfunction getScale(struct) {\n  const cbb = struct.getCoordBoundingBox()\n  const VIEW_SIZE = 220\n  let scale = VIEW_SIZE / Math.max(cbb.max.y - cbb.min.y, cbb.max.x - cbb.min.x)\n\n  if (scale < 35) scale = 35\n  if (scale > 50) scale = 50\n  return scale\n}\n","/****************************************************************************\n * Copyright 2021 EPAM Systems\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *    http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n ***************************************************************************/\n\n// import classes from './select.module.less'\n\nfunction SelectList({\n  schema,\n  value,\n  onSelect,\n  splitIndexes,\n  selected,\n  component,\n  classes,\n  ...props\n}) {\n  return (\n    <ul {...props}>\n      {schema.enum.map((opt, index) => (\n        <li\n          key={opt}\n          onClick={() => onSelect(opt, index)}\n          className={\n            (opt === value ? `${classes.selected} ` : '') +\n            (isSplitIndex(index, splitIndexes) ? ` ${classes.split}` : '')\n          }\n        >\n          {schema.enumNames ? schema.enumNames[index] : opt}\n        </li>\n      ))}\n    </ul>\n  )\n}\n\nfunction isSplitIndex(index, splitIndexes) {\n  return index > 0 && splitIndexes && splitIndexes.includes(index)\n}\n\nexport default SelectList\n","/****************************************************************************\n * Copyright 2021 EPAM Systems\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *    http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n ***************************************************************************/\n\nimport { FC, RefCallback } from 'react'\nimport TemplateTable, { Template } from './TemplateTable'\nimport {\n  changeFilter,\n  changeGroup,\n  deleteTmpl,\n  editTmpl,\n  selectTmpl\n} from '../../state/templates'\nimport { filterLib, greekify } from '../../utils'\n\nimport { Dialog } from '../../views/components'\nimport Input from '../../component/form/input'\nimport SaveButton from '../../component/view/savebutton'\nimport { SdfSerializer } from 'ketcher-core'\nimport SelectList from '../../component/form/select'\nimport { Struct } from 'ketcher-core'\nimport classes from './template-lib.module.less'\nimport clsx from 'clsx'\nimport { connect } from 'react-redux'\nimport { createSelector } from 'reselect'\nimport { omit } from 'lodash/fp'\nimport { onAction } from '../../state'\nimport { useResizeObserver } from '../../../../hooks'\n\ninterface TemplateLibProps {\n  filter: string\n  group: string\n  lib: Array<Template>\n  selected: Template\n  mode: string\n}\n\ninterface TemplateLibCallProps {\n  onAttach: (tmpl: Template) => void\n  onCancel: () => void\n  onChangeGroup: (group: string) => void\n  onDelete: (tmpl: Template) => void\n  onFilter: (filter: string) => void\n  onOk: (res: any) => void\n  onSelect: (res: any) => void\n}\n\ntype Props = TemplateLibProps & TemplateLibCallProps\n\nexport interface Result {\n  struct: Struct\n  aid: number | null\n  bid: number | null\n  mode: string\n}\n\nconst filterLibSelector = createSelector(\n  (props: Props) => props.lib,\n  (props: Props) => props.filter,\n  filterLib\n)\n\nconst TemplateDialog: FC<Props> = props => {\n  const { filter, onFilter, onChangeGroup, mode, ...rest } = props\n  const CONTAINER_MIN_WIDTH = 310\n  let group = props.group\n  const lib = filterLibSelector(props)\n  group = lib[group] ? group : Object.keys(lib)[0]\n  const {\n    ref,\n    width\n  }: {\n    ref: RefCallback<HTMLDivElement>\n    width: number | undefined\n  } = useResizeObserver<HTMLDivElement>()\n\n  const result = (): Result | null => {\n    const tmpl = props.selected\n    return tmpl\n      ? {\n          struct: tmpl.struct,\n          aid: parseInt(String(tmpl.props.atomid)) || null,\n          bid: parseInt(String(tmpl.props.bondid)) || null,\n          mode: mode\n        }\n      : null\n  }\n\n  const sdfSerializer = new SdfSerializer()\n  const data = sdfSerializer.serialize(props.lib)\n\n  const select = (tmpl: Template): void => {\n    if (tmpl === props.selected) props.onOk(result())\n    else props.onSelect(tmpl)\n  }\n\n  return (\n    <Dialog\n      title=\"Template Library\"\n      className={classes.templateLib}\n      params={omit(['group'], rest)}\n      result={() => result()}\n      buttons={[\n        group && (\n          <SaveButton\n            key=\"save-to-SDF\"\n            data={data}\n            filename=\"ketcher-tmpls.sdf\"\n          >\n            Save To SDF‚Ä¶\n          </SaveButton>\n        ),\n        'Cancel',\n        'OK'\n      ]}\n    >\n      <div className={classes.dialog_body}>\n        <label>\n          Filter:\n          <Input\n            type=\"search\"\n            value={filter}\n            onChange={value => onFilter(value)}\n          />\n        </label>\n        <div\n          className={clsx(classes.tableGroupWrap, {\n            [classes.singleColLayout]: width && width < CONTAINER_MIN_WIDTH\n          })}\n          ref={ref}\n        >\n          {group && (\n            <Input\n              className={classes.groups}\n              classes={classes}\n              component={SelectList}\n              splitIndexes={[Object.keys(lib).indexOf('User Templates')]}\n              value={group}\n              onChange={g => onChangeGroup(g)}\n              schema={{\n                enum: Object.keys(lib),\n                enumNames: Object.keys(lib).map(g => greekify(g))\n              }}\n            />\n          )}\n          <TemplateTable\n            templates={lib[group]}\n            onSelect={select}\n            selected={props.selected}\n            onDelete={props.onDelete}\n            onAttach={props.onAttach}\n          />\n        </div>\n      </div>\n    </Dialog>\n  )\n}\n\nexport default connect(\n  store => ({ ...omit(['attach'], (store as any).templates) }),\n  (dispatch, props) => ({\n    onFilter: filter => dispatch(changeFilter(filter)),\n    onSelect: tmpl => dispatch(selectTmpl(tmpl)),\n    onChangeGroup: group => dispatch(changeGroup(group)),\n    // @ts-ignore\n    onAttach: tmpl => dispatch(editTmpl(tmpl)),\n    // @ts-ignore\n    onDelete: tmpl => dispatch(deleteTmpl(tmpl)),\n    onOk: res => {\n      dispatch(onAction({ tool: 'template', opts: res }))\n      ;(props as any).onOk(res)\n    }\n  })\n)(TemplateDialog)\n","/****************************************************************************\n * Copyright 2021 EPAM Systems\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *    http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n ***************************************************************************/\n\nimport { useEffect, useMemo, useState } from 'react'\n\nimport classes from './FontControl.module.less'\n\nimport { range } from 'lodash/fp'\n\nexport const FontControl = ({ editorState, setEditorState, styles }) => {\n  const defaultFontSize = '13px'\n  const [isShowingFontSizeMenu, setIsShowingFontSizeMenu] = useState(false)\n  const [currentFontSize, setCurrentFontSize] = useState(defaultFontSize)\n\n  const setFontSize = (e, value) => {\n    e.preventDefault()\n    setCurrentFontSize(value)\n    const newEditorState = styles.fontSize.remove(editorState)\n    setEditorState(styles.fontSize.add(newEditorState, value))\n    setIsShowingFontSizeMenu(false)\n  }\n\n  const currentStyle = styles.fontSize.current(editorState)\n\n  useEffect(() => {\n    setCurrentFontSize(currentStyle || defaultFontSize)\n  }, [currentStyle])\n\n  const MIN_FONT_SIZE = 4\n  const MAX_FONT_SIZE = 144\n  const fontSizes = range(MIN_FONT_SIZE, MAX_FONT_SIZE + 1)\n\n  const fontSizeOptions = useMemo(\n    () =>\n      fontSizes.map(fontSize => (\n        <div\n          key={fontSize}\n          className={classes.fontSizeOption}\n          onMouseDown={e => setFontSize(e, `${fontSize}px`)}\n        >\n          {fontSize}\n        </div>\n      )),\n    [isShowingFontSizeMenu]\n  )\n\n  return (\n    <div>\n      <button\n        className={classes.fontBtn}\n        onMouseDown={e => {\n          e.preventDefault()\n          setIsShowingFontSizeMenu(!isShowingFontSizeMenu)\n        }}\n      >\n        {currentFontSize}\n      </button>\n      {isShowingFontSizeMenu ? (\n        <div className={classes.fontSizeMenu}>{fontSizeOptions}</div>\n      ) : null}\n    </div>\n  )\n}\n\nexport default FontControl\n","/****************************************************************************\n * Copyright 2021 EPAM Systems\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *    http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n ***************************************************************************/\n\nimport Icon from '../../../../../component/view/icon'\nimport React from 'react'\nimport { TextCommand } from 'ketcher-core'\nimport clsx from 'clsx'\nimport styles from './TextButton.module.less'\n\ninterface TextButtonProps {\n  button: { command: TextCommand; name: string }\n  active: boolean\n}\n\ninterface TextButtonPropsCallProps {\n  toggleStyle: (command: TextCommand) => void\n}\n\ntype Props = TextButtonProps & TextButtonPropsCallProps\n\nexport const TextButton = (props: Props) => {\n  const toggleStyle = (\n    event: React.MouseEvent<HTMLButtonElement, MouseEvent>,\n    command: TextCommand\n  ) => {\n    event.preventDefault()\n    props.toggleStyle(command)\n  }\n\n  return (\n    <button\n      className={clsx(styles.textButton, { [styles.isActive]: props.active })}\n      title={props.button.command.toLowerCase()}\n      onMouseDown={event => {\n        toggleStyle(event, props.button.command)\n      }}\n    >\n      <Icon name={props.button.name} />\n    </button>\n  )\n}\n","/****************************************************************************\n * Copyright 2021 EPAM Systems\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *    http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n ***************************************************************************/\n\nimport 'draft-js/dist/Draft.css'\n\nimport {\n  DraftStyleMap,\n  Editor,\n  EditorState,\n  RawDraftContentState,\n  RichUtils,\n  convertFromRaw,\n  convertToRaw,\n  getDefaultKeyBinding\n} from 'draft-js'\nimport { useCallback, useState } from 'react'\n\nimport { Dialog } from '../../../components'\nimport { DialogParams } from '../../../components/Dialog/Dialog'\nimport { FontControl } from './FontControl'\nimport { TextButton } from './TextButton'\nimport { TextCommand } from 'ketcher-core'\nimport classes from './Text.module.less'\nimport { connect } from 'react-redux'\nimport createStyles from 'draft-js-custom-styles'\n\nconst { styles, customStyleFn } = createStyles(['font-size'])\n\ninterface TextProps extends DialogParams {\n  formState: any\n  id?: any\n  content: string\n  position?: string\n}\n\nconst buttons: Array<{ command: TextCommand; name: string }> = [\n  {\n    command: TextCommand.Bold,\n    name: 'text-bold'\n  },\n  {\n    command: TextCommand.Italic,\n    name: 'text-italic'\n  },\n  {\n    command: TextCommand.Subscript,\n    name: 'text-subscript'\n  },\n  {\n    command: TextCommand.Superscript,\n    name: 'text-superscript'\n  }\n]\n\nconst Text = (props: TextProps) => {\n  const { formState, position, id } = props\n  const rawContentState: RawDraftContentState | null = props.content\n    ? (JSON.parse(props.content) as RawDraftContentState)\n    : null\n  const [editorState, setEditorState] = useState<EditorState>(\n    EditorState.moveFocusToEnd(\n      EditorState.createWithContent(\n        convertFromRaw(rawContentState || { blocks: [], entityMap: {} })\n      )\n    )\n  )\n\n  const result = () => {\n    const content = editorState.getCurrentContent()\n    return {\n      content: content.hasText() ? JSON.stringify(convertToRaw(content)) : '',\n      position,\n      id\n    }\n  }\n\n  const keyBindingFn = (e: any): string | null => {\n    if (e.keyCode === 13) {\n      e.stopPropagation()\n    }\n\n    return getDefaultKeyBinding(e)\n  }\n\n  const onContentChange = (state: EditorState): void => {\n    setEditorState(state)\n  }\n\n  const currentStyle = editorState.getCurrentInlineStyle()\n\n  const toggleStyle = useCallback(\n    (command: TextCommand): void => {\n      let newEditorState: EditorState = editorState\n      switch (command) {\n        case TextCommand.Subscript: {\n          if (currentStyle.has(TextCommand.Superscript)) {\n            newEditorState = RichUtils.toggleInlineStyle(\n              newEditorState,\n              TextCommand.Superscript\n            )\n          }\n          break\n        }\n        case TextCommand.Superscript: {\n          if (currentStyle.has(TextCommand.Subscript)) {\n            newEditorState = RichUtils.toggleInlineStyle(\n              newEditorState,\n              TextCommand.Subscript\n            )\n          }\n          break\n        }\n      }\n      newEditorState = RichUtils.toggleInlineStyle(newEditorState, command)\n\n      setEditorState(newEditorState)\n    },\n    [currentStyle, editorState]\n  )\n\n  const customStyleMap: DraftStyleMap = {\n    SUBSCRIPT: {\n      verticalAlign: 'sub',\n      transform: 'scale(0.7)',\n      display: 'inline-block',\n      transformOrigin: 'left'\n    },\n    SUPERSCRIPT: {\n      verticalAlign: 'super',\n      transform: 'scale(0.7)',\n      display: 'inline-block',\n      transformOrigin: 'left'\n    }\n  }\n\n  return (\n    <Dialog\n      className=\"textEditor\"\n      title=\"Text editor\"\n      params={props}\n      result={result}\n      valid={() => formState.form.valid}\n    >\n      <ul className={classes.controlPanel}>\n        <FontControl\n          editorState={editorState}\n          setEditorState={setEditorState}\n          styles={styles}\n        />\n        {buttons.map(button => {\n          return (\n            <TextButton\n              button={button}\n              key={button.name}\n              active={currentStyle.has(button.command)}\n              toggleStyle={toggleStyle}\n            />\n          )\n        })}\n      </ul>\n      <div className={classes.textEditorInput}>\n        <Editor\n          keyBindingFn={keyBindingFn}\n          editorState={editorState}\n          onChange={onContentChange}\n          customStyleMap={customStyleMap}\n          customStyleFn={customStyleFn}\n        />\n      </div>\n    </Dialog>\n  )\n}\n\nexport default connect(store => ({ formState: (store as any).modal }))(Text)\n","/****************************************************************************\n * Copyright 2021 EPAM Systems\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *    http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n ***************************************************************************/\n\nimport { About, Settings } from '../views/modal/components/meta'\nimport {\n  Analyse,\n  Check,\n  Miew,\n  Recognize\n} from '../views/modal/components/process'\n// schemify dialogs\nimport {\n  Atom,\n  AttachPoints,\n  Automap,\n  Bond,\n  RgroupLogic\n} from '../views/modal/components/toolbox'\nimport { Open, Save } from '../views/modal/components/document'\n\nimport EnhancedStereo from './toolbox/enhancedStereo/enhancedStereo'\nimport { FunctionalGroups } from '../views/components/FunctionalGroups'\nimport LabelEdit from './toolbox/labeledit'\nimport PeriodTable from '../views/modal/components/PeriodTable'\nimport { RemoveFG } from '../views/modal/components/toolbox/FG/RemoveFG'\nimport Rgroup from './toolbox/rgroup/rgroup'\nimport Sdata from './toolbox/sdata'\nimport Sgroup from './toolbox/sgroup'\nimport TemplateAttach from './template/template-attach'\nimport TemplatesDialog from './template/TemplateDialog'\nimport Text from '../views/modal/components/Text'\n\nexport default {\n  open: Open,\n  analyse: Analyse,\n  recognize: Recognize,\n  'period-table': PeriodTable,\n  rgroup: Rgroup,\n  attach: TemplateAttach,\n  templates: TemplatesDialog,\n  about: About,\n  miew: Miew,\n  atomProps: Atom,\n  attachmentPoints: AttachPoints,\n  automap: Automap,\n  bondProps: Bond,\n  check: Check,\n  enhancedStereo: EnhancedStereo,\n  labelEdit: LabelEdit,\n  rgroupLogic: RgroupLogic,\n  removeFG: RemoveFG,\n  save: Save,\n  settings: Settings,\n  sgroup: Sgroup,\n  sdata: Sdata,\n  text: Text,\n  fGroups: FunctionalGroups\n} as any\n","/****************************************************************************\n * Copyright 2021 EPAM Systems\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *    http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n ***************************************************************************/\n\nimport { BaseCallProps, BaseProps } from '../../../modal.types'\nimport classes from './RemoveFG.module.less'\nimport { useAppContext } from '../../../../../../../hooks'\nimport { fromSgroupDeletion } from 'ketcher-core'\n\ninterface RemoveFGProps extends BaseProps {\n  fgIds: any\n}\n\ntype Props = RemoveFGProps & BaseCallProps\n\nconst RemoveFG = (props: Props) => {\n  const { getKetcherInstance } = useAppContext()\n  const editor = getKetcherInstance().editor as any\n  const { fgIds } = props\n\n  const remove = function () {\n    if (fgIds.length > 0)\n      for (let id of fgIds) {\n        editor.update(fromSgroupDeletion(editor.render.ctab, id))\n      }\n    return true\n  }\n\n  const exit = (key, res) => {\n    props[key](res)\n  }\n\n  return (\n    <div\n      onSubmit={event => event.preventDefault()}\n      tabIndex={-1}\n      className={classes.window}\n    >\n      <header className={classes.header}>Edit Abbreviation</header>\n      <div className={classes.question}>\n        A change was detected for the abbreviation. Do you want to remove the\n        abbreviation information from the structure and continue work with\n        separate atoms and bonds?\n      </div>\n      <footer className={classes.footer}>\n        <input\n          type=\"button\"\n          value={'Cancel'}\n          className={classes.buttonCancel}\n          onClick={() => exit('onOk', false)}\n        />\n        <input\n          type=\"button\"\n          value={'Remove Abbreviation'}\n          className={classes.buttonOk}\n          onClick={() => exit('onOk', remove())}\n        />\n      </footer>\n    </div>\n  )\n}\n\nexport type { RemoveFGProps }\nexport { RemoveFG }\n","/****************************************************************************\n * Copyright 2021 EPAM Systems\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *    http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n ***************************************************************************/\n\nimport { Modal, ModalProps } from './Modal'\n\nimport { BaseCallProps } from './modal.types'\nimport { Dispatch } from 'redux'\nimport { connect } from 'react-redux'\nimport { omit } from 'lodash/fp'\n\ntype StateProps = Pick<ModalProps, 'modal'>\n\nconst mapStateToProps = (state): StateProps => ({\n  modal: state.modal\n})\n\nconst mapDispatchToProps = (dispatch: Dispatch): BaseCallProps => ({\n  onOk: _result => {\n    dispatch({ type: 'MODAL_CLOSE' })\n  },\n  onCancel: () => {\n    dispatch({ type: 'MODAL_CLOSE' })\n  }\n})\n\nconst mergeProps = (\n  stateProps: StateProps,\n  dispatchProps: BaseCallProps\n): ModalProps => {\n  const prop = stateProps.modal && stateProps.modal.prop\n  const initProps = prop ? omit(['onResult', 'onCancel'], prop) : {}\n  return {\n    modal: stateProps.modal,\n    ...initProps,\n    onOk: result => {\n      if (prop && prop.onResult) prop.onResult(result)\n      dispatchProps.onOk(result)\n    },\n    onCancel: () => {\n      if (prop && prop.onCancel) prop.onCancel()\n      dispatchProps.onCancel()\n    }\n  }\n}\n\nconst ModalContainer = connect(\n  mapStateToProps,\n  mapDispatchToProps,\n  mergeProps\n)(Modal)\n\nexport default ModalContainer\n","/****************************************************************************\n * Copyright 2021 EPAM Systems\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *    http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n ***************************************************************************/\n\nimport { useRef } from 'react'\n\nimport { BaseCallProps } from './modal.types'\nimport classes from './Modal.module.less'\nimport clsx from 'clsx'\nimport mediaSizes from './mediaSizes'\nimport modals from '../../dialog'\nimport useResizeObserver from 'use-resize-observer/polyfilled'\n\ninterface ModalProps extends BaseCallProps {\n  modal: {\n    name: string\n    form: any\n    prop: any\n  }\n}\n\ntype Props = ModalProps & BaseCallProps\n\nfunction Modal(props: Props) {\n  const { modal, ...rest } = props\n  const containerRef = useRef<HTMLDivElement>(null)\n  const { height, width } = useResizeObserver<HTMLDivElement>({\n    ref: containerRef\n  })\n\n  if (!modal) return null\n\n  const Component = modals[modal.name]\n\n  if (!Component)\n    throw new Error(`There is no modal window named ${modal.name}`)\n\n  return (\n    <div className={classes.modalOverlay} ref={containerRef}>\n      <Component\n        className={clsx({\n          [classes.smallScreen]:\n            (height && height <= mediaSizes.smallHeight) ||\n            (width && width <= mediaSizes.smallWidth)\n        })}\n        {...rest}\n      />\n    </div>\n  )\n}\n\nexport type { ModalProps }\nexport { Modal }\n","/****************************************************************************\n * Copyright 2021 EPAM Systems\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *    http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n ***************************************************************************/\n\nimport {\n  fromBond,\n  fromElement,\n  fromSgroup,\n  fromStereoLabel,\n  toBond,\n  toElement,\n  toSgroup,\n  toStereoLabel\n} from '../../data/convert/structconv'\n\nimport { Elements } from 'ketcher-core'\nimport acts from '../../action'\nimport { debounce } from 'lodash/fp'\nimport { openDialog } from '../modal'\nimport { serverCall } from '../server'\n\nexport default function initEditor(dispatch, getState) {\n  const updateAction = debounce(100, () => dispatch({ type: 'UPDATE' }))\n  const sleep = time => new Promise(resolve => setTimeout(resolve, time))\n\n  function resetToSelect(dispatch) {\n    // eslint-disable-line no-shadow\n    const state = global.currentState\n    const activeTool = state.actionState.activeTool.tool\n    if (activeTool === 'select') return\n    const selectMode = state.toolbar.visibleTools.select\n    const resetOption = state.options.settings.resetToSelect\n    if (resetOption === true || resetOption === activeTool)\n      // example: 'paste'\n      dispatch({ type: 'ACTION', action: acts[selectMode].action })\n    else updateAction()\n  }\n\n  return {\n    onInit: editor => {\n      dispatch({ type: 'INIT', editor })\n    },\n    onChange: action => {\n      if (action === undefined) sleep(0).then(() => dispatch(resetToSelect))\n      // new tool in reducer\n      else dispatch(resetToSelect)\n    },\n    onSelectionChange: () => {\n      updateAction()\n    },\n    onElementEdit: selem => {\n      const elem = selem.type === 'text' ? selem : fromElement(selem)\n      let dlg = null\n      if (elem.type === 'text') {\n        // TODO: move textdialog opening logic to another place\n        return openDialog(dispatch, 'text', elem)\n      } else if (Elements.get(elem.label)) {\n        dlg = openDialog(dispatch, 'atomProps', elem)\n      } else if (Object.keys(elem).length === 1 && 'ap' in elem) {\n        dlg = openDialog(dispatch, 'attachmentPoints', elem.ap).then(res => ({\n          ap: res\n        }))\n      } else if (elem.type === 'list' || elem.type === 'not-list') {\n        dlg = openDialog(dispatch, 'period-table', elem)\n      } else if (elem.type === 'rlabel') {\n        const rgroups = getState().editor.struct().rgroups\n        const params = {\n          type: 'atom',\n          values: elem.values,\n          disabledIds: Array.from(rgroups.entries()).reduce(\n            (acc, [rgid, rg]) => {\n              if (rg.frags.has(elem.fragId)) acc.push(rgid)\n\n              return acc\n            },\n            []\n          )\n        }\n        dlg = openDialog(dispatch, 'rgroup', params).then(res => ({\n          values: res.values,\n          type: 'rlabel'\n        }))\n      } else {\n        dlg = openDialog(dispatch, 'period-table', elem)\n      }\n      return dlg.then(toElement)\n    },\n\n    // TODO: correct\n    onEnhancedStereoEdit: ({ ...init }) =>\n      sleep(0).then(() => {\n        init = fromStereoLabel(init.stereoLabel)\n        return openDialog(dispatch, 'enhancedStereo', {\n          init\n        }).then(\n          res => toStereoLabel(res),\n          () => null\n        )\n      }),\n\n    onQuickEdit: atom => openDialog(dispatch, 'labelEdit', atom),\n    onBondEdit: bond =>\n      openDialog(dispatch, 'bondProps', fromBond(bond)).then(toBond),\n    onRgroupEdit: rgroup => {\n      const struct = getState().editor.struct()\n\n      if (Object.keys(rgroup).length > 2) {\n        const rgroupLabels = Array.from(struct.rgroups.keys())\n        if (!rgroup.range) rgroup.range = '>0'\n\n        return openDialog(\n          dispatch,\n          'rgroupLogic',\n          Object.assign({ rgroupLabels }, rgroup)\n        )\n      }\n\n      const disabledIds = Array.from(struct.atoms.values()).reduce(\n        (acc, atom) => {\n          if (atom.fragment === rgroup.fragId && atom.rglabel !== null)\n            return acc.concat(fromElement(atom).values)\n\n          return acc\n        },\n        []\n      )\n      const params = {\n        type: 'fragment',\n        values: [rgroup.label],\n        disabledIds\n      }\n      return openDialog(dispatch, 'rgroup', params).then(res => ({\n        label: res.values[0]\n      }))\n    },\n    onSgroupEdit: sgroup =>\n      sleep(0) // huck to open dialog after dispatch sgroup tool action\n        .then(() => openDialog(dispatch, 'sgroup', fromSgroup(sgroup)))\n        .then(toSgroup),\n    onRemoveFG: result =>\n      sleep(0).then(() => openDialog(dispatch, 'removeFG', result)),\n    onSdataEdit: sgroup =>\n      sleep(0)\n        .then(() =>\n          openDialog(\n            dispatch,\n            sgroup.type === 'DAT' ? 'sdata' : 'sgroup',\n            fromSgroup(sgroup)\n          )\n        )\n        .then(toSgroup),\n    onMessage: msg => {\n      if (msg.error) {\n        //TODO: add error handler call\n      }\n    },\n    onAromatizeStruct: struct => {\n      const state = getState()\n      const serverOpts = state.options.getServerSettings()\n      return serverCall(\n        state.editor,\n        state.server,\n        'aromatize',\n        serverOpts,\n        struct\n      ).catch(e => state.editor.errorHandler(e))\n    },\n    onDearomatizeStruct: struct => {\n      const state = getState()\n      const serverOpts = state.options.getServerSettings()\n      return serverCall(\n        state.editor,\n        state.server,\n        'dearomatize',\n        serverOpts,\n        struct\n      ).catch(e => state.editor.errorHandler(e))\n    },\n    onMouseDown: () => {\n      updateAction()\n    }\n  }\n}\n","/****************************************************************************\n * Copyright 2021 EPAM Systems\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *    http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n ***************************************************************************/\n\nimport { StructEditor } from './components'\nimport { connect } from 'react-redux'\nimport initEditor from '../state/editor'\n\nconst Editor = connect(\n  state => ({\n    options: state.options.settings,\n    indigoVerification: state.requestsStatuses.indigoVerification\n  }),\n  dispatch => dispatch(initEditor)\n)(StructEditor)\n\nexport default Editor\n","/****************************************************************************\n * Copyright 2021 EPAM Systems\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *    http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n ***************************************************************************/\n\nimport { App, AppCallProps } from './App'\n\nimport { checkServer } from '../state/server'\nimport { connect } from 'react-redux'\n\nconst mapDispatchToProps: AppCallProps = {\n  checkServer\n}\n\nconst AppContainer = connect(null, mapDispatchToProps)(App)\n\nexport { AppContainer }\nexport default AppContainer\n","/****************************************************************************\n * Copyright 2021 EPAM Systems\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *    http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n ***************************************************************************/\n\nimport {\n  BottomToolbarContainer,\n  LeftToolbarContainer,\n  RightToolbarContainer,\n  TopToolbarContainer\n} from '../views/toolbars'\nimport { useEffect } from 'react'\nimport { useDispatch } from 'react-redux'\nimport AppClipArea from '../views/AppClipArea'\nimport { AppHiddenContainer } from './AppHidden'\nimport AppModalContainer from '../views/modal'\nimport Editor from '../views/Editor'\nimport classes from './App.module.less'\nimport { initFGTemplates } from '../state/functionalGroups'\nimport { useSettingsContext } from '../../../hooks'\n\ninterface AppCallProps {\n  checkServer: () => void\n}\n\ntype Props = AppCallProps\n\nconst App = (props: Props) => {\n  const dispatch = useDispatch()\n  const { checkServer } = props\n  const { staticResourcesUrl } = useSettingsContext()\n\n  useEffect(() => {\n    checkServer()\n    dispatch(initFGTemplates(staticResourcesUrl))\n  }, [])\n\n  return (\n    <div className={classes.app}>\n      <AppHiddenContainer />\n      <Editor className={classes.canvas} />\n\n      <TopToolbarContainer className={classes.top} />\n      <LeftToolbarContainer className={classes.left} />\n      <BottomToolbarContainer className={classes.bottom} />\n      <RightToolbarContainer className={classes.right} />\n\n      <AppClipArea />\n      <AppModalContainer />\n    </div>\n  )\n}\n\nexport type { AppCallProps }\nexport { App }\n","/****************************************************************************\n * Copyright 2021 EPAM Systems\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *    http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n ***************************************************************************/\n\nimport { AppContext, ErrorsContext, SettingsContext } from './../../../contexts'\nimport { Ketcher, StructService } from 'ketcher-core'\n\nimport App from './App.container'\nimport { Provider } from 'react-redux'\nimport ReactDOM from 'react-dom'\nimport createStore from '../state'\nimport { initKeydownListener } from '../state/hotkeys'\nimport { initResize } from '../state/toolbar'\n\nfunction initApp(\n  element: HTMLDivElement | null,\n  staticResourcesUrl: string,\n  options: any,\n  server: StructService,\n  setEditor: (editor: any) => void\n) {\n  const store = createStore(options, server, setEditor)\n  store.dispatch(initKeydownListener(element))\n  store.dispatch(initResize())\n\n  ReactDOM.render(\n    <Provider store={store}>\n      <SettingsContext.Provider value={{ staticResourcesUrl }}>\n        <ErrorsContext.Provider value={{ errorHandler: options.errorHandler }}>\n          <AppContext.Provider\n            value={{\n              getKetcherInstance: () => (window as any).ketcher as Ketcher\n            }}\n          >\n            <App />\n          </AppContext.Provider>\n        </ErrorsContext.Provider>\n      </SettingsContext.Provider>\n    </Provider>,\n    element\n  )\n}\n\nexport { initApp }\n","/****************************************************************************\n * Copyright 2021 EPAM Systems\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *    http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n ***************************************************************************/\n\nimport {\n  FormatterFactory,\n  Ketcher,\n  ServiceMode,\n  StructService,\n  StructServiceProvider\n} from 'ketcher-core'\n\nimport { ButtonsConfig } from './ButtonsConfig'\nimport { Editor } from '../../editor'\nimport createApi from '../../api'\nimport { initApp } from '../../ui'\n\nclass KetcherBuilder {\n  private structService: StructService | null\n  private editor: Editor | null\n  private serviceMode: ServiceMode | null\n  private formatterFactory: FormatterFactory | null\n\n  constructor() {\n    this.structService = null\n    this.editor = null\n    this.serviceMode = null\n    this.formatterFactory = null\n  }\n\n  async appendApiAsync(structServiceProvider: StructServiceProvider) {\n    this.structService = createApi(structServiceProvider, {\n      'smart-layout': true,\n      'ignore-stereochemistry-errors': true,\n      'mass-skip-error-on-pseudoatoms': false,\n      'gross-formula-add-rsites': true,\n      'aromatize-skip-superatoms': true\n    })\n  }\n\n  appendServiceMode(mode: ServiceMode) {\n    this.serviceMode = mode\n  }\n\n  async appendUiAsync(\n    element: HTMLDivElement | null,\n    staticResourcesUrl: string,\n    errorHandler: (message: string) => void,\n    buttons?: ButtonsConfig\n  ): Promise<void> {\n    const { structService } = this\n\n    const editor = await new Promise<Editor>(resolve => {\n      initApp(\n        element,\n        staticResourcesUrl,\n        {\n          buttons: buttons || {},\n          errorHandler: errorHandler || null,\n          version: process.env.VERSION || '',\n          buildDate: process.env.BUILD_DATE || '',\n          buildNumber: process.env.BUILD_NUMBER || ''\n        },\n        structService!,\n        resolve\n      )\n    })\n\n    this.editor = editor\n    this.editor.errorHandler =\n      errorHandler && typeof errorHandler === 'function'\n        ? errorHandler\n        : () => {}\n    this.formatterFactory = new FormatterFactory(structService!)\n  }\n\n  build() {\n    if (!this.serviceMode) {\n      throw new Error('You should append ServiceMode before building')\n    }\n\n    if (!this.structService) {\n      throw new Error('You should append Api before building')\n    }\n\n    if (!this.formatterFactory) {\n      throw new Error(\n        'You should append StructureServiceFactory before building'\n      )\n    }\n\n    const ketcher = new Ketcher(\n      this.editor!,\n      this.structService,\n      this.formatterFactory\n    )\n    ketcher[this.serviceMode] = true\n\n    const params = new URLSearchParams(document.location.search)\n    const initialMol = params.get('moll')\n    if (initialMol) {\n      ketcher.setMolecule(initialMol)\n    }\n\n    return ketcher\n  }\n}\n\nexport { KetcherBuilder }\n","/****************************************************************************\n * Copyright 2021 EPAM Systems\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *    http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n ***************************************************************************/\n\nimport { ButtonsConfig, KetcherBuilder } from './builders'\n\nimport { StructServiceProvider } from 'ketcher-core'\n\ninterface Config {\n  element: HTMLDivElement | null\n  staticResourcesUrl: string\n  structServiceProvider: StructServiceProvider\n  buttons?: ButtonsConfig\n  errorHandler: (message: string) => void\n}\n\nasync function buildKetcherAsync({\n  element,\n  staticResourcesUrl,\n  structServiceProvider,\n  buttons,\n  errorHandler\n}: Config) {\n  const builder = new KetcherBuilder()\n\n  await builder.appendApiAsync(structServiceProvider)\n  builder.appendServiceMode(structServiceProvider.mode)\n  await builder.appendUiAsync(\n    element,\n    staticResourcesUrl,\n    errorHandler,\n    buttons\n  )\n\n  return builder.build()\n}\n\nexport type { Config, ButtonsConfig }\nexport default buildKetcherAsync\n","/****************************************************************************\n * Copyright 2021 EPAM Systems\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *    http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n ***************************************************************************/\n\nimport 'intersection-observer'\nimport 'element-closest-polyfill'\nimport 'regenerator-runtime/runtime'\nimport 'url-search-params-polyfill'\nimport 'whatwg-fetch'\nimport './index.less'\n\nimport init, { Config } from './script'\nimport { useEffect, useRef } from 'react'\n\nimport { Ketcher } from 'ketcher-core'\nimport classes from './Editor.module.less'\nimport clsx from 'clsx'\nimport { useResizeObserver } from './hooks'\n\nconst mediaSizes = {\n  smallWidth: 1040,\n  smallHeight: 600\n}\n\ninterface EditorProps extends Omit<Config, 'element'> {\n  onInit?: (ketcher: Ketcher) => void\n}\n\nfunction Editor(props: EditorProps) {\n  const rootElRef = useRef<HTMLDivElement>(null)\n  const { onInit } = props\n  const { height, width } = useResizeObserver<HTMLDivElement>({\n    ref: rootElRef\n  })\n  useEffect(() => {\n    init({\n      ...props,\n      element: rootElRef.current\n    }).then((ketcher: Ketcher) => {\n      if (typeof onInit === 'function') {\n        onInit(ketcher)\n      }\n    })\n    // TODO: provide the list of dependencies after implementing unsubscribe function\n  }, [])\n\n  return (\n    <div\n      ref={rootElRef}\n      className={clsx('Ketcher-root', classes.editor, {\n        [classes.small]:\n          (height && height <= mediaSizes.smallHeight) ||\n          (width && width <= mediaSizes.smallWidth)\n      })}\n    />\n  )\n}\n\nexport { Editor }\n","/****************************************************************************\n * Copyright 2021 EPAM Systems\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *    http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n ***************************************************************************/\nimport './ErrorModal.css'\n\ninterface ErrorModalProps {\n  message: string\n  close: () => void\n}\n\nconst ErrorModal = ({ message, close }: ErrorModalProps) => {\n  return (\n    <div className={'modalOverlay'}>\n      <div className={'modalWindow'}>\n        <header>Error message</header>\n        <div className={'modalBody'}>{message}</div>\n        <footer>\n          <button\n            className={'ok'}\n            onClick={() => {\n              close()\n            }}\n          >\n            OK\n          </button>\n        </footer>\n      </div>\n    </div>\n  )\n}\n\nexport default ErrorModal\n","import 'react-app-polyfill/ie11'\nimport 'react-app-polyfill/stable'\nimport 'url-search-params-polyfill'\nimport './index.css'\nimport ReactDOM from 'react-dom'\nimport App from './App'\n\nReactDOM.render(<App />, document.getElementById('root'))\n","/****************************************************************************\n * Copyright 2021 EPAM Systems\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *    http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n ***************************************************************************/\n\nexport enum Command {\n  Info = 'info',\n  Convert = 'convert',\n  Layout = 'layout',\n  Clean = 'clean',\n  Aromatize = 'aromatize',\n  Dearomatize = 'dearomatize',\n  CalculateCip = 'calculateCip',\n  Automap = 'automap',\n  Check = 'check',\n  Calculate = 'calculate',\n  GenerateImageAsBase64 = 'generateImageAsBase64'\n}\n\nexport enum SupportedFormat {\n  Rxn = 'rxnfile',\n  Mol = 'molfile',\n  Smiles = 'smiles',\n  Smarts = 'smarts',\n  CML = 'cml',\n  InChI = 'inchi',\n  InChIAuxInfo = 'inchi-aux',\n  Ket = 'ket',\n  CDXML = 'cdxml'\n}\n\nexport interface WithStruct {\n  struct: string\n}\n\nexport interface WithFormat {\n  format: SupportedFormat\n}\n\nexport interface WithSelection {\n  selectedAtoms: Array<number>\n}\n\nexport interface CheckCommandData extends CommandData, WithStruct {\n  types: Array<string>\n}\n\nexport interface CommandData {\n  options: CommandOptions\n}\n\nexport interface ConvertCommandData\n  extends CommandData,\n    WithStruct,\n    WithFormat {}\n\nexport interface GenerateImageCommandData extends CommandData, WithStruct {\n  outputFormat: 'png' | 'svg'\n  backgroundColor?: string\n}\n\nexport interface LayoutCommandData\n  extends CommandData,\n    WithStruct,\n    WithFormat {}\n\nexport interface CleanCommandData\n  extends CommandData,\n    WithStruct,\n    WithSelection,\n    WithFormat {}\n\nexport interface AromatizeCommandData\n  extends CommandData,\n    WithStruct,\n    WithFormat {}\n\nexport interface DearomatizeCommandData\n  extends CommandData,\n    WithStruct,\n    WithFormat {}\n\nexport interface CalculateCipCommandData\n  extends CommandData,\n    WithStruct,\n    WithFormat {}\n\nexport interface CalculateCommandData\n  extends CommandData,\n    WithStruct,\n    WithSelection {\n  properties: Array<string>\n}\n\nexport interface AutomapCommandData\n  extends CommandData,\n    WithStruct,\n    WithFormat {\n  mode: string\n}\n\nexport interface CommandOptions {\n  [key: string]: string | number | boolean | undefined\n}\n\nexport interface OutputMessage<T> {\n  hasError?: boolean\n  payload?: T\n  error?: string\n}\nexport interface InputMessage<T> {\n  type: Command\n  data: T\n}\n","/****************************************************************************\n * Copyright 2021 EPAM Systems\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *    http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n ***************************************************************************/\n\nimport {\n  AromatizeCommandData,\n  AutomapCommandData,\n  CalculateCipCommandData,\n  CalculateCommandData,\n  CheckCommandData,\n  CleanCommandData,\n  Command,\n  CommandOptions,\n  ConvertCommandData,\n  DearomatizeCommandData,\n  GenerateImageCommandData,\n  InputMessage,\n  LayoutCommandData,\n  OutputMessage,\n  SupportedFormat\n} from './indigoWorker.types'\nimport {\n  AromatizeData,\n  AromatizeResult,\n  AutomapData,\n  AutomapResult,\n  CalculateCipData,\n  CalculateCipResult,\n  CalculateData,\n  CalculateResult,\n  CheckData,\n  CheckResult,\n  ChemicalMimeType,\n  CleanData,\n  CleanResult,\n  ConvertData,\n  ConvertResult,\n  DearomatizeData,\n  DearomatizeResult,\n  GenerateImageOptions,\n  InfoResult,\n  LayoutData,\n  LayoutResult,\n  RecognizeResult,\n  StructService,\n  StructServiceOptions\n} from 'ketcher-core'\n\n// @ts-ignore\nimport IndigoWorker from 'web-worker:./indigoWorker'\n\ninterface KeyValuePair {\n  [key: string]: number | string | boolean | object\n}\n\nfunction convertMimeTypeToOutputFormat(\n  mimeType: ChemicalMimeType\n): SupportedFormat {\n  let format: SupportedFormat\n  switch (mimeType) {\n    case ChemicalMimeType.Mol: {\n      format = SupportedFormat.Mol\n      break\n    }\n    case ChemicalMimeType.Rxn: {\n      format = SupportedFormat.Rxn\n      break\n    }\n    case ChemicalMimeType.DaylightSmiles:\n    case ChemicalMimeType.ExtendedSmiles: {\n      format = SupportedFormat.Smiles\n      break\n    }\n    case ChemicalMimeType.DaylightSmarts: {\n      format = SupportedFormat.Smarts\n      break\n    }\n    case ChemicalMimeType.InChI: {\n      format = SupportedFormat.InChI\n      break\n    }\n    case ChemicalMimeType.InChIAuxInfo: {\n      format = SupportedFormat.InChIAuxInfo\n      break\n    }\n    case ChemicalMimeType.CML: {\n      format = SupportedFormat.CML\n      break\n    }\n    case ChemicalMimeType.KET: {\n      format = SupportedFormat.Ket\n      break\n    }\n    case ChemicalMimeType.CDXML: {\n      format = SupportedFormat.CDXML\n      break\n    }\n    default: {\n      throw new Error('Unsupported chemical mime type')\n    }\n  }\n\n  return format\n}\n\nfunction mapCalculatedPropertyName(property: string) {\n  let mappedProperty: string | undefined\n  switch (property) {\n    case 'gross-formula': {\n      mappedProperty = 'gross'\n      break\n    }\n    default:\n      mappedProperty = property\n      break\n  }\n\n  return mappedProperty\n}\n\nfunction mapWarningGroup(property: string) {\n  let mappedProperty: string | undefined\n  switch (property) {\n    case 'OVERLAP_BOND': {\n      mappedProperty = 'overlapping_bonds'\n      break\n    }\n    default:\n      mappedProperty = property.toLowerCase()\n      break\n  }\n\n  return mappedProperty\n}\n\nclass IndigoService implements StructService {\n  private readonly defaultOptions: StructServiceOptions\n\n  constructor(defaultOptions: StructServiceOptions) {\n    this.defaultOptions = defaultOptions\n  }\n\n  info(): Promise<InfoResult> {\n    return new Promise((resolve, reject) => {\n      const worker: Worker = new IndigoWorker()\n\n      worker.onmessage = (e: MessageEvent<OutputMessage<string>>) => {\n        worker.terminate()\n        const msg: OutputMessage<string> = e.data\n        if (!msg.hasError) {\n          const result: InfoResult = {\n            indigoVersion: msg.payload!,\n            imagoVersions: [],\n            isAvailable: true\n          }\n          resolve(result)\n        } else {\n          reject(msg.error)\n        }\n      }\n\n      worker.postMessage({ type: Command.Info })\n    })\n  }\n\n  convert(\n    data: ConvertData,\n    options?: StructServiceOptions\n  ): Promise<ConvertResult> {\n    const { output_format, struct } = data\n    const format = convertMimeTypeToOutputFormat(output_format)\n\n    return new Promise((resolve, reject) => {\n      const worker: Worker = new IndigoWorker()\n\n      worker.onmessage = (e: MessageEvent<OutputMessage<string>>) => {\n        worker.terminate()\n        const msg: OutputMessage<string> = e.data\n        if (!msg.hasError) {\n          const result: ConvertResult = {\n            struct: msg.payload!,\n            format: output_format\n          }\n          resolve(result)\n        } else {\n          reject(msg.error)\n        }\n      }\n\n      const commandOptions: CommandOptions = {\n        ...this.defaultOptions,\n        ...options\n      }\n\n      const commandData: ConvertCommandData = {\n        struct,\n        format,\n        options: commandOptions\n      }\n\n      const inputMessage: InputMessage<ConvertCommandData> = {\n        type: Command.Convert,\n        data: commandData\n      }\n\n      worker.postMessage(inputMessage)\n    })\n  }\n\n  layout(\n    data: LayoutData,\n    options?: StructServiceOptions\n  ): Promise<LayoutResult> {\n    const { struct, output_format } = data\n    const format = convertMimeTypeToOutputFormat(output_format)\n\n    return new Promise((resolve, reject) => {\n      const worker: Worker = new IndigoWorker()\n\n      worker.onmessage = (e: MessageEvent<OutputMessage<string>>) => {\n        worker.terminate()\n        const msg: OutputMessage<string> = e.data\n        if (!msg.hasError) {\n          const result: LayoutResult = {\n            struct: msg.payload!,\n            format: ChemicalMimeType.Mol\n          }\n          resolve(result)\n        } else {\n          reject(msg.error)\n        }\n      }\n\n      const commandOptions: CommandOptions = {\n        ...this.defaultOptions,\n        ...options\n      }\n\n      const commandData: LayoutCommandData = {\n        struct,\n        format,\n        options: commandOptions\n      }\n\n      const inputMessage: InputMessage<LayoutCommandData> = {\n        type: Command.Layout,\n        data: commandData\n      }\n\n      worker.postMessage(inputMessage)\n    })\n  }\n\n  clean(data: CleanData, options?: StructServiceOptions): Promise<CleanResult> {\n    const { struct, selected, output_format } = data\n    const format = convertMimeTypeToOutputFormat(output_format)\n\n    return new Promise((resolve, reject) => {\n      const worker: Worker = new IndigoWorker()\n\n      worker.onmessage = (e: MessageEvent<OutputMessage<string>>) => {\n        worker.terminate()\n        const msg: OutputMessage<string> = e.data\n        if (!msg.hasError) {\n          const result: CleanResult = {\n            struct: msg.payload!,\n            format: ChemicalMimeType.Mol\n          }\n          resolve(result)\n        } else {\n          reject(msg.error)\n        }\n      }\n\n      const commandOptions: CommandOptions = {\n        ...this.defaultOptions,\n        ...options\n      }\n\n      const commandData: CleanCommandData = {\n        struct,\n        format,\n        options: commandOptions,\n        selectedAtoms: selected || []\n      }\n\n      const inputMessage: InputMessage<CleanCommandData> = {\n        type: Command.Clean,\n        data: commandData\n      }\n\n      worker.postMessage(inputMessage)\n    })\n  }\n\n  aromatize(\n    data: AromatizeData,\n    options?: StructServiceOptions\n  ): Promise<AromatizeResult> {\n    const { struct, output_format } = data\n    const format = convertMimeTypeToOutputFormat(output_format)\n\n    return new Promise((resolve, reject) => {\n      const worker: Worker = new IndigoWorker()\n\n      worker.onmessage = (e: MessageEvent<OutputMessage<string>>) => {\n        worker.terminate()\n        const msg: OutputMessage<string> = e.data\n        if (!msg.hasError) {\n          const result: AromatizeResult = {\n            struct: msg.payload!,\n            format: ChemicalMimeType.Mol\n          }\n          resolve(result)\n        } else {\n          reject(msg.error)\n        }\n      }\n\n      const commandOptions: CommandOptions = {\n        ...this.defaultOptions,\n        ...options\n      }\n\n      const commandData: AromatizeCommandData = {\n        struct,\n        format,\n        options: commandOptions\n      }\n\n      const inputMessage: InputMessage<AromatizeCommandData> = {\n        type: Command.Aromatize,\n        data: commandData\n      }\n\n      worker.postMessage(inputMessage)\n    })\n  }\n\n  dearomatize(\n    data: DearomatizeData,\n    options?: StructServiceOptions\n  ): Promise<DearomatizeResult> {\n    const { struct, output_format } = data\n    const format = convertMimeTypeToOutputFormat(output_format)\n\n    return new Promise((resolve, reject) => {\n      const worker: Worker = new IndigoWorker()\n\n      worker.onmessage = (e: MessageEvent<OutputMessage<string>>) => {\n        worker.terminate()\n        const msg: OutputMessage<string> = e.data\n        if (!msg.hasError) {\n          const result: AromatizeResult = {\n            struct: msg.payload!,\n            format: ChemicalMimeType.Mol\n          }\n          resolve(result)\n        } else {\n          reject(msg.error)\n        }\n      }\n\n      const commandOptions: CommandOptions = {\n        ...this.defaultOptions,\n        ...options\n      }\n\n      const commandData: DearomatizeCommandData = {\n        struct,\n        format,\n        options: commandOptions\n      }\n\n      const inputMessage: InputMessage<DearomatizeCommandData> = {\n        type: Command.Dearomatize,\n        data: commandData\n      }\n\n      worker.postMessage(inputMessage)\n    })\n  }\n\n  calculateCip(\n    data: CalculateCipData,\n    options?: StructServiceOptions\n  ): Promise<CalculateCipResult> {\n    const { struct, output_format } = data\n    const format = convertMimeTypeToOutputFormat(output_format)\n\n    return new Promise((resolve, reject) => {\n      const worker: Worker = new IndigoWorker()\n\n      worker.onmessage = (e: MessageEvent<OutputMessage<string>>) => {\n        worker.terminate()\n        const msg: OutputMessage<string> = e.data\n        if (!msg.hasError) {\n          const result: CalculateCipResult = {\n            struct: msg.payload!,\n            format: ChemicalMimeType.Mol\n          }\n          resolve(result)\n        } else {\n          reject(msg.error)\n        }\n      }\n\n      const commandOptions: CommandOptions = {\n        ...this.defaultOptions,\n        ...options\n      }\n\n      const commandData: CalculateCipCommandData = {\n        struct,\n        format,\n        options: commandOptions\n      }\n\n      const inputMessage: InputMessage<CalculateCipCommandData> = {\n        type: Command.CalculateCip,\n        data: commandData\n      }\n\n      worker.postMessage(inputMessage)\n    })\n  }\n\n  automap(\n    data: AutomapData,\n    options?: StructServiceOptions\n  ): Promise<AutomapResult> {\n    const { mode, struct, output_format } = data\n    const format = convertMimeTypeToOutputFormat(output_format)\n\n    return new Promise((resolve, reject) => {\n      const worker: Worker = new IndigoWorker()\n\n      worker.onmessage = (e: MessageEvent<OutputMessage<string>>) => {\n        worker.terminate()\n        const msg: OutputMessage<string> = e.data\n        if (!msg.hasError) {\n          const result: AutomapResult = {\n            struct: msg.payload!,\n            format: ChemicalMimeType.Mol\n          }\n          resolve(result)\n        } else {\n          reject(msg.error)\n        }\n      }\n\n      const commandOptions: CommandOptions = {\n        ...this.defaultOptions,\n        ...options\n      }\n\n      const commandData: AutomapCommandData = {\n        struct,\n        format,\n        mode,\n        options: commandOptions\n      }\n\n      const inputMessage: InputMessage<CalculateCipCommandData> = {\n        type: Command.Automap,\n        data: commandData\n      }\n\n      worker.postMessage(inputMessage)\n    })\n  }\n\n  check(data: CheckData, options?: StructServiceOptions): Promise<CheckResult> {\n    const { types, struct } = data\n\n    return new Promise((resolve, reject) => {\n      const worker: Worker = new IndigoWorker()\n\n      worker.onmessage = (e: MessageEvent<OutputMessage<string>>) => {\n        worker.terminate()\n        const msg: OutputMessage<string> = e.data\n        if (!msg.hasError) {\n          const warnings = JSON.parse(msg.payload!) as KeyValuePair\n\n          const result: CheckResult = Object.entries(warnings).reduce(\n            (acc, curr) => {\n              const [key, value] = curr\n              const mappedPropertyName = mapWarningGroup(key)\n              acc[mappedPropertyName] = value\n\n              return acc\n            },\n            {}\n          )\n          resolve(result)\n        } else {\n          reject(msg.error)\n        }\n      }\n\n      const commandOptions: CommandOptions = {\n        ...this.defaultOptions,\n        ...options\n      }\n\n      const commandData: CheckCommandData = {\n        struct,\n        types,\n        options: commandOptions\n      }\n\n      const inputMessage: InputMessage<CheckCommandData> = {\n        type: Command.Check,\n        data: commandData\n      }\n\n      worker.postMessage(inputMessage)\n    })\n  }\n\n  calculate(\n    data: CalculateData,\n    options?: StructServiceOptions\n  ): Promise<CalculateResult> {\n    const { properties, struct, selected } = data\n    return new Promise((resolve, reject) => {\n      const worker: Worker = new IndigoWorker()\n\n      worker.onmessage = (e: MessageEvent<OutputMessage<string>>) => {\n        worker.terminate()\n        const msg: OutputMessage<string> = e.data\n        if (!msg.hasError) {\n          const calculatedProperties = JSON.parse(msg.payload!) as KeyValuePair\n          const result: CalculateResult = Object.entries(\n            calculatedProperties\n          ).reduce((acc, curr) => {\n            const [key, value] = curr\n            const mappedPropertyName = mapCalculatedPropertyName(key)\n            if (properties.includes(mappedPropertyName)) {\n              acc[mappedPropertyName] = value\n            }\n\n            return acc\n          }, {})\n          resolve(result)\n        } else {\n          reject(msg.error)\n        }\n      }\n\n      const commandOptions: CommandOptions = {\n        ...this.defaultOptions,\n        ...options\n      }\n\n      const commandData: CalculateCommandData = {\n        struct,\n        properties,\n        options: commandOptions,\n        selectedAtoms: selected || []\n      }\n\n      const inputMessage: InputMessage<CalculateCommandData> = {\n        type: Command.Calculate,\n        data: commandData\n      }\n\n      worker.postMessage(inputMessage)\n    })\n  }\n\n  // @ts-ignore\n  recognize(blob: Blob, version: string): Promise<RecognizeResult> {\n    return Promise.reject('Not supported in standalone mode')\n  }\n\n  generateImageAsBase64(\n    data: string,\n    options: GenerateImageOptions = { outputFormat: 'png', backgroundColor: '' }\n  ): Promise<string> {\n    const { outputFormat, backgroundColor, ...restOptions } = options\n    return new Promise((resolve, reject) => {\n      const worker: Worker = new IndigoWorker()\n\n      worker.onmessage = (e: MessageEvent<OutputMessage<string>>) => {\n        worker.terminate()\n        const msg: OutputMessage<string> = e.data\n        if (!msg.hasError) {\n          resolve(msg.payload!)\n        } else {\n          reject(msg.error)\n        }\n      }\n\n      const commandOptions: CommandOptions = {\n        ...this.defaultOptions,\n        ...restOptions\n      }\n\n      const commandData: GenerateImageCommandData = {\n        struct: data,\n        outputFormat: outputFormat || 'png',\n        backgroundColor: backgroundColor,\n        options: commandOptions\n      }\n\n      const inputMessage: InputMessage<GenerateImageCommandData> = {\n        type: Command.GenerateImageAsBase64,\n        data: commandData\n      }\n\n      worker.postMessage(inputMessage)\n    })\n  }\n}\n\nexport default IndigoService\n","/****************************************************************************\n * Copyright 2021 EPAM Systems\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *    http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n ***************************************************************************/\n\nimport {\n  ServiceMode,\n  StructService,\n  StructServiceOptions,\n  StructServiceProvider\n} from 'ketcher-core'\n\nimport StandaloneStructService from './standaloneStructService'\n\nclass StandaloneStructServiceProvider implements StructServiceProvider {\n  mode: ServiceMode = 'standalone'\n\n  createStructService(options: StructServiceOptions): StructService {\n    return new StandaloneStructService(options)\n  }\n}\nexport default StandaloneStructServiceProvider\n"],"sourceRoot":""}